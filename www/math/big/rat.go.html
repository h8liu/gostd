<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment">//&nbsp;This&nbsp;file&nbsp;implements&nbsp;multi-precision&nbsp;rational&nbsp;numbers.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">package</span>&nbsp;<span class="ident">big</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">import</span>&nbsp;<span class="op">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;encoding/binary&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;math&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;strings&#34;</span><br>
<span class="lineno">15</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;A&nbsp;Rat&nbsp;represents&nbsp;a&nbsp;quotient&nbsp;a/b&nbsp;of&nbsp;arbitrary&nbsp;precision.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;zero&nbsp;value&nbsp;for&nbsp;a&nbsp;Rat&nbsp;represents&nbsp;the&nbsp;value&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">Rat</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;To&nbsp;make&nbsp;zero&nbsp;values&nbsp;for&nbsp;Rat&nbsp;work&nbsp;w/o&nbsp;initialization,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;a&nbsp;zero&nbsp;value&nbsp;of&nbsp;b&nbsp;(len(b)&nbsp;==&nbsp;0)&nbsp;acts&nbsp;like&nbsp;b&nbsp;==&nbsp;1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;a.neg&nbsp;determines&nbsp;the&nbsp;sign&nbsp;of&nbsp;the&nbsp;Rat,&nbsp;b.neg&nbsp;is&nbsp;ignored.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">a</span><span class="op">,</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="ident">Int</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;NewRat&nbsp;creates&nbsp;a&nbsp;new&nbsp;Rat&nbsp;with&nbsp;numerator&nbsp;a&nbsp;and&nbsp;denominator&nbsp;b.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">NewRat</span><span class="op">(</span><span class="ident">a</span><span class="op">,</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="ident">int64</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">Rat</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">Rat</span><span class="op">)</span><span class="op">.</span><span class="ident">SetFrac64</span><span class="op">(</span><span class="ident">a</span><span class="op">,</span>&nbsp;<span class="ident">b</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;SetFloat64&nbsp;sets&nbsp;z&nbsp;to&nbsp;exactly&nbsp;f&nbsp;and&nbsp;returns&nbsp;z.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;If&nbsp;f&nbsp;is&nbsp;not&nbsp;finite,&nbsp;SetFloat&nbsp;returns&nbsp;nil.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">z</span>&nbsp;<span class="op">*</span><span class="ident">Rat</span><span class="op">)</span>&nbsp;<span class="ident">SetFloat64</span><span class="op">(</span><span class="ident">f</span>&nbsp;<span class="builtintype">float64</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">Rat</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">const</span>&nbsp;<span class="ident">expMask</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">1</span><span class="op">&lt;&lt;</span><span class="num">11</span>&nbsp;<span class="op">-</span>&nbsp;<span class="num">1</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">bits</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">math</span><span class="op">.</span><span class="ident">Float64bits</span><span class="op">(</span><span class="ident">f</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mantissa</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">bits</span>&nbsp;<span class="op">&amp;</span>&nbsp;<span class="op">(</span><span class="num">1</span><span class="op">&lt;&lt;</span><span class="num">52</span>&nbsp;<span class="op">-</span>&nbsp;<span class="num">1</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">exp</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="op">(</span><span class="ident">bits</span>&nbsp;<span class="op">&gt;&gt;</span>&nbsp;<span class="num">52</span><span class="op">)</span>&nbsp;<span class="op">&amp;</span>&nbsp;<span class="ident">expMask</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">exp</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">expMask</span><span class="op">:</span>&nbsp;<span class="comment">//&nbsp;non-finite</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="num">0</span><span class="op">:</span>&nbsp;<span class="comment">//&nbsp;denormal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">exp</span>&nbsp;<span class="op">-=</span>&nbsp;<span class="num">1022</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">default</span><span class="op">:</span>&nbsp;<span class="comment">//&nbsp;normal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mantissa</span>&nbsp;<span class="op">|=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="op">&lt;&lt;</span>&nbsp;<span class="num">52</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">exp</span>&nbsp;<span class="op">-=</span>&nbsp;<span class="num">1023</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">shift</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">52</span>&nbsp;<span class="op">-</span>&nbsp;<span class="ident">exp</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Optimization&nbsp;(?):&nbsp;partially&nbsp;pre-normalise.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">mantissa</span><span class="op">&amp;</span><span class="num">1</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">shift</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mantissa</span>&nbsp;<span class="op">&gt;&gt;=</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">shift</span><span class="op">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">.</span><span class="ident">a</span><span class="op">.</span><span class="ident">SetUint64</span><span class="op">(</span><span class="ident">mantissa</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">.</span><span class="ident">a</span><span class="op">.</span><span class="ident">neg</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">f</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">Set</span><span class="op">(</span><span class="ident">intOne</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">shift</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">Lsh</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">z</span><span class="op">.</span><span class="ident">b</span><span class="op">,</span>&nbsp;<span class="builtintype">uint</span><span class="op">(</span><span class="ident">shift</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">.</span><span class="ident">a</span><span class="op">.</span><span class="ident">Lsh</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">z</span><span class="op">.</span><span class="ident">a</span><span class="op">,</span>&nbsp;<span class="builtintype">uint</span><span class="op">(</span><span class="op">-</span><span class="ident">shift</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">norm</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">65</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;quotToFloat32&nbsp;returns&nbsp;the&nbsp;non-negative&nbsp;float32&nbsp;value</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;nearest&nbsp;to&nbsp;the&nbsp;quotient&nbsp;a/b,&nbsp;using&nbsp;round-to-even&nbsp;in</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;halfway&nbsp;cases.&nbsp;&nbsp;It&nbsp;does&nbsp;not&nbsp;mutate&nbsp;its&nbsp;arguments.</span><br>
<span class="lineno">70</span><span class="comment">//&nbsp;Preconditions:&nbsp;b&nbsp;is&nbsp;non-zero;&nbsp;a&nbsp;and&nbsp;b&nbsp;have&nbsp;no&nbsp;common&nbsp;factors.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">quotToFloat32</span><span class="op">(</span><span class="ident">a</span><span class="op">,</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="ident">nat</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">f</span>&nbsp;<span class="builtintype">float32</span><span class="op">,</span>&nbsp;<span class="ident">exact</span>&nbsp;<span class="builtintype">bool</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">const</span>&nbsp;<span class="op">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;float&nbsp;size&nbsp;in&nbsp;bits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Fsize</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">32</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;mantissa</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Msize</span>&nbsp;&nbsp;<span class="op">=</span>&nbsp;<span class="num">23</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Msize1</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">Msize</span>&nbsp;<span class="op">+</span>&nbsp;<span class="num">1</span>&nbsp;<span class="comment">//&nbsp;incl.&nbsp;implicit&nbsp;1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Msize2</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">Msize1</span>&nbsp;<span class="op">+</span>&nbsp;<span class="num">1</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;exponent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Esize</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">Fsize</span>&nbsp;<span class="op">-</span>&nbsp;<span class="ident">Msize1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Ebias</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">1</span><span class="op">&lt;&lt;</span><span class="op">(</span><span class="ident">Esize</span><span class="op">-</span><span class="num">1</span><span class="op">)</span>&nbsp;<span class="op">-</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Emin</span>&nbsp;&nbsp;<span class="op">=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="op">-</span>&nbsp;<span class="ident">Ebias</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Emax</span>&nbsp;&nbsp;<span class="op">=</span>&nbsp;<span class="ident">Ebias</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;TODO(adonovan):&nbsp;specialize&nbsp;common&nbsp;degenerate&nbsp;cases:&nbsp;1.0,&nbsp;integers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">alen</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">a</span><span class="op">.</span><span class="ident">bitLen</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">alen</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">blen</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">bitLen</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">blen</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="string">&#34;division&nbsp;by&nbsp;zero&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;1.&nbsp;Left-shift&nbsp;A&nbsp;or&nbsp;B&nbsp;such&nbsp;that&nbsp;quotient&nbsp;A/B&nbsp;is&nbsp;in&nbsp;[1&lt;&lt;Msize1,&nbsp;1&lt;&lt;(Msize2+1)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;(Msize2&nbsp;bits&nbsp;if&nbsp;A&nbsp;&lt;&nbsp;B&nbsp;when&nbsp;they&nbsp;are&nbsp;left-aligned,&nbsp;Msize2+1&nbsp;bits&nbsp;if&nbsp;A&nbsp;&gt;=&nbsp;B).</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;This&nbsp;is&nbsp;2&nbsp;or&nbsp;3&nbsp;more&nbsp;than&nbsp;the&nbsp;float32&nbsp;mantissa&nbsp;field&nbsp;width&nbsp;of&nbsp;Msize:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;-&nbsp;the&nbsp;optional&nbsp;extra&nbsp;bit&nbsp;is&nbsp;shifted&nbsp;away&nbsp;in&nbsp;step&nbsp;3&nbsp;below.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;-&nbsp;the&nbsp;high-order&nbsp;1&nbsp;is&nbsp;omitted&nbsp;in&nbsp;&#34;normal&#34;&nbsp;representation;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;-&nbsp;the&nbsp;low-order&nbsp;1&nbsp;will&nbsp;be&nbsp;used&nbsp;during&nbsp;rounding&nbsp;then&nbsp;discarded.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">exp</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">alen</span>&nbsp;<span class="op">-</span>&nbsp;<span class="ident">blen</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">a2</span><span class="op">,</span>&nbsp;<span class="ident">b2</span>&nbsp;<span class="ident">nat</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">a2</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">a2</span><span class="op">.</span><span class="ident">set</span><span class="op">(</span><span class="ident">a</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b2</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">b2</span><span class="op">.</span><span class="ident">set</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">shift</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">Msize2</span>&nbsp;<span class="op">-</span>&nbsp;<span class="ident">exp</span><span class="op">;</span>&nbsp;<span class="ident">shift</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">a2</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">a2</span><span class="op">.</span><span class="ident">shl</span><span class="op">(</span><span class="ident">a2</span><span class="op">,</span>&nbsp;<span class="builtintype">uint</span><span class="op">(</span><span class="ident">shift</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="keyword">if</span>&nbsp;<span class="ident">shift</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b2</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">b2</span><span class="op">.</span><span class="ident">shl</span><span class="op">(</span><span class="ident">b2</span><span class="op">,</span>&nbsp;<span class="builtintype">uint</span><span class="op">(</span><span class="op">-</span><span class="ident">shift</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;2.&nbsp;Compute&nbsp;quotient&nbsp;and&nbsp;remainder&nbsp;(q,&nbsp;r).&nbsp;&nbsp;NB:&nbsp;due&nbsp;to&nbsp;the</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;extra&nbsp;shift,&nbsp;the&nbsp;low-order&nbsp;bit&nbsp;of&nbsp;q&nbsp;is&nbsp;logically&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;high-order&nbsp;bit&nbsp;of&nbsp;r.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">q</span>&nbsp;<span class="ident">nat</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">q</span><span class="op">,</span>&nbsp;<span class="ident">r</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">q</span><span class="op">.</span><span class="ident">div</span><span class="op">(</span><span class="ident">a2</span><span class="op">,</span>&nbsp;<span class="ident">a2</span><span class="op">,</span>&nbsp;<span class="ident">b2</span><span class="op">)</span>&nbsp;<span class="comment">//&nbsp;(recycle&nbsp;a2)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mantissa</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">low32</span><span class="op">(</span><span class="ident">q</span><span class="op">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">haveRem</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">r</span><span class="op">)</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="comment">//&nbsp;mantissa&amp;1&nbsp;&amp;&amp;&nbsp;!haveRem&nbsp;=&gt;&nbsp;remainder&nbsp;is&nbsp;exactly&nbsp;half</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;3.&nbsp;If&nbsp;quotient&nbsp;didn&#39;t&nbsp;fit&nbsp;in&nbsp;Msize2&nbsp;bits,&nbsp;redo&nbsp;division&nbsp;by&nbsp;b2&lt;&lt;1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;(in&nbsp;effect---we&nbsp;accomplish&nbsp;this&nbsp;incrementally).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">mantissa</span><span class="op">&gt;&gt;</span><span class="ident">Msize2</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">1</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">mantissa</span><span class="op">&amp;</span><span class="num">1</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">1</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">haveRem</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mantissa</span>&nbsp;<span class="op">&gt;&gt;=</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">exp</span><span class="op">++</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">mantissa</span><span class="op">&gt;&gt;</span><span class="ident">Msize1</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="ident">fmt</span><span class="op">.</span><span class="ident">Sprintf</span><span class="op">(</span><span class="string">&#34;expected&nbsp;exactly&nbsp;%d&nbsp;bits&nbsp;of&nbsp;result&#34;</span><span class="op">,</span>&nbsp;<span class="ident">Msize2</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;4.&nbsp;Rounding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">Emin</span><span class="op">-</span><span class="ident">Msize</span>&nbsp;<span class="op">&lt;=</span>&nbsp;<span class="ident">exp</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">exp</span>&nbsp;<span class="op">&lt;=</span>&nbsp;<span class="ident">Emin</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Denormal&nbsp;case;&nbsp;lose&nbsp;&#39;shift&#39;&nbsp;bits&nbsp;of&nbsp;precision.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">shift</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtintype">uint</span><span class="op">(</span><span class="ident">Emin</span>&nbsp;<span class="op">-</span>&nbsp;<span class="op">(</span><span class="ident">exp</span>&nbsp;<span class="op">-</span>&nbsp;<span class="num">1</span><span class="op">)</span><span class="op">)</span>&nbsp;<span class="comment">//&nbsp;[1..Esize1)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">lostbits</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">mantissa</span>&nbsp;<span class="op">&amp;</span>&nbsp;<span class="op">(</span><span class="num">1</span><span class="op">&lt;&lt;</span><span class="ident">shift</span>&nbsp;<span class="op">-</span>&nbsp;<span class="num">1</span><span class="op">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">haveRem</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">haveRem</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">lostbits</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mantissa</span>&nbsp;<span class="op">&gt;&gt;=</span>&nbsp;<span class="ident">shift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">exp</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">2</span>&nbsp;<span class="op">-</span>&nbsp;<span class="ident">Ebias</span>&nbsp;<span class="comment">//&nbsp;==&nbsp;exp&nbsp;+&nbsp;shift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Round&nbsp;q&nbsp;using&nbsp;round-half-to-even.</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">exact</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">!</span><span class="ident">haveRem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">mantissa</span><span class="op">&amp;</span><span class="num">1</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">exact</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">haveRem</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">mantissa</span><span class="op">&amp;</span><span class="num">2</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">mantissa</span><span class="op">++</span><span class="op">;</span>&nbsp;<span class="ident">mantissa</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="num">1</span><span class="op">&lt;&lt;</span><span class="ident">Msize2</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Complete&nbsp;rollover&nbsp;11...1&nbsp;=&gt;&nbsp;100...0,&nbsp;so&nbsp;shift&nbsp;is&nbsp;safe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mantissa</span>&nbsp;<span class="op">&gt;&gt;=</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">exp</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mantissa</span>&nbsp;<span class="op">&gt;&gt;=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="comment">//&nbsp;discard&nbsp;rounding&nbsp;bit.&nbsp;&nbsp;Mantissa&nbsp;now&nbsp;scaled&nbsp;by&nbsp;1&lt;&lt;Msize1.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">f</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtintype">float32</span><span class="op">(</span><span class="ident">math</span><span class="op">.</span><span class="ident">Ldexp</span><span class="op">(</span><span class="builtintype">float64</span><span class="op">(</span><span class="ident">mantissa</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">exp</span><span class="op">-</span><span class="ident">Msize1</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">math</span><span class="op">.</span><span class="ident">IsInf</span><span class="op">(</span><span class="builtintype">float64</span><span class="op">(</span><span class="ident">f</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">exact</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="comment">//&nbsp;quotToFloat64&nbsp;returns&nbsp;the&nbsp;non-negative&nbsp;float64&nbsp;value</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;nearest&nbsp;to&nbsp;the&nbsp;quotient&nbsp;a/b,&nbsp;using&nbsp;round-to-even&nbsp;in</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;halfway&nbsp;cases.&nbsp;&nbsp;It&nbsp;does&nbsp;not&nbsp;mutate&nbsp;its&nbsp;arguments.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Preconditions:&nbsp;b&nbsp;is&nbsp;non-zero;&nbsp;a&nbsp;and&nbsp;b&nbsp;have&nbsp;no&nbsp;common&nbsp;factors.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">quotToFloat64</span><span class="op">(</span><span class="ident">a</span><span class="op">,</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="ident">nat</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">f</span>&nbsp;<span class="builtintype">float64</span><span class="op">,</span>&nbsp;<span class="ident">exact</span>&nbsp;<span class="builtintype">bool</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">const</span>&nbsp;<span class="op">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;float&nbsp;size&nbsp;in&nbsp;bits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Fsize</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">64</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;mantissa</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Msize</span>&nbsp;&nbsp;<span class="op">=</span>&nbsp;<span class="num">52</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Msize1</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">Msize</span>&nbsp;<span class="op">+</span>&nbsp;<span class="num">1</span>&nbsp;<span class="comment">//&nbsp;incl.&nbsp;implicit&nbsp;1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Msize2</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">Msize1</span>&nbsp;<span class="op">+</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;exponent</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Esize</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">Fsize</span>&nbsp;<span class="op">-</span>&nbsp;<span class="ident">Msize1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Ebias</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">1</span><span class="op">&lt;&lt;</span><span class="op">(</span><span class="ident">Esize</span><span class="op">-</span><span class="num">1</span><span class="op">)</span>&nbsp;<span class="op">-</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Emin</span>&nbsp;&nbsp;<span class="op">=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="op">-</span>&nbsp;<span class="ident">Ebias</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Emax</span>&nbsp;&nbsp;<span class="op">=</span>&nbsp;<span class="ident">Ebias</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">)</span><br>
<span class="lineno">185</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;TODO(adonovan):&nbsp;specialize&nbsp;common&nbsp;degenerate&nbsp;cases:&nbsp;1.0,&nbsp;integers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">alen</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">a</span><span class="op">.</span><span class="ident">bitLen</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">alen</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">blen</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">bitLen</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">blen</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="string">&#34;division&nbsp;by&nbsp;zero&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;1.&nbsp;Left-shift&nbsp;A&nbsp;or&nbsp;B&nbsp;such&nbsp;that&nbsp;quotient&nbsp;A/B&nbsp;is&nbsp;in&nbsp;[1&lt;&lt;Msize1,&nbsp;1&lt;&lt;(Msize2+1)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;(Msize2&nbsp;bits&nbsp;if&nbsp;A&nbsp;&lt;&nbsp;B&nbsp;when&nbsp;they&nbsp;are&nbsp;left-aligned,&nbsp;Msize2+1&nbsp;bits&nbsp;if&nbsp;A&nbsp;&gt;=&nbsp;B).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;This&nbsp;is&nbsp;2&nbsp;or&nbsp;3&nbsp;more&nbsp;than&nbsp;the&nbsp;float64&nbsp;mantissa&nbsp;field&nbsp;width&nbsp;of&nbsp;Msize:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;-&nbsp;the&nbsp;optional&nbsp;extra&nbsp;bit&nbsp;is&nbsp;shifted&nbsp;away&nbsp;in&nbsp;step&nbsp;3&nbsp;below.</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;-&nbsp;the&nbsp;high-order&nbsp;1&nbsp;is&nbsp;omitted&nbsp;in&nbsp;&#34;normal&#34;&nbsp;representation;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;-&nbsp;the&nbsp;low-order&nbsp;1&nbsp;will&nbsp;be&nbsp;used&nbsp;during&nbsp;rounding&nbsp;then&nbsp;discarded.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">exp</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">alen</span>&nbsp;<span class="op">-</span>&nbsp;<span class="ident">blen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">a2</span><span class="op">,</span>&nbsp;<span class="ident">b2</span>&nbsp;<span class="ident">nat</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">a2</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">a2</span><span class="op">.</span><span class="ident">set</span><span class="op">(</span><span class="ident">a</span><span class="op">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b2</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">b2</span><span class="op">.</span><span class="ident">set</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">shift</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">Msize2</span>&nbsp;<span class="op">-</span>&nbsp;<span class="ident">exp</span><span class="op">;</span>&nbsp;<span class="ident">shift</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">a2</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">a2</span><span class="op">.</span><span class="ident">shl</span><span class="op">(</span><span class="ident">a2</span><span class="op">,</span>&nbsp;<span class="builtintype">uint</span><span class="op">(</span><span class="ident">shift</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="keyword">if</span>&nbsp;<span class="ident">shift</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b2</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">b2</span><span class="op">.</span><span class="ident">shl</span><span class="op">(</span><span class="ident">b2</span><span class="op">,</span>&nbsp;<span class="builtintype">uint</span><span class="op">(</span><span class="op">-</span><span class="ident">shift</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;2.&nbsp;Compute&nbsp;quotient&nbsp;and&nbsp;remainder&nbsp;(q,&nbsp;r).&nbsp;&nbsp;NB:&nbsp;due&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;extra&nbsp;shift,&nbsp;the&nbsp;low-order&nbsp;bit&nbsp;of&nbsp;q&nbsp;is&nbsp;logically&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;high-order&nbsp;bit&nbsp;of&nbsp;r.</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">q</span>&nbsp;<span class="ident">nat</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">q</span><span class="op">,</span>&nbsp;<span class="ident">r</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">q</span><span class="op">.</span><span class="ident">div</span><span class="op">(</span><span class="ident">a2</span><span class="op">,</span>&nbsp;<span class="ident">a2</span><span class="op">,</span>&nbsp;<span class="ident">b2</span><span class="op">)</span>&nbsp;<span class="comment">//&nbsp;(recycle&nbsp;a2)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mantissa</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">low64</span><span class="op">(</span><span class="ident">q</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">haveRem</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">r</span><span class="op">)</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="comment">//&nbsp;mantissa&amp;1&nbsp;&amp;&amp;&nbsp;!haveRem&nbsp;=&gt;&nbsp;remainder&nbsp;is&nbsp;exactly&nbsp;half</span><br>
<span class="lineno"></span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;3.&nbsp;If&nbsp;quotient&nbsp;didn&#39;t&nbsp;fit&nbsp;in&nbsp;Msize2&nbsp;bits,&nbsp;redo&nbsp;division&nbsp;by&nbsp;b2&lt;&lt;1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;(in&nbsp;effect---we&nbsp;accomplish&nbsp;this&nbsp;incrementally).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">mantissa</span><span class="op">&gt;&gt;</span><span class="ident">Msize2</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">1</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">mantissa</span><span class="op">&amp;</span><span class="num">1</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">1</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">haveRem</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mantissa</span>&nbsp;<span class="op">&gt;&gt;=</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">exp</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">mantissa</span><span class="op">&gt;&gt;</span><span class="ident">Msize1</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="ident">fmt</span><span class="op">.</span><span class="ident">Sprintf</span><span class="op">(</span><span class="string">&#34;expected&nbsp;exactly&nbsp;%d&nbsp;bits&nbsp;of&nbsp;result&#34;</span><span class="op">,</span>&nbsp;<span class="ident">Msize2</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;4.&nbsp;Rounding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">Emin</span><span class="op">-</span><span class="ident">Msize</span>&nbsp;<span class="op">&lt;=</span>&nbsp;<span class="ident">exp</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">exp</span>&nbsp;<span class="op">&lt;=</span>&nbsp;<span class="ident">Emin</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Denormal&nbsp;case;&nbsp;lose&nbsp;&#39;shift&#39;&nbsp;bits&nbsp;of&nbsp;precision.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">shift</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtintype">uint</span><span class="op">(</span><span class="ident">Emin</span>&nbsp;<span class="op">-</span>&nbsp;<span class="op">(</span><span class="ident">exp</span>&nbsp;<span class="op">-</span>&nbsp;<span class="num">1</span><span class="op">)</span><span class="op">)</span>&nbsp;<span class="comment">//&nbsp;[1..Esize1)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">lostbits</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">mantissa</span>&nbsp;<span class="op">&amp;</span>&nbsp;<span class="op">(</span><span class="num">1</span><span class="op">&lt;&lt;</span><span class="ident">shift</span>&nbsp;<span class="op">-</span>&nbsp;<span class="num">1</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">haveRem</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">haveRem</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">lostbits</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mantissa</span>&nbsp;<span class="op">&gt;&gt;=</span>&nbsp;<span class="ident">shift</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">exp</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">2</span>&nbsp;<span class="op">-</span>&nbsp;<span class="ident">Ebias</span>&nbsp;<span class="comment">//&nbsp;==&nbsp;exp&nbsp;+&nbsp;shift</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Round&nbsp;q&nbsp;using&nbsp;round-half-to-even.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">exact</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">!</span><span class="ident">haveRem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">mantissa</span><span class="op">&amp;</span><span class="num">1</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">exact</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">haveRem</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">mantissa</span><span class="op">&amp;</span><span class="num">2</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">mantissa</span><span class="op">++</span><span class="op">;</span>&nbsp;<span class="ident">mantissa</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="num">1</span><span class="op">&lt;&lt;</span><span class="ident">Msize2</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Complete&nbsp;rollover&nbsp;11...1&nbsp;=&gt;&nbsp;100...0,&nbsp;so&nbsp;shift&nbsp;is&nbsp;safe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mantissa</span>&nbsp;<span class="op">&gt;&gt;=</span>&nbsp;<span class="num">1</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">exp</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">mantissa</span>&nbsp;<span class="op">&gt;&gt;=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="comment">//&nbsp;discard&nbsp;rounding&nbsp;bit.&nbsp;&nbsp;Mantissa&nbsp;now&nbsp;scaled&nbsp;by&nbsp;1&lt;&lt;Msize1.</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">f</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">math</span><span class="op">.</span><span class="ident">Ldexp</span><span class="op">(</span><span class="builtintype">float64</span><span class="op">(</span><span class="ident">mantissa</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">exp</span><span class="op">-</span><span class="ident">Msize1</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">math</span><span class="op">.</span><span class="ident">IsInf</span><span class="op">(</span><span class="ident">f</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">exact</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Float32&nbsp;returns&nbsp;the&nbsp;nearest&nbsp;float32&nbsp;value&nbsp;for&nbsp;x&nbsp;and&nbsp;a&nbsp;bool&nbsp;indicating</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;whether&nbsp;f&nbsp;represents&nbsp;x&nbsp;exactly.&nbsp;If&nbsp;the&nbsp;magnitude&nbsp;of&nbsp;x&nbsp;is&nbsp;too&nbsp;large&nbsp;to</span><br>
<span class="lineno">265</span><span class="comment">//&nbsp;be&nbsp;represented&nbsp;by&nbsp;a&nbsp;float32,&nbsp;f&nbsp;is&nbsp;an&nbsp;infinity&nbsp;and&nbsp;exact&nbsp;is&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;sign&nbsp;of&nbsp;f&nbsp;always&nbsp;matches&nbsp;the&nbsp;sign&nbsp;of&nbsp;x,&nbsp;even&nbsp;if&nbsp;f&nbsp;==&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">x</span>&nbsp;<span class="op">*</span><span class="ident">Rat</span><span class="op">)</span>&nbsp;<span class="ident">Float32</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">f</span>&nbsp;<span class="builtintype">float32</span><span class="op">,</span>&nbsp;<span class="ident">exact</span>&nbsp;<span class="builtintype">bool</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">x</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">set</span><span class="op">(</span><span class="ident">natOne</span><span class="op">)</span>&nbsp;<span class="comment">//&nbsp;materialize&nbsp;denominator</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">f</span><span class="op">,</span>&nbsp;<span class="ident">exact</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">quotToFloat32</span><span class="op">(</span><span class="ident">x</span><span class="op">.</span><span class="ident">a</span><span class="op">.</span><span class="ident">abs</span><span class="op">,</span>&nbsp;<span class="ident">b</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">x</span><span class="op">.</span><span class="ident">a</span><span class="op">.</span><span class="ident">neg</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">f</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">-</span><span class="ident">f</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Float64&nbsp;returns&nbsp;the&nbsp;nearest&nbsp;float64&nbsp;value&nbsp;for&nbsp;x&nbsp;and&nbsp;a&nbsp;bool&nbsp;indicating</span><br>
<span class="lineno">280</span><span class="comment">//&nbsp;whether&nbsp;f&nbsp;represents&nbsp;x&nbsp;exactly.&nbsp;If&nbsp;the&nbsp;magnitude&nbsp;of&nbsp;x&nbsp;is&nbsp;too&nbsp;large&nbsp;to</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;be&nbsp;represented&nbsp;by&nbsp;a&nbsp;float64,&nbsp;f&nbsp;is&nbsp;an&nbsp;infinity&nbsp;and&nbsp;exact&nbsp;is&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;sign&nbsp;of&nbsp;f&nbsp;always&nbsp;matches&nbsp;the&nbsp;sign&nbsp;of&nbsp;x,&nbsp;even&nbsp;if&nbsp;f&nbsp;==&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">x</span>&nbsp;<span class="op">*</span><span class="ident">Rat</span><span class="op">)</span>&nbsp;<span class="ident">Float64</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">f</span>&nbsp;<span class="builtintype">float64</span><span class="op">,</span>&nbsp;<span class="ident">exact</span>&nbsp;<span class="builtintype">bool</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">x</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">set</span><span class="op">(</span><span class="ident">natOne</span><span class="op">)</span>&nbsp;<span class="comment">//&nbsp;materialize&nbsp;denominator</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">f</span><span class="op">,</span>&nbsp;<span class="ident">exact</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">quotToFloat64</span><span class="op">(</span><span class="ident">x</span><span class="op">.</span><span class="ident">a</span><span class="op">.</span><span class="ident">abs</span><span class="op">,</span>&nbsp;<span class="ident">b</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">x</span><span class="op">.</span><span class="ident">a</span><span class="op">.</span><span class="ident">neg</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">f</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">-</span><span class="ident">f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">295</span><span class="comment">//&nbsp;SetFrac&nbsp;sets&nbsp;z&nbsp;to&nbsp;a/b&nbsp;and&nbsp;returns&nbsp;z.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">z</span>&nbsp;<span class="op">*</span><span class="ident">Rat</span><span class="op">)</span>&nbsp;<span class="ident">SetFrac</span><span class="op">(</span><span class="ident">a</span><span class="op">,</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="op">*</span><span class="ident">Int</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">Rat</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">.</span><span class="ident">a</span><span class="op">.</span><span class="ident">neg</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">a</span><span class="op">.</span><span class="ident">neg</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">neg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">babs</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">abs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">babs</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="string">&#34;division&nbsp;by&nbsp;zero&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">&amp;</span><span class="ident">z</span><span class="op">.</span><span class="ident">a</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">alias</span><span class="op">(</span><span class="ident">z</span><span class="op">.</span><span class="ident">a</span><span class="op">.</span><span class="ident">abs</span><span class="op">,</span>&nbsp;<span class="ident">babs</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">babs</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">nat</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">.</span><span class="ident">set</span><span class="op">(</span><span class="ident">babs</span><span class="op">)</span>&nbsp;<span class="comment">//&nbsp;make&nbsp;a&nbsp;copy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">.</span><span class="ident">a</span><span class="op">.</span><span class="ident">abs</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">a</span><span class="op">.</span><span class="ident">abs</span><span class="op">.</span><span class="ident">set</span><span class="op">(</span><span class="ident">a</span><span class="op">.</span><span class="ident">abs</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span><span class="op">.</span><span class="ident">set</span><span class="op">(</span><span class="ident">babs</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">norm</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">310</span><span class="comment">//&nbsp;SetFrac64&nbsp;sets&nbsp;z&nbsp;to&nbsp;a/b&nbsp;and&nbsp;returns&nbsp;z.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">z</span>&nbsp;<span class="op">*</span><span class="ident">Rat</span><span class="op">)</span>&nbsp;<span class="ident">SetFrac64</span><span class="op">(</span><span class="ident">a</span><span class="op">,</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="ident">int64</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">Rat</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">.</span><span class="ident">a</span><span class="op">.</span><span class="ident">SetInt64</span><span class="op">(</span><span class="ident">a</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="string">&#34;division&nbsp;by&nbsp;zero&#34;</span><span class="op">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">-</span><span class="ident">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">.</span><span class="ident">a</span><span class="op">.</span><span class="ident">neg</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">!</span><span class="ident">z</span><span class="op">.</span><span class="ident">a</span><span class="op">.</span><span class="ident">neg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span><span class="op">.</span><span class="ident">setUint64</span><span class="op">(</span><span class="ident">uint64</span><span class="op">(</span><span class="ident">b</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">norm</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;SetInt&nbsp;sets&nbsp;z&nbsp;to&nbsp;x&nbsp;(by&nbsp;making&nbsp;a&nbsp;copy&nbsp;of&nbsp;x)&nbsp;and&nbsp;returns&nbsp;z.</span><br>
<span class="lineno">325</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">z</span>&nbsp;<span class="op">*</span><span class="ident">Rat</span><span class="op">)</span>&nbsp;<span class="ident">SetInt</span><span class="op">(</span><span class="ident">x</span>&nbsp;<span class="op">*</span><span class="ident">Int</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">Rat</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">.</span><span class="ident">a</span><span class="op">.</span><span class="ident">Set</span><span class="op">(</span><span class="ident">x</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span><span class="op">.</span><span class="builtinfunc">make</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;SetInt64&nbsp;sets&nbsp;z&nbsp;to&nbsp;x&nbsp;and&nbsp;returns&nbsp;z.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">z</span>&nbsp;<span class="op">*</span><span class="ident">Rat</span><span class="op">)</span>&nbsp;<span class="ident">SetInt64</span><span class="op">(</span><span class="ident">x</span>&nbsp;<span class="ident">int64</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">Rat</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">.</span><span class="ident">a</span><span class="op">.</span><span class="ident">SetInt64</span><span class="op">(</span><span class="ident">x</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span><span class="op">.</span><span class="builtinfunc">make</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Set&nbsp;sets&nbsp;z&nbsp;to&nbsp;x&nbsp;(by&nbsp;making&nbsp;a&nbsp;copy&nbsp;of&nbsp;x)&nbsp;and&nbsp;returns&nbsp;z.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">z</span>&nbsp;<span class="op">*</span><span class="ident">Rat</span><span class="op">)</span>&nbsp;<span class="ident">Set</span><span class="op">(</span><span class="ident">x</span>&nbsp;<span class="op">*</span><span class="ident">Rat</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">Rat</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">z</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">x</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">.</span><span class="ident">a</span><span class="op">.</span><span class="ident">Set</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">x</span><span class="op">.</span><span class="ident">a</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">Set</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">x</span><span class="op">.</span><span class="ident">b</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><br>
<span class="lineno">345</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Abs&nbsp;sets&nbsp;z&nbsp;to&nbsp;|x|&nbsp;(the&nbsp;absolute&nbsp;value&nbsp;of&nbsp;x)&nbsp;and&nbsp;returns&nbsp;z.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">z</span>&nbsp;<span class="op">*</span><span class="ident">Rat</span><span class="op">)</span>&nbsp;<span class="ident">Abs</span><span class="op">(</span><span class="ident">x</span>&nbsp;<span class="op">*</span><span class="ident">Rat</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">Rat</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">.</span><span class="ident">Set</span><span class="op">(</span><span class="ident">x</span><span class="op">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">.</span><span class="ident">a</span><span class="op">.</span><span class="ident">neg</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Neg&nbsp;sets&nbsp;z&nbsp;to&nbsp;-x&nbsp;and&nbsp;returns&nbsp;z.</span><br>
<span class="lineno">355</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">z</span>&nbsp;<span class="op">*</span><span class="ident">Rat</span><span class="op">)</span>&nbsp;<span class="ident">Neg</span><span class="op">(</span><span class="ident">x</span>&nbsp;<span class="op">*</span><span class="ident">Rat</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">Rat</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">.</span><span class="ident">Set</span><span class="op">(</span><span class="ident">x</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">.</span><span class="ident">a</span><span class="op">.</span><span class="ident">neg</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">z</span><span class="op">.</span><span class="ident">a</span><span class="op">.</span><span class="ident">abs</span><span class="op">)</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="op">!</span><span class="ident">z</span><span class="op">.</span><span class="ident">a</span><span class="op">.</span><span class="ident">neg</span>&nbsp;<span class="comment">//&nbsp;0&nbsp;has&nbsp;no&nbsp;sign</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">360</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Inv&nbsp;sets&nbsp;z&nbsp;to&nbsp;1/x&nbsp;and&nbsp;returns&nbsp;z.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">z</span>&nbsp;<span class="op">*</span><span class="ident">Rat</span><span class="op">)</span>&nbsp;<span class="ident">Inv</span><span class="op">(</span><span class="ident">x</span>&nbsp;<span class="op">*</span><span class="ident">Rat</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">Rat</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">x</span><span class="op">.</span><span class="ident">a</span><span class="op">.</span><span class="ident">abs</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="string">&#34;division&nbsp;by&nbsp;zero&#34;</span><span class="op">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">.</span><span class="ident">Set</span><span class="op">(</span><span class="ident">x</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">a</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">a</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">a</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">a</span><span class="op">.</span><span class="ident">set</span><span class="op">(</span><span class="ident">natOne</span><span class="op">)</span>&nbsp;<span class="comment">//&nbsp;materialize&nbsp;numerator</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">a</span><span class="op">.</span><span class="ident">abs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">cmp</span><span class="op">(</span><span class="ident">natOne</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="builtinfunc">make</span><span class="op">(</span><span class="num">0</span><span class="op">)</span>&nbsp;<span class="comment">//&nbsp;normalize&nbsp;denominator</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">.</span><span class="ident">a</span><span class="op">.</span><span class="ident">abs</span><span class="op">,</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">a</span><span class="op">,</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="comment">//&nbsp;sign&nbsp;doesn&#39;t&nbsp;change</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Sign&nbsp;returns:</span><br>
<span class="lineno">380</span><span class="comment">//</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&nbsp;&nbsp;&nbsp-1&nbsp;if&nbsp;x&nbsp;&lt;&nbsp;&nbsp;0</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&nbsp;&nbsp;&nbsp&nbsp;0&nbsp;if&nbsp;x&nbsp;==&nbsp;0</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&nbsp;&nbsp;&nbsp+1&nbsp;if&nbsp;x&nbsp;&gt;&nbsp;&nbsp;0</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno">385</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">x</span>&nbsp;<span class="op">*</span><span class="ident">Rat</span><span class="op">)</span>&nbsp;<span class="ident">Sign</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">int</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">x</span><span class="op">.</span><span class="ident">a</span><span class="op">.</span><span class="ident">Sign</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;IsInt&nbsp;returns&nbsp;true&nbsp;if&nbsp;the&nbsp;denominator&nbsp;of&nbsp;x&nbsp;is&nbsp;1.</span><br>
<span class="lineno">390</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">x</span>&nbsp;<span class="op">*</span><span class="ident">Rat</span><span class="op">)</span>&nbsp;<span class="ident">IsInt</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">bool</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">x</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">x</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span><span class="op">.</span><span class="ident">cmp</span><span class="op">(</span><span class="ident">natOne</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Num&nbsp;returns&nbsp;the&nbsp;numerator&nbsp;of&nbsp;x;&nbsp;it&nbsp;may&nbsp;be&nbsp;&lt;=&nbsp;0.</span><br>
<span class="lineno">395</span><span class="comment">//&nbsp;The&nbsp;result&nbsp;is&nbsp;a&nbsp;reference&nbsp;to&nbsp;x&#39;s&nbsp;numerator;&nbsp;it</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;may&nbsp;change&nbsp;if&nbsp;a&nbsp;new&nbsp;value&nbsp;is&nbsp;assigned&nbsp;to&nbsp;x,&nbsp;and&nbsp;vice&nbsp;versa.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;sign&nbsp;of&nbsp;the&nbsp;numerator&nbsp;corresponds&nbsp;to&nbsp;the&nbsp;sign&nbsp;of&nbsp;x.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">x</span>&nbsp;<span class="op">*</span><span class="ident">Rat</span><span class="op">)</span>&nbsp;<span class="ident">Num</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">Int</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">&amp;</span><span class="ident">x</span><span class="op">.</span><span class="ident">a</span><br>
<span class="lineno">400</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Denom&nbsp;returns&nbsp;the&nbsp;denominator&nbsp;of&nbsp;x;&nbsp;it&nbsp;is&nbsp;always&nbsp;&gt;&nbsp;0.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;result&nbsp;is&nbsp;a&nbsp;reference&nbsp;to&nbsp;x&#39;s&nbsp;denominator;&nbsp;it</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;may&nbsp;change&nbsp;if&nbsp;a&nbsp;new&nbsp;value&nbsp;is&nbsp;assigned&nbsp;to&nbsp;x,&nbsp;and&nbsp;vice&nbsp;versa.</span><br>
<span class="lineno">405</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">x</span>&nbsp;<span class="op">*</span><span class="ident">Rat</span><span class="op">)</span>&nbsp;<span class="ident">Denom</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">Int</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">x</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">neg</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">false</span>&nbsp;<span class="comment">//&nbsp;the&nbsp;result&nbsp;is&nbsp;always&nbsp;&gt;=&nbsp;0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">x</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">x</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">x</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span><span class="op">.</span><span class="ident">set</span><span class="op">(</span><span class="ident">natOne</span><span class="op">)</span>&nbsp;<span class="comment">//&nbsp;materialize&nbsp;denominator</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">&amp;</span><span class="ident">x</span><span class="op">.</span><span class="ident">b</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">z</span>&nbsp;<span class="op">*</span><span class="ident">Rat</span><span class="op">)</span>&nbsp;<span class="ident">norm</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">Rat</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">z</span><span class="op">.</span><span class="ident">a</span><span class="op">.</span><span class="ident">abs</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;z&nbsp;==&nbsp;0&nbsp;-&nbsp;normalize&nbsp;sign&nbsp;and&nbsp;denominator</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">.</span><span class="ident">a</span><span class="op">.</span><span class="ident">neg</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span><span class="op">.</span><span class="builtinfunc">make</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">z</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span><span class="op">:</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;z&nbsp;is&nbsp;normalized&nbsp;int&nbsp;-&nbsp;nothing&nbsp;to&nbsp;do</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span><span class="op">.</span><span class="ident">cmp</span><span class="op">(</span><span class="ident">natOne</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;z&nbsp;is&nbsp;int&nbsp;-&nbsp;normalize&nbsp;denominator</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span><span class="op">.</span><span class="builtinfunc">make</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">default</span><span class="op">:</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">neg</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">a</span><span class="op">.</span><span class="ident">neg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">.</span><span class="ident">a</span><span class="op">.</span><span class="ident">neg</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">neg</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">f</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">NewInt</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><span class="op">.</span><span class="ident">binaryGCD</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">z</span><span class="op">.</span><span class="ident">a</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">z</span><span class="op">.</span><span class="ident">b</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">f</span><span class="op">.</span><span class="ident">Cmp</span><span class="op">(</span><span class="ident">intOne</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">.</span><span class="ident">a</span><span class="op">.</span><span class="ident">abs</span><span class="op">,</span>&nbsp;<span class="ident">_</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">a</span><span class="op">.</span><span class="ident">abs</span><span class="op">.</span><span class="ident">div</span><span class="op">(</span><span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">a</span><span class="op">.</span><span class="ident">abs</span><span class="op">,</span>&nbsp;<span class="ident">f</span><span class="op">.</span><span class="ident">abs</span><span class="op">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span><span class="op">,</span>&nbsp;<span class="ident">_</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span><span class="op">.</span><span class="ident">div</span><span class="op">(</span><span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span><span class="op">,</span>&nbsp;<span class="ident">f</span><span class="op">.</span><span class="ident">abs</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span><span class="op">.</span><span class="ident">cmp</span><span class="op">(</span><span class="ident">natOne</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;z&nbsp;is&nbsp;int&nbsp;-&nbsp;normalize&nbsp;denominator</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span><span class="op">.</span><span class="builtinfunc">make</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">.</span><span class="ident">a</span><span class="op">.</span><span class="ident">neg</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">neg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">440</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;mulDenom&nbsp;sets&nbsp;z&nbsp;to&nbsp;the&nbsp;denominator&nbsp;product&nbsp;x*y&nbsp;(by&nbsp;taking&nbsp;into</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;account&nbsp;that&nbsp;0&nbsp;values&nbsp;for&nbsp;x&nbsp;or&nbsp;y&nbsp;must&nbsp;be&nbsp;interpreted&nbsp;as&nbsp;1)&nbsp;and</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;returns&nbsp;z.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">mulDenom</span><span class="op">(</span><span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">x</span><span class="op">,</span>&nbsp;<span class="ident">y</span>&nbsp;<span class="ident">nat</span><span class="op">)</span>&nbsp;<span class="ident">nat</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">x</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">set</span><span class="op">(</span><span class="ident">y</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">y</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">set</span><span class="op">(</span><span class="ident">x</span><span class="op">)</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">mul</span><span class="op">(</span><span class="ident">x</span><span class="op">,</span>&nbsp;<span class="ident">y</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;scaleDenom&nbsp;computes&nbsp;x*f.</span><br>
<span class="lineno">455</span><span class="comment">//&nbsp;If&nbsp;f&nbsp;==&nbsp;0&nbsp;(zero&nbsp;value&nbsp;of&nbsp;denominator),&nbsp;the&nbsp;result&nbsp;is&nbsp;(a&nbsp;copy&nbsp;of)&nbsp;x.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">scaleDenom</span><span class="op">(</span><span class="ident">x</span>&nbsp;<span class="op">*</span><span class="ident">Int</span><span class="op">,</span>&nbsp;<span class="ident">f</span>&nbsp;<span class="ident">nat</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">Int</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">z</span>&nbsp;<span class="ident">Int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">f</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">Set</span><span class="op">(</span><span class="ident">x</span><span class="op">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">.</span><span class="ident">abs</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">abs</span><span class="op">.</span><span class="ident">mul</span><span class="op">(</span><span class="ident">x</span><span class="op">.</span><span class="ident">abs</span><span class="op">,</span>&nbsp;<span class="ident">f</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">.</span><span class="ident">neg</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">x</span><span class="op">.</span><span class="ident">neg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">&amp;</span><span class="ident">z</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">465</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Cmp&nbsp;compares&nbsp;x&nbsp;and&nbsp;y&nbsp;and&nbsp;returns:</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&nbsp;&nbsp;-1&nbsp;if&nbsp;x&nbsp;&lt;&nbsp;&nbsp;y</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&nbsp;&nbsp;&nbsp;0&nbsp;if&nbsp;x&nbsp;==&nbsp;y</span><br>
<span class="lineno">470</span><span class="comment">//&nbsp;&nbsp;&nbsp;+1&nbsp;if&nbsp;x&nbsp;&gt;&nbsp;&nbsp;y</span><br>
<span class="lineno"></span><span class="comment">//</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">x</span>&nbsp;<span class="op">*</span><span class="ident">Rat</span><span class="op">)</span>&nbsp;<span class="ident">Cmp</span><span class="op">(</span><span class="ident">y</span>&nbsp;<span class="op">*</span><span class="ident">Rat</span><span class="op">)</span>&nbsp;<span class="builtintype">int</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">scaleDenom</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">x</span><span class="op">.</span><span class="ident">a</span><span class="op">,</span>&nbsp;<span class="ident">y</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span><span class="op">)</span><span class="op">.</span><span class="ident">Cmp</span><span class="op">(</span><span class="ident">scaleDenom</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">y</span><span class="op">.</span><span class="ident">a</span><span class="op">,</span>&nbsp;<span class="ident">x</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">475</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Add&nbsp;sets&nbsp;z&nbsp;to&nbsp;the&nbsp;sum&nbsp;x+y&nbsp;and&nbsp;returns&nbsp;z.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">z</span>&nbsp;<span class="op">*</span><span class="ident">Rat</span><span class="op">)</span>&nbsp;<span class="ident">Add</span><span class="op">(</span><span class="ident">x</span><span class="op">,</span>&nbsp;<span class="ident">y</span>&nbsp;<span class="op">*</span><span class="ident">Rat</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">Rat</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">a1</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">scaleDenom</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">x</span><span class="op">.</span><span class="ident">a</span><span class="op">,</span>&nbsp;<span class="ident">y</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">a2</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">scaleDenom</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">y</span><span class="op">.</span><span class="ident">a</span><span class="op">,</span>&nbsp;<span class="ident">x</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span><span class="op">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">.</span><span class="ident">a</span><span class="op">.</span><span class="ident">Add</span><span class="op">(</span><span class="ident">a1</span><span class="op">,</span>&nbsp;<span class="ident">a2</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">mulDenom</span><span class="op">(</span><span class="ident">z</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span><span class="op">,</span>&nbsp;<span class="ident">x</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span><span class="op">,</span>&nbsp;<span class="ident">y</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">norm</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">485</span><span class="comment">//&nbsp;Sub&nbsp;sets&nbsp;z&nbsp;to&nbsp;the&nbsp;difference&nbsp;x-y&nbsp;and&nbsp;returns&nbsp;z.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">z</span>&nbsp;<span class="op">*</span><span class="ident">Rat</span><span class="op">)</span>&nbsp;<span class="ident">Sub</span><span class="op">(</span><span class="ident">x</span><span class="op">,</span>&nbsp;<span class="ident">y</span>&nbsp;<span class="op">*</span><span class="ident">Rat</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">Rat</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">a1</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">scaleDenom</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">x</span><span class="op">.</span><span class="ident">a</span><span class="op">,</span>&nbsp;<span class="ident">y</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">a2</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">scaleDenom</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">y</span><span class="op">.</span><span class="ident">a</span><span class="op">,</span>&nbsp;<span class="ident">x</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">.</span><span class="ident">a</span><span class="op">.</span><span class="ident">Sub</span><span class="op">(</span><span class="ident">a1</span><span class="op">,</span>&nbsp;<span class="ident">a2</span><span class="op">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">mulDenom</span><span class="op">(</span><span class="ident">z</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span><span class="op">,</span>&nbsp;<span class="ident">x</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span><span class="op">,</span>&nbsp;<span class="ident">y</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">norm</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Mul&nbsp;sets&nbsp;z&nbsp;to&nbsp;the&nbsp;product&nbsp;x*y&nbsp;and&nbsp;returns&nbsp;z.</span><br>
<span class="lineno">495</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">z</span>&nbsp;<span class="op">*</span><span class="ident">Rat</span><span class="op">)</span>&nbsp;<span class="ident">Mul</span><span class="op">(</span><span class="ident">x</span><span class="op">,</span>&nbsp;<span class="ident">y</span>&nbsp;<span class="op">*</span><span class="ident">Rat</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">Rat</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">.</span><span class="ident">a</span><span class="op">.</span><span class="ident">Mul</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">x</span><span class="op">.</span><span class="ident">a</span><span class="op">,</span>&nbsp;<span class="op">&amp;</span><span class="ident">y</span><span class="op">.</span><span class="ident">a</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">mulDenom</span><span class="op">(</span><span class="ident">z</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span><span class="op">,</span>&nbsp;<span class="ident">x</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span><span class="op">,</span>&nbsp;<span class="ident">y</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">norm</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">500</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Quo&nbsp;sets&nbsp;z&nbsp;to&nbsp;the&nbsp;quotient&nbsp;x/y&nbsp;and&nbsp;returns&nbsp;z.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;If&nbsp;y&nbsp;==&nbsp;0,&nbsp;a&nbsp;division-by-zero&nbsp;run-time&nbsp;panic&nbsp;occurs.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">z</span>&nbsp;<span class="op">*</span><span class="ident">Rat</span><span class="op">)</span>&nbsp;<span class="ident">Quo</span><span class="op">(</span><span class="ident">x</span><span class="op">,</span>&nbsp;<span class="ident">y</span>&nbsp;<span class="op">*</span><span class="ident">Rat</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">Rat</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">y</span><span class="op">.</span><span class="ident">a</span><span class="op">.</span><span class="ident">abs</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="string">&#34;division&nbsp;by&nbsp;zero&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">a</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">scaleDenom</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">x</span><span class="op">.</span><span class="ident">a</span><span class="op">,</span>&nbsp;<span class="ident">y</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">scaleDenom</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">y</span><span class="op">.</span><span class="ident">a</span><span class="op">,</span>&nbsp;<span class="ident">x</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">.</span><span class="ident">a</span><span class="op">.</span><span class="ident">abs</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">a</span><span class="op">.</span><span class="ident">abs</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">abs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">.</span><span class="ident">a</span><span class="op">.</span><span class="ident">neg</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">a</span><span class="op">.</span><span class="ident">neg</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">neg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">norm</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">515</span><span class="keyword">func</span>&nbsp;<span class="ident">ratTok</span><span class="op">(</span><span class="ident">ch</span>&nbsp;<span class="builtintype">rune</span><span class="op">)</span>&nbsp;<span class="builtintype">bool</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">strings</span><span class="op">.</span><span class="ident">IndexRune</span><span class="op">(</span><span class="string">&#34;+-/0123456789.eE&#34;</span><span class="op">,</span>&nbsp;<span class="ident">ch</span><span class="op">)</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Scan&nbsp;is&nbsp;a&nbsp;support&nbsp;routine&nbsp;for&nbsp;fmt.Scanner.&nbsp;It&nbsp;accepts&nbsp;the&nbsp;formats</span><br>
<span class="lineno">520</span><span class="comment">//&nbsp;&#39;e&#39;,&nbsp;&#39;E&#39;,&nbsp;&#39;f&#39;,&nbsp;&#39;F&#39;,&nbsp;&#39;g&#39;,&nbsp;&#39;G&#39;,&nbsp;and&nbsp;&#39;v&#39;.&nbsp;All&nbsp;formats&nbsp;are&nbsp;equivalent.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">z</span>&nbsp;<span class="op">*</span><span class="ident">Rat</span><span class="op">)</span>&nbsp;<span class="ident">Scan</span><span class="op">(</span><span class="ident">s</span>&nbsp;<span class="ident">fmt</span><span class="op">.</span><span class="ident">ScanState</span><span class="op">,</span>&nbsp;<span class="ident">ch</span>&nbsp;<span class="builtintype">rune</span><span class="op">)</span>&nbsp;<span class="builtintype">error</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tok</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">s</span><span class="op">.</span><span class="ident">Token</span><span class="op">(</span><span class="ident">true</span><span class="op">,</span>&nbsp;<span class="ident">ratTok</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">err</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">strings</span><span class="op">.</span><span class="ident">IndexRune</span><span class="op">(</span><span class="string">&#34;efgEFGv&#34;</span><span class="op">,</span>&nbsp;<span class="ident">ch</span><span class="op">)</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">errors</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="string">&#34;Rat.Scan:&nbsp;invalid&nbsp;verb&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">SetString</span><span class="op">(</span><span class="builtintype">string</span><span class="op">(</span><span class="ident">tok</span><span class="op">)</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="op">!</span><span class="ident">ok</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">errors</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="string">&#34;Rat.Scan:&nbsp;invalid&nbsp;syntax&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="comment">//&nbsp;SetString&nbsp;sets&nbsp;z&nbsp;to&nbsp;the&nbsp;value&nbsp;of&nbsp;s&nbsp;and&nbsp;returns&nbsp;z&nbsp;and&nbsp;a&nbsp;boolean&nbsp;indicating</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;success.&nbsp;s&nbsp;can&nbsp;be&nbsp;given&nbsp;as&nbsp;a&nbsp;fraction&nbsp;&#34;a/b&#34;&nbsp;or&nbsp;as&nbsp;a&nbsp;floating-point&nbsp;number</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;optionally&nbsp;followed&nbsp;by&nbsp;an&nbsp;exponent.&nbsp;If&nbsp;the&nbsp;operation&nbsp;failed,&nbsp;the&nbsp;value&nbsp;of</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;z&nbsp;is&nbsp;undefined&nbsp;but&nbsp;the&nbsp;returned&nbsp;value&nbsp;is&nbsp;nil.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">z</span>&nbsp;<span class="op">*</span><span class="ident">Rat</span><span class="op">)</span>&nbsp;<span class="ident">SetString</span><span class="op">(</span><span class="ident">s</span>&nbsp;<span class="builtintype">string</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="op">*</span><span class="ident">Rat</span><span class="op">,</span>&nbsp;<span class="builtintype">bool</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">s</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;check&nbsp;for&nbsp;a&nbsp;quotient</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">sep</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">strings</span><span class="op">.</span><span class="ident">Index</span><span class="op">(</span><span class="ident">s</span><span class="op">,</span>&nbsp;<span class="string">&#34;/&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">sep</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">a</span><span class="op">.</span><span class="ident">SetString</span><span class="op">(</span><span class="ident">s</span><span class="op">[</span><span class="num">0</span><span class="op">:</span><span class="ident">sep</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="num">10</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="op">!</span><span class="ident">ok</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">s</span><span class="op">[</span><span class="ident">sep</span><span class="op">+</span><span class="num">1</span><span class="op">:</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="builtintype">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span><span class="op">,</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span><span class="op">.</span><span class="ident">scan</span><span class="op">(</span><span class="ident">strings</span><span class="op">.</span><span class="ident">NewReader</span><span class="op">(</span><span class="ident">s</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="num">10</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">z</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">norm</span><span class="op">(</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">560</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;check&nbsp;for&nbsp;a&nbsp;decimal&nbsp;point</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">sep</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">strings</span><span class="op">.</span><span class="ident">Index</span><span class="op">(</span><span class="ident">s</span><span class="op">,</span>&nbsp;<span class="string">&#34;.&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;check&nbsp;for&nbsp;an&nbsp;exponent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">e</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">strings</span><span class="op">.</span><span class="ident">IndexAny</span><span class="op">(</span><span class="ident">s</span><span class="op">,</span>&nbsp;<span class="string">&#34;eE&#34;</span><span class="op">)</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">exp</span>&nbsp;<span class="ident">Int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">e</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">e</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">sep</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;The&nbsp;E&nbsp;must&nbsp;come&nbsp;after&nbsp;the&nbsp;decimal&nbsp;point.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">false</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">exp</span><span class="op">.</span><span class="ident">SetString</span><span class="op">(</span><span class="ident">s</span><span class="op">[</span><span class="ident">e</span><span class="op">+</span><span class="num">1</span><span class="op">:</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="num">10</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="op">!</span><span class="ident">ok</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">s</span><span class="op">[</span><span class="num">0</span><span class="op">:</span><span class="ident">e</span><span class="op">]</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">sep</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">s</span><span class="op">[</span><span class="num">0</span><span class="op">:</span><span class="ident">sep</span><span class="op">]</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">s</span><span class="op">[</span><span class="ident">sep</span><span class="op">+</span><span class="num">1</span><span class="op">:</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">exp</span><span class="op">.</span><span class="ident">Sub</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">exp</span><span class="op">,</span>&nbsp;<span class="ident">NewInt</span><span class="op">(</span><span class="ident">int64</span><span class="op">(</span><span class="builtinfunc">len</span><span class="op">(</span><span class="ident">s</span><span class="op">)</span><span class="op">-</span><span class="ident">sep</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">580</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">a</span><span class="op">.</span><span class="ident">SetString</span><span class="op">(</span><span class="ident">s</span><span class="op">,</span>&nbsp;<span class="num">10</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="op">!</span><span class="ident">ok</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">powTen</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">nat</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">.</span><span class="ident">expNN</span><span class="op">(</span><span class="ident">natTen</span><span class="op">,</span>&nbsp;<span class="ident">exp</span><span class="op">.</span><span class="ident">abs</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><span class="op">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">exp</span><span class="op">.</span><span class="ident">neg</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">powTen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">.</span><span class="ident">norm</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">.</span><span class="ident">a</span><span class="op">.</span><span class="ident">abs</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">a</span><span class="op">.</span><span class="ident">abs</span><span class="op">.</span><span class="ident">mul</span><span class="op">(</span><span class="ident">z</span><span class="op">.</span><span class="ident">a</span><span class="op">.</span><span class="ident">abs</span><span class="op">,</span>&nbsp;<span class="ident">powTen</span><span class="op">)</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span><span class="op">.</span><span class="builtinfunc">make</span><span class="op">(</span><span class="num">0</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">z</span><span class="op">,</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">595</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;String&nbsp;returns&nbsp;a&nbsp;string&nbsp;representation&nbsp;of&nbsp;x&nbsp;in&nbsp;the&nbsp;form&nbsp;&#34;a/b&#34;&nbsp;(even&nbsp;if&nbsp;b&nbsp;==&nbsp;1).</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">x</span>&nbsp;<span class="op">*</span><span class="ident">Rat</span><span class="op">)</span>&nbsp;<span class="ident">String</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="string">&#34;/1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">x</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span>&nbsp;<span class="op">=</span>&nbsp;<span class="string">&#34;/&#34;</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">x</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span><span class="op">.</span><span class="ident">decimalString</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">x</span><span class="op">.</span><span class="ident">a</span><span class="op">.</span><span class="ident">String</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">s</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">605</span><span class="comment">//&nbsp;RatString&nbsp;returns&nbsp;a&nbsp;string&nbsp;representation&nbsp;of&nbsp;x&nbsp;in&nbsp;the&nbsp;form&nbsp;&#34;a/b&#34;&nbsp;if&nbsp;b&nbsp;!=&nbsp;1,</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;and&nbsp;in&nbsp;the&nbsp;form&nbsp;&#34;a&#34;&nbsp;if&nbsp;b&nbsp;==&nbsp;1.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">x</span>&nbsp;<span class="op">*</span><span class="ident">Rat</span><span class="op">)</span>&nbsp;<span class="ident">RatString</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">x</span><span class="op">.</span><span class="ident">IsInt</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">x</span><span class="op">.</span><span class="ident">a</span><span class="op">.</span><span class="ident">String</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">x</span><span class="op">.</span><span class="ident">String</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;FloatString&nbsp;returns&nbsp;a&nbsp;string&nbsp;representation&nbsp;of&nbsp;x&nbsp;in&nbsp;decimal&nbsp;form&nbsp;with&nbsp;prec</span><br>
<span class="lineno">615</span><span class="comment">//&nbsp;digits&nbsp;of&nbsp;precision&nbsp;after&nbsp;the&nbsp;decimal&nbsp;point&nbsp;and&nbsp;the&nbsp;last&nbsp;digit&nbsp;rounded.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">x</span>&nbsp;<span class="op">*</span><span class="ident">Rat</span><span class="op">)</span>&nbsp;<span class="ident">FloatString</span><span class="op">(</span><span class="ident">prec</span>&nbsp;<span class="builtintype">int</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">x</span><span class="op">.</span><span class="ident">IsInt</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">x</span><span class="op">.</span><span class="ident">a</span><span class="op">.</span><span class="ident">String</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">prec</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="string">&#34;.&#34;</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">strings</span><span class="op">.</span><span class="ident">Repeat</span><span class="op">(</span><span class="string">&#34;0&#34;</span><span class="op">,</span>&nbsp;<span class="ident">prec</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;x.b.abs&nbsp;!=&nbsp;0</span><br>
<span class="lineno">625</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">q</span><span class="op">,</span>&nbsp;<span class="ident">r</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">nat</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">.</span><span class="ident">div</span><span class="op">(</span><span class="ident">nat</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">x</span><span class="op">.</span><span class="ident">a</span><span class="op">.</span><span class="ident">abs</span><span class="op">,</span>&nbsp;<span class="ident">x</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">p</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">natOne</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">prec</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">p</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">nat</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">.</span><span class="ident">expNN</span><span class="op">(</span><span class="ident">natTen</span><span class="op">,</span>&nbsp;<span class="ident">nat</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">.</span><span class="ident">setUint64</span><span class="op">(</span><span class="ident">uint64</span><span class="op">(</span><span class="ident">prec</span><span class="op">)</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">mul</span><span class="op">(</span><span class="ident">r</span><span class="op">,</span>&nbsp;<span class="ident">p</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span><span class="op">,</span>&nbsp;<span class="ident">r2</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">div</span><span class="op">(</span><span class="ident">nat</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">r</span><span class="op">,</span>&nbsp;<span class="ident">x</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span><span class="op">)</span><br>
<span class="lineno">635</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;see&nbsp;if&nbsp;we&nbsp;need&nbsp;to&nbsp;round&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r2</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">r2</span><span class="op">.</span><span class="ident">add</span><span class="op">(</span><span class="ident">r2</span><span class="op">,</span>&nbsp;<span class="ident">r2</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">x</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span><span class="op">.</span><span class="ident">cmp</span><span class="op">(</span><span class="ident">r2</span><span class="op">)</span>&nbsp;<span class="op">&lt;=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">add</span><span class="op">(</span><span class="ident">r</span><span class="op">,</span>&nbsp;<span class="ident">natOne</span><span class="op">)</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">cmp</span><span class="op">(</span><span class="ident">p</span><span class="op">)</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">q</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">nat</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">.</span><span class="ident">add</span><span class="op">(</span><span class="ident">q</span><span class="op">,</span>&nbsp;<span class="ident">natOne</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">r</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">nat</span><span class="op">(</span><span class="ident">nil</span><span class="op">)</span><span class="op">.</span><span class="ident">sub</span><span class="op">(</span><span class="ident">r</span><span class="op">,</span>&nbsp;<span class="ident">p</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">645</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">q</span><span class="op">.</span><span class="ident">decimalString</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">x</span><span class="op">.</span><span class="ident">a</span><span class="op">.</span><span class="ident">neg</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span>&nbsp;<span class="op">=</span>&nbsp;<span class="string">&#34;-&#34;</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">650</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">prec</span>&nbsp;<span class="op">&gt;</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">rs</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">decimalString</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">leadingZeros</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">prec</span>&nbsp;<span class="op">-</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">rs</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span>&nbsp;<span class="op">+=</span>&nbsp;<span class="string">&#34;.&#34;</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">strings</span><span class="op">.</span><span class="ident">Repeat</span><span class="op">(</span><span class="string">&#34;0&#34;</span><span class="op">,</span>&nbsp;<span class="ident">leadingZeros</span><span class="op">)</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">rs</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">s</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">660</span><span class="comment">//&nbsp;Gob&nbsp;codec&nbsp;version.&nbsp;Permits&nbsp;backward-compatible&nbsp;changes&nbsp;to&nbsp;the&nbsp;encoding.</span><br>
<span class="lineno"></span><span class="keyword">const</span>&nbsp;<span class="ident">ratGobVersion</span>&nbsp;<span class="builtintype">byte</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;GobEncode&nbsp;implements&nbsp;the&nbsp;gob.GobEncoder&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">x</span>&nbsp;<span class="op">*</span><span class="ident">Rat</span><span class="op">)</span>&nbsp;<span class="ident">GobEncode</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">x</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">buf</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="num">1</span><span class="op">+</span><span class="num">4</span><span class="op">+</span><span class="op">(</span><span class="builtinfunc">len</span><span class="op">(</span><span class="ident">x</span><span class="op">.</span><span class="ident">a</span><span class="op">.</span><span class="ident">abs</span><span class="op">)</span><span class="op">+</span><span class="builtinfunc">len</span><span class="op">(</span><span class="ident">x</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span><span class="op">)</span><span class="op">)</span><span class="op">*</span><span class="ident">_S</span><span class="op">)</span>&nbsp;<span class="comment">//&nbsp;extra&nbsp;bytes&nbsp;for&nbsp;version&nbsp;and&nbsp;sign&nbsp;bit&nbsp;(1),&nbsp;and&nbsp;numerator&nbsp;length&nbsp;(4)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">x</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span><span class="op">.</span><span class="ident">bytes</span><span class="op">(</span><span class="ident">buf</span><span class="op">)</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">j</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">x</span><span class="op">.</span><span class="ident">a</span><span class="op">.</span><span class="ident">abs</span><span class="op">.</span><span class="ident">bytes</span><span class="op">(</span><span class="ident">buf</span><span class="op">[</span><span class="num">0</span><span class="op">:</span><span class="ident">i</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">n</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">-</span>&nbsp;<span class="ident">j</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="builtintype">uint32</span><span class="op">(</span><span class="ident">n</span><span class="op">)</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">n</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;this&nbsp;should&nbsp;never&nbsp;happen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="ident">errors</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="string">&#34;Rat.GobEncode:&nbsp;numerator&nbsp;too&nbsp;large&#34;</span><span class="op">)</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">binary</span><span class="op">.</span><span class="ident">BigEndian</span><span class="op">.</span><span class="ident">PutUint32</span><span class="op">(</span><span class="ident">buf</span><span class="op">[</span><span class="ident">j</span><span class="op">-</span><span class="num">4</span><span class="op">:</span><span class="ident">j</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="builtintype">uint32</span><span class="op">(</span><span class="ident">n</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">j</span>&nbsp;<span class="op">-=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="op">+</span>&nbsp;<span class="num">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">ratGobVersion</span>&nbsp;<span class="op">&lt;&lt;</span>&nbsp;<span class="num">1</span>&nbsp;<span class="comment">//&nbsp;make&nbsp;space&nbsp;for&nbsp;sign&nbsp;bit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">x</span><span class="op">.</span><span class="ident">a</span><span class="op">.</span><span class="ident">neg</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span>&nbsp;<span class="op">|=</span>&nbsp;<span class="num">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">buf</span><span class="op">[</span><span class="ident">j</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">buf</span><span class="op">[</span><span class="ident">j</span><span class="op">:</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">685</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;GobDecode&nbsp;implements&nbsp;the&nbsp;gob.GobDecoder&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">z</span>&nbsp;<span class="op">*</span><span class="ident">Rat</span><span class="op">)</span>&nbsp;<span class="ident">GobDecode</span><span class="op">(</span><span class="ident">buf</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">)</span>&nbsp;<span class="builtintype">error</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">buf</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Other&nbsp;side&nbsp;sent&nbsp;a&nbsp;nil&nbsp;or&nbsp;default&nbsp;value.</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">*</span><span class="ident">z</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">Rat</span><span class="op">{</span><span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">buf</span><span class="op">[</span><span class="num">0</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">b</span><span class="op">&gt;&gt;</span><span class="num">1</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">ratGobVersion</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">errors</span><span class="op">.</span><span class="ident">New</span><span class="op">(</span><span class="ident">fmt</span><span class="op">.</span><span class="ident">Sprintf</span><span class="op">(</span><span class="string">&#34;Rat.GobDecode:&nbsp;encoding&nbsp;version&nbsp;%d&nbsp;not&nbsp;supported&#34;</span><span class="op">,</span>&nbsp;<span class="ident">b</span><span class="op">&gt;&gt;</span><span class="num">1</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">const</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="op">=</span>&nbsp;<span class="num">1</span>&nbsp;<span class="op">+</span>&nbsp;<span class="num">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">binary</span><span class="op">.</span><span class="ident">BigEndian</span><span class="op">.</span><span class="ident">Uint32</span><span class="op">(</span><span class="ident">buf</span><span class="op">[</span><span class="ident">j</span><span class="op">-</span><span class="num">4</span><span class="op">:</span><span class="ident">j</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">.</span><span class="ident">a</span><span class="op">.</span><span class="ident">neg</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">b</span><span class="op">&amp;</span><span class="num">1</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">.</span><span class="ident">a</span><span class="op">.</span><span class="ident">abs</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">a</span><span class="op">.</span><span class="ident">abs</span><span class="op">.</span><span class="ident">setBytes</span><span class="op">(</span><span class="ident">buf</span><span class="op">[</span><span class="ident">j</span><span class="op">:</span><span class="ident">i</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">z</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">z</span><span class="op">.</span><span class="ident">b</span><span class="op">.</span><span class="ident">abs</span><span class="op">.</span><span class="ident">setBytes</span><span class="op">(</span><span class="ident">buf</span><span class="op">[</span><span class="ident">i</span><span class="op">:</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">705</span><span class="comment">//&nbsp;MarshalText&nbsp;implements&nbsp;the&nbsp;encoding.TextMarshaler&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">r</span>&nbsp;<span class="op">*</span><span class="ident">Rat</span><span class="op">)</span>&nbsp;<span class="ident">MarshalText</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">text</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="builtintype">error</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">(</span><span class="ident">r</span><span class="op">.</span><span class="ident">RatString</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">710</span><span class="comment">//&nbsp;UnmarshalText&nbsp;implements&nbsp;the&nbsp;encoding.TextUnmarshaler&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">r</span>&nbsp;<span class="op">*</span><span class="ident">Rat</span><span class="op">)</span>&nbsp;<span class="ident">UnmarshalText</span><span class="op">(</span><span class="ident">text</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">)</span>&nbsp;<span class="builtintype">error</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">ok</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">r</span><span class="op">.</span><span class="ident">SetString</span><span class="op">(</span><span class="builtintype">string</span><span class="op">(</span><span class="ident">text</span><span class="op">)</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="op">!</span><span class="ident">ok</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">fmt</span><span class="op">.</span><span class="ident">Errorf</span><span class="op">(</span><span class="string">&#34;math/big:&nbsp;cannot&nbsp;unmarshal&nbsp;%q&nbsp;into&nbsp;a&nbsp;*big.Rat&#34;</span><span class="op">,</span>&nbsp;<span class="ident">text</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span><span class="op">}</span>
</div>
</body>
</html>
