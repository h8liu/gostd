<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>expvar</h2>
<ul>
<li><a href="/gostd/expvar/expvar.go.html" class="current">expvar.go</a></li>
<li><a href="/gostd/expvar/expvar_test.go.html">expvar_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6379064">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6379119">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6379173">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6379224">//&nbsp;Package&nbsp;expvar&nbsp;provides&nbsp;a&nbsp;standardized&nbsp;interface&nbsp;to&nbsp;public&nbsp;variables,&nbsp;such</span><br>
<span class="lineno"></span><span class="comment" id="6379302">//&nbsp;as&nbsp;operation&nbsp;counters&nbsp;in&nbsp;servers.&nbsp;It&nbsp;exposes&nbsp;these&nbsp;variables&nbsp;via&nbsp;HTTP&nbsp;at</span><br>
<span class="lineno"></span><span class="comment" id="6379378">//&nbsp;/debug/vars&nbsp;in&nbsp;JSON&nbsp;format.</span><br>
<span class="lineno"></span><span class="comment" id="6379409">//</span><br>
<span class="lineno"></span><span class="comment" id="6379412">//&nbsp;Operations&nbsp;to&nbsp;set&nbsp;or&nbsp;modify&nbsp;these&nbsp;public&nbsp;variables&nbsp;are&nbsp;atomic.</span><br>
<span class="lineno">10</span><span class="comment" id="6379478">//</span><br>
<span class="lineno"></span><span class="comment" id="6379481">//&nbsp;In&nbsp;addition&nbsp;to&nbsp;adding&nbsp;the&nbsp;HTTP&nbsp;handler,&nbsp;this&nbsp;package&nbsp;registers&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6379551">//&nbsp;following&nbsp;variables:</span><br>
<span class="lineno"></span><span class="comment" id="6379575">//</span><br>
<span class="lineno"></span><span class="comment" id="6379578">//&nbsp;&nbsp;&nbsp;&nbsp;cmdline&nbsp;&nbsp;&nbsp;os.Args</span><br>
<span class="lineno">15</span><span class="comment" id="6379599">//&nbsp;&nbsp;&nbsp;&nbsp;memstats&nbsp;&nbsp;runtime.Memstats</span><br>
<span class="lineno"></span><span class="comment" id="6379629">//</span><br>
<span class="lineno"></span><span class="comment" id="6379632">//&nbsp;The&nbsp;package&nbsp;is&nbsp;sometimes&nbsp;only&nbsp;imported&nbsp;for&nbsp;the&nbsp;side&nbsp;effect&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="6379697">//&nbsp;registering&nbsp;its&nbsp;HTTP&nbsp;handler&nbsp;and&nbsp;the&nbsp;above&nbsp;variables.&nbsp;&nbsp;To&nbsp;use&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="6379765">//&nbsp;this&nbsp;way,&nbsp;link&nbsp;this&nbsp;package&nbsp;into&nbsp;your&nbsp;program:</span><br>
<span class="lineno">20</span><span class="comment" id="6379815">//&nbsp;&nbsp;&nbsp;&nbsp;import&nbsp;_&nbsp;&#34;expvar&#34;</span><br>
<span class="lineno"></span><span class="comment" id="6379836">//</span><br>
<span class="lineno"></span><span class="keyword" id="6379839">package</span>&nbsp;<span class="ident" id="6379847">expvar</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6379855">import</span>&nbsp;<span class="op" id="6379862">(</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6379865">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6379874">&#34;encoding/json&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6379891">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6379898">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6379905">&#34;net/http&#34;</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6379917">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6379923">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6379934">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6379942">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6379953">&#34;sync&#34;</span><br>
<span class="lineno">35</span><span class="op" id="6379960">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6379963">//&nbsp;Var&nbsp;is&nbsp;an&nbsp;abstract&nbsp;type&nbsp;for&nbsp;all&nbsp;exported&nbsp;variables.</span><br>
<span class="lineno"></span><span class="keyword" id="6380018">type</span>&nbsp;<span class="ident" id="6380023">Var</span>&nbsp;<span class="keyword" id="6380027">interface</span>&nbsp;<span class="op" id="6380037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6380040">String</span><span class="op" id="6380046">(</span><span class="op" id="6380047">)</span>&nbsp;<span class="builtintype" id="6380049">string</span><br>
<span class="lineno">40</span><span class="op" id="6380056">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6380059">//&nbsp;Int&nbsp;is&nbsp;a&nbsp;64-bit&nbsp;integer&nbsp;variable&nbsp;that&nbsp;satisfies&nbsp;the&nbsp;Var&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="6380129">type</span>&nbsp;<span class="ident" id="6380134">Int</span>&nbsp;<span class="keyword" id="6380138">struct</span>&nbsp;<span class="op" id="6380145">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6380148">mu</span>&nbsp;<span class="ident" id="6380151">sync</span><span class="op" id="6380155">.</span><span class="ident" id="6380156">RWMutex</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6380165">i</span>&nbsp;&nbsp;<span class="ident" id="6380168">int64</span><br>
<span class="lineno"></span><span class="op" id="6380174">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6380177">func</span>&nbsp;<span class="op" id="6380182">(</span><span class="ident" id="6380183">v</span>&nbsp;<span class="op" id="6380185">*</span><span class="ident" id="6380186">Int</span><span class="op" id="6380189">)</span>&nbsp;<span class="ident" id="6380191">String</span><span class="op" id="6380197">(</span><span class="op" id="6380198">)</span>&nbsp;<span class="builtintype" id="6380200">string</span>&nbsp;<span class="op" id="6380207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6380210">v</span><span class="op" id="6380211">.</span><span class="ident" id="6380212">mu</span><span class="op" id="6380214">.</span><span class="ident" id="6380215">RLock</span><span class="op" id="6380220">(</span><span class="op" id="6380221">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6380224">defer</span>&nbsp;<span class="ident" id="6380230">v</span><span class="op" id="6380231">.</span><span class="ident" id="6380232">mu</span><span class="op" id="6380234">.</span><span class="ident" id="6380235">RUnlock</span><span class="op" id="6380242">(</span><span class="op" id="6380243">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6380246">return</span>&nbsp;<span class="ident" id="6380253">strconv</span><span class="op" id="6380260">.</span><span class="ident" id="6380261">FormatInt</span><span class="op" id="6380270">(</span><span class="ident" id="6380271">v</span><span class="op" id="6380272">.</span><span class="ident" id="6380273">i</span><span class="op" id="6380274">,</span>&nbsp;<span class="num" id="6380276">10</span><span class="op" id="6380278">)</span><br>
<span class="lineno"></span><span class="op" id="6380280">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6380283">func</span>&nbsp;<span class="op" id="6380288">(</span><span class="ident" id="6380289">v</span>&nbsp;<span class="op" id="6380291">*</span><span class="ident" id="6380292">Int</span><span class="op" id="6380295">)</span>&nbsp;<span class="ident" id="6380297">Add</span><span class="op" id="6380300">(</span><span class="ident" id="6380301">delta</span>&nbsp;<span class="ident" id="6380307">int64</span><span class="op" id="6380312">)</span>&nbsp;<span class="op" id="6380314">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6380317">v</span><span class="op" id="6380318">.</span><span class="ident" id="6380319">mu</span><span class="op" id="6380321">.</span><span class="ident" id="6380322">Lock</span><span class="op" id="6380326">(</span><span class="op" id="6380327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6380330">defer</span>&nbsp;<span class="ident" id="6380336">v</span><span class="op" id="6380337">.</span><span class="ident" id="6380338">mu</span><span class="op" id="6380340">.</span><span class="ident" id="6380341">Unlock</span><span class="op" id="6380347">(</span><span class="op" id="6380348">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6380351">v</span><span class="op" id="6380352">.</span><span class="ident" id="6380353">i</span>&nbsp;<span class="op" id="6380355">+=</span>&nbsp;<span class="ident" id="6380358">delta</span><br>
<span class="lineno"></span><span class="op" id="6380364">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="6380367">func</span>&nbsp;<span class="op" id="6380372">(</span><span class="ident" id="6380373">v</span>&nbsp;<span class="op" id="6380375">*</span><span class="ident" id="6380376">Int</span><span class="op" id="6380379">)</span>&nbsp;<span class="ident" id="6380381">Set</span><span class="op" id="6380384">(</span><span class="ident" id="6380385">value</span>&nbsp;<span class="ident" id="6380391">int64</span><span class="op" id="6380396">)</span>&nbsp;<span class="op" id="6380398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6380401">v</span><span class="op" id="6380402">.</span><span class="ident" id="6380403">mu</span><span class="op" id="6380405">.</span><span class="ident" id="6380406">Lock</span><span class="op" id="6380410">(</span><span class="op" id="6380411">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6380414">defer</span>&nbsp;<span class="ident" id="6380420">v</span><span class="op" id="6380421">.</span><span class="ident" id="6380422">mu</span><span class="op" id="6380424">.</span><span class="ident" id="6380425">Unlock</span><span class="op" id="6380431">(</span><span class="op" id="6380432">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6380435">v</span><span class="op" id="6380436">.</span><span class="ident" id="6380437">i</span>&nbsp;<span class="op" id="6380439">=</span>&nbsp;<span class="ident" id="6380441">value</span><br>
<span class="lineno"></span><span class="op" id="6380447">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="comment" id="6380450">//&nbsp;Float&nbsp;is&nbsp;a&nbsp;64-bit&nbsp;float&nbsp;variable&nbsp;that&nbsp;satisfies&nbsp;the&nbsp;Var&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="6380520">type</span>&nbsp;<span class="ident" id="6380525">Float</span>&nbsp;<span class="keyword" id="6380531">struct</span>&nbsp;<span class="op" id="6380538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6380541">mu</span>&nbsp;<span class="ident" id="6380544">sync</span><span class="op" id="6380548">.</span><span class="ident" id="6380549">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6380558">f</span>&nbsp;&nbsp;<span class="builtintype" id="6380561">float64</span><br>
<span class="lineno">70</span><span class="op" id="6380569">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6380572">func</span>&nbsp;<span class="op" id="6380577">(</span><span class="ident" id="6380578">v</span>&nbsp;<span class="op" id="6380580">*</span><span class="ident" id="6380581">Float</span><span class="op" id="6380586">)</span>&nbsp;<span class="ident" id="6380588">String</span><span class="op" id="6380594">(</span><span class="op" id="6380595">)</span>&nbsp;<span class="builtintype" id="6380597">string</span>&nbsp;<span class="op" id="6380604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6380607">v</span><span class="op" id="6380608">.</span><span class="ident" id="6380609">mu</span><span class="op" id="6380611">.</span><span class="ident" id="6380612">RLock</span><span class="op" id="6380617">(</span><span class="op" id="6380618">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6380621">defer</span>&nbsp;<span class="ident" id="6380627">v</span><span class="op" id="6380628">.</span><span class="ident" id="6380629">mu</span><span class="op" id="6380631">.</span><span class="ident" id="6380632">RUnlock</span><span class="op" id="6380639">(</span><span class="op" id="6380640">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6380643">return</span>&nbsp;<span class="ident" id="6380650">strconv</span><span class="op" id="6380657">.</span><span class="ident" id="6380658">FormatFloat</span><span class="op" id="6380669">(</span><span class="ident" id="6380670">v</span><span class="op" id="6380671">.</span><span class="ident" id="6380672">f</span><span class="op" id="6380673">,</span>&nbsp;<span class="string" id="6380675">&#39;g&#39;</span><span class="op" id="6380678">,</span>&nbsp;<span class="op" id="6380680">-</span><span class="num" id="6380681">1</span><span class="op" id="6380682">,</span>&nbsp;<span class="num" id="6380684">64</span><span class="op" id="6380686">)</span><br>
<span class="lineno"></span><span class="op" id="6380688">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6380691">//&nbsp;Add&nbsp;adds&nbsp;delta&nbsp;to&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="6380715">func</span>&nbsp;<span class="op" id="6380720">(</span><span class="ident" id="6380721">v</span>&nbsp;<span class="op" id="6380723">*</span><span class="ident" id="6380724">Float</span><span class="op" id="6380729">)</span>&nbsp;<span class="ident" id="6380731">Add</span><span class="op" id="6380734">(</span><span class="ident" id="6380735">delta</span>&nbsp;<span class="builtintype" id="6380741">float64</span><span class="op" id="6380748">)</span>&nbsp;<span class="op" id="6380750">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6380753">v</span><span class="op" id="6380754">.</span><span class="ident" id="6380755">mu</span><span class="op" id="6380757">.</span><span class="ident" id="6380758">Lock</span><span class="op" id="6380762">(</span><span class="op" id="6380763">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6380766">defer</span>&nbsp;<span class="ident" id="6380772">v</span><span class="op" id="6380773">.</span><span class="ident" id="6380774">mu</span><span class="op" id="6380776">.</span><span class="ident" id="6380777">Unlock</span><span class="op" id="6380783">(</span><span class="op" id="6380784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6380787">v</span><span class="op" id="6380788">.</span><span class="ident" id="6380789">f</span>&nbsp;<span class="op" id="6380791">+=</span>&nbsp;<span class="ident" id="6380794">delta</span><br>
<span class="lineno"></span><span class="op" id="6380800">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span><span class="comment" id="6380803">//&nbsp;Set&nbsp;sets&nbsp;v&nbsp;to&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="6380827">func</span>&nbsp;<span class="op" id="6380832">(</span><span class="ident" id="6380833">v</span>&nbsp;<span class="op" id="6380835">*</span><span class="ident" id="6380836">Float</span><span class="op" id="6380841">)</span>&nbsp;<span class="ident" id="6380843">Set</span><span class="op" id="6380846">(</span><span class="ident" id="6380847">value</span>&nbsp;<span class="builtintype" id="6380853">float64</span><span class="op" id="6380860">)</span>&nbsp;<span class="op" id="6380862">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6380865">v</span><span class="op" id="6380866">.</span><span class="ident" id="6380867">mu</span><span class="op" id="6380869">.</span><span class="ident" id="6380870">Lock</span><span class="op" id="6380874">(</span><span class="op" id="6380875">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6380878">defer</span>&nbsp;<span class="ident" id="6380884">v</span><span class="op" id="6380885">.</span><span class="ident" id="6380886">mu</span><span class="op" id="6380888">.</span><span class="ident" id="6380889">Unlock</span><span class="op" id="6380895">(</span><span class="op" id="6380896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6380899">v</span><span class="op" id="6380900">.</span><span class="ident" id="6380901">f</span>&nbsp;<span class="op" id="6380903">=</span>&nbsp;<span class="ident" id="6380905">value</span><br>
<span class="lineno">90</span><span class="op" id="6380911">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6380914">//&nbsp;Map&nbsp;is&nbsp;a&nbsp;string-to-Var&nbsp;map&nbsp;variable&nbsp;that&nbsp;satisfies&nbsp;the&nbsp;Var&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="6380987">type</span>&nbsp;<span class="ident" id="6380992">Map</span>&nbsp;<span class="keyword" id="6380996">struct</span>&nbsp;<span class="op" id="6381003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6381006">mu</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6381011">sync</span><span class="op" id="6381015">.</span><span class="ident" id="6381016">RWMutex</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6381025">m</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6381030">map</span><span class="op" id="6381033">[</span><span class="builtintype" id="6381034">string</span><span class="op" id="6381040">]</span><span class="ident" id="6381041">Var</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6381046">keys</span>&nbsp;<span class="op" id="6381051">[</span><span class="op" id="6381052">]</span><span class="builtintype" id="6381053">string</span>&nbsp;<span class="comment" id="6381060">//&nbsp;sorted</span><br>
<span class="lineno"></span><span class="op" id="6381070">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6381073">//&nbsp;KeyValue&nbsp;represents&nbsp;a&nbsp;single&nbsp;entry&nbsp;in&nbsp;a&nbsp;Map.</span><br>
<span class="lineno">100</span><span class="keyword" id="6381121">type</span>&nbsp;<span class="ident" id="6381126">KeyValue</span>&nbsp;<span class="keyword" id="6381135">struct</span>&nbsp;<span class="op" id="6381142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6381145">Key</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6381151">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6381159">Value</span>&nbsp;<span class="ident" id="6381165">Var</span><br>
<span class="lineno"></span><span class="op" id="6381169">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="keyword" id="6381172">func</span>&nbsp;<span class="op" id="6381177">(</span><span class="ident" id="6381178">v</span>&nbsp;<span class="op" id="6381180">*</span><span class="ident" id="6381181">Map</span><span class="op" id="6381184">)</span>&nbsp;<span class="ident" id="6381186">String</span><span class="op" id="6381192">(</span><span class="op" id="6381193">)</span>&nbsp;<span class="builtintype" id="6381195">string</span>&nbsp;<span class="op" id="6381202">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6381205">v</span><span class="op" id="6381206">.</span><span class="ident" id="6381207">mu</span><span class="op" id="6381209">.</span><span class="ident" id="6381210">RLock</span><span class="op" id="6381215">(</span><span class="op" id="6381216">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6381219">defer</span>&nbsp;<span class="ident" id="6381225">v</span><span class="op" id="6381226">.</span><span class="ident" id="6381227">mu</span><span class="op" id="6381229">.</span><span class="ident" id="6381230">RUnlock</span><span class="op" id="6381237">(</span><span class="op" id="6381238">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6381241">var</span>&nbsp;<span class="ident" id="6381245">b</span>&nbsp;<span class="ident" id="6381247">bytes</span><span class="op" id="6381252">.</span><span class="ident" id="6381253">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6381261">fmt</span><span class="op" id="6381264">.</span><span class="ident" id="6381265">Fprintf</span><span class="op" id="6381272">(</span><span class="op" id="6381273">&amp;</span><span class="ident" id="6381274">b</span><span class="op" id="6381275">,</span>&nbsp;<span class="string" id="6381277">&#34;{&#34;</span><span class="op" id="6381280">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6381283">first</span>&nbsp;<span class="op" id="6381289">:=</span>&nbsp;<span class="builtintype" id="6381292">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6381298">v</span><span class="op" id="6381299">.</span><span class="ident" id="6381300">doLocked</span><span class="op" id="6381308">(</span><span class="keyword" id="6381309">func</span><span class="op" id="6381313">(</span><span class="ident" id="6381314">kv</span>&nbsp;<span class="ident" id="6381317">KeyValue</span><span class="op" id="6381325">)</span>&nbsp;<span class="op" id="6381327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6381331">if</span>&nbsp;<span class="op" id="6381334">!</span><span class="ident" id="6381335">first</span>&nbsp;<span class="op" id="6381341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6381346">fmt</span><span class="op" id="6381349">.</span><span class="ident" id="6381350">Fprintf</span><span class="op" id="6381357">(</span><span class="op" id="6381358">&amp;</span><span class="ident" id="6381359">b</span><span class="op" id="6381360">,</span>&nbsp;<span class="string" id="6381362">&#34;,&nbsp;&#34;</span><span class="op" id="6381366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6381370">}</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6381374">fmt</span><span class="op" id="6381377">.</span><span class="ident" id="6381378">Fprintf</span><span class="op" id="6381385">(</span><span class="op" id="6381386">&amp;</span><span class="ident" id="6381387">b</span><span class="op" id="6381388">,</span>&nbsp;<span class="string" id="6381390">&#34;%q:&nbsp;%v&#34;</span><span class="op" id="6381398">,</span>&nbsp;<span class="ident" id="6381400">kv</span><span class="op" id="6381402">.</span><span class="ident" id="6381403">Key</span><span class="op" id="6381406">,</span>&nbsp;<span class="ident" id="6381408">kv</span><span class="op" id="6381410">.</span><span class="ident" id="6381411">Value</span><span class="op" id="6381416">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6381420">first</span>&nbsp;<span class="op" id="6381426">=</span>&nbsp;<span class="builtintype" id="6381428">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6381435">}</span><span class="op" id="6381436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6381439">fmt</span><span class="op" id="6381442">.</span><span class="ident" id="6381443">Fprintf</span><span class="op" id="6381450">(</span><span class="op" id="6381451">&amp;</span><span class="ident" id="6381452">b</span><span class="op" id="6381453">,</span>&nbsp;<span class="string" id="6381455">&#34;}&#34;</span><span class="op" id="6381458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6381461">return</span>&nbsp;<span class="ident" id="6381468">b</span><span class="op" id="6381469">.</span><span class="ident" id="6381470">String</span><span class="op" id="6381476">(</span><span class="op" id="6381477">)</span><br>
<span class="lineno">120</span><span class="op" id="6381479">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6381482">func</span>&nbsp;<span class="op" id="6381487">(</span><span class="ident" id="6381488">v</span>&nbsp;<span class="op" id="6381490">*</span><span class="ident" id="6381491">Map</span><span class="op" id="6381494">)</span>&nbsp;<span class="ident" id="6381496">Init</span><span class="op" id="6381500">(</span><span class="op" id="6381501">)</span>&nbsp;<span class="op" id="6381503">*</span><span class="ident" id="6381504">Map</span>&nbsp;<span class="op" id="6381508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6381511">v</span><span class="op" id="6381512">.</span><span class="ident" id="6381513">m</span>&nbsp;<span class="op" id="6381515">=</span>&nbsp;<span class="builtinfunc" id="6381517">make</span><span class="op" id="6381521">(</span><span class="keyword" id="6381522">map</span><span class="op" id="6381525">[</span><span class="builtintype" id="6381526">string</span><span class="op" id="6381532">]</span><span class="ident" id="6381533">Var</span><span class="op" id="6381536">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6381539">return</span>&nbsp;<span class="ident" id="6381546">v</span><br>
<span class="lineno">125</span><span class="op" id="6381548">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6381551">//&nbsp;updateKeys&nbsp;updates&nbsp;the&nbsp;sorted&nbsp;list&nbsp;of&nbsp;keys&nbsp;in&nbsp;v.keys.</span><br>
<span class="lineno"></span><span class="comment" id="6381608">//&nbsp;must&nbsp;be&nbsp;called&nbsp;with&nbsp;v.mu&nbsp;held.</span><br>
<span class="lineno"></span><span class="keyword" id="6381642">func</span>&nbsp;<span class="op" id="6381647">(</span><span class="ident" id="6381648">v</span>&nbsp;<span class="op" id="6381650">*</span><span class="ident" id="6381651">Map</span><span class="op" id="6381654">)</span>&nbsp;<span class="ident" id="6381656">updateKeys</span><span class="op" id="6381666">(</span><span class="op" id="6381667">)</span>&nbsp;<span class="op" id="6381669">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6381672">if</span>&nbsp;<span class="builtinfunc" id="6381675">len</span><span class="op" id="6381678">(</span><span class="ident" id="6381679">v</span><span class="op" id="6381680">.</span><span class="ident" id="6381681">m</span><span class="op" id="6381682">)</span>&nbsp;<span class="op" id="6381684">==</span>&nbsp;<span class="builtinfunc" id="6381687">len</span><span class="op" id="6381690">(</span><span class="ident" id="6381691">v</span><span class="op" id="6381692">.</span><span class="ident" id="6381693">keys</span><span class="op" id="6381697">)</span>&nbsp;<span class="op" id="6381699">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6381703">//&nbsp;No&nbsp;new&nbsp;key.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6381720">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6381728">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6381731">v</span><span class="op" id="6381732">.</span><span class="ident" id="6381733">keys</span>&nbsp;<span class="op" id="6381738">=</span>&nbsp;<span class="ident" id="6381740">v</span><span class="op" id="6381741">.</span><span class="ident" id="6381742">keys</span><span class="op" id="6381746">[</span><span class="op" id="6381747">:</span><span class="num" id="6381748">0</span><span class="op" id="6381749">]</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6381752">for</span>&nbsp;<span class="ident" id="6381756">k</span>&nbsp;<span class="op" id="6381758">:=</span>&nbsp;<span class="keyword" id="6381761">range</span>&nbsp;<span class="ident" id="6381767">v</span><span class="op" id="6381768">.</span><span class="ident" id="6381769">m</span>&nbsp;<span class="op" id="6381771">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6381775">v</span><span class="op" id="6381776">.</span><span class="ident" id="6381777">keys</span>&nbsp;<span class="op" id="6381782">=</span>&nbsp;<span class="builtinfunc" id="6381784">append</span><span class="op" id="6381790">(</span><span class="ident" id="6381791">v</span><span class="op" id="6381792">.</span><span class="ident" id="6381793">keys</span><span class="op" id="6381797">,</span>&nbsp;<span class="ident" id="6381799">k</span><span class="op" id="6381800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6381803">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6381806">sort</span><span class="op" id="6381810">.</span><span class="ident" id="6381811">Strings</span><span class="op" id="6381818">(</span><span class="ident" id="6381819">v</span><span class="op" id="6381820">.</span><span class="ident" id="6381821">keys</span><span class="op" id="6381825">)</span><br>
<span class="lineno"></span><span class="op" id="6381827">}</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span><span class="keyword" id="6381830">func</span>&nbsp;<span class="op" id="6381835">(</span><span class="ident" id="6381836">v</span>&nbsp;<span class="op" id="6381838">*</span><span class="ident" id="6381839">Map</span><span class="op" id="6381842">)</span>&nbsp;<span class="ident" id="6381844">Get</span><span class="op" id="6381847">(</span><span class="ident" id="6381848">key</span>&nbsp;<span class="builtintype" id="6381852">string</span><span class="op" id="6381858">)</span>&nbsp;<span class="ident" id="6381860">Var</span>&nbsp;<span class="op" id="6381864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6381867">v</span><span class="op" id="6381868">.</span><span class="ident" id="6381869">mu</span><span class="op" id="6381871">.</span><span class="ident" id="6381872">RLock</span><span class="op" id="6381877">(</span><span class="op" id="6381878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6381881">defer</span>&nbsp;<span class="ident" id="6381887">v</span><span class="op" id="6381888">.</span><span class="ident" id="6381889">mu</span><span class="op" id="6381891">.</span><span class="ident" id="6381892">RUnlock</span><span class="op" id="6381899">(</span><span class="op" id="6381900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6381903">return</span>&nbsp;<span class="ident" id="6381910">v</span><span class="op" id="6381911">.</span><span class="ident" id="6381912">m</span><span class="op" id="6381913">[</span><span class="ident" id="6381914">key</span><span class="op" id="6381917">]</span><br>
<span class="lineno">145</span><span class="op" id="6381919">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6381922">func</span>&nbsp;<span class="op" id="6381927">(</span><span class="ident" id="6381928">v</span>&nbsp;<span class="op" id="6381930">*</span><span class="ident" id="6381931">Map</span><span class="op" id="6381934">)</span>&nbsp;<span class="ident" id="6381936">Set</span><span class="op" id="6381939">(</span><span class="ident" id="6381940">key</span>&nbsp;<span class="builtintype" id="6381944">string</span><span class="op" id="6381950">,</span>&nbsp;<span class="ident" id="6381952">av</span>&nbsp;<span class="ident" id="6381955">Var</span><span class="op" id="6381958">)</span>&nbsp;<span class="op" id="6381960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6381963">v</span><span class="op" id="6381964">.</span><span class="ident" id="6381965">mu</span><span class="op" id="6381967">.</span><span class="ident" id="6381968">Lock</span><span class="op" id="6381972">(</span><span class="op" id="6381973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6381976">defer</span>&nbsp;<span class="ident" id="6381982">v</span><span class="op" id="6381983">.</span><span class="ident" id="6381984">mu</span><span class="op" id="6381986">.</span><span class="ident" id="6381987">Unlock</span><span class="op" id="6381993">(</span><span class="op" id="6381994">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6381997">v</span><span class="op" id="6381998">.</span><span class="ident" id="6381999">m</span><span class="op" id="6382000">[</span><span class="ident" id="6382001">key</span><span class="op" id="6382004">]</span>&nbsp;<span class="op" id="6382006">=</span>&nbsp;<span class="ident" id="6382008">av</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6382012">v</span><span class="op" id="6382013">.</span><span class="ident" id="6382014">updateKeys</span><span class="op" id="6382024">(</span><span class="op" id="6382025">)</span><br>
<span class="lineno"></span><span class="op" id="6382027">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6382030">func</span>&nbsp;<span class="op" id="6382035">(</span><span class="ident" id="6382036">v</span>&nbsp;<span class="op" id="6382038">*</span><span class="ident" id="6382039">Map</span><span class="op" id="6382042">)</span>&nbsp;<span class="ident" id="6382044">Add</span><span class="op" id="6382047">(</span><span class="ident" id="6382048">key</span>&nbsp;<span class="builtintype" id="6382052">string</span><span class="op" id="6382058">,</span>&nbsp;<span class="ident" id="6382060">delta</span>&nbsp;<span class="ident" id="6382066">int64</span><span class="op" id="6382071">)</span>&nbsp;<span class="op" id="6382073">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6382076">v</span><span class="op" id="6382077">.</span><span class="ident" id="6382078">mu</span><span class="op" id="6382080">.</span><span class="ident" id="6382081">RLock</span><span class="op" id="6382086">(</span><span class="op" id="6382087">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6382090">av</span><span class="op" id="6382092">,</span>&nbsp;<span class="ident" id="6382094">ok</span>&nbsp;<span class="op" id="6382097">:=</span>&nbsp;<span class="ident" id="6382100">v</span><span class="op" id="6382101">.</span><span class="ident" id="6382102">m</span><span class="op" id="6382103">[</span><span class="ident" id="6382104">key</span><span class="op" id="6382107">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6382110">v</span><span class="op" id="6382111">.</span><span class="ident" id="6382112">mu</span><span class="op" id="6382114">.</span><span class="ident" id="6382115">RUnlock</span><span class="op" id="6382122">(</span><span class="op" id="6382123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6382126">if</span>&nbsp;<span class="op" id="6382129">!</span><span class="ident" id="6382130">ok</span>&nbsp;<span class="op" id="6382133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6382137">//&nbsp;check&nbsp;again&nbsp;under&nbsp;the&nbsp;write&nbsp;lock</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6382175">v</span><span class="op" id="6382176">.</span><span class="ident" id="6382177">mu</span><span class="op" id="6382179">.</span><span class="ident" id="6382180">Lock</span><span class="op" id="6382184">(</span><span class="op" id="6382185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6382189">av</span><span class="op" id="6382191">,</span>&nbsp;<span class="ident" id="6382193">ok</span>&nbsp;<span class="op" id="6382196">=</span>&nbsp;<span class="ident" id="6382198">v</span><span class="op" id="6382199">.</span><span class="ident" id="6382200">m</span><span class="op" id="6382201">[</span><span class="ident" id="6382202">key</span><span class="op" id="6382205">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6382209">if</span>&nbsp;<span class="op" id="6382212">!</span><span class="ident" id="6382213">ok</span>&nbsp;<span class="op" id="6382216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6382221">av</span>&nbsp;<span class="op" id="6382224">=</span>&nbsp;<span class="builtinfunc" id="6382226">new</span><span class="op" id="6382229">(</span><span class="ident" id="6382230">Int</span><span class="op" id="6382233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6382238">v</span><span class="op" id="6382239">.</span><span class="ident" id="6382240">m</span><span class="op" id="6382241">[</span><span class="ident" id="6382242">key</span><span class="op" id="6382245">]</span>&nbsp;<span class="op" id="6382247">=</span>&nbsp;<span class="ident" id="6382249">av</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6382255">v</span><span class="op" id="6382256">.</span><span class="ident" id="6382257">updateKeys</span><span class="op" id="6382267">(</span><span class="op" id="6382268">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6382272">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6382276">v</span><span class="op" id="6382277">.</span><span class="ident" id="6382278">mu</span><span class="op" id="6382280">.</span><span class="ident" id="6382281">Unlock</span><span class="op" id="6382287">(</span><span class="op" id="6382288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6382291">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6382295">//&nbsp;Add&nbsp;to&nbsp;Int;&nbsp;ignore&nbsp;otherwise.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6382329">if</span>&nbsp;<span class="ident" id="6382332">iv</span><span class="op" id="6382334">,</span>&nbsp;<span class="ident" id="6382336">ok</span>&nbsp;<span class="op" id="6382339">:=</span>&nbsp;<span class="ident" id="6382342">av</span><span class="op" id="6382344">.</span><span class="op" id="6382345">(</span><span class="op" id="6382346">*</span><span class="ident" id="6382347">Int</span><span class="op" id="6382350">)</span><span class="op" id="6382351">;</span>&nbsp;<span class="ident" id="6382353">ok</span>&nbsp;<span class="op" id="6382356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6382360">iv</span><span class="op" id="6382362">.</span><span class="ident" id="6382363">Add</span><span class="op" id="6382366">(</span><span class="ident" id="6382367">delta</span><span class="op" id="6382372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6382375">}</span><br>
<span class="lineno"></span><span class="op" id="6382377">}</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span><span class="comment" id="6382380">//&nbsp;AddFloat&nbsp;adds&nbsp;delta&nbsp;to&nbsp;the&nbsp;*Float&nbsp;value&nbsp;stored&nbsp;under&nbsp;the&nbsp;given&nbsp;map&nbsp;key.</span><br>
<span class="lineno"></span><span class="keyword" id="6382455">func</span>&nbsp;<span class="op" id="6382460">(</span><span class="ident" id="6382461">v</span>&nbsp;<span class="op" id="6382463">*</span><span class="ident" id="6382464">Map</span><span class="op" id="6382467">)</span>&nbsp;<span class="ident" id="6382469">AddFloat</span><span class="op" id="6382477">(</span><span class="ident" id="6382478">key</span>&nbsp;<span class="builtintype" id="6382482">string</span><span class="op" id="6382488">,</span>&nbsp;<span class="ident" id="6382490">delta</span>&nbsp;<span class="builtintype" id="6382496">float64</span><span class="op" id="6382503">)</span>&nbsp;<span class="op" id="6382505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6382508">v</span><span class="op" id="6382509">.</span><span class="ident" id="6382510">mu</span><span class="op" id="6382512">.</span><span class="ident" id="6382513">RLock</span><span class="op" id="6382518">(</span><span class="op" id="6382519">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6382522">av</span><span class="op" id="6382524">,</span>&nbsp;<span class="ident" id="6382526">ok</span>&nbsp;<span class="op" id="6382529">:=</span>&nbsp;<span class="ident" id="6382532">v</span><span class="op" id="6382533">.</span><span class="ident" id="6382534">m</span><span class="op" id="6382535">[</span><span class="ident" id="6382536">key</span><span class="op" id="6382539">]</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6382542">v</span><span class="op" id="6382543">.</span><span class="ident" id="6382544">mu</span><span class="op" id="6382546">.</span><span class="ident" id="6382547">RUnlock</span><span class="op" id="6382554">(</span><span class="op" id="6382555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6382558">if</span>&nbsp;<span class="op" id="6382561">!</span><span class="ident" id="6382562">ok</span>&nbsp;<span class="op" id="6382565">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6382569">//&nbsp;check&nbsp;again&nbsp;under&nbsp;the&nbsp;write&nbsp;lock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6382607">v</span><span class="op" id="6382608">.</span><span class="ident" id="6382609">mu</span><span class="op" id="6382611">.</span><span class="ident" id="6382612">Lock</span><span class="op" id="6382616">(</span><span class="op" id="6382617">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6382621">av</span><span class="op" id="6382623">,</span>&nbsp;<span class="ident" id="6382625">ok</span>&nbsp;<span class="op" id="6382628">=</span>&nbsp;<span class="ident" id="6382630">v</span><span class="op" id="6382631">.</span><span class="ident" id="6382632">m</span><span class="op" id="6382633">[</span><span class="ident" id="6382634">key</span><span class="op" id="6382637">]</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6382641">if</span>&nbsp;<span class="op" id="6382644">!</span><span class="ident" id="6382645">ok</span>&nbsp;<span class="op" id="6382648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6382653">av</span>&nbsp;<span class="op" id="6382656">=</span>&nbsp;<span class="builtinfunc" id="6382658">new</span><span class="op" id="6382661">(</span><span class="ident" id="6382662">Float</span><span class="op" id="6382667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6382672">v</span><span class="op" id="6382673">.</span><span class="ident" id="6382674">m</span><span class="op" id="6382675">[</span><span class="ident" id="6382676">key</span><span class="op" id="6382679">]</span>&nbsp;<span class="op" id="6382681">=</span>&nbsp;<span class="ident" id="6382683">av</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6382689">v</span><span class="op" id="6382690">.</span><span class="ident" id="6382691">updateKeys</span><span class="op" id="6382701">(</span><span class="op" id="6382702">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6382706">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6382710">v</span><span class="op" id="6382711">.</span><span class="ident" id="6382712">mu</span><span class="op" id="6382714">.</span><span class="ident" id="6382715">Unlock</span><span class="op" id="6382721">(</span><span class="op" id="6382722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6382725">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6382729">//&nbsp;Add&nbsp;to&nbsp;Float;&nbsp;ignore&nbsp;otherwise.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6382765">if</span>&nbsp;<span class="ident" id="6382768">iv</span><span class="op" id="6382770">,</span>&nbsp;<span class="ident" id="6382772">ok</span>&nbsp;<span class="op" id="6382775">:=</span>&nbsp;<span class="ident" id="6382778">av</span><span class="op" id="6382780">.</span><span class="op" id="6382781">(</span><span class="op" id="6382782">*</span><span class="ident" id="6382783">Float</span><span class="op" id="6382788">)</span><span class="op" id="6382789">;</span>&nbsp;<span class="ident" id="6382791">ok</span>&nbsp;<span class="op" id="6382794">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6382798">iv</span><span class="op" id="6382800">.</span><span class="ident" id="6382801">Add</span><span class="op" id="6382804">(</span><span class="ident" id="6382805">delta</span><span class="op" id="6382810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6382813">}</span><br>
<span class="lineno"></span><span class="op" id="6382815">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6382818">//&nbsp;Do&nbsp;calls&nbsp;f&nbsp;for&nbsp;each&nbsp;entry&nbsp;in&nbsp;the&nbsp;map.</span><br>
<span class="lineno">200</span><span class="comment" id="6382859">//&nbsp;The&nbsp;map&nbsp;is&nbsp;locked&nbsp;during&nbsp;the&nbsp;iteration,</span><br>
<span class="lineno"></span><span class="comment" id="6382902">//&nbsp;but&nbsp;existing&nbsp;entries&nbsp;may&nbsp;be&nbsp;concurrently&nbsp;updated.</span><br>
<span class="lineno"></span><span class="keyword" id="6382955">func</span>&nbsp;<span class="op" id="6382960">(</span><span class="ident" id="6382961">v</span>&nbsp;<span class="op" id="6382963">*</span><span class="ident" id="6382964">Map</span><span class="op" id="6382967">)</span>&nbsp;<span class="ident" id="6382969">Do</span><span class="op" id="6382971">(</span><span class="ident" id="6382972">f</span>&nbsp;<span class="keyword" id="6382974">func</span><span class="op" id="6382978">(</span><span class="ident" id="6382979">KeyValue</span><span class="op" id="6382987">)</span><span class="op" id="6382988">)</span>&nbsp;<span class="op" id="6382990">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6382993">v</span><span class="op" id="6382994">.</span><span class="ident" id="6382995">mu</span><span class="op" id="6382997">.</span><span class="ident" id="6382998">RLock</span><span class="op" id="6383003">(</span><span class="op" id="6383004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6383007">defer</span>&nbsp;<span class="ident" id="6383013">v</span><span class="op" id="6383014">.</span><span class="ident" id="6383015">mu</span><span class="op" id="6383017">.</span><span class="ident" id="6383018">RUnlock</span><span class="op" id="6383025">(</span><span class="op" id="6383026">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6383029">v</span><span class="op" id="6383030">.</span><span class="ident" id="6383031">doLocked</span><span class="op" id="6383039">(</span><span class="ident" id="6383040">f</span><span class="op" id="6383041">)</span><br>
<span class="lineno"></span><span class="op" id="6383043">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6383046">//&nbsp;doLocked&nbsp;calls&nbsp;f&nbsp;for&nbsp;each&nbsp;entry&nbsp;in&nbsp;the&nbsp;map.</span><br>
<span class="lineno"></span><span class="comment" id="6383093">//&nbsp;v.mu&nbsp;must&nbsp;be&nbsp;held&nbsp;for&nbsp;reads.</span><br>
<span class="lineno">210</span><span class="keyword" id="6383125">func</span>&nbsp;<span class="op" id="6383130">(</span><span class="ident" id="6383131">v</span>&nbsp;<span class="op" id="6383133">*</span><span class="ident" id="6383134">Map</span><span class="op" id="6383137">)</span>&nbsp;<span class="ident" id="6383139">doLocked</span><span class="op" id="6383147">(</span><span class="ident" id="6383148">f</span>&nbsp;<span class="keyword" id="6383150">func</span><span class="op" id="6383154">(</span><span class="ident" id="6383155">KeyValue</span><span class="op" id="6383163">)</span><span class="op" id="6383164">)</span>&nbsp;<span class="op" id="6383166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6383169">for</span>&nbsp;<span class="ident" id="6383173">_</span><span class="op" id="6383174">,</span>&nbsp;<span class="ident" id="6383176">k</span>&nbsp;<span class="op" id="6383178">:=</span>&nbsp;<span class="keyword" id="6383181">range</span>&nbsp;<span class="ident" id="6383187">v</span><span class="op" id="6383188">.</span><span class="ident" id="6383189">keys</span>&nbsp;<span class="op" id="6383194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6383198">f</span><span class="op" id="6383199">(</span><span class="ident" id="6383200">KeyValue</span><span class="op" id="6383208">{</span><span class="ident" id="6383209">k</span><span class="op" id="6383210">,</span>&nbsp;<span class="ident" id="6383212">v</span><span class="op" id="6383213">.</span><span class="ident" id="6383214">m</span><span class="op" id="6383215">[</span><span class="ident" id="6383216">k</span><span class="op" id="6383217">]</span><span class="op" id="6383218">}</span><span class="op" id="6383219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6383222">}</span><br>
<span class="lineno"></span><span class="op" id="6383224">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="comment" id="6383227">//&nbsp;String&nbsp;is&nbsp;a&nbsp;string&nbsp;variable,&nbsp;and&nbsp;satisfies&nbsp;the&nbsp;Var&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="6383292">type</span>&nbsp;<span class="ident" id="6383297">String</span>&nbsp;<span class="keyword" id="6383304">struct</span>&nbsp;<span class="op" id="6383311">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6383314">mu</span>&nbsp;<span class="ident" id="6383317">sync</span><span class="op" id="6383321">.</span><span class="ident" id="6383322">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6383331">s</span>&nbsp;&nbsp;<span class="builtintype" id="6383334">string</span><br>
<span class="lineno">220</span><span class="op" id="6383341">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6383344">func</span>&nbsp;<span class="op" id="6383349">(</span><span class="ident" id="6383350">v</span>&nbsp;<span class="op" id="6383352">*</span><span class="ident" id="6383353">String</span><span class="op" id="6383359">)</span>&nbsp;<span class="ident" id="6383361">String</span><span class="op" id="6383367">(</span><span class="op" id="6383368">)</span>&nbsp;<span class="builtintype" id="6383370">string</span>&nbsp;<span class="op" id="6383377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6383380">v</span><span class="op" id="6383381">.</span><span class="ident" id="6383382">mu</span><span class="op" id="6383384">.</span><span class="ident" id="6383385">RLock</span><span class="op" id="6383390">(</span><span class="op" id="6383391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6383394">defer</span>&nbsp;<span class="ident" id="6383400">v</span><span class="op" id="6383401">.</span><span class="ident" id="6383402">mu</span><span class="op" id="6383404">.</span><span class="ident" id="6383405">RUnlock</span><span class="op" id="6383412">(</span><span class="op" id="6383413">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6383416">return</span>&nbsp;<span class="ident" id="6383423">strconv</span><span class="op" id="6383430">.</span><span class="ident" id="6383431">Quote</span><span class="op" id="6383436">(</span><span class="ident" id="6383437">v</span><span class="op" id="6383438">.</span><span class="ident" id="6383439">s</span><span class="op" id="6383440">)</span><br>
<span class="lineno"></span><span class="op" id="6383442">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6383445">func</span>&nbsp;<span class="op" id="6383450">(</span><span class="ident" id="6383451">v</span>&nbsp;<span class="op" id="6383453">*</span><span class="ident" id="6383454">String</span><span class="op" id="6383460">)</span>&nbsp;<span class="ident" id="6383462">Set</span><span class="op" id="6383465">(</span><span class="ident" id="6383466">value</span>&nbsp;<span class="builtintype" id="6383472">string</span><span class="op" id="6383478">)</span>&nbsp;<span class="op" id="6383480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6383483">v</span><span class="op" id="6383484">.</span><span class="ident" id="6383485">mu</span><span class="op" id="6383487">.</span><span class="ident" id="6383488">Lock</span><span class="op" id="6383492">(</span><span class="op" id="6383493">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6383496">defer</span>&nbsp;<span class="ident" id="6383502">v</span><span class="op" id="6383503">.</span><span class="ident" id="6383504">mu</span><span class="op" id="6383506">.</span><span class="ident" id="6383507">Unlock</span><span class="op" id="6383513">(</span><span class="op" id="6383514">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6383517">v</span><span class="op" id="6383518">.</span><span class="ident" id="6383519">s</span>&nbsp;<span class="op" id="6383521">=</span>&nbsp;<span class="ident" id="6383523">value</span><br>
<span class="lineno"></span><span class="op" id="6383529">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6383532">//&nbsp;Func&nbsp;implements&nbsp;Var&nbsp;by&nbsp;calling&nbsp;the&nbsp;function</span><br>
<span class="lineno">235</span><span class="comment" id="6383579">//&nbsp;and&nbsp;formatting&nbsp;the&nbsp;returned&nbsp;value&nbsp;using&nbsp;JSON.</span><br>
<span class="lineno"></span><span class="keyword" id="6383628">type</span>&nbsp;<span class="ident" id="6383633">Func</span>&nbsp;<span class="keyword" id="6383638">func</span><span class="op" id="6383642">(</span><span class="op" id="6383643">)</span>&nbsp;<span class="keyword" id="6383645">interface</span><span class="op" id="6383654">{</span><span class="op" id="6383655">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6383658">func</span>&nbsp;<span class="op" id="6383663">(</span><span class="ident" id="6383664">f</span>&nbsp;<span class="ident" id="6383666">Func</span><span class="op" id="6383670">)</span>&nbsp;<span class="ident" id="6383672">String</span><span class="op" id="6383678">(</span><span class="op" id="6383679">)</span>&nbsp;<span class="builtintype" id="6383681">string</span>&nbsp;<span class="op" id="6383688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6383691">v</span><span class="op" id="6383692">,</span>&nbsp;<span class="ident" id="6383694">_</span>&nbsp;<span class="op" id="6383696">:=</span>&nbsp;<span class="ident" id="6383699">json</span><span class="op" id="6383703">.</span><span class="ident" id="6383704">Marshal</span><span class="op" id="6383711">(</span><span class="ident" id="6383712">f</span><span class="op" id="6383713">(</span><span class="op" id="6383714">)</span><span class="op" id="6383715">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6383718">return</span>&nbsp;<span class="builtintype" id="6383725">string</span><span class="op" id="6383731">(</span><span class="ident" id="6383732">v</span><span class="op" id="6383733">)</span><br>
<span class="lineno"></span><span class="op" id="6383735">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6383738">//&nbsp;All&nbsp;published&nbsp;variables.</span><br>
<span class="lineno"></span><span class="keyword" id="6383766">var</span>&nbsp;<span class="op" id="6383770">(</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6383773">mutex</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="6383781">sync</span><span class="op" id="6383785">.</span><span class="ident" id="6383786">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6383795">vars</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6383803">=</span>&nbsp;<span class="builtinfunc" id="6383805">make</span><span class="op" id="6383809">(</span><span class="keyword" id="6383810">map</span><span class="op" id="6383813">[</span><span class="builtintype" id="6383814">string</span><span class="op" id="6383820">]</span><span class="ident" id="6383821">Var</span><span class="op" id="6383824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6383827">varKeys</span>&nbsp;<span class="op" id="6383835">[</span><span class="op" id="6383836">]</span><span class="builtintype" id="6383837">string</span>&nbsp;<span class="comment" id="6383844">//&nbsp;sorted</span><br>
<span class="lineno"></span><span class="op" id="6383854">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span><span class="comment" id="6383857">//&nbsp;Publish&nbsp;declares&nbsp;a&nbsp;named&nbsp;exported&nbsp;variable.&nbsp;This&nbsp;should&nbsp;be&nbsp;called&nbsp;from&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="6383933">//&nbsp;package&#39;s&nbsp;init&nbsp;function&nbsp;when&nbsp;it&nbsp;creates&nbsp;its&nbsp;Vars.&nbsp;If&nbsp;the&nbsp;name&nbsp;is&nbsp;already</span><br>
<span class="lineno"></span><span class="comment" id="6384009">//&nbsp;registered&nbsp;then&nbsp;this&nbsp;will&nbsp;log.Panic.</span><br>
<span class="lineno"></span><span class="keyword" id="6384049">func</span>&nbsp;<span class="ident" id="6384054">Publish</span><span class="op" id="6384061">(</span><span class="ident" id="6384062">name</span>&nbsp;<span class="builtintype" id="6384067">string</span><span class="op" id="6384073">,</span>&nbsp;<span class="ident" id="6384075">v</span>&nbsp;<span class="ident" id="6384077">Var</span><span class="op" id="6384080">)</span>&nbsp;<span class="op" id="6384082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6384085">mutex</span><span class="op" id="6384090">.</span><span class="ident" id="6384091">Lock</span><span class="op" id="6384095">(</span><span class="op" id="6384096">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6384099">defer</span>&nbsp;<span class="ident" id="6384105">mutex</span><span class="op" id="6384110">.</span><span class="ident" id="6384111">Unlock</span><span class="op" id="6384117">(</span><span class="op" id="6384118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6384121">if</span>&nbsp;<span class="ident" id="6384124">_</span><span class="op" id="6384125">,</span>&nbsp;<span class="ident" id="6384127">existing</span>&nbsp;<span class="op" id="6384136">:=</span>&nbsp;<span class="ident" id="6384139">vars</span><span class="op" id="6384143">[</span><span class="ident" id="6384144">name</span><span class="op" id="6384148">]</span><span class="op" id="6384149">;</span>&nbsp;<span class="ident" id="6384151">existing</span>&nbsp;<span class="op" id="6384160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6384164">log</span><span class="op" id="6384167">.</span><span class="ident" id="6384168">Panicln</span><span class="op" id="6384175">(</span><span class="string" id="6384176">&#34;Reuse&nbsp;of&nbsp;exported&nbsp;var&nbsp;name:&#34;</span><span class="op" id="6384205">,</span>&nbsp;<span class="ident" id="6384207">name</span><span class="op" id="6384211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6384214">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6384217">vars</span><span class="op" id="6384221">[</span><span class="ident" id="6384222">name</span><span class="op" id="6384226">]</span>&nbsp;<span class="op" id="6384228">=</span>&nbsp;<span class="ident" id="6384230">v</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6384233">varKeys</span>&nbsp;<span class="op" id="6384241">=</span>&nbsp;<span class="builtinfunc" id="6384243">append</span><span class="op" id="6384249">(</span><span class="ident" id="6384250">varKeys</span><span class="op" id="6384257">,</span>&nbsp;<span class="ident" id="6384259">name</span><span class="op" id="6384263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6384266">sort</span><span class="op" id="6384270">.</span><span class="ident" id="6384271">Strings</span><span class="op" id="6384278">(</span><span class="ident" id="6384279">varKeys</span><span class="op" id="6384286">)</span><br>
<span class="lineno"></span><span class="op" id="6384288">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6384291">//&nbsp;Get&nbsp;retrieves&nbsp;a&nbsp;named&nbsp;exported&nbsp;variable.</span><br>
<span class="lineno">265</span><span class="keyword" id="6384335">func</span>&nbsp;<span class="ident" id="6384340">Get</span><span class="op" id="6384343">(</span><span class="ident" id="6384344">name</span>&nbsp;<span class="builtintype" id="6384349">string</span><span class="op" id="6384355">)</span>&nbsp;<span class="ident" id="6384357">Var</span>&nbsp;<span class="op" id="6384361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6384364">mutex</span><span class="op" id="6384369">.</span><span class="ident" id="6384370">RLock</span><span class="op" id="6384375">(</span><span class="op" id="6384376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6384379">defer</span>&nbsp;<span class="ident" id="6384385">mutex</span><span class="op" id="6384390">.</span><span class="ident" id="6384391">RUnlock</span><span class="op" id="6384398">(</span><span class="op" id="6384399">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6384402">return</span>&nbsp;<span class="ident" id="6384409">vars</span><span class="op" id="6384413">[</span><span class="ident" id="6384414">name</span><span class="op" id="6384418">]</span><br>
<span class="lineno"></span><span class="op" id="6384420">}</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span><span class="comment" id="6384423">//&nbsp;Convenience&nbsp;functions&nbsp;for&nbsp;creating&nbsp;new&nbsp;exported&nbsp;variables.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6384486">func</span>&nbsp;<span class="ident" id="6384491">NewInt</span><span class="op" id="6384497">(</span><span class="ident" id="6384498">name</span>&nbsp;<span class="builtintype" id="6384503">string</span><span class="op" id="6384509">)</span>&nbsp;<span class="op" id="6384511">*</span><span class="ident" id="6384512">Int</span>&nbsp;<span class="op" id="6384516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6384519">v</span>&nbsp;<span class="op" id="6384521">:=</span>&nbsp;<span class="builtinfunc" id="6384524">new</span><span class="op" id="6384527">(</span><span class="ident" id="6384528">Int</span><span class="op" id="6384531">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6384534">Publish</span><span class="op" id="6384541">(</span><span class="ident" id="6384542">name</span><span class="op" id="6384546">,</span>&nbsp;<span class="ident" id="6384548">v</span><span class="op" id="6384549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6384552">return</span>&nbsp;<span class="ident" id="6384559">v</span><br>
<span class="lineno"></span><span class="op" id="6384561">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6384564">func</span>&nbsp;<span class="ident" id="6384569">NewFloat</span><span class="op" id="6384577">(</span><span class="ident" id="6384578">name</span>&nbsp;<span class="builtintype" id="6384583">string</span><span class="op" id="6384589">)</span>&nbsp;<span class="op" id="6384591">*</span><span class="ident" id="6384592">Float</span>&nbsp;<span class="op" id="6384598">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6384601">v</span>&nbsp;<span class="op" id="6384603">:=</span>&nbsp;<span class="builtinfunc" id="6384606">new</span><span class="op" id="6384609">(</span><span class="ident" id="6384610">Float</span><span class="op" id="6384615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6384618">Publish</span><span class="op" id="6384625">(</span><span class="ident" id="6384626">name</span><span class="op" id="6384630">,</span>&nbsp;<span class="ident" id="6384632">v</span><span class="op" id="6384633">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6384636">return</span>&nbsp;<span class="ident" id="6384643">v</span><br>
<span class="lineno"></span><span class="op" id="6384645">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="keyword" id="6384648">func</span>&nbsp;<span class="ident" id="6384653">NewMap</span><span class="op" id="6384659">(</span><span class="ident" id="6384660">name</span>&nbsp;<span class="builtintype" id="6384665">string</span><span class="op" id="6384671">)</span>&nbsp;<span class="op" id="6384673">*</span><span class="ident" id="6384674">Map</span>&nbsp;<span class="op" id="6384678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6384681">v</span>&nbsp;<span class="op" id="6384683">:=</span>&nbsp;<span class="builtinfunc" id="6384686">new</span><span class="op" id="6384689">(</span><span class="ident" id="6384690">Map</span><span class="op" id="6384693">)</span><span class="op" id="6384694">.</span><span class="ident" id="6384695">Init</span><span class="op" id="6384699">(</span><span class="op" id="6384700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6384703">Publish</span><span class="op" id="6384710">(</span><span class="ident" id="6384711">name</span><span class="op" id="6384715">,</span>&nbsp;<span class="ident" id="6384717">v</span><span class="op" id="6384718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6384721">return</span>&nbsp;<span class="ident" id="6384728">v</span><br>
<span class="lineno"></span><span class="op" id="6384730">}</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span><span class="keyword" id="6384733">func</span>&nbsp;<span class="ident" id="6384738">NewString</span><span class="op" id="6384747">(</span><span class="ident" id="6384748">name</span>&nbsp;<span class="builtintype" id="6384753">string</span><span class="op" id="6384759">)</span>&nbsp;<span class="op" id="6384761">*</span><span class="ident" id="6384762">String</span>&nbsp;<span class="op" id="6384769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6384772">v</span>&nbsp;<span class="op" id="6384774">:=</span>&nbsp;<span class="builtinfunc" id="6384777">new</span><span class="op" id="6384780">(</span><span class="ident" id="6384781">String</span><span class="op" id="6384787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6384790">Publish</span><span class="op" id="6384797">(</span><span class="ident" id="6384798">name</span><span class="op" id="6384802">,</span>&nbsp;<span class="ident" id="6384804">v</span><span class="op" id="6384805">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6384808">return</span>&nbsp;<span class="ident" id="6384815">v</span><br>
<span class="lineno">295</span><span class="op" id="6384817">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6384820">//&nbsp;Do&nbsp;calls&nbsp;f&nbsp;for&nbsp;each&nbsp;exported&nbsp;variable.</span><br>
<span class="lineno"></span><span class="comment" id="6384862">//&nbsp;The&nbsp;global&nbsp;variable&nbsp;map&nbsp;is&nbsp;locked&nbsp;during&nbsp;the&nbsp;iteration,</span><br>
<span class="lineno"></span><span class="comment" id="6384921">//&nbsp;but&nbsp;existing&nbsp;entries&nbsp;may&nbsp;be&nbsp;concurrently&nbsp;updated.</span><br>
<span class="lineno">300</span><span class="keyword" id="6384974">func</span>&nbsp;<span class="ident" id="6384979">Do</span><span class="op" id="6384981">(</span><span class="ident" id="6384982">f</span>&nbsp;<span class="keyword" id="6384984">func</span><span class="op" id="6384988">(</span><span class="ident" id="6384989">KeyValue</span><span class="op" id="6384997">)</span><span class="op" id="6384998">)</span>&nbsp;<span class="op" id="6385000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6385003">mutex</span><span class="op" id="6385008">.</span><span class="ident" id="6385009">RLock</span><span class="op" id="6385014">(</span><span class="op" id="6385015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6385018">defer</span>&nbsp;<span class="ident" id="6385024">mutex</span><span class="op" id="6385029">.</span><span class="ident" id="6385030">RUnlock</span><span class="op" id="6385037">(</span><span class="op" id="6385038">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6385041">for</span>&nbsp;<span class="ident" id="6385045">_</span><span class="op" id="6385046">,</span>&nbsp;<span class="ident" id="6385048">k</span>&nbsp;<span class="op" id="6385050">:=</span>&nbsp;<span class="keyword" id="6385053">range</span>&nbsp;<span class="ident" id="6385059">varKeys</span>&nbsp;<span class="op" id="6385067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6385071">f</span><span class="op" id="6385072">(</span><span class="ident" id="6385073">KeyValue</span><span class="op" id="6385081">{</span><span class="ident" id="6385082">k</span><span class="op" id="6385083">,</span>&nbsp;<span class="ident" id="6385085">vars</span><span class="op" id="6385089">[</span><span class="ident" id="6385090">k</span><span class="op" id="6385091">]</span><span class="op" id="6385092">}</span><span class="op" id="6385093">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6385096">}</span><br>
<span class="lineno"></span><span class="op" id="6385098">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6385101">func</span>&nbsp;<span class="ident" id="6385106">expvarHandler</span><span class="op" id="6385119">(</span><span class="ident" id="6385120">w</span>&nbsp;<span class="ident" id="6385122">http</span><span class="op" id="6385126">.</span><span class="ident" id="6385127">ResponseWriter</span><span class="op" id="6385141">,</span>&nbsp;<span class="ident" id="6385143">r</span>&nbsp;<span class="op" id="6385145">*</span><span class="ident" id="6385146">http</span><span class="op" id="6385150">.</span><span class="ident" id="6385151">Request</span><span class="op" id="6385158">)</span>&nbsp;<span class="op" id="6385160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6385163">w</span><span class="op" id="6385164">.</span><span class="ident" id="6385165">Header</span><span class="op" id="6385171">(</span><span class="op" id="6385172">)</span><span class="op" id="6385173">.</span><span class="ident" id="6385174">Set</span><span class="op" id="6385177">(</span><span class="string" id="6385178">&#34;Content-Type&#34;</span><span class="op" id="6385192">,</span>&nbsp;<span class="string" id="6385194">&#34;application/json;&nbsp;charset=utf-8&#34;</span><span class="op" id="6385227">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6385230">fmt</span><span class="op" id="6385233">.</span><span class="ident" id="6385234">Fprintf</span><span class="op" id="6385241">(</span><span class="ident" id="6385242">w</span><span class="op" id="6385243">,</span>&nbsp;<span class="string" id="6385245">&#34;{\n&#34;</span><span class="op" id="6385250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6385253">first</span>&nbsp;<span class="op" id="6385259">:=</span>&nbsp;<span class="builtintype" id="6385262">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6385268">Do</span><span class="op" id="6385270">(</span><span class="keyword" id="6385271">func</span><span class="op" id="6385275">(</span><span class="ident" id="6385276">kv</span>&nbsp;<span class="ident" id="6385279">KeyValue</span><span class="op" id="6385287">)</span>&nbsp;<span class="op" id="6385289">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6385293">if</span>&nbsp;<span class="op" id="6385296">!</span><span class="ident" id="6385297">first</span>&nbsp;<span class="op" id="6385303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6385308">fmt</span><span class="op" id="6385311">.</span><span class="ident" id="6385312">Fprintf</span><span class="op" id="6385319">(</span><span class="ident" id="6385320">w</span><span class="op" id="6385321">,</span>&nbsp;<span class="string" id="6385323">&#34;,\n&#34;</span><span class="op" id="6385328">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6385332">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6385336">first</span>&nbsp;<span class="op" id="6385342">=</span>&nbsp;<span class="builtintype" id="6385344">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6385352">fmt</span><span class="op" id="6385355">.</span><span class="ident" id="6385356">Fprintf</span><span class="op" id="6385363">(</span><span class="ident" id="6385364">w</span><span class="op" id="6385365">,</span>&nbsp;<span class="string" id="6385367">&#34;%q:&nbsp;%s&#34;</span><span class="op" id="6385375">,</span>&nbsp;<span class="ident" id="6385377">kv</span><span class="op" id="6385379">.</span><span class="ident" id="6385380">Key</span><span class="op" id="6385383">,</span>&nbsp;<span class="ident" id="6385385">kv</span><span class="op" id="6385387">.</span><span class="ident" id="6385388">Value</span><span class="op" id="6385393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6385396">}</span><span class="op" id="6385397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6385400">fmt</span><span class="op" id="6385403">.</span><span class="ident" id="6385404">Fprintf</span><span class="op" id="6385411">(</span><span class="ident" id="6385412">w</span><span class="op" id="6385413">,</span>&nbsp;<span class="string" id="6385415">&#34;\n}\n&#34;</span><span class="op" id="6385422">)</span><br>
<span class="lineno">320</span><span class="op" id="6385424">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6385427">func</span>&nbsp;<span class="ident" id="6385432">cmdline</span><span class="op" id="6385439">(</span><span class="op" id="6385440">)</span>&nbsp;<span class="keyword" id="6385442">interface</span><span class="op" id="6385451">{</span><span class="op" id="6385452">}</span>&nbsp;<span class="op" id="6385454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6385457">return</span>&nbsp;<span class="ident" id="6385464">os</span><span class="op" id="6385466">.</span><span class="ident" id="6385467">Args</span><br>
<span class="lineno"></span><span class="op" id="6385472">}</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span><span class="keyword" id="6385475">func</span>&nbsp;<span class="ident" id="6385480">memstats</span><span class="op" id="6385488">(</span><span class="op" id="6385489">)</span>&nbsp;<span class="keyword" id="6385491">interface</span><span class="op" id="6385500">{</span><span class="op" id="6385501">}</span>&nbsp;<span class="op" id="6385503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6385506">stats</span>&nbsp;<span class="op" id="6385512">:=</span>&nbsp;<span class="builtinfunc" id="6385515">new</span><span class="op" id="6385518">(</span><span class="ident" id="6385519">runtime</span><span class="op" id="6385526">.</span><span class="ident" id="6385527">MemStats</span><span class="op" id="6385535">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6385538">runtime</span><span class="op" id="6385545">.</span><span class="ident" id="6385546">ReadMemStats</span><span class="op" id="6385558">(</span><span class="ident" id="6385559">stats</span><span class="op" id="6385564">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6385567">return</span>&nbsp;<span class="op" id="6385574">*</span><span class="ident" id="6385575">stats</span><br>
<span class="lineno">330</span><span class="op" id="6385581">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6385584">func</span>&nbsp;<span class="ident" id="6385589">init</span><span class="op" id="6385593">(</span><span class="op" id="6385594">)</span>&nbsp;<span class="op" id="6385596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6385599">http</span><span class="op" id="6385603">.</span><span class="ident" id="6385604">HandleFunc</span><span class="op" id="6385614">(</span><span class="string" id="6385615">&#34;/debug/vars&#34;</span><span class="op" id="6385628">,</span>&nbsp;<span class="ident" id="6385630">expvarHandler</span><span class="op" id="6385643">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6385646">Publish</span><span class="op" id="6385653">(</span><span class="string" id="6385654">&#34;cmdline&#34;</span><span class="op" id="6385663">,</span>&nbsp;<span class="ident" id="6385665">Func</span><span class="op" id="6385669">(</span><span class="ident" id="6385670">cmdline</span><span class="op" id="6385677">)</span><span class="op" id="6385678">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6385681">Publish</span><span class="op" id="6385688">(</span><span class="string" id="6385689">&#34;memstats&#34;</span><span class="op" id="6385699">,</span>&nbsp;<span class="ident" id="6385701">Func</span><span class="op" id="6385705">(</span><span class="ident" id="6385706">memstats</span><span class="op" id="6385714">)</span><span class="op" id="6385715">)</span><br>
<span class="lineno"></span><span class="op" id="6385717">}</span>
</div>
</body>
</html>
