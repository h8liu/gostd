<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="1984246">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1984301">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1984355">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1984406">package</span>&nbsp;<span class="ident" id="1984414">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1984423">import</span>&nbsp;<span class="string" id="1984430">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1984440">var</span>&nbsp;<span class="ident" id="1984444">indexError</span>&nbsp;<span class="op" id="1984455">=</span>&nbsp;<span class="builtintype" id="1984457">error</span><span class="op" id="1984462">(</span><span class="ident" id="1984463">errorString</span><span class="op" id="1984474">(</span><span class="string" id="1984475">&#34;index&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="1984495">)</span><span class="op" id="1984496">)</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="1984499">func</span>&nbsp;<span class="ident" id="1984504">panicindex</span><span class="op" id="1984514">(</span><span class="op" id="1984515">)</span>&nbsp;<span class="op" id="1984517">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1984520">panic</span><span class="op" id="1984525">(</span><span class="ident" id="1984526">indexError</span><span class="op" id="1984536">)</span><br>
<span class="lineno"></span><span class="op" id="1984538">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="1984541">var</span>&nbsp;<span class="ident" id="1984545">sliceError</span>&nbsp;<span class="op" id="1984556">=</span>&nbsp;<span class="builtintype" id="1984558">error</span><span class="op" id="1984563">(</span><span class="ident" id="1984564">errorString</span><span class="op" id="1984575">(</span><span class="string" id="1984576">&#34;slice&nbsp;bounds&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="1984603">)</span><span class="op" id="1984604">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1984607">func</span>&nbsp;<span class="ident" id="1984612">panicslice</span><span class="op" id="1984622">(</span><span class="op" id="1984623">)</span>&nbsp;<span class="op" id="1984625">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1984628">panic</span><span class="op" id="1984633">(</span><span class="ident" id="1984634">sliceError</span><span class="op" id="1984644">)</span><br>
<span class="lineno"></span><span class="op" id="1984646">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="1984649">var</span>&nbsp;<span class="ident" id="1984653">divideError</span>&nbsp;<span class="op" id="1984665">=</span>&nbsp;<span class="builtintype" id="1984667">error</span><span class="op" id="1984672">(</span><span class="ident" id="1984673">errorString</span><span class="op" id="1984684">(</span><span class="string" id="1984685">&#34;integer&nbsp;divide&nbsp;by&nbsp;zero&#34;</span><span class="op" id="1984709">)</span><span class="op" id="1984710">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1984713">func</span>&nbsp;<span class="ident" id="1984718">panicdivide</span><span class="op" id="1984729">(</span><span class="op" id="1984730">)</span>&nbsp;<span class="op" id="1984732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1984735">panic</span><span class="op" id="1984740">(</span><span class="ident" id="1984741">divideError</span><span class="op" id="1984752">)</span><br>
<span class="lineno">25</span><span class="op" id="1984754">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1984757">var</span>&nbsp;<span class="ident" id="1984761">overflowError</span>&nbsp;<span class="op" id="1984775">=</span>&nbsp;<span class="builtintype" id="1984777">error</span><span class="op" id="1984782">(</span><span class="ident" id="1984783">errorString</span><span class="op" id="1984794">(</span><span class="string" id="1984795">&#34;integer&nbsp;overflow&#34;</span><span class="op" id="1984813">)</span><span class="op" id="1984814">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1984817">func</span>&nbsp;<span class="ident" id="1984822">panicoverflow</span><span class="op" id="1984835">(</span><span class="op" id="1984836">)</span>&nbsp;<span class="op" id="1984838">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1984841">panic</span><span class="op" id="1984846">(</span><span class="ident" id="1984847">overflowError</span><span class="op" id="1984860">)</span><br>
<span class="lineno"></span><span class="op" id="1984862">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1984865">var</span>&nbsp;<span class="ident" id="1984869">floatError</span>&nbsp;<span class="op" id="1984880">=</span>&nbsp;<span class="builtintype" id="1984882">error</span><span class="op" id="1984887">(</span><span class="ident" id="1984888">errorString</span><span class="op" id="1984899">(</span><span class="string" id="1984900">&#34;floating&nbsp;point&nbsp;error&#34;</span><span class="op" id="1984922">)</span><span class="op" id="1984923">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="keyword" id="1984926">func</span>&nbsp;<span class="ident" id="1984931">panicfloat</span><span class="op" id="1984941">(</span><span class="op" id="1984942">)</span>&nbsp;<span class="op" id="1984944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1984947">panic</span><span class="op" id="1984952">(</span><span class="ident" id="1984953">floatError</span><span class="op" id="1984963">)</span><br>
<span class="lineno"></span><span class="op" id="1984965">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1984968">var</span>&nbsp;<span class="ident" id="1984972">memoryError</span>&nbsp;<span class="op" id="1984984">=</span>&nbsp;<span class="builtintype" id="1984986">error</span><span class="op" id="1984991">(</span><span class="ident" id="1984992">errorString</span><span class="op" id="1985003">(</span><span class="string" id="1985004">&#34;invalid&nbsp;memory&nbsp;address&nbsp;or&nbsp;nil&nbsp;pointer&nbsp;dereference&#34;</span><span class="op" id="1985055">)</span><span class="op" id="1985056">)</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="keyword" id="1985059">func</span>&nbsp;<span class="ident" id="1985064">panicmem</span><span class="op" id="1985072">(</span><span class="op" id="1985073">)</span>&nbsp;<span class="op" id="1985075">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1985078">panic</span><span class="op" id="1985083">(</span><span class="ident" id="1985084">memoryError</span><span class="op" id="1985095">)</span><br>
<span class="lineno"></span><span class="op" id="1985097">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="keyword" id="1985100">func</span>&nbsp;<span class="ident" id="1985105">throwreturn</span><span class="op" id="1985116">(</span><span class="op" id="1985117">)</span>&nbsp;<span class="op" id="1985119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1985122">gothrow</span><span class="op" id="1985129">(</span><span class="string" id="1985130">&#34;no&nbsp;return&nbsp;at&nbsp;end&nbsp;of&nbsp;a&nbsp;typed&nbsp;function&nbsp;-&nbsp;compiler&nbsp;is&nbsp;broken&#34;</span><span class="op" id="1985189">)</span><br>
<span class="lineno"></span><span class="op" id="1985191">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1985194">func</span>&nbsp;<span class="ident" id="1985199">throwinit</span><span class="op" id="1985208">(</span><span class="op" id="1985209">)</span>&nbsp;<span class="op" id="1985211">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1985214">gothrow</span><span class="op" id="1985221">(</span><span class="string" id="1985222">&#34;recursive&nbsp;call&nbsp;during&nbsp;initialization&nbsp;-&nbsp;linker&nbsp;skew&#34;</span><span class="op" id="1985274">)</span><br>
<span class="lineno"></span><span class="op" id="1985276">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1985279">//&nbsp;Create&nbsp;a&nbsp;new&nbsp;deferred&nbsp;function&nbsp;fn&nbsp;with&nbsp;siz&nbsp;bytes&nbsp;of&nbsp;arguments.</span><br>
<span class="lineno"></span><span class="comment" id="1985345">//&nbsp;The&nbsp;compiler&nbsp;turns&nbsp;a&nbsp;defer&nbsp;statement&nbsp;into&nbsp;a&nbsp;call&nbsp;to&nbsp;this.</span><br>
<span class="lineno">55</span><span class="comment" id="1985406">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1985419">func</span>&nbsp;<span class="ident" id="1985424">deferproc</span><span class="op" id="1985433">(</span><span class="ident" id="1985434">siz</span>&nbsp;<span class="builtintype" id="1985438">int32</span><span class="op" id="1985443">,</span>&nbsp;<span class="ident" id="1985445">fn</span>&nbsp;<span class="op" id="1985448">*</span><span class="ident" id="1985449">funcval</span><span class="op" id="1985456">)</span>&nbsp;<span class="op" id="1985458">{</span>&nbsp;<span class="comment" id="1985460">//&nbsp;arguments&nbsp;of&nbsp;fn&nbsp;follow&nbsp;fn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1985490">//&nbsp;the&nbsp;arguments&nbsp;of&nbsp;fn&nbsp;are&nbsp;in&nbsp;a&nbsp;perilous&nbsp;state.&nbsp;&nbsp;The&nbsp;stack&nbsp;map</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1985554">//&nbsp;for&nbsp;deferproc&nbsp;does&nbsp;not&nbsp;describe&nbsp;them.&nbsp;&nbsp;So&nbsp;we&nbsp;can&#39;t&nbsp;let&nbsp;garbage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1985621">//&nbsp;collection&nbsp;or&nbsp;stack&nbsp;copying&nbsp;trigger&nbsp;until&nbsp;we&#39;ve&nbsp;copied&nbsp;them&nbsp;out</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1985689">//&nbsp;to&nbsp;somewhere&nbsp;safe.&nbsp;&nbsp;deferproc_m&nbsp;does&nbsp;that.&nbsp;&nbsp;Until&nbsp;deferproc_m,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1985756">//&nbsp;we&nbsp;can&nbsp;only&nbsp;call&nbsp;nosplit&nbsp;routines.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1985795">argp</span>&nbsp;<span class="op" id="1985800">:=</span>&nbsp;<span class="builtintype" id="1985803">uintptr</span><span class="op" id="1985810">(</span><span class="ident" id="1985811">unsafe</span><span class="op" id="1985817">.</span><span class="ident" id="1985818">Pointer</span><span class="op" id="1985825">(</span><span class="op" id="1985826">&amp;</span><span class="ident" id="1985827">fn</span><span class="op" id="1985829">)</span><span class="op" id="1985830">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1985833">argp</span>&nbsp;<span class="op" id="1985838">+=</span>&nbsp;<span class="ident" id="1985841">unsafe</span><span class="op" id="1985847">.</span><span class="ident" id="1985848">Sizeof</span><span class="op" id="1985854">(</span><span class="ident" id="1985855">fn</span><span class="op" id="1985857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1985860">if</span>&nbsp;<span class="ident" id="1985863">GOARCH</span>&nbsp;<span class="op" id="1985870">==</span>&nbsp;<span class="string" id="1985873">&#34;arm&#34;</span>&nbsp;<span class="op" id="1985879">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1985883">argp</span>&nbsp;<span class="op" id="1985888">+=</span>&nbsp;<span class="ident" id="1985891">ptrSize</span>&nbsp;<span class="comment" id="1985899">//&nbsp;skip&nbsp;caller&#39;s&nbsp;saved&nbsp;link&nbsp;register</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1985937">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1985940">mp</span>&nbsp;<span class="op" id="1985943">:=</span>&nbsp;<span class="ident" id="1985946">acquirem</span><span class="op" id="1985954">(</span><span class="op" id="1985955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1985958">mp</span><span class="op" id="1985960">.</span><span class="ident" id="1985961">scalararg</span><span class="op" id="1985970">[</span><span class="num" id="1985971">0</span><span class="op" id="1985972">]</span>&nbsp;<span class="op" id="1985974">=</span>&nbsp;<span class="builtintype" id="1985976">uintptr</span><span class="op" id="1985983">(</span><span class="ident" id="1985984">siz</span><span class="op" id="1985987">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1985990">mp</span><span class="op" id="1985992">.</span><span class="ident" id="1985993">ptrarg</span><span class="op" id="1985999">[</span><span class="num" id="1986000">0</span><span class="op" id="1986001">]</span>&nbsp;<span class="op" id="1986003">=</span>&nbsp;<span class="ident" id="1986005">unsafe</span><span class="op" id="1986011">.</span><span class="ident" id="1986012">Pointer</span><span class="op" id="1986019">(</span><span class="ident" id="1986020">fn</span><span class="op" id="1986022">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1986025">mp</span><span class="op" id="1986027">.</span><span class="ident" id="1986028">scalararg</span><span class="op" id="1986037">[</span><span class="num" id="1986038">1</span><span class="op" id="1986039">]</span>&nbsp;<span class="op" id="1986041">=</span>&nbsp;<span class="ident" id="1986043">argp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1986049">mp</span><span class="op" id="1986051">.</span><span class="ident" id="1986052">scalararg</span><span class="op" id="1986061">[</span><span class="num" id="1986062">2</span><span class="op" id="1986063">]</span>&nbsp;<span class="op" id="1986065">=</span>&nbsp;<span class="ident" id="1986067">getcallerpc</span><span class="op" id="1986078">(</span><span class="ident" id="1986079">unsafe</span><span class="op" id="1986085">.</span><span class="ident" id="1986086">Pointer</span><span class="op" id="1986093">(</span><span class="op" id="1986094">&amp;</span><span class="ident" id="1986095">siz</span><span class="op" id="1986098">)</span><span class="op" id="1986099">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1986103">if</span>&nbsp;<span class="ident" id="1986106">mp</span><span class="op" id="1986108">.</span><span class="ident" id="1986109">curg</span>&nbsp;<span class="op" id="1986114">!=</span>&nbsp;<span class="ident" id="1986117">getg</span><span class="op" id="1986121">(</span><span class="op" id="1986122">)</span>&nbsp;<span class="op" id="1986124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1986128">//&nbsp;go&nbsp;code&nbsp;on&nbsp;the&nbsp;m&nbsp;stack&nbsp;can&#39;t&nbsp;defer</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1986168">gothrow</span><span class="op" id="1986175">(</span><span class="string" id="1986176">&#34;defer&nbsp;on&nbsp;m&#34;</span><span class="op" id="1986188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1986191">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1986195">onM</span><span class="op" id="1986198">(</span><span class="ident" id="1986199">deferproc_m</span><span class="op" id="1986210">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1986214">releasem</span><span class="op" id="1986222">(</span><span class="ident" id="1986223">mp</span><span class="op" id="1986225">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1986229">//&nbsp;deferproc&nbsp;returns&nbsp;0&nbsp;normally.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1986263">//&nbsp;a&nbsp;deferred&nbsp;func&nbsp;that&nbsp;stops&nbsp;a&nbsp;panic</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1986302">//&nbsp;makes&nbsp;the&nbsp;deferproc&nbsp;return&nbsp;1.</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1986336">//&nbsp;the&nbsp;code&nbsp;the&nbsp;compiler&nbsp;generates&nbsp;always</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1986379">//&nbsp;checks&nbsp;the&nbsp;return&nbsp;value&nbsp;and&nbsp;jumps&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1986424">//&nbsp;end&nbsp;of&nbsp;the&nbsp;function&nbsp;if&nbsp;deferproc&nbsp;returns&nbsp;!=&nbsp;0.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1986475">return0</span><span class="op" id="1986482">(</span><span class="op" id="1986483">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1986486">//&nbsp;No&nbsp;code&nbsp;can&nbsp;go&nbsp;here&nbsp;-&nbsp;the&nbsp;C&nbsp;return&nbsp;register&nbsp;has</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1986538">//&nbsp;been&nbsp;set&nbsp;and&nbsp;must&nbsp;not&nbsp;be&nbsp;clobbered.</span><br>
<span class="lineno"></span><span class="op" id="1986577">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1986580">//&nbsp;Small&nbsp;malloc&nbsp;size&nbsp;classes&nbsp;&gt;=&nbsp;16&nbsp;are&nbsp;the&nbsp;multiples&nbsp;of&nbsp;16:&nbsp;16,&nbsp;32,&nbsp;48,&nbsp;64,&nbsp;80,&nbsp;96,&nbsp;112,&nbsp;128,&nbsp;144,&nbsp;...</span><br>
<span class="lineno"></span><span class="comment" id="1986683">//&nbsp;Each&nbsp;P&nbsp;holds&nbsp;a&nbsp;pool&nbsp;for&nbsp;defers&nbsp;with&nbsp;small&nbsp;arg&nbsp;sizes.</span><br>
<span class="lineno">95</span><span class="comment" id="1986739">//&nbsp;Assign&nbsp;defer&nbsp;allocations&nbsp;to&nbsp;pools&nbsp;by&nbsp;rounding&nbsp;to&nbsp;16,&nbsp;to&nbsp;match&nbsp;malloc&nbsp;size&nbsp;classes.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1986826">const</span>&nbsp;<span class="op" id="1986832">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1986835">deferHeaderSize</span>&nbsp;<span class="op" id="1986851">=</span>&nbsp;<span class="ident" id="1986853">unsafe</span><span class="op" id="1986859">.</span><span class="ident" id="1986860">Sizeof</span><span class="op" id="1986866">(</span><span class="ident" id="1986867">_defer</span><span class="op" id="1986873">{</span><span class="op" id="1986874">}</span><span class="op" id="1986875">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1986878">minDeferAlloc</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1986894">=</span>&nbsp;<span class="op" id="1986896">(</span><span class="ident" id="1986897">deferHeaderSize</span>&nbsp;<span class="op" id="1986913">+</span>&nbsp;<span class="num" id="1986915">15</span><span class="op" id="1986917">)</span>&nbsp;<span class="op" id="1986919">&amp;^</span>&nbsp;<span class="num" id="1986922">15</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1986926">minDeferArgs</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1986942">=</span>&nbsp;<span class="ident" id="1986944">minDeferAlloc</span>&nbsp;<span class="op" id="1986958">-</span>&nbsp;<span class="ident" id="1986960">deferHeaderSize</span><br>
<span class="lineno"></span><span class="op" id="1986976">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1986979">//&nbsp;defer&nbsp;size&nbsp;class&nbsp;for&nbsp;arg&nbsp;size&nbsp;sz</span><br>
<span class="lineno"></span><span class="comment" id="1987015">//go:nosplit</span><br>
<span class="lineno">105</span><span class="keyword" id="1987028">func</span>&nbsp;<span class="ident" id="1987033">deferclass</span><span class="op" id="1987043">(</span><span class="ident" id="1987044">siz</span>&nbsp;<span class="builtintype" id="1987048">uintptr</span><span class="op" id="1987055">)</span>&nbsp;<span class="builtintype" id="1987057">uintptr</span>&nbsp;<span class="op" id="1987065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1987068">if</span>&nbsp;<span class="ident" id="1987071">siz</span>&nbsp;<span class="op" id="1987075">&lt;=</span>&nbsp;<span class="ident" id="1987078">minDeferArgs</span>&nbsp;<span class="op" id="1987091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1987095">return</span>&nbsp;<span class="num" id="1987102">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1987105">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1987108">return</span>&nbsp;<span class="op" id="1987115">(</span><span class="ident" id="1987116">siz</span>&nbsp;<span class="op" id="1987120">-</span>&nbsp;<span class="ident" id="1987122">minDeferArgs</span>&nbsp;<span class="op" id="1987135">+</span>&nbsp;<span class="num" id="1987137">15</span><span class="op" id="1987139">)</span>&nbsp;<span class="op" id="1987141">/</span>&nbsp;<span class="num" id="1987143">16</span><br>
<span class="lineno">110</span><span class="op" id="1987146">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1987149">//&nbsp;total&nbsp;size&nbsp;of&nbsp;memory&nbsp;block&nbsp;for&nbsp;defer&nbsp;with&nbsp;arg&nbsp;size&nbsp;sz</span><br>
<span class="lineno"></span><span class="keyword" id="1987206">func</span>&nbsp;<span class="ident" id="1987211">totaldefersize</span><span class="op" id="1987225">(</span><span class="ident" id="1987226">siz</span>&nbsp;<span class="builtintype" id="1987230">uintptr</span><span class="op" id="1987237">)</span>&nbsp;<span class="builtintype" id="1987239">uintptr</span>&nbsp;<span class="op" id="1987247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1987250">if</span>&nbsp;<span class="ident" id="1987253">siz</span>&nbsp;<span class="op" id="1987257">&lt;=</span>&nbsp;<span class="ident" id="1987260">minDeferArgs</span>&nbsp;<span class="op" id="1987273">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1987277">return</span>&nbsp;<span class="ident" id="1987284">minDeferAlloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1987299">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1987302">return</span>&nbsp;<span class="ident" id="1987309">deferHeaderSize</span>&nbsp;<span class="op" id="1987325">+</span>&nbsp;<span class="ident" id="1987327">siz</span><br>
<span class="lineno"></span><span class="op" id="1987331">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="comment" id="1987334">//&nbsp;Ensure&nbsp;that&nbsp;defer&nbsp;arg&nbsp;sizes&nbsp;that&nbsp;map&nbsp;to&nbsp;the&nbsp;same&nbsp;defer&nbsp;size&nbsp;class</span><br>
<span class="lineno"></span><span class="comment" id="1987403">//&nbsp;also&nbsp;map&nbsp;to&nbsp;the&nbsp;same&nbsp;malloc&nbsp;size&nbsp;class.</span><br>
<span class="lineno"></span><span class="keyword" id="1987446">func</span>&nbsp;<span class="ident" id="1987451">testdefersizes</span><span class="op" id="1987465">(</span><span class="op" id="1987466">)</span>&nbsp;<span class="op" id="1987468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1987471">var</span>&nbsp;<span class="ident" id="1987475">m</span>&nbsp;<span class="op" id="1987477">[</span><span class="builtinfunc" id="1987478">len</span><span class="op" id="1987481">(</span><span class="ident" id="1987482">p</span><span class="op" id="1987483">{</span><span class="op" id="1987484">}</span><span class="op" id="1987485">.</span><span class="ident" id="1987486">deferpool</span><span class="op" id="1987495">)</span><span class="op" id="1987496">]</span><span class="builtintype" id="1987497">int32</span><br>
<span class="lineno"></span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1987505">for</span>&nbsp;<span class="ident" id="1987509">i</span>&nbsp;<span class="op" id="1987511">:=</span>&nbsp;<span class="keyword" id="1987514">range</span>&nbsp;<span class="ident" id="1987520">m</span>&nbsp;<span class="op" id="1987522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1987526">m</span><span class="op" id="1987527">[</span><span class="ident" id="1987528">i</span><span class="op" id="1987529">]</span>&nbsp;<span class="op" id="1987531">=</span>&nbsp;<span class="op" id="1987533">-</span><span class="num" id="1987534">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1987537">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1987540">for</span>&nbsp;<span class="ident" id="1987544">i</span>&nbsp;<span class="op" id="1987546">:=</span>&nbsp;<span class="builtintype" id="1987549">uintptr</span><span class="op" id="1987556">(</span><span class="num" id="1987557">0</span><span class="op" id="1987558">)</span><span class="op" id="1987559">;</span>&nbsp;<span class="op" id="1987561">;</span>&nbsp;<span class="ident" id="1987563">i</span><span class="op" id="1987564">++</span>&nbsp;<span class="op" id="1987567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1987571">defersc</span>&nbsp;<span class="op" id="1987579">:=</span>&nbsp;<span class="ident" id="1987582">deferclass</span><span class="op" id="1987592">(</span><span class="ident" id="1987593">i</span><span class="op" id="1987594">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1987598">if</span>&nbsp;<span class="ident" id="1987601">defersc</span>&nbsp;<span class="op" id="1987609">&gt;=</span>&nbsp;<span class="builtintype" id="1987612">uintptr</span><span class="op" id="1987619">(</span><span class="builtinfunc" id="1987620">len</span><span class="op" id="1987623">(</span><span class="ident" id="1987624">m</span><span class="op" id="1987625">)</span><span class="op" id="1987626">)</span>&nbsp;<span class="op" id="1987628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1987633">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1987641">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1987645">siz</span>&nbsp;<span class="op" id="1987649">:=</span>&nbsp;<span class="ident" id="1987652">goroundupsize</span><span class="op" id="1987665">(</span><span class="ident" id="1987666">totaldefersize</span><span class="op" id="1987680">(</span><span class="ident" id="1987681">i</span><span class="op" id="1987682">)</span><span class="op" id="1987683">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1987687">if</span>&nbsp;<span class="ident" id="1987690">m</span><span class="op" id="1987691">[</span><span class="ident" id="1987692">defersc</span><span class="op" id="1987699">]</span>&nbsp;<span class="op" id="1987701">&lt;</span>&nbsp;<span class="num" id="1987703">0</span>&nbsp;<span class="op" id="1987705">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1987710">m</span><span class="op" id="1987711">[</span><span class="ident" id="1987712">defersc</span><span class="op" id="1987719">]</span>&nbsp;<span class="op" id="1987721">=</span>&nbsp;<span class="builtintype" id="1987723">int32</span><span class="op" id="1987728">(</span><span class="ident" id="1987729">siz</span><span class="op" id="1987732">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1987737">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1987748">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1987752">if</span>&nbsp;<span class="ident" id="1987755">m</span><span class="op" id="1987756">[</span><span class="ident" id="1987757">defersc</span><span class="op" id="1987764">]</span>&nbsp;<span class="op" id="1987766">!=</span>&nbsp;<span class="builtintype" id="1987769">int32</span><span class="op" id="1987774">(</span><span class="ident" id="1987775">siz</span><span class="op" id="1987778">)</span>&nbsp;<span class="op" id="1987780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1987785">print</span><span class="op" id="1987790">(</span><span class="string" id="1987791">&#34;bad&nbsp;defer&nbsp;size&nbsp;class:&nbsp;i=&#34;</span><span class="op" id="1987817">,</span>&nbsp;<span class="ident" id="1987819">i</span><span class="op" id="1987820">,</span>&nbsp;<span class="string" id="1987822">&#34;&nbsp;siz=&#34;</span><span class="op" id="1987829">,</span>&nbsp;<span class="ident" id="1987831">siz</span><span class="op" id="1987834">,</span>&nbsp;<span class="string" id="1987836">&#34;&nbsp;defersc=&#34;</span><span class="op" id="1987847">,</span>&nbsp;<span class="ident" id="1987849">defersc</span><span class="op" id="1987856">,</span>&nbsp;<span class="string" id="1987858">&#34;\n&#34;</span><span class="op" id="1987862">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1987867">gothrow</span><span class="op" id="1987874">(</span><span class="string" id="1987875">&#34;bad&nbsp;defer&nbsp;size&nbsp;class&#34;</span><span class="op" id="1987897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1987901">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1987904">}</span><br>
<span class="lineno"></span><span class="op" id="1987906">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="comment" id="1987909">//&nbsp;The&nbsp;arguments&nbsp;associated&nbsp;with&nbsp;a&nbsp;deferred&nbsp;call&nbsp;are&nbsp;stored</span><br>
<span class="lineno"></span><span class="comment" id="1987969">//&nbsp;immediately&nbsp;after&nbsp;the&nbsp;_defer&nbsp;header&nbsp;in&nbsp;memory.</span><br>
<span class="lineno"></span><span class="comment" id="1988019">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1988032">func</span>&nbsp;<span class="ident" id="1988037">deferArgs</span><span class="op" id="1988046">(</span><span class="ident" id="1988047">d</span>&nbsp;<span class="op" id="1988049">*</span><span class="ident" id="1988050">_defer</span><span class="op" id="1988056">)</span>&nbsp;<span class="ident" id="1988058">unsafe</span><span class="op" id="1988064">.</span><span class="ident" id="1988065">Pointer</span>&nbsp;<span class="op" id="1988073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1988076">return</span>&nbsp;<span class="ident" id="1988083">add</span><span class="op" id="1988086">(</span><span class="ident" id="1988087">unsafe</span><span class="op" id="1988093">.</span><span class="ident" id="1988094">Pointer</span><span class="op" id="1988101">(</span><span class="ident" id="1988102">d</span><span class="op" id="1988103">)</span><span class="op" id="1988104">,</span>&nbsp;<span class="ident" id="1988106">unsafe</span><span class="op" id="1988112">.</span><span class="ident" id="1988113">Sizeof</span><span class="op" id="1988119">(</span><span class="op" id="1988120">*</span><span class="ident" id="1988121">d</span><span class="op" id="1988122">)</span><span class="op" id="1988123">)</span><br>
<span class="lineno">150</span><span class="op" id="1988125">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1988128">var</span>&nbsp;<span class="ident" id="1988132">deferType</span>&nbsp;<span class="op" id="1988142">*</span><span class="ident" id="1988143">_type</span>&nbsp;<span class="comment" id="1988149">//&nbsp;type&nbsp;of&nbsp;_defer&nbsp;struct</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1988175">func</span>&nbsp;<span class="ident" id="1988180">init</span><span class="op" id="1988184">(</span><span class="op" id="1988185">)</span>&nbsp;<span class="op" id="1988187">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1988190">var</span>&nbsp;<span class="ident" id="1988194">x</span>&nbsp;<span class="keyword" id="1988196">interface</span><span class="op" id="1988205">{</span><span class="op" id="1988206">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1988209">x</span>&nbsp;<span class="op" id="1988211">=</span>&nbsp;<span class="op" id="1988213">(</span><span class="op" id="1988214">*</span><span class="ident" id="1988215">_defer</span><span class="op" id="1988221">)</span><span class="op" id="1988222">(</span><span class="ident" id="1988223">nil</span><span class="op" id="1988226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1988229">deferType</span>&nbsp;<span class="op" id="1988239">=</span>&nbsp;<span class="op" id="1988241">(</span><span class="op" id="1988242">*</span><span class="op" id="1988243">(</span><span class="op" id="1988244">*</span><span class="op" id="1988245">*</span><span class="ident" id="1988246">ptrtype</span><span class="op" id="1988253">)</span><span class="op" id="1988254">(</span><span class="ident" id="1988255">unsafe</span><span class="op" id="1988261">.</span><span class="ident" id="1988262">Pointer</span><span class="op" id="1988269">(</span><span class="op" id="1988270">&amp;</span><span class="ident" id="1988271">x</span><span class="op" id="1988272">)</span><span class="op" id="1988273">)</span><span class="op" id="1988274">)</span><span class="op" id="1988275">.</span><span class="ident" id="1988276">elem</span><br>
<span class="lineno"></span><span class="op" id="1988281">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="comment" id="1988284">//&nbsp;Allocate&nbsp;a&nbsp;Defer,&nbsp;usually&nbsp;using&nbsp;per-P&nbsp;pool.</span><br>
<span class="lineno"></span><span class="comment" id="1988331">//&nbsp;Each&nbsp;defer&nbsp;must&nbsp;be&nbsp;released&nbsp;with&nbsp;freedefer.</span><br>
<span class="lineno"></span><span class="comment" id="1988378">//&nbsp;Note:&nbsp;runs&nbsp;on&nbsp;M&nbsp;stack</span><br>
<span class="lineno"></span><span class="keyword" id="1988403">func</span>&nbsp;<span class="ident" id="1988408">newdefer</span><span class="op" id="1988416">(</span><span class="ident" id="1988417">siz</span>&nbsp;<span class="builtintype" id="1988421">int32</span><span class="op" id="1988426">)</span>&nbsp;<span class="op" id="1988428">*</span><span class="ident" id="1988429">_defer</span>&nbsp;<span class="op" id="1988436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1988439">var</span>&nbsp;<span class="ident" id="1988443">d</span>&nbsp;<span class="op" id="1988445">*</span><span class="ident" id="1988446">_defer</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1988454">sc</span>&nbsp;<span class="op" id="1988457">:=</span>&nbsp;<span class="ident" id="1988460">deferclass</span><span class="op" id="1988470">(</span><span class="builtintype" id="1988471">uintptr</span><span class="op" id="1988478">(</span><span class="ident" id="1988479">siz</span><span class="op" id="1988482">)</span><span class="op" id="1988483">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1988486">mp</span>&nbsp;<span class="op" id="1988489">:=</span>&nbsp;<span class="ident" id="1988492">acquirem</span><span class="op" id="1988500">(</span><span class="op" id="1988501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1988504">if</span>&nbsp;<span class="ident" id="1988507">sc</span>&nbsp;<span class="op" id="1988510">&lt;</span>&nbsp;<span class="builtintype" id="1988512">uintptr</span><span class="op" id="1988519">(</span><span class="builtinfunc" id="1988520">len</span><span class="op" id="1988523">(</span><span class="ident" id="1988524">p</span><span class="op" id="1988525">{</span><span class="op" id="1988526">}</span><span class="op" id="1988527">.</span><span class="ident" id="1988528">deferpool</span><span class="op" id="1988537">)</span><span class="op" id="1988538">)</span>&nbsp;<span class="op" id="1988540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1988544">pp</span>&nbsp;<span class="op" id="1988547">:=</span>&nbsp;<span class="ident" id="1988550">mp</span><span class="op" id="1988552">.</span><span class="ident" id="1988553">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1988557">d</span>&nbsp;<span class="op" id="1988559">=</span>&nbsp;<span class="ident" id="1988561">pp</span><span class="op" id="1988563">.</span><span class="ident" id="1988564">deferpool</span><span class="op" id="1988573">[</span><span class="ident" id="1988574">sc</span><span class="op" id="1988576">]</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1988580">if</span>&nbsp;<span class="ident" id="1988583">d</span>&nbsp;<span class="op" id="1988585">!=</span>&nbsp;<span class="ident" id="1988588">nil</span>&nbsp;<span class="op" id="1988592">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1988597">pp</span><span class="op" id="1988599">.</span><span class="ident" id="1988600">deferpool</span><span class="op" id="1988609">[</span><span class="ident" id="1988610">sc</span><span class="op" id="1988612">]</span>&nbsp;<span class="op" id="1988614">=</span>&nbsp;<span class="ident" id="1988616">d</span><span class="op" id="1988617">.</span><span class="ident" id="1988618">link</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1988625">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1988628">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1988631">if</span>&nbsp;<span class="ident" id="1988634">d</span>&nbsp;<span class="op" id="1988636">==</span>&nbsp;<span class="ident" id="1988639">nil</span>&nbsp;<span class="op" id="1988643">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1988647">//&nbsp;Allocate&nbsp;new&nbsp;defer+args.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1988677">total</span>&nbsp;<span class="op" id="1988683">:=</span>&nbsp;<span class="ident" id="1988686">goroundupsize</span><span class="op" id="1988699">(</span><span class="ident" id="1988700">totaldefersize</span><span class="op" id="1988714">(</span><span class="builtintype" id="1988715">uintptr</span><span class="op" id="1988722">(</span><span class="ident" id="1988723">siz</span><span class="op" id="1988726">)</span><span class="op" id="1988727">)</span><span class="op" id="1988728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1988732">d</span>&nbsp;<span class="op" id="1988734">=</span>&nbsp;<span class="op" id="1988736">(</span><span class="op" id="1988737">*</span><span class="ident" id="1988738">_defer</span><span class="op" id="1988744">)</span><span class="op" id="1988745">(</span><span class="ident" id="1988746">mallocgc</span><span class="op" id="1988754">(</span><span class="ident" id="1988755">total</span><span class="op" id="1988760">,</span>&nbsp;<span class="ident" id="1988762">deferType</span><span class="op" id="1988771">,</span>&nbsp;<span class="num" id="1988773">0</span><span class="op" id="1988774">)</span><span class="op" id="1988775">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1988778">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1988781">d</span><span class="op" id="1988782">.</span><span class="ident" id="1988783">siz</span>&nbsp;<span class="op" id="1988787">=</span>&nbsp;<span class="ident" id="1988789">siz</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1988794">gp</span>&nbsp;<span class="op" id="1988797">:=</span>&nbsp;<span class="ident" id="1988800">mp</span><span class="op" id="1988802">.</span><span class="ident" id="1988803">curg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1988809">d</span><span class="op" id="1988810">.</span><span class="ident" id="1988811">link</span>&nbsp;<span class="op" id="1988816">=</span>&nbsp;<span class="ident" id="1988818">gp</span><span class="op" id="1988820">.</span><span class="ident" id="1988821">_defer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1988829">gp</span><span class="op" id="1988831">.</span><span class="ident" id="1988832">_defer</span>&nbsp;<span class="op" id="1988839">=</span>&nbsp;<span class="ident" id="1988841">d</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1988844">releasem</span><span class="op" id="1988852">(</span><span class="ident" id="1988853">mp</span><span class="op" id="1988855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1988858">return</span>&nbsp;<span class="ident" id="1988865">d</span><br>
<span class="lineno">185</span><span class="op" id="1988867">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1988870">//&nbsp;Free&nbsp;the&nbsp;given&nbsp;defer.</span><br>
<span class="lineno"></span><span class="comment" id="1988895">//&nbsp;The&nbsp;defer&nbsp;cannot&nbsp;be&nbsp;used&nbsp;after&nbsp;this&nbsp;call.</span><br>
<span class="lineno"></span><span class="comment" id="1988940">//go:nosplit</span><br>
<span class="lineno">190</span><span class="keyword" id="1988953">func</span>&nbsp;<span class="ident" id="1988958">freedefer</span><span class="op" id="1988967">(</span><span class="ident" id="1988968">d</span>&nbsp;<span class="op" id="1988970">*</span><span class="ident" id="1988971">_defer</span><span class="op" id="1988977">)</span>&nbsp;<span class="op" id="1988979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1988982">if</span>&nbsp;<span class="ident" id="1988985">d</span><span class="op" id="1988986">.</span><span class="ident" id="1988987">_panic</span>&nbsp;<span class="op" id="1988994">!=</span>&nbsp;<span class="ident" id="1988997">nil</span>&nbsp;<span class="op" id="1989001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1989005">freedeferpanic</span><span class="op" id="1989019">(</span><span class="op" id="1989020">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1989023">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1989026">if</span>&nbsp;<span class="ident" id="1989029">d</span><span class="op" id="1989030">.</span><span class="ident" id="1989031">fn</span>&nbsp;<span class="op" id="1989034">!=</span>&nbsp;<span class="ident" id="1989037">nil</span>&nbsp;<span class="op" id="1989041">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1989045">freedeferfn</span><span class="op" id="1989056">(</span><span class="op" id="1989057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1989060">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1989063">sc</span>&nbsp;<span class="op" id="1989066">:=</span>&nbsp;<span class="ident" id="1989069">deferclass</span><span class="op" id="1989079">(</span><span class="builtintype" id="1989080">uintptr</span><span class="op" id="1989087">(</span><span class="ident" id="1989088">d</span><span class="op" id="1989089">.</span><span class="ident" id="1989090">siz</span><span class="op" id="1989093">)</span><span class="op" id="1989094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1989097">if</span>&nbsp;<span class="ident" id="1989100">sc</span>&nbsp;<span class="op" id="1989103">&lt;</span>&nbsp;<span class="builtintype" id="1989105">uintptr</span><span class="op" id="1989112">(</span><span class="builtinfunc" id="1989113">len</span><span class="op" id="1989116">(</span><span class="ident" id="1989117">p</span><span class="op" id="1989118">{</span><span class="op" id="1989119">}</span><span class="op" id="1989120">.</span><span class="ident" id="1989121">deferpool</span><span class="op" id="1989130">)</span><span class="op" id="1989131">)</span>&nbsp;<span class="op" id="1989133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1989137">mp</span>&nbsp;<span class="op" id="1989140">:=</span>&nbsp;<span class="ident" id="1989143">acquirem</span><span class="op" id="1989151">(</span><span class="op" id="1989152">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1989156">pp</span>&nbsp;<span class="op" id="1989159">:=</span>&nbsp;<span class="ident" id="1989162">mp</span><span class="op" id="1989164">.</span><span class="ident" id="1989165">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1989169">*</span><span class="ident" id="1989170">d</span>&nbsp;<span class="op" id="1989172">=</span>&nbsp;<span class="ident" id="1989174">_defer</span><span class="op" id="1989180">{</span><span class="op" id="1989181">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1989185">d</span><span class="op" id="1989186">.</span><span class="ident" id="1989187">link</span>&nbsp;<span class="op" id="1989192">=</span>&nbsp;<span class="ident" id="1989194">pp</span><span class="op" id="1989196">.</span><span class="ident" id="1989197">deferpool</span><span class="op" id="1989206">[</span><span class="ident" id="1989207">sc</span><span class="op" id="1989209">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1989213">pp</span><span class="op" id="1989215">.</span><span class="ident" id="1989216">deferpool</span><span class="op" id="1989225">[</span><span class="ident" id="1989226">sc</span><span class="op" id="1989228">]</span>&nbsp;<span class="op" id="1989230">=</span>&nbsp;<span class="ident" id="1989232">d</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1989236">releasem</span><span class="op" id="1989244">(</span><span class="ident" id="1989245">mp</span><span class="op" id="1989247">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1989250">}</span><br>
<span class="lineno"></span><span class="op" id="1989252">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1989255">//&nbsp;Separate&nbsp;function&nbsp;so&nbsp;that&nbsp;it&nbsp;can&nbsp;split&nbsp;stack.</span><br>
<span class="lineno"></span><span class="comment" id="1989304">//&nbsp;Windows&nbsp;otherwise&nbsp;runs&nbsp;out&nbsp;of&nbsp;stack&nbsp;space.</span><br>
<span class="lineno">210</span><span class="keyword" id="1989350">func</span>&nbsp;<span class="ident" id="1989355">freedeferpanic</span><span class="op" id="1989369">(</span><span class="op" id="1989370">)</span>&nbsp;<span class="op" id="1989372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1989375">//&nbsp;_panic&nbsp;must&nbsp;be&nbsp;cleared&nbsp;before&nbsp;d&nbsp;is&nbsp;unlinked&nbsp;from&nbsp;gp.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1989432">gothrow</span><span class="op" id="1989439">(</span><span class="string" id="1989440">&#34;freedefer&nbsp;with&nbsp;d._panic&nbsp;!=&nbsp;nil&#34;</span><span class="op" id="1989472">)</span><br>
<span class="lineno"></span><span class="op" id="1989474">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span><span class="keyword" id="1989477">func</span>&nbsp;<span class="ident" id="1989482">freedeferfn</span><span class="op" id="1989493">(</span><span class="op" id="1989494">)</span>&nbsp;<span class="op" id="1989496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1989499">//&nbsp;fn&nbsp;must&nbsp;be&nbsp;cleared&nbsp;before&nbsp;d&nbsp;is&nbsp;unlinked&nbsp;from&nbsp;gp.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1989552">gothrow</span><span class="op" id="1989559">(</span><span class="string" id="1989560">&#34;freedefer&nbsp;with&nbsp;d.fn&nbsp;!=&nbsp;nil&#34;</span><span class="op" id="1989588">)</span><br>
<span class="lineno"></span><span class="op" id="1989590">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">220</span><span class="comment" id="1989593">//&nbsp;Run&nbsp;a&nbsp;deferred&nbsp;function&nbsp;if&nbsp;there&nbsp;is&nbsp;one.</span><br>
<span class="lineno"></span><span class="comment" id="1989637">//&nbsp;The&nbsp;compiler&nbsp;inserts&nbsp;a&nbsp;call&nbsp;to&nbsp;this&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;any</span><br>
<span class="lineno"></span><span class="comment" id="1989694">//&nbsp;function&nbsp;which&nbsp;calls&nbsp;defer.</span><br>
<span class="lineno"></span><span class="comment" id="1989725">//&nbsp;If&nbsp;there&nbsp;is&nbsp;a&nbsp;deferred&nbsp;function,&nbsp;this&nbsp;will&nbsp;call&nbsp;runtimejmpdefer,</span><br>
<span class="lineno"></span><span class="comment" id="1989795">//&nbsp;which&nbsp;will&nbsp;jump&nbsp;to&nbsp;the&nbsp;deferred&nbsp;function&nbsp;such&nbsp;that&nbsp;it&nbsp;appears</span><br>
<span class="lineno">225</span><span class="comment" id="1989860">//&nbsp;to&nbsp;have&nbsp;been&nbsp;called&nbsp;by&nbsp;the&nbsp;caller&nbsp;of&nbsp;deferreturn&nbsp;at&nbsp;the&nbsp;point</span><br>
<span class="lineno"></span><span class="comment" id="1989925">//&nbsp;just&nbsp;before&nbsp;deferreturn&nbsp;was&nbsp;called.&nbsp;&nbsp;The&nbsp;effect&nbsp;is&nbsp;that&nbsp;deferreturn</span><br>
<span class="lineno"></span><span class="comment" id="1989996">//&nbsp;is&nbsp;called&nbsp;again&nbsp;and&nbsp;again&nbsp;until&nbsp;there&nbsp;are&nbsp;no&nbsp;more&nbsp;deferred&nbsp;functions.</span><br>
<span class="lineno"></span><span class="comment" id="1990069">//&nbsp;Cannot&nbsp;split&nbsp;the&nbsp;stack&nbsp;because&nbsp;we&nbsp;reuse&nbsp;the&nbsp;caller&#39;s&nbsp;frame&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1990134">//&nbsp;call&nbsp;the&nbsp;deferred&nbsp;function.</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span><span class="comment" id="1990166">//&nbsp;The&nbsp;single&nbsp;argument&nbsp;isn&#39;t&nbsp;actually&nbsp;used&nbsp;-&nbsp;it&nbsp;just&nbsp;has&nbsp;its&nbsp;address</span><br>
<span class="lineno"></span><span class="comment" id="1990235">//&nbsp;taken&nbsp;so&nbsp;it&nbsp;can&nbsp;be&nbsp;matched&nbsp;against&nbsp;pending&nbsp;defers.</span><br>
<span class="lineno"></span><span class="comment" id="1990289">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1990302">func</span>&nbsp;<span class="ident" id="1990307">deferreturn</span><span class="op" id="1990318">(</span><span class="ident" id="1990319">arg0</span>&nbsp;<span class="builtintype" id="1990324">uintptr</span><span class="op" id="1990331">)</span>&nbsp;<span class="op" id="1990333">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1990336">gp</span>&nbsp;<span class="op" id="1990339">:=</span>&nbsp;<span class="ident" id="1990342">getg</span><span class="op" id="1990346">(</span><span class="op" id="1990347">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1990350">d</span>&nbsp;<span class="op" id="1990352">:=</span>&nbsp;<span class="ident" id="1990355">gp</span><span class="op" id="1990357">.</span><span class="ident" id="1990358">_defer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1990366">if</span>&nbsp;<span class="ident" id="1990369">d</span>&nbsp;<span class="op" id="1990371">==</span>&nbsp;<span class="ident" id="1990374">nil</span>&nbsp;<span class="op" id="1990378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1990382">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1990390">}</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1990393">argp</span>&nbsp;<span class="op" id="1990398">:=</span>&nbsp;<span class="builtintype" id="1990401">uintptr</span><span class="op" id="1990408">(</span><span class="ident" id="1990409">unsafe</span><span class="op" id="1990415">.</span><span class="ident" id="1990416">Pointer</span><span class="op" id="1990423">(</span><span class="op" id="1990424">&amp;</span><span class="ident" id="1990425">arg0</span><span class="op" id="1990429">)</span><span class="op" id="1990430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1990433">if</span>&nbsp;<span class="ident" id="1990436">d</span><span class="op" id="1990437">.</span><span class="ident" id="1990438">argp</span>&nbsp;<span class="op" id="1990443">!=</span>&nbsp;<span class="ident" id="1990446">argp</span>&nbsp;<span class="op" id="1990451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1990455">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1990463">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1990467">//&nbsp;Moving&nbsp;arguments&nbsp;around.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1990496">//&nbsp;Do&nbsp;not&nbsp;allow&nbsp;preemption&nbsp;here,&nbsp;because&nbsp;the&nbsp;garbage&nbsp;collector</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1990560">//&nbsp;won&#39;t&nbsp;know&nbsp;the&nbsp;form&nbsp;of&nbsp;the&nbsp;arguments&nbsp;until&nbsp;the&nbsp;jmpdefer&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1990624">//&nbsp;flip&nbsp;the&nbsp;PC&nbsp;over&nbsp;to&nbsp;fn.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1990652">mp</span>&nbsp;<span class="op" id="1990655">:=</span>&nbsp;<span class="ident" id="1990658">acquirem</span><span class="op" id="1990666">(</span><span class="op" id="1990667">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1990670">memmove</span><span class="op" id="1990677">(</span><span class="ident" id="1990678">unsafe</span><span class="op" id="1990684">.</span><span class="ident" id="1990685">Pointer</span><span class="op" id="1990692">(</span><span class="ident" id="1990693">argp</span><span class="op" id="1990697">)</span><span class="op" id="1990698">,</span>&nbsp;<span class="ident" id="1990700">deferArgs</span><span class="op" id="1990709">(</span><span class="ident" id="1990710">d</span><span class="op" id="1990711">)</span><span class="op" id="1990712">,</span>&nbsp;<span class="builtintype" id="1990714">uintptr</span><span class="op" id="1990721">(</span><span class="ident" id="1990722">d</span><span class="op" id="1990723">.</span><span class="ident" id="1990724">siz</span><span class="op" id="1990727">)</span><span class="op" id="1990728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1990731">fn</span>&nbsp;<span class="op" id="1990734">:=</span>&nbsp;<span class="ident" id="1990737">d</span><span class="op" id="1990738">.</span><span class="ident" id="1990739">fn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1990743">d</span><span class="op" id="1990744">.</span><span class="ident" id="1990745">fn</span>&nbsp;<span class="op" id="1990748">=</span>&nbsp;<span class="ident" id="1990750">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1990755">gp</span><span class="op" id="1990757">.</span><span class="ident" id="1990758">_defer</span>&nbsp;<span class="op" id="1990765">=</span>&nbsp;<span class="ident" id="1990767">d</span><span class="op" id="1990768">.</span><span class="ident" id="1990769">link</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1990775">freedefer</span><span class="op" id="1990784">(</span><span class="ident" id="1990785">d</span><span class="op" id="1990786">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1990789">releasem</span><span class="op" id="1990797">(</span><span class="ident" id="1990798">mp</span><span class="op" id="1990800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1990803">jmpdefer</span><span class="op" id="1990811">(</span><span class="ident" id="1990812">fn</span><span class="op" id="1990814">,</span>&nbsp;<span class="ident" id="1990816">argp</span><span class="op" id="1990820">)</span><br>
<span class="lineno"></span><span class="op" id="1990822">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1990825">//&nbsp;Goexit&nbsp;terminates&nbsp;the&nbsp;goroutine&nbsp;that&nbsp;calls&nbsp;it.&nbsp;&nbsp;No&nbsp;other&nbsp;goroutine&nbsp;is&nbsp;affected.</span><br>
<span class="lineno">260</span><span class="comment" id="1990908">//&nbsp;Goexit&nbsp;runs&nbsp;all&nbsp;deferred&nbsp;calls&nbsp;before&nbsp;terminating&nbsp;the&nbsp;goroutine.&nbsp;&nbsp;Because&nbsp;Goexit</span><br>
<span class="lineno"></span><span class="comment" id="1990992">//&nbsp;is&nbsp;not&nbsp;panic,&nbsp;however,&nbsp;any&nbsp;recover&nbsp;calls&nbsp;in&nbsp;those&nbsp;deferred&nbsp;functions&nbsp;will&nbsp;return&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="1991081">//</span><br>
<span class="lineno"></span><span class="comment" id="1991084">//&nbsp;Calling&nbsp;Goexit&nbsp;from&nbsp;the&nbsp;main&nbsp;goroutine&nbsp;terminates&nbsp;that&nbsp;goroutine</span><br>
<span class="lineno"></span><span class="comment" id="1991152">//&nbsp;without&nbsp;func&nbsp;main&nbsp;returning.&nbsp;Since&nbsp;func&nbsp;main&nbsp;has&nbsp;not&nbsp;returned,</span><br>
<span class="lineno">265</span><span class="comment" id="1991218">//&nbsp;the&nbsp;program&nbsp;continues&nbsp;execution&nbsp;of&nbsp;other&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="comment" id="1991274">//&nbsp;If&nbsp;all&nbsp;other&nbsp;goroutines&nbsp;exit,&nbsp;the&nbsp;program&nbsp;crashes.</span><br>
<span class="lineno"></span><span class="keyword" id="1991328">func</span>&nbsp;<span class="ident" id="1991333">Goexit</span><span class="op" id="1991339">(</span><span class="op" id="1991340">)</span>&nbsp;<span class="op" id="1991342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1991345">//&nbsp;Run&nbsp;all&nbsp;deferred&nbsp;functions&nbsp;for&nbsp;the&nbsp;current&nbsp;goroutine.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1991403">//&nbsp;This&nbsp;code&nbsp;is&nbsp;similar&nbsp;to&nbsp;gopanic,&nbsp;see&nbsp;that&nbsp;implementation</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1991464">//&nbsp;for&nbsp;detailed&nbsp;comments.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1991491">gp</span>&nbsp;<span class="op" id="1991494">:=</span>&nbsp;<span class="ident" id="1991497">getg</span><span class="op" id="1991501">(</span><span class="op" id="1991502">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1991505">for</span>&nbsp;<span class="op" id="1991509">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1991513">d</span>&nbsp;<span class="op" id="1991515">:=</span>&nbsp;<span class="ident" id="1991518">gp</span><span class="op" id="1991520">.</span><span class="ident" id="1991521">_defer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1991530">if</span>&nbsp;<span class="ident" id="1991533">d</span>&nbsp;<span class="op" id="1991535">==</span>&nbsp;<span class="ident" id="1991538">nil</span>&nbsp;<span class="op" id="1991542">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1991547">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1991555">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1991559">if</span>&nbsp;<span class="ident" id="1991562">d</span><span class="op" id="1991563">.</span><span class="ident" id="1991564">started</span>&nbsp;<span class="op" id="1991572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1991577">if</span>&nbsp;<span class="ident" id="1991580">d</span><span class="op" id="1991581">.</span><span class="ident" id="1991582">_panic</span>&nbsp;<span class="op" id="1991589">!=</span>&nbsp;<span class="ident" id="1991592">nil</span>&nbsp;<span class="op" id="1991596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1991602">d</span><span class="op" id="1991603">.</span><span class="ident" id="1991604">_panic</span><span class="op" id="1991610">.</span><span class="ident" id="1991611">aborted</span>&nbsp;<span class="op" id="1991619">=</span>&nbsp;<span class="builtintype" id="1991621">true</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1991630">d</span><span class="op" id="1991631">.</span><span class="ident" id="1991632">_panic</span>&nbsp;<span class="op" id="1991639">=</span>&nbsp;<span class="ident" id="1991641">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1991648">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1991653">d</span><span class="op" id="1991654">.</span><span class="ident" id="1991655">fn</span>&nbsp;<span class="op" id="1991658">=</span>&nbsp;<span class="ident" id="1991660">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1991667">gp</span><span class="op" id="1991669">.</span><span class="ident" id="1991670">_defer</span>&nbsp;<span class="op" id="1991677">=</span>&nbsp;<span class="ident" id="1991679">d</span><span class="op" id="1991680">.</span><span class="ident" id="1991681">link</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1991689">freedefer</span><span class="op" id="1991698">(</span><span class="ident" id="1991699">d</span><span class="op" id="1991700">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1991705">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1991716">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1991720">d</span><span class="op" id="1991721">.</span><span class="ident" id="1991722">started</span>&nbsp;<span class="op" id="1991730">=</span>&nbsp;<span class="builtintype" id="1991732">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1991739">reflectcall</span><span class="op" id="1991750">(</span><span class="ident" id="1991751">unsafe</span><span class="op" id="1991757">.</span><span class="ident" id="1991758">Pointer</span><span class="op" id="1991765">(</span><span class="ident" id="1991766">d</span><span class="op" id="1991767">.</span><span class="ident" id="1991768">fn</span><span class="op" id="1991770">)</span><span class="op" id="1991771">,</span>&nbsp;<span class="ident" id="1991773">deferArgs</span><span class="op" id="1991782">(</span><span class="ident" id="1991783">d</span><span class="op" id="1991784">)</span><span class="op" id="1991785">,</span>&nbsp;<span class="builtintype" id="1991787">uint32</span><span class="op" id="1991793">(</span><span class="ident" id="1991794">d</span><span class="op" id="1991795">.</span><span class="ident" id="1991796">siz</span><span class="op" id="1991799">)</span><span class="op" id="1991800">,</span>&nbsp;<span class="builtintype" id="1991802">uint32</span><span class="op" id="1991808">(</span><span class="ident" id="1991809">d</span><span class="op" id="1991810">.</span><span class="ident" id="1991811">siz</span><span class="op" id="1991814">)</span><span class="op" id="1991815">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1991819">if</span>&nbsp;<span class="ident" id="1991822">gp</span><span class="op" id="1991824">.</span><span class="ident" id="1991825">_defer</span>&nbsp;<span class="op" id="1991832">!=</span>&nbsp;<span class="ident" id="1991835">d</span>&nbsp;<span class="op" id="1991837">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1991842">gothrow</span><span class="op" id="1991849">(</span><span class="string" id="1991850">&#34;bad&nbsp;defer&nbsp;entry&nbsp;in&nbsp;Goexit&#34;</span><span class="op" id="1991877">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1991881">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1991885">d</span><span class="op" id="1991886">.</span><span class="ident" id="1991887">_panic</span>&nbsp;<span class="op" id="1991894">=</span>&nbsp;<span class="ident" id="1991896">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1991902">d</span><span class="op" id="1991903">.</span><span class="ident" id="1991904">fn</span>&nbsp;<span class="op" id="1991907">=</span>&nbsp;<span class="ident" id="1991909">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1991915">gp</span><span class="op" id="1991917">.</span><span class="ident" id="1991918">_defer</span>&nbsp;<span class="op" id="1991925">=</span>&nbsp;<span class="ident" id="1991927">d</span><span class="op" id="1991928">.</span><span class="ident" id="1991929">link</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1991936">freedefer</span><span class="op" id="1991945">(</span><span class="ident" id="1991946">d</span><span class="op" id="1991947">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1991951">//&nbsp;Note:&nbsp;we&nbsp;ignore&nbsp;recovers&nbsp;here&nbsp;because&nbsp;Goexit&nbsp;isn&#39;t&nbsp;a&nbsp;panic</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1992014">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1992017">goexit</span><span class="op" id="1992023">(</span><span class="op" id="1992024">)</span><br>
<span class="lineno"></span><span class="op" id="1992026">}</span><br>
<span class="lineno">300</span><br>
<span class="lineno"></span><span class="keyword" id="1992029">func</span>&nbsp;<span class="ident" id="1992034">canpanic</span><span class="op" id="1992042">(</span><span class="op" id="1992043">*</span><span class="ident" id="1992044">g</span><span class="op" id="1992045">)</span>&nbsp;<span class="builtintype" id="1992047">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1992053">//&nbsp;Print&nbsp;all&nbsp;currently&nbsp;active&nbsp;panics.&nbsp;&nbsp;Used&nbsp;when&nbsp;crashing.</span><br>
<span class="lineno"></span><span class="keyword" id="1992112">func</span>&nbsp;<span class="ident" id="1992117">printpanics</span><span class="op" id="1992128">(</span><span class="ident" id="1992129">p</span>&nbsp;<span class="op" id="1992131">*</span><span class="ident" id="1992132">_panic</span><span class="op" id="1992138">)</span>&nbsp;<span class="op" id="1992140">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1992143">if</span>&nbsp;<span class="ident" id="1992146">p</span><span class="op" id="1992147">.</span><span class="ident" id="1992148">link</span>&nbsp;<span class="op" id="1992153">!=</span>&nbsp;<span class="ident" id="1992156">nil</span>&nbsp;<span class="op" id="1992160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1992164">printpanics</span><span class="op" id="1992175">(</span><span class="ident" id="1992176">p</span><span class="op" id="1992177">.</span><span class="ident" id="1992178">link</span><span class="op" id="1992182">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1992186">print</span><span class="op" id="1992191">(</span><span class="string" id="1992192">&#34;\t&#34;</span><span class="op" id="1992196">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1992199">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1992202">print</span><span class="op" id="1992207">(</span><span class="string" id="1992208">&#34;panic:&nbsp;&#34;</span><span class="op" id="1992217">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1992220">printany</span><span class="op" id="1992228">(</span><span class="ident" id="1992229">p</span><span class="op" id="1992230">.</span><span class="ident" id="1992231">arg</span><span class="op" id="1992234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1992237">if</span>&nbsp;<span class="ident" id="1992240">p</span><span class="op" id="1992241">.</span><span class="ident" id="1992242">recovered</span>&nbsp;<span class="op" id="1992252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1992256">print</span><span class="op" id="1992261">(</span><span class="string" id="1992262">&#34;&nbsp;[recovered]&#34;</span><span class="op" id="1992276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1992279">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1992282">print</span><span class="op" id="1992287">(</span><span class="string" id="1992288">&#34;\n&#34;</span><span class="op" id="1992292">)</span><br>
<span class="lineno">315</span><span class="op" id="1992294">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1992297">//&nbsp;The&nbsp;implementation&nbsp;of&nbsp;the&nbsp;predeclared&nbsp;function&nbsp;panic.</span><br>
<span class="lineno"></span><span class="keyword" id="1992354">func</span>&nbsp;<span class="ident" id="1992359">gopanic</span><span class="op" id="1992366">(</span><span class="ident" id="1992367">e</span>&nbsp;<span class="keyword" id="1992369">interface</span><span class="op" id="1992378">{</span><span class="op" id="1992379">}</span><span class="op" id="1992380">)</span>&nbsp;<span class="op" id="1992382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1992385">gp</span>&nbsp;<span class="op" id="1992388">:=</span>&nbsp;<span class="ident" id="1992391">getg</span><span class="op" id="1992395">(</span><span class="op" id="1992396">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1992399">if</span>&nbsp;<span class="ident" id="1992402">gp</span><span class="op" id="1992404">.</span><span class="ident" id="1992405">m</span><span class="op" id="1992406">.</span><span class="ident" id="1992407">curg</span>&nbsp;<span class="op" id="1992412">!=</span>&nbsp;<span class="ident" id="1992415">gp</span>&nbsp;<span class="op" id="1992418">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1992422">gothrow</span><span class="op" id="1992429">(</span><span class="string" id="1992430">&#34;panic&nbsp;on&nbsp;m&nbsp;stack&#34;</span><span class="op" id="1992448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1992451">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1992455">//&nbsp;m.softfloat&nbsp;is&nbsp;set&nbsp;during&nbsp;software&nbsp;floating&nbsp;point.</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1992510">//&nbsp;It&nbsp;increments&nbsp;m.locks&nbsp;to&nbsp;avoid&nbsp;preemption.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1992557">//&nbsp;We&nbsp;moved&nbsp;the&nbsp;memory&nbsp;loads&nbsp;out,&nbsp;so&nbsp;there&nbsp;shouldn&#39;t&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1992614">//&nbsp;any&nbsp;reason&nbsp;for&nbsp;it&nbsp;to&nbsp;panic&nbsp;anymore.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1992654">if</span>&nbsp;<span class="ident" id="1992657">gp</span><span class="op" id="1992659">.</span><span class="ident" id="1992660">m</span><span class="op" id="1992661">.</span><span class="ident" id="1992662">softfloat</span>&nbsp;<span class="op" id="1992672">!=</span>&nbsp;<span class="num" id="1992675">0</span>&nbsp;<span class="op" id="1992677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1992681">gp</span><span class="op" id="1992683">.</span><span class="ident" id="1992684">m</span><span class="op" id="1992685">.</span><span class="ident" id="1992686">locks</span><span class="op" id="1992691">--</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1992696">gp</span><span class="op" id="1992698">.</span><span class="ident" id="1992699">m</span><span class="op" id="1992700">.</span><span class="ident" id="1992701">softfloat</span>&nbsp;<span class="op" id="1992711">=</span>&nbsp;<span class="num" id="1992713">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1992717">gothrow</span><span class="op" id="1992724">(</span><span class="string" id="1992725">&#34;panic&nbsp;during&nbsp;softfloat&#34;</span><span class="op" id="1992749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1992752">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1992755">if</span>&nbsp;<span class="ident" id="1992758">gp</span><span class="op" id="1992760">.</span><span class="ident" id="1992761">m</span><span class="op" id="1992762">.</span><span class="ident" id="1992763">mallocing</span>&nbsp;<span class="op" id="1992773">!=</span>&nbsp;<span class="num" id="1992776">0</span>&nbsp;<span class="op" id="1992778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1992782">print</span><span class="op" id="1992787">(</span><span class="string" id="1992788">&#34;panic:&nbsp;&#34;</span><span class="op" id="1992797">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1992801">printany</span><span class="op" id="1992809">(</span><span class="ident" id="1992810">e</span><span class="op" id="1992811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1992815">print</span><span class="op" id="1992820">(</span><span class="string" id="1992821">&#34;\n&#34;</span><span class="op" id="1992825">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1992829">gothrow</span><span class="op" id="1992836">(</span><span class="string" id="1992837">&#34;panic&nbsp;during&nbsp;malloc&#34;</span><span class="op" id="1992858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1992861">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1992864">if</span>&nbsp;<span class="ident" id="1992867">gp</span><span class="op" id="1992869">.</span><span class="ident" id="1992870">m</span><span class="op" id="1992871">.</span><span class="ident" id="1992872">gcing</span>&nbsp;<span class="op" id="1992878">!=</span>&nbsp;<span class="num" id="1992881">0</span>&nbsp;<span class="op" id="1992883">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1992887">print</span><span class="op" id="1992892">(</span><span class="string" id="1992893">&#34;panic:&nbsp;&#34;</span><span class="op" id="1992902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1992906">printany</span><span class="op" id="1992914">(</span><span class="ident" id="1992915">e</span><span class="op" id="1992916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1992920">print</span><span class="op" id="1992925">(</span><span class="string" id="1992926">&#34;\n&#34;</span><span class="op" id="1992930">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1992934">gothrow</span><span class="op" id="1992941">(</span><span class="string" id="1992942">&#34;panic&nbsp;during&nbsp;gc&#34;</span><span class="op" id="1992959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1992962">}</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1992965">if</span>&nbsp;<span class="ident" id="1992968">gp</span><span class="op" id="1992970">.</span><span class="ident" id="1992971">m</span><span class="op" id="1992972">.</span><span class="ident" id="1992973">locks</span>&nbsp;<span class="op" id="1992979">!=</span>&nbsp;<span class="num" id="1992982">0</span>&nbsp;<span class="op" id="1992984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1992988">print</span><span class="op" id="1992993">(</span><span class="string" id="1992994">&#34;panic:&nbsp;&#34;</span><span class="op" id="1993003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1993007">printany</span><span class="op" id="1993015">(</span><span class="ident" id="1993016">e</span><span class="op" id="1993017">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1993021">print</span><span class="op" id="1993026">(</span><span class="string" id="1993027">&#34;\n&#34;</span><span class="op" id="1993031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1993035">gothrow</span><span class="op" id="1993042">(</span><span class="string" id="1993043">&#34;panic&nbsp;holding&nbsp;locks&#34;</span><span class="op" id="1993064">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1993067">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1993071">var</span>&nbsp;<span class="ident" id="1993075">p</span>&nbsp;<span class="ident" id="1993077">_panic</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1993085">p</span><span class="op" id="1993086">.</span><span class="ident" id="1993087">arg</span>&nbsp;<span class="op" id="1993091">=</span>&nbsp;<span class="ident" id="1993093">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1993096">p</span><span class="op" id="1993097">.</span><span class="ident" id="1993098">link</span>&nbsp;<span class="op" id="1993103">=</span>&nbsp;<span class="ident" id="1993105">gp</span><span class="op" id="1993107">.</span><span class="ident" id="1993108">_panic</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1993116">gp</span><span class="op" id="1993118">.</span><span class="ident" id="1993119">_panic</span>&nbsp;<span class="op" id="1993126">=</span>&nbsp;<span class="op" id="1993128">(</span><span class="op" id="1993129">*</span><span class="ident" id="1993130">_panic</span><span class="op" id="1993136">)</span><span class="op" id="1993137">(</span><span class="ident" id="1993138">noescape</span><span class="op" id="1993146">(</span><span class="ident" id="1993147">unsafe</span><span class="op" id="1993153">.</span><span class="ident" id="1993154">Pointer</span><span class="op" id="1993161">(</span><span class="op" id="1993162">&amp;</span><span class="ident" id="1993163">p</span><span class="op" id="1993164">)</span><span class="op" id="1993165">)</span><span class="op" id="1993166">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1993170">for</span>&nbsp;<span class="op" id="1993174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1993178">d</span>&nbsp;<span class="op" id="1993180">:=</span>&nbsp;<span class="ident" id="1993183">gp</span><span class="op" id="1993185">.</span><span class="ident" id="1993186">_defer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1993195">if</span>&nbsp;<span class="ident" id="1993198">d</span>&nbsp;<span class="op" id="1993200">==</span>&nbsp;<span class="ident" id="1993203">nil</span>&nbsp;<span class="op" id="1993207">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1993212">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1993220">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1993225">//&nbsp;If&nbsp;defer&nbsp;was&nbsp;started&nbsp;by&nbsp;earlier&nbsp;panic&nbsp;or&nbsp;Goexit&nbsp;(and,&nbsp;since&nbsp;we&#39;re&nbsp;back&nbsp;here,&nbsp;that&nbsp;triggered&nbsp;a&nbsp;new&nbsp;panic),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1993336">//&nbsp;take&nbsp;defer&nbsp;off&nbsp;list.&nbsp;The&nbsp;earlier&nbsp;panic&nbsp;or&nbsp;Goexit&nbsp;will&nbsp;not&nbsp;continue&nbsp;running.</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1993417">if</span>&nbsp;<span class="ident" id="1993420">d</span><span class="op" id="1993421">.</span><span class="ident" id="1993422">started</span>&nbsp;<span class="op" id="1993430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1993435">if</span>&nbsp;<span class="ident" id="1993438">d</span><span class="op" id="1993439">.</span><span class="ident" id="1993440">_panic</span>&nbsp;<span class="op" id="1993447">!=</span>&nbsp;<span class="ident" id="1993450">nil</span>&nbsp;<span class="op" id="1993454">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1993460">d</span><span class="op" id="1993461">.</span><span class="ident" id="1993462">_panic</span><span class="op" id="1993468">.</span><span class="ident" id="1993469">aborted</span>&nbsp;<span class="op" id="1993477">=</span>&nbsp;<span class="builtintype" id="1993479">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1993487">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1993492">d</span><span class="op" id="1993493">.</span><span class="ident" id="1993494">_panic</span>&nbsp;<span class="op" id="1993501">=</span>&nbsp;<span class="ident" id="1993503">nil</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1993510">d</span><span class="op" id="1993511">.</span><span class="ident" id="1993512">fn</span>&nbsp;<span class="op" id="1993515">=</span>&nbsp;<span class="ident" id="1993517">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1993524">gp</span><span class="op" id="1993526">.</span><span class="ident" id="1993527">_defer</span>&nbsp;<span class="op" id="1993534">=</span>&nbsp;<span class="ident" id="1993536">d</span><span class="op" id="1993537">.</span><span class="ident" id="1993538">link</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1993546">freedefer</span><span class="op" id="1993555">(</span><span class="ident" id="1993556">d</span><span class="op" id="1993557">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1993562">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1993573">}</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1993578">//&nbsp;Mark&nbsp;defer&nbsp;as&nbsp;started,&nbsp;but&nbsp;keep&nbsp;on&nbsp;list,&nbsp;so&nbsp;that&nbsp;traceback</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1993642">//&nbsp;can&nbsp;find&nbsp;and&nbsp;update&nbsp;the&nbsp;defer&#39;s&nbsp;argument&nbsp;frame&nbsp;if&nbsp;stack&nbsp;growth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1993710">//&nbsp;or&nbsp;a&nbsp;garbage&nbsp;collection&nbsp;hapens&nbsp;before&nbsp;reflectcall&nbsp;starts&nbsp;executing&nbsp;d.fn.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1993788">d</span><span class="op" id="1993789">.</span><span class="ident" id="1993790">started</span>&nbsp;<span class="op" id="1993798">=</span>&nbsp;<span class="builtintype" id="1993800">true</span><br>
<span class="lineno">380</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1993808">//&nbsp;Record&nbsp;the&nbsp;panic&nbsp;that&nbsp;is&nbsp;running&nbsp;the&nbsp;defer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1993857">//&nbsp;If&nbsp;there&nbsp;is&nbsp;a&nbsp;new&nbsp;panic&nbsp;during&nbsp;the&nbsp;deferred&nbsp;call,&nbsp;that&nbsp;panic</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1993923">//&nbsp;will&nbsp;find&nbsp;d&nbsp;in&nbsp;the&nbsp;list&nbsp;and&nbsp;will&nbsp;mark&nbsp;d._panic&nbsp;(this&nbsp;panic)&nbsp;aborted.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1993997">d</span><span class="op" id="1993998">.</span><span class="ident" id="1993999">_panic</span>&nbsp;<span class="op" id="1994006">=</span>&nbsp;<span class="op" id="1994008">(</span><span class="op" id="1994009">*</span><span class="ident" id="1994010">_panic</span><span class="op" id="1994016">)</span><span class="op" id="1994017">(</span><span class="ident" id="1994018">noescape</span><span class="op" id="1994026">(</span><span class="op" id="1994027">(</span><span class="ident" id="1994028">unsafe</span><span class="op" id="1994034">.</span><span class="ident" id="1994035">Pointer</span><span class="op" id="1994042">)</span><span class="op" id="1994043">(</span><span class="op" id="1994044">&amp;</span><span class="ident" id="1994045">p</span><span class="op" id="1994046">)</span><span class="op" id="1994047">)</span><span class="op" id="1994048">)</span><br>
<span class="lineno">385</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1994053">p</span><span class="op" id="1994054">.</span><span class="ident" id="1994055">argp</span>&nbsp;<span class="op" id="1994060">=</span>&nbsp;<span class="ident" id="1994062">unsafe</span><span class="op" id="1994068">.</span><span class="ident" id="1994069">Pointer</span><span class="op" id="1994076">(</span><span class="ident" id="1994077">getargp</span><span class="op" id="1994084">(</span><span class="num" id="1994085">0</span><span class="op" id="1994086">)</span><span class="op" id="1994087">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1994091">reflectcall</span><span class="op" id="1994102">(</span><span class="ident" id="1994103">unsafe</span><span class="op" id="1994109">.</span><span class="ident" id="1994110">Pointer</span><span class="op" id="1994117">(</span><span class="ident" id="1994118">d</span><span class="op" id="1994119">.</span><span class="ident" id="1994120">fn</span><span class="op" id="1994122">)</span><span class="op" id="1994123">,</span>&nbsp;<span class="ident" id="1994125">deferArgs</span><span class="op" id="1994134">(</span><span class="ident" id="1994135">d</span><span class="op" id="1994136">)</span><span class="op" id="1994137">,</span>&nbsp;<span class="builtintype" id="1994139">uint32</span><span class="op" id="1994145">(</span><span class="ident" id="1994146">d</span><span class="op" id="1994147">.</span><span class="ident" id="1994148">siz</span><span class="op" id="1994151">)</span><span class="op" id="1994152">,</span>&nbsp;<span class="builtintype" id="1994154">uint32</span><span class="op" id="1994160">(</span><span class="ident" id="1994161">d</span><span class="op" id="1994162">.</span><span class="ident" id="1994163">siz</span><span class="op" id="1994166">)</span><span class="op" id="1994167">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1994171">p</span><span class="op" id="1994172">.</span><span class="ident" id="1994173">argp</span>&nbsp;<span class="op" id="1994178">=</span>&nbsp;<span class="ident" id="1994180">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1994187">//&nbsp;reflectcall&nbsp;did&nbsp;not&nbsp;panic.&nbsp;Remove&nbsp;d.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1994229">if</span>&nbsp;<span class="ident" id="1994232">gp</span><span class="op" id="1994234">.</span><span class="ident" id="1994235">_defer</span>&nbsp;<span class="op" id="1994242">!=</span>&nbsp;<span class="ident" id="1994245">d</span>&nbsp;<span class="op" id="1994247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1994252">gothrow</span><span class="op" id="1994259">(</span><span class="string" id="1994260">&#34;bad&nbsp;defer&nbsp;entry&nbsp;in&nbsp;panic&#34;</span><span class="op" id="1994286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1994290">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1994294">d</span><span class="op" id="1994295">.</span><span class="ident" id="1994296">_panic</span>&nbsp;<span class="op" id="1994303">=</span>&nbsp;<span class="ident" id="1994305">nil</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1994311">d</span><span class="op" id="1994312">.</span><span class="ident" id="1994313">fn</span>&nbsp;<span class="op" id="1994316">=</span>&nbsp;<span class="ident" id="1994318">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1994324">gp</span><span class="op" id="1994326">.</span><span class="ident" id="1994327">_defer</span>&nbsp;<span class="op" id="1994334">=</span>&nbsp;<span class="ident" id="1994336">d</span><span class="op" id="1994337">.</span><span class="ident" id="1994338">link</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1994346">//&nbsp;trigger&nbsp;shrinkage&nbsp;to&nbsp;test&nbsp;stack&nbsp;copy.&nbsp;&nbsp;See&nbsp;stack_test.go:TestStackPanic</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1994423">//GC()</span><br>
<span class="lineno">400</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1994433">pc</span>&nbsp;<span class="op" id="1994436">:=</span>&nbsp;<span class="ident" id="1994439">d</span><span class="op" id="1994440">.</span><span class="ident" id="1994441">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1994446">argp</span>&nbsp;<span class="op" id="1994451">:=</span>&nbsp;<span class="ident" id="1994454">unsafe</span><span class="op" id="1994460">.</span><span class="ident" id="1994461">Pointer</span><span class="op" id="1994468">(</span><span class="ident" id="1994469">d</span><span class="op" id="1994470">.</span><span class="ident" id="1994471">argp</span><span class="op" id="1994475">)</span>&nbsp;<span class="comment" id="1994477">//&nbsp;must&nbsp;be&nbsp;pointer&nbsp;so&nbsp;it&nbsp;gets&nbsp;adjusted&nbsp;during&nbsp;stack&nbsp;copy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1994536">freedefer</span><span class="op" id="1994545">(</span><span class="ident" id="1994546">d</span><span class="op" id="1994547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1994551">if</span>&nbsp;<span class="ident" id="1994554">p</span><span class="op" id="1994555">.</span><span class="ident" id="1994556">recovered</span>&nbsp;<span class="op" id="1994566">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1994571">gp</span><span class="op" id="1994573">.</span><span class="ident" id="1994574">_panic</span>&nbsp;<span class="op" id="1994581">=</span>&nbsp;<span class="ident" id="1994583">p</span><span class="op" id="1994584">.</span><span class="ident" id="1994585">link</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1994593">//&nbsp;Aborted&nbsp;panics&nbsp;are&nbsp;marked&nbsp;but&nbsp;remain&nbsp;on&nbsp;the&nbsp;g.panic&nbsp;list.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1994657">//&nbsp;Remove&nbsp;them&nbsp;from&nbsp;the&nbsp;list.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1994690">for</span>&nbsp;<span class="ident" id="1994694">gp</span><span class="op" id="1994696">.</span><span class="ident" id="1994697">_panic</span>&nbsp;<span class="op" id="1994704">!=</span>&nbsp;<span class="ident" id="1994707">nil</span>&nbsp;<span class="op" id="1994711">&amp;&amp;</span>&nbsp;<span class="ident" id="1994714">gp</span><span class="op" id="1994716">.</span><span class="ident" id="1994717">_panic</span><span class="op" id="1994723">.</span><span class="ident" id="1994724">aborted</span>&nbsp;<span class="op" id="1994732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1994738">gp</span><span class="op" id="1994740">.</span><span class="ident" id="1994741">_panic</span>&nbsp;<span class="op" id="1994748">=</span>&nbsp;<span class="ident" id="1994750">gp</span><span class="op" id="1994752">.</span><span class="ident" id="1994753">_panic</span><span class="op" id="1994759">.</span><span class="ident" id="1994760">link</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1994768">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1994773">if</span>&nbsp;<span class="ident" id="1994776">gp</span><span class="op" id="1994778">.</span><span class="ident" id="1994779">_panic</span>&nbsp;<span class="op" id="1994786">==</span>&nbsp;<span class="ident" id="1994789">nil</span>&nbsp;<span class="op" id="1994793">{</span>&nbsp;<span class="comment" id="1994795">//&nbsp;must&nbsp;be&nbsp;done&nbsp;with&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1994827">gp</span><span class="op" id="1994829">.</span><span class="ident" id="1994830">sig</span>&nbsp;<span class="op" id="1994834">=</span>&nbsp;<span class="num" id="1994836">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1994841">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1994846">//&nbsp;Pass&nbsp;information&nbsp;about&nbsp;recovering&nbsp;frame&nbsp;to&nbsp;recovery.</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1994905">gp</span><span class="op" id="1994907">.</span><span class="ident" id="1994908">sigcode0</span>&nbsp;<span class="op" id="1994917">=</span>&nbsp;<span class="builtintype" id="1994919">uintptr</span><span class="op" id="1994926">(</span><span class="ident" id="1994927">argp</span><span class="op" id="1994931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1994936">gp</span><span class="op" id="1994938">.</span><span class="ident" id="1994939">sigcode1</span>&nbsp;<span class="op" id="1994948">=</span>&nbsp;<span class="ident" id="1994950">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1994956">mcall</span><span class="op" id="1994961">(</span><span class="ident" id="1994962">recovery_m</span><span class="op" id="1994972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1994977">gothrow</span><span class="op" id="1994984">(</span><span class="string" id="1994985">&#34;recovery&nbsp;failed&#34;</span><span class="op" id="1995002">)</span>&nbsp;<span class="comment" id="1995004">//&nbsp;mcall&nbsp;should&nbsp;not&nbsp;return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1995033">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1995036">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1995040">//&nbsp;ran&nbsp;out&nbsp;of&nbsp;deferred&nbsp;calls&nbsp;-&nbsp;old-school&nbsp;panic&nbsp;now</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1995093">startpanic</span><span class="op" id="1995103">(</span><span class="op" id="1995104">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1995107">printpanics</span><span class="op" id="1995118">(</span><span class="ident" id="1995119">gp</span><span class="op" id="1995121">.</span><span class="ident" id="1995122">_panic</span><span class="op" id="1995128">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1995131">dopanic</span><span class="op" id="1995138">(</span><span class="num" id="1995139">0</span><span class="op" id="1995140">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1995148">//&nbsp;should&nbsp;not&nbsp;return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1995170">*</span><span class="op" id="1995171">(</span><span class="op" id="1995172">*</span><span class="builtintype" id="1995173">int</span><span class="op" id="1995176">)</span><span class="op" id="1995177">(</span><span class="ident" id="1995178">nil</span><span class="op" id="1995181">)</span>&nbsp;<span class="op" id="1995183">=</span>&nbsp;<span class="num" id="1995185">0</span>&nbsp;<span class="comment" id="1995187">//&nbsp;not&nbsp;reached</span><br>
<span class="lineno"></span><span class="op" id="1995202">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1995205">//&nbsp;getargp&nbsp;returns&nbsp;the&nbsp;location&nbsp;where&nbsp;the&nbsp;caller</span><br>
<span class="lineno">430</span><span class="comment" id="1995254">//&nbsp;writes&nbsp;outgoing&nbsp;function&nbsp;call&nbsp;arguments.</span><br>
<span class="lineno"></span><span class="comment" id="1995298">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1995311">func</span>&nbsp;<span class="ident" id="1995316">getargp</span><span class="op" id="1995323">(</span><span class="ident" id="1995324">x</span>&nbsp;<span class="builtintype" id="1995326">int</span><span class="op" id="1995329">)</span>&nbsp;<span class="builtintype" id="1995331">uintptr</span>&nbsp;<span class="op" id="1995339">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1995342">//&nbsp;x&nbsp;is&nbsp;an&nbsp;argument&nbsp;mainly&nbsp;so&nbsp;that&nbsp;we&nbsp;can&nbsp;return&nbsp;its&nbsp;address.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1995405">//&nbsp;However,&nbsp;we&nbsp;need&nbsp;to&nbsp;make&nbsp;the&nbsp;function&nbsp;complex&nbsp;enough</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1995462">//&nbsp;that&nbsp;it&nbsp;won&#39;t&nbsp;be&nbsp;inlined.&nbsp;We&nbsp;always&nbsp;pass&nbsp;x&nbsp;=&nbsp;0,&nbsp;so&nbsp;this&nbsp;code</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1995527">//&nbsp;does&nbsp;nothing&nbsp;other&nbsp;than&nbsp;keep&nbsp;the&nbsp;compiler&nbsp;from&nbsp;thinking</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1995587">//&nbsp;the&nbsp;function&nbsp;is&nbsp;simple&nbsp;enough&nbsp;to&nbsp;inline.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1995632">if</span>&nbsp;<span class="ident" id="1995635">x</span>&nbsp;<span class="op" id="1995637">&gt;</span>&nbsp;<span class="num" id="1995639">0</span>&nbsp;<span class="op" id="1995641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1995645">return</span>&nbsp;<span class="ident" id="1995652">getcallersp</span><span class="op" id="1995663">(</span><span class="ident" id="1995664">unsafe</span><span class="op" id="1995670">.</span><span class="ident" id="1995671">Pointer</span><span class="op" id="1995678">(</span><span class="op" id="1995679">&amp;</span><span class="ident" id="1995680">x</span><span class="op" id="1995681">)</span><span class="op" id="1995682">)</span>&nbsp;<span class="op" id="1995684">*</span>&nbsp;<span class="num" id="1995686">0</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1995689">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1995692">return</span>&nbsp;<span class="builtintype" id="1995699">uintptr</span><span class="op" id="1995706">(</span><span class="ident" id="1995707">noescape</span><span class="op" id="1995715">(</span><span class="ident" id="1995716">unsafe</span><span class="op" id="1995722">.</span><span class="ident" id="1995723">Pointer</span><span class="op" id="1995730">(</span><span class="op" id="1995731">&amp;</span><span class="ident" id="1995732">x</span><span class="op" id="1995733">)</span><span class="op" id="1995734">)</span><span class="op" id="1995735">)</span><br>
<span class="lineno"></span><span class="op" id="1995737">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1995740">//&nbsp;The&nbsp;implementation&nbsp;of&nbsp;the&nbsp;predeclared&nbsp;function&nbsp;recover.</span><br>
<span class="lineno">445</span><span class="comment" id="1995799">//&nbsp;Cannot&nbsp;split&nbsp;the&nbsp;stack&nbsp;because&nbsp;it&nbsp;needs&nbsp;to&nbsp;reliably</span><br>
<span class="lineno"></span><span class="comment" id="1995854">//&nbsp;find&nbsp;the&nbsp;stack&nbsp;segment&nbsp;of&nbsp;its&nbsp;caller.</span><br>
<span class="lineno"></span><span class="comment" id="1995895">//</span><br>
<span class="lineno"></span><span class="comment" id="1995898">//&nbsp;TODO(rsc):&nbsp;Once&nbsp;we&nbsp;commit&nbsp;to&nbsp;CopyStackAlways,</span><br>
<span class="lineno"></span><span class="comment" id="1995947">//&nbsp;this&nbsp;doesn&#39;t&nbsp;need&nbsp;to&nbsp;be&nbsp;nosplit.</span><br>
<span class="lineno">450</span><span class="comment" id="1995983">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1995996">func</span>&nbsp;<span class="ident" id="1996001">gorecover</span><span class="op" id="1996010">(</span><span class="ident" id="1996011">argp</span>&nbsp;<span class="builtintype" id="1996016">uintptr</span><span class="op" id="1996023">)</span>&nbsp;<span class="keyword" id="1996025">interface</span><span class="op" id="1996034">{</span><span class="op" id="1996035">}</span>&nbsp;<span class="op" id="1996037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1996040">//&nbsp;Must&nbsp;be&nbsp;in&nbsp;a&nbsp;function&nbsp;running&nbsp;as&nbsp;part&nbsp;of&nbsp;a&nbsp;deferred&nbsp;call&nbsp;during&nbsp;the&nbsp;panic.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1996119">//&nbsp;Must&nbsp;be&nbsp;called&nbsp;from&nbsp;the&nbsp;topmost&nbsp;function&nbsp;of&nbsp;the&nbsp;call</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1996176">//&nbsp;(the&nbsp;function&nbsp;used&nbsp;in&nbsp;the&nbsp;defer&nbsp;statement).</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1996224">//&nbsp;p.argp&nbsp;is&nbsp;the&nbsp;argument&nbsp;pointer&nbsp;of&nbsp;that&nbsp;topmost&nbsp;deferred&nbsp;function&nbsp;call.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1996299">//&nbsp;Compare&nbsp;against&nbsp;argp&nbsp;reported&nbsp;by&nbsp;caller.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1996344">//&nbsp;If&nbsp;they&nbsp;match,&nbsp;the&nbsp;caller&nbsp;is&nbsp;the&nbsp;one&nbsp;who&nbsp;can&nbsp;recover.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1996402">gp</span>&nbsp;<span class="op" id="1996405">:=</span>&nbsp;<span class="ident" id="1996408">getg</span><span class="op" id="1996412">(</span><span class="op" id="1996413">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1996416">p</span>&nbsp;<span class="op" id="1996418">:=</span>&nbsp;<span class="ident" id="1996421">gp</span><span class="op" id="1996423">.</span><span class="ident" id="1996424">_panic</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1996432">if</span>&nbsp;<span class="ident" id="1996435">p</span>&nbsp;<span class="op" id="1996437">!=</span>&nbsp;<span class="ident" id="1996440">nil</span>&nbsp;<span class="op" id="1996444">&amp;&amp;</span>&nbsp;<span class="op" id="1996447">!</span><span class="ident" id="1996448">p</span><span class="op" id="1996449">.</span><span class="ident" id="1996450">recovered</span>&nbsp;<span class="op" id="1996460">&amp;&amp;</span>&nbsp;<span class="ident" id="1996463">argp</span>&nbsp;<span class="op" id="1996468">==</span>&nbsp;<span class="builtintype" id="1996471">uintptr</span><span class="op" id="1996478">(</span><span class="ident" id="1996479">p</span><span class="op" id="1996480">.</span><span class="ident" id="1996481">argp</span><span class="op" id="1996485">)</span>&nbsp;<span class="op" id="1996487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1996491">p</span><span class="op" id="1996492">.</span><span class="ident" id="1996493">recovered</span>&nbsp;<span class="op" id="1996503">=</span>&nbsp;<span class="builtintype" id="1996505">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1996512">return</span>&nbsp;<span class="ident" id="1996519">p</span><span class="op" id="1996520">.</span><span class="ident" id="1996521">arg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1996526">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1996529">return</span>&nbsp;<span class="ident" id="1996536">nil</span><br>
<span class="lineno">465</span><span class="op" id="1996540">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1996543">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1996556">func</span>&nbsp;<span class="ident" id="1996561">startpanic</span><span class="op" id="1996571">(</span><span class="op" id="1996572">)</span>&nbsp;<span class="op" id="1996574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1996577">onM_signalok</span><span class="op" id="1996589">(</span><span class="ident" id="1996590">startpanic_m</span><span class="op" id="1996602">)</span><br>
<span class="lineno">470</span><span class="op" id="1996604">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1996607">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1996620">func</span>&nbsp;<span class="ident" id="1996625">dopanic</span><span class="op" id="1996632">(</span><span class="ident" id="1996633">unused</span>&nbsp;<span class="builtintype" id="1996640">int</span><span class="op" id="1996643">)</span>&nbsp;<span class="op" id="1996645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1996648">gp</span>&nbsp;<span class="op" id="1996651">:=</span>&nbsp;<span class="ident" id="1996654">getg</span><span class="op" id="1996658">(</span><span class="op" id="1996659">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1996662">mp</span>&nbsp;<span class="op" id="1996665">:=</span>&nbsp;<span class="ident" id="1996668">acquirem</span><span class="op" id="1996676">(</span><span class="op" id="1996677">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1996680">mp</span><span class="op" id="1996682">.</span><span class="ident" id="1996683">ptrarg</span><span class="op" id="1996689">[</span><span class="num" id="1996690">0</span><span class="op" id="1996691">]</span>&nbsp;<span class="op" id="1996693">=</span>&nbsp;<span class="ident" id="1996695">unsafe</span><span class="op" id="1996701">.</span><span class="ident" id="1996702">Pointer</span><span class="op" id="1996709">(</span><span class="ident" id="1996710">gp</span><span class="op" id="1996712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1996715">mp</span><span class="op" id="1996717">.</span><span class="ident" id="1996718">scalararg</span><span class="op" id="1996727">[</span><span class="num" id="1996728">0</span><span class="op" id="1996729">]</span>&nbsp;<span class="op" id="1996731">=</span>&nbsp;<span class="ident" id="1996733">getcallerpc</span><span class="op" id="1996744">(</span><span class="op" id="1996745">(</span><span class="ident" id="1996746">unsafe</span><span class="op" id="1996752">.</span><span class="ident" id="1996753">Pointer</span><span class="op" id="1996760">)</span><span class="op" id="1996761">(</span><span class="op" id="1996762">&amp;</span><span class="ident" id="1996763">unused</span><span class="op" id="1996769">)</span><span class="op" id="1996770">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1996773">mp</span><span class="op" id="1996775">.</span><span class="ident" id="1996776">scalararg</span><span class="op" id="1996785">[</span><span class="num" id="1996786">1</span><span class="op" id="1996787">]</span>&nbsp;<span class="op" id="1996789">=</span>&nbsp;<span class="ident" id="1996791">getcallersp</span><span class="op" id="1996802">(</span><span class="op" id="1996803">(</span><span class="ident" id="1996804">unsafe</span><span class="op" id="1996810">.</span><span class="ident" id="1996811">Pointer</span><span class="op" id="1996818">)</span><span class="op" id="1996819">(</span><span class="op" id="1996820">&amp;</span><span class="ident" id="1996821">unused</span><span class="op" id="1996827">)</span><span class="op" id="1996828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1996831">onM_signalok</span><span class="op" id="1996843">(</span><span class="ident" id="1996844">dopanic_m</span><span class="op" id="1996853">)</span>&nbsp;<span class="comment" id="1996855">//&nbsp;should&nbsp;never&nbsp;return</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1996879">*</span><span class="op" id="1996880">(</span><span class="op" id="1996881">*</span><span class="builtintype" id="1996882">int</span><span class="op" id="1996885">)</span><span class="op" id="1996886">(</span><span class="ident" id="1996887">nil</span><span class="op" id="1996890">)</span>&nbsp;<span class="op" id="1996892">=</span>&nbsp;<span class="num" id="1996894">0</span><br>
<span class="lineno"></span><span class="op" id="1996896">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1996899">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1996912">func</span>&nbsp;<span class="ident" id="1996917">throw</span><span class="op" id="1996922">(</span><span class="ident" id="1996923">s</span>&nbsp;<span class="op" id="1996925">*</span><span class="builtintype" id="1996926">byte</span><span class="op" id="1996930">)</span>&nbsp;<span class="op" id="1996932">{</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1996935">gp</span>&nbsp;<span class="op" id="1996938">:=</span>&nbsp;<span class="ident" id="1996941">getg</span><span class="op" id="1996945">(</span><span class="op" id="1996946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1996949">if</span>&nbsp;<span class="ident" id="1996952">gp</span><span class="op" id="1996954">.</span><span class="ident" id="1996955">m</span><span class="op" id="1996956">.</span><span class="ident" id="1996957">throwing</span>&nbsp;<span class="op" id="1996966">==</span>&nbsp;<span class="num" id="1996969">0</span>&nbsp;<span class="op" id="1996971">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1996975">gp</span><span class="op" id="1996977">.</span><span class="ident" id="1996978">m</span><span class="op" id="1996979">.</span><span class="ident" id="1996980">throwing</span>&nbsp;<span class="op" id="1996989">=</span>&nbsp;<span class="num" id="1996991">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1996994">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1996997">startpanic</span><span class="op" id="1997007">(</span><span class="op" id="1997008">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1997011">print</span><span class="op" id="1997016">(</span><span class="string" id="1997017">&#34;fatal&nbsp;error:&nbsp;&#34;</span><span class="op" id="1997032">,</span>&nbsp;<span class="ident" id="1997034">gostringnocopy</span><span class="op" id="1997048">(</span><span class="ident" id="1997049">s</span><span class="op" id="1997050">)</span><span class="op" id="1997051">,</span>&nbsp;<span class="string" id="1997053">&#34;\n&#34;</span><span class="op" id="1997057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1997060">dopanic</span><span class="op" id="1997067">(</span><span class="num" id="1997068">0</span><span class="op" id="1997069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1997072">*</span><span class="op" id="1997073">(</span><span class="op" id="1997074">*</span><span class="builtintype" id="1997075">int</span><span class="op" id="1997078">)</span><span class="op" id="1997079">(</span><span class="ident" id="1997080">nil</span><span class="op" id="1997083">)</span>&nbsp;<span class="op" id="1997085">=</span>&nbsp;<span class="num" id="1997087">0</span>&nbsp;<span class="comment" id="1997089">//&nbsp;not&nbsp;reached</span><br>
<span class="lineno"></span><span class="op" id="1997104">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">495</span><span class="comment" id="1997107">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1997120">func</span>&nbsp;<span class="ident" id="1997125">gothrow</span><span class="op" id="1997132">(</span><span class="ident" id="1997133">s</span>&nbsp;<span class="builtintype" id="1997135">string</span><span class="op" id="1997141">)</span>&nbsp;<span class="op" id="1997143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1997146">gp</span>&nbsp;<span class="op" id="1997149">:=</span>&nbsp;<span class="ident" id="1997152">getg</span><span class="op" id="1997156">(</span><span class="op" id="1997157">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1997160">if</span>&nbsp;<span class="ident" id="1997163">gp</span><span class="op" id="1997165">.</span><span class="ident" id="1997166">m</span><span class="op" id="1997167">.</span><span class="ident" id="1997168">throwing</span>&nbsp;<span class="op" id="1997177">==</span>&nbsp;<span class="num" id="1997180">0</span>&nbsp;<span class="op" id="1997182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1997186">gp</span><span class="op" id="1997188">.</span><span class="ident" id="1997189">m</span><span class="op" id="1997190">.</span><span class="ident" id="1997191">throwing</span>&nbsp;<span class="op" id="1997200">=</span>&nbsp;<span class="num" id="1997202">1</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1997205">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1997208">startpanic</span><span class="op" id="1997218">(</span><span class="op" id="1997219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1997222">print</span><span class="op" id="1997227">(</span><span class="string" id="1997228">&#34;fatal&nbsp;error:&nbsp;&#34;</span><span class="op" id="1997243">,</span>&nbsp;<span class="ident" id="1997245">s</span><span class="op" id="1997246">,</span>&nbsp;<span class="string" id="1997248">&#34;\n&#34;</span><span class="op" id="1997252">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1997255">dopanic</span><span class="op" id="1997262">(</span><span class="num" id="1997263">0</span><span class="op" id="1997264">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1997267">*</span><span class="op" id="1997268">(</span><span class="op" id="1997269">*</span><span class="builtintype" id="1997270">int</span><span class="op" id="1997273">)</span><span class="op" id="1997274">(</span><span class="ident" id="1997275">nil</span><span class="op" id="1997278">)</span>&nbsp;<span class="op" id="1997280">=</span>&nbsp;<span class="num" id="1997282">0</span>&nbsp;<span class="comment" id="1997284">//&nbsp;not&nbsp;reached</span><br>
<span class="lineno">505</span><span class="op" id="1997299">}</span>
</div>
</body>
</html>
