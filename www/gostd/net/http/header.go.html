<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http</h2>
<ul>
<li><a href="/gostd/net/http/client.go.html">client.go</a></li>
<li><a href="/gostd/net/http/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/http/cookie.go.html">cookie.go</a></li>
<li><a href="/gostd/net/http/cookie_test.go.html">cookie_test.go</a></li>
<li><a href="/gostd/net/http/doc.go.html">doc.go</a></li>
<li><a href="/gostd/net/http/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/net/http/filetransport.go.html">filetransport.go</a></li>
<li><a href="/gostd/net/http/filetransport_test.go.html">filetransport_test.go</a></li>
<li><a href="/gostd/net/http/fs.go.html">fs.go</a></li>
<li><a href="/gostd/net/http/fs_test.go.html">fs_test.go</a></li>
<li><a href="/gostd/net/http/header.go.html" class="current">header.go</a></li>
<li><a href="/gostd/net/http/header_test.go.html">header_test.go</a></li>
<li><a href="/gostd/net/http/jar.go.html">jar.go</a></li>
<li><a href="/gostd/net/http/lex.go.html">lex.go</a></li>
<li><a href="/gostd/net/http/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/net/http/main_test.go.html">main_test.go</a></li>
<li><a href="/gostd/net/http/npn_test.go.html">npn_test.go</a></li>
<li><a href="/gostd/net/http/proxy_test.go.html">proxy_test.go</a></li>
<li><a href="/gostd/net/http/range_test.go.html">range_test.go</a></li>
<li><a href="/gostd/net/http/readrequest_test.go.html">readrequest_test.go</a></li>
<li><a href="/gostd/net/http/request.go.html">request.go</a></li>
<li><a href="/gostd/net/http/request_test.go.html">request_test.go</a></li>
<li><a href="/gostd/net/http/requestwrite_test.go.html">requestwrite_test.go</a></li>
<li><a href="/gostd/net/http/response.go.html">response.go</a></li>
<li><a href="/gostd/net/http/response_test.go.html">response_test.go</a></li>
<li><a href="/gostd/net/http/responsewrite_test.go.html">responsewrite_test.go</a></li>
<li><a href="/gostd/net/http/serve_test.go.html">serve_test.go</a></li>
<li><a href="/gostd/net/http/server.go.html">server.go</a></li>
<li><a href="/gostd/net/http/sniff.go.html">sniff.go</a></li>
<li><a href="/gostd/net/http/sniff_test.go.html">sniff_test.go</a></li>
<li><a href="/gostd/net/http/status.go.html">status.go</a></li>
<li><a href="/gostd/net/http/transfer.go.html">transfer.go</a></li>
<li><a href="/gostd/net/http/transfer_test.go.html">transfer_test.go</a></li>
<li><a href="/gostd/net/http/transport.go.html">transport.go</a></li>
<li><a href="/gostd/net/http/transport_test.go.html">transport_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3833576">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3833632">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3833686">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3833737">package</span>&nbsp;<span class="ident" id="3833745">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3833751">import</span>&nbsp;<span class="op" id="3833758">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3833761">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3833767">&#34;net/textproto&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3833784">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3833792">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3833803">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3833811">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3833818">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword" id="3833821">var</span>&nbsp;<span class="ident" id="3833825">raceEnabled</span>&nbsp;<span class="op" id="3833837">=</span>&nbsp;<span class="builtintype" id="3833839">false</span>&nbsp;<span class="comment" id="3833845">//&nbsp;set&nbsp;by&nbsp;race.go</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3833864">//&nbsp;A&nbsp;Header&nbsp;represents&nbsp;the&nbsp;key-value&nbsp;pairs&nbsp;in&nbsp;an&nbsp;HTTP&nbsp;header.</span><br>
<span class="lineno"></span><span class="keyword" id="3833926">type</span>&nbsp;<span class="ident" id="3833931">Header</span>&nbsp;<span class="keyword" id="3833938">map</span><span class="op" id="3833941">[</span><span class="builtintype" id="3833942">string</span><span class="op" id="3833948">]</span><span class="op" id="3833949">[</span><span class="op" id="3833950">]</span><span class="builtintype" id="3833951">string</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="comment" id="3833959">//&nbsp;Add&nbsp;adds&nbsp;the&nbsp;key,&nbsp;value&nbsp;pair&nbsp;to&nbsp;the&nbsp;header.</span><br>
<span class="lineno"></span><span class="comment" id="3834006">//&nbsp;It&nbsp;appends&nbsp;to&nbsp;any&nbsp;existing&nbsp;values&nbsp;associated&nbsp;with&nbsp;key.</span><br>
<span class="lineno"></span><span class="keyword" id="3834064">func</span>&nbsp;<span class="op" id="3834069">(</span><span class="ident" id="3834070">h</span>&nbsp;<span class="ident" id="3834072">Header</span><span class="op" id="3834078">)</span>&nbsp;<span class="ident" id="3834080">Add</span><span class="op" id="3834083">(</span><span class="ident" id="3834084">key</span><span class="op" id="3834087">,</span>&nbsp;<span class="ident" id="3834089">value</span>&nbsp;<span class="builtintype" id="3834095">string</span><span class="op" id="3834101">)</span>&nbsp;<span class="op" id="3834103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3834106">textproto</span><span class="op" id="3834115">.</span><span class="ident" id="3834116">MIMEHeader</span><span class="op" id="3834126">(</span><span class="ident" id="3834127">h</span><span class="op" id="3834128">)</span><span class="op" id="3834129">.</span><span class="ident" id="3834130">Add</span><span class="op" id="3834133">(</span><span class="ident" id="3834134">key</span><span class="op" id="3834137">,</span>&nbsp;<span class="ident" id="3834139">value</span><span class="op" id="3834144">)</span><br>
<span class="lineno">25</span><span class="op" id="3834146">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3834149">//&nbsp;Set&nbsp;sets&nbsp;the&nbsp;header&nbsp;entries&nbsp;associated&nbsp;with&nbsp;key&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3834203">//&nbsp;the&nbsp;single&nbsp;element&nbsp;value.&nbsp;&nbsp;It&nbsp;replaces&nbsp;any&nbsp;existing</span><br>
<span class="lineno"></span><span class="comment" id="3834258">//&nbsp;values&nbsp;associated&nbsp;with&nbsp;key.</span><br>
<span class="lineno">30</span><span class="keyword" id="3834289">func</span>&nbsp;<span class="op" id="3834294">(</span><span class="ident" id="3834295">h</span>&nbsp;<span class="ident" id="3834297">Header</span><span class="op" id="3834303">)</span>&nbsp;<span class="ident" id="3834305">Set</span><span class="op" id="3834308">(</span><span class="ident" id="3834309">key</span><span class="op" id="3834312">,</span>&nbsp;<span class="ident" id="3834314">value</span>&nbsp;<span class="builtintype" id="3834320">string</span><span class="op" id="3834326">)</span>&nbsp;<span class="op" id="3834328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3834331">textproto</span><span class="op" id="3834340">.</span><span class="ident" id="3834341">MIMEHeader</span><span class="op" id="3834351">(</span><span class="ident" id="3834352">h</span><span class="op" id="3834353">)</span><span class="op" id="3834354">.</span><span class="ident" id="3834355">Set</span><span class="op" id="3834358">(</span><span class="ident" id="3834359">key</span><span class="op" id="3834362">,</span>&nbsp;<span class="ident" id="3834364">value</span><span class="op" id="3834369">)</span><br>
<span class="lineno"></span><span class="op" id="3834371">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3834374">//&nbsp;Get&nbsp;gets&nbsp;the&nbsp;first&nbsp;value&nbsp;associated&nbsp;with&nbsp;the&nbsp;given&nbsp;key.</span><br>
<span class="lineno">35</span><span class="comment" id="3834433">//&nbsp;If&nbsp;there&nbsp;are&nbsp;no&nbsp;values&nbsp;associated&nbsp;with&nbsp;the&nbsp;key,&nbsp;Get&nbsp;returns&nbsp;&#34;&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="3834500">//&nbsp;To&nbsp;access&nbsp;multiple&nbsp;values&nbsp;of&nbsp;a&nbsp;key,&nbsp;access&nbsp;the&nbsp;map&nbsp;directly</span><br>
<span class="lineno"></span><span class="comment" id="3834563">//&nbsp;with&nbsp;CanonicalHeaderKey.</span><br>
<span class="lineno"></span><span class="keyword" id="3834591">func</span>&nbsp;<span class="op" id="3834596">(</span><span class="ident" id="3834597">h</span>&nbsp;<span class="ident" id="3834599">Header</span><span class="op" id="3834605">)</span>&nbsp;<span class="ident" id="3834607">Get</span><span class="op" id="3834610">(</span><span class="ident" id="3834611">key</span>&nbsp;<span class="builtintype" id="3834615">string</span><span class="op" id="3834621">)</span>&nbsp;<span class="builtintype" id="3834623">string</span>&nbsp;<span class="op" id="3834630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3834633">return</span>&nbsp;<span class="ident" id="3834640">textproto</span><span class="op" id="3834649">.</span><span class="ident" id="3834650">MIMEHeader</span><span class="op" id="3834660">(</span><span class="ident" id="3834661">h</span><span class="op" id="3834662">)</span><span class="op" id="3834663">.</span><span class="ident" id="3834664">Get</span><span class="op" id="3834667">(</span><span class="ident" id="3834668">key</span><span class="op" id="3834671">)</span><br>
<span class="lineno">40</span><span class="op" id="3834673">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3834676">//&nbsp;get&nbsp;is&nbsp;like&nbsp;Get,&nbsp;but&nbsp;key&nbsp;must&nbsp;already&nbsp;be&nbsp;in&nbsp;CanonicalHeaderKey&nbsp;form.</span><br>
<span class="lineno"></span><span class="keyword" id="3834748">func</span>&nbsp;<span class="op" id="3834753">(</span><span class="ident" id="3834754">h</span>&nbsp;<span class="ident" id="3834756">Header</span><span class="op" id="3834762">)</span>&nbsp;<span class="ident" id="3834764">get</span><span class="op" id="3834767">(</span><span class="ident" id="3834768">key</span>&nbsp;<span class="builtintype" id="3834772">string</span><span class="op" id="3834778">)</span>&nbsp;<span class="builtintype" id="3834780">string</span>&nbsp;<span class="op" id="3834787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3834790">if</span>&nbsp;<span class="ident" id="3834793">v</span>&nbsp;<span class="op" id="3834795">:=</span>&nbsp;<span class="ident" id="3834798">h</span><span class="op" id="3834799">[</span><span class="ident" id="3834800">key</span><span class="op" id="3834803">]</span><span class="op" id="3834804">;</span>&nbsp;<span class="builtinfunc" id="3834806">len</span><span class="op" id="3834809">(</span><span class="ident" id="3834810">v</span><span class="op" id="3834811">)</span>&nbsp;<span class="op" id="3834813">&gt;</span>&nbsp;<span class="num" id="3834815">0</span>&nbsp;<span class="op" id="3834817">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3834821">return</span>&nbsp;<span class="ident" id="3834828">v</span><span class="op" id="3834829">[</span><span class="num" id="3834830">0</span><span class="op" id="3834831">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3834834">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3834837">return</span>&nbsp;<span class="string" id="3834844">&#34;&#34;</span><br>
<span class="lineno"></span><span class="op" id="3834847">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="3834850">//&nbsp;Del&nbsp;deletes&nbsp;the&nbsp;values&nbsp;associated&nbsp;with&nbsp;key.</span><br>
<span class="lineno"></span><span class="keyword" id="3834897">func</span>&nbsp;<span class="op" id="3834902">(</span><span class="ident" id="3834903">h</span>&nbsp;<span class="ident" id="3834905">Header</span><span class="op" id="3834911">)</span>&nbsp;<span class="ident" id="3834913">Del</span><span class="op" id="3834916">(</span><span class="ident" id="3834917">key</span>&nbsp;<span class="builtintype" id="3834921">string</span><span class="op" id="3834927">)</span>&nbsp;<span class="op" id="3834929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3834932">textproto</span><span class="op" id="3834941">.</span><span class="ident" id="3834942">MIMEHeader</span><span class="op" id="3834952">(</span><span class="ident" id="3834953">h</span><span class="op" id="3834954">)</span><span class="op" id="3834955">.</span><span class="ident" id="3834956">Del</span><span class="op" id="3834959">(</span><span class="ident" id="3834960">key</span><span class="op" id="3834963">)</span><br>
<span class="lineno"></span><span class="op" id="3834965">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="3834968">//&nbsp;Write&nbsp;writes&nbsp;a&nbsp;header&nbsp;in&nbsp;wire&nbsp;format.</span><br>
<span class="lineno"></span><span class="keyword" id="3835009">func</span>&nbsp;<span class="op" id="3835014">(</span><span class="ident" id="3835015">h</span>&nbsp;<span class="ident" id="3835017">Header</span><span class="op" id="3835023">)</span>&nbsp;<span class="ident" id="3835025">Write</span><span class="op" id="3835030">(</span><span class="ident" id="3835031">w</span>&nbsp;<span class="ident" id="3835033">io</span><span class="op" id="3835035">.</span><span class="ident" id="3835036">Writer</span><span class="op" id="3835042">)</span>&nbsp;<span class="builtintype" id="3835044">error</span>&nbsp;<span class="op" id="3835050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3835053">return</span>&nbsp;<span class="ident" id="3835060">h</span><span class="op" id="3835061">.</span><span class="ident" id="3835062">WriteSubset</span><span class="op" id="3835073">(</span><span class="ident" id="3835074">w</span><span class="op" id="3835075">,</span>&nbsp;<span class="ident" id="3835077">nil</span><span class="op" id="3835080">)</span><br>
<span class="lineno"></span><span class="op" id="3835082">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="3835085">func</span>&nbsp;<span class="op" id="3835090">(</span><span class="ident" id="3835091">h</span>&nbsp;<span class="ident" id="3835093">Header</span><span class="op" id="3835099">)</span>&nbsp;<span class="ident" id="3835101">clone</span><span class="op" id="3835106">(</span><span class="op" id="3835107">)</span>&nbsp;<span class="ident" id="3835109">Header</span>&nbsp;<span class="op" id="3835116">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3835119">h2</span>&nbsp;<span class="op" id="3835122">:=</span>&nbsp;<span class="builtinfunc" id="3835125">make</span><span class="op" id="3835129">(</span><span class="ident" id="3835130">Header</span><span class="op" id="3835136">,</span>&nbsp;<span class="builtinfunc" id="3835138">len</span><span class="op" id="3835141">(</span><span class="ident" id="3835142">h</span><span class="op" id="3835143">)</span><span class="op" id="3835144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3835147">for</span>&nbsp;<span class="ident" id="3835151">k</span><span class="op" id="3835152">,</span>&nbsp;<span class="ident" id="3835154">vv</span>&nbsp;<span class="op" id="3835157">:=</span>&nbsp;<span class="keyword" id="3835160">range</span>&nbsp;<span class="ident" id="3835166">h</span>&nbsp;<span class="op" id="3835168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3835172">vv2</span>&nbsp;<span class="op" id="3835176">:=</span>&nbsp;<span class="builtinfunc" id="3835179">make</span><span class="op" id="3835183">(</span><span class="op" id="3835184">[</span><span class="op" id="3835185">]</span><span class="builtintype" id="3835186">string</span><span class="op" id="3835192">,</span>&nbsp;<span class="builtinfunc" id="3835194">len</span><span class="op" id="3835197">(</span><span class="ident" id="3835198">vv</span><span class="op" id="3835200">)</span><span class="op" id="3835201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3835205">copy</span><span class="op" id="3835209">(</span><span class="ident" id="3835210">vv2</span><span class="op" id="3835213">,</span>&nbsp;<span class="ident" id="3835215">vv</span><span class="op" id="3835217">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3835221">h2</span><span class="op" id="3835223">[</span><span class="ident" id="3835224">k</span><span class="op" id="3835225">]</span>&nbsp;<span class="op" id="3835227">=</span>&nbsp;<span class="ident" id="3835229">vv2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3835234">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3835237">return</span>&nbsp;<span class="ident" id="3835244">h2</span><br>
<span class="lineno"></span><span class="op" id="3835247">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="keyword" id="3835250">var</span>&nbsp;<span class="ident" id="3835254">timeFormats</span>&nbsp;<span class="op" id="3835266">=</span>&nbsp;<span class="op" id="3835268">[</span><span class="op" id="3835269">]</span><span class="builtintype" id="3835270">string</span><span class="op" id="3835276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3835279">TimeFormat</span><span class="op" id="3835289">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3835292">time</span><span class="op" id="3835296">.</span><span class="ident" id="3835297">RFC850</span><span class="op" id="3835303">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3835306">time</span><span class="op" id="3835310">.</span><span class="ident" id="3835311">ANSIC</span><span class="op" id="3835316">,</span><br>
<span class="lineno"></span><span class="op" id="3835318">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="comment" id="3835321">//&nbsp;ParseTime&nbsp;parses&nbsp;a&nbsp;time&nbsp;header&nbsp;(such&nbsp;as&nbsp;the&nbsp;Date:&nbsp;header),</span><br>
<span class="lineno"></span><span class="comment" id="3835383">//&nbsp;trying&nbsp;each&nbsp;of&nbsp;the&nbsp;three&nbsp;formats&nbsp;allowed&nbsp;by&nbsp;HTTP/1.1:</span><br>
<span class="lineno"></span><span class="comment" id="3835440">//&nbsp;TimeFormat,&nbsp;time.RFC850,&nbsp;and&nbsp;time.ANSIC.</span><br>
<span class="lineno"></span><span class="keyword" id="3835484">func</span>&nbsp;<span class="ident" id="3835489">ParseTime</span><span class="op" id="3835498">(</span><span class="ident" id="3835499">text</span>&nbsp;<span class="builtintype" id="3835504">string</span><span class="op" id="3835510">)</span>&nbsp;<span class="op" id="3835512">(</span><span class="ident" id="3835513">t</span>&nbsp;<span class="ident" id="3835515">time</span><span class="op" id="3835519">.</span><span class="ident" id="3835520">Time</span><span class="op" id="3835524">,</span>&nbsp;<span class="ident" id="3835526">err</span>&nbsp;<span class="builtintype" id="3835530">error</span><span class="op" id="3835535">)</span>&nbsp;<span class="op" id="3835537">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3835540">for</span>&nbsp;<span class="ident" id="3835544">_</span><span class="op" id="3835545">,</span>&nbsp;<span class="ident" id="3835547">layout</span>&nbsp;<span class="op" id="3835554">:=</span>&nbsp;<span class="keyword" id="3835557">range</span>&nbsp;<span class="ident" id="3835563">timeFormats</span>&nbsp;<span class="op" id="3835575">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3835579">t</span><span class="op" id="3835580">,</span>&nbsp;<span class="ident" id="3835582">err</span>&nbsp;<span class="op" id="3835586">=</span>&nbsp;<span class="ident" id="3835588">time</span><span class="op" id="3835592">.</span><span class="ident" id="3835593">Parse</span><span class="op" id="3835598">(</span><span class="ident" id="3835599">layout</span><span class="op" id="3835605">,</span>&nbsp;<span class="ident" id="3835607">text</span><span class="op" id="3835611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3835615">if</span>&nbsp;<span class="ident" id="3835618">err</span>&nbsp;<span class="op" id="3835622">==</span>&nbsp;<span class="ident" id="3835625">nil</span>&nbsp;<span class="op" id="3835629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3835634">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3835643">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3835646">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3835649">return</span><br>
<span class="lineno"></span><span class="op" id="3835656">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3835659">var</span>&nbsp;<span class="ident" id="3835663">headerNewlineToSpace</span>&nbsp;<span class="op" id="3835684">=</span>&nbsp;<span class="ident" id="3835686">strings</span><span class="op" id="3835693">.</span><span class="ident" id="3835694">NewReplacer</span><span class="op" id="3835705">(</span><span class="string" id="3835706">&#34;\n&#34;</span><span class="op" id="3835710">,</span>&nbsp;<span class="string" id="3835712">&#34;&nbsp;&#34;</span><span class="op" id="3835715">,</span>&nbsp;<span class="string" id="3835717">&#34;\r&#34;</span><span class="op" id="3835721">,</span>&nbsp;<span class="string" id="3835723">&#34;&nbsp;&#34;</span><span class="op" id="3835726">)</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="keyword" id="3835729">type</span>&nbsp;<span class="ident" id="3835734">writeStringer</span>&nbsp;<span class="keyword" id="3835748">interface</span>&nbsp;<span class="op" id="3835758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3835761">WriteString</span><span class="op" id="3835772">(</span><span class="builtintype" id="3835773">string</span><span class="op" id="3835779">)</span>&nbsp;<span class="op" id="3835781">(</span><span class="builtintype" id="3835782">int</span><span class="op" id="3835785">,</span>&nbsp;<span class="builtintype" id="3835787">error</span><span class="op" id="3835792">)</span><br>
<span class="lineno"></span><span class="op" id="3835794">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="comment" id="3835797">//&nbsp;stringWriter&nbsp;implements&nbsp;WriteString&nbsp;on&nbsp;a&nbsp;Writer.</span><br>
<span class="lineno"></span><span class="keyword" id="3835849">type</span>&nbsp;<span class="ident" id="3835854">stringWriter</span>&nbsp;<span class="keyword" id="3835867">struct</span>&nbsp;<span class="op" id="3835874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3835877">w</span>&nbsp;<span class="ident" id="3835879">io</span><span class="op" id="3835881">.</span><span class="ident" id="3835882">Writer</span><br>
<span class="lineno"></span><span class="op" id="3835889">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="keyword" id="3835892">func</span>&nbsp;<span class="op" id="3835897">(</span><span class="ident" id="3835898">w</span>&nbsp;<span class="ident" id="3835900">stringWriter</span><span class="op" id="3835912">)</span>&nbsp;<span class="ident" id="3835914">WriteString</span><span class="op" id="3835925">(</span><span class="ident" id="3835926">s</span>&nbsp;<span class="builtintype" id="3835928">string</span><span class="op" id="3835934">)</span>&nbsp;<span class="op" id="3835936">(</span><span class="ident" id="3835937">n</span>&nbsp;<span class="builtintype" id="3835939">int</span><span class="op" id="3835942">,</span>&nbsp;<span class="ident" id="3835944">err</span>&nbsp;<span class="builtintype" id="3835948">error</span><span class="op" id="3835953">)</span>&nbsp;<span class="op" id="3835955">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3835958">return</span>&nbsp;<span class="ident" id="3835965">w</span><span class="op" id="3835966">.</span><span class="ident" id="3835967">w</span><span class="op" id="3835968">.</span><span class="ident" id="3835969">Write</span><span class="op" id="3835974">(</span><span class="op" id="3835975">[</span><span class="op" id="3835976">]</span><span class="builtintype" id="3835977">byte</span><span class="op" id="3835981">(</span><span class="ident" id="3835982">s</span><span class="op" id="3835983">)</span><span class="op" id="3835984">)</span><br>
<span class="lineno"></span><span class="op" id="3835986">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3835989">type</span>&nbsp;<span class="ident" id="3835994">keyValues</span>&nbsp;<span class="keyword" id="3836004">struct</span>&nbsp;<span class="op" id="3836011">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3836014">key</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3836021">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3836029">values</span>&nbsp;<span class="op" id="3836036">[</span><span class="op" id="3836037">]</span><span class="builtintype" id="3836038">string</span><br>
<span class="lineno"></span><span class="op" id="3836045">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3836048">//&nbsp;A&nbsp;headerSorter&nbsp;implements&nbsp;sort.Interface&nbsp;by&nbsp;sorting&nbsp;a&nbsp;[]keyValues</span><br>
<span class="lineno">110</span><span class="comment" id="3836117">//&nbsp;by&nbsp;key.&nbsp;It&#39;s&nbsp;used&nbsp;as&nbsp;a&nbsp;pointer,&nbsp;so&nbsp;it&nbsp;can&nbsp;fit&nbsp;in&nbsp;a&nbsp;sort.Interface</span><br>
<span class="lineno"></span><span class="comment" id="3836186">//&nbsp;interface&nbsp;value&nbsp;without&nbsp;allocation.</span><br>
<span class="lineno"></span><span class="keyword" id="3836225">type</span>&nbsp;<span class="ident" id="3836230">headerSorter</span>&nbsp;<span class="keyword" id="3836243">struct</span>&nbsp;<span class="op" id="3836250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3836253">kvs</span>&nbsp;<span class="op" id="3836257">[</span><span class="op" id="3836258">]</span><span class="ident" id="3836259">keyValues</span><br>
<span class="lineno"></span><span class="op" id="3836269">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span><span class="keyword" id="3836272">func</span>&nbsp;<span class="op" id="3836277">(</span><span class="ident" id="3836278">s</span>&nbsp;<span class="op" id="3836280">*</span><span class="ident" id="3836281">headerSorter</span><span class="op" id="3836293">)</span>&nbsp;<span class="ident" id="3836295">Len</span><span class="op" id="3836298">(</span><span class="op" id="3836299">)</span>&nbsp;<span class="builtintype" id="3836301">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3836315">{</span>&nbsp;<span class="keyword" id="3836317">return</span>&nbsp;<span class="builtinfunc" id="3836324">len</span><span class="op" id="3836327">(</span><span class="ident" id="3836328">s</span><span class="op" id="3836329">.</span><span class="ident" id="3836330">kvs</span><span class="op" id="3836333">)</span>&nbsp;<span class="op" id="3836335">}</span><br>
<span class="lineno"></span><span class="keyword" id="3836337">func</span>&nbsp;<span class="op" id="3836342">(</span><span class="ident" id="3836343">s</span>&nbsp;<span class="op" id="3836345">*</span><span class="ident" id="3836346">headerSorter</span><span class="op" id="3836358">)</span>&nbsp;<span class="ident" id="3836360">Swap</span><span class="op" id="3836364">(</span><span class="ident" id="3836365">i</span><span class="op" id="3836366">,</span>&nbsp;<span class="ident" id="3836368">j</span>&nbsp;<span class="builtintype" id="3836370">int</span><span class="op" id="3836373">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3836380">{</span>&nbsp;<span class="ident" id="3836382">s</span><span class="op" id="3836383">.</span><span class="ident" id="3836384">kvs</span><span class="op" id="3836387">[</span><span class="ident" id="3836388">i</span><span class="op" id="3836389">]</span><span class="op" id="3836390">,</span>&nbsp;<span class="ident" id="3836392">s</span><span class="op" id="3836393">.</span><span class="ident" id="3836394">kvs</span><span class="op" id="3836397">[</span><span class="ident" id="3836398">j</span><span class="op" id="3836399">]</span>&nbsp;<span class="op" id="3836401">=</span>&nbsp;<span class="ident" id="3836403">s</span><span class="op" id="3836404">.</span><span class="ident" id="3836405">kvs</span><span class="op" id="3836408">[</span><span class="ident" id="3836409">j</span><span class="op" id="3836410">]</span><span class="op" id="3836411">,</span>&nbsp;<span class="ident" id="3836413">s</span><span class="op" id="3836414">.</span><span class="ident" id="3836415">kvs</span><span class="op" id="3836418">[</span><span class="ident" id="3836419">i</span><span class="op" id="3836420">]</span>&nbsp;<span class="op" id="3836422">}</span><br>
<span class="lineno"></span><span class="keyword" id="3836424">func</span>&nbsp;<span class="op" id="3836429">(</span><span class="ident" id="3836430">s</span>&nbsp;<span class="op" id="3836432">*</span><span class="ident" id="3836433">headerSorter</span><span class="op" id="3836445">)</span>&nbsp;<span class="ident" id="3836447">Less</span><span class="op" id="3836451">(</span><span class="ident" id="3836452">i</span><span class="op" id="3836453">,</span>&nbsp;<span class="ident" id="3836455">j</span>&nbsp;<span class="builtintype" id="3836457">int</span><span class="op" id="3836460">)</span>&nbsp;<span class="builtintype" id="3836462">bool</span>&nbsp;<span class="op" id="3836467">{</span>&nbsp;<span class="keyword" id="3836469">return</span>&nbsp;<span class="ident" id="3836476">s</span><span class="op" id="3836477">.</span><span class="ident" id="3836478">kvs</span><span class="op" id="3836481">[</span><span class="ident" id="3836482">i</span><span class="op" id="3836483">]</span><span class="op" id="3836484">.</span><span class="ident" id="3836485">key</span>&nbsp;<span class="op" id="3836489">&lt;</span>&nbsp;<span class="ident" id="3836491">s</span><span class="op" id="3836492">.</span><span class="ident" id="3836493">kvs</span><span class="op" id="3836496">[</span><span class="ident" id="3836497">j</span><span class="op" id="3836498">]</span><span class="op" id="3836499">.</span><span class="ident" id="3836500">key</span>&nbsp;<span class="op" id="3836504">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="keyword" id="3836507">var</span>&nbsp;<span class="ident" id="3836511">headerSorterPool</span>&nbsp;<span class="op" id="3836528">=</span>&nbsp;<span class="ident" id="3836530">sync</span><span class="op" id="3836534">.</span><span class="ident" id="3836535">Pool</span><span class="op" id="3836539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3836542">New</span><span class="op" id="3836545">:</span>&nbsp;<span class="keyword" id="3836547">func</span><span class="op" id="3836551">(</span><span class="op" id="3836552">)</span>&nbsp;<span class="keyword" id="3836554">interface</span><span class="op" id="3836563">{</span><span class="op" id="3836564">}</span>&nbsp;<span class="op" id="3836566">{</span>&nbsp;<span class="keyword" id="3836568">return</span>&nbsp;<span class="builtinfunc" id="3836575">new</span><span class="op" id="3836578">(</span><span class="ident" id="3836579">headerSorter</span><span class="op" id="3836591">)</span>&nbsp;<span class="op" id="3836593">}</span><span class="op" id="3836594">,</span><br>
<span class="lineno"></span><span class="op" id="3836596">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3836599">//&nbsp;sortedKeyValues&nbsp;returns&nbsp;h&#39;s&nbsp;keys&nbsp;sorted&nbsp;in&nbsp;the&nbsp;returned&nbsp;kvs</span><br>
<span class="lineno">125</span><span class="comment" id="3836662">//&nbsp;slice.&nbsp;The&nbsp;headerSorter&nbsp;used&nbsp;to&nbsp;sort&nbsp;is&nbsp;also&nbsp;returned,&nbsp;for&nbsp;possible</span><br>
<span class="lineno"></span><span class="comment" id="3836733">//&nbsp;return&nbsp;to&nbsp;headerSorterCache.</span><br>
<span class="lineno"></span><span class="keyword" id="3836765">func</span>&nbsp;<span class="op" id="3836770">(</span><span class="ident" id="3836771">h</span>&nbsp;<span class="ident" id="3836773">Header</span><span class="op" id="3836779">)</span>&nbsp;<span class="ident" id="3836781">sortedKeyValues</span><span class="op" id="3836796">(</span><span class="ident" id="3836797">exclude</span>&nbsp;<span class="keyword" id="3836805">map</span><span class="op" id="3836808">[</span><span class="builtintype" id="3836809">string</span><span class="op" id="3836815">]</span><span class="builtintype" id="3836816">bool</span><span class="op" id="3836820">)</span>&nbsp;<span class="op" id="3836822">(</span><span class="ident" id="3836823">kvs</span>&nbsp;<span class="op" id="3836827">[</span><span class="op" id="3836828">]</span><span class="ident" id="3836829">keyValues</span><span class="op" id="3836838">,</span>&nbsp;<span class="ident" id="3836840">hs</span>&nbsp;<span class="op" id="3836843">*</span><span class="ident" id="3836844">headerSorter</span><span class="op" id="3836856">)</span>&nbsp;<span class="op" id="3836858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3836861">hs</span>&nbsp;<span class="op" id="3836864">=</span>&nbsp;<span class="ident" id="3836866">headerSorterPool</span><span class="op" id="3836882">.</span><span class="ident" id="3836883">Get</span><span class="op" id="3836886">(</span><span class="op" id="3836887">)</span><span class="op" id="3836888">.</span><span class="op" id="3836889">(</span><span class="op" id="3836890">*</span><span class="ident" id="3836891">headerSorter</span><span class="op" id="3836903">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3836906">if</span>&nbsp;<span class="builtinfunc" id="3836909">cap</span><span class="op" id="3836912">(</span><span class="ident" id="3836913">hs</span><span class="op" id="3836915">.</span><span class="ident" id="3836916">kvs</span><span class="op" id="3836919">)</span>&nbsp;<span class="op" id="3836921">&lt;</span>&nbsp;<span class="builtinfunc" id="3836923">len</span><span class="op" id="3836926">(</span><span class="ident" id="3836927">h</span><span class="op" id="3836928">)</span>&nbsp;<span class="op" id="3836930">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3836934">hs</span><span class="op" id="3836936">.</span><span class="ident" id="3836937">kvs</span>&nbsp;<span class="op" id="3836941">=</span>&nbsp;<span class="builtinfunc" id="3836943">make</span><span class="op" id="3836947">(</span><span class="op" id="3836948">[</span><span class="op" id="3836949">]</span><span class="ident" id="3836950">keyValues</span><span class="op" id="3836959">,</span>&nbsp;<span class="num" id="3836961">0</span><span class="op" id="3836962">,</span>&nbsp;<span class="builtinfunc" id="3836964">len</span><span class="op" id="3836967">(</span><span class="ident" id="3836968">h</span><span class="op" id="3836969">)</span><span class="op" id="3836970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3836973">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3836976">kvs</span>&nbsp;<span class="op" id="3836980">=</span>&nbsp;<span class="ident" id="3836982">hs</span><span class="op" id="3836984">.</span><span class="ident" id="3836985">kvs</span><span class="op" id="3836988">[</span><span class="op" id="3836989">:</span><span class="num" id="3836990">0</span><span class="op" id="3836991">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3836994">for</span>&nbsp;<span class="ident" id="3836998">k</span><span class="op" id="3836999">,</span>&nbsp;<span class="ident" id="3837001">vv</span>&nbsp;<span class="op" id="3837004">:=</span>&nbsp;<span class="keyword" id="3837007">range</span>&nbsp;<span class="ident" id="3837013">h</span>&nbsp;<span class="op" id="3837015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3837019">if</span>&nbsp;<span class="op" id="3837022">!</span><span class="ident" id="3837023">exclude</span><span class="op" id="3837030">[</span><span class="ident" id="3837031">k</span><span class="op" id="3837032">]</span>&nbsp;<span class="op" id="3837034">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3837039">kvs</span>&nbsp;<span class="op" id="3837043">=</span>&nbsp;<span class="builtinfunc" id="3837045">append</span><span class="op" id="3837051">(</span><span class="ident" id="3837052">kvs</span><span class="op" id="3837055">,</span>&nbsp;<span class="ident" id="3837057">keyValues</span><span class="op" id="3837066">{</span><span class="ident" id="3837067">k</span><span class="op" id="3837068">,</span>&nbsp;<span class="ident" id="3837070">vv</span><span class="op" id="3837072">}</span><span class="op" id="3837073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3837077">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3837080">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3837083">hs</span><span class="op" id="3837085">.</span><span class="ident" id="3837086">kvs</span>&nbsp;<span class="op" id="3837090">=</span>&nbsp;<span class="ident" id="3837092">kvs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3837097">sort</span><span class="op" id="3837101">.</span><span class="ident" id="3837102">Sort</span><span class="op" id="3837106">(</span><span class="ident" id="3837107">hs</span><span class="op" id="3837109">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3837112">return</span>&nbsp;<span class="ident" id="3837119">kvs</span><span class="op" id="3837122">,</span>&nbsp;<span class="ident" id="3837124">hs</span><br>
<span class="lineno"></span><span class="op" id="3837127">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3837130">//&nbsp;WriteSubset&nbsp;writes&nbsp;a&nbsp;header&nbsp;in&nbsp;wire&nbsp;format.</span><br>
<span class="lineno"></span><span class="comment" id="3837177">//&nbsp;If&nbsp;exclude&nbsp;is&nbsp;not&nbsp;nil,&nbsp;keys&nbsp;where&nbsp;exclude[key]&nbsp;==&nbsp;true&nbsp;are&nbsp;not&nbsp;written.</span><br>
<span class="lineno">145</span><span class="keyword" id="3837252">func</span>&nbsp;<span class="op" id="3837257">(</span><span class="ident" id="3837258">h</span>&nbsp;<span class="ident" id="3837260">Header</span><span class="op" id="3837266">)</span>&nbsp;<span class="ident" id="3837268">WriteSubset</span><span class="op" id="3837279">(</span><span class="ident" id="3837280">w</span>&nbsp;<span class="ident" id="3837282">io</span><span class="op" id="3837284">.</span><span class="ident" id="3837285">Writer</span><span class="op" id="3837291">,</span>&nbsp;<span class="ident" id="3837293">exclude</span>&nbsp;<span class="keyword" id="3837301">map</span><span class="op" id="3837304">[</span><span class="builtintype" id="3837305">string</span><span class="op" id="3837311">]</span><span class="builtintype" id="3837312">bool</span><span class="op" id="3837316">)</span>&nbsp;<span class="builtintype" id="3837318">error</span>&nbsp;<span class="op" id="3837324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3837327">ws</span><span class="op" id="3837329">,</span>&nbsp;<span class="ident" id="3837331">ok</span>&nbsp;<span class="op" id="3837334">:=</span>&nbsp;<span class="ident" id="3837337">w</span><span class="op" id="3837338">.</span><span class="op" id="3837339">(</span><span class="ident" id="3837340">writeStringer</span><span class="op" id="3837353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3837356">if</span>&nbsp;<span class="op" id="3837359">!</span><span class="ident" id="3837360">ok</span>&nbsp;<span class="op" id="3837363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3837367">ws</span>&nbsp;<span class="op" id="3837370">=</span>&nbsp;<span class="ident" id="3837372">stringWriter</span><span class="op" id="3837384">{</span><span class="ident" id="3837385">w</span><span class="op" id="3837386">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3837389">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3837392">kvs</span><span class="op" id="3837395">,</span>&nbsp;<span class="ident" id="3837397">sorter</span>&nbsp;<span class="op" id="3837404">:=</span>&nbsp;<span class="ident" id="3837407">h</span><span class="op" id="3837408">.</span><span class="ident" id="3837409">sortedKeyValues</span><span class="op" id="3837424">(</span><span class="ident" id="3837425">exclude</span><span class="op" id="3837432">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3837435">for</span>&nbsp;<span class="ident" id="3837439">_</span><span class="op" id="3837440">,</span>&nbsp;<span class="ident" id="3837442">kv</span>&nbsp;<span class="op" id="3837445">:=</span>&nbsp;<span class="keyword" id="3837448">range</span>&nbsp;<span class="ident" id="3837454">kvs</span>&nbsp;<span class="op" id="3837458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3837462">for</span>&nbsp;<span class="ident" id="3837466">_</span><span class="op" id="3837467">,</span>&nbsp;<span class="ident" id="3837469">v</span>&nbsp;<span class="op" id="3837471">:=</span>&nbsp;<span class="keyword" id="3837474">range</span>&nbsp;<span class="ident" id="3837480">kv</span><span class="op" id="3837482">.</span><span class="ident" id="3837483">values</span>&nbsp;<span class="op" id="3837490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3837495">v</span>&nbsp;<span class="op" id="3837497">=</span>&nbsp;<span class="ident" id="3837499">headerNewlineToSpace</span><span class="op" id="3837519">.</span><span class="ident" id="3837520">Replace</span><span class="op" id="3837527">(</span><span class="ident" id="3837528">v</span><span class="op" id="3837529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3837534">v</span>&nbsp;<span class="op" id="3837536">=</span>&nbsp;<span class="ident" id="3837538">textproto</span><span class="op" id="3837547">.</span><span class="ident" id="3837548">TrimString</span><span class="op" id="3837558">(</span><span class="ident" id="3837559">v</span><span class="op" id="3837560">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3837565">for</span>&nbsp;<span class="ident" id="3837569">_</span><span class="op" id="3837570">,</span>&nbsp;<span class="ident" id="3837572">s</span>&nbsp;<span class="op" id="3837574">:=</span>&nbsp;<span class="keyword" id="3837577">range</span>&nbsp;<span class="op" id="3837583">[</span><span class="op" id="3837584">]</span><span class="builtintype" id="3837585">string</span><span class="op" id="3837591">{</span><span class="ident" id="3837592">kv</span><span class="op" id="3837594">.</span><span class="ident" id="3837595">key</span><span class="op" id="3837598">,</span>&nbsp;<span class="string" id="3837600">&#34;:&nbsp;&#34;</span><span class="op" id="3837604">,</span>&nbsp;<span class="ident" id="3837606">v</span><span class="op" id="3837607">,</span>&nbsp;<span class="string" id="3837609">&#34;\r\n&#34;</span><span class="op" id="3837615">}</span>&nbsp;<span class="op" id="3837617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3837623">if</span>&nbsp;<span class="ident" id="3837626">_</span><span class="op" id="3837627">,</span>&nbsp;<span class="ident" id="3837629">err</span>&nbsp;<span class="op" id="3837633">:=</span>&nbsp;<span class="ident" id="3837636">ws</span><span class="op" id="3837638">.</span><span class="ident" id="3837639">WriteString</span><span class="op" id="3837650">(</span><span class="ident" id="3837651">s</span><span class="op" id="3837652">)</span><span class="op" id="3837653">;</span>&nbsp;<span class="ident" id="3837655">err</span>&nbsp;<span class="op" id="3837659">!=</span>&nbsp;<span class="ident" id="3837662">nil</span>&nbsp;<span class="op" id="3837666">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3837673">return</span>&nbsp;<span class="ident" id="3837680">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3837688">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3837693">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3837697">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3837700">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3837703">headerSorterPool</span><span class="op" id="3837719">.</span><span class="ident" id="3837720">Put</span><span class="op" id="3837723">(</span><span class="ident" id="3837724">sorter</span><span class="op" id="3837730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3837733">return</span>&nbsp;<span class="ident" id="3837740">nil</span><br>
<span class="lineno"></span><span class="op" id="3837744">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="comment" id="3837747">//&nbsp;CanonicalHeaderKey&nbsp;returns&nbsp;the&nbsp;canonical&nbsp;format&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3837805">//&nbsp;header&nbsp;key&nbsp;s.&nbsp;&nbsp;The&nbsp;canonicalization&nbsp;converts&nbsp;the&nbsp;first</span><br>
<span class="lineno"></span><span class="comment" id="3837863">//&nbsp;letter&nbsp;and&nbsp;any&nbsp;letter&nbsp;following&nbsp;a&nbsp;hyphen&nbsp;to&nbsp;upper&nbsp;case;</span><br>
<span class="lineno"></span><span class="comment" id="3837922">//&nbsp;the&nbsp;rest&nbsp;are&nbsp;converted&nbsp;to&nbsp;lowercase.&nbsp;&nbsp;For&nbsp;example,&nbsp;the</span><br>
<span class="lineno">170</span><span class="comment" id="3837980">//&nbsp;canonical&nbsp;key&nbsp;for&nbsp;&#34;accept-encoding&#34;&nbsp;is&nbsp;&#34;Accept-Encoding&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="3838041">func</span>&nbsp;<span class="ident" id="3838046">CanonicalHeaderKey</span><span class="op" id="3838064">(</span><span class="ident" id="3838065">s</span>&nbsp;<span class="builtintype" id="3838067">string</span><span class="op" id="3838073">)</span>&nbsp;<span class="builtintype" id="3838075">string</span>&nbsp;<span class="op" id="3838082">{</span>&nbsp;<span class="keyword" id="3838084">return</span>&nbsp;<span class="ident" id="3838091">textproto</span><span class="op" id="3838100">.</span><span class="ident" id="3838101">CanonicalMIMEHeaderKey</span><span class="op" id="3838123">(</span><span class="ident" id="3838124">s</span><span class="op" id="3838125">)</span>&nbsp;<span class="op" id="3838127">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3838130">//&nbsp;hasToken&nbsp;reports&nbsp;whether&nbsp;token&nbsp;appears&nbsp;with&nbsp;v,&nbsp;ASCII</span><br>
<span class="lineno"></span><span class="comment" id="3838186">//&nbsp;case-insensitive,&nbsp;with&nbsp;space&nbsp;or&nbsp;comma&nbsp;boundaries.</span><br>
<span class="lineno">175</span><span class="comment" id="3838239">//&nbsp;token&nbsp;must&nbsp;be&nbsp;all&nbsp;lowercase.</span><br>
<span class="lineno"></span><span class="comment" id="3838271">//&nbsp;v&nbsp;may&nbsp;contain&nbsp;mixed&nbsp;cased.</span><br>
<span class="lineno"></span><span class="keyword" id="3838301">func</span>&nbsp;<span class="ident" id="3838306">hasToken</span><span class="op" id="3838314">(</span><span class="ident" id="3838315">v</span><span class="op" id="3838316">,</span>&nbsp;<span class="ident" id="3838318">token</span>&nbsp;<span class="builtintype" id="3838324">string</span><span class="op" id="3838330">)</span>&nbsp;<span class="builtintype" id="3838332">bool</span>&nbsp;<span class="op" id="3838337">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3838340">if</span>&nbsp;<span class="builtinfunc" id="3838343">len</span><span class="op" id="3838346">(</span><span class="ident" id="3838347">token</span><span class="op" id="3838352">)</span>&nbsp;<span class="op" id="3838354">&gt;</span>&nbsp;<span class="builtinfunc" id="3838356">len</span><span class="op" id="3838359">(</span><span class="ident" id="3838360">v</span><span class="op" id="3838361">)</span>&nbsp;<span class="op" id="3838363">||</span>&nbsp;<span class="ident" id="3838366">token</span>&nbsp;<span class="op" id="3838372">==</span>&nbsp;<span class="string" id="3838375">&#34;&#34;</span>&nbsp;<span class="op" id="3838378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3838382">return</span>&nbsp;<span class="builtintype" id="3838389">false</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3838396">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3838399">if</span>&nbsp;<span class="ident" id="3838402">v</span>&nbsp;<span class="op" id="3838404">==</span>&nbsp;<span class="ident" id="3838407">token</span>&nbsp;<span class="op" id="3838413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3838417">return</span>&nbsp;<span class="builtintype" id="3838424">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3838430">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3838433">for</span>&nbsp;<span class="ident" id="3838437">sp</span>&nbsp;<span class="op" id="3838440">:=</span>&nbsp;<span class="num" id="3838443">0</span><span class="op" id="3838444">;</span>&nbsp;<span class="ident" id="3838446">sp</span>&nbsp;<span class="op" id="3838449">&lt;=</span>&nbsp;<span class="builtinfunc" id="3838452">len</span><span class="op" id="3838455">(</span><span class="ident" id="3838456">v</span><span class="op" id="3838457">)</span><span class="op" id="3838458">-</span><span class="builtinfunc" id="3838459">len</span><span class="op" id="3838462">(</span><span class="ident" id="3838463">token</span><span class="op" id="3838468">)</span><span class="op" id="3838469">;</span>&nbsp;<span class="ident" id="3838471">sp</span><span class="op" id="3838473">++</span>&nbsp;<span class="op" id="3838476">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3838480">//&nbsp;Check&nbsp;that&nbsp;first&nbsp;character&nbsp;is&nbsp;good.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3838521">//&nbsp;The&nbsp;token&nbsp;is&nbsp;ASCII,&nbsp;so&nbsp;checking&nbsp;only&nbsp;a&nbsp;single&nbsp;byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3838577">//&nbsp;is&nbsp;sufficient.&nbsp;&nbsp;We&nbsp;skip&nbsp;this&nbsp;potential&nbsp;starting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3838630">//&nbsp;position&nbsp;if&nbsp;both&nbsp;the&nbsp;first&nbsp;byte&nbsp;and&nbsp;its&nbsp;potential</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3838685">//&nbsp;ASCII&nbsp;uppercase&nbsp;equivalent&nbsp;(b|0x20)&nbsp;don&#39;t&nbsp;match.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3838739">//&nbsp;False&nbsp;positives&nbsp;(&#39;^&#39;&nbsp;=&gt;&nbsp;&#39;~&#39;)&nbsp;are&nbsp;caught&nbsp;by&nbsp;EqualFold.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3838798">if</span>&nbsp;<span class="ident" id="3838801">b</span>&nbsp;<span class="op" id="3838803">:=</span>&nbsp;<span class="ident" id="3838806">v</span><span class="op" id="3838807">[</span><span class="ident" id="3838808">sp</span><span class="op" id="3838810">]</span><span class="op" id="3838811">;</span>&nbsp;<span class="ident" id="3838813">b</span>&nbsp;<span class="op" id="3838815">!=</span>&nbsp;<span class="ident" id="3838818">token</span><span class="op" id="3838823">[</span><span class="num" id="3838824">0</span><span class="op" id="3838825">]</span>&nbsp;<span class="op" id="3838827">&amp;&amp;</span>&nbsp;<span class="ident" id="3838830">b</span><span class="op" id="3838831">|</span><span class="num" id="3838832">0x20</span>&nbsp;<span class="op" id="3838837">!=</span>&nbsp;<span class="ident" id="3838840">token</span><span class="op" id="3838845">[</span><span class="num" id="3838846">0</span><span class="op" id="3838847">]</span>&nbsp;<span class="op" id="3838849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3838854">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3838865">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3838869">//&nbsp;Check&nbsp;that&nbsp;start&nbsp;pos&nbsp;is&nbsp;on&nbsp;a&nbsp;valid&nbsp;token&nbsp;boundary.</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3838925">if</span>&nbsp;<span class="ident" id="3838928">sp</span>&nbsp;<span class="op" id="3838931">&gt;</span>&nbsp;<span class="num" id="3838933">0</span>&nbsp;<span class="op" id="3838935">&amp;&amp;</span>&nbsp;<span class="op" id="3838938">!</span><span class="ident" id="3838939">isTokenBoundary</span><span class="op" id="3838954">(</span><span class="ident" id="3838955">v</span><span class="op" id="3838956">[</span><span class="ident" id="3838957">sp</span><span class="op" id="3838959">-</span><span class="num" id="3838960">1</span><span class="op" id="3838961">]</span><span class="op" id="3838962">)</span>&nbsp;<span class="op" id="3838964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3838969">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3838980">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3838984">//&nbsp;Check&nbsp;that&nbsp;end&nbsp;pos&nbsp;is&nbsp;on&nbsp;a&nbsp;valid&nbsp;token&nbsp;boundary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3839038">if</span>&nbsp;<span class="ident" id="3839041">endPos</span>&nbsp;<span class="op" id="3839048">:=</span>&nbsp;<span class="ident" id="3839051">sp</span>&nbsp;<span class="op" id="3839054">+</span>&nbsp;<span class="builtinfunc" id="3839056">len</span><span class="op" id="3839059">(</span><span class="ident" id="3839060">token</span><span class="op" id="3839065">)</span><span class="op" id="3839066">;</span>&nbsp;<span class="ident" id="3839068">endPos</span>&nbsp;<span class="op" id="3839075">!=</span>&nbsp;<span class="builtinfunc" id="3839078">len</span><span class="op" id="3839081">(</span><span class="ident" id="3839082">v</span><span class="op" id="3839083">)</span>&nbsp;<span class="op" id="3839085">&amp;&amp;</span>&nbsp;<span class="op" id="3839088">!</span><span class="ident" id="3839089">isTokenBoundary</span><span class="op" id="3839104">(</span><span class="ident" id="3839105">v</span><span class="op" id="3839106">[</span><span class="ident" id="3839107">endPos</span><span class="op" id="3839113">]</span><span class="op" id="3839114">)</span>&nbsp;<span class="op" id="3839116">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3839121">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3839132">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3839136">if</span>&nbsp;<span class="ident" id="3839139">strings</span><span class="op" id="3839146">.</span><span class="ident" id="3839147">EqualFold</span><span class="op" id="3839156">(</span><span class="ident" id="3839157">v</span><span class="op" id="3839158">[</span><span class="ident" id="3839159">sp</span><span class="op" id="3839161">:</span><span class="ident" id="3839162">sp</span><span class="op" id="3839164">+</span><span class="builtinfunc" id="3839165">len</span><span class="op" id="3839168">(</span><span class="ident" id="3839169">token</span><span class="op" id="3839174">)</span><span class="op" id="3839175">]</span><span class="op" id="3839176">,</span>&nbsp;<span class="ident" id="3839178">token</span><span class="op" id="3839183">)</span>&nbsp;<span class="op" id="3839185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3839190">return</span>&nbsp;<span class="builtintype" id="3839197">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3839204">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3839207">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3839210">return</span>&nbsp;<span class="builtintype" id="3839217">false</span><br>
<span class="lineno"></span><span class="op" id="3839223">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3839226">func</span>&nbsp;<span class="ident" id="3839231">isTokenBoundary</span><span class="op" id="3839246">(</span><span class="ident" id="3839247">b</span>&nbsp;<span class="builtintype" id="3839249">byte</span><span class="op" id="3839253">)</span>&nbsp;<span class="builtintype" id="3839255">bool</span>&nbsp;<span class="op" id="3839260">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3839263">return</span>&nbsp;<span class="ident" id="3839270">b</span>&nbsp;<span class="op" id="3839272">==</span>&nbsp;<span class="string" id="3839275">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="3839279">||</span>&nbsp;<span class="ident" id="3839282">b</span>&nbsp;<span class="op" id="3839284">==</span>&nbsp;<span class="string" id="3839287">&#39;,&#39;</span>&nbsp;<span class="op" id="3839291">||</span>&nbsp;<span class="ident" id="3839294">b</span>&nbsp;<span class="op" id="3839296">==</span>&nbsp;<span class="string" id="3839299">&#39;\t&#39;</span><br>
<span class="lineno"></span><span class="op" id="3839304">}</span>
</div>
</body>
</html>
