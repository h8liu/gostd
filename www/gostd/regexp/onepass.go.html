<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>regexp</h2>
<ul>
<li><a href="/gostd/regexp/all_test.go.html">all_test.go</a></li>
<li><a href="/gostd/regexp/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/regexp/exec.go.html">exec.go</a></li>
<li><a href="/gostd/regexp/exec2_test.go.html">exec2_test.go</a></li>
<li><a href="/gostd/regexp/exec_test.go.html">exec_test.go</a></li>
<li><a href="/gostd/regexp/find_test.go.html">find_test.go</a></li>
<li><a href="/gostd/regexp/onepass.go.html" class="current">onepass.go</a></li>
<li><a href="/gostd/regexp/onepass_test.go.html">onepass_test.go</a></li>
<li><a href="/gostd/regexp/regexp.go.html">regexp.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3402263">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3402319">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3402373">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3402424">package</span>&nbsp;<span class="ident" id="3402432">regexp</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3402440">import</span>&nbsp;<span class="op" id="3402447">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3402450">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3402459">&#34;regexp/syntax&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3402476">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3402484">&#34;unicode&#34;</span><br>
<span class="lineno"></span><span class="op" id="3402494">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3402497">//&nbsp;&#34;One-pass&#34;&nbsp;regexp&nbsp;execution.</span><br>
<span class="lineno">15</span><span class="comment" id="3402529">//&nbsp;Some&nbsp;regexps&nbsp;can&nbsp;be&nbsp;analyzed&nbsp;to&nbsp;determine&nbsp;that&nbsp;they&nbsp;never&nbsp;need</span><br>
<span class="lineno"></span><span class="comment" id="3402595">//&nbsp;backtracking:&nbsp;they&nbsp;are&nbsp;guaranteed&nbsp;to&nbsp;run&nbsp;in&nbsp;one&nbsp;pass&nbsp;over&nbsp;the&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="3402667">//&nbsp;without&nbsp;bothering&nbsp;to&nbsp;save&nbsp;all&nbsp;the&nbsp;usual&nbsp;NFA&nbsp;state.</span><br>
<span class="lineno"></span><span class="comment" id="3402721">//&nbsp;Detect&nbsp;those&nbsp;and&nbsp;execute&nbsp;them&nbsp;more&nbsp;quickly.</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span><span class="comment" id="3402769">//&nbsp;A&nbsp;onePassProg&nbsp;is&nbsp;a&nbsp;compiled&nbsp;one-pass&nbsp;regular&nbsp;expression&nbsp;program.</span><br>
<span class="lineno"></span><span class="comment" id="3402837">//&nbsp;It&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;syntax.Prog&nbsp;except&nbsp;for&nbsp;the&nbsp;use&nbsp;of&nbsp;onePassInst.</span><br>
<span class="lineno"></span><span class="keyword" id="3402905">type</span>&nbsp;<span class="ident" id="3402910">onePassProg</span>&nbsp;<span class="keyword" id="3402922">struct</span>&nbsp;<span class="op" id="3402929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3402932">Inst</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3402939">[</span><span class="op" id="3402940">]</span><span class="ident" id="3402941">onePassInst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3402954">Start</span>&nbsp;&nbsp;<span class="builtintype" id="3402961">int</span>&nbsp;<span class="comment" id="3402965">//&nbsp;index&nbsp;of&nbsp;start&nbsp;instruction</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3402996">NumCap</span>&nbsp;<span class="builtintype" id="3403003">int</span>&nbsp;<span class="comment" id="3403007">//&nbsp;number&nbsp;of&nbsp;InstCapture&nbsp;insts&nbsp;in&nbsp;re</span><br>
<span class="lineno"></span><span class="op" id="3403044">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3403047">//&nbsp;A&nbsp;onePassInst&nbsp;is&nbsp;a&nbsp;single&nbsp;instruction&nbsp;in&nbsp;a&nbsp;one-pass&nbsp;regular&nbsp;expression&nbsp;program.</span><br>
<span class="lineno"></span><span class="comment" id="3403130">//&nbsp;It&nbsp;is&nbsp;the&nbsp;same&nbsp;as&nbsp;syntax.Inst&nbsp;except&nbsp;for&nbsp;the&nbsp;new&nbsp;&#39;Next&#39;&nbsp;field.</span><br>
<span class="lineno">30</span><span class="keyword" id="3403196">type</span>&nbsp;<span class="ident" id="3403201">onePassInst</span>&nbsp;<span class="keyword" id="3403213">struct</span>&nbsp;<span class="op" id="3403220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3403223">syntax</span><span class="op" id="3403229">.</span><span class="ident" id="3403230">Inst</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3403236">Next</span>&nbsp;<span class="op" id="3403241">[</span><span class="op" id="3403242">]</span><span class="builtintype" id="3403243">uint32</span><br>
<span class="lineno"></span><span class="op" id="3403250">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="comment" id="3403253">//&nbsp;OnePassPrefix&nbsp;returns&nbsp;a&nbsp;literal&nbsp;string&nbsp;that&nbsp;all&nbsp;matches&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3403320">//&nbsp;regexp&nbsp;must&nbsp;start&nbsp;with.&nbsp;&nbsp;Complete&nbsp;is&nbsp;true&nbsp;if&nbsp;the&nbsp;prefix</span><br>
<span class="lineno"></span><span class="comment" id="3403379">//&nbsp;is&nbsp;the&nbsp;entire&nbsp;match.&nbsp;Pc&nbsp;is&nbsp;the&nbsp;index&nbsp;of&nbsp;the&nbsp;last&nbsp;rune&nbsp;instruction</span><br>
<span class="lineno"></span><span class="comment" id="3403448">//&nbsp;in&nbsp;the&nbsp;string.&nbsp;The&nbsp;OnePassPrefix&nbsp;skips&nbsp;over&nbsp;the&nbsp;mandatory</span><br>
<span class="lineno"></span><span class="comment" id="3403509">//&nbsp;EmptyBeginText</span><br>
<span class="lineno">40</span><span class="keyword" id="3403527">func</span>&nbsp;<span class="ident" id="3403532">onePassPrefix</span><span class="op" id="3403545">(</span><span class="ident" id="3403546">p</span>&nbsp;<span class="op" id="3403548">*</span><span class="ident" id="3403549">syntax</span><span class="op" id="3403555">.</span><span class="ident" id="3403556">Prog</span><span class="op" id="3403560">)</span>&nbsp;<span class="op" id="3403562">(</span><span class="ident" id="3403563">prefix</span>&nbsp;<span class="builtintype" id="3403570">string</span><span class="op" id="3403576">,</span>&nbsp;<span class="ident" id="3403578">complete</span>&nbsp;<span class="builtintype" id="3403587">bool</span><span class="op" id="3403591">,</span>&nbsp;<span class="ident" id="3403593">pc</span>&nbsp;<span class="builtintype" id="3403596">uint32</span><span class="op" id="3403602">)</span>&nbsp;<span class="op" id="3403604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3403607">i</span>&nbsp;<span class="op" id="3403609">:=</span>&nbsp;<span class="op" id="3403612">&amp;</span><span class="ident" id="3403613">p</span><span class="op" id="3403614">.</span><span class="ident" id="3403615">Inst</span><span class="op" id="3403619">[</span><span class="ident" id="3403620">p</span><span class="op" id="3403621">.</span><span class="ident" id="3403622">Start</span><span class="op" id="3403627">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3403630">if</span>&nbsp;<span class="ident" id="3403633">i</span><span class="op" id="3403634">.</span><span class="ident" id="3403635">Op</span>&nbsp;<span class="op" id="3403638">!=</span>&nbsp;<span class="ident" id="3403641">syntax</span><span class="op" id="3403647">.</span><span class="ident" id="3403648">InstEmptyWidth</span>&nbsp;<span class="op" id="3403663">||</span>&nbsp;<span class="op" id="3403666">(</span><span class="ident" id="3403667">syntax</span><span class="op" id="3403673">.</span><span class="ident" id="3403674">EmptyOp</span><span class="op" id="3403681">(</span><span class="ident" id="3403682">i</span><span class="op" id="3403683">.</span><span class="ident" id="3403684">Arg</span><span class="op" id="3403687">)</span><span class="op" id="3403688">)</span><span class="op" id="3403689">&amp;</span><span class="ident" id="3403690">syntax</span><span class="op" id="3403696">.</span><span class="ident" id="3403697">EmptyBeginText</span>&nbsp;<span class="op" id="3403712">==</span>&nbsp;<span class="num" id="3403715">0</span>&nbsp;<span class="op" id="3403717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3403721">return</span>&nbsp;<span class="string" id="3403728">&#34;&#34;</span><span class="op" id="3403730">,</span>&nbsp;<span class="ident" id="3403732">i</span><span class="op" id="3403733">.</span><span class="ident" id="3403734">Op</span>&nbsp;<span class="op" id="3403737">==</span>&nbsp;<span class="ident" id="3403740">syntax</span><span class="op" id="3403746">.</span><span class="ident" id="3403747">InstMatch</span><span class="op" id="3403756">,</span>&nbsp;<span class="builtintype" id="3403758">uint32</span><span class="op" id="3403764">(</span><span class="ident" id="3403765">p</span><span class="op" id="3403766">.</span><span class="ident" id="3403767">Start</span><span class="op" id="3403772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3403775">}</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3403778">pc</span>&nbsp;<span class="op" id="3403781">=</span>&nbsp;<span class="ident" id="3403783">i</span><span class="op" id="3403784">.</span><span class="ident" id="3403785">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3403790">i</span>&nbsp;<span class="op" id="3403792">=</span>&nbsp;<span class="op" id="3403794">&amp;</span><span class="ident" id="3403795">p</span><span class="op" id="3403796">.</span><span class="ident" id="3403797">Inst</span><span class="op" id="3403801">[</span><span class="ident" id="3403802">pc</span><span class="op" id="3403804">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3403807">for</span>&nbsp;<span class="ident" id="3403811">i</span><span class="op" id="3403812">.</span><span class="ident" id="3403813">Op</span>&nbsp;<span class="op" id="3403816">==</span>&nbsp;<span class="ident" id="3403819">syntax</span><span class="op" id="3403825">.</span><span class="ident" id="3403826">InstNop</span>&nbsp;<span class="op" id="3403834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3403838">pc</span>&nbsp;<span class="op" id="3403841">=</span>&nbsp;<span class="ident" id="3403843">i</span><span class="op" id="3403844">.</span><span class="ident" id="3403845">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3403851">i</span>&nbsp;<span class="op" id="3403853">=</span>&nbsp;<span class="op" id="3403855">&amp;</span><span class="ident" id="3403856">p</span><span class="op" id="3403857">.</span><span class="ident" id="3403858">Inst</span><span class="op" id="3403862">[</span><span class="ident" id="3403863">pc</span><span class="op" id="3403865">]</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3403868">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3403871">//&nbsp;Avoid&nbsp;allocation&nbsp;of&nbsp;buffer&nbsp;if&nbsp;prefix&nbsp;is&nbsp;empty.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3403922">if</span>&nbsp;<span class="ident" id="3403925">iop</span><span class="op" id="3403928">(</span><span class="ident" id="3403929">i</span><span class="op" id="3403930">)</span>&nbsp;<span class="op" id="3403932">!=</span>&nbsp;<span class="ident" id="3403935">syntax</span><span class="op" id="3403941">.</span><span class="ident" id="3403942">InstRune</span>&nbsp;<span class="op" id="3403951">||</span>&nbsp;<span class="builtinfunc" id="3403954">len</span><span class="op" id="3403957">(</span><span class="ident" id="3403958">i</span><span class="op" id="3403959">.</span><span class="ident" id="3403960">Rune</span><span class="op" id="3403964">)</span>&nbsp;<span class="op" id="3403966">!=</span>&nbsp;<span class="num" id="3403969">1</span>&nbsp;<span class="op" id="3403971">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3403975">return</span>&nbsp;<span class="string" id="3403982">&#34;&#34;</span><span class="op" id="3403984">,</span>&nbsp;<span class="ident" id="3403986">i</span><span class="op" id="3403987">.</span><span class="ident" id="3403988">Op</span>&nbsp;<span class="op" id="3403991">==</span>&nbsp;<span class="ident" id="3403994">syntax</span><span class="op" id="3404000">.</span><span class="ident" id="3404001">InstMatch</span><span class="op" id="3404010">,</span>&nbsp;<span class="builtintype" id="3404012">uint32</span><span class="op" id="3404018">(</span><span class="ident" id="3404019">p</span><span class="op" id="3404020">.</span><span class="ident" id="3404021">Start</span><span class="op" id="3404026">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3404029">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3404033">//&nbsp;Have&nbsp;prefix;&nbsp;gather&nbsp;characters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3404069">var</span>&nbsp;<span class="ident" id="3404073">buf</span>&nbsp;<span class="ident" id="3404077">bytes</span><span class="op" id="3404082">.</span><span class="ident" id="3404083">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3404091">for</span>&nbsp;<span class="ident" id="3404095">iop</span><span class="op" id="3404098">(</span><span class="ident" id="3404099">i</span><span class="op" id="3404100">)</span>&nbsp;<span class="op" id="3404102">==</span>&nbsp;<span class="ident" id="3404105">syntax</span><span class="op" id="3404111">.</span><span class="ident" id="3404112">InstRune</span>&nbsp;<span class="op" id="3404121">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3404124">len</span><span class="op" id="3404127">(</span><span class="ident" id="3404128">i</span><span class="op" id="3404129">.</span><span class="ident" id="3404130">Rune</span><span class="op" id="3404134">)</span>&nbsp;<span class="op" id="3404136">==</span>&nbsp;<span class="num" id="3404139">1</span>&nbsp;<span class="op" id="3404141">&amp;&amp;</span>&nbsp;<span class="ident" id="3404144">syntax</span><span class="op" id="3404150">.</span><span class="ident" id="3404151">Flags</span><span class="op" id="3404156">(</span><span class="ident" id="3404157">i</span><span class="op" id="3404158">.</span><span class="ident" id="3404159">Arg</span><span class="op" id="3404162">)</span><span class="op" id="3404163">&amp;</span><span class="ident" id="3404164">syntax</span><span class="op" id="3404170">.</span><span class="ident" id="3404171">FoldCase</span>&nbsp;<span class="op" id="3404180">==</span>&nbsp;<span class="num" id="3404183">0</span>&nbsp;<span class="op" id="3404185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3404189">buf</span><span class="op" id="3404192">.</span><span class="ident" id="3404193">WriteRune</span><span class="op" id="3404202">(</span><span class="ident" id="3404203">i</span><span class="op" id="3404204">.</span><span class="ident" id="3404205">Rune</span><span class="op" id="3404209">[</span><span class="num" id="3404210">0</span><span class="op" id="3404211">]</span><span class="op" id="3404212">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3404216">pc</span><span class="op" id="3404218">,</span>&nbsp;<span class="ident" id="3404220">i</span>&nbsp;<span class="op" id="3404222">=</span>&nbsp;<span class="ident" id="3404224">i</span><span class="op" id="3404225">.</span><span class="ident" id="3404226">Out</span><span class="op" id="3404229">,</span>&nbsp;<span class="op" id="3404231">&amp;</span><span class="ident" id="3404232">p</span><span class="op" id="3404233">.</span><span class="ident" id="3404234">Inst</span><span class="op" id="3404238">[</span><span class="ident" id="3404239">i</span><span class="op" id="3404240">.</span><span class="ident" id="3404241">Out</span><span class="op" id="3404244">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3404247">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3404250">return</span>&nbsp;<span class="ident" id="3404257">buf</span><span class="op" id="3404260">.</span><span class="ident" id="3404261">String</span><span class="op" id="3404267">(</span><span class="op" id="3404268">)</span><span class="op" id="3404269">,</span>&nbsp;<span class="ident" id="3404271">i</span><span class="op" id="3404272">.</span><span class="ident" id="3404273">Op</span>&nbsp;<span class="op" id="3404276">==</span>&nbsp;<span class="ident" id="3404279">syntax</span><span class="op" id="3404285">.</span><span class="ident" id="3404286">InstEmptyWidth</span>&nbsp;<span class="op" id="3404301">&amp;&amp;</span>&nbsp;<span class="op" id="3404304">(</span><span class="ident" id="3404305">syntax</span><span class="op" id="3404311">.</span><span class="ident" id="3404312">EmptyOp</span><span class="op" id="3404319">(</span><span class="ident" id="3404320">i</span><span class="op" id="3404321">.</span><span class="ident" id="3404322">Arg</span><span class="op" id="3404325">)</span><span class="op" id="3404326">)</span><span class="op" id="3404327">&amp;</span><span class="ident" id="3404328">syntax</span><span class="op" id="3404334">.</span><span class="ident" id="3404335">EmptyBeginText</span>&nbsp;<span class="op" id="3404350">!=</span>&nbsp;<span class="num" id="3404353">0</span><span class="op" id="3404354">,</span>&nbsp;<span class="ident" id="3404356">pc</span><br>
<span class="lineno"></span><span class="op" id="3404359">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="3404362">//&nbsp;OnePassNext&nbsp;selects&nbsp;the&nbsp;next&nbsp;actionable&nbsp;state&nbsp;of&nbsp;the&nbsp;prog,&nbsp;based&nbsp;on&nbsp;the&nbsp;input&nbsp;character.</span><br>
<span class="lineno"></span><span class="comment" id="3404454">//&nbsp;It&nbsp;should&nbsp;only&nbsp;be&nbsp;called&nbsp;when&nbsp;i.Op&nbsp;==&nbsp;InstAlt&nbsp;or&nbsp;InstAltMatch,&nbsp;and&nbsp;from&nbsp;the&nbsp;one-pass&nbsp;machine.</span><br>
<span class="lineno"></span><span class="comment" id="3404551">//&nbsp;One&nbsp;of&nbsp;the&nbsp;alternates&nbsp;may&nbsp;ultimately&nbsp;lead&nbsp;without&nbsp;input&nbsp;to&nbsp;end&nbsp;of&nbsp;line.&nbsp;If&nbsp;the&nbsp;instruction</span><br>
<span class="lineno"></span><span class="comment" id="3404645">//&nbsp;is&nbsp;InstAltMatch&nbsp;the&nbsp;path&nbsp;to&nbsp;the&nbsp;InstMatch&nbsp;is&nbsp;in&nbsp;i.Out,&nbsp;the&nbsp;normal&nbsp;node&nbsp;in&nbsp;i.Next.</span><br>
<span class="lineno"></span><span class="keyword" id="3404730">func</span>&nbsp;<span class="ident" id="3404735">onePassNext</span><span class="op" id="3404746">(</span><span class="ident" id="3404747">i</span>&nbsp;<span class="op" id="3404749">*</span><span class="ident" id="3404750">onePassInst</span><span class="op" id="3404761">,</span>&nbsp;<span class="ident" id="3404763">r</span>&nbsp;<span class="builtintype" id="3404765">rune</span><span class="op" id="3404769">)</span>&nbsp;<span class="builtintype" id="3404771">uint32</span>&nbsp;<span class="op" id="3404778">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3404781">next</span>&nbsp;<span class="op" id="3404786">:=</span>&nbsp;<span class="ident" id="3404789">i</span><span class="op" id="3404790">.</span><span class="ident" id="3404791">MatchRunePos</span><span class="op" id="3404803">(</span><span class="ident" id="3404804">r</span><span class="op" id="3404805">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3404808">if</span>&nbsp;<span class="ident" id="3404811">next</span>&nbsp;<span class="op" id="3404816">&gt;=</span>&nbsp;<span class="num" id="3404819">0</span>&nbsp;<span class="op" id="3404821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3404825">return</span>&nbsp;<span class="ident" id="3404832">i</span><span class="op" id="3404833">.</span><span class="ident" id="3404834">Next</span><span class="op" id="3404838">[</span><span class="ident" id="3404839">next</span><span class="op" id="3404843">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3404846">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3404849">if</span>&nbsp;<span class="ident" id="3404852">i</span><span class="op" id="3404853">.</span><span class="ident" id="3404854">Op</span>&nbsp;<span class="op" id="3404857">==</span>&nbsp;<span class="ident" id="3404860">syntax</span><span class="op" id="3404866">.</span><span class="ident" id="3404867">InstAltMatch</span>&nbsp;<span class="op" id="3404880">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3404884">return</span>&nbsp;<span class="ident" id="3404891">i</span><span class="op" id="3404892">.</span><span class="ident" id="3404893">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3404898">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3404901">return</span>&nbsp;<span class="num" id="3404908">0</span><br>
<span class="lineno"></span><span class="op" id="3404910">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="keyword" id="3404913">func</span>&nbsp;<span class="ident" id="3404918">iop</span><span class="op" id="3404921">(</span><span class="ident" id="3404922">i</span>&nbsp;<span class="op" id="3404924">*</span><span class="ident" id="3404925">syntax</span><span class="op" id="3404931">.</span><span class="ident" id="3404932">Inst</span><span class="op" id="3404936">)</span>&nbsp;<span class="ident" id="3404938">syntax</span><span class="op" id="3404944">.</span><span class="ident" id="3404945">InstOp</span>&nbsp;<span class="op" id="3404952">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3404955">op</span>&nbsp;<span class="op" id="3404958">:=</span>&nbsp;<span class="ident" id="3404961">i</span><span class="op" id="3404962">.</span><span class="ident" id="3404963">Op</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3404967">switch</span>&nbsp;<span class="ident" id="3404974">op</span>&nbsp;<span class="op" id="3404977">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3404980">case</span>&nbsp;<span class="ident" id="3404985">syntax</span><span class="op" id="3404991">.</span><span class="ident" id="3404992">InstRune1</span><span class="op" id="3405001">,</span>&nbsp;<span class="ident" id="3405003">syntax</span><span class="op" id="3405009">.</span><span class="ident" id="3405010">InstRuneAny</span><span class="op" id="3405021">,</span>&nbsp;<span class="ident" id="3405023">syntax</span><span class="op" id="3405029">.</span><span class="ident" id="3405030">InstRuneAnyNotNL</span><span class="op" id="3405046">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3405050">op</span>&nbsp;<span class="op" id="3405053">=</span>&nbsp;<span class="ident" id="3405055">syntax</span><span class="op" id="3405061">.</span><span class="ident" id="3405062">InstRune</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3405072">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3405075">return</span>&nbsp;<span class="ident" id="3405082">op</span><br>
<span class="lineno"></span><span class="op" id="3405085">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3405088">//&nbsp;Sparse&nbsp;Array&nbsp;implementation&nbsp;is&nbsp;used&nbsp;as&nbsp;a&nbsp;queueOnePass.</span><br>
<span class="lineno">90</span><span class="keyword" id="3405146">type</span>&nbsp;<span class="ident" id="3405151">queueOnePass</span>&nbsp;<span class="keyword" id="3405164">struct</span>&nbsp;<span class="op" id="3405171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3405174">sparse</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3405190">[</span><span class="op" id="3405191">]</span><span class="builtintype" id="3405192">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3405200">dense</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3405216">[</span><span class="op" id="3405217">]</span><span class="builtintype" id="3405218">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3405226">size</span><span class="op" id="3405230">,</span>&nbsp;<span class="ident" id="3405232">nextIndex</span>&nbsp;<span class="builtintype" id="3405242">uint32</span><br>
<span class="lineno"></span><span class="op" id="3405249">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="keyword" id="3405252">func</span>&nbsp;<span class="op" id="3405257">(</span><span class="ident" id="3405258">q</span>&nbsp;<span class="op" id="3405260">*</span><span class="ident" id="3405261">queueOnePass</span><span class="op" id="3405273">)</span>&nbsp;<span class="ident" id="3405275">empty</span><span class="op" id="3405280">(</span><span class="op" id="3405281">)</span>&nbsp;<span class="builtintype" id="3405283">bool</span>&nbsp;<span class="op" id="3405288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3405291">return</span>&nbsp;<span class="ident" id="3405298">q</span><span class="op" id="3405299">.</span><span class="ident" id="3405300">nextIndex</span>&nbsp;<span class="op" id="3405310">&gt;=</span>&nbsp;<span class="ident" id="3405313">q</span><span class="op" id="3405314">.</span><span class="ident" id="3405315">size</span><br>
<span class="lineno"></span><span class="op" id="3405320">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="keyword" id="3405323">func</span>&nbsp;<span class="op" id="3405328">(</span><span class="ident" id="3405329">q</span>&nbsp;<span class="op" id="3405331">*</span><span class="ident" id="3405332">queueOnePass</span><span class="op" id="3405344">)</span>&nbsp;<span class="ident" id="3405346">next</span><span class="op" id="3405350">(</span><span class="op" id="3405351">)</span>&nbsp;<span class="op" id="3405353">(</span><span class="ident" id="3405354">n</span>&nbsp;<span class="builtintype" id="3405356">uint32</span><span class="op" id="3405362">)</span>&nbsp;<span class="op" id="3405364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3405367">n</span>&nbsp;<span class="op" id="3405369">=</span>&nbsp;<span class="ident" id="3405371">q</span><span class="op" id="3405372">.</span><span class="ident" id="3405373">dense</span><span class="op" id="3405378">[</span><span class="ident" id="3405379">q</span><span class="op" id="3405380">.</span><span class="ident" id="3405381">nextIndex</span><span class="op" id="3405390">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3405393">q</span><span class="op" id="3405394">.</span><span class="ident" id="3405395">nextIndex</span><span class="op" id="3405404">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3405408">return</span><br>
<span class="lineno"></span><span class="op" id="3405415">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="keyword" id="3405418">func</span>&nbsp;<span class="op" id="3405423">(</span><span class="ident" id="3405424">q</span>&nbsp;<span class="op" id="3405426">*</span><span class="ident" id="3405427">queueOnePass</span><span class="op" id="3405439">)</span>&nbsp;<span class="ident" id="3405441">clear</span><span class="op" id="3405446">(</span><span class="op" id="3405447">)</span>&nbsp;<span class="op" id="3405449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3405452">q</span><span class="op" id="3405453">.</span><span class="ident" id="3405454">size</span>&nbsp;<span class="op" id="3405459">=</span>&nbsp;<span class="num" id="3405461">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3405464">q</span><span class="op" id="3405465">.</span><span class="ident" id="3405466">nextIndex</span>&nbsp;<span class="op" id="3405476">=</span>&nbsp;<span class="num" id="3405478">0</span><br>
<span class="lineno"></span><span class="op" id="3405480">}</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span><span class="keyword" id="3405483">func</span>&nbsp;<span class="op" id="3405488">(</span><span class="ident" id="3405489">q</span>&nbsp;<span class="op" id="3405491">*</span><span class="ident" id="3405492">queueOnePass</span><span class="op" id="3405504">)</span>&nbsp;<span class="ident" id="3405506">reset</span><span class="op" id="3405511">(</span><span class="op" id="3405512">)</span>&nbsp;<span class="op" id="3405514">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3405517">q</span><span class="op" id="3405518">.</span><span class="ident" id="3405519">nextIndex</span>&nbsp;<span class="op" id="3405529">=</span>&nbsp;<span class="num" id="3405531">0</span><br>
<span class="lineno"></span><span class="op" id="3405533">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="keyword" id="3405536">func</span>&nbsp;<span class="op" id="3405541">(</span><span class="ident" id="3405542">q</span>&nbsp;<span class="op" id="3405544">*</span><span class="ident" id="3405545">queueOnePass</span><span class="op" id="3405557">)</span>&nbsp;<span class="ident" id="3405559">contains</span><span class="op" id="3405567">(</span><span class="ident" id="3405568">u</span>&nbsp;<span class="builtintype" id="3405570">uint32</span><span class="op" id="3405576">)</span>&nbsp;<span class="builtintype" id="3405578">bool</span>&nbsp;<span class="op" id="3405583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3405586">if</span>&nbsp;<span class="ident" id="3405589">u</span>&nbsp;<span class="op" id="3405591">&gt;=</span>&nbsp;<span class="builtintype" id="3405594">uint32</span><span class="op" id="3405600">(</span><span class="builtinfunc" id="3405601">len</span><span class="op" id="3405604">(</span><span class="ident" id="3405605">q</span><span class="op" id="3405606">.</span><span class="ident" id="3405607">sparse</span><span class="op" id="3405613">)</span><span class="op" id="3405614">)</span>&nbsp;<span class="op" id="3405616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3405620">return</span>&nbsp;<span class="builtintype" id="3405627">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3405634">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3405637">return</span>&nbsp;<span class="ident" id="3405644">q</span><span class="op" id="3405645">.</span><span class="ident" id="3405646">sparse</span><span class="op" id="3405652">[</span><span class="ident" id="3405653">u</span><span class="op" id="3405654">]</span>&nbsp;<span class="op" id="3405656">&lt;</span>&nbsp;<span class="ident" id="3405658">q</span><span class="op" id="3405659">.</span><span class="ident" id="3405660">size</span>&nbsp;<span class="op" id="3405665">&amp;&amp;</span>&nbsp;<span class="ident" id="3405668">q</span><span class="op" id="3405669">.</span><span class="ident" id="3405670">dense</span><span class="op" id="3405675">[</span><span class="ident" id="3405676">q</span><span class="op" id="3405677">.</span><span class="ident" id="3405678">sparse</span><span class="op" id="3405684">[</span><span class="ident" id="3405685">u</span><span class="op" id="3405686">]</span><span class="op" id="3405687">]</span>&nbsp;<span class="op" id="3405689">==</span>&nbsp;<span class="ident" id="3405692">u</span><br>
<span class="lineno">120</span><span class="op" id="3405694">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3405697">func</span>&nbsp;<span class="op" id="3405702">(</span><span class="ident" id="3405703">q</span>&nbsp;<span class="op" id="3405705">*</span><span class="ident" id="3405706">queueOnePass</span><span class="op" id="3405718">)</span>&nbsp;<span class="ident" id="3405720">insert</span><span class="op" id="3405726">(</span><span class="ident" id="3405727">u</span>&nbsp;<span class="builtintype" id="3405729">uint32</span><span class="op" id="3405735">)</span>&nbsp;<span class="op" id="3405737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3405740">if</span>&nbsp;<span class="op" id="3405743">!</span><span class="ident" id="3405744">q</span><span class="op" id="3405745">.</span><span class="ident" id="3405746">contains</span><span class="op" id="3405754">(</span><span class="ident" id="3405755">u</span><span class="op" id="3405756">)</span>&nbsp;<span class="op" id="3405758">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3405762">q</span><span class="op" id="3405763">.</span><span class="ident" id="3405764">insertNew</span><span class="op" id="3405773">(</span><span class="ident" id="3405774">u</span><span class="op" id="3405775">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3405778">}</span><br>
<span class="lineno"></span><span class="op" id="3405780">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3405783">func</span>&nbsp;<span class="op" id="3405788">(</span><span class="ident" id="3405789">q</span>&nbsp;<span class="op" id="3405791">*</span><span class="ident" id="3405792">queueOnePass</span><span class="op" id="3405804">)</span>&nbsp;<span class="ident" id="3405806">insertNew</span><span class="op" id="3405815">(</span><span class="ident" id="3405816">u</span>&nbsp;<span class="builtintype" id="3405818">uint32</span><span class="op" id="3405824">)</span>&nbsp;<span class="op" id="3405826">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3405829">if</span>&nbsp;<span class="ident" id="3405832">u</span>&nbsp;<span class="op" id="3405834">&gt;=</span>&nbsp;<span class="builtintype" id="3405837">uint32</span><span class="op" id="3405843">(</span><span class="builtinfunc" id="3405844">len</span><span class="op" id="3405847">(</span><span class="ident" id="3405848">q</span><span class="op" id="3405849">.</span><span class="ident" id="3405850">sparse</span><span class="op" id="3405856">)</span><span class="op" id="3405857">)</span>&nbsp;<span class="op" id="3405859">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3405863">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3405871">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3405874">q</span><span class="op" id="3405875">.</span><span class="ident" id="3405876">sparse</span><span class="op" id="3405882">[</span><span class="ident" id="3405883">u</span><span class="op" id="3405884">]</span>&nbsp;<span class="op" id="3405886">=</span>&nbsp;<span class="ident" id="3405888">q</span><span class="op" id="3405889">.</span><span class="ident" id="3405890">size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3405896">q</span><span class="op" id="3405897">.</span><span class="ident" id="3405898">dense</span><span class="op" id="3405903">[</span><span class="ident" id="3405904">q</span><span class="op" id="3405905">.</span><span class="ident" id="3405906">size</span><span class="op" id="3405910">]</span>&nbsp;<span class="op" id="3405912">=</span>&nbsp;<span class="ident" id="3405914">u</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3405917">q</span><span class="op" id="3405918">.</span><span class="ident" id="3405919">size</span><span class="op" id="3405923">++</span><br>
<span class="lineno">135</span><span class="op" id="3405926">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3405929">func</span>&nbsp;<span class="ident" id="3405934">newQueue</span><span class="op" id="3405942">(</span><span class="ident" id="3405943">size</span>&nbsp;<span class="builtintype" id="3405948">int</span><span class="op" id="3405951">)</span>&nbsp;<span class="op" id="3405953">(</span><span class="ident" id="3405954">q</span>&nbsp;<span class="op" id="3405956">*</span><span class="ident" id="3405957">queueOnePass</span><span class="op" id="3405969">)</span>&nbsp;<span class="op" id="3405971">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3405974">return</span>&nbsp;<span class="op" id="3405981">&amp;</span><span class="ident" id="3405982">queueOnePass</span><span class="op" id="3405994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3405998">sparse</span><span class="op" id="3406004">:</span>&nbsp;<span class="builtinfunc" id="3406006">make</span><span class="op" id="3406010">(</span><span class="op" id="3406011">[</span><span class="op" id="3406012">]</span><span class="builtintype" id="3406013">uint32</span><span class="op" id="3406019">,</span>&nbsp;<span class="ident" id="3406021">size</span><span class="op" id="3406025">)</span><span class="op" id="3406026">,</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3406030">dense</span><span class="op" id="3406035">:</span>&nbsp;&nbsp;<span class="builtinfunc" id="3406038">make</span><span class="op" id="3406042">(</span><span class="op" id="3406043">[</span><span class="op" id="3406044">]</span><span class="builtintype" id="3406045">uint32</span><span class="op" id="3406051">,</span>&nbsp;<span class="ident" id="3406053">size</span><span class="op" id="3406057">)</span><span class="op" id="3406058">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3406061">}</span><br>
<span class="lineno"></span><span class="op" id="3406063">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3406066">//&nbsp;mergeRuneSets&nbsp;merges&nbsp;two&nbsp;non-intersecting&nbsp;runesets,&nbsp;and&nbsp;returns&nbsp;the&nbsp;merged&nbsp;result,</span><br>
<span class="lineno">145</span><span class="comment" id="3406152">//&nbsp;and&nbsp;a&nbsp;NextIp&nbsp;array.&nbsp;The&nbsp;idea&nbsp;is&nbsp;that&nbsp;if&nbsp;a&nbsp;rune&nbsp;matches&nbsp;the&nbsp;OnePassRunes&nbsp;at&nbsp;index</span><br>
<span class="lineno"></span><span class="comment" id="3406236">//&nbsp;i,&nbsp;NextIp[i/2]&nbsp;is&nbsp;the&nbsp;target.&nbsp;If&nbsp;the&nbsp;input&nbsp;sets&nbsp;intersect,&nbsp;an&nbsp;empty&nbsp;runeset&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3406321">//&nbsp;NextIp&nbsp;array&nbsp;with&nbsp;the&nbsp;single&nbsp;element&nbsp;mergeFailed&nbsp;is&nbsp;returned.</span><br>
<span class="lineno"></span><span class="comment" id="3406386">//&nbsp;The&nbsp;code&nbsp;assumes&nbsp;that&nbsp;both&nbsp;inputs&nbsp;contain&nbsp;ordered&nbsp;and&nbsp;non-intersecting&nbsp;rune&nbsp;pairs.</span><br>
<span class="lineno"></span><span class="keyword" id="3406472">const</span>&nbsp;<span class="ident" id="3406478">mergeFailed</span>&nbsp;<span class="op" id="3406490">=</span>&nbsp;<span class="builtintype" id="3406492">uint32</span><span class="op" id="3406498">(</span><span class="num" id="3406499">0xffffffff</span><span class="op" id="3406509">)</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span><span class="keyword" id="3406512">var</span>&nbsp;<span class="op" id="3406516">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3406519">noRune</span>&nbsp;<span class="op" id="3406526">=</span>&nbsp;<span class="op" id="3406528">[</span><span class="op" id="3406529">]</span><span class="builtintype" id="3406530">rune</span><span class="op" id="3406534">{</span><span class="op" id="3406535">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3406538">noNext</span>&nbsp;<span class="op" id="3406545">=</span>&nbsp;<span class="op" id="3406547">[</span><span class="op" id="3406548">]</span><span class="builtintype" id="3406549">uint32</span><span class="op" id="3406555">{</span><span class="ident" id="3406556">mergeFailed</span><span class="op" id="3406567">}</span><br>
<span class="lineno"></span><span class="op" id="3406569">)</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="keyword" id="3406572">func</span>&nbsp;<span class="ident" id="3406577">mergeRuneSets</span><span class="op" id="3406590">(</span><span class="ident" id="3406591">leftRunes</span><span class="op" id="3406600">,</span>&nbsp;<span class="ident" id="3406602">rightRunes</span>&nbsp;<span class="op" id="3406613">*</span><span class="op" id="3406614">[</span><span class="op" id="3406615">]</span><span class="builtintype" id="3406616">rune</span><span class="op" id="3406620">,</span>&nbsp;<span class="ident" id="3406622">leftPC</span><span class="op" id="3406628">,</span>&nbsp;<span class="ident" id="3406630">rightPC</span>&nbsp;<span class="builtintype" id="3406638">uint32</span><span class="op" id="3406644">)</span>&nbsp;<span class="op" id="3406646">(</span><span class="op" id="3406647">[</span><span class="op" id="3406648">]</span><span class="builtintype" id="3406649">rune</span><span class="op" id="3406653">,</span>&nbsp;<span class="op" id="3406655">[</span><span class="op" id="3406656">]</span><span class="builtintype" id="3406657">uint32</span><span class="op" id="3406663">)</span>&nbsp;<span class="op" id="3406665">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3406668">leftLen</span>&nbsp;<span class="op" id="3406676">:=</span>&nbsp;<span class="builtinfunc" id="3406679">len</span><span class="op" id="3406682">(</span><span class="op" id="3406683">*</span><span class="ident" id="3406684">leftRunes</span><span class="op" id="3406693">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3406696">rightLen</span>&nbsp;<span class="op" id="3406705">:=</span>&nbsp;<span class="builtinfunc" id="3406708">len</span><span class="op" id="3406711">(</span><span class="op" id="3406712">*</span><span class="ident" id="3406713">rightRunes</span><span class="op" id="3406723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3406726">if</span>&nbsp;<span class="ident" id="3406729">leftLen</span><span class="op" id="3406736">&amp;</span><span class="num" id="3406737">0x1</span>&nbsp;<span class="op" id="3406741">!=</span>&nbsp;<span class="num" id="3406744">0</span>&nbsp;<span class="op" id="3406746">||</span>&nbsp;<span class="ident" id="3406749">rightLen</span><span class="op" id="3406757">&amp;</span><span class="num" id="3406758">0x1</span>&nbsp;<span class="op" id="3406762">!=</span>&nbsp;<span class="num" id="3406765">0</span>&nbsp;<span class="op" id="3406767">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3406771">panic</span><span class="op" id="3406776">(</span><span class="string" id="3406777">&#34;mergeRuneSets&nbsp;odd&nbsp;length&nbsp;[]rune&#34;</span><span class="op" id="3406810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3406813">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3406816">var</span>&nbsp;<span class="op" id="3406820">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3406824">lx</span><span class="op" id="3406826">,</span>&nbsp;<span class="ident" id="3406828">rx</span>&nbsp;<span class="builtintype" id="3406831">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3406836">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3406839">merged</span>&nbsp;<span class="op" id="3406846">:=</span>&nbsp;<span class="builtinfunc" id="3406849">make</span><span class="op" id="3406853">(</span><span class="op" id="3406854">[</span><span class="op" id="3406855">]</span><span class="builtintype" id="3406856">rune</span><span class="op" id="3406860">,</span>&nbsp;<span class="num" id="3406862">0</span><span class="op" id="3406863">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3406866">next</span>&nbsp;<span class="op" id="3406871">:=</span>&nbsp;<span class="builtinfunc" id="3406874">make</span><span class="op" id="3406878">(</span><span class="op" id="3406879">[</span><span class="op" id="3406880">]</span><span class="builtintype" id="3406881">uint32</span><span class="op" id="3406887">,</span>&nbsp;<span class="num" id="3406889">0</span><span class="op" id="3406890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3406893">ok</span>&nbsp;<span class="op" id="3406896">:=</span>&nbsp;<span class="builtintype" id="3406899">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3406905">defer</span>&nbsp;<span class="keyword" id="3406911">func</span><span class="op" id="3406915">(</span><span class="op" id="3406916">)</span>&nbsp;<span class="op" id="3406918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3406922">if</span>&nbsp;<span class="op" id="3406925">!</span><span class="ident" id="3406926">ok</span>&nbsp;<span class="op" id="3406929">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3406934">merged</span>&nbsp;<span class="op" id="3406941">=</span>&nbsp;<span class="builtintype" id="3406943">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3406950">next</span>&nbsp;<span class="op" id="3406955">=</span>&nbsp;<span class="builtintype" id="3406957">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3406963">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3406966">}</span><span class="op" id="3406967">(</span><span class="op" id="3406968">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3406972">ix</span>&nbsp;<span class="op" id="3406975">:=</span>&nbsp;<span class="op" id="3406978">-</span><span class="num" id="3406979">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3406982">extend</span>&nbsp;<span class="op" id="3406989">:=</span>&nbsp;<span class="keyword" id="3406992">func</span><span class="op" id="3406996">(</span><span class="ident" id="3406997">newLow</span>&nbsp;<span class="op" id="3407004">*</span><span class="builtintype" id="3407005">int</span><span class="op" id="3407008">,</span>&nbsp;<span class="ident" id="3407010">newArray</span>&nbsp;<span class="op" id="3407019">*</span><span class="op" id="3407020">[</span><span class="op" id="3407021">]</span><span class="builtintype" id="3407022">rune</span><span class="op" id="3407026">,</span>&nbsp;<span class="ident" id="3407028">pc</span>&nbsp;<span class="builtintype" id="3407031">uint32</span><span class="op" id="3407037">)</span>&nbsp;<span class="builtintype" id="3407039">bool</span>&nbsp;<span class="op" id="3407044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3407048">if</span>&nbsp;<span class="ident" id="3407051">ix</span>&nbsp;<span class="op" id="3407054">&gt;</span>&nbsp;<span class="num" id="3407056">0</span>&nbsp;<span class="op" id="3407058">&amp;&amp;</span>&nbsp;<span class="op" id="3407061">(</span><span class="op" id="3407062">*</span><span class="ident" id="3407063">newArray</span><span class="op" id="3407071">)</span><span class="op" id="3407072">[</span><span class="op" id="3407073">*</span><span class="ident" id="3407074">newLow</span><span class="op" id="3407080">]</span>&nbsp;<span class="op" id="3407082">&lt;=</span>&nbsp;<span class="ident" id="3407085">merged</span><span class="op" id="3407091">[</span><span class="ident" id="3407092">ix</span><span class="op" id="3407094">]</span>&nbsp;<span class="op" id="3407096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3407101">return</span>&nbsp;<span class="builtintype" id="3407108">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3407116">}</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3407120">merged</span>&nbsp;<span class="op" id="3407127">=</span>&nbsp;<span class="builtinfunc" id="3407129">append</span><span class="op" id="3407135">(</span><span class="ident" id="3407136">merged</span><span class="op" id="3407142">,</span>&nbsp;<span class="op" id="3407144">(</span><span class="op" id="3407145">*</span><span class="ident" id="3407146">newArray</span><span class="op" id="3407154">)</span><span class="op" id="3407155">[</span><span class="op" id="3407156">*</span><span class="ident" id="3407157">newLow</span><span class="op" id="3407163">]</span><span class="op" id="3407164">,</span>&nbsp;<span class="op" id="3407166">(</span><span class="op" id="3407167">*</span><span class="ident" id="3407168">newArray</span><span class="op" id="3407176">)</span><span class="op" id="3407177">[</span><span class="op" id="3407178">*</span><span class="ident" id="3407179">newLow</span><span class="op" id="3407185">+</span><span class="num" id="3407186">1</span><span class="op" id="3407187">]</span><span class="op" id="3407188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3407192">*</span><span class="ident" id="3407193">newLow</span>&nbsp;<span class="op" id="3407200">+=</span>&nbsp;<span class="num" id="3407203">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3407207">ix</span>&nbsp;<span class="op" id="3407210">+=</span>&nbsp;<span class="num" id="3407213">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3407217">next</span>&nbsp;<span class="op" id="3407222">=</span>&nbsp;<span class="builtinfunc" id="3407224">append</span><span class="op" id="3407230">(</span><span class="ident" id="3407231">next</span><span class="op" id="3407235">,</span>&nbsp;<span class="ident" id="3407237">pc</span><span class="op" id="3407239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3407243">return</span>&nbsp;<span class="builtintype" id="3407250">true</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3407256">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3407260">for</span>&nbsp;<span class="ident" id="3407264">lx</span>&nbsp;<span class="op" id="3407267">&lt;</span>&nbsp;<span class="ident" id="3407269">leftLen</span>&nbsp;<span class="op" id="3407277">||</span>&nbsp;<span class="ident" id="3407280">rx</span>&nbsp;<span class="op" id="3407283">&lt;</span>&nbsp;<span class="ident" id="3407285">rightLen</span>&nbsp;<span class="op" id="3407294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3407298">switch</span>&nbsp;<span class="op" id="3407305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3407309">case</span>&nbsp;<span class="ident" id="3407314">rx</span>&nbsp;<span class="op" id="3407317">&gt;=</span>&nbsp;<span class="ident" id="3407320">rightLen</span><span class="op" id="3407328">:</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3407333">ok</span>&nbsp;<span class="op" id="3407336">=</span>&nbsp;<span class="ident" id="3407338">extend</span><span class="op" id="3407344">(</span><span class="op" id="3407345">&amp;</span><span class="ident" id="3407346">lx</span><span class="op" id="3407348">,</span>&nbsp;<span class="ident" id="3407350">leftRunes</span><span class="op" id="3407359">,</span>&nbsp;<span class="ident" id="3407361">leftPC</span><span class="op" id="3407367">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3407371">case</span>&nbsp;<span class="ident" id="3407376">lx</span>&nbsp;<span class="op" id="3407379">&gt;=</span>&nbsp;<span class="ident" id="3407382">leftLen</span><span class="op" id="3407389">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3407394">ok</span>&nbsp;<span class="op" id="3407397">=</span>&nbsp;<span class="ident" id="3407399">extend</span><span class="op" id="3407405">(</span><span class="op" id="3407406">&amp;</span><span class="ident" id="3407407">rx</span><span class="op" id="3407409">,</span>&nbsp;<span class="ident" id="3407411">rightRunes</span><span class="op" id="3407421">,</span>&nbsp;<span class="ident" id="3407423">rightPC</span><span class="op" id="3407430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3407434">case</span>&nbsp;<span class="op" id="3407439">(</span><span class="op" id="3407440">*</span><span class="ident" id="3407441">rightRunes</span><span class="op" id="3407451">)</span><span class="op" id="3407452">[</span><span class="ident" id="3407453">rx</span><span class="op" id="3407455">]</span>&nbsp;<span class="op" id="3407457">&lt;</span>&nbsp;<span class="op" id="3407459">(</span><span class="op" id="3407460">*</span><span class="ident" id="3407461">leftRunes</span><span class="op" id="3407470">)</span><span class="op" id="3407471">[</span><span class="ident" id="3407472">lx</span><span class="op" id="3407474">]</span><span class="op" id="3407475">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3407480">ok</span>&nbsp;<span class="op" id="3407483">=</span>&nbsp;<span class="ident" id="3407485">extend</span><span class="op" id="3407491">(</span><span class="op" id="3407492">&amp;</span><span class="ident" id="3407493">rx</span><span class="op" id="3407495">,</span>&nbsp;<span class="ident" id="3407497">rightRunes</span><span class="op" id="3407507">,</span>&nbsp;<span class="ident" id="3407509">rightPC</span><span class="op" id="3407516">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3407520">default</span><span class="op" id="3407527">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3407532">ok</span>&nbsp;<span class="op" id="3407535">=</span>&nbsp;<span class="ident" id="3407537">extend</span><span class="op" id="3407543">(</span><span class="op" id="3407544">&amp;</span><span class="ident" id="3407545">lx</span><span class="op" id="3407547">,</span>&nbsp;<span class="ident" id="3407549">leftRunes</span><span class="op" id="3407558">,</span>&nbsp;<span class="ident" id="3407560">leftPC</span><span class="op" id="3407566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3407570">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3407574">if</span>&nbsp;<span class="op" id="3407577">!</span><span class="ident" id="3407578">ok</span>&nbsp;<span class="op" id="3407581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3407586">return</span>&nbsp;<span class="ident" id="3407593">noRune</span><span class="op" id="3407599">,</span>&nbsp;<span class="ident" id="3407601">noNext</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3407610">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3407613">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3407616">return</span>&nbsp;<span class="ident" id="3407623">merged</span><span class="op" id="3407629">,</span>&nbsp;<span class="ident" id="3407631">next</span><br>
<span class="lineno"></span><span class="op" id="3407636">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">205</span><span class="comment" id="3407639">//&nbsp;cleanupOnePass&nbsp;drops&nbsp;working&nbsp;memory,&nbsp;and&nbsp;restores&nbsp;certain&nbsp;shortcut&nbsp;instructions.</span><br>
<span class="lineno"></span><span class="keyword" id="3407723">func</span>&nbsp;<span class="ident" id="3407728">cleanupOnePass</span><span class="op" id="3407742">(</span><span class="ident" id="3407743">prog</span>&nbsp;<span class="op" id="3407748">*</span><span class="ident" id="3407749">onePassProg</span><span class="op" id="3407760">,</span>&nbsp;<span class="ident" id="3407762">original</span>&nbsp;<span class="op" id="3407771">*</span><span class="ident" id="3407772">syntax</span><span class="op" id="3407778">.</span><span class="ident" id="3407779">Prog</span><span class="op" id="3407783">)</span>&nbsp;<span class="op" id="3407785">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3407788">for</span>&nbsp;<span class="ident" id="3407792">ix</span><span class="op" id="3407794">,</span>&nbsp;<span class="ident" id="3407796">instOriginal</span>&nbsp;<span class="op" id="3407809">:=</span>&nbsp;<span class="keyword" id="3407812">range</span>&nbsp;<span class="ident" id="3407818">original</span><span class="op" id="3407826">.</span><span class="ident" id="3407827">Inst</span>&nbsp;<span class="op" id="3407832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3407836">switch</span>&nbsp;<span class="ident" id="3407843">instOriginal</span><span class="op" id="3407855">.</span><span class="ident" id="3407856">Op</span>&nbsp;<span class="op" id="3407859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3407863">case</span>&nbsp;<span class="ident" id="3407868">syntax</span><span class="op" id="3407874">.</span><span class="ident" id="3407875">InstAlt</span><span class="op" id="3407882">,</span>&nbsp;<span class="ident" id="3407884">syntax</span><span class="op" id="3407890">.</span><span class="ident" id="3407891">InstAltMatch</span><span class="op" id="3407903">,</span>&nbsp;<span class="ident" id="3407905">syntax</span><span class="op" id="3407911">.</span><span class="ident" id="3407912">InstRune</span><span class="op" id="3407920">:</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3407924">case</span>&nbsp;<span class="ident" id="3407929">syntax</span><span class="op" id="3407935">.</span><span class="ident" id="3407936">InstCapture</span><span class="op" id="3407947">,</span>&nbsp;<span class="ident" id="3407949">syntax</span><span class="op" id="3407955">.</span><span class="ident" id="3407956">InstEmptyWidth</span><span class="op" id="3407970">,</span>&nbsp;<span class="ident" id="3407972">syntax</span><span class="op" id="3407978">.</span><span class="ident" id="3407979">InstNop</span><span class="op" id="3407986">,</span>&nbsp;<span class="ident" id="3407988">syntax</span><span class="op" id="3407994">.</span><span class="ident" id="3407995">InstMatch</span><span class="op" id="3408004">,</span>&nbsp;<span class="ident" id="3408006">syntax</span><span class="op" id="3408012">.</span><span class="ident" id="3408013">InstFail</span><span class="op" id="3408021">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3408026">prog</span><span class="op" id="3408030">.</span><span class="ident" id="3408031">Inst</span><span class="op" id="3408035">[</span><span class="ident" id="3408036">ix</span><span class="op" id="3408038">]</span><span class="op" id="3408039">.</span><span class="ident" id="3408040">Next</span>&nbsp;<span class="op" id="3408045">=</span>&nbsp;<span class="builtintype" id="3408047">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3408053">case</span>&nbsp;<span class="ident" id="3408058">syntax</span><span class="op" id="3408064">.</span><span class="ident" id="3408065">InstRune1</span><span class="op" id="3408074">,</span>&nbsp;<span class="ident" id="3408076">syntax</span><span class="op" id="3408082">.</span><span class="ident" id="3408083">InstRuneAny</span><span class="op" id="3408094">,</span>&nbsp;<span class="ident" id="3408096">syntax</span><span class="op" id="3408102">.</span><span class="ident" id="3408103">InstRuneAnyNotNL</span><span class="op" id="3408119">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3408124">prog</span><span class="op" id="3408128">.</span><span class="ident" id="3408129">Inst</span><span class="op" id="3408133">[</span><span class="ident" id="3408134">ix</span><span class="op" id="3408136">]</span><span class="op" id="3408137">.</span><span class="ident" id="3408138">Next</span>&nbsp;<span class="op" id="3408143">=</span>&nbsp;<span class="builtintype" id="3408145">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3408152">prog</span><span class="op" id="3408156">.</span><span class="ident" id="3408157">Inst</span><span class="op" id="3408161">[</span><span class="ident" id="3408162">ix</span><span class="op" id="3408164">]</span>&nbsp;<span class="op" id="3408166">=</span>&nbsp;<span class="ident" id="3408168">onePassInst</span><span class="op" id="3408179">{</span><span class="ident" id="3408180">Inst</span><span class="op" id="3408184">:</span>&nbsp;<span class="ident" id="3408186">instOriginal</span><span class="op" id="3408198">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3408202">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3408205">}</span><br>
<span class="lineno"></span><span class="op" id="3408207">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3408210">//&nbsp;onePassCopy&nbsp;creates&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;original&nbsp;Prog,&nbsp;as&nbsp;we&#39;ll&nbsp;be&nbsp;modifying&nbsp;it</span><br>
<span class="lineno">220</span><span class="keyword" id="3408287">func</span>&nbsp;<span class="ident" id="3408292">onePassCopy</span><span class="op" id="3408303">(</span><span class="ident" id="3408304">prog</span>&nbsp;<span class="op" id="3408309">*</span><span class="ident" id="3408310">syntax</span><span class="op" id="3408316">.</span><span class="ident" id="3408317">Prog</span><span class="op" id="3408321">)</span>&nbsp;<span class="op" id="3408323">*</span><span class="ident" id="3408324">onePassProg</span>&nbsp;<span class="op" id="3408336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3408339">p</span>&nbsp;<span class="op" id="3408341">:=</span>&nbsp;<span class="op" id="3408344">&amp;</span><span class="ident" id="3408345">onePassProg</span><span class="op" id="3408356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3408360">Start</span><span class="op" id="3408365">:</span>&nbsp;&nbsp;<span class="ident" id="3408368">prog</span><span class="op" id="3408372">.</span><span class="ident" id="3408373">Start</span><span class="op" id="3408378">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3408382">NumCap</span><span class="op" id="3408388">:</span>&nbsp;<span class="ident" id="3408390">prog</span><span class="op" id="3408394">.</span><span class="ident" id="3408395">NumCap</span><span class="op" id="3408401">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3408404">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3408407">for</span>&nbsp;<span class="ident" id="3408411">_</span><span class="op" id="3408412">,</span>&nbsp;<span class="ident" id="3408414">inst</span>&nbsp;<span class="op" id="3408419">:=</span>&nbsp;<span class="keyword" id="3408422">range</span>&nbsp;<span class="ident" id="3408428">prog</span><span class="op" id="3408432">.</span><span class="ident" id="3408433">Inst</span>&nbsp;<span class="op" id="3408438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3408442">p</span><span class="op" id="3408443">.</span><span class="ident" id="3408444">Inst</span>&nbsp;<span class="op" id="3408449">=</span>&nbsp;<span class="builtinfunc" id="3408451">append</span><span class="op" id="3408457">(</span><span class="ident" id="3408458">p</span><span class="op" id="3408459">.</span><span class="ident" id="3408460">Inst</span><span class="op" id="3408464">,</span>&nbsp;<span class="ident" id="3408466">onePassInst</span><span class="op" id="3408477">{</span><span class="ident" id="3408478">Inst</span><span class="op" id="3408482">:</span>&nbsp;<span class="ident" id="3408484">inst</span><span class="op" id="3408488">}</span><span class="op" id="3408489">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3408492">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3408496">//&nbsp;rewrites&nbsp;one&nbsp;or&nbsp;more&nbsp;common&nbsp;Prog&nbsp;constructs&nbsp;that&nbsp;enable&nbsp;some&nbsp;otherwise</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3408571">//&nbsp;non-onepass&nbsp;Progs&nbsp;to&nbsp;be&nbsp;onepass.&nbsp;A:BD&nbsp;(for&nbsp;example)&nbsp;means&nbsp;an&nbsp;InstAlt&nbsp;at</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3408647">//&nbsp;ip&nbsp;A,&nbsp;that&nbsp;points&nbsp;to&nbsp;ips&nbsp;B&nbsp;&amp;&nbsp;C.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3408683">//&nbsp;A:BC&nbsp;+&nbsp;B:DA&nbsp;=&gt;&nbsp;A:BC&nbsp;+&nbsp;B:CD</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3408714">//&nbsp;A:BC&nbsp;+&nbsp;B:DC&nbsp;=&gt;&nbsp;A:DC&nbsp;+&nbsp;B:DC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3408745">for</span>&nbsp;<span class="ident" id="3408749">pc</span>&nbsp;<span class="op" id="3408752">:=</span>&nbsp;<span class="keyword" id="3408755">range</span>&nbsp;<span class="ident" id="3408761">p</span><span class="op" id="3408762">.</span><span class="ident" id="3408763">Inst</span>&nbsp;<span class="op" id="3408768">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3408772">switch</span>&nbsp;<span class="ident" id="3408779">p</span><span class="op" id="3408780">.</span><span class="ident" id="3408781">Inst</span><span class="op" id="3408785">[</span><span class="ident" id="3408786">pc</span><span class="op" id="3408788">]</span><span class="op" id="3408789">.</span><span class="ident" id="3408790">Op</span>&nbsp;<span class="op" id="3408793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3408797">default</span><span class="op" id="3408804">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3408809">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3408820">case</span>&nbsp;<span class="ident" id="3408825">syntax</span><span class="op" id="3408831">.</span><span class="ident" id="3408832">InstAlt</span><span class="op" id="3408839">,</span>&nbsp;<span class="ident" id="3408841">syntax</span><span class="op" id="3408847">.</span><span class="ident" id="3408848">InstAltMatch</span><span class="op" id="3408860">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3408865">//&nbsp;A:Bx&nbsp;+&nbsp;B:Ay</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3408883">p_A_Other</span>&nbsp;<span class="op" id="3408893">:=</span>&nbsp;<span class="op" id="3408896">&amp;</span><span class="ident" id="3408897">p</span><span class="op" id="3408898">.</span><span class="ident" id="3408899">Inst</span><span class="op" id="3408903">[</span><span class="ident" id="3408904">pc</span><span class="op" id="3408906">]</span><span class="op" id="3408907">.</span><span class="ident" id="3408908">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3408915">p_A_Alt</span>&nbsp;<span class="op" id="3408923">:=</span>&nbsp;<span class="op" id="3408926">&amp;</span><span class="ident" id="3408927">p</span><span class="op" id="3408928">.</span><span class="ident" id="3408929">Inst</span><span class="op" id="3408933">[</span><span class="ident" id="3408934">pc</span><span class="op" id="3408936">]</span><span class="op" id="3408937">.</span><span class="ident" id="3408938">Arg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3408945">//&nbsp;make&nbsp;sure&nbsp;a&nbsp;target&nbsp;is&nbsp;another&nbsp;Alt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3408985">instAlt</span>&nbsp;<span class="op" id="3408993">:=</span>&nbsp;<span class="ident" id="3408996">p</span><span class="op" id="3408997">.</span><span class="ident" id="3408998">Inst</span><span class="op" id="3409002">[</span><span class="op" id="3409003">*</span><span class="ident" id="3409004">p_A_Alt</span><span class="op" id="3409011">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3409016">if</span>&nbsp;<span class="op" id="3409019">!</span><span class="op" id="3409020">(</span><span class="ident" id="3409021">instAlt</span><span class="op" id="3409028">.</span><span class="ident" id="3409029">Op</span>&nbsp;<span class="op" id="3409032">==</span>&nbsp;<span class="ident" id="3409035">syntax</span><span class="op" id="3409041">.</span><span class="ident" id="3409042">InstAlt</span>&nbsp;<span class="op" id="3409050">||</span>&nbsp;<span class="ident" id="3409053">instAlt</span><span class="op" id="3409060">.</span><span class="ident" id="3409061">Op</span>&nbsp;<span class="op" id="3409064">==</span>&nbsp;<span class="ident" id="3409067">syntax</span><span class="op" id="3409073">.</span><span class="ident" id="3409074">InstAltMatch</span><span class="op" id="3409086">)</span>&nbsp;<span class="op" id="3409088">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3409094">p_A_Alt</span><span class="op" id="3409101">,</span>&nbsp;<span class="ident" id="3409103">p_A_Other</span>&nbsp;<span class="op" id="3409113">=</span>&nbsp;<span class="ident" id="3409115">p_A_Other</span><span class="op" id="3409124">,</span>&nbsp;<span class="ident" id="3409126">p_A_Alt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3409138">instAlt</span>&nbsp;<span class="op" id="3409146">=</span>&nbsp;<span class="ident" id="3409148">p</span><span class="op" id="3409149">.</span><span class="ident" id="3409150">Inst</span><span class="op" id="3409154">[</span><span class="op" id="3409155">*</span><span class="ident" id="3409156">p_A_Alt</span><span class="op" id="3409163">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3409169">if</span>&nbsp;<span class="op" id="3409172">!</span><span class="op" id="3409173">(</span><span class="ident" id="3409174">instAlt</span><span class="op" id="3409181">.</span><span class="ident" id="3409182">Op</span>&nbsp;<span class="op" id="3409185">==</span>&nbsp;<span class="ident" id="3409188">syntax</span><span class="op" id="3409194">.</span><span class="ident" id="3409195">InstAlt</span>&nbsp;<span class="op" id="3409203">||</span>&nbsp;<span class="ident" id="3409206">instAlt</span><span class="op" id="3409213">.</span><span class="ident" id="3409214">Op</span>&nbsp;<span class="op" id="3409217">==</span>&nbsp;<span class="ident" id="3409220">syntax</span><span class="op" id="3409226">.</span><span class="ident" id="3409227">InstAltMatch</span><span class="op" id="3409239">)</span>&nbsp;<span class="op" id="3409241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3409248">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3409261">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3409266">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3409271">instOther</span>&nbsp;<span class="op" id="3409281">:=</span>&nbsp;<span class="ident" id="3409284">p</span><span class="op" id="3409285">.</span><span class="ident" id="3409286">Inst</span><span class="op" id="3409290">[</span><span class="op" id="3409291">*</span><span class="ident" id="3409292">p_A_Other</span><span class="op" id="3409301">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3409306">//&nbsp;Analyzing&nbsp;both&nbsp;legs&nbsp;pointing&nbsp;to&nbsp;Alts&nbsp;is&nbsp;for&nbsp;another&nbsp;day</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3409368">if</span>&nbsp;<span class="ident" id="3409371">instOther</span><span class="op" id="3409380">.</span><span class="ident" id="3409381">Op</span>&nbsp;<span class="op" id="3409384">==</span>&nbsp;<span class="ident" id="3409387">syntax</span><span class="op" id="3409393">.</span><span class="ident" id="3409394">InstAlt</span>&nbsp;<span class="op" id="3409402">||</span>&nbsp;<span class="ident" id="3409405">instOther</span><span class="op" id="3409414">.</span><span class="ident" id="3409415">Op</span>&nbsp;<span class="op" id="3409418">==</span>&nbsp;<span class="ident" id="3409421">syntax</span><span class="op" id="3409427">.</span><span class="ident" id="3409428">InstAltMatch</span>&nbsp;<span class="op" id="3409441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3409447">//&nbsp;too&nbsp;complicated</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3409470">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3409482">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3409487">//&nbsp;simple&nbsp;empty&nbsp;transition&nbsp;loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3409522">//&nbsp;A:BC&nbsp;+&nbsp;B:DA&nbsp;=&gt;&nbsp;A:BC&nbsp;+&nbsp;B:DC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3409555">p_B_Alt</span>&nbsp;<span class="op" id="3409563">:=</span>&nbsp;<span class="op" id="3409566">&amp;</span><span class="ident" id="3409567">p</span><span class="op" id="3409568">.</span><span class="ident" id="3409569">Inst</span><span class="op" id="3409573">[</span><span class="op" id="3409574">*</span><span class="ident" id="3409575">p_A_Alt</span><span class="op" id="3409582">]</span><span class="op" id="3409583">.</span><span class="ident" id="3409584">Out</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3409591">p_B_Other</span>&nbsp;<span class="op" id="3409601">:=</span>&nbsp;<span class="op" id="3409604">&amp;</span><span class="ident" id="3409605">p</span><span class="op" id="3409606">.</span><span class="ident" id="3409607">Inst</span><span class="op" id="3409611">[</span><span class="op" id="3409612">*</span><span class="ident" id="3409613">p_A_Alt</span><span class="op" id="3409620">]</span><span class="op" id="3409621">.</span><span class="ident" id="3409622">Arg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3409629">patch</span>&nbsp;<span class="op" id="3409635">:=</span>&nbsp;<span class="builtintype" id="3409638">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3409647">if</span>&nbsp;<span class="ident" id="3409650">instAlt</span><span class="op" id="3409657">.</span><span class="ident" id="3409658">Out</span>&nbsp;<span class="op" id="3409662">==</span>&nbsp;<span class="builtintype" id="3409665">uint32</span><span class="op" id="3409671">(</span><span class="ident" id="3409672">pc</span><span class="op" id="3409674">)</span>&nbsp;<span class="op" id="3409676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3409682">patch</span>&nbsp;<span class="op" id="3409688">=</span>&nbsp;<span class="builtintype" id="3409690">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3409698">}</span>&nbsp;<span class="keyword" id="3409700">else</span>&nbsp;<span class="keyword" id="3409705">if</span>&nbsp;<span class="ident" id="3409708">instAlt</span><span class="op" id="3409715">.</span><span class="ident" id="3409716">Arg</span>&nbsp;<span class="op" id="3409720">==</span>&nbsp;<span class="builtintype" id="3409723">uint32</span><span class="op" id="3409729">(</span><span class="ident" id="3409730">pc</span><span class="op" id="3409732">)</span>&nbsp;<span class="op" id="3409734">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3409740">patch</span>&nbsp;<span class="op" id="3409746">=</span>&nbsp;<span class="builtintype" id="3409748">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3409757">p_B_Alt</span><span class="op" id="3409764">,</span>&nbsp;<span class="ident" id="3409766">p_B_Other</span>&nbsp;<span class="op" id="3409776">=</span>&nbsp;<span class="ident" id="3409778">p_B_Other</span><span class="op" id="3409787">,</span>&nbsp;<span class="ident" id="3409789">p_B_Alt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3409800">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3409805">if</span>&nbsp;<span class="ident" id="3409808">patch</span>&nbsp;<span class="op" id="3409814">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3409820">*</span><span class="ident" id="3409821">p_B_Alt</span>&nbsp;<span class="op" id="3409829">=</span>&nbsp;<span class="op" id="3409831">*</span><span class="ident" id="3409832">p_A_Other</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3409845">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3409851">//&nbsp;empty&nbsp;transition&nbsp;to&nbsp;common&nbsp;target</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3409891">//&nbsp;A:BC&nbsp;+&nbsp;B:DC&nbsp;=&gt;&nbsp;A:DC&nbsp;+&nbsp;B:DC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3409924">if</span>&nbsp;<span class="op" id="3409927">*</span><span class="ident" id="3409928">p_A_Other</span>&nbsp;<span class="op" id="3409938">==</span>&nbsp;<span class="op" id="3409941">*</span><span class="ident" id="3409942">p_B_Alt</span>&nbsp;<span class="op" id="3409950">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3409956">*</span><span class="ident" id="3409957">p_A_Alt</span>&nbsp;<span class="op" id="3409965">=</span>&nbsp;<span class="op" id="3409967">*</span><span class="ident" id="3409968">p_B_Other</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3409981">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3409985">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3409988">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3409991">return</span>&nbsp;<span class="ident" id="3409998">p</span><br>
<span class="lineno">280</span><span class="op" id="3410000">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3410003">//&nbsp;runeSlice&nbsp;exists&nbsp;to&nbsp;permit&nbsp;sorting&nbsp;the&nbsp;case-folded&nbsp;rune&nbsp;sets.</span><br>
<span class="lineno"></span><span class="keyword" id="3410068">type</span>&nbsp;<span class="ident" id="3410073">runeSlice</span>&nbsp;<span class="op" id="3410083">[</span><span class="op" id="3410084">]</span><span class="builtintype" id="3410085">rune</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="keyword" id="3410091">func</span>&nbsp;<span class="op" id="3410096">(</span><span class="ident" id="3410097">p</span>&nbsp;<span class="ident" id="3410099">runeSlice</span><span class="op" id="3410108">)</span>&nbsp;<span class="ident" id="3410110">Len</span><span class="op" id="3410113">(</span><span class="op" id="3410114">)</span>&nbsp;<span class="builtintype" id="3410116">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3410130">{</span>&nbsp;<span class="keyword" id="3410132">return</span>&nbsp;<span class="builtinfunc" id="3410139">len</span><span class="op" id="3410142">(</span><span class="ident" id="3410143">p</span><span class="op" id="3410144">)</span>&nbsp;<span class="op" id="3410146">}</span><br>
<span class="lineno"></span><span class="keyword" id="3410148">func</span>&nbsp;<span class="op" id="3410153">(</span><span class="ident" id="3410154">p</span>&nbsp;<span class="ident" id="3410156">runeSlice</span><span class="op" id="3410165">)</span>&nbsp;<span class="ident" id="3410167">Less</span><span class="op" id="3410171">(</span><span class="ident" id="3410172">i</span><span class="op" id="3410173">,</span>&nbsp;<span class="ident" id="3410175">j</span>&nbsp;<span class="builtintype" id="3410177">int</span><span class="op" id="3410180">)</span>&nbsp;<span class="builtintype" id="3410182">bool</span>&nbsp;<span class="op" id="3410187">{</span>&nbsp;<span class="keyword" id="3410189">return</span>&nbsp;<span class="ident" id="3410196">p</span><span class="op" id="3410197">[</span><span class="ident" id="3410198">i</span><span class="op" id="3410199">]</span>&nbsp;<span class="op" id="3410201">&lt;</span>&nbsp;<span class="ident" id="3410203">p</span><span class="op" id="3410204">[</span><span class="ident" id="3410205">j</span><span class="op" id="3410206">]</span>&nbsp;<span class="op" id="3410208">}</span><br>
<span class="lineno"></span><span class="keyword" id="3410210">func</span>&nbsp;<span class="op" id="3410215">(</span><span class="ident" id="3410216">p</span>&nbsp;<span class="ident" id="3410218">runeSlice</span><span class="op" id="3410227">)</span>&nbsp;<span class="ident" id="3410229">Swap</span><span class="op" id="3410233">(</span><span class="ident" id="3410234">i</span><span class="op" id="3410235">,</span>&nbsp;<span class="ident" id="3410237">j</span>&nbsp;<span class="builtintype" id="3410239">int</span><span class="op" id="3410242">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3410249">{</span>&nbsp;<span class="ident" id="3410251">p</span><span class="op" id="3410252">[</span><span class="ident" id="3410253">i</span><span class="op" id="3410254">]</span><span class="op" id="3410255">,</span>&nbsp;<span class="ident" id="3410257">p</span><span class="op" id="3410258">[</span><span class="ident" id="3410259">j</span><span class="op" id="3410260">]</span>&nbsp;<span class="op" id="3410262">=</span>&nbsp;<span class="ident" id="3410264">p</span><span class="op" id="3410265">[</span><span class="ident" id="3410266">j</span><span class="op" id="3410267">]</span><span class="op" id="3410268">,</span>&nbsp;<span class="ident" id="3410270">p</span><span class="op" id="3410271">[</span><span class="ident" id="3410272">i</span><span class="op" id="3410273">]</span>&nbsp;<span class="op" id="3410275">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3410278">//&nbsp;Sort&nbsp;is&nbsp;a&nbsp;convenience&nbsp;method.</span><br>
<span class="lineno">290</span><span class="keyword" id="3410311">func</span>&nbsp;<span class="op" id="3410316">(</span><span class="ident" id="3410317">p</span>&nbsp;<span class="ident" id="3410319">runeSlice</span><span class="op" id="3410328">)</span>&nbsp;<span class="ident" id="3410330">Sort</span><span class="op" id="3410334">(</span><span class="op" id="3410335">)</span>&nbsp;<span class="op" id="3410337">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3410340">sort</span><span class="op" id="3410344">.</span><span class="ident" id="3410345">Sort</span><span class="op" id="3410349">(</span><span class="ident" id="3410350">p</span><span class="op" id="3410351">)</span><br>
<span class="lineno"></span><span class="op" id="3410353">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3410356">var</span>&nbsp;<span class="ident" id="3410360">anyRuneNotNL</span>&nbsp;<span class="op" id="3410373">=</span>&nbsp;<span class="op" id="3410375">[</span><span class="op" id="3410376">]</span><span class="builtintype" id="3410377">rune</span><span class="op" id="3410381">{</span><span class="num" id="3410382">0</span><span class="op" id="3410383">,</span>&nbsp;<span class="string" id="3410385">&#39;\n&#39;</span>&nbsp;<span class="op" id="3410390">-</span>&nbsp;<span class="num" id="3410392">1</span><span class="op" id="3410393">,</span>&nbsp;<span class="string" id="3410395">&#39;\n&#39;</span>&nbsp;<span class="op" id="3410400">+</span>&nbsp;<span class="num" id="3410402">1</span><span class="op" id="3410403">,</span>&nbsp;<span class="ident" id="3410405">unicode</span><span class="op" id="3410412">.</span><span class="ident" id="3410413">MaxRune</span><span class="op" id="3410420">}</span><br>
<span class="lineno">295</span><span class="keyword" id="3410422">var</span>&nbsp;<span class="ident" id="3410426">anyRune</span>&nbsp;<span class="op" id="3410434">=</span>&nbsp;<span class="op" id="3410436">[</span><span class="op" id="3410437">]</span><span class="builtintype" id="3410438">rune</span><span class="op" id="3410442">{</span><span class="num" id="3410443">0</span><span class="op" id="3410444">,</span>&nbsp;<span class="ident" id="3410446">unicode</span><span class="op" id="3410453">.</span><span class="ident" id="3410454">MaxRune</span><span class="op" id="3410461">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3410464">//&nbsp;makeOnePass&nbsp;creates&nbsp;a&nbsp;onepass&nbsp;Prog,&nbsp;if&nbsp;possible.&nbsp;It&nbsp;is&nbsp;possible&nbsp;if&nbsp;at&nbsp;any&nbsp;alt,</span><br>
<span class="lineno"></span><span class="comment" id="3410546">//&nbsp;the&nbsp;match&nbsp;engine&nbsp;can&nbsp;always&nbsp;tell&nbsp;which&nbsp;branch&nbsp;to&nbsp;take.&nbsp;The&nbsp;routine&nbsp;may&nbsp;modify</span><br>
<span class="lineno"></span><span class="comment" id="3410627">//&nbsp;p&nbsp;if&nbsp;it&nbsp;is&nbsp;turned&nbsp;into&nbsp;a&nbsp;onepass&nbsp;Prog.&nbsp;If&nbsp;it&nbsp;isn&#39;t&nbsp;possible&nbsp;for&nbsp;this&nbsp;to&nbsp;be&nbsp;a</span><br>
<span class="lineno">300</span><span class="comment" id="3410707">//&nbsp;onepass&nbsp;Prog,&nbsp;the&nbsp;Prog&nbsp;notOnePass&nbsp;is&nbsp;returned.&nbsp;makeOnePass&nbsp;is&nbsp;recursive</span><br>
<span class="lineno"></span><span class="comment" id="3410782">//&nbsp;to&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;Prog.</span><br>
<span class="lineno"></span><span class="keyword" id="3410810">func</span>&nbsp;<span class="ident" id="3410815">makeOnePass</span><span class="op" id="3410826">(</span><span class="ident" id="3410827">p</span>&nbsp;<span class="op" id="3410829">*</span><span class="ident" id="3410830">onePassProg</span><span class="op" id="3410841">)</span>&nbsp;<span class="op" id="3410843">*</span><span class="ident" id="3410844">onePassProg</span>&nbsp;<span class="op" id="3410856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3410859">//&nbsp;If&nbsp;the&nbsp;machine&nbsp;is&nbsp;very&nbsp;long,&nbsp;it&#39;s&nbsp;not&nbsp;worth&nbsp;the&nbsp;time&nbsp;to&nbsp;check&nbsp;if&nbsp;we&nbsp;can&nbsp;use&nbsp;one&nbsp;pass.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3410949">if</span>&nbsp;<span class="builtinfunc" id="3410952">len</span><span class="op" id="3410955">(</span><span class="ident" id="3410956">p</span><span class="op" id="3410957">.</span><span class="ident" id="3410958">Inst</span><span class="op" id="3410962">)</span>&nbsp;<span class="op" id="3410964">&gt;=</span>&nbsp;<span class="num" id="3410967">1000</span>&nbsp;<span class="op" id="3410972">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3410976">return</span>&nbsp;<span class="ident" id="3410983">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3410995">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3410999">var</span>&nbsp;<span class="op" id="3411003">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3411007">instQueue</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3411020">=</span>&nbsp;<span class="ident" id="3411022">newQueue</span><span class="op" id="3411030">(</span><span class="builtinfunc" id="3411031">len</span><span class="op" id="3411034">(</span><span class="ident" id="3411035">p</span><span class="op" id="3411036">.</span><span class="ident" id="3411037">Inst</span><span class="op" id="3411041">)</span><span class="op" id="3411042">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3411046">visitQueue</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3411059">=</span>&nbsp;<span class="ident" id="3411061">newQueue</span><span class="op" id="3411069">(</span><span class="builtinfunc" id="3411070">len</span><span class="op" id="3411073">(</span><span class="ident" id="3411074">p</span><span class="op" id="3411075">.</span><span class="ident" id="3411076">Inst</span><span class="op" id="3411080">)</span><span class="op" id="3411081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3411085">build</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3411098">func</span><span class="op" id="3411102">(</span><span class="builtintype" id="3411103">uint32</span><span class="op" id="3411109">,</span>&nbsp;<span class="op" id="3411111">*</span><span class="ident" id="3411112">queueOnePass</span><span class="op" id="3411124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3411128">check</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3411141">func</span><span class="op" id="3411145">(</span><span class="builtintype" id="3411146">uint32</span><span class="op" id="3411152">,</span>&nbsp;<span class="keyword" id="3411154">map</span><span class="op" id="3411157">[</span><span class="builtintype" id="3411158">uint32</span><span class="op" id="3411164">]</span><span class="builtintype" id="3411165">bool</span><span class="op" id="3411169">)</span>&nbsp;<span class="builtintype" id="3411171">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3411178">onePassRunes</span>&nbsp;<span class="op" id="3411191">=</span>&nbsp;<span class="builtinfunc" id="3411193">make</span><span class="op" id="3411197">(</span><span class="op" id="3411198">[</span><span class="op" id="3411199">]</span><span class="op" id="3411200">[</span><span class="op" id="3411201">]</span><span class="builtintype" id="3411202">rune</span><span class="op" id="3411206">,</span>&nbsp;<span class="builtinfunc" id="3411208">len</span><span class="op" id="3411211">(</span><span class="ident" id="3411212">p</span><span class="op" id="3411213">.</span><span class="ident" id="3411214">Inst</span><span class="op" id="3411218">)</span><span class="op" id="3411219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3411222">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3411225">build</span>&nbsp;<span class="op" id="3411231">=</span>&nbsp;<span class="keyword" id="3411233">func</span><span class="op" id="3411237">(</span><span class="ident" id="3411238">pc</span>&nbsp;<span class="builtintype" id="3411241">uint32</span><span class="op" id="3411247">,</span>&nbsp;<span class="ident" id="3411249">q</span>&nbsp;<span class="op" id="3411251">*</span><span class="ident" id="3411252">queueOnePass</span><span class="op" id="3411264">)</span>&nbsp;<span class="op" id="3411266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3411270">if</span>&nbsp;<span class="ident" id="3411273">q</span><span class="op" id="3411274">.</span><span class="ident" id="3411275">contains</span><span class="op" id="3411283">(</span><span class="ident" id="3411284">pc</span><span class="op" id="3411286">)</span>&nbsp;<span class="op" id="3411288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3411293">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3411302">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3411306">inst</span>&nbsp;<span class="op" id="3411311">:=</span>&nbsp;<span class="ident" id="3411314">p</span><span class="op" id="3411315">.</span><span class="ident" id="3411316">Inst</span><span class="op" id="3411320">[</span><span class="ident" id="3411321">pc</span><span class="op" id="3411323">]</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3411327">switch</span>&nbsp;<span class="ident" id="3411334">inst</span><span class="op" id="3411338">.</span><span class="ident" id="3411339">Op</span>&nbsp;<span class="op" id="3411342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3411346">case</span>&nbsp;<span class="ident" id="3411351">syntax</span><span class="op" id="3411357">.</span><span class="ident" id="3411358">InstAlt</span><span class="op" id="3411365">,</span>&nbsp;<span class="ident" id="3411367">syntax</span><span class="op" id="3411373">.</span><span class="ident" id="3411374">InstAltMatch</span><span class="op" id="3411386">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3411391">q</span><span class="op" id="3411392">.</span><span class="ident" id="3411393">insert</span><span class="op" id="3411399">(</span><span class="ident" id="3411400">inst</span><span class="op" id="3411404">.</span><span class="ident" id="3411405">Out</span><span class="op" id="3411408">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3411413">build</span><span class="op" id="3411418">(</span><span class="ident" id="3411419">inst</span><span class="op" id="3411423">.</span><span class="ident" id="3411424">Out</span><span class="op" id="3411427">,</span>&nbsp;<span class="ident" id="3411429">q</span><span class="op" id="3411430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3411435">q</span><span class="op" id="3411436">.</span><span class="ident" id="3411437">insert</span><span class="op" id="3411443">(</span><span class="ident" id="3411444">inst</span><span class="op" id="3411448">.</span><span class="ident" id="3411449">Arg</span><span class="op" id="3411452">)</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3411456">case</span>&nbsp;<span class="ident" id="3411461">syntax</span><span class="op" id="3411467">.</span><span class="ident" id="3411468">InstMatch</span><span class="op" id="3411477">,</span>&nbsp;<span class="ident" id="3411479">syntax</span><span class="op" id="3411485">.</span><span class="ident" id="3411486">InstFail</span><span class="op" id="3411494">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3411498">default</span><span class="op" id="3411505">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3411510">q</span><span class="op" id="3411511">.</span><span class="ident" id="3411512">insert</span><span class="op" id="3411518">(</span><span class="ident" id="3411519">inst</span><span class="op" id="3411523">.</span><span class="ident" id="3411524">Out</span><span class="op" id="3411527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3411531">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3411534">}</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3411538">//&nbsp;check&nbsp;that&nbsp;paths&nbsp;from&nbsp;Alt&nbsp;instructions&nbsp;are&nbsp;unambiguous,&nbsp;and&nbsp;rebuild&nbsp;the&nbsp;new</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3411618">//&nbsp;program&nbsp;as&nbsp;a&nbsp;onepass&nbsp;program</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3411651">check</span>&nbsp;<span class="op" id="3411657">=</span>&nbsp;<span class="keyword" id="3411659">func</span><span class="op" id="3411663">(</span><span class="ident" id="3411664">pc</span>&nbsp;<span class="builtintype" id="3411667">uint32</span><span class="op" id="3411673">,</span>&nbsp;<span class="ident" id="3411675">m</span>&nbsp;<span class="keyword" id="3411677">map</span><span class="op" id="3411680">[</span><span class="builtintype" id="3411681">uint32</span><span class="op" id="3411687">]</span><span class="builtintype" id="3411688">bool</span><span class="op" id="3411692">)</span>&nbsp;<span class="op" id="3411694">(</span><span class="ident" id="3411695">ok</span>&nbsp;<span class="builtintype" id="3411698">bool</span><span class="op" id="3411702">)</span>&nbsp;<span class="op" id="3411704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3411708">ok</span>&nbsp;<span class="op" id="3411711">=</span>&nbsp;<span class="builtintype" id="3411713">true</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3411720">inst</span>&nbsp;<span class="op" id="3411725">:=</span>&nbsp;<span class="op" id="3411728">&amp;</span><span class="ident" id="3411729">p</span><span class="op" id="3411730">.</span><span class="ident" id="3411731">Inst</span><span class="op" id="3411735">[</span><span class="ident" id="3411736">pc</span><span class="op" id="3411738">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3411742">if</span>&nbsp;<span class="ident" id="3411745">visitQueue</span><span class="op" id="3411755">.</span><span class="ident" id="3411756">contains</span><span class="op" id="3411764">(</span><span class="ident" id="3411765">pc</span><span class="op" id="3411767">)</span>&nbsp;<span class="op" id="3411769">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3411774">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3411783">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3411787">visitQueue</span><span class="op" id="3411797">.</span><span class="ident" id="3411798">insert</span><span class="op" id="3411804">(</span><span class="ident" id="3411805">pc</span><span class="op" id="3411807">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3411811">switch</span>&nbsp;<span class="ident" id="3411818">inst</span><span class="op" id="3411822">.</span><span class="ident" id="3411823">Op</span>&nbsp;<span class="op" id="3411826">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3411830">case</span>&nbsp;<span class="ident" id="3411835">syntax</span><span class="op" id="3411841">.</span><span class="ident" id="3411842">InstAlt</span><span class="op" id="3411849">,</span>&nbsp;<span class="ident" id="3411851">syntax</span><span class="op" id="3411857">.</span><span class="ident" id="3411858">InstAltMatch</span><span class="op" id="3411870">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3411875">ok</span>&nbsp;<span class="op" id="3411878">=</span>&nbsp;<span class="ident" id="3411880">check</span><span class="op" id="3411885">(</span><span class="ident" id="3411886">inst</span><span class="op" id="3411890">.</span><span class="ident" id="3411891">Out</span><span class="op" id="3411894">,</span>&nbsp;<span class="ident" id="3411896">m</span><span class="op" id="3411897">)</span>&nbsp;<span class="op" id="3411899">&amp;&amp;</span>&nbsp;<span class="ident" id="3411902">check</span><span class="op" id="3411907">(</span><span class="ident" id="3411908">inst</span><span class="op" id="3411912">.</span><span class="ident" id="3411913">Arg</span><span class="op" id="3411916">,</span>&nbsp;<span class="ident" id="3411918">m</span><span class="op" id="3411919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3411924">//&nbsp;check&nbsp;no-input&nbsp;paths&nbsp;to&nbsp;InstMatch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3411964">matchOut</span>&nbsp;<span class="op" id="3411973">:=</span>&nbsp;<span class="ident" id="3411976">m</span><span class="op" id="3411977">[</span><span class="ident" id="3411978">inst</span><span class="op" id="3411982">.</span><span class="ident" id="3411983">Out</span><span class="op" id="3411986">]</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3411991">matchArg</span>&nbsp;<span class="op" id="3412000">:=</span>&nbsp;<span class="ident" id="3412003">m</span><span class="op" id="3412004">[</span><span class="ident" id="3412005">inst</span><span class="op" id="3412009">.</span><span class="ident" id="3412010">Arg</span><span class="op" id="3412013">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3412018">if</span>&nbsp;<span class="ident" id="3412021">matchOut</span>&nbsp;<span class="op" id="3412030">&amp;&amp;</span>&nbsp;<span class="ident" id="3412033">matchArg</span>&nbsp;<span class="op" id="3412042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3412048">ok</span>&nbsp;<span class="op" id="3412051">=</span>&nbsp;<span class="builtintype" id="3412053">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3412063">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3412072">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3412077">//&nbsp;Match&nbsp;on&nbsp;empty&nbsp;goes&nbsp;in&nbsp;inst.Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3412115">if</span>&nbsp;<span class="ident" id="3412118">matchArg</span>&nbsp;<span class="op" id="3412127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3412133">inst</span><span class="op" id="3412137">.</span><span class="ident" id="3412138">Out</span><span class="op" id="3412141">,</span>&nbsp;<span class="ident" id="3412143">inst</span><span class="op" id="3412147">.</span><span class="ident" id="3412148">Arg</span>&nbsp;<span class="op" id="3412152">=</span>&nbsp;<span class="ident" id="3412154">inst</span><span class="op" id="3412158">.</span><span class="ident" id="3412159">Arg</span><span class="op" id="3412162">,</span>&nbsp;<span class="ident" id="3412164">inst</span><span class="op" id="3412168">.</span><span class="ident" id="3412169">Out</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3412177">matchOut</span><span class="op" id="3412185">,</span>&nbsp;<span class="ident" id="3412187">matchArg</span>&nbsp;<span class="op" id="3412196">=</span>&nbsp;<span class="ident" id="3412198">matchArg</span><span class="op" id="3412206">,</span>&nbsp;<span class="ident" id="3412208">matchOut</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3412220">}</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3412225">if</span>&nbsp;<span class="ident" id="3412228">matchOut</span>&nbsp;<span class="op" id="3412237">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3412243">m</span><span class="op" id="3412244">[</span><span class="ident" id="3412245">pc</span><span class="op" id="3412247">]</span>&nbsp;<span class="op" id="3412249">=</span>&nbsp;<span class="builtintype" id="3412251">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3412260">inst</span><span class="op" id="3412264">.</span><span class="ident" id="3412265">Op</span>&nbsp;<span class="op" id="3412268">=</span>&nbsp;<span class="ident" id="3412270">syntax</span><span class="op" id="3412276">.</span><span class="ident" id="3412277">InstAltMatch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3412293">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3412299">//&nbsp;build&nbsp;a&nbsp;dispatch&nbsp;operator&nbsp;from&nbsp;the&nbsp;two&nbsp;legs&nbsp;of&nbsp;the&nbsp;alt.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3412361">onePassRunes</span><span class="op" id="3412373">[</span><span class="ident" id="3412374">pc</span><span class="op" id="3412376">]</span><span class="op" id="3412377">,</span>&nbsp;<span class="ident" id="3412379">inst</span><span class="op" id="3412383">.</span><span class="ident" id="3412384">Next</span>&nbsp;<span class="op" id="3412389">=</span>&nbsp;<span class="ident" id="3412391">mergeRuneSets</span><span class="op" id="3412404">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3412410">&amp;</span><span class="ident" id="3412411">onePassRunes</span><span class="op" id="3412423">[</span><span class="ident" id="3412424">inst</span><span class="op" id="3412428">.</span><span class="ident" id="3412429">Out</span><span class="op" id="3412432">]</span><span class="op" id="3412433">,</span>&nbsp;<span class="op" id="3412435">&amp;</span><span class="ident" id="3412436">onePassRunes</span><span class="op" id="3412448">[</span><span class="ident" id="3412449">inst</span><span class="op" id="3412453">.</span><span class="ident" id="3412454">Arg</span><span class="op" id="3412457">]</span><span class="op" id="3412458">,</span>&nbsp;<span class="ident" id="3412460">inst</span><span class="op" id="3412464">.</span><span class="ident" id="3412465">Out</span><span class="op" id="3412468">,</span>&nbsp;<span class="ident" id="3412470">inst</span><span class="op" id="3412474">.</span><span class="ident" id="3412475">Arg</span><span class="op" id="3412478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3412483">if</span>&nbsp;<span class="builtinfunc" id="3412486">len</span><span class="op" id="3412489">(</span><span class="ident" id="3412490">inst</span><span class="op" id="3412494">.</span><span class="ident" id="3412495">Next</span><span class="op" id="3412499">)</span>&nbsp;<span class="op" id="3412501">&gt;</span>&nbsp;<span class="num" id="3412503">0</span>&nbsp;<span class="op" id="3412505">&amp;&amp;</span>&nbsp;<span class="ident" id="3412508">inst</span><span class="op" id="3412512">.</span><span class="ident" id="3412513">Next</span><span class="op" id="3412517">[</span><span class="num" id="3412518">0</span><span class="op" id="3412519">]</span>&nbsp;<span class="op" id="3412521">==</span>&nbsp;<span class="ident" id="3412524">mergeFailed</span>&nbsp;<span class="op" id="3412536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3412542">ok</span>&nbsp;<span class="op" id="3412545">=</span>&nbsp;<span class="builtintype" id="3412547">false</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3412557">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3412566">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3412570">case</span>&nbsp;<span class="ident" id="3412575">syntax</span><span class="op" id="3412581">.</span><span class="ident" id="3412582">InstCapture</span><span class="op" id="3412593">,</span>&nbsp;<span class="ident" id="3412595">syntax</span><span class="op" id="3412601">.</span><span class="ident" id="3412602">InstNop</span><span class="op" id="3412609">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3412614">ok</span>&nbsp;<span class="op" id="3412617">=</span>&nbsp;<span class="ident" id="3412619">check</span><span class="op" id="3412624">(</span><span class="ident" id="3412625">inst</span><span class="op" id="3412629">.</span><span class="ident" id="3412630">Out</span><span class="op" id="3412633">,</span>&nbsp;<span class="ident" id="3412635">m</span><span class="op" id="3412636">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3412641">m</span><span class="op" id="3412642">[</span><span class="ident" id="3412643">pc</span><span class="op" id="3412645">]</span>&nbsp;<span class="op" id="3412647">=</span>&nbsp;<span class="ident" id="3412649">m</span><span class="op" id="3412650">[</span><span class="ident" id="3412651">inst</span><span class="op" id="3412655">.</span><span class="ident" id="3412656">Out</span><span class="op" id="3412659">]</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3412664">//&nbsp;pass&nbsp;matching&nbsp;runes&nbsp;back&nbsp;through&nbsp;these&nbsp;no-ops.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3412717">onePassRunes</span><span class="op" id="3412729">[</span><span class="ident" id="3412730">pc</span><span class="op" id="3412732">]</span>&nbsp;<span class="op" id="3412734">=</span>&nbsp;<span class="builtinfunc" id="3412736">append</span><span class="op" id="3412742">(</span><span class="op" id="3412743">[</span><span class="op" id="3412744">]</span><span class="builtintype" id="3412745">rune</span><span class="op" id="3412749">{</span><span class="op" id="3412750">}</span><span class="op" id="3412751">,</span>&nbsp;<span class="ident" id="3412753">onePassRunes</span><span class="op" id="3412765">[</span><span class="ident" id="3412766">inst</span><span class="op" id="3412770">.</span><span class="ident" id="3412771">Out</span><span class="op" id="3412774">]</span><span class="op" id="3412775">...</span><span class="op" id="3412778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3412783">inst</span><span class="op" id="3412787">.</span><span class="ident" id="3412788">Next</span>&nbsp;<span class="op" id="3412793">=</span>&nbsp;<span class="op" id="3412795">[</span><span class="op" id="3412796">]</span><span class="builtintype" id="3412797">uint32</span><span class="op" id="3412803">{</span><span class="op" id="3412804">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3412809">for</span>&nbsp;<span class="ident" id="3412813">i</span>&nbsp;<span class="op" id="3412815">:=</span>&nbsp;<span class="builtinfunc" id="3412818">len</span><span class="op" id="3412821">(</span><span class="ident" id="3412822">onePassRunes</span><span class="op" id="3412834">[</span><span class="ident" id="3412835">pc</span><span class="op" id="3412837">]</span><span class="op" id="3412838">)</span>&nbsp;<span class="op" id="3412840">/</span>&nbsp;<span class="num" id="3412842">2</span><span class="op" id="3412843">;</span>&nbsp;<span class="ident" id="3412845">i</span>&nbsp;<span class="op" id="3412847">&gt;=</span>&nbsp;<span class="num" id="3412850">0</span><span class="op" id="3412851">;</span>&nbsp;<span class="ident" id="3412853">i</span><span class="op" id="3412854">--</span>&nbsp;<span class="op" id="3412857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3412863">inst</span><span class="op" id="3412867">.</span><span class="ident" id="3412868">Next</span>&nbsp;<span class="op" id="3412873">=</span>&nbsp;<span class="builtinfunc" id="3412875">append</span><span class="op" id="3412881">(</span><span class="ident" id="3412882">inst</span><span class="op" id="3412886">.</span><span class="ident" id="3412887">Next</span><span class="op" id="3412891">,</span>&nbsp;<span class="ident" id="3412893">inst</span><span class="op" id="3412897">.</span><span class="ident" id="3412898">Out</span><span class="op" id="3412901">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3412906">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3412910">case</span>&nbsp;<span class="ident" id="3412915">syntax</span><span class="op" id="3412921">.</span><span class="ident" id="3412922">InstEmptyWidth</span><span class="op" id="3412936">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3412941">ok</span>&nbsp;<span class="op" id="3412944">=</span>&nbsp;<span class="ident" id="3412946">check</span><span class="op" id="3412951">(</span><span class="ident" id="3412952">inst</span><span class="op" id="3412956">.</span><span class="ident" id="3412957">Out</span><span class="op" id="3412960">,</span>&nbsp;<span class="ident" id="3412962">m</span><span class="op" id="3412963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3412968">m</span><span class="op" id="3412969">[</span><span class="ident" id="3412970">pc</span><span class="op" id="3412972">]</span>&nbsp;<span class="op" id="3412974">=</span>&nbsp;<span class="ident" id="3412976">m</span><span class="op" id="3412977">[</span><span class="ident" id="3412978">inst</span><span class="op" id="3412982">.</span><span class="ident" id="3412983">Out</span><span class="op" id="3412986">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3412991">onePassRunes</span><span class="op" id="3413003">[</span><span class="ident" id="3413004">pc</span><span class="op" id="3413006">]</span>&nbsp;<span class="op" id="3413008">=</span>&nbsp;<span class="builtinfunc" id="3413010">append</span><span class="op" id="3413016">(</span><span class="op" id="3413017">[</span><span class="op" id="3413018">]</span><span class="builtintype" id="3413019">rune</span><span class="op" id="3413023">{</span><span class="op" id="3413024">}</span><span class="op" id="3413025">,</span>&nbsp;<span class="ident" id="3413027">onePassRunes</span><span class="op" id="3413039">[</span><span class="ident" id="3413040">inst</span><span class="op" id="3413044">.</span><span class="ident" id="3413045">Out</span><span class="op" id="3413048">]</span><span class="op" id="3413049">...</span><span class="op" id="3413052">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3413057">inst</span><span class="op" id="3413061">.</span><span class="ident" id="3413062">Next</span>&nbsp;<span class="op" id="3413067">=</span>&nbsp;<span class="op" id="3413069">[</span><span class="op" id="3413070">]</span><span class="builtintype" id="3413071">uint32</span><span class="op" id="3413077">{</span><span class="op" id="3413078">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3413083">for</span>&nbsp;<span class="ident" id="3413087">i</span>&nbsp;<span class="op" id="3413089">:=</span>&nbsp;<span class="builtinfunc" id="3413092">len</span><span class="op" id="3413095">(</span><span class="ident" id="3413096">onePassRunes</span><span class="op" id="3413108">[</span><span class="ident" id="3413109">pc</span><span class="op" id="3413111">]</span><span class="op" id="3413112">)</span>&nbsp;<span class="op" id="3413114">/</span>&nbsp;<span class="num" id="3413116">2</span><span class="op" id="3413117">;</span>&nbsp;<span class="ident" id="3413119">i</span>&nbsp;<span class="op" id="3413121">&gt;=</span>&nbsp;<span class="num" id="3413124">0</span><span class="op" id="3413125">;</span>&nbsp;<span class="ident" id="3413127">i</span><span class="op" id="3413128">--</span>&nbsp;<span class="op" id="3413131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3413137">inst</span><span class="op" id="3413141">.</span><span class="ident" id="3413142">Next</span>&nbsp;<span class="op" id="3413147">=</span>&nbsp;<span class="builtinfunc" id="3413149">append</span><span class="op" id="3413155">(</span><span class="ident" id="3413156">inst</span><span class="op" id="3413160">.</span><span class="ident" id="3413161">Next</span><span class="op" id="3413165">,</span>&nbsp;<span class="ident" id="3413167">inst</span><span class="op" id="3413171">.</span><span class="ident" id="3413172">Out</span><span class="op" id="3413175">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3413180">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3413184">case</span>&nbsp;<span class="ident" id="3413189">syntax</span><span class="op" id="3413195">.</span><span class="ident" id="3413196">InstMatch</span><span class="op" id="3413205">,</span>&nbsp;<span class="ident" id="3413207">syntax</span><span class="op" id="3413213">.</span><span class="ident" id="3413214">InstFail</span><span class="op" id="3413222">:</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3413227">m</span><span class="op" id="3413228">[</span><span class="ident" id="3413229">pc</span><span class="op" id="3413231">]</span>&nbsp;<span class="op" id="3413233">=</span>&nbsp;<span class="ident" id="3413235">inst</span><span class="op" id="3413239">.</span><span class="ident" id="3413240">Op</span>&nbsp;<span class="op" id="3413243">==</span>&nbsp;<span class="ident" id="3413246">syntax</span><span class="op" id="3413252">.</span><span class="ident" id="3413253">InstMatch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3413266">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3413274">case</span>&nbsp;<span class="ident" id="3413279">syntax</span><span class="op" id="3413285">.</span><span class="ident" id="3413286">InstRune</span><span class="op" id="3413294">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3413299">ok</span>&nbsp;<span class="op" id="3413302">=</span>&nbsp;<span class="ident" id="3413304">check</span><span class="op" id="3413309">(</span><span class="ident" id="3413310">inst</span><span class="op" id="3413314">.</span><span class="ident" id="3413315">Out</span><span class="op" id="3413318">,</span>&nbsp;<span class="ident" id="3413320">m</span><span class="op" id="3413321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3413326">m</span><span class="op" id="3413327">[</span><span class="ident" id="3413328">pc</span><span class="op" id="3413330">]</span>&nbsp;<span class="op" id="3413332">=</span>&nbsp;<span class="builtintype" id="3413334">false</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3413343">if</span>&nbsp;<span class="builtinfunc" id="3413346">len</span><span class="op" id="3413349">(</span><span class="ident" id="3413350">inst</span><span class="op" id="3413354">.</span><span class="ident" id="3413355">Next</span><span class="op" id="3413359">)</span>&nbsp;<span class="op" id="3413361">&gt;</span>&nbsp;<span class="num" id="3413363">0</span>&nbsp;<span class="op" id="3413365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3413371">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3413380">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3413385">if</span>&nbsp;<span class="builtinfunc" id="3413388">len</span><span class="op" id="3413391">(</span><span class="ident" id="3413392">inst</span><span class="op" id="3413396">.</span><span class="ident" id="3413397">Rune</span><span class="op" id="3413401">)</span>&nbsp;<span class="op" id="3413403">==</span>&nbsp;<span class="num" id="3413406">0</span>&nbsp;<span class="op" id="3413408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3413414">onePassRunes</span><span class="op" id="3413426">[</span><span class="ident" id="3413427">pc</span><span class="op" id="3413429">]</span>&nbsp;<span class="op" id="3413431">=</span>&nbsp;<span class="op" id="3413433">[</span><span class="op" id="3413434">]</span><span class="builtintype" id="3413435">rune</span><span class="op" id="3413439">{</span><span class="op" id="3413440">}</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3413446">inst</span><span class="op" id="3413450">.</span><span class="ident" id="3413451">Next</span>&nbsp;<span class="op" id="3413456">=</span>&nbsp;<span class="op" id="3413458">[</span><span class="op" id="3413459">]</span><span class="builtintype" id="3413460">uint32</span><span class="op" id="3413466">{</span><span class="ident" id="3413467">inst</span><span class="op" id="3413471">.</span><span class="ident" id="3413472">Out</span><span class="op" id="3413475">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3413481">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3413490">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3413495">runes</span>&nbsp;<span class="op" id="3413501">:=</span>&nbsp;<span class="builtinfunc" id="3413504">make</span><span class="op" id="3413508">(</span><span class="op" id="3413509">[</span><span class="op" id="3413510">]</span><span class="builtintype" id="3413511">rune</span><span class="op" id="3413515">,</span>&nbsp;<span class="num" id="3413517">0</span><span class="op" id="3413518">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3413523">if</span>&nbsp;<span class="builtinfunc" id="3413526">len</span><span class="op" id="3413529">(</span><span class="ident" id="3413530">inst</span><span class="op" id="3413534">.</span><span class="ident" id="3413535">Rune</span><span class="op" id="3413539">)</span>&nbsp;<span class="op" id="3413541">==</span>&nbsp;<span class="num" id="3413544">1</span>&nbsp;<span class="op" id="3413546">&amp;&amp;</span>&nbsp;<span class="ident" id="3413549">syntax</span><span class="op" id="3413555">.</span><span class="ident" id="3413556">Flags</span><span class="op" id="3413561">(</span><span class="ident" id="3413562">inst</span><span class="op" id="3413566">.</span><span class="ident" id="3413567">Arg</span><span class="op" id="3413570">)</span><span class="op" id="3413571">&amp;</span><span class="ident" id="3413572">syntax</span><span class="op" id="3413578">.</span><span class="ident" id="3413579">FoldCase</span>&nbsp;<span class="op" id="3413588">!=</span>&nbsp;<span class="num" id="3413591">0</span>&nbsp;<span class="op" id="3413593">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3413599">r0</span>&nbsp;<span class="op" id="3413602">:=</span>&nbsp;<span class="ident" id="3413605">inst</span><span class="op" id="3413609">.</span><span class="ident" id="3413610">Rune</span><span class="op" id="3413614">[</span><span class="num" id="3413615">0</span><span class="op" id="3413616">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3413622">runes</span>&nbsp;<span class="op" id="3413628">=</span>&nbsp;<span class="builtinfunc" id="3413630">append</span><span class="op" id="3413636">(</span><span class="ident" id="3413637">runes</span><span class="op" id="3413642">,</span>&nbsp;<span class="ident" id="3413644">r0</span><span class="op" id="3413646">,</span>&nbsp;<span class="ident" id="3413648">r0</span><span class="op" id="3413650">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3413656">for</span>&nbsp;<span class="ident" id="3413660">r1</span>&nbsp;<span class="op" id="3413663">:=</span>&nbsp;<span class="ident" id="3413666">unicode</span><span class="op" id="3413673">.</span><span class="ident" id="3413674">SimpleFold</span><span class="op" id="3413684">(</span><span class="ident" id="3413685">r0</span><span class="op" id="3413687">)</span><span class="op" id="3413688">;</span>&nbsp;<span class="ident" id="3413690">r1</span>&nbsp;<span class="op" id="3413693">!=</span>&nbsp;<span class="ident" id="3413696">r0</span><span class="op" id="3413698">;</span>&nbsp;<span class="ident" id="3413700">r1</span>&nbsp;<span class="op" id="3413703">=</span>&nbsp;<span class="ident" id="3413705">unicode</span><span class="op" id="3413712">.</span><span class="ident" id="3413713">SimpleFold</span><span class="op" id="3413723">(</span><span class="ident" id="3413724">r1</span><span class="op" id="3413726">)</span>&nbsp;<span class="op" id="3413728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3413735">runes</span>&nbsp;<span class="op" id="3413741">=</span>&nbsp;<span class="builtinfunc" id="3413743">append</span><span class="op" id="3413749">(</span><span class="ident" id="3413750">runes</span><span class="op" id="3413755">,</span>&nbsp;<span class="ident" id="3413757">r1</span><span class="op" id="3413759">,</span>&nbsp;<span class="ident" id="3413761">r1</span><span class="op" id="3413763">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3413769">}</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3413775">sort</span><span class="op" id="3413779">.</span><span class="ident" id="3413780">Sort</span><span class="op" id="3413784">(</span><span class="ident" id="3413785">runeSlice</span><span class="op" id="3413794">(</span><span class="ident" id="3413795">runes</span><span class="op" id="3413800">)</span><span class="op" id="3413801">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3413806">}</span>&nbsp;<span class="keyword" id="3413808">else</span>&nbsp;<span class="op" id="3413813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3413819">runes</span>&nbsp;<span class="op" id="3413825">=</span>&nbsp;<span class="builtinfunc" id="3413827">append</span><span class="op" id="3413833">(</span><span class="ident" id="3413834">runes</span><span class="op" id="3413839">,</span>&nbsp;<span class="ident" id="3413841">inst</span><span class="op" id="3413845">.</span><span class="ident" id="3413846">Rune</span><span class="op" id="3413850">...</span><span class="op" id="3413853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3413858">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3413863">onePassRunes</span><span class="op" id="3413875">[</span><span class="ident" id="3413876">pc</span><span class="op" id="3413878">]</span>&nbsp;<span class="op" id="3413880">=</span>&nbsp;<span class="ident" id="3413882">runes</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3413891">inst</span><span class="op" id="3413895">.</span><span class="ident" id="3413896">Next</span>&nbsp;<span class="op" id="3413901">=</span>&nbsp;<span class="op" id="3413903">[</span><span class="op" id="3413904">]</span><span class="builtintype" id="3413905">uint32</span><span class="op" id="3413911">{</span><span class="op" id="3413912">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3413917">for</span>&nbsp;<span class="ident" id="3413921">i</span>&nbsp;<span class="op" id="3413923">:=</span>&nbsp;<span class="builtinfunc" id="3413926">len</span><span class="op" id="3413929">(</span><span class="ident" id="3413930">onePassRunes</span><span class="op" id="3413942">[</span><span class="ident" id="3413943">pc</span><span class="op" id="3413945">]</span><span class="op" id="3413946">)</span>&nbsp;<span class="op" id="3413948">/</span>&nbsp;<span class="num" id="3413950">2</span><span class="op" id="3413951">;</span>&nbsp;<span class="ident" id="3413953">i</span>&nbsp;<span class="op" id="3413955">&gt;=</span>&nbsp;<span class="num" id="3413958">0</span><span class="op" id="3413959">;</span>&nbsp;<span class="ident" id="3413961">i</span><span class="op" id="3413962">--</span>&nbsp;<span class="op" id="3413965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3413971">inst</span><span class="op" id="3413975">.</span><span class="ident" id="3413976">Next</span>&nbsp;<span class="op" id="3413981">=</span>&nbsp;<span class="builtinfunc" id="3413983">append</span><span class="op" id="3413989">(</span><span class="ident" id="3413990">inst</span><span class="op" id="3413994">.</span><span class="ident" id="3413995">Next</span><span class="op" id="3413999">,</span>&nbsp;<span class="ident" id="3414001">inst</span><span class="op" id="3414005">.</span><span class="ident" id="3414006">Out</span><span class="op" id="3414009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3414014">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3414019">inst</span><span class="op" id="3414023">.</span><span class="ident" id="3414024">Op</span>&nbsp;<span class="op" id="3414027">=</span>&nbsp;<span class="ident" id="3414029">syntax</span><span class="op" id="3414035">.</span><span class="ident" id="3414036">InstRune</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3414047">case</span>&nbsp;<span class="ident" id="3414052">syntax</span><span class="op" id="3414058">.</span><span class="ident" id="3414059">InstRune1</span><span class="op" id="3414068">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3414073">ok</span>&nbsp;<span class="op" id="3414076">=</span>&nbsp;<span class="ident" id="3414078">check</span><span class="op" id="3414083">(</span><span class="ident" id="3414084">inst</span><span class="op" id="3414088">.</span><span class="ident" id="3414089">Out</span><span class="op" id="3414092">,</span>&nbsp;<span class="ident" id="3414094">m</span><span class="op" id="3414095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3414100">m</span><span class="op" id="3414101">[</span><span class="ident" id="3414102">pc</span><span class="op" id="3414104">]</span>&nbsp;<span class="op" id="3414106">=</span>&nbsp;<span class="builtintype" id="3414108">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3414117">if</span>&nbsp;<span class="builtinfunc" id="3414120">len</span><span class="op" id="3414123">(</span><span class="ident" id="3414124">inst</span><span class="op" id="3414128">.</span><span class="ident" id="3414129">Next</span><span class="op" id="3414133">)</span>&nbsp;<span class="op" id="3414135">&gt;</span>&nbsp;<span class="num" id="3414137">0</span>&nbsp;<span class="op" id="3414139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3414145">break</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3414154">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3414159">runes</span>&nbsp;<span class="op" id="3414165">:=</span>&nbsp;<span class="op" id="3414168">[</span><span class="op" id="3414169">]</span><span class="builtintype" id="3414170">rune</span><span class="op" id="3414174">{</span><span class="op" id="3414175">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3414180">//&nbsp;expand&nbsp;case-folded&nbsp;runes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3414211">if</span>&nbsp;<span class="ident" id="3414214">syntax</span><span class="op" id="3414220">.</span><span class="ident" id="3414221">Flags</span><span class="op" id="3414226">(</span><span class="ident" id="3414227">inst</span><span class="op" id="3414231">.</span><span class="ident" id="3414232">Arg</span><span class="op" id="3414235">)</span><span class="op" id="3414236">&amp;</span><span class="ident" id="3414237">syntax</span><span class="op" id="3414243">.</span><span class="ident" id="3414244">FoldCase</span>&nbsp;<span class="op" id="3414253">!=</span>&nbsp;<span class="num" id="3414256">0</span>&nbsp;<span class="op" id="3414258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3414264">r0</span>&nbsp;<span class="op" id="3414267">:=</span>&nbsp;<span class="ident" id="3414270">inst</span><span class="op" id="3414274">.</span><span class="ident" id="3414275">Rune</span><span class="op" id="3414279">[</span><span class="num" id="3414280">0</span><span class="op" id="3414281">]</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3414287">runes</span>&nbsp;<span class="op" id="3414293">=</span>&nbsp;<span class="builtinfunc" id="3414295">append</span><span class="op" id="3414301">(</span><span class="ident" id="3414302">runes</span><span class="op" id="3414307">,</span>&nbsp;<span class="ident" id="3414309">r0</span><span class="op" id="3414311">,</span>&nbsp;<span class="ident" id="3414313">r0</span><span class="op" id="3414315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3414321">for</span>&nbsp;<span class="ident" id="3414325">r1</span>&nbsp;<span class="op" id="3414328">:=</span>&nbsp;<span class="ident" id="3414331">unicode</span><span class="op" id="3414338">.</span><span class="ident" id="3414339">SimpleFold</span><span class="op" id="3414349">(</span><span class="ident" id="3414350">r0</span><span class="op" id="3414352">)</span><span class="op" id="3414353">;</span>&nbsp;<span class="ident" id="3414355">r1</span>&nbsp;<span class="op" id="3414358">!=</span>&nbsp;<span class="ident" id="3414361">r0</span><span class="op" id="3414363">;</span>&nbsp;<span class="ident" id="3414365">r1</span>&nbsp;<span class="op" id="3414368">=</span>&nbsp;<span class="ident" id="3414370">unicode</span><span class="op" id="3414377">.</span><span class="ident" id="3414378">SimpleFold</span><span class="op" id="3414388">(</span><span class="ident" id="3414389">r1</span><span class="op" id="3414391">)</span>&nbsp;<span class="op" id="3414393">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3414400">runes</span>&nbsp;<span class="op" id="3414406">=</span>&nbsp;<span class="builtinfunc" id="3414408">append</span><span class="op" id="3414414">(</span><span class="ident" id="3414415">runes</span><span class="op" id="3414420">,</span>&nbsp;<span class="ident" id="3414422">r1</span><span class="op" id="3414424">,</span>&nbsp;<span class="ident" id="3414426">r1</span><span class="op" id="3414428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3414434">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3414440">sort</span><span class="op" id="3414444">.</span><span class="ident" id="3414445">Sort</span><span class="op" id="3414449">(</span><span class="ident" id="3414450">runeSlice</span><span class="op" id="3414459">(</span><span class="ident" id="3414460">runes</span><span class="op" id="3414465">)</span><span class="op" id="3414466">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3414471">}</span>&nbsp;<span class="keyword" id="3414473">else</span>&nbsp;<span class="op" id="3414478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3414484">runes</span>&nbsp;<span class="op" id="3414490">=</span>&nbsp;<span class="builtinfunc" id="3414492">append</span><span class="op" id="3414498">(</span><span class="ident" id="3414499">runes</span><span class="op" id="3414504">,</span>&nbsp;<span class="ident" id="3414506">inst</span><span class="op" id="3414510">.</span><span class="ident" id="3414511">Rune</span><span class="op" id="3414515">[</span><span class="num" id="3414516">0</span><span class="op" id="3414517">]</span><span class="op" id="3414518">,</span>&nbsp;<span class="ident" id="3414520">inst</span><span class="op" id="3414524">.</span><span class="ident" id="3414525">Rune</span><span class="op" id="3414529">[</span><span class="num" id="3414530">0</span><span class="op" id="3414531">]</span><span class="op" id="3414532">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3414537">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3414542">onePassRunes</span><span class="op" id="3414554">[</span><span class="ident" id="3414555">pc</span><span class="op" id="3414557">]</span>&nbsp;<span class="op" id="3414559">=</span>&nbsp;<span class="ident" id="3414561">runes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3414570">inst</span><span class="op" id="3414574">.</span><span class="ident" id="3414575">Next</span>&nbsp;<span class="op" id="3414580">=</span>&nbsp;<span class="op" id="3414582">[</span><span class="op" id="3414583">]</span><span class="builtintype" id="3414584">uint32</span><span class="op" id="3414590">{</span><span class="op" id="3414591">}</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3414596">for</span>&nbsp;<span class="ident" id="3414600">i</span>&nbsp;<span class="op" id="3414602">:=</span>&nbsp;<span class="builtinfunc" id="3414605">len</span><span class="op" id="3414608">(</span><span class="ident" id="3414609">onePassRunes</span><span class="op" id="3414621">[</span><span class="ident" id="3414622">pc</span><span class="op" id="3414624">]</span><span class="op" id="3414625">)</span>&nbsp;<span class="op" id="3414627">/</span>&nbsp;<span class="num" id="3414629">2</span><span class="op" id="3414630">;</span>&nbsp;<span class="ident" id="3414632">i</span>&nbsp;<span class="op" id="3414634">&gt;=</span>&nbsp;<span class="num" id="3414637">0</span><span class="op" id="3414638">;</span>&nbsp;<span class="ident" id="3414640">i</span><span class="op" id="3414641">--</span>&nbsp;<span class="op" id="3414644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3414650">inst</span><span class="op" id="3414654">.</span><span class="ident" id="3414655">Next</span>&nbsp;<span class="op" id="3414660">=</span>&nbsp;<span class="builtinfunc" id="3414662">append</span><span class="op" id="3414668">(</span><span class="ident" id="3414669">inst</span><span class="op" id="3414673">.</span><span class="ident" id="3414674">Next</span><span class="op" id="3414678">,</span>&nbsp;<span class="ident" id="3414680">inst</span><span class="op" id="3414684">.</span><span class="ident" id="3414685">Out</span><span class="op" id="3414688">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3414693">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3414698">inst</span><span class="op" id="3414702">.</span><span class="ident" id="3414703">Op</span>&nbsp;<span class="op" id="3414706">=</span>&nbsp;<span class="ident" id="3414708">syntax</span><span class="op" id="3414714">.</span><span class="ident" id="3414715">InstRune</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3414726">case</span>&nbsp;<span class="ident" id="3414731">syntax</span><span class="op" id="3414737">.</span><span class="ident" id="3414738">InstRuneAny</span><span class="op" id="3414749">:</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3414754">ok</span>&nbsp;<span class="op" id="3414757">=</span>&nbsp;<span class="ident" id="3414759">check</span><span class="op" id="3414764">(</span><span class="ident" id="3414765">inst</span><span class="op" id="3414769">.</span><span class="ident" id="3414770">Out</span><span class="op" id="3414773">,</span>&nbsp;<span class="ident" id="3414775">m</span><span class="op" id="3414776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3414781">m</span><span class="op" id="3414782">[</span><span class="ident" id="3414783">pc</span><span class="op" id="3414785">]</span>&nbsp;<span class="op" id="3414787">=</span>&nbsp;<span class="builtintype" id="3414789">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3414798">if</span>&nbsp;<span class="builtinfunc" id="3414801">len</span><span class="op" id="3414804">(</span><span class="ident" id="3414805">inst</span><span class="op" id="3414809">.</span><span class="ident" id="3414810">Next</span><span class="op" id="3414814">)</span>&nbsp;<span class="op" id="3414816">&gt;</span>&nbsp;<span class="num" id="3414818">0</span>&nbsp;<span class="op" id="3414820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3414826">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3414835">}</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3414840">onePassRunes</span><span class="op" id="3414852">[</span><span class="ident" id="3414853">pc</span><span class="op" id="3414855">]</span>&nbsp;<span class="op" id="3414857">=</span>&nbsp;<span class="builtinfunc" id="3414859">append</span><span class="op" id="3414865">(</span><span class="op" id="3414866">[</span><span class="op" id="3414867">]</span><span class="builtintype" id="3414868">rune</span><span class="op" id="3414872">{</span><span class="op" id="3414873">}</span><span class="op" id="3414874">,</span>&nbsp;<span class="ident" id="3414876">anyRune</span><span class="op" id="3414883">...</span><span class="op" id="3414886">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3414891">inst</span><span class="op" id="3414895">.</span><span class="ident" id="3414896">Next</span>&nbsp;<span class="op" id="3414901">=</span>&nbsp;<span class="op" id="3414903">[</span><span class="op" id="3414904">]</span><span class="builtintype" id="3414905">uint32</span><span class="op" id="3414911">{</span><span class="ident" id="3414912">inst</span><span class="op" id="3414916">.</span><span class="ident" id="3414917">Out</span><span class="op" id="3414920">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3414924">case</span>&nbsp;<span class="ident" id="3414929">syntax</span><span class="op" id="3414935">.</span><span class="ident" id="3414936">InstRuneAnyNotNL</span><span class="op" id="3414952">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3414957">ok</span>&nbsp;<span class="op" id="3414960">=</span>&nbsp;<span class="ident" id="3414962">check</span><span class="op" id="3414967">(</span><span class="ident" id="3414968">inst</span><span class="op" id="3414972">.</span><span class="ident" id="3414973">Out</span><span class="op" id="3414976">,</span>&nbsp;<span class="ident" id="3414978">m</span><span class="op" id="3414979">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3414984">m</span><span class="op" id="3414985">[</span><span class="ident" id="3414986">pc</span><span class="op" id="3414988">]</span>&nbsp;<span class="op" id="3414990">=</span>&nbsp;<span class="builtintype" id="3414992">false</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3415001">if</span>&nbsp;<span class="builtinfunc" id="3415004">len</span><span class="op" id="3415007">(</span><span class="ident" id="3415008">inst</span><span class="op" id="3415012">.</span><span class="ident" id="3415013">Next</span><span class="op" id="3415017">)</span>&nbsp;<span class="op" id="3415019">&gt;</span>&nbsp;<span class="num" id="3415021">0</span>&nbsp;<span class="op" id="3415023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3415029">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3415038">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3415043">onePassRunes</span><span class="op" id="3415055">[</span><span class="ident" id="3415056">pc</span><span class="op" id="3415058">]</span>&nbsp;<span class="op" id="3415060">=</span>&nbsp;<span class="builtinfunc" id="3415062">append</span><span class="op" id="3415068">(</span><span class="op" id="3415069">[</span><span class="op" id="3415070">]</span><span class="builtintype" id="3415071">rune</span><span class="op" id="3415075">{</span><span class="op" id="3415076">}</span><span class="op" id="3415077">,</span>&nbsp;<span class="ident" id="3415079">anyRuneNotNL</span><span class="op" id="3415091">...</span><span class="op" id="3415094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3415099">inst</span><span class="op" id="3415103">.</span><span class="ident" id="3415104">Next</span>&nbsp;<span class="op" id="3415109">=</span>&nbsp;<span class="op" id="3415111">[</span><span class="op" id="3415112">]</span><span class="builtintype" id="3415113">uint32</span><span class="op" id="3415119">{</span><span class="op" id="3415120">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3415125">for</span>&nbsp;<span class="ident" id="3415129">i</span>&nbsp;<span class="op" id="3415131">:=</span>&nbsp;<span class="builtinfunc" id="3415134">len</span><span class="op" id="3415137">(</span><span class="ident" id="3415138">onePassRunes</span><span class="op" id="3415150">[</span><span class="ident" id="3415151">pc</span><span class="op" id="3415153">]</span><span class="op" id="3415154">)</span>&nbsp;<span class="op" id="3415156">/</span>&nbsp;<span class="num" id="3415158">2</span><span class="op" id="3415159">;</span>&nbsp;<span class="ident" id="3415161">i</span>&nbsp;<span class="op" id="3415163">&gt;=</span>&nbsp;<span class="num" id="3415166">0</span><span class="op" id="3415167">;</span>&nbsp;<span class="ident" id="3415169">i</span><span class="op" id="3415170">--</span>&nbsp;<span class="op" id="3415173">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3415179">inst</span><span class="op" id="3415183">.</span><span class="ident" id="3415184">Next</span>&nbsp;<span class="op" id="3415189">=</span>&nbsp;<span class="builtinfunc" id="3415191">append</span><span class="op" id="3415197">(</span><span class="ident" id="3415198">inst</span><span class="op" id="3415202">.</span><span class="ident" id="3415203">Next</span><span class="op" id="3415207">,</span>&nbsp;<span class="ident" id="3415209">inst</span><span class="op" id="3415213">.</span><span class="ident" id="3415214">Out</span><span class="op" id="3415217">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3415222">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3415226">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3415230">return</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3415238">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3415242">instQueue</span><span class="op" id="3415251">.</span><span class="ident" id="3415252">clear</span><span class="op" id="3415257">(</span><span class="op" id="3415258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3415261">instQueue</span><span class="op" id="3415270">.</span><span class="ident" id="3415271">insert</span><span class="op" id="3415277">(</span><span class="builtintype" id="3415278">uint32</span><span class="op" id="3415284">(</span><span class="ident" id="3415285">p</span><span class="op" id="3415286">.</span><span class="ident" id="3415287">Start</span><span class="op" id="3415292">)</span><span class="op" id="3415293">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3415296">m</span>&nbsp;<span class="op" id="3415298">:=</span>&nbsp;<span class="builtinfunc" id="3415301">make</span><span class="op" id="3415305">(</span><span class="keyword" id="3415306">map</span><span class="op" id="3415309">[</span><span class="builtintype" id="3415310">uint32</span><span class="op" id="3415316">]</span><span class="builtintype" id="3415317">bool</span><span class="op" id="3415321">,</span>&nbsp;<span class="builtinfunc" id="3415323">len</span><span class="op" id="3415326">(</span><span class="ident" id="3415327">p</span><span class="op" id="3415328">.</span><span class="ident" id="3415329">Inst</span><span class="op" id="3415333">)</span><span class="op" id="3415334">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3415337">for</span>&nbsp;<span class="op" id="3415341">!</span><span class="ident" id="3415342">instQueue</span><span class="op" id="3415351">.</span><span class="ident" id="3415352">empty</span><span class="op" id="3415357">(</span><span class="op" id="3415358">)</span>&nbsp;<span class="op" id="3415360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3415364">pc</span>&nbsp;<span class="op" id="3415367">:=</span>&nbsp;<span class="ident" id="3415370">instQueue</span><span class="op" id="3415379">.</span><span class="ident" id="3415380">next</span><span class="op" id="3415384">(</span><span class="op" id="3415385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3415389">inst</span>&nbsp;<span class="op" id="3415394">:=</span>&nbsp;<span class="ident" id="3415397">p</span><span class="op" id="3415398">.</span><span class="ident" id="3415399">Inst</span><span class="op" id="3415403">[</span><span class="ident" id="3415404">pc</span><span class="op" id="3415406">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3415410">visitQueue</span><span class="op" id="3415420">.</span><span class="ident" id="3415421">clear</span><span class="op" id="3415426">(</span><span class="op" id="3415427">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3415431">if</span>&nbsp;<span class="op" id="3415434">!</span><span class="ident" id="3415435">check</span><span class="op" id="3415440">(</span><span class="builtintype" id="3415441">uint32</span><span class="op" id="3415447">(</span><span class="ident" id="3415448">pc</span><span class="op" id="3415450">)</span><span class="op" id="3415451">,</span>&nbsp;<span class="ident" id="3415453">m</span><span class="op" id="3415454">)</span>&nbsp;<span class="op" id="3415456">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3415461">p</span>&nbsp;<span class="op" id="3415463">=</span>&nbsp;<span class="ident" id="3415465">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3415479">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3415487">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3415491">switch</span>&nbsp;<span class="ident" id="3415498">inst</span><span class="op" id="3415502">.</span><span class="ident" id="3415503">Op</span>&nbsp;<span class="op" id="3415506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3415510">case</span>&nbsp;<span class="ident" id="3415515">syntax</span><span class="op" id="3415521">.</span><span class="ident" id="3415522">InstAlt</span><span class="op" id="3415529">,</span>&nbsp;<span class="ident" id="3415531">syntax</span><span class="op" id="3415537">.</span><span class="ident" id="3415538">InstAltMatch</span><span class="op" id="3415550">:</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3415555">instQueue</span><span class="op" id="3415564">.</span><span class="ident" id="3415565">insert</span><span class="op" id="3415571">(</span><span class="ident" id="3415572">inst</span><span class="op" id="3415576">.</span><span class="ident" id="3415577">Out</span><span class="op" id="3415580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3415585">instQueue</span><span class="op" id="3415594">.</span><span class="ident" id="3415595">insert</span><span class="op" id="3415601">(</span><span class="ident" id="3415602">inst</span><span class="op" id="3415606">.</span><span class="ident" id="3415607">Arg</span><span class="op" id="3415610">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3415614">case</span>&nbsp;<span class="ident" id="3415619">syntax</span><span class="op" id="3415625">.</span><span class="ident" id="3415626">InstCapture</span><span class="op" id="3415637">,</span>&nbsp;<span class="ident" id="3415639">syntax</span><span class="op" id="3415645">.</span><span class="ident" id="3415646">InstEmptyWidth</span><span class="op" id="3415660">,</span>&nbsp;<span class="ident" id="3415662">syntax</span><span class="op" id="3415668">.</span><span class="ident" id="3415669">InstNop</span><span class="op" id="3415676">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3415681">instQueue</span><span class="op" id="3415690">.</span><span class="ident" id="3415691">insert</span><span class="op" id="3415697">(</span><span class="ident" id="3415698">inst</span><span class="op" id="3415702">.</span><span class="ident" id="3415703">Out</span><span class="op" id="3415706">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3415710">case</span>&nbsp;<span class="ident" id="3415715">syntax</span><span class="op" id="3415721">.</span><span class="ident" id="3415722">InstMatch</span><span class="op" id="3415731">:</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3415735">case</span>&nbsp;<span class="ident" id="3415740">syntax</span><span class="op" id="3415746">.</span><span class="ident" id="3415747">InstFail</span><span class="op" id="3415755">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3415759">case</span>&nbsp;<span class="ident" id="3415764">syntax</span><span class="op" id="3415770">.</span><span class="ident" id="3415771">InstRune</span><span class="op" id="3415779">,</span>&nbsp;<span class="ident" id="3415781">syntax</span><span class="op" id="3415787">.</span><span class="ident" id="3415788">InstRune1</span><span class="op" id="3415797">,</span>&nbsp;<span class="ident" id="3415799">syntax</span><span class="op" id="3415805">.</span><span class="ident" id="3415806">InstRuneAny</span><span class="op" id="3415817">,</span>&nbsp;<span class="ident" id="3415819">syntax</span><span class="op" id="3415825">.</span><span class="ident" id="3415826">InstRuneAnyNotNL</span><span class="op" id="3415842">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3415846">default</span><span class="op" id="3415853">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3415857">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3415860">}</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3415863">if</span>&nbsp;<span class="ident" id="3415866">p</span>&nbsp;<span class="op" id="3415868">!=</span>&nbsp;<span class="ident" id="3415871">notOnePass</span>&nbsp;<span class="op" id="3415882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3415886">for</span>&nbsp;<span class="ident" id="3415890">i</span>&nbsp;<span class="op" id="3415892">:=</span>&nbsp;<span class="keyword" id="3415895">range</span>&nbsp;<span class="ident" id="3415901">p</span><span class="op" id="3415902">.</span><span class="ident" id="3415903">Inst</span>&nbsp;<span class="op" id="3415908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3415913">p</span><span class="op" id="3415914">.</span><span class="ident" id="3415915">Inst</span><span class="op" id="3415919">[</span><span class="ident" id="3415920">i</span><span class="op" id="3415921">]</span><span class="op" id="3415922">.</span><span class="ident" id="3415923">Rune</span>&nbsp;<span class="op" id="3415928">=</span>&nbsp;<span class="ident" id="3415930">onePassRunes</span><span class="op" id="3415942">[</span><span class="ident" id="3415943">i</span><span class="op" id="3415944">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3415948">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3415951">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3415954">return</span>&nbsp;<span class="ident" id="3415961">p</span><br>
<span class="lineno"></span><span class="op" id="3415963">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3415966">//&nbsp;walk&nbsp;visits&nbsp;each&nbsp;Inst&nbsp;in&nbsp;the&nbsp;prog&nbsp;once,&nbsp;and&nbsp;applies&nbsp;the&nbsp;argument</span><br>
<span class="lineno"></span><span class="comment" id="3416034">//&nbsp;function(ip,&nbsp;next),&nbsp;in&nbsp;pre-order.</span><br>
<span class="lineno">495</span><span class="keyword" id="3416071">func</span>&nbsp;<span class="ident" id="3416076">walk</span><span class="op" id="3416080">(</span><span class="ident" id="3416081">prog</span>&nbsp;<span class="op" id="3416086">*</span><span class="ident" id="3416087">syntax</span><span class="op" id="3416093">.</span><span class="ident" id="3416094">Prog</span><span class="op" id="3416098">,</span>&nbsp;<span class="ident" id="3416100">funcs</span>&nbsp;<span class="op" id="3416106">...</span><span class="keyword" id="3416109">func</span><span class="op" id="3416113">(</span><span class="ident" id="3416114">ip</span><span class="op" id="3416116">,</span>&nbsp;<span class="ident" id="3416118">next</span>&nbsp;<span class="builtintype" id="3416123">uint32</span><span class="op" id="3416129">)</span><span class="op" id="3416130">)</span>&nbsp;<span class="op" id="3416132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3416135">var</span>&nbsp;<span class="ident" id="3416139">walk1</span>&nbsp;<span class="keyword" id="3416145">func</span><span class="op" id="3416149">(</span><span class="builtintype" id="3416150">uint32</span><span class="op" id="3416156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3416159">progQueue</span>&nbsp;<span class="op" id="3416169">:=</span>&nbsp;<span class="ident" id="3416172">newQueue</span><span class="op" id="3416180">(</span><span class="builtinfunc" id="3416181">len</span><span class="op" id="3416184">(</span><span class="ident" id="3416185">prog</span><span class="op" id="3416189">.</span><span class="ident" id="3416190">Inst</span><span class="op" id="3416194">)</span><span class="op" id="3416195">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3416198">walk1</span>&nbsp;<span class="op" id="3416204">=</span>&nbsp;<span class="keyword" id="3416206">func</span><span class="op" id="3416210">(</span><span class="ident" id="3416211">ip</span>&nbsp;<span class="builtintype" id="3416214">uint32</span><span class="op" id="3416220">)</span>&nbsp;<span class="op" id="3416222">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3416226">if</span>&nbsp;<span class="ident" id="3416229">progQueue</span><span class="op" id="3416238">.</span><span class="ident" id="3416239">contains</span><span class="op" id="3416247">(</span><span class="ident" id="3416248">ip</span><span class="op" id="3416250">)</span>&nbsp;<span class="op" id="3416252">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3416257">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3416266">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3416270">progQueue</span><span class="op" id="3416279">.</span><span class="ident" id="3416280">insert</span><span class="op" id="3416286">(</span><span class="ident" id="3416287">ip</span><span class="op" id="3416289">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3416293">inst</span>&nbsp;<span class="op" id="3416298">:=</span>&nbsp;<span class="ident" id="3416301">prog</span><span class="op" id="3416305">.</span><span class="ident" id="3416306">Inst</span><span class="op" id="3416310">[</span><span class="ident" id="3416311">ip</span><span class="op" id="3416313">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3416317">switch</span>&nbsp;<span class="ident" id="3416324">inst</span><span class="op" id="3416328">.</span><span class="ident" id="3416329">Op</span>&nbsp;<span class="op" id="3416332">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3416336">case</span>&nbsp;<span class="ident" id="3416341">syntax</span><span class="op" id="3416347">.</span><span class="ident" id="3416348">InstAlt</span><span class="op" id="3416355">,</span>&nbsp;<span class="ident" id="3416357">syntax</span><span class="op" id="3416363">.</span><span class="ident" id="3416364">InstAltMatch</span><span class="op" id="3416376">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3416381">for</span>&nbsp;<span class="ident" id="3416385">_</span><span class="op" id="3416386">,</span>&nbsp;<span class="ident" id="3416388">f</span>&nbsp;<span class="op" id="3416390">:=</span>&nbsp;<span class="keyword" id="3416393">range</span>&nbsp;<span class="ident" id="3416399">funcs</span>&nbsp;<span class="op" id="3416405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3416411">f</span><span class="op" id="3416412">(</span><span class="ident" id="3416413">ip</span><span class="op" id="3416415">,</span>&nbsp;<span class="ident" id="3416417">inst</span><span class="op" id="3416421">.</span><span class="ident" id="3416422">Out</span><span class="op" id="3416425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3416431">f</span><span class="op" id="3416432">(</span><span class="ident" id="3416433">ip</span><span class="op" id="3416435">,</span>&nbsp;<span class="ident" id="3416437">inst</span><span class="op" id="3416441">.</span><span class="ident" id="3416442">Arg</span><span class="op" id="3416445">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3416450">}</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3416455">walk1</span><span class="op" id="3416460">(</span><span class="ident" id="3416461">inst</span><span class="op" id="3416465">.</span><span class="ident" id="3416466">Out</span><span class="op" id="3416469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3416474">walk1</span><span class="op" id="3416479">(</span><span class="ident" id="3416480">inst</span><span class="op" id="3416484">.</span><span class="ident" id="3416485">Arg</span><span class="op" id="3416488">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3416492">default</span><span class="op" id="3416499">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3416504">for</span>&nbsp;<span class="ident" id="3416508">_</span><span class="op" id="3416509">,</span>&nbsp;<span class="ident" id="3416511">f</span>&nbsp;<span class="op" id="3416513">:=</span>&nbsp;<span class="keyword" id="3416516">range</span>&nbsp;<span class="ident" id="3416522">funcs</span>&nbsp;<span class="op" id="3416528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3416534">f</span><span class="op" id="3416535">(</span><span class="ident" id="3416536">ip</span><span class="op" id="3416538">,</span>&nbsp;<span class="ident" id="3416540">inst</span><span class="op" id="3416544">.</span><span class="ident" id="3416545">Out</span><span class="op" id="3416548">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3416553">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3416558">walk1</span><span class="op" id="3416563">(</span><span class="ident" id="3416564">inst</span><span class="op" id="3416568">.</span><span class="ident" id="3416569">Out</span><span class="op" id="3416572">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3416576">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3416579">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3416582">walk1</span><span class="op" id="3416587">(</span><span class="builtintype" id="3416588">uint32</span><span class="op" id="3416594">(</span><span class="ident" id="3416595">prog</span><span class="op" id="3416599">.</span><span class="ident" id="3416600">Start</span><span class="op" id="3416605">)</span><span class="op" id="3416606">)</span><br>
<span class="lineno">520</span><span class="op" id="3416608">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3416611">//&nbsp;find&nbsp;returns&nbsp;the&nbsp;Insts&nbsp;that&nbsp;match&nbsp;the&nbsp;argument&nbsp;predicate&nbsp;function</span><br>
<span class="lineno"></span><span class="keyword" id="3416680">func</span>&nbsp;<span class="ident" id="3416685">find</span><span class="op" id="3416689">(</span><span class="ident" id="3416690">prog</span>&nbsp;<span class="op" id="3416695">*</span><span class="ident" id="3416696">syntax</span><span class="op" id="3416702">.</span><span class="ident" id="3416703">Prog</span><span class="op" id="3416707">,</span>&nbsp;<span class="ident" id="3416709">f</span>&nbsp;<span class="keyword" id="3416711">func</span><span class="op" id="3416715">(</span><span class="op" id="3416716">*</span><span class="ident" id="3416717">syntax</span><span class="op" id="3416723">.</span><span class="ident" id="3416724">Prog</span><span class="op" id="3416728">,</span>&nbsp;<span class="builtintype" id="3416730">int</span><span class="op" id="3416733">)</span>&nbsp;<span class="builtintype" id="3416735">bool</span><span class="op" id="3416739">)</span>&nbsp;<span class="op" id="3416741">(</span><span class="ident" id="3416742">matches</span>&nbsp;<span class="op" id="3416750">[</span><span class="op" id="3416751">]</span><span class="builtintype" id="3416752">uint32</span><span class="op" id="3416758">)</span>&nbsp;<span class="op" id="3416760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3416763">matches</span>&nbsp;<span class="op" id="3416771">=</span>&nbsp;<span class="op" id="3416773">[</span><span class="op" id="3416774">]</span><span class="builtintype" id="3416775">uint32</span><span class="op" id="3416781">{</span><span class="op" id="3416782">}</span><br>
<span class="lineno">525</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3416786">for</span>&nbsp;<span class="ident" id="3416790">ip</span>&nbsp;<span class="op" id="3416793">:=</span>&nbsp;<span class="keyword" id="3416796">range</span>&nbsp;<span class="ident" id="3416802">prog</span><span class="op" id="3416806">.</span><span class="ident" id="3416807">Inst</span>&nbsp;<span class="op" id="3416812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3416816">if</span>&nbsp;<span class="ident" id="3416819">f</span><span class="op" id="3416820">(</span><span class="ident" id="3416821">prog</span><span class="op" id="3416825">,</span>&nbsp;<span class="ident" id="3416827">ip</span><span class="op" id="3416829">)</span>&nbsp;<span class="op" id="3416831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3416836">matches</span>&nbsp;<span class="op" id="3416844">=</span>&nbsp;<span class="builtinfunc" id="3416846">append</span><span class="op" id="3416852">(</span><span class="ident" id="3416853">matches</span><span class="op" id="3416860">,</span>&nbsp;<span class="builtintype" id="3416862">uint32</span><span class="op" id="3416868">(</span><span class="ident" id="3416869">ip</span><span class="op" id="3416871">)</span><span class="op" id="3416872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3416876">}</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3416879">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3416882">return</span><br>
<span class="lineno"></span><span class="op" id="3416889">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3416892">var</span>&nbsp;<span class="ident" id="3416896">notOnePass</span>&nbsp;<span class="op" id="3416907">*</span><span class="ident" id="3416908">onePassProg</span>&nbsp;<span class="op" id="3416920">=</span>&nbsp;<span class="builtintype" id="3416922">nil</span><br>
<span class="lineno">535</span><br>
<span class="lineno"></span><span class="comment" id="3416927">//&nbsp;compileOnePass&nbsp;returns&nbsp;a&nbsp;new&nbsp;*syntax.Prog&nbsp;suitable&nbsp;for&nbsp;onePass&nbsp;execution&nbsp;if&nbsp;the&nbsp;original&nbsp;Prog</span><br>
<span class="lineno"></span><span class="comment" id="3417024">//&nbsp;can&nbsp;be&nbsp;recharacterized&nbsp;as&nbsp;a&nbsp;one-pass&nbsp;regexp&nbsp;program,&nbsp;or&nbsp;syntax.notOnePass&nbsp;if&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3417108">//&nbsp;Prog&nbsp;cannot&nbsp;be&nbsp;converted.&nbsp;For&nbsp;a&nbsp;one&nbsp;pass&nbsp;prog,&nbsp;the&nbsp;fundamental&nbsp;condition&nbsp;that&nbsp;must</span><br>
<span class="lineno"></span><span class="comment" id="3417194">//&nbsp;be&nbsp;true&nbsp;is:&nbsp;at&nbsp;any&nbsp;InstAlt,&nbsp;there&nbsp;must&nbsp;be&nbsp;no&nbsp;ambiguity&nbsp;about&nbsp;what&nbsp;branch&nbsp;to&nbsp;&nbsp;take.</span><br>
<span class="lineno">540</span><span class="keyword" id="3417280">func</span>&nbsp;<span class="ident" id="3417285">compileOnePass</span><span class="op" id="3417299">(</span><span class="ident" id="3417300">prog</span>&nbsp;<span class="op" id="3417305">*</span><span class="ident" id="3417306">syntax</span><span class="op" id="3417312">.</span><span class="ident" id="3417313">Prog</span><span class="op" id="3417317">)</span>&nbsp;<span class="op" id="3417319">(</span><span class="ident" id="3417320">p</span>&nbsp;<span class="op" id="3417322">*</span><span class="ident" id="3417323">onePassProg</span><span class="op" id="3417334">)</span>&nbsp;<span class="op" id="3417336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3417339">if</span>&nbsp;<span class="ident" id="3417342">prog</span><span class="op" id="3417346">.</span><span class="ident" id="3417347">Start</span>&nbsp;<span class="op" id="3417353">==</span>&nbsp;<span class="num" id="3417356">0</span>&nbsp;<span class="op" id="3417358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3417362">return</span>&nbsp;<span class="ident" id="3417369">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3417381">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3417384">//&nbsp;onepass&nbsp;regexp&nbsp;is&nbsp;anchored</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3417415">if</span>&nbsp;<span class="ident" id="3417418">prog</span><span class="op" id="3417422">.</span><span class="ident" id="3417423">Inst</span><span class="op" id="3417427">[</span><span class="ident" id="3417428">prog</span><span class="op" id="3417432">.</span><span class="ident" id="3417433">Start</span><span class="op" id="3417438">]</span><span class="op" id="3417439">.</span><span class="ident" id="3417440">Op</span>&nbsp;<span class="op" id="3417443">!=</span>&nbsp;<span class="ident" id="3417446">syntax</span><span class="op" id="3417452">.</span><span class="ident" id="3417453">InstEmptyWidth</span>&nbsp;<span class="op" id="3417468">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3417473">syntax</span><span class="op" id="3417479">.</span><span class="ident" id="3417480">EmptyOp</span><span class="op" id="3417487">(</span><span class="ident" id="3417488">prog</span><span class="op" id="3417492">.</span><span class="ident" id="3417493">Inst</span><span class="op" id="3417497">[</span><span class="ident" id="3417498">prog</span><span class="op" id="3417502">.</span><span class="ident" id="3417503">Start</span><span class="op" id="3417508">]</span><span class="op" id="3417509">.</span><span class="ident" id="3417510">Arg</span><span class="op" id="3417513">)</span><span class="op" id="3417514">&amp;</span><span class="ident" id="3417515">syntax</span><span class="op" id="3417521">.</span><span class="ident" id="3417522">EmptyBeginText</span>&nbsp;<span class="op" id="3417537">!=</span>&nbsp;<span class="ident" id="3417540">syntax</span><span class="op" id="3417546">.</span><span class="ident" id="3417547">EmptyBeginText</span>&nbsp;<span class="op" id="3417562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3417566">return</span>&nbsp;<span class="ident" id="3417573">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3417585">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3417588">//&nbsp;every&nbsp;instruction&nbsp;leading&nbsp;to&nbsp;InstMatch&nbsp;must&nbsp;be&nbsp;EmptyEndText</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3417652">for</span>&nbsp;<span class="ident" id="3417656">_</span><span class="op" id="3417657">,</span>&nbsp;<span class="ident" id="3417659">inst</span>&nbsp;<span class="op" id="3417664">:=</span>&nbsp;<span class="keyword" id="3417667">range</span>&nbsp;<span class="ident" id="3417673">prog</span><span class="op" id="3417677">.</span><span class="ident" id="3417678">Inst</span>&nbsp;<span class="op" id="3417683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3417687">opOut</span>&nbsp;<span class="op" id="3417693">:=</span>&nbsp;<span class="ident" id="3417696">prog</span><span class="op" id="3417700">.</span><span class="ident" id="3417701">Inst</span><span class="op" id="3417705">[</span><span class="ident" id="3417706">inst</span><span class="op" id="3417710">.</span><span class="ident" id="3417711">Out</span><span class="op" id="3417714">]</span><span class="op" id="3417715">.</span><span class="ident" id="3417716">Op</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3417721">switch</span>&nbsp;<span class="ident" id="3417728">inst</span><span class="op" id="3417732">.</span><span class="ident" id="3417733">Op</span>&nbsp;<span class="op" id="3417736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3417740">default</span><span class="op" id="3417747">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3417752">if</span>&nbsp;<span class="ident" id="3417755">opOut</span>&nbsp;<span class="op" id="3417761">==</span>&nbsp;<span class="ident" id="3417764">syntax</span><span class="op" id="3417770">.</span><span class="ident" id="3417771">InstMatch</span>&nbsp;<span class="op" id="3417781">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3417787">return</span>&nbsp;<span class="ident" id="3417794">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3417808">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3417812">case</span>&nbsp;<span class="ident" id="3417817">syntax</span><span class="op" id="3417823">.</span><span class="ident" id="3417824">InstAlt</span><span class="op" id="3417831">,</span>&nbsp;<span class="ident" id="3417833">syntax</span><span class="op" id="3417839">.</span><span class="ident" id="3417840">InstAltMatch</span><span class="op" id="3417852">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3417857">if</span>&nbsp;<span class="ident" id="3417860">opOut</span>&nbsp;<span class="op" id="3417866">==</span>&nbsp;<span class="ident" id="3417869">syntax</span><span class="op" id="3417875">.</span><span class="ident" id="3417876">InstMatch</span>&nbsp;<span class="op" id="3417886">||</span>&nbsp;<span class="ident" id="3417889">prog</span><span class="op" id="3417893">.</span><span class="ident" id="3417894">Inst</span><span class="op" id="3417898">[</span><span class="ident" id="3417899">inst</span><span class="op" id="3417903">.</span><span class="ident" id="3417904">Arg</span><span class="op" id="3417907">]</span><span class="op" id="3417908">.</span><span class="ident" id="3417909">Op</span>&nbsp;<span class="op" id="3417912">==</span>&nbsp;<span class="ident" id="3417915">syntax</span><span class="op" id="3417921">.</span><span class="ident" id="3417922">InstMatch</span>&nbsp;<span class="op" id="3417932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3417938">return</span>&nbsp;<span class="ident" id="3417945">notOnePass</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3417959">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3417963">case</span>&nbsp;<span class="ident" id="3417968">syntax</span><span class="op" id="3417974">.</span><span class="ident" id="3417975">InstEmptyWidth</span><span class="op" id="3417989">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3417994">if</span>&nbsp;<span class="ident" id="3417997">opOut</span>&nbsp;<span class="op" id="3418003">==</span>&nbsp;<span class="ident" id="3418006">syntax</span><span class="op" id="3418012">.</span><span class="ident" id="3418013">InstMatch</span>&nbsp;<span class="op" id="3418023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3418029">if</span>&nbsp;<span class="ident" id="3418032">syntax</span><span class="op" id="3418038">.</span><span class="ident" id="3418039">EmptyOp</span><span class="op" id="3418046">(</span><span class="ident" id="3418047">inst</span><span class="op" id="3418051">.</span><span class="ident" id="3418052">Arg</span><span class="op" id="3418055">)</span><span class="op" id="3418056">&amp;</span><span class="ident" id="3418057">syntax</span><span class="op" id="3418063">.</span><span class="ident" id="3418064">EmptyEndText</span>&nbsp;<span class="op" id="3418077">==</span>&nbsp;<span class="ident" id="3418080">syntax</span><span class="op" id="3418086">.</span><span class="ident" id="3418087">EmptyEndText</span>&nbsp;<span class="op" id="3418100">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3418107">continue</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3418120">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3418126">return</span>&nbsp;<span class="ident" id="3418133">notOnePass</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3418147">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3418151">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3418154">}</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3418157">//&nbsp;Creates&nbsp;a&nbsp;slightly&nbsp;optimized&nbsp;copy&nbsp;of&nbsp;the&nbsp;original&nbsp;Prog</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3418216">//&nbsp;that&nbsp;cleans&nbsp;up&nbsp;some&nbsp;Prog&nbsp;idioms&nbsp;that&nbsp;block&nbsp;valid&nbsp;onepass&nbsp;programs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3418286">p</span>&nbsp;<span class="op" id="3418288">=</span>&nbsp;<span class="ident" id="3418290">onePassCopy</span><span class="op" id="3418301">(</span><span class="ident" id="3418302">prog</span><span class="op" id="3418306">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3418310">//&nbsp;checkAmbiguity&nbsp;on&nbsp;InstAlts,&nbsp;build&nbsp;onepass&nbsp;Prog&nbsp;if&nbsp;possible</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3418373">p</span>&nbsp;<span class="op" id="3418375">=</span>&nbsp;<span class="ident" id="3418377">makeOnePass</span><span class="op" id="3418388">(</span><span class="ident" id="3418389">p</span><span class="op" id="3418390">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3418394">if</span>&nbsp;<span class="ident" id="3418397">p</span>&nbsp;<span class="op" id="3418399">!=</span>&nbsp;<span class="ident" id="3418402">notOnePass</span>&nbsp;<span class="op" id="3418413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3418417">cleanupOnePass</span><span class="op" id="3418431">(</span><span class="ident" id="3418432">p</span><span class="op" id="3418433">,</span>&nbsp;<span class="ident" id="3418435">prog</span><span class="op" id="3418439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3418442">}</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3418445">return</span>&nbsp;<span class="ident" id="3418452">p</span><br>
<span class="lineno"></span><span class="op" id="3418454">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
