<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html" class="current">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3733312">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3733367">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3733421">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3733472">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;nacl&nbsp;netbsd&nbsp;openbsd&nbsp;solaris</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3733542">package</span>&nbsp;<span class="ident" id="3733550">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3733555">import</span>&nbsp;<span class="op" id="3733562">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3733565">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3733571">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3733577">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3733588">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3733603">&#34;syscall&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3733614">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3733621">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3733624">//&nbsp;Network&nbsp;file&nbsp;descriptor.</span><br>
<span class="lineno"></span><span class="keyword" id="3733652">type</span>&nbsp;<span class="ident" id="3733657">netFD</span>&nbsp;<span class="keyword" id="3733663">struct</span>&nbsp;<span class="op" id="3733670">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3733673">//&nbsp;locking/lifetime&nbsp;of&nbsp;sysfd&nbsp;+&nbsp;serialize&nbsp;access&nbsp;to&nbsp;Read&nbsp;and&nbsp;Write&nbsp;methods</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3733748">fdmu</span>&nbsp;<span class="ident" id="3733753">fdMutex</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3733763">//&nbsp;immutable&nbsp;until&nbsp;Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3733789">sysfd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3733801">int</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3733806">family</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3733818">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3733823">sotype</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3733835">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3733840">isConnected</span>&nbsp;<span class="builtintype" id="3733852">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3733858">net</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3733870">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3733878">laddr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3733890">Addr</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3733896">raddr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3733908">Addr</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3733915">//&nbsp;wait&nbsp;server</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3733931">pd</span>&nbsp;<span class="ident" id="3733934">pollDesc</span><br>
<span class="lineno"></span><span class="op" id="3733943">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="3733946">func</span>&nbsp;<span class="ident" id="3733951">sysInit</span><span class="op" id="3733958">(</span><span class="op" id="3733959">)</span>&nbsp;<span class="op" id="3733961">{</span><br>
<span class="lineno"></span><span class="op" id="3733963">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3733966">func</span>&nbsp;<span class="ident" id="3733971">dial</span><span class="op" id="3733975">(</span><span class="ident" id="3733976">network</span>&nbsp;<span class="builtintype" id="3733984">string</span><span class="op" id="3733990">,</span>&nbsp;<span class="ident" id="3733992">ra</span>&nbsp;<span class="ident" id="3733995">Addr</span><span class="op" id="3733999">,</span>&nbsp;<span class="ident" id="3734001">dialer</span>&nbsp;<span class="keyword" id="3734008">func</span><span class="op" id="3734012">(</span><span class="ident" id="3734013">time</span><span class="op" id="3734017">.</span><span class="ident" id="3734018">Time</span><span class="op" id="3734022">)</span>&nbsp;<span class="op" id="3734024">(</span><span class="ident" id="3734025">Conn</span><span class="op" id="3734029">,</span>&nbsp;<span class="builtintype" id="3734031">error</span><span class="op" id="3734036">)</span><span class="op" id="3734037">,</span>&nbsp;<span class="ident" id="3734039">deadline</span>&nbsp;<span class="ident" id="3734048">time</span><span class="op" id="3734052">.</span><span class="ident" id="3734053">Time</span><span class="op" id="3734057">)</span>&nbsp;<span class="op" id="3734059">(</span><span class="ident" id="3734060">Conn</span><span class="op" id="3734064">,</span>&nbsp;<span class="builtintype" id="3734066">error</span><span class="op" id="3734071">)</span>&nbsp;<span class="op" id="3734073">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3734076">return</span>&nbsp;<span class="ident" id="3734083">dialer</span><span class="op" id="3734089">(</span><span class="ident" id="3734090">deadline</span><span class="op" id="3734098">)</span><br>
<span class="lineno"></span><span class="op" id="3734100">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3734103">func</span>&nbsp;<span class="ident" id="3734108">newFD</span><span class="op" id="3734113">(</span><span class="ident" id="3734114">sysfd</span><span class="op" id="3734119">,</span>&nbsp;<span class="ident" id="3734121">family</span><span class="op" id="3734127">,</span>&nbsp;<span class="ident" id="3734129">sotype</span>&nbsp;<span class="builtintype" id="3734136">int</span><span class="op" id="3734139">,</span>&nbsp;<span class="ident" id="3734141">net</span>&nbsp;<span class="builtintype" id="3734145">string</span><span class="op" id="3734151">)</span>&nbsp;<span class="op" id="3734153">(</span><span class="op" id="3734154">*</span><span class="ident" id="3734155">netFD</span><span class="op" id="3734160">,</span>&nbsp;<span class="builtintype" id="3734162">error</span><span class="op" id="3734167">)</span>&nbsp;<span class="op" id="3734169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3734172">return</span>&nbsp;<span class="op" id="3734179">&amp;</span><span class="ident" id="3734180">netFD</span><span class="op" id="3734185">{</span><span class="ident" id="3734186">sysfd</span><span class="op" id="3734191">:</span>&nbsp;<span class="ident" id="3734193">sysfd</span><span class="op" id="3734198">,</span>&nbsp;<span class="ident" id="3734200">family</span><span class="op" id="3734206">:</span>&nbsp;<span class="ident" id="3734208">family</span><span class="op" id="3734214">,</span>&nbsp;<span class="ident" id="3734216">sotype</span><span class="op" id="3734222">:</span>&nbsp;<span class="ident" id="3734224">sotype</span><span class="op" id="3734230">,</span>&nbsp;<span class="ident" id="3734232">net</span><span class="op" id="3734235">:</span>&nbsp;<span class="ident" id="3734237">net</span><span class="op" id="3734240">}</span><span class="op" id="3734241">,</span>&nbsp;<span class="builtintype" id="3734243">nil</span><br>
<span class="lineno">45</span><span class="op" id="3734247">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3734250">func</span>&nbsp;<span class="op" id="3734255">(</span><span class="ident" id="3734256">fd</span>&nbsp;<span class="op" id="3734259">*</span><span class="ident" id="3734260">netFD</span><span class="op" id="3734265">)</span>&nbsp;<span class="ident" id="3734267">init</span><span class="op" id="3734271">(</span><span class="op" id="3734272">)</span>&nbsp;<span class="builtintype" id="3734274">error</span>&nbsp;<span class="op" id="3734280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3734283">if</span>&nbsp;<span class="ident" id="3734286">err</span>&nbsp;<span class="op" id="3734290">:=</span>&nbsp;<span class="ident" id="3734293">fd</span><span class="op" id="3734295">.</span><span class="ident" id="3734296">pd</span><span class="op" id="3734298">.</span><span class="ident" id="3734299">Init</span><span class="op" id="3734303">(</span><span class="ident" id="3734304">fd</span><span class="op" id="3734306">)</span><span class="op" id="3734307">;</span>&nbsp;<span class="ident" id="3734309">err</span>&nbsp;<span class="op" id="3734313">!=</span>&nbsp;<span class="builtintype" id="3734316">nil</span>&nbsp;<span class="op" id="3734320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3734324">return</span>&nbsp;<span class="ident" id="3734331">err</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3734336">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3734339">return</span>&nbsp;<span class="builtintype" id="3734346">nil</span><br>
<span class="lineno"></span><span class="op" id="3734350">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3734353">func</span>&nbsp;<span class="op" id="3734358">(</span><span class="ident" id="3734359">fd</span>&nbsp;<span class="op" id="3734362">*</span><span class="ident" id="3734363">netFD</span><span class="op" id="3734368">)</span>&nbsp;<span class="ident" id="3734370">setAddr</span><span class="op" id="3734377">(</span><span class="ident" id="3734378">laddr</span><span class="op" id="3734383">,</span>&nbsp;<span class="ident" id="3734385">raddr</span>&nbsp;<span class="ident" id="3734391">Addr</span><span class="op" id="3734395">)</span>&nbsp;<span class="op" id="3734397">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3734400">fd</span><span class="op" id="3734402">.</span><span class="ident" id="3734403">laddr</span>&nbsp;<span class="op" id="3734409">=</span>&nbsp;<span class="ident" id="3734411">laddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3734418">fd</span><span class="op" id="3734420">.</span><span class="ident" id="3734421">raddr</span>&nbsp;<span class="op" id="3734427">=</span>&nbsp;<span class="ident" id="3734429">raddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3734436">runtime</span><span class="op" id="3734443">.</span><span class="ident" id="3734444">SetFinalizer</span><span class="op" id="3734456">(</span><span class="ident" id="3734457">fd</span><span class="op" id="3734459">,</span>&nbsp;<span class="op" id="3734461">(</span><span class="op" id="3734462">*</span><span class="ident" id="3734463">netFD</span><span class="op" id="3734468">)</span><span class="op" id="3734469">.</span><span class="ident" id="3734470">Close</span><span class="op" id="3734475">)</span><br>
<span class="lineno"></span><span class="op" id="3734477">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="3734480">func</span>&nbsp;<span class="op" id="3734485">(</span><span class="ident" id="3734486">fd</span>&nbsp;<span class="op" id="3734489">*</span><span class="ident" id="3734490">netFD</span><span class="op" id="3734495">)</span>&nbsp;<span class="ident" id="3734497">name</span><span class="op" id="3734501">(</span><span class="op" id="3734502">)</span>&nbsp;<span class="builtintype" id="3734504">string</span>&nbsp;<span class="op" id="3734511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3734514">var</span>&nbsp;<span class="ident" id="3734518">ls</span><span class="op" id="3734520">,</span>&nbsp;<span class="ident" id="3734522">rs</span>&nbsp;<span class="builtintype" id="3734525">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3734533">if</span>&nbsp;<span class="ident" id="3734536">fd</span><span class="op" id="3734538">.</span><span class="ident" id="3734539">laddr</span>&nbsp;<span class="op" id="3734545">!=</span>&nbsp;<span class="builtintype" id="3734548">nil</span>&nbsp;<span class="op" id="3734552">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3734556">ls</span>&nbsp;<span class="op" id="3734559">=</span>&nbsp;<span class="ident" id="3734561">fd</span><span class="op" id="3734563">.</span><span class="ident" id="3734564">laddr</span><span class="op" id="3734569">.</span><span class="ident" id="3734570">String</span><span class="op" id="3734576">(</span><span class="op" id="3734577">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3734580">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3734583">if</span>&nbsp;<span class="ident" id="3734586">fd</span><span class="op" id="3734588">.</span><span class="ident" id="3734589">raddr</span>&nbsp;<span class="op" id="3734595">!=</span>&nbsp;<span class="builtintype" id="3734598">nil</span>&nbsp;<span class="op" id="3734602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3734606">rs</span>&nbsp;<span class="op" id="3734609">=</span>&nbsp;<span class="ident" id="3734611">fd</span><span class="op" id="3734613">.</span><span class="ident" id="3734614">raddr</span><span class="op" id="3734619">.</span><span class="ident" id="3734620">String</span><span class="op" id="3734626">(</span><span class="op" id="3734627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3734630">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3734633">return</span>&nbsp;<span class="ident" id="3734640">fd</span><span class="op" id="3734642">.</span><span class="ident" id="3734643">net</span>&nbsp;<span class="op" id="3734647">+</span>&nbsp;<span class="string" id="3734649">&#34;:&#34;</span>&nbsp;<span class="op" id="3734653">+</span>&nbsp;<span class="ident" id="3734655">ls</span>&nbsp;<span class="op" id="3734658">+</span>&nbsp;<span class="string" id="3734660">&#34;-&gt;&#34;</span>&nbsp;<span class="op" id="3734665">+</span>&nbsp;<span class="ident" id="3734667">rs</span><br>
<span class="lineno"></span><span class="op" id="3734670">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="keyword" id="3734673">func</span>&nbsp;<span class="op" id="3734678">(</span><span class="ident" id="3734679">fd</span>&nbsp;<span class="op" id="3734682">*</span><span class="ident" id="3734683">netFD</span><span class="op" id="3734688">)</span>&nbsp;<span class="ident" id="3734690">connect</span><span class="op" id="3734697">(</span><span class="ident" id="3734698">la</span><span class="op" id="3734700">,</span>&nbsp;<span class="ident" id="3734702">ra</span>&nbsp;<span class="ident" id="3734705">syscall</span><span class="op" id="3734712">.</span><span class="ident" id="3734713">Sockaddr</span><span class="op" id="3734721">,</span>&nbsp;<span class="ident" id="3734723">deadline</span>&nbsp;<span class="ident" id="3734732">time</span><span class="op" id="3734736">.</span><span class="ident" id="3734737">Time</span><span class="op" id="3734741">)</span>&nbsp;<span class="builtintype" id="3734743">error</span>&nbsp;<span class="op" id="3734749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3734752">//&nbsp;Do&nbsp;not&nbsp;need&nbsp;to&nbsp;call&nbsp;fd.writeLock&nbsp;here,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3734795">//&nbsp;because&nbsp;fd&nbsp;is&nbsp;not&nbsp;yet&nbsp;accessible&nbsp;to&nbsp;user,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3734841">//&nbsp;so&nbsp;no&nbsp;concurrent&nbsp;operations&nbsp;are&nbsp;possible.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3734887">switch</span>&nbsp;<span class="ident" id="3734894">err</span>&nbsp;<span class="op" id="3734898">:=</span>&nbsp;<span class="ident" id="3734901">syscall</span><span class="op" id="3734908">.</span><span class="ident" id="3734909">Connect</span><span class="op" id="3734916">(</span><span class="ident" id="3734917">fd</span><span class="op" id="3734919">.</span><span class="ident" id="3734920">sysfd</span><span class="op" id="3734925">,</span>&nbsp;<span class="ident" id="3734927">ra</span><span class="op" id="3734929">)</span><span class="op" id="3734930">;</span>&nbsp;<span class="ident" id="3734932">err</span>&nbsp;<span class="op" id="3734936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3734939">case</span>&nbsp;<span class="ident" id="3734944">syscall</span><span class="op" id="3734951">.</span><span class="ident" id="3734952">EINPROGRESS</span><span class="op" id="3734963">,</span>&nbsp;<span class="ident" id="3734965">syscall</span><span class="op" id="3734972">.</span><span class="ident" id="3734973">EALREADY</span><span class="op" id="3734981">,</span>&nbsp;<span class="ident" id="3734983">syscall</span><span class="op" id="3734990">.</span><span class="ident" id="3734991">EINTR</span><span class="op" id="3734996">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3734999">case</span>&nbsp;<span class="builtintype" id="3735004">nil</span><span class="op" id="3735007">,</span>&nbsp;<span class="ident" id="3735009">syscall</span><span class="op" id="3735016">.</span><span class="ident" id="3735017">EISCONN</span><span class="op" id="3735024">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3735028">if</span>&nbsp;<span class="op" id="3735031">!</span><span class="ident" id="3735032">deadline</span><span class="op" id="3735040">.</span><span class="ident" id="3735041">IsZero</span><span class="op" id="3735047">(</span><span class="op" id="3735048">)</span>&nbsp;<span class="op" id="3735050">&amp;&amp;</span>&nbsp;<span class="ident" id="3735053">deadline</span><span class="op" id="3735061">.</span><span class="ident" id="3735062">Before</span><span class="op" id="3735068">(</span><span class="ident" id="3735069">time</span><span class="op" id="3735073">.</span><span class="ident" id="3735074">Now</span><span class="op" id="3735077">(</span><span class="op" id="3735078">)</span><span class="op" id="3735079">)</span>&nbsp;<span class="op" id="3735081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3735086">return</span>&nbsp;<span class="ident" id="3735093">errTimeout</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3735106">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3735110">if</span>&nbsp;<span class="ident" id="3735113">err</span>&nbsp;<span class="op" id="3735117">:=</span>&nbsp;<span class="ident" id="3735120">fd</span><span class="op" id="3735122">.</span><span class="ident" id="3735123">init</span><span class="op" id="3735127">(</span><span class="op" id="3735128">)</span><span class="op" id="3735129">;</span>&nbsp;<span class="ident" id="3735131">err</span>&nbsp;<span class="op" id="3735135">!=</span>&nbsp;<span class="builtintype" id="3735138">nil</span>&nbsp;<span class="op" id="3735142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3735147">return</span>&nbsp;<span class="ident" id="3735154">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3735160">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3735164">return</span>&nbsp;<span class="builtintype" id="3735171">nil</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3735176">case</span>&nbsp;<span class="ident" id="3735181">syscall</span><span class="op" id="3735188">.</span><span class="ident" id="3735189">EINVAL</span><span class="op" id="3735195">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3735199">//&nbsp;On&nbsp;Solaris&nbsp;we&nbsp;can&nbsp;see&nbsp;EINVAL&nbsp;if&nbsp;the&nbsp;socket&nbsp;has</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3735251">//&nbsp;already&nbsp;been&nbsp;accepted&nbsp;and&nbsp;closed&nbsp;by&nbsp;the&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3735304">//&nbsp;Treat&nbsp;this&nbsp;as&nbsp;a&nbsp;successful&nbsp;connection--writes&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3735358">//&nbsp;the&nbsp;socket&nbsp;will&nbsp;see&nbsp;EOF.&nbsp;&nbsp;For&nbsp;details&nbsp;and&nbsp;a&nbsp;test</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3735412">//&nbsp;case&nbsp;in&nbsp;C&nbsp;see&nbsp;http://golang.org/issue/6828.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3735461">if</span>&nbsp;<span class="ident" id="3735464">runtime</span><span class="op" id="3735471">.</span><span class="ident" id="3735472">GOOS</span>&nbsp;<span class="op" id="3735477">==</span>&nbsp;<span class="string" id="3735480">&#34;solaris&#34;</span>&nbsp;<span class="op" id="3735490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3735495">return</span>&nbsp;<span class="builtintype" id="3735502">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3735508">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3735512">fallthrough</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3735525">default</span><span class="op" id="3735532">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3735536">return</span>&nbsp;<span class="ident" id="3735543">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3735548">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3735551">if</span>&nbsp;<span class="ident" id="3735554">err</span>&nbsp;<span class="op" id="3735558">:=</span>&nbsp;<span class="ident" id="3735561">fd</span><span class="op" id="3735563">.</span><span class="ident" id="3735564">init</span><span class="op" id="3735568">(</span><span class="op" id="3735569">)</span><span class="op" id="3735570">;</span>&nbsp;<span class="ident" id="3735572">err</span>&nbsp;<span class="op" id="3735576">!=</span>&nbsp;<span class="builtintype" id="3735579">nil</span>&nbsp;<span class="op" id="3735583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3735587">return</span>&nbsp;<span class="ident" id="3735594">err</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3735599">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3735602">if</span>&nbsp;<span class="op" id="3735605">!</span><span class="ident" id="3735606">deadline</span><span class="op" id="3735614">.</span><span class="ident" id="3735615">IsZero</span><span class="op" id="3735621">(</span><span class="op" id="3735622">)</span>&nbsp;<span class="op" id="3735624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3735628">fd</span><span class="op" id="3735630">.</span><span class="ident" id="3735631">setWriteDeadline</span><span class="op" id="3735647">(</span><span class="ident" id="3735648">deadline</span><span class="op" id="3735656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3735660">defer</span>&nbsp;<span class="ident" id="3735666">fd</span><span class="op" id="3735668">.</span><span class="ident" id="3735669">setWriteDeadline</span><span class="op" id="3735685">(</span><span class="ident" id="3735686">noDeadline</span><span class="op" id="3735696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3735699">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3735702">for</span>&nbsp;<span class="op" id="3735706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3735710">//&nbsp;Performing&nbsp;multiple&nbsp;connect&nbsp;system&nbsp;calls&nbsp;on&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3735761">//&nbsp;non-blocking&nbsp;socket&nbsp;under&nbsp;Unix&nbsp;variants&nbsp;does&nbsp;not</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3735815">//&nbsp;necessarily&nbsp;result&nbsp;in&nbsp;earlier&nbsp;errors&nbsp;being</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3735863">//&nbsp;returned.&nbsp;Instead,&nbsp;once&nbsp;runtime-integrated&nbsp;network</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3735919">//&nbsp;poller&nbsp;tells&nbsp;us&nbsp;that&nbsp;the&nbsp;socket&nbsp;is&nbsp;ready,&nbsp;get&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3735974">//&nbsp;SO_ERROR&nbsp;socket&nbsp;option&nbsp;to&nbsp;see&nbsp;if&nbsp;the&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3736027">//&nbsp;succeeded&nbsp;or&nbsp;failed.&nbsp;See&nbsp;issue&nbsp;7474&nbsp;for&nbsp;further</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3736080">//&nbsp;details.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3736094">if</span>&nbsp;<span class="ident" id="3736097">err</span>&nbsp;<span class="op" id="3736101">:=</span>&nbsp;<span class="ident" id="3736104">fd</span><span class="op" id="3736106">.</span><span class="ident" id="3736107">pd</span><span class="op" id="3736109">.</span><span class="ident" id="3736110">WaitWrite</span><span class="op" id="3736119">(</span><span class="op" id="3736120">)</span><span class="op" id="3736121">;</span>&nbsp;<span class="ident" id="3736123">err</span>&nbsp;<span class="op" id="3736127">!=</span>&nbsp;<span class="builtintype" id="3736130">nil</span>&nbsp;<span class="op" id="3736134">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3736139">return</span>&nbsp;<span class="ident" id="3736146">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3736152">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3736156">nerr</span><span class="op" id="3736160">,</span>&nbsp;<span class="ident" id="3736162">err</span>&nbsp;<span class="op" id="3736166">:=</span>&nbsp;<span class="ident" id="3736169">syscall</span><span class="op" id="3736176">.</span><span class="ident" id="3736177">GetsockoptInt</span><span class="op" id="3736190">(</span><span class="ident" id="3736191">fd</span><span class="op" id="3736193">.</span><span class="ident" id="3736194">sysfd</span><span class="op" id="3736199">,</span>&nbsp;<span class="ident" id="3736201">syscall</span><span class="op" id="3736208">.</span><span class="ident" id="3736209">SOL_SOCKET</span><span class="op" id="3736219">,</span>&nbsp;<span class="ident" id="3736221">syscall</span><span class="op" id="3736228">.</span><span class="ident" id="3736229">SO_ERROR</span><span class="op" id="3736237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3736241">if</span>&nbsp;<span class="ident" id="3736244">err</span>&nbsp;<span class="op" id="3736248">!=</span>&nbsp;<span class="builtintype" id="3736251">nil</span>&nbsp;<span class="op" id="3736255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3736260">return</span>&nbsp;<span class="ident" id="3736267">err</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3736273">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3736277">switch</span>&nbsp;<span class="ident" id="3736284">err</span>&nbsp;<span class="op" id="3736288">:=</span>&nbsp;<span class="ident" id="3736291">syscall</span><span class="op" id="3736298">.</span><span class="ident" id="3736299">Errno</span><span class="op" id="3736304">(</span><span class="ident" id="3736305">nerr</span><span class="op" id="3736309">)</span><span class="op" id="3736310">;</span>&nbsp;<span class="ident" id="3736312">err</span>&nbsp;<span class="op" id="3736316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3736320">case</span>&nbsp;<span class="ident" id="3736325">syscall</span><span class="op" id="3736332">.</span><span class="ident" id="3736333">EINPROGRESS</span><span class="op" id="3736344">,</span>&nbsp;<span class="ident" id="3736346">syscall</span><span class="op" id="3736353">.</span><span class="ident" id="3736354">EALREADY</span><span class="op" id="3736362">,</span>&nbsp;<span class="ident" id="3736364">syscall</span><span class="op" id="3736371">.</span><span class="ident" id="3736372">EINTR</span><span class="op" id="3736377">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3736381">case</span>&nbsp;<span class="ident" id="3736386">syscall</span><span class="op" id="3736393">.</span><span class="ident" id="3736394">Errno</span><span class="op" id="3736399">(</span><span class="num" id="3736400">0</span><span class="op" id="3736401">)</span><span class="op" id="3736402">,</span>&nbsp;<span class="ident" id="3736404">syscall</span><span class="op" id="3736411">.</span><span class="ident" id="3736412">EISCONN</span><span class="op" id="3736419">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3736424">return</span>&nbsp;<span class="builtintype" id="3736431">nil</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3736437">default</span><span class="op" id="3736444">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3736449">return</span>&nbsp;<span class="ident" id="3736456">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3736462">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3736465">}</span><br>
<span class="lineno"></span><span class="op" id="3736467">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span><span class="keyword" id="3736470">func</span>&nbsp;<span class="op" id="3736475">(</span><span class="ident" id="3736476">fd</span>&nbsp;<span class="op" id="3736479">*</span><span class="ident" id="3736480">netFD</span><span class="op" id="3736485">)</span>&nbsp;<span class="ident" id="3736487">destroy</span><span class="op" id="3736494">(</span><span class="op" id="3736495">)</span>&nbsp;<span class="op" id="3736497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3736500">//&nbsp;Poller&nbsp;may&nbsp;want&nbsp;to&nbsp;unregister&nbsp;fd&nbsp;in&nbsp;readiness&nbsp;notification&nbsp;mechanism,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3736574">//&nbsp;so&nbsp;this&nbsp;must&nbsp;be&nbsp;executed&nbsp;before&nbsp;closesocket.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3736623">fd</span><span class="op" id="3736625">.</span><span class="ident" id="3736626">pd</span><span class="op" id="3736628">.</span><span class="ident" id="3736629">Close</span><span class="op" id="3736634">(</span><span class="op" id="3736635">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3736638">closesocket</span><span class="op" id="3736649">(</span><span class="ident" id="3736650">fd</span><span class="op" id="3736652">.</span><span class="ident" id="3736653">sysfd</span><span class="op" id="3736658">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3736661">fd</span><span class="op" id="3736663">.</span><span class="ident" id="3736664">sysfd</span>&nbsp;<span class="op" id="3736670">=</span>&nbsp;<span class="op" id="3736672">-</span><span class="num" id="3736673">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3736676">runtime</span><span class="op" id="3736683">.</span><span class="ident" id="3736684">SetFinalizer</span><span class="op" id="3736696">(</span><span class="ident" id="3736697">fd</span><span class="op" id="3736699">,</span>&nbsp;<span class="builtintype" id="3736701">nil</span><span class="op" id="3736704">)</span><br>
<span class="lineno"></span><span class="op" id="3736706">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="comment" id="3736709">//&nbsp;Add&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;fd.</span><br>
<span class="lineno"></span><span class="comment" id="3736740">//&nbsp;Returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;fd&nbsp;cannot&nbsp;be&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="3736786">func</span>&nbsp;<span class="op" id="3736791">(</span><span class="ident" id="3736792">fd</span>&nbsp;<span class="op" id="3736795">*</span><span class="ident" id="3736796">netFD</span><span class="op" id="3736801">)</span>&nbsp;<span class="ident" id="3736803">incref</span><span class="op" id="3736809">(</span><span class="op" id="3736810">)</span>&nbsp;<span class="builtintype" id="3736812">error</span>&nbsp;<span class="op" id="3736818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3736821">if</span>&nbsp;<span class="op" id="3736824">!</span><span class="ident" id="3736825">fd</span><span class="op" id="3736827">.</span><span class="ident" id="3736828">fdmu</span><span class="op" id="3736832">.</span><span class="ident" id="3736833">Incref</span><span class="op" id="3736839">(</span><span class="op" id="3736840">)</span>&nbsp;<span class="op" id="3736842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3736846">return</span>&nbsp;<span class="ident" id="3736853">errClosing</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3736865">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3736868">return</span>&nbsp;<span class="builtintype" id="3736875">nil</span><br>
<span class="lineno"></span><span class="op" id="3736879">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3736882">//&nbsp;Remove&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;FD&nbsp;and&nbsp;close&nbsp;if&nbsp;we&#39;ve&nbsp;been&nbsp;asked&nbsp;to&nbsp;do&nbsp;so</span><br>
<span class="lineno">150</span><span class="comment" id="3736954">//&nbsp;(and&nbsp;there&nbsp;are&nbsp;no&nbsp;references&nbsp;left).</span><br>
<span class="lineno"></span><span class="keyword" id="3736993">func</span>&nbsp;<span class="op" id="3736998">(</span><span class="ident" id="3736999">fd</span>&nbsp;<span class="op" id="3737002">*</span><span class="ident" id="3737003">netFD</span><span class="op" id="3737008">)</span>&nbsp;<span class="ident" id="3737010">decref</span><span class="op" id="3737016">(</span><span class="op" id="3737017">)</span>&nbsp;<span class="op" id="3737019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3737022">if</span>&nbsp;<span class="ident" id="3737025">fd</span><span class="op" id="3737027">.</span><span class="ident" id="3737028">fdmu</span><span class="op" id="3737032">.</span><span class="ident" id="3737033">Decref</span><span class="op" id="3737039">(</span><span class="op" id="3737040">)</span>&nbsp;<span class="op" id="3737042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3737046">fd</span><span class="op" id="3737048">.</span><span class="ident" id="3737049">destroy</span><span class="op" id="3737056">(</span><span class="op" id="3737057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3737060">}</span><br>
<span class="lineno">155</span><span class="op" id="3737062">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3737065">//&nbsp;Add&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;fd&nbsp;and&nbsp;lock&nbsp;for&nbsp;reading.</span><br>
<span class="lineno"></span><span class="comment" id="3737117">//&nbsp;Returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;fd&nbsp;cannot&nbsp;be&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="3737163">func</span>&nbsp;<span class="op" id="3737168">(</span><span class="ident" id="3737169">fd</span>&nbsp;<span class="op" id="3737172">*</span><span class="ident" id="3737173">netFD</span><span class="op" id="3737178">)</span>&nbsp;<span class="ident" id="3737180">readLock</span><span class="op" id="3737188">(</span><span class="op" id="3737189">)</span>&nbsp;<span class="builtintype" id="3737191">error</span>&nbsp;<span class="op" id="3737197">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3737200">if</span>&nbsp;<span class="op" id="3737203">!</span><span class="ident" id="3737204">fd</span><span class="op" id="3737206">.</span><span class="ident" id="3737207">fdmu</span><span class="op" id="3737211">.</span><span class="ident" id="3737212">RWLock</span><span class="op" id="3737218">(</span><span class="builtintype" id="3737219">true</span><span class="op" id="3737223">)</span>&nbsp;<span class="op" id="3737225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3737229">return</span>&nbsp;<span class="ident" id="3737236">errClosing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3737248">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3737251">return</span>&nbsp;<span class="builtintype" id="3737258">nil</span><br>
<span class="lineno"></span><span class="op" id="3737262">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="comment" id="3737265">//&nbsp;Unlock&nbsp;for&nbsp;reading&nbsp;and&nbsp;remove&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;FD.</span><br>
<span class="lineno"></span><span class="keyword" id="3737322">func</span>&nbsp;<span class="op" id="3737327">(</span><span class="ident" id="3737328">fd</span>&nbsp;<span class="op" id="3737331">*</span><span class="ident" id="3737332">netFD</span><span class="op" id="3737337">)</span>&nbsp;<span class="ident" id="3737339">readUnlock</span><span class="op" id="3737349">(</span><span class="op" id="3737350">)</span>&nbsp;<span class="op" id="3737352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3737355">if</span>&nbsp;<span class="ident" id="3737358">fd</span><span class="op" id="3737360">.</span><span class="ident" id="3737361">fdmu</span><span class="op" id="3737365">.</span><span class="ident" id="3737366">RWUnlock</span><span class="op" id="3737374">(</span><span class="builtintype" id="3737375">true</span><span class="op" id="3737379">)</span>&nbsp;<span class="op" id="3737381">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3737385">fd</span><span class="op" id="3737387">.</span><span class="ident" id="3737388">destroy</span><span class="op" id="3737395">(</span><span class="op" id="3737396">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3737399">}</span><br>
<span class="lineno"></span><span class="op" id="3737401">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3737404">//&nbsp;Add&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;fd&nbsp;and&nbsp;lock&nbsp;for&nbsp;writing.</span><br>
<span class="lineno"></span><span class="comment" id="3737456">//&nbsp;Returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;fd&nbsp;cannot&nbsp;be&nbsp;used.</span><br>
<span class="lineno">175</span><span class="keyword" id="3737502">func</span>&nbsp;<span class="op" id="3737507">(</span><span class="ident" id="3737508">fd</span>&nbsp;<span class="op" id="3737511">*</span><span class="ident" id="3737512">netFD</span><span class="op" id="3737517">)</span>&nbsp;<span class="ident" id="3737519">writeLock</span><span class="op" id="3737528">(</span><span class="op" id="3737529">)</span>&nbsp;<span class="builtintype" id="3737531">error</span>&nbsp;<span class="op" id="3737537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3737540">if</span>&nbsp;<span class="op" id="3737543">!</span><span class="ident" id="3737544">fd</span><span class="op" id="3737546">.</span><span class="ident" id="3737547">fdmu</span><span class="op" id="3737551">.</span><span class="ident" id="3737552">RWLock</span><span class="op" id="3737558">(</span><span class="builtintype" id="3737559">false</span><span class="op" id="3737564">)</span>&nbsp;<span class="op" id="3737566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3737570">return</span>&nbsp;<span class="ident" id="3737577">errClosing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3737589">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3737592">return</span>&nbsp;<span class="builtintype" id="3737599">nil</span><br>
<span class="lineno">180</span><span class="op" id="3737603">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3737606">//&nbsp;Unlock&nbsp;for&nbsp;writing&nbsp;and&nbsp;remove&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;FD.</span><br>
<span class="lineno"></span><span class="keyword" id="3737663">func</span>&nbsp;<span class="op" id="3737668">(</span><span class="ident" id="3737669">fd</span>&nbsp;<span class="op" id="3737672">*</span><span class="ident" id="3737673">netFD</span><span class="op" id="3737678">)</span>&nbsp;<span class="ident" id="3737680">writeUnlock</span><span class="op" id="3737691">(</span><span class="op" id="3737692">)</span>&nbsp;<span class="op" id="3737694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3737697">if</span>&nbsp;<span class="ident" id="3737700">fd</span><span class="op" id="3737702">.</span><span class="ident" id="3737703">fdmu</span><span class="op" id="3737707">.</span><span class="ident" id="3737708">RWUnlock</span><span class="op" id="3737716">(</span><span class="builtintype" id="3737717">false</span><span class="op" id="3737722">)</span>&nbsp;<span class="op" id="3737724">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3737728">fd</span><span class="op" id="3737730">.</span><span class="ident" id="3737731">destroy</span><span class="op" id="3737738">(</span><span class="op" id="3737739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3737742">}</span><br>
<span class="lineno"></span><span class="op" id="3737744">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3737747">func</span>&nbsp;<span class="op" id="3737752">(</span><span class="ident" id="3737753">fd</span>&nbsp;<span class="op" id="3737756">*</span><span class="ident" id="3737757">netFD</span><span class="op" id="3737762">)</span>&nbsp;<span class="ident" id="3737764">Close</span><span class="op" id="3737769">(</span><span class="op" id="3737770">)</span>&nbsp;<span class="builtintype" id="3737772">error</span>&nbsp;<span class="op" id="3737778">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3737781">fd</span><span class="op" id="3737783">.</span><span class="ident" id="3737784">pd</span><span class="op" id="3737786">.</span><span class="ident" id="3737787">Lock</span><span class="op" id="3737791">(</span><span class="op" id="3737792">)</span>&nbsp;<span class="comment" id="3737794">//&nbsp;needed&nbsp;for&nbsp;both&nbsp;fd.incref(true)&nbsp;and&nbsp;pollDesc.Evict</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3737849">if</span>&nbsp;<span class="op" id="3737852">!</span><span class="ident" id="3737853">fd</span><span class="op" id="3737855">.</span><span class="ident" id="3737856">fdmu</span><span class="op" id="3737860">.</span><span class="ident" id="3737861">IncrefAndClose</span><span class="op" id="3737875">(</span><span class="op" id="3737876">)</span>&nbsp;<span class="op" id="3737878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3737882">fd</span><span class="op" id="3737884">.</span><span class="ident" id="3737885">pd</span><span class="op" id="3737887">.</span><span class="ident" id="3737888">Unlock</span><span class="op" id="3737894">(</span><span class="op" id="3737895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3737899">return</span>&nbsp;<span class="ident" id="3737906">errClosing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3737918">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3737921">//&nbsp;Unblock&nbsp;any&nbsp;I/O.&nbsp;&nbsp;Once&nbsp;it&nbsp;all&nbsp;unblocks&nbsp;and&nbsp;returns,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3737977">//&nbsp;so&nbsp;that&nbsp;it&nbsp;cannot&nbsp;be&nbsp;referring&nbsp;to&nbsp;fd.sysfd&nbsp;anymore,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3738033">//&nbsp;the&nbsp;final&nbsp;decref&nbsp;will&nbsp;close&nbsp;fd.sysfd.&nbsp;&nbsp;This&nbsp;should&nbsp;happen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3738095">//&nbsp;fairly&nbsp;quickly,&nbsp;since&nbsp;all&nbsp;the&nbsp;I/O&nbsp;is&nbsp;non-blocking,&nbsp;and&nbsp;any</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3738158">//&nbsp;attempts&nbsp;to&nbsp;block&nbsp;in&nbsp;the&nbsp;pollDesc&nbsp;will&nbsp;return&nbsp;errClosing.</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3738220">doWakeup</span>&nbsp;<span class="op" id="3738229">:=</span>&nbsp;<span class="ident" id="3738232">fd</span><span class="op" id="3738234">.</span><span class="ident" id="3738235">pd</span><span class="op" id="3738237">.</span><span class="ident" id="3738238">Evict</span><span class="op" id="3738243">(</span><span class="op" id="3738244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3738247">fd</span><span class="op" id="3738249">.</span><span class="ident" id="3738250">pd</span><span class="op" id="3738252">.</span><span class="ident" id="3738253">Unlock</span><span class="op" id="3738259">(</span><span class="op" id="3738260">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3738263">fd</span><span class="op" id="3738265">.</span><span class="ident" id="3738266">decref</span><span class="op" id="3738272">(</span><span class="op" id="3738273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3738276">if</span>&nbsp;<span class="ident" id="3738279">doWakeup</span>&nbsp;<span class="op" id="3738288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3738292">fd</span><span class="op" id="3738294">.</span><span class="ident" id="3738295">pd</span><span class="op" id="3738297">.</span><span class="ident" id="3738298">Wakeup</span><span class="op" id="3738304">(</span><span class="op" id="3738305">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3738308">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3738311">return</span>&nbsp;<span class="builtintype" id="3738318">nil</span><br>
<span class="lineno"></span><span class="op" id="3738322">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3738325">func</span>&nbsp;<span class="op" id="3738330">(</span><span class="ident" id="3738331">fd</span>&nbsp;<span class="op" id="3738334">*</span><span class="ident" id="3738335">netFD</span><span class="op" id="3738340">)</span>&nbsp;<span class="ident" id="3738342">shutdown</span><span class="op" id="3738350">(</span><span class="ident" id="3738351">how</span>&nbsp;<span class="builtintype" id="3738355">int</span><span class="op" id="3738358">)</span>&nbsp;<span class="builtintype" id="3738360">error</span>&nbsp;<span class="op" id="3738366">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3738369">if</span>&nbsp;<span class="ident" id="3738372">err</span>&nbsp;<span class="op" id="3738376">:=</span>&nbsp;<span class="ident" id="3738379">fd</span><span class="op" id="3738381">.</span><span class="ident" id="3738382">incref</span><span class="op" id="3738388">(</span><span class="op" id="3738389">)</span><span class="op" id="3738390">;</span>&nbsp;<span class="ident" id="3738392">err</span>&nbsp;<span class="op" id="3738396">!=</span>&nbsp;<span class="builtintype" id="3738399">nil</span>&nbsp;<span class="op" id="3738403">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3738407">return</span>&nbsp;<span class="ident" id="3738414">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3738419">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3738422">defer</span>&nbsp;<span class="ident" id="3738428">fd</span><span class="op" id="3738430">.</span><span class="ident" id="3738431">decref</span><span class="op" id="3738437">(</span><span class="op" id="3738438">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3738441">err</span>&nbsp;<span class="op" id="3738445">:=</span>&nbsp;<span class="ident" id="3738448">syscall</span><span class="op" id="3738455">.</span><span class="ident" id="3738456">Shutdown</span><span class="op" id="3738464">(</span><span class="ident" id="3738465">fd</span><span class="op" id="3738467">.</span><span class="ident" id="3738468">sysfd</span><span class="op" id="3738473">,</span>&nbsp;<span class="ident" id="3738475">how</span><span class="op" id="3738478">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3738481">if</span>&nbsp;<span class="ident" id="3738484">err</span>&nbsp;<span class="op" id="3738488">!=</span>&nbsp;<span class="builtintype" id="3738491">nil</span>&nbsp;<span class="op" id="3738495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3738499">return</span>&nbsp;<span class="op" id="3738506">&amp;</span><span class="ident" id="3738507">OpError</span><span class="op" id="3738514">{</span><span class="string" id="3738515">&#34;shutdown&#34;</span><span class="op" id="3738525">,</span>&nbsp;<span class="ident" id="3738527">fd</span><span class="op" id="3738529">.</span><span class="ident" id="3738530">net</span><span class="op" id="3738533">,</span>&nbsp;<span class="ident" id="3738535">fd</span><span class="op" id="3738537">.</span><span class="ident" id="3738538">laddr</span><span class="op" id="3738543">,</span>&nbsp;<span class="ident" id="3738545">err</span><span class="op" id="3738548">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3738551">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3738554">return</span>&nbsp;<span class="builtintype" id="3738561">nil</span><br>
<span class="lineno"></span><span class="op" id="3738565">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="keyword" id="3738568">func</span>&nbsp;<span class="op" id="3738573">(</span><span class="ident" id="3738574">fd</span>&nbsp;<span class="op" id="3738577">*</span><span class="ident" id="3738578">netFD</span><span class="op" id="3738583">)</span>&nbsp;<span class="ident" id="3738585">closeRead</span><span class="op" id="3738594">(</span><span class="op" id="3738595">)</span>&nbsp;<span class="builtintype" id="3738597">error</span>&nbsp;<span class="op" id="3738603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3738606">return</span>&nbsp;<span class="ident" id="3738613">fd</span><span class="op" id="3738615">.</span><span class="ident" id="3738616">shutdown</span><span class="op" id="3738624">(</span><span class="ident" id="3738625">syscall</span><span class="op" id="3738632">.</span><span class="ident" id="3738633">SHUT_RD</span><span class="op" id="3738640">)</span><br>
<span class="lineno"></span><span class="op" id="3738642">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span><span class="keyword" id="3738645">func</span>&nbsp;<span class="op" id="3738650">(</span><span class="ident" id="3738651">fd</span>&nbsp;<span class="op" id="3738654">*</span><span class="ident" id="3738655">netFD</span><span class="op" id="3738660">)</span>&nbsp;<span class="ident" id="3738662">closeWrite</span><span class="op" id="3738672">(</span><span class="op" id="3738673">)</span>&nbsp;<span class="builtintype" id="3738675">error</span>&nbsp;<span class="op" id="3738681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3738684">return</span>&nbsp;<span class="ident" id="3738691">fd</span><span class="op" id="3738693">.</span><span class="ident" id="3738694">shutdown</span><span class="op" id="3738702">(</span><span class="ident" id="3738703">syscall</span><span class="op" id="3738710">.</span><span class="ident" id="3738711">SHUT_WR</span><span class="op" id="3738718">)</span><br>
<span class="lineno"></span><span class="op" id="3738720">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3738723">func</span>&nbsp;<span class="op" id="3738728">(</span><span class="ident" id="3738729">fd</span>&nbsp;<span class="op" id="3738732">*</span><span class="ident" id="3738733">netFD</span><span class="op" id="3738738">)</span>&nbsp;<span class="ident" id="3738740">Read</span><span class="op" id="3738744">(</span><span class="ident" id="3738745">p</span>&nbsp;<span class="op" id="3738747">[</span><span class="op" id="3738748">]</span><span class="builtintype" id="3738749">byte</span><span class="op" id="3738753">)</span>&nbsp;<span class="op" id="3738755">(</span><span class="ident" id="3738756">n</span>&nbsp;<span class="builtintype" id="3738758">int</span><span class="op" id="3738761">,</span>&nbsp;<span class="ident" id="3738763">err</span>&nbsp;<span class="builtintype" id="3738767">error</span><span class="op" id="3738772">)</span>&nbsp;<span class="op" id="3738774">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3738777">if</span>&nbsp;<span class="ident" id="3738780">err</span>&nbsp;<span class="op" id="3738784">:=</span>&nbsp;<span class="ident" id="3738787">fd</span><span class="op" id="3738789">.</span><span class="ident" id="3738790">readLock</span><span class="op" id="3738798">(</span><span class="op" id="3738799">)</span><span class="op" id="3738800">;</span>&nbsp;<span class="ident" id="3738802">err</span>&nbsp;<span class="op" id="3738806">!=</span>&nbsp;<span class="builtintype" id="3738809">nil</span>&nbsp;<span class="op" id="3738813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3738817">return</span>&nbsp;<span class="num" id="3738824">0</span><span class="op" id="3738825">,</span>&nbsp;<span class="ident" id="3738827">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3738832">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3738835">defer</span>&nbsp;<span class="ident" id="3738841">fd</span><span class="op" id="3738843">.</span><span class="ident" id="3738844">readUnlock</span><span class="op" id="3738854">(</span><span class="op" id="3738855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3738858">if</span>&nbsp;<span class="ident" id="3738861">err</span>&nbsp;<span class="op" id="3738865">:=</span>&nbsp;<span class="ident" id="3738868">fd</span><span class="op" id="3738870">.</span><span class="ident" id="3738871">pd</span><span class="op" id="3738873">.</span><span class="ident" id="3738874">PrepareRead</span><span class="op" id="3738885">(</span><span class="op" id="3738886">)</span><span class="op" id="3738887">;</span>&nbsp;<span class="ident" id="3738889">err</span>&nbsp;<span class="op" id="3738893">!=</span>&nbsp;<span class="builtintype" id="3738896">nil</span>&nbsp;<span class="op" id="3738900">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3738904">return</span>&nbsp;<span class="num" id="3738911">0</span><span class="op" id="3738912">,</span>&nbsp;<span class="op" id="3738914">&amp;</span><span class="ident" id="3738915">OpError</span><span class="op" id="3738922">{</span><span class="string" id="3738923">&#34;read&#34;</span><span class="op" id="3738929">,</span>&nbsp;<span class="ident" id="3738931">fd</span><span class="op" id="3738933">.</span><span class="ident" id="3738934">net</span><span class="op" id="3738937">,</span>&nbsp;<span class="ident" id="3738939">fd</span><span class="op" id="3738941">.</span><span class="ident" id="3738942">raddr</span><span class="op" id="3738947">,</span>&nbsp;<span class="ident" id="3738949">err</span><span class="op" id="3738952">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3738955">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3738958">for</span>&nbsp;<span class="op" id="3738962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3738966">n</span><span class="op" id="3738967">,</span>&nbsp;<span class="ident" id="3738969">err</span>&nbsp;<span class="op" id="3738973">=</span>&nbsp;<span class="ident" id="3738975">syscall</span><span class="op" id="3738982">.</span><span class="ident" id="3738983">Read</span><span class="op" id="3738987">(</span><span class="builtintype" id="3738988">int</span><span class="op" id="3738991">(</span><span class="ident" id="3738992">fd</span><span class="op" id="3738994">.</span><span class="ident" id="3738995">sysfd</span><span class="op" id="3739000">)</span><span class="op" id="3739001">,</span>&nbsp;<span class="ident" id="3739003">p</span><span class="op" id="3739004">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3739008">if</span>&nbsp;<span class="ident" id="3739011">err</span>&nbsp;<span class="op" id="3739015">!=</span>&nbsp;<span class="builtintype" id="3739018">nil</span>&nbsp;<span class="op" id="3739022">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3739027">n</span>&nbsp;<span class="op" id="3739029">=</span>&nbsp;<span class="num" id="3739031">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3739036">if</span>&nbsp;<span class="ident" id="3739039">err</span>&nbsp;<span class="op" id="3739043">==</span>&nbsp;<span class="ident" id="3739046">syscall</span><span class="op" id="3739053">.</span><span class="ident" id="3739054">EAGAIN</span>&nbsp;<span class="op" id="3739061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3739067">if</span>&nbsp;<span class="ident" id="3739070">err</span>&nbsp;<span class="op" id="3739074">=</span>&nbsp;<span class="ident" id="3739076">fd</span><span class="op" id="3739078">.</span><span class="ident" id="3739079">pd</span><span class="op" id="3739081">.</span><span class="ident" id="3739082">WaitRead</span><span class="op" id="3739090">(</span><span class="op" id="3739091">)</span><span class="op" id="3739092">;</span>&nbsp;<span class="ident" id="3739094">err</span>&nbsp;<span class="op" id="3739098">==</span>&nbsp;<span class="builtintype" id="3739101">nil</span>&nbsp;<span class="op" id="3739105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3739112">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3739125">}</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3739130">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3739134">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3739138">err</span>&nbsp;<span class="op" id="3739142">=</span>&nbsp;<span class="ident" id="3739144">chkReadErr</span><span class="op" id="3739154">(</span><span class="ident" id="3739155">n</span><span class="op" id="3739156">,</span>&nbsp;<span class="ident" id="3739158">err</span><span class="op" id="3739161">,</span>&nbsp;<span class="ident" id="3739163">fd</span><span class="op" id="3739165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3739169">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3739176">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3739179">if</span>&nbsp;<span class="ident" id="3739182">err</span>&nbsp;<span class="op" id="3739186">!=</span>&nbsp;<span class="builtintype" id="3739189">nil</span>&nbsp;<span class="op" id="3739193">&amp;&amp;</span>&nbsp;<span class="ident" id="3739196">err</span>&nbsp;<span class="op" id="3739200">!=</span>&nbsp;<span class="ident" id="3739203">io</span><span class="op" id="3739205">.</span><span class="ident" id="3739206">EOF</span>&nbsp;<span class="op" id="3739210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3739214">err</span>&nbsp;<span class="op" id="3739218">=</span>&nbsp;<span class="op" id="3739220">&amp;</span><span class="ident" id="3739221">OpError</span><span class="op" id="3739228">{</span><span class="string" id="3739229">&#34;read&#34;</span><span class="op" id="3739235">,</span>&nbsp;<span class="ident" id="3739237">fd</span><span class="op" id="3739239">.</span><span class="ident" id="3739240">net</span><span class="op" id="3739243">,</span>&nbsp;<span class="ident" id="3739245">fd</span><span class="op" id="3739247">.</span><span class="ident" id="3739248">raddr</span><span class="op" id="3739253">,</span>&nbsp;<span class="ident" id="3739255">err</span><span class="op" id="3739258">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3739261">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3739264">return</span><br>
<span class="lineno"></span><span class="op" id="3739271">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span><span class="keyword" id="3739274">func</span>&nbsp;<span class="op" id="3739279">(</span><span class="ident" id="3739280">fd</span>&nbsp;<span class="op" id="3739283">*</span><span class="ident" id="3739284">netFD</span><span class="op" id="3739289">)</span>&nbsp;<span class="ident" id="3739291">readFrom</span><span class="op" id="3739299">(</span><span class="ident" id="3739300">p</span>&nbsp;<span class="op" id="3739302">[</span><span class="op" id="3739303">]</span><span class="builtintype" id="3739304">byte</span><span class="op" id="3739308">)</span>&nbsp;<span class="op" id="3739310">(</span><span class="ident" id="3739311">n</span>&nbsp;<span class="builtintype" id="3739313">int</span><span class="op" id="3739316">,</span>&nbsp;<span class="ident" id="3739318">sa</span>&nbsp;<span class="ident" id="3739321">syscall</span><span class="op" id="3739328">.</span><span class="ident" id="3739329">Sockaddr</span><span class="op" id="3739337">,</span>&nbsp;<span class="ident" id="3739339">err</span>&nbsp;<span class="builtintype" id="3739343">error</span><span class="op" id="3739348">)</span>&nbsp;<span class="op" id="3739350">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3739353">if</span>&nbsp;<span class="ident" id="3739356">err</span>&nbsp;<span class="op" id="3739360">:=</span>&nbsp;<span class="ident" id="3739363">fd</span><span class="op" id="3739365">.</span><span class="ident" id="3739366">readLock</span><span class="op" id="3739374">(</span><span class="op" id="3739375">)</span><span class="op" id="3739376">;</span>&nbsp;<span class="ident" id="3739378">err</span>&nbsp;<span class="op" id="3739382">!=</span>&nbsp;<span class="builtintype" id="3739385">nil</span>&nbsp;<span class="op" id="3739389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3739393">return</span>&nbsp;<span class="num" id="3739400">0</span><span class="op" id="3739401">,</span>&nbsp;<span class="builtintype" id="3739403">nil</span><span class="op" id="3739406">,</span>&nbsp;<span class="ident" id="3739408">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3739413">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3739416">defer</span>&nbsp;<span class="ident" id="3739422">fd</span><span class="op" id="3739424">.</span><span class="ident" id="3739425">readUnlock</span><span class="op" id="3739435">(</span><span class="op" id="3739436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3739439">if</span>&nbsp;<span class="ident" id="3739442">err</span>&nbsp;<span class="op" id="3739446">:=</span>&nbsp;<span class="ident" id="3739449">fd</span><span class="op" id="3739451">.</span><span class="ident" id="3739452">pd</span><span class="op" id="3739454">.</span><span class="ident" id="3739455">PrepareRead</span><span class="op" id="3739466">(</span><span class="op" id="3739467">)</span><span class="op" id="3739468">;</span>&nbsp;<span class="ident" id="3739470">err</span>&nbsp;<span class="op" id="3739474">!=</span>&nbsp;<span class="builtintype" id="3739477">nil</span>&nbsp;<span class="op" id="3739481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3739485">return</span>&nbsp;<span class="num" id="3739492">0</span><span class="op" id="3739493">,</span>&nbsp;<span class="builtintype" id="3739495">nil</span><span class="op" id="3739498">,</span>&nbsp;<span class="op" id="3739500">&amp;</span><span class="ident" id="3739501">OpError</span><span class="op" id="3739508">{</span><span class="string" id="3739509">&#34;read&#34;</span><span class="op" id="3739515">,</span>&nbsp;<span class="ident" id="3739517">fd</span><span class="op" id="3739519">.</span><span class="ident" id="3739520">net</span><span class="op" id="3739523">,</span>&nbsp;<span class="ident" id="3739525">fd</span><span class="op" id="3739527">.</span><span class="ident" id="3739528">laddr</span><span class="op" id="3739533">,</span>&nbsp;<span class="ident" id="3739535">err</span><span class="op" id="3739538">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3739541">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3739544">for</span>&nbsp;<span class="op" id="3739548">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3739552">n</span><span class="op" id="3739553">,</span>&nbsp;<span class="ident" id="3739555">sa</span><span class="op" id="3739557">,</span>&nbsp;<span class="ident" id="3739559">err</span>&nbsp;<span class="op" id="3739563">=</span>&nbsp;<span class="ident" id="3739565">syscall</span><span class="op" id="3739572">.</span><span class="ident" id="3739573">Recvfrom</span><span class="op" id="3739581">(</span><span class="ident" id="3739582">fd</span><span class="op" id="3739584">.</span><span class="ident" id="3739585">sysfd</span><span class="op" id="3739590">,</span>&nbsp;<span class="ident" id="3739592">p</span><span class="op" id="3739593">,</span>&nbsp;<span class="num" id="3739595">0</span><span class="op" id="3739596">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3739600">if</span>&nbsp;<span class="ident" id="3739603">err</span>&nbsp;<span class="op" id="3739607">!=</span>&nbsp;<span class="builtintype" id="3739610">nil</span>&nbsp;<span class="op" id="3739614">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3739619">n</span>&nbsp;<span class="op" id="3739621">=</span>&nbsp;<span class="num" id="3739623">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3739628">if</span>&nbsp;<span class="ident" id="3739631">err</span>&nbsp;<span class="op" id="3739635">==</span>&nbsp;<span class="ident" id="3739638">syscall</span><span class="op" id="3739645">.</span><span class="ident" id="3739646">EAGAIN</span>&nbsp;<span class="op" id="3739653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3739659">if</span>&nbsp;<span class="ident" id="3739662">err</span>&nbsp;<span class="op" id="3739666">=</span>&nbsp;<span class="ident" id="3739668">fd</span><span class="op" id="3739670">.</span><span class="ident" id="3739671">pd</span><span class="op" id="3739673">.</span><span class="ident" id="3739674">WaitRead</span><span class="op" id="3739682">(</span><span class="op" id="3739683">)</span><span class="op" id="3739684">;</span>&nbsp;<span class="ident" id="3739686">err</span>&nbsp;<span class="op" id="3739690">==</span>&nbsp;<span class="builtintype" id="3739693">nil</span>&nbsp;<span class="op" id="3739697">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3739704">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3739717">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3739722">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3739726">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3739730">err</span>&nbsp;<span class="op" id="3739734">=</span>&nbsp;<span class="ident" id="3739736">chkReadErr</span><span class="op" id="3739746">(</span><span class="ident" id="3739747">n</span><span class="op" id="3739748">,</span>&nbsp;<span class="ident" id="3739750">err</span><span class="op" id="3739753">,</span>&nbsp;<span class="ident" id="3739755">fd</span><span class="op" id="3739757">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3739761">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3739768">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3739771">if</span>&nbsp;<span class="ident" id="3739774">err</span>&nbsp;<span class="op" id="3739778">!=</span>&nbsp;<span class="builtintype" id="3739781">nil</span>&nbsp;<span class="op" id="3739785">&amp;&amp;</span>&nbsp;<span class="ident" id="3739788">err</span>&nbsp;<span class="op" id="3739792">!=</span>&nbsp;<span class="ident" id="3739795">io</span><span class="op" id="3739797">.</span><span class="ident" id="3739798">EOF</span>&nbsp;<span class="op" id="3739802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3739806">err</span>&nbsp;<span class="op" id="3739810">=</span>&nbsp;<span class="op" id="3739812">&amp;</span><span class="ident" id="3739813">OpError</span><span class="op" id="3739820">{</span><span class="string" id="3739821">&#34;read&#34;</span><span class="op" id="3739827">,</span>&nbsp;<span class="ident" id="3739829">fd</span><span class="op" id="3739831">.</span><span class="ident" id="3739832">net</span><span class="op" id="3739835">,</span>&nbsp;<span class="ident" id="3739837">fd</span><span class="op" id="3739839">.</span><span class="ident" id="3739840">laddr</span><span class="op" id="3739845">,</span>&nbsp;<span class="ident" id="3739847">err</span><span class="op" id="3739850">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3739853">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3739856">return</span><br>
<span class="lineno"></span><span class="op" id="3739863">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3739866">func</span>&nbsp;<span class="op" id="3739871">(</span><span class="ident" id="3739872">fd</span>&nbsp;<span class="op" id="3739875">*</span><span class="ident" id="3739876">netFD</span><span class="op" id="3739881">)</span>&nbsp;<span class="ident" id="3739883">readMsg</span><span class="op" id="3739890">(</span><span class="ident" id="3739891">p</span>&nbsp;<span class="op" id="3739893">[</span><span class="op" id="3739894">]</span><span class="builtintype" id="3739895">byte</span><span class="op" id="3739899">,</span>&nbsp;<span class="ident" id="3739901">oob</span>&nbsp;<span class="op" id="3739905">[</span><span class="op" id="3739906">]</span><span class="builtintype" id="3739907">byte</span><span class="op" id="3739911">)</span>&nbsp;<span class="op" id="3739913">(</span><span class="ident" id="3739914">n</span><span class="op" id="3739915">,</span>&nbsp;<span class="ident" id="3739917">oobn</span><span class="op" id="3739921">,</span>&nbsp;<span class="ident" id="3739923">flags</span>&nbsp;<span class="builtintype" id="3739929">int</span><span class="op" id="3739932">,</span>&nbsp;<span class="ident" id="3739934">sa</span>&nbsp;<span class="ident" id="3739937">syscall</span><span class="op" id="3739944">.</span><span class="ident" id="3739945">Sockaddr</span><span class="op" id="3739953">,</span>&nbsp;<span class="ident" id="3739955">err</span>&nbsp;<span class="builtintype" id="3739959">error</span><span class="op" id="3739964">)</span>&nbsp;<span class="op" id="3739966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3739969">if</span>&nbsp;<span class="ident" id="3739972">err</span>&nbsp;<span class="op" id="3739976">:=</span>&nbsp;<span class="ident" id="3739979">fd</span><span class="op" id="3739981">.</span><span class="ident" id="3739982">readLock</span><span class="op" id="3739990">(</span><span class="op" id="3739991">)</span><span class="op" id="3739992">;</span>&nbsp;<span class="ident" id="3739994">err</span>&nbsp;<span class="op" id="3739998">!=</span>&nbsp;<span class="builtintype" id="3740001">nil</span>&nbsp;<span class="op" id="3740005">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3740009">return</span>&nbsp;<span class="num" id="3740016">0</span><span class="op" id="3740017">,</span>&nbsp;<span class="num" id="3740019">0</span><span class="op" id="3740020">,</span>&nbsp;<span class="num" id="3740022">0</span><span class="op" id="3740023">,</span>&nbsp;<span class="builtintype" id="3740025">nil</span><span class="op" id="3740028">,</span>&nbsp;<span class="ident" id="3740030">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3740035">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3740038">defer</span>&nbsp;<span class="ident" id="3740044">fd</span><span class="op" id="3740046">.</span><span class="ident" id="3740047">readUnlock</span><span class="op" id="3740057">(</span><span class="op" id="3740058">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3740061">if</span>&nbsp;<span class="ident" id="3740064">err</span>&nbsp;<span class="op" id="3740068">:=</span>&nbsp;<span class="ident" id="3740071">fd</span><span class="op" id="3740073">.</span><span class="ident" id="3740074">pd</span><span class="op" id="3740076">.</span><span class="ident" id="3740077">PrepareRead</span><span class="op" id="3740088">(</span><span class="op" id="3740089">)</span><span class="op" id="3740090">;</span>&nbsp;<span class="ident" id="3740092">err</span>&nbsp;<span class="op" id="3740096">!=</span>&nbsp;<span class="builtintype" id="3740099">nil</span>&nbsp;<span class="op" id="3740103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3740107">return</span>&nbsp;<span class="num" id="3740114">0</span><span class="op" id="3740115">,</span>&nbsp;<span class="num" id="3740117">0</span><span class="op" id="3740118">,</span>&nbsp;<span class="num" id="3740120">0</span><span class="op" id="3740121">,</span>&nbsp;<span class="builtintype" id="3740123">nil</span><span class="op" id="3740126">,</span>&nbsp;<span class="op" id="3740128">&amp;</span><span class="ident" id="3740129">OpError</span><span class="op" id="3740136">{</span><span class="string" id="3740137">&#34;read&#34;</span><span class="op" id="3740143">,</span>&nbsp;<span class="ident" id="3740145">fd</span><span class="op" id="3740147">.</span><span class="ident" id="3740148">net</span><span class="op" id="3740151">,</span>&nbsp;<span class="ident" id="3740153">fd</span><span class="op" id="3740155">.</span><span class="ident" id="3740156">laddr</span><span class="op" id="3740161">,</span>&nbsp;<span class="ident" id="3740163">err</span><span class="op" id="3740166">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3740169">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3740172">for</span>&nbsp;<span class="op" id="3740176">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3740180">n</span><span class="op" id="3740181">,</span>&nbsp;<span class="ident" id="3740183">oobn</span><span class="op" id="3740187">,</span>&nbsp;<span class="ident" id="3740189">flags</span><span class="op" id="3740194">,</span>&nbsp;<span class="ident" id="3740196">sa</span><span class="op" id="3740198">,</span>&nbsp;<span class="ident" id="3740200">err</span>&nbsp;<span class="op" id="3740204">=</span>&nbsp;<span class="ident" id="3740206">syscall</span><span class="op" id="3740213">.</span><span class="ident" id="3740214">Recvmsg</span><span class="op" id="3740221">(</span><span class="ident" id="3740222">fd</span><span class="op" id="3740224">.</span><span class="ident" id="3740225">sysfd</span><span class="op" id="3740230">,</span>&nbsp;<span class="ident" id="3740232">p</span><span class="op" id="3740233">,</span>&nbsp;<span class="ident" id="3740235">oob</span><span class="op" id="3740238">,</span>&nbsp;<span class="num" id="3740240">0</span><span class="op" id="3740241">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3740245">if</span>&nbsp;<span class="ident" id="3740248">err</span>&nbsp;<span class="op" id="3740252">!=</span>&nbsp;<span class="builtintype" id="3740255">nil</span>&nbsp;<span class="op" id="3740259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3740264">//&nbsp;TODO(dfc)&nbsp;should&nbsp;n&nbsp;and&nbsp;oobn&nbsp;be&nbsp;set&nbsp;to&nbsp;0</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3740310">if</span>&nbsp;<span class="ident" id="3740313">err</span>&nbsp;<span class="op" id="3740317">==</span>&nbsp;<span class="ident" id="3740320">syscall</span><span class="op" id="3740327">.</span><span class="ident" id="3740328">EAGAIN</span>&nbsp;<span class="op" id="3740335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3740341">if</span>&nbsp;<span class="ident" id="3740344">err</span>&nbsp;<span class="op" id="3740348">=</span>&nbsp;<span class="ident" id="3740350">fd</span><span class="op" id="3740352">.</span><span class="ident" id="3740353">pd</span><span class="op" id="3740355">.</span><span class="ident" id="3740356">WaitRead</span><span class="op" id="3740364">(</span><span class="op" id="3740365">)</span><span class="op" id="3740366">;</span>&nbsp;<span class="ident" id="3740368">err</span>&nbsp;<span class="op" id="3740372">==</span>&nbsp;<span class="builtintype" id="3740375">nil</span>&nbsp;<span class="op" id="3740379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3740386">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3740399">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3740404">}</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3740408">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3740412">err</span>&nbsp;<span class="op" id="3740416">=</span>&nbsp;<span class="ident" id="3740418">chkReadErr</span><span class="op" id="3740428">(</span><span class="ident" id="3740429">n</span><span class="op" id="3740430">,</span>&nbsp;<span class="ident" id="3740432">err</span><span class="op" id="3740435">,</span>&nbsp;<span class="ident" id="3740437">fd</span><span class="op" id="3740439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3740443">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3740450">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3740453">if</span>&nbsp;<span class="ident" id="3740456">err</span>&nbsp;<span class="op" id="3740460">!=</span>&nbsp;<span class="builtintype" id="3740463">nil</span>&nbsp;<span class="op" id="3740467">&amp;&amp;</span>&nbsp;<span class="ident" id="3740470">err</span>&nbsp;<span class="op" id="3740474">!=</span>&nbsp;<span class="ident" id="3740477">io</span><span class="op" id="3740479">.</span><span class="ident" id="3740480">EOF</span>&nbsp;<span class="op" id="3740484">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3740488">err</span>&nbsp;<span class="op" id="3740492">=</span>&nbsp;<span class="op" id="3740494">&amp;</span><span class="ident" id="3740495">OpError</span><span class="op" id="3740502">{</span><span class="string" id="3740503">&#34;read&#34;</span><span class="op" id="3740509">,</span>&nbsp;<span class="ident" id="3740511">fd</span><span class="op" id="3740513">.</span><span class="ident" id="3740514">net</span><span class="op" id="3740517">,</span>&nbsp;<span class="ident" id="3740519">fd</span><span class="op" id="3740521">.</span><span class="ident" id="3740522">laddr</span><span class="op" id="3740527">,</span>&nbsp;<span class="ident" id="3740529">err</span><span class="op" id="3740532">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3740535">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3740538">return</span><br>
<span class="lineno"></span><span class="op" id="3740545">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">310</span><span class="keyword" id="3740548">func</span>&nbsp;<span class="ident" id="3740553">chkReadErr</span><span class="op" id="3740563">(</span><span class="ident" id="3740564">n</span>&nbsp;<span class="builtintype" id="3740566">int</span><span class="op" id="3740569">,</span>&nbsp;<span class="ident" id="3740571">err</span>&nbsp;<span class="builtintype" id="3740575">error</span><span class="op" id="3740580">,</span>&nbsp;<span class="ident" id="3740582">fd</span>&nbsp;<span class="op" id="3740585">*</span><span class="ident" id="3740586">netFD</span><span class="op" id="3740591">)</span>&nbsp;<span class="builtintype" id="3740593">error</span>&nbsp;<span class="op" id="3740599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3740602">if</span>&nbsp;<span class="ident" id="3740605">n</span>&nbsp;<span class="op" id="3740607">==</span>&nbsp;<span class="num" id="3740610">0</span>&nbsp;<span class="op" id="3740612">&amp;&amp;</span>&nbsp;<span class="ident" id="3740615">err</span>&nbsp;<span class="op" id="3740619">==</span>&nbsp;<span class="builtintype" id="3740622">nil</span>&nbsp;<span class="op" id="3740626">&amp;&amp;</span>&nbsp;<span class="ident" id="3740629">fd</span><span class="op" id="3740631">.</span><span class="ident" id="3740632">sotype</span>&nbsp;<span class="op" id="3740639">!=</span>&nbsp;<span class="ident" id="3740642">syscall</span><span class="op" id="3740649">.</span><span class="ident" id="3740650">SOCK_DGRAM</span>&nbsp;<span class="op" id="3740661">&amp;&amp;</span>&nbsp;<span class="ident" id="3740664">fd</span><span class="op" id="3740666">.</span><span class="ident" id="3740667">sotype</span>&nbsp;<span class="op" id="3740674">!=</span>&nbsp;<span class="ident" id="3740677">syscall</span><span class="op" id="3740684">.</span><span class="ident" id="3740685">SOCK_RAW</span>&nbsp;<span class="op" id="3740694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3740698">return</span>&nbsp;<span class="ident" id="3740705">io</span><span class="op" id="3740707">.</span><span class="ident" id="3740708">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3740713">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3740716">return</span>&nbsp;<span class="ident" id="3740723">err</span><br>
<span class="lineno">315</span><span class="op" id="3740727">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3740730">func</span>&nbsp;<span class="op" id="3740735">(</span><span class="ident" id="3740736">fd</span>&nbsp;<span class="op" id="3740739">*</span><span class="ident" id="3740740">netFD</span><span class="op" id="3740745">)</span>&nbsp;<span class="ident" id="3740747">Write</span><span class="op" id="3740752">(</span><span class="ident" id="3740753">p</span>&nbsp;<span class="op" id="3740755">[</span><span class="op" id="3740756">]</span><span class="builtintype" id="3740757">byte</span><span class="op" id="3740761">)</span>&nbsp;<span class="op" id="3740763">(</span><span class="ident" id="3740764">nn</span>&nbsp;<span class="builtintype" id="3740767">int</span><span class="op" id="3740770">,</span>&nbsp;<span class="ident" id="3740772">err</span>&nbsp;<span class="builtintype" id="3740776">error</span><span class="op" id="3740781">)</span>&nbsp;<span class="op" id="3740783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3740786">if</span>&nbsp;<span class="ident" id="3740789">err</span>&nbsp;<span class="op" id="3740793">:=</span>&nbsp;<span class="ident" id="3740796">fd</span><span class="op" id="3740798">.</span><span class="ident" id="3740799">writeLock</span><span class="op" id="3740808">(</span><span class="op" id="3740809">)</span><span class="op" id="3740810">;</span>&nbsp;<span class="ident" id="3740812">err</span>&nbsp;<span class="op" id="3740816">!=</span>&nbsp;<span class="builtintype" id="3740819">nil</span>&nbsp;<span class="op" id="3740823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3740827">return</span>&nbsp;<span class="num" id="3740834">0</span><span class="op" id="3740835">,</span>&nbsp;<span class="ident" id="3740837">err</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3740842">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3740845">defer</span>&nbsp;<span class="ident" id="3740851">fd</span><span class="op" id="3740853">.</span><span class="ident" id="3740854">writeUnlock</span><span class="op" id="3740865">(</span><span class="op" id="3740866">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3740869">if</span>&nbsp;<span class="ident" id="3740872">err</span>&nbsp;<span class="op" id="3740876">:=</span>&nbsp;<span class="ident" id="3740879">fd</span><span class="op" id="3740881">.</span><span class="ident" id="3740882">pd</span><span class="op" id="3740884">.</span><span class="ident" id="3740885">PrepareWrite</span><span class="op" id="3740897">(</span><span class="op" id="3740898">)</span><span class="op" id="3740899">;</span>&nbsp;<span class="ident" id="3740901">err</span>&nbsp;<span class="op" id="3740905">!=</span>&nbsp;<span class="builtintype" id="3740908">nil</span>&nbsp;<span class="op" id="3740912">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3740916">return</span>&nbsp;<span class="num" id="3740923">0</span><span class="op" id="3740924">,</span>&nbsp;<span class="op" id="3740926">&amp;</span><span class="ident" id="3740927">OpError</span><span class="op" id="3740934">{</span><span class="string" id="3740935">&#34;write&#34;</span><span class="op" id="3740942">,</span>&nbsp;<span class="ident" id="3740944">fd</span><span class="op" id="3740946">.</span><span class="ident" id="3740947">net</span><span class="op" id="3740950">,</span>&nbsp;<span class="ident" id="3740952">fd</span><span class="op" id="3740954">.</span><span class="ident" id="3740955">raddr</span><span class="op" id="3740960">,</span>&nbsp;<span class="ident" id="3740962">err</span><span class="op" id="3740965">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3740968">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3740971">for</span>&nbsp;<span class="op" id="3740975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3740979">var</span>&nbsp;<span class="ident" id="3740983">n</span>&nbsp;<span class="builtintype" id="3740985">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3740991">n</span><span class="op" id="3740992">,</span>&nbsp;<span class="ident" id="3740994">err</span>&nbsp;<span class="op" id="3740998">=</span>&nbsp;<span class="ident" id="3741000">syscall</span><span class="op" id="3741007">.</span><span class="ident" id="3741008">Write</span><span class="op" id="3741013">(</span><span class="builtintype" id="3741014">int</span><span class="op" id="3741017">(</span><span class="ident" id="3741018">fd</span><span class="op" id="3741020">.</span><span class="ident" id="3741021">sysfd</span><span class="op" id="3741026">)</span><span class="op" id="3741027">,</span>&nbsp;<span class="ident" id="3741029">p</span><span class="op" id="3741030">[</span><span class="ident" id="3741031">nn</span><span class="op" id="3741033">:</span><span class="op" id="3741034">]</span><span class="op" id="3741035">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3741039">if</span>&nbsp;<span class="ident" id="3741042">n</span>&nbsp;<span class="op" id="3741044">&gt;</span>&nbsp;<span class="num" id="3741046">0</span>&nbsp;<span class="op" id="3741048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3741053">nn</span>&nbsp;<span class="op" id="3741056">+=</span>&nbsp;<span class="ident" id="3741059">n</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3741063">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3741067">if</span>&nbsp;<span class="ident" id="3741070">nn</span>&nbsp;<span class="op" id="3741073">==</span>&nbsp;<span class="builtinfunc" id="3741076">len</span><span class="op" id="3741079">(</span><span class="ident" id="3741080">p</span><span class="op" id="3741081">)</span>&nbsp;<span class="op" id="3741083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3741088">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3741096">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3741100">if</span>&nbsp;<span class="ident" id="3741103">err</span>&nbsp;<span class="op" id="3741107">==</span>&nbsp;<span class="ident" id="3741110">syscall</span><span class="op" id="3741117">.</span><span class="ident" id="3741118">EAGAIN</span>&nbsp;<span class="op" id="3741125">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3741130">if</span>&nbsp;<span class="ident" id="3741133">err</span>&nbsp;<span class="op" id="3741137">=</span>&nbsp;<span class="ident" id="3741139">fd</span><span class="op" id="3741141">.</span><span class="ident" id="3741142">pd</span><span class="op" id="3741144">.</span><span class="ident" id="3741145">WaitWrite</span><span class="op" id="3741154">(</span><span class="op" id="3741155">)</span><span class="op" id="3741156">;</span>&nbsp;<span class="ident" id="3741158">err</span>&nbsp;<span class="op" id="3741162">==</span>&nbsp;<span class="builtintype" id="3741165">nil</span>&nbsp;<span class="op" id="3741169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3741175">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3741187">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3741191">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3741195">if</span>&nbsp;<span class="ident" id="3741198">err</span>&nbsp;<span class="op" id="3741202">!=</span>&nbsp;<span class="builtintype" id="3741205">nil</span>&nbsp;<span class="op" id="3741209">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3741214">n</span>&nbsp;<span class="op" id="3741216">=</span>&nbsp;<span class="num" id="3741218">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3741223">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3741231">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3741235">if</span>&nbsp;<span class="ident" id="3741238">n</span>&nbsp;<span class="op" id="3741240">==</span>&nbsp;<span class="num" id="3741243">0</span>&nbsp;<span class="op" id="3741245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3741250">err</span>&nbsp;<span class="op" id="3741254">=</span>&nbsp;<span class="ident" id="3741256">io</span><span class="op" id="3741258">.</span><span class="ident" id="3741259">ErrUnexpectedEOF</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3741279">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3741287">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3741290">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3741293">if</span>&nbsp;<span class="ident" id="3741296">err</span>&nbsp;<span class="op" id="3741300">!=</span>&nbsp;<span class="builtintype" id="3741303">nil</span>&nbsp;<span class="op" id="3741307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3741311">err</span>&nbsp;<span class="op" id="3741315">=</span>&nbsp;<span class="op" id="3741317">&amp;</span><span class="ident" id="3741318">OpError</span><span class="op" id="3741325">{</span><span class="string" id="3741326">&#34;write&#34;</span><span class="op" id="3741333">,</span>&nbsp;<span class="ident" id="3741335">fd</span><span class="op" id="3741337">.</span><span class="ident" id="3741338">net</span><span class="op" id="3741341">,</span>&nbsp;<span class="ident" id="3741343">fd</span><span class="op" id="3741345">.</span><span class="ident" id="3741346">raddr</span><span class="op" id="3741351">,</span>&nbsp;<span class="ident" id="3741353">err</span><span class="op" id="3741356">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3741359">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3741362">return</span>&nbsp;<span class="ident" id="3741369">nn</span><span class="op" id="3741371">,</span>&nbsp;<span class="ident" id="3741373">err</span><br>
<span class="lineno"></span><span class="op" id="3741377">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3741380">func</span>&nbsp;<span class="op" id="3741385">(</span><span class="ident" id="3741386">fd</span>&nbsp;<span class="op" id="3741389">*</span><span class="ident" id="3741390">netFD</span><span class="op" id="3741395">)</span>&nbsp;<span class="ident" id="3741397">writeTo</span><span class="op" id="3741404">(</span><span class="ident" id="3741405">p</span>&nbsp;<span class="op" id="3741407">[</span><span class="op" id="3741408">]</span><span class="builtintype" id="3741409">byte</span><span class="op" id="3741413">,</span>&nbsp;<span class="ident" id="3741415">sa</span>&nbsp;<span class="ident" id="3741418">syscall</span><span class="op" id="3741425">.</span><span class="ident" id="3741426">Sockaddr</span><span class="op" id="3741434">)</span>&nbsp;<span class="op" id="3741436">(</span><span class="ident" id="3741437">n</span>&nbsp;<span class="builtintype" id="3741439">int</span><span class="op" id="3741442">,</span>&nbsp;<span class="ident" id="3741444">err</span>&nbsp;<span class="builtintype" id="3741448">error</span><span class="op" id="3741453">)</span>&nbsp;<span class="op" id="3741455">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3741458">if</span>&nbsp;<span class="ident" id="3741461">err</span>&nbsp;<span class="op" id="3741465">:=</span>&nbsp;<span class="ident" id="3741468">fd</span><span class="op" id="3741470">.</span><span class="ident" id="3741471">writeLock</span><span class="op" id="3741480">(</span><span class="op" id="3741481">)</span><span class="op" id="3741482">;</span>&nbsp;<span class="ident" id="3741484">err</span>&nbsp;<span class="op" id="3741488">!=</span>&nbsp;<span class="builtintype" id="3741491">nil</span>&nbsp;<span class="op" id="3741495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3741499">return</span>&nbsp;<span class="num" id="3741506">0</span><span class="op" id="3741507">,</span>&nbsp;<span class="ident" id="3741509">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3741514">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3741517">defer</span>&nbsp;<span class="ident" id="3741523">fd</span><span class="op" id="3741525">.</span><span class="ident" id="3741526">writeUnlock</span><span class="op" id="3741537">(</span><span class="op" id="3741538">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3741541">if</span>&nbsp;<span class="ident" id="3741544">err</span>&nbsp;<span class="op" id="3741548">:=</span>&nbsp;<span class="ident" id="3741551">fd</span><span class="op" id="3741553">.</span><span class="ident" id="3741554">pd</span><span class="op" id="3741556">.</span><span class="ident" id="3741557">PrepareWrite</span><span class="op" id="3741569">(</span><span class="op" id="3741570">)</span><span class="op" id="3741571">;</span>&nbsp;<span class="ident" id="3741573">err</span>&nbsp;<span class="op" id="3741577">!=</span>&nbsp;<span class="builtintype" id="3741580">nil</span>&nbsp;<span class="op" id="3741584">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3741588">return</span>&nbsp;<span class="num" id="3741595">0</span><span class="op" id="3741596">,</span>&nbsp;<span class="op" id="3741598">&amp;</span><span class="ident" id="3741599">OpError</span><span class="op" id="3741606">{</span><span class="string" id="3741607">&#34;write&#34;</span><span class="op" id="3741614">,</span>&nbsp;<span class="ident" id="3741616">fd</span><span class="op" id="3741618">.</span><span class="ident" id="3741619">net</span><span class="op" id="3741622">,</span>&nbsp;<span class="ident" id="3741624">fd</span><span class="op" id="3741626">.</span><span class="ident" id="3741627">raddr</span><span class="op" id="3741632">,</span>&nbsp;<span class="ident" id="3741634">err</span><span class="op" id="3741637">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3741640">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3741643">for</span>&nbsp;<span class="op" id="3741647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3741651">err</span>&nbsp;<span class="op" id="3741655">=</span>&nbsp;<span class="ident" id="3741657">syscall</span><span class="op" id="3741664">.</span><span class="ident" id="3741665">Sendto</span><span class="op" id="3741671">(</span><span class="ident" id="3741672">fd</span><span class="op" id="3741674">.</span><span class="ident" id="3741675">sysfd</span><span class="op" id="3741680">,</span>&nbsp;<span class="ident" id="3741682">p</span><span class="op" id="3741683">,</span>&nbsp;<span class="num" id="3741685">0</span><span class="op" id="3741686">,</span>&nbsp;<span class="ident" id="3741688">sa</span><span class="op" id="3741690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3741694">if</span>&nbsp;<span class="ident" id="3741697">err</span>&nbsp;<span class="op" id="3741701">==</span>&nbsp;<span class="ident" id="3741704">syscall</span><span class="op" id="3741711">.</span><span class="ident" id="3741712">EAGAIN</span>&nbsp;<span class="op" id="3741719">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3741724">if</span>&nbsp;<span class="ident" id="3741727">err</span>&nbsp;<span class="op" id="3741731">=</span>&nbsp;<span class="ident" id="3741733">fd</span><span class="op" id="3741735">.</span><span class="ident" id="3741736">pd</span><span class="op" id="3741738">.</span><span class="ident" id="3741739">WaitWrite</span><span class="op" id="3741748">(</span><span class="op" id="3741749">)</span><span class="op" id="3741750">;</span>&nbsp;<span class="ident" id="3741752">err</span>&nbsp;<span class="op" id="3741756">==</span>&nbsp;<span class="builtintype" id="3741759">nil</span>&nbsp;<span class="op" id="3741763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3741769">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3741781">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3741785">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3741789">break</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3741796">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3741799">if</span>&nbsp;<span class="ident" id="3741802">err</span>&nbsp;<span class="op" id="3741806">==</span>&nbsp;<span class="builtintype" id="3741809">nil</span>&nbsp;<span class="op" id="3741813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3741817">n</span>&nbsp;<span class="op" id="3741819">=</span>&nbsp;<span class="builtinfunc" id="3741821">len</span><span class="op" id="3741824">(</span><span class="ident" id="3741825">p</span><span class="op" id="3741826">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3741829">}</span>&nbsp;<span class="keyword" id="3741831">else</span>&nbsp;<span class="op" id="3741836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3741840">err</span>&nbsp;<span class="op" id="3741844">=</span>&nbsp;<span class="op" id="3741846">&amp;</span><span class="ident" id="3741847">OpError</span><span class="op" id="3741854">{</span><span class="string" id="3741855">&#34;write&#34;</span><span class="op" id="3741862">,</span>&nbsp;<span class="ident" id="3741864">fd</span><span class="op" id="3741866">.</span><span class="ident" id="3741867">net</span><span class="op" id="3741870">,</span>&nbsp;<span class="ident" id="3741872">fd</span><span class="op" id="3741874">.</span><span class="ident" id="3741875">raddr</span><span class="op" id="3741880">,</span>&nbsp;<span class="ident" id="3741882">err</span><span class="op" id="3741885">}</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3741888">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3741891">return</span><br>
<span class="lineno"></span><span class="op" id="3741898">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3741901">func</span>&nbsp;<span class="op" id="3741906">(</span><span class="ident" id="3741907">fd</span>&nbsp;<span class="op" id="3741910">*</span><span class="ident" id="3741911">netFD</span><span class="op" id="3741916">)</span>&nbsp;<span class="ident" id="3741918">writeMsg</span><span class="op" id="3741926">(</span><span class="ident" id="3741927">p</span>&nbsp;<span class="op" id="3741929">[</span><span class="op" id="3741930">]</span><span class="builtintype" id="3741931">byte</span><span class="op" id="3741935">,</span>&nbsp;<span class="ident" id="3741937">oob</span>&nbsp;<span class="op" id="3741941">[</span><span class="op" id="3741942">]</span><span class="builtintype" id="3741943">byte</span><span class="op" id="3741947">,</span>&nbsp;<span class="ident" id="3741949">sa</span>&nbsp;<span class="ident" id="3741952">syscall</span><span class="op" id="3741959">.</span><span class="ident" id="3741960">Sockaddr</span><span class="op" id="3741968">)</span>&nbsp;<span class="op" id="3741970">(</span><span class="ident" id="3741971">n</span>&nbsp;<span class="builtintype" id="3741973">int</span><span class="op" id="3741976">,</span>&nbsp;<span class="ident" id="3741978">oobn</span>&nbsp;<span class="builtintype" id="3741983">int</span><span class="op" id="3741986">,</span>&nbsp;<span class="ident" id="3741988">err</span>&nbsp;<span class="builtintype" id="3741992">error</span><span class="op" id="3741997">)</span>&nbsp;<span class="op" id="3741999">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3742002">if</span>&nbsp;<span class="ident" id="3742005">err</span>&nbsp;<span class="op" id="3742009">:=</span>&nbsp;<span class="ident" id="3742012">fd</span><span class="op" id="3742014">.</span><span class="ident" id="3742015">writeLock</span><span class="op" id="3742024">(</span><span class="op" id="3742025">)</span><span class="op" id="3742026">;</span>&nbsp;<span class="ident" id="3742028">err</span>&nbsp;<span class="op" id="3742032">!=</span>&nbsp;<span class="builtintype" id="3742035">nil</span>&nbsp;<span class="op" id="3742039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3742043">return</span>&nbsp;<span class="num" id="3742050">0</span><span class="op" id="3742051">,</span>&nbsp;<span class="num" id="3742053">0</span><span class="op" id="3742054">,</span>&nbsp;<span class="ident" id="3742056">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3742061">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3742064">defer</span>&nbsp;<span class="ident" id="3742070">fd</span><span class="op" id="3742072">.</span><span class="ident" id="3742073">writeUnlock</span><span class="op" id="3742084">(</span><span class="op" id="3742085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3742088">if</span>&nbsp;<span class="ident" id="3742091">err</span>&nbsp;<span class="op" id="3742095">:=</span>&nbsp;<span class="ident" id="3742098">fd</span><span class="op" id="3742100">.</span><span class="ident" id="3742101">pd</span><span class="op" id="3742103">.</span><span class="ident" id="3742104">PrepareWrite</span><span class="op" id="3742116">(</span><span class="op" id="3742117">)</span><span class="op" id="3742118">;</span>&nbsp;<span class="ident" id="3742120">err</span>&nbsp;<span class="op" id="3742124">!=</span>&nbsp;<span class="builtintype" id="3742127">nil</span>&nbsp;<span class="op" id="3742131">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3742135">return</span>&nbsp;<span class="num" id="3742142">0</span><span class="op" id="3742143">,</span>&nbsp;<span class="num" id="3742145">0</span><span class="op" id="3742146">,</span>&nbsp;<span class="op" id="3742148">&amp;</span><span class="ident" id="3742149">OpError</span><span class="op" id="3742156">{</span><span class="string" id="3742157">&#34;write&#34;</span><span class="op" id="3742164">,</span>&nbsp;<span class="ident" id="3742166">fd</span><span class="op" id="3742168">.</span><span class="ident" id="3742169">net</span><span class="op" id="3742172">,</span>&nbsp;<span class="ident" id="3742174">fd</span><span class="op" id="3742176">.</span><span class="ident" id="3742177">raddr</span><span class="op" id="3742182">,</span>&nbsp;<span class="ident" id="3742184">err</span><span class="op" id="3742187">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3742190">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3742193">for</span>&nbsp;<span class="op" id="3742197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3742201">n</span><span class="op" id="3742202">,</span>&nbsp;<span class="ident" id="3742204">err</span>&nbsp;<span class="op" id="3742208">=</span>&nbsp;<span class="ident" id="3742210">syscall</span><span class="op" id="3742217">.</span><span class="ident" id="3742218">SendmsgN</span><span class="op" id="3742226">(</span><span class="ident" id="3742227">fd</span><span class="op" id="3742229">.</span><span class="ident" id="3742230">sysfd</span><span class="op" id="3742235">,</span>&nbsp;<span class="ident" id="3742237">p</span><span class="op" id="3742238">,</span>&nbsp;<span class="ident" id="3742240">oob</span><span class="op" id="3742243">,</span>&nbsp;<span class="ident" id="3742245">sa</span><span class="op" id="3742247">,</span>&nbsp;<span class="num" id="3742249">0</span><span class="op" id="3742250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3742254">if</span>&nbsp;<span class="ident" id="3742257">err</span>&nbsp;<span class="op" id="3742261">==</span>&nbsp;<span class="ident" id="3742264">syscall</span><span class="op" id="3742271">.</span><span class="ident" id="3742272">EAGAIN</span>&nbsp;<span class="op" id="3742279">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3742284">if</span>&nbsp;<span class="ident" id="3742287">err</span>&nbsp;<span class="op" id="3742291">=</span>&nbsp;<span class="ident" id="3742293">fd</span><span class="op" id="3742295">.</span><span class="ident" id="3742296">pd</span><span class="op" id="3742298">.</span><span class="ident" id="3742299">WaitWrite</span><span class="op" id="3742308">(</span><span class="op" id="3742309">)</span><span class="op" id="3742310">;</span>&nbsp;<span class="ident" id="3742312">err</span>&nbsp;<span class="op" id="3742316">==</span>&nbsp;<span class="builtintype" id="3742319">nil</span>&nbsp;<span class="op" id="3742323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3742329">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3742341">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3742345">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3742349">break</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3742356">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3742359">if</span>&nbsp;<span class="ident" id="3742362">err</span>&nbsp;<span class="op" id="3742366">==</span>&nbsp;<span class="builtintype" id="3742369">nil</span>&nbsp;<span class="op" id="3742373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3742377">oobn</span>&nbsp;<span class="op" id="3742382">=</span>&nbsp;<span class="builtinfunc" id="3742384">len</span><span class="op" id="3742387">(</span><span class="ident" id="3742388">oob</span><span class="op" id="3742391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3742394">}</span>&nbsp;<span class="keyword" id="3742396">else</span>&nbsp;<span class="op" id="3742401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3742405">err</span>&nbsp;<span class="op" id="3742409">=</span>&nbsp;<span class="op" id="3742411">&amp;</span><span class="ident" id="3742412">OpError</span><span class="op" id="3742419">{</span><span class="string" id="3742420">&#34;write&#34;</span><span class="op" id="3742427">,</span>&nbsp;<span class="ident" id="3742429">fd</span><span class="op" id="3742431">.</span><span class="ident" id="3742432">net</span><span class="op" id="3742435">,</span>&nbsp;<span class="ident" id="3742437">fd</span><span class="op" id="3742439">.</span><span class="ident" id="3742440">raddr</span><span class="op" id="3742445">,</span>&nbsp;<span class="ident" id="3742447">err</span><span class="op" id="3742450">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3742453">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3742456">return</span><br>
<span class="lineno"></span><span class="op" id="3742463">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3742466">func</span>&nbsp;<span class="op" id="3742471">(</span><span class="ident" id="3742472">fd</span>&nbsp;<span class="op" id="3742475">*</span><span class="ident" id="3742476">netFD</span><span class="op" id="3742481">)</span>&nbsp;<span class="ident" id="3742483">accept</span><span class="op" id="3742489">(</span><span class="op" id="3742490">)</span>&nbsp;<span class="op" id="3742492">(</span><span class="ident" id="3742493">netfd</span>&nbsp;<span class="op" id="3742499">*</span><span class="ident" id="3742500">netFD</span><span class="op" id="3742505">,</span>&nbsp;<span class="ident" id="3742507">err</span>&nbsp;<span class="builtintype" id="3742511">error</span><span class="op" id="3742516">)</span>&nbsp;<span class="op" id="3742518">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3742521">if</span>&nbsp;<span class="ident" id="3742524">err</span>&nbsp;<span class="op" id="3742528">:=</span>&nbsp;<span class="ident" id="3742531">fd</span><span class="op" id="3742533">.</span><span class="ident" id="3742534">readLock</span><span class="op" id="3742542">(</span><span class="op" id="3742543">)</span><span class="op" id="3742544">;</span>&nbsp;<span class="ident" id="3742546">err</span>&nbsp;<span class="op" id="3742550">!=</span>&nbsp;<span class="builtintype" id="3742553">nil</span>&nbsp;<span class="op" id="3742557">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3742561">return</span>&nbsp;<span class="builtintype" id="3742568">nil</span><span class="op" id="3742571">,</span>&nbsp;<span class="ident" id="3742573">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3742578">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3742581">defer</span>&nbsp;<span class="ident" id="3742587">fd</span><span class="op" id="3742589">.</span><span class="ident" id="3742590">readUnlock</span><span class="op" id="3742600">(</span><span class="op" id="3742601">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3742605">var</span>&nbsp;<span class="ident" id="3742609">s</span>&nbsp;<span class="builtintype" id="3742611">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3742616">var</span>&nbsp;<span class="ident" id="3742620">rsa</span>&nbsp;<span class="ident" id="3742624">syscall</span><span class="op" id="3742631">.</span><span class="ident" id="3742632">Sockaddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3742642">if</span>&nbsp;<span class="ident" id="3742645">err</span>&nbsp;<span class="op" id="3742649">=</span>&nbsp;<span class="ident" id="3742651">fd</span><span class="op" id="3742653">.</span><span class="ident" id="3742654">pd</span><span class="op" id="3742656">.</span><span class="ident" id="3742657">PrepareRead</span><span class="op" id="3742668">(</span><span class="op" id="3742669">)</span><span class="op" id="3742670">;</span>&nbsp;<span class="ident" id="3742672">err</span>&nbsp;<span class="op" id="3742676">!=</span>&nbsp;<span class="builtintype" id="3742679">nil</span>&nbsp;<span class="op" id="3742683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3742687">return</span>&nbsp;<span class="builtintype" id="3742694">nil</span><span class="op" id="3742697">,</span>&nbsp;<span class="op" id="3742699">&amp;</span><span class="ident" id="3742700">OpError</span><span class="op" id="3742707">{</span><span class="string" id="3742708">&#34;accept&#34;</span><span class="op" id="3742716">,</span>&nbsp;<span class="ident" id="3742718">fd</span><span class="op" id="3742720">.</span><span class="ident" id="3742721">net</span><span class="op" id="3742724">,</span>&nbsp;<span class="ident" id="3742726">fd</span><span class="op" id="3742728">.</span><span class="ident" id="3742729">laddr</span><span class="op" id="3742734">,</span>&nbsp;<span class="ident" id="3742736">err</span><span class="op" id="3742739">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3742742">}</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3742745">for</span>&nbsp;<span class="op" id="3742749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3742753">s</span><span class="op" id="3742754">,</span>&nbsp;<span class="ident" id="3742756">rsa</span><span class="op" id="3742759">,</span>&nbsp;<span class="ident" id="3742761">err</span>&nbsp;<span class="op" id="3742765">=</span>&nbsp;<span class="ident" id="3742767">accept</span><span class="op" id="3742773">(</span><span class="ident" id="3742774">fd</span><span class="op" id="3742776">.</span><span class="ident" id="3742777">sysfd</span><span class="op" id="3742782">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3742786">if</span>&nbsp;<span class="ident" id="3742789">err</span>&nbsp;<span class="op" id="3742793">!=</span>&nbsp;<span class="builtintype" id="3742796">nil</span>&nbsp;<span class="op" id="3742800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3742805">if</span>&nbsp;<span class="ident" id="3742808">err</span>&nbsp;<span class="op" id="3742812">==</span>&nbsp;<span class="ident" id="3742815">syscall</span><span class="op" id="3742822">.</span><span class="ident" id="3742823">EAGAIN</span>&nbsp;<span class="op" id="3742830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3742836">if</span>&nbsp;<span class="ident" id="3742839">err</span>&nbsp;<span class="op" id="3742843">=</span>&nbsp;<span class="ident" id="3742845">fd</span><span class="op" id="3742847">.</span><span class="ident" id="3742848">pd</span><span class="op" id="3742850">.</span><span class="ident" id="3742851">WaitRead</span><span class="op" id="3742859">(</span><span class="op" id="3742860">)</span><span class="op" id="3742861">;</span>&nbsp;<span class="ident" id="3742863">err</span>&nbsp;<span class="op" id="3742867">==</span>&nbsp;<span class="builtintype" id="3742870">nil</span>&nbsp;<span class="op" id="3742874">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3742881">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3742894">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3742899">}</span>&nbsp;<span class="keyword" id="3742901">else</span>&nbsp;<span class="keyword" id="3742906">if</span>&nbsp;<span class="ident" id="3742909">err</span>&nbsp;<span class="op" id="3742913">==</span>&nbsp;<span class="ident" id="3742916">syscall</span><span class="op" id="3742923">.</span><span class="ident" id="3742924">ECONNABORTED</span>&nbsp;<span class="op" id="3742937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3742943">//&nbsp;This&nbsp;means&nbsp;that&nbsp;a&nbsp;socket&nbsp;on&nbsp;the&nbsp;listen&nbsp;queue&nbsp;was&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3743006">//&nbsp;before&nbsp;we&nbsp;Accept()ed&nbsp;it;&nbsp;it&#39;s&nbsp;a&nbsp;silly&nbsp;error,&nbsp;so&nbsp;try&nbsp;again.</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3743072">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3743084">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3743089">return</span>&nbsp;<span class="builtintype" id="3743096">nil</span><span class="op" id="3743099">,</span>&nbsp;<span class="op" id="3743101">&amp;</span><span class="ident" id="3743102">OpError</span><span class="op" id="3743109">{</span><span class="string" id="3743110">&#34;accept&#34;</span><span class="op" id="3743118">,</span>&nbsp;<span class="ident" id="3743120">fd</span><span class="op" id="3743122">.</span><span class="ident" id="3743123">net</span><span class="op" id="3743126">,</span>&nbsp;<span class="ident" id="3743128">fd</span><span class="op" id="3743130">.</span><span class="ident" id="3743131">laddr</span><span class="op" id="3743136">,</span>&nbsp;<span class="ident" id="3743138">err</span><span class="op" id="3743141">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3743145">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3743149">break</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3743156">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3743160">if</span>&nbsp;<span class="ident" id="3743163">netfd</span><span class="op" id="3743168">,</span>&nbsp;<span class="ident" id="3743170">err</span>&nbsp;<span class="op" id="3743174">=</span>&nbsp;<span class="ident" id="3743176">newFD</span><span class="op" id="3743181">(</span><span class="ident" id="3743182">s</span><span class="op" id="3743183">,</span>&nbsp;<span class="ident" id="3743185">fd</span><span class="op" id="3743187">.</span><span class="ident" id="3743188">family</span><span class="op" id="3743194">,</span>&nbsp;<span class="ident" id="3743196">fd</span><span class="op" id="3743198">.</span><span class="ident" id="3743199">sotype</span><span class="op" id="3743205">,</span>&nbsp;<span class="ident" id="3743207">fd</span><span class="op" id="3743209">.</span><span class="ident" id="3743210">net</span><span class="op" id="3743213">)</span><span class="op" id="3743214">;</span>&nbsp;<span class="ident" id="3743216">err</span>&nbsp;<span class="op" id="3743220">!=</span>&nbsp;<span class="builtintype" id="3743223">nil</span>&nbsp;<span class="op" id="3743227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3743231">closesocket</span><span class="op" id="3743242">(</span><span class="ident" id="3743243">s</span><span class="op" id="3743244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3743248">return</span>&nbsp;<span class="builtintype" id="3743255">nil</span><span class="op" id="3743258">,</span>&nbsp;<span class="ident" id="3743260">err</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3743265">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3743268">if</span>&nbsp;<span class="ident" id="3743271">err</span>&nbsp;<span class="op" id="3743275">=</span>&nbsp;<span class="ident" id="3743277">netfd</span><span class="op" id="3743282">.</span><span class="ident" id="3743283">init</span><span class="op" id="3743287">(</span><span class="op" id="3743288">)</span><span class="op" id="3743289">;</span>&nbsp;<span class="ident" id="3743291">err</span>&nbsp;<span class="op" id="3743295">!=</span>&nbsp;<span class="builtintype" id="3743298">nil</span>&nbsp;<span class="op" id="3743302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3743306">fd</span><span class="op" id="3743308">.</span><span class="ident" id="3743309">Close</span><span class="op" id="3743314">(</span><span class="op" id="3743315">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3743319">return</span>&nbsp;<span class="builtintype" id="3743326">nil</span><span class="op" id="3743329">,</span>&nbsp;<span class="ident" id="3743331">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3743336">}</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3743339">lsa</span><span class="op" id="3743342">,</span>&nbsp;<span class="ident" id="3743344">_</span>&nbsp;<span class="op" id="3743346">:=</span>&nbsp;<span class="ident" id="3743349">syscall</span><span class="op" id="3743356">.</span><span class="ident" id="3743357">Getsockname</span><span class="op" id="3743368">(</span><span class="ident" id="3743369">netfd</span><span class="op" id="3743374">.</span><span class="ident" id="3743375">sysfd</span><span class="op" id="3743380">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3743383">netfd</span><span class="op" id="3743388">.</span><span class="ident" id="3743389">setAddr</span><span class="op" id="3743396">(</span><span class="ident" id="3743397">netfd</span><span class="op" id="3743402">.</span><span class="ident" id="3743403">addrFunc</span><span class="op" id="3743411">(</span><span class="op" id="3743412">)</span><span class="op" id="3743413">(</span><span class="ident" id="3743414">lsa</span><span class="op" id="3743417">)</span><span class="op" id="3743418">,</span>&nbsp;<span class="ident" id="3743420">netfd</span><span class="op" id="3743425">.</span><span class="ident" id="3743426">addrFunc</span><span class="op" id="3743434">(</span><span class="op" id="3743435">)</span><span class="op" id="3743436">(</span><span class="ident" id="3743437">rsa</span><span class="op" id="3743440">)</span><span class="op" id="3743441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3743444">return</span>&nbsp;<span class="ident" id="3743451">netfd</span><span class="op" id="3743456">,</span>&nbsp;<span class="builtintype" id="3743458">nil</span><br>
<span class="lineno"></span><span class="op" id="3743462">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">445</span><span class="comment" id="3743465">//&nbsp;tryDupCloexec&nbsp;indicates&nbsp;whether&nbsp;F_DUPFD_CLOEXEC&nbsp;should&nbsp;be&nbsp;used.</span><br>
<span class="lineno"></span><span class="comment" id="3743532">//&nbsp;If&nbsp;the&nbsp;kernel&nbsp;doesn&#39;t&nbsp;support&nbsp;it,&nbsp;this&nbsp;is&nbsp;set&nbsp;to&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="3743587">var</span>&nbsp;<span class="ident" id="3743591">tryDupCloexec</span>&nbsp;<span class="op" id="3743605">=</span>&nbsp;<span class="builtintype" id="3743607">int32</span><span class="op" id="3743612">(</span><span class="num" id="3743613">1</span><span class="op" id="3743614">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3743617">func</span>&nbsp;<span class="ident" id="3743622">dupCloseOnExec</span><span class="op" id="3743636">(</span><span class="ident" id="3743637">fd</span>&nbsp;<span class="builtintype" id="3743640">int</span><span class="op" id="3743643">)</span>&nbsp;<span class="op" id="3743645">(</span><span class="ident" id="3743646">newfd</span>&nbsp;<span class="builtintype" id="3743652">int</span><span class="op" id="3743655">,</span>&nbsp;<span class="ident" id="3743657">err</span>&nbsp;<span class="builtintype" id="3743661">error</span><span class="op" id="3743666">)</span>&nbsp;<span class="op" id="3743668">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3743671">if</span>&nbsp;<span class="ident" id="3743674">atomic</span><span class="op" id="3743680">.</span><span class="ident" id="3743681">LoadInt32</span><span class="op" id="3743690">(</span><span class="op" id="3743691">&amp;</span><span class="ident" id="3743692">tryDupCloexec</span><span class="op" id="3743705">)</span>&nbsp;<span class="op" id="3743707">==</span>&nbsp;<span class="num" id="3743710">1</span>&nbsp;<span class="op" id="3743712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3743716">r0</span><span class="op" id="3743718">,</span>&nbsp;<span class="ident" id="3743720">_</span><span class="op" id="3743721">,</span>&nbsp;<span class="ident" id="3743723">e1</span>&nbsp;<span class="op" id="3743726">:=</span>&nbsp;<span class="ident" id="3743729">syscall</span><span class="op" id="3743736">.</span><span class="ident" id="3743737">Syscall</span><span class="op" id="3743744">(</span><span class="ident" id="3743745">syscall</span><span class="op" id="3743752">.</span><span class="ident" id="3743753">SYS_FCNTL</span><span class="op" id="3743762">,</span>&nbsp;<span class="builtintype" id="3743764">uintptr</span><span class="op" id="3743771">(</span><span class="ident" id="3743772">fd</span><span class="op" id="3743774">)</span><span class="op" id="3743775">,</span>&nbsp;<span class="ident" id="3743777">syscall</span><span class="op" id="3743784">.</span><span class="ident" id="3743785">F_DUPFD_CLOEXEC</span><span class="op" id="3743800">,</span>&nbsp;<span class="num" id="3743802">0</span><span class="op" id="3743803">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3743807">if</span>&nbsp;<span class="ident" id="3743810">runtime</span><span class="op" id="3743817">.</span><span class="ident" id="3743818">GOOS</span>&nbsp;<span class="op" id="3743823">==</span>&nbsp;<span class="string" id="3743826">&#34;darwin&#34;</span>&nbsp;<span class="op" id="3743835">&amp;&amp;</span>&nbsp;<span class="ident" id="3743838">e1</span>&nbsp;<span class="op" id="3743841">==</span>&nbsp;<span class="ident" id="3743844">syscall</span><span class="op" id="3743851">.</span><span class="ident" id="3743852">EBADF</span>&nbsp;<span class="op" id="3743858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3743863">//&nbsp;On&nbsp;OS&nbsp;X&nbsp;10.6&nbsp;and&nbsp;below&nbsp;(but&nbsp;we&nbsp;only&nbsp;support</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3743913">//&nbsp;&gt;=&nbsp;10.6),&nbsp;F_DUPFD_CLOEXEC&nbsp;is&nbsp;unsupported</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3743960">//&nbsp;and&nbsp;fcntl&nbsp;there&nbsp;falls&nbsp;back&nbsp;(undocumented)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3744008">//&nbsp;to&nbsp;doing&nbsp;an&nbsp;ioctl&nbsp;instead,&nbsp;returning&nbsp;EBADF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3744057">//&nbsp;in&nbsp;this&nbsp;case&nbsp;because&nbsp;fd&nbsp;is&nbsp;not&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3744101">//&nbsp;expected&nbsp;device&nbsp;fd&nbsp;type.&nbsp;&nbsp;Treat&nbsp;it&nbsp;as</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3744145">//&nbsp;EINVAL&nbsp;instead,&nbsp;so&nbsp;we&nbsp;fall&nbsp;back&nbsp;to&nbsp;the</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3744190">//&nbsp;normal&nbsp;dup&nbsp;path.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3744213">//&nbsp;TODO:&nbsp;only&nbsp;do&nbsp;this&nbsp;on&nbsp;10.6&nbsp;if&nbsp;we&nbsp;can&nbsp;detect&nbsp;10.6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3744268">//&nbsp;cheaply.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3744283">e1</span>&nbsp;<span class="op" id="3744286">=</span>&nbsp;<span class="ident" id="3744288">syscall</span><span class="op" id="3744295">.</span><span class="ident" id="3744296">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3744305">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3744309">switch</span>&nbsp;<span class="ident" id="3744316">e1</span>&nbsp;<span class="op" id="3744319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3744323">case</span>&nbsp;<span class="num" id="3744328">0</span><span class="op" id="3744329">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3744334">return</span>&nbsp;<span class="builtintype" id="3744341">int</span><span class="op" id="3744344">(</span><span class="ident" id="3744345">r0</span><span class="op" id="3744347">)</span><span class="op" id="3744348">,</span>&nbsp;<span class="builtintype" id="3744350">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3744356">case</span>&nbsp;<span class="ident" id="3744361">syscall</span><span class="op" id="3744368">.</span><span class="ident" id="3744369">EINVAL</span><span class="op" id="3744375">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3744380">//&nbsp;Old&nbsp;kernel.&nbsp;Fall&nbsp;back&nbsp;to&nbsp;the&nbsp;portable&nbsp;way</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3744428">//&nbsp;from&nbsp;now&nbsp;on.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3744447">atomic</span><span class="op" id="3744453">.</span><span class="ident" id="3744454">StoreInt32</span><span class="op" id="3744464">(</span><span class="op" id="3744465">&amp;</span><span class="ident" id="3744466">tryDupCloexec</span><span class="op" id="3744479">,</span>&nbsp;<span class="num" id="3744481">0</span><span class="op" id="3744482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3744486">default</span><span class="op" id="3744493">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3744498">return</span>&nbsp;<span class="op" id="3744505">-</span><span class="num" id="3744506">1</span><span class="op" id="3744507">,</span>&nbsp;<span class="ident" id="3744509">e1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3744514">}</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3744517">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3744520">return</span>&nbsp;<span class="ident" id="3744527">dupCloseOnExecOld</span><span class="op" id="3744544">(</span><span class="ident" id="3744545">fd</span><span class="op" id="3744547">)</span><br>
<span class="lineno"></span><span class="op" id="3744549">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3744552">//&nbsp;dupCloseOnExecUnixOld&nbsp;is&nbsp;the&nbsp;traditional&nbsp;way&nbsp;to&nbsp;dup&nbsp;an&nbsp;fd&nbsp;and</span><br>
<span class="lineno">480</span><span class="comment" id="3744617">//&nbsp;set&nbsp;its&nbsp;O_CLOEXEC&nbsp;bit,&nbsp;using&nbsp;two&nbsp;system&nbsp;calls.</span><br>
<span class="lineno"></span><span class="keyword" id="3744667">func</span>&nbsp;<span class="ident" id="3744672">dupCloseOnExecOld</span><span class="op" id="3744689">(</span><span class="ident" id="3744690">fd</span>&nbsp;<span class="builtintype" id="3744693">int</span><span class="op" id="3744696">)</span>&nbsp;<span class="op" id="3744698">(</span><span class="ident" id="3744699">newfd</span>&nbsp;<span class="builtintype" id="3744705">int</span><span class="op" id="3744708">,</span>&nbsp;<span class="ident" id="3744710">err</span>&nbsp;<span class="builtintype" id="3744714">error</span><span class="op" id="3744719">)</span>&nbsp;<span class="op" id="3744721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3744724">syscall</span><span class="op" id="3744731">.</span><span class="ident" id="3744732">ForkLock</span><span class="op" id="3744740">.</span><span class="ident" id="3744741">RLock</span><span class="op" id="3744746">(</span><span class="op" id="3744747">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3744750">defer</span>&nbsp;<span class="ident" id="3744756">syscall</span><span class="op" id="3744763">.</span><span class="ident" id="3744764">ForkLock</span><span class="op" id="3744772">.</span><span class="ident" id="3744773">RUnlock</span><span class="op" id="3744780">(</span><span class="op" id="3744781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3744784">newfd</span><span class="op" id="3744789">,</span>&nbsp;<span class="ident" id="3744791">err</span>&nbsp;<span class="op" id="3744795">=</span>&nbsp;<span class="ident" id="3744797">syscall</span><span class="op" id="3744804">.</span><span class="ident" id="3744805">Dup</span><span class="op" id="3744808">(</span><span class="ident" id="3744809">fd</span><span class="op" id="3744811">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3744814">if</span>&nbsp;<span class="ident" id="3744817">err</span>&nbsp;<span class="op" id="3744821">!=</span>&nbsp;<span class="builtintype" id="3744824">nil</span>&nbsp;<span class="op" id="3744828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3744832">return</span>&nbsp;<span class="op" id="3744839">-</span><span class="num" id="3744840">1</span><span class="op" id="3744841">,</span>&nbsp;<span class="ident" id="3744843">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3744848">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3744851">syscall</span><span class="op" id="3744858">.</span><span class="ident" id="3744859">CloseOnExec</span><span class="op" id="3744870">(</span><span class="ident" id="3744871">newfd</span><span class="op" id="3744876">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3744879">return</span><br>
<span class="lineno">490</span><span class="op" id="3744886">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3744889">func</span>&nbsp;<span class="op" id="3744894">(</span><span class="ident" id="3744895">fd</span>&nbsp;<span class="op" id="3744898">*</span><span class="ident" id="3744899">netFD</span><span class="op" id="3744904">)</span>&nbsp;<span class="ident" id="3744906">dup</span><span class="op" id="3744909">(</span><span class="op" id="3744910">)</span>&nbsp;<span class="op" id="3744912">(</span><span class="ident" id="3744913">f</span>&nbsp;<span class="op" id="3744915">*</span><span class="ident" id="3744916">os</span><span class="op" id="3744918">.</span><span class="ident" id="3744919">File</span><span class="op" id="3744923">,</span>&nbsp;<span class="ident" id="3744925">err</span>&nbsp;<span class="builtintype" id="3744929">error</span><span class="op" id="3744934">)</span>&nbsp;<span class="op" id="3744936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3744939">ns</span><span class="op" id="3744941">,</span>&nbsp;<span class="ident" id="3744943">err</span>&nbsp;<span class="op" id="3744947">:=</span>&nbsp;<span class="ident" id="3744950">dupCloseOnExec</span><span class="op" id="3744964">(</span><span class="ident" id="3744965">fd</span><span class="op" id="3744967">.</span><span class="ident" id="3744968">sysfd</span><span class="op" id="3744973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3744976">if</span>&nbsp;<span class="ident" id="3744979">err</span>&nbsp;<span class="op" id="3744983">!=</span>&nbsp;<span class="builtintype" id="3744986">nil</span>&nbsp;<span class="op" id="3744990">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3744994">return</span>&nbsp;<span class="builtintype" id="3745001">nil</span><span class="op" id="3745004">,</span>&nbsp;<span class="op" id="3745006">&amp;</span><span class="ident" id="3745007">OpError</span><span class="op" id="3745014">{</span><span class="string" id="3745015">&#34;dup&#34;</span><span class="op" id="3745020">,</span>&nbsp;<span class="ident" id="3745022">fd</span><span class="op" id="3745024">.</span><span class="ident" id="3745025">net</span><span class="op" id="3745028">,</span>&nbsp;<span class="ident" id="3745030">fd</span><span class="op" id="3745032">.</span><span class="ident" id="3745033">laddr</span><span class="op" id="3745038">,</span>&nbsp;<span class="ident" id="3745040">err</span><span class="op" id="3745043">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3745046">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3745050">//&nbsp;We&nbsp;want&nbsp;blocking&nbsp;mode&nbsp;for&nbsp;the&nbsp;new&nbsp;fd,&nbsp;hence&nbsp;the&nbsp;double&nbsp;negative.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3745119">//&nbsp;This&nbsp;also&nbsp;puts&nbsp;the&nbsp;old&nbsp;fd&nbsp;into&nbsp;blocking&nbsp;mode,&nbsp;meaning&nbsp;that</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3745182">//&nbsp;I/O&nbsp;will&nbsp;block&nbsp;the&nbsp;thread&nbsp;instead&nbsp;of&nbsp;letting&nbsp;us&nbsp;use&nbsp;the&nbsp;epoll&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3745256">//&nbsp;Everything&nbsp;will&nbsp;still&nbsp;work,&nbsp;just&nbsp;with&nbsp;more&nbsp;threads.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3745312">if</span>&nbsp;<span class="ident" id="3745315">err</span>&nbsp;<span class="op" id="3745319">=</span>&nbsp;<span class="ident" id="3745321">syscall</span><span class="op" id="3745328">.</span><span class="ident" id="3745329">SetNonblock</span><span class="op" id="3745340">(</span><span class="ident" id="3745341">ns</span><span class="op" id="3745343">,</span>&nbsp;<span class="builtintype" id="3745345">false</span><span class="op" id="3745350">)</span><span class="op" id="3745351">;</span>&nbsp;<span class="ident" id="3745353">err</span>&nbsp;<span class="op" id="3745357">!=</span>&nbsp;<span class="builtintype" id="3745360">nil</span>&nbsp;<span class="op" id="3745364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3745368">return</span>&nbsp;<span class="builtintype" id="3745375">nil</span><span class="op" id="3745378">,</span>&nbsp;<span class="op" id="3745380">&amp;</span><span class="ident" id="3745381">OpError</span><span class="op" id="3745388">{</span><span class="string" id="3745389">&#34;setnonblock&#34;</span><span class="op" id="3745402">,</span>&nbsp;<span class="ident" id="3745404">fd</span><span class="op" id="3745406">.</span><span class="ident" id="3745407">net</span><span class="op" id="3745410">,</span>&nbsp;<span class="ident" id="3745412">fd</span><span class="op" id="3745414">.</span><span class="ident" id="3745415">laddr</span><span class="op" id="3745420">,</span>&nbsp;<span class="ident" id="3745422">err</span><span class="op" id="3745425">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3745428">}</span><br>
<span class="lineno">505</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3745432">return</span>&nbsp;<span class="ident" id="3745439">os</span><span class="op" id="3745441">.</span><span class="ident" id="3745442">NewFile</span><span class="op" id="3745449">(</span><span class="builtintype" id="3745450">uintptr</span><span class="op" id="3745457">(</span><span class="ident" id="3745458">ns</span><span class="op" id="3745460">)</span><span class="op" id="3745461">,</span>&nbsp;<span class="ident" id="3745463">fd</span><span class="op" id="3745465">.</span><span class="ident" id="3745466">name</span><span class="op" id="3745470">(</span><span class="op" id="3745471">)</span><span class="op" id="3745472">)</span><span class="op" id="3745473">,</span>&nbsp;<span class="builtintype" id="3745475">nil</span><br>
<span class="lineno"></span><span class="op" id="3745479">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3745482">func</span>&nbsp;<span class="ident" id="3745487">closesocket</span><span class="op" id="3745498">(</span><span class="ident" id="3745499">s</span>&nbsp;<span class="builtintype" id="3745501">int</span><span class="op" id="3745504">)</span>&nbsp;<span class="builtintype" id="3745506">error</span>&nbsp;<span class="op" id="3745512">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3745515">return</span>&nbsp;<span class="ident" id="3745522">syscall</span><span class="op" id="3745529">.</span><span class="ident" id="3745530">Close</span><span class="op" id="3745535">(</span><span class="ident" id="3745536">s</span><span class="op" id="3745537">)</span><br>
<span class="lineno"></span><span class="op" id="3745539">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3745542">func</span>&nbsp;<span class="ident" id="3745547">skipRawSocketTests</span><span class="op" id="3745565">(</span><span class="op" id="3745566">)</span>&nbsp;<span class="op" id="3745568">(</span><span class="ident" id="3745569">skip</span>&nbsp;<span class="builtintype" id="3745574">bool</span><span class="op" id="3745578">,</span>&nbsp;<span class="ident" id="3745580">skipmsg</span>&nbsp;<span class="builtintype" id="3745588">string</span><span class="op" id="3745594">,</span>&nbsp;<span class="ident" id="3745596">err</span>&nbsp;<span class="builtintype" id="3745600">error</span><span class="op" id="3745605">)</span>&nbsp;<span class="op" id="3745607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3745610">if</span>&nbsp;<span class="ident" id="3745613">os</span><span class="op" id="3745615">.</span><span class="ident" id="3745616">Getuid</span><span class="op" id="3745622">(</span><span class="op" id="3745623">)</span>&nbsp;<span class="op" id="3745625">!=</span>&nbsp;<span class="num" id="3745628">0</span>&nbsp;<span class="op" id="3745630">{</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3745634">return</span>&nbsp;<span class="builtintype" id="3745641">true</span><span class="op" id="3745645">,</span>&nbsp;<span class="string" id="3745647">&#34;skipping&nbsp;test;&nbsp;must&nbsp;be&nbsp;root&#34;</span><span class="op" id="3745676">,</span>&nbsp;<span class="builtintype" id="3745678">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3745683">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3745686">return</span>&nbsp;<span class="builtintype" id="3745693">false</span><span class="op" id="3745698">,</span>&nbsp;<span class="string" id="3745700">&#34;&#34;</span><span class="op" id="3745702">,</span>&nbsp;<span class="builtintype" id="3745704">nil</span><br>
<span class="lineno"></span><span class="op" id="3745708">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
