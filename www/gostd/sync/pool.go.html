<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>sync</h2>
<ul>
<li><a href="/gostd/sync/cond.go.html">cond.go</a></li>
<li><a href="/gostd/sync/cond_test.go.html">cond_test.go</a></li>
<li><a href="/gostd/sync/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/sync/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/sync/mutex.go.html">mutex.go</a></li>
<li><a href="/gostd/sync/mutex_test.go.html">mutex_test.go</a></li>
<li><a href="/gostd/sync/once.go.html">once.go</a></li>
<li><a href="/gostd/sync/once_test.go.html">once_test.go</a></li>
<li><a href="/gostd/sync/pool.go.html" class="current">pool.go</a></li>
<li><a href="/gostd/sync/pool_test.go.html">pool_test.go</a></li>
<li><a href="/gostd/sync/race0.go.html">race0.go</a></li>
<li><a href="/gostd/sync/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/sync/runtime_sema_test.go.html">runtime_sema_test.go</a></li>
<li><a href="/gostd/sync/rwmutex.go.html">rwmutex.go</a></li>
<li><a href="/gostd/sync/rwmutex_test.go.html">rwmutex_test.go</a></li>
<li><a href="/gostd/sync/waitgroup.go.html">waitgroup.go</a></li>
<li><a href="/gostd/sync/waitgroup_test.go.html">waitgroup_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1412464">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1412519">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1412573">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1412624">package</span>&nbsp;<span class="ident" id="1412632">sync</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1412638">import</span>&nbsp;<span class="op" id="1412645">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1412648">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1412659">&#34;sync/atomic&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="1412674">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="1412683">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1412686">//&nbsp;A&nbsp;Pool&nbsp;is&nbsp;a&nbsp;set&nbsp;of&nbsp;temporary&nbsp;objects&nbsp;that&nbsp;may&nbsp;be&nbsp;individually&nbsp;saved&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="1412761">//&nbsp;retrieved.</span><br>
<span class="lineno">15</span><span class="comment" id="1412775">//</span><br>
<span class="lineno"></span><span class="comment" id="1412778">//&nbsp;Any&nbsp;item&nbsp;stored&nbsp;in&nbsp;the&nbsp;Pool&nbsp;may&nbsp;be&nbsp;removed&nbsp;automatically&nbsp;at&nbsp;any&nbsp;time&nbsp;without</span><br>
<span class="lineno"></span><span class="comment" id="1412858">//&nbsp;notification.&nbsp;If&nbsp;the&nbsp;Pool&nbsp;holds&nbsp;the&nbsp;only&nbsp;reference&nbsp;when&nbsp;this&nbsp;happens,&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1412935">//&nbsp;item&nbsp;might&nbsp;be&nbsp;deallocated.</span><br>
<span class="lineno"></span><span class="comment" id="1412965">//</span><br>
<span class="lineno">20</span><span class="comment" id="1412968">//&nbsp;A&nbsp;Pool&nbsp;is&nbsp;safe&nbsp;for&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines&nbsp;simultaneously.</span><br>
<span class="lineno"></span><span class="comment" id="1413033">//</span><br>
<span class="lineno"></span><span class="comment" id="1413036">//&nbsp;Pool&#39;s&nbsp;purpose&nbsp;is&nbsp;to&nbsp;cache&nbsp;allocated&nbsp;but&nbsp;unused&nbsp;items&nbsp;for&nbsp;later&nbsp;reuse,</span><br>
<span class="lineno"></span><span class="comment" id="1413110">//&nbsp;relieving&nbsp;pressure&nbsp;on&nbsp;the&nbsp;garbage&nbsp;collector.&nbsp;That&nbsp;is,&nbsp;it&nbsp;makes&nbsp;it&nbsp;easy&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1413187">//&nbsp;build&nbsp;efficient,&nbsp;thread-safe&nbsp;free&nbsp;lists.&nbsp;However,&nbsp;it&nbsp;is&nbsp;not&nbsp;suitable&nbsp;for&nbsp;all</span><br>
<span class="lineno">25</span><span class="comment" id="1413267">//&nbsp;free&nbsp;lists.</span><br>
<span class="lineno"></span><span class="comment" id="1413282">//</span><br>
<span class="lineno"></span><span class="comment" id="1413285">//&nbsp;An&nbsp;appropriate&nbsp;use&nbsp;of&nbsp;a&nbsp;Pool&nbsp;is&nbsp;to&nbsp;manage&nbsp;a&nbsp;group&nbsp;of&nbsp;temporary&nbsp;items</span><br>
<span class="lineno"></span><span class="comment" id="1413357">//&nbsp;silently&nbsp;shared&nbsp;among&nbsp;and&nbsp;potentially&nbsp;reused&nbsp;by&nbsp;concurrent&nbsp;independent</span><br>
<span class="lineno"></span><span class="comment" id="1413431">//&nbsp;clients&nbsp;of&nbsp;a&nbsp;package.&nbsp;Pool&nbsp;provides&nbsp;a&nbsp;way&nbsp;to&nbsp;amortize&nbsp;allocation&nbsp;overhead</span><br>
<span class="lineno">30</span><span class="comment" id="1413508">//&nbsp;across&nbsp;many&nbsp;clients.</span><br>
<span class="lineno"></span><span class="comment" id="1413532">//</span><br>
<span class="lineno"></span><span class="comment" id="1413535">//&nbsp;An&nbsp;example&nbsp;of&nbsp;good&nbsp;use&nbsp;of&nbsp;a&nbsp;Pool&nbsp;is&nbsp;in&nbsp;the&nbsp;fmt&nbsp;package,&nbsp;which&nbsp;maintains&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="1413612">//&nbsp;dynamically-sized&nbsp;store&nbsp;of&nbsp;temporary&nbsp;output&nbsp;buffers.&nbsp;The&nbsp;store&nbsp;scales&nbsp;under</span><br>
<span class="lineno"></span><span class="comment" id="1413691">//&nbsp;load&nbsp;(when&nbsp;many&nbsp;goroutines&nbsp;are&nbsp;actively&nbsp;printing)&nbsp;and&nbsp;shrinks&nbsp;when</span><br>
<span class="lineno">35</span><span class="comment" id="1413761">//&nbsp;quiescent.</span><br>
<span class="lineno"></span><span class="comment" id="1413775">//</span><br>
<span class="lineno"></span><span class="comment" id="1413778">//&nbsp;On&nbsp;the&nbsp;other&nbsp;hand,&nbsp;a&nbsp;free&nbsp;list&nbsp;maintained&nbsp;as&nbsp;part&nbsp;of&nbsp;a&nbsp;short-lived&nbsp;object&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1413858">//&nbsp;not&nbsp;a&nbsp;suitable&nbsp;use&nbsp;for&nbsp;a&nbsp;Pool,&nbsp;since&nbsp;the&nbsp;overhead&nbsp;does&nbsp;not&nbsp;amortize&nbsp;well&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="1413937">//&nbsp;that&nbsp;scenario.&nbsp;It&nbsp;is&nbsp;more&nbsp;efficient&nbsp;to&nbsp;have&nbsp;such&nbsp;objects&nbsp;implement&nbsp;their&nbsp;own</span><br>
<span class="lineno">40</span><span class="comment" id="1414017">//&nbsp;free&nbsp;list.</span><br>
<span class="lineno"></span><span class="comment" id="1414031">//</span><br>
<span class="lineno"></span><span class="keyword" id="1414034">type</span>&nbsp;<span class="ident" id="1414039">Pool</span>&nbsp;<span class="keyword" id="1414044">struct</span>&nbsp;<span class="op" id="1414051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1414054">local</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1414064">unsafe</span><span class="op" id="1414070">.</span><span class="ident" id="1414071">Pointer</span>&nbsp;<span class="comment" id="1414079">//&nbsp;local&nbsp;fixed-size&nbsp;per-P&nbsp;pool,&nbsp;actual&nbsp;type&nbsp;is&nbsp;[P]poolLocal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1414140">localSize</span>&nbsp;<span class="builtintype" id="1414150">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1414165">//&nbsp;size&nbsp;of&nbsp;the&nbsp;local&nbsp;array</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1414194">//&nbsp;New&nbsp;optionally&nbsp;specifies&nbsp;a&nbsp;function&nbsp;to&nbsp;generate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1414246">//&nbsp;a&nbsp;value&nbsp;when&nbsp;Get&nbsp;would&nbsp;otherwise&nbsp;return&nbsp;nil.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1414295">//&nbsp;It&nbsp;may&nbsp;not&nbsp;be&nbsp;changed&nbsp;concurrently&nbsp;with&nbsp;calls&nbsp;to&nbsp;Get.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1414353">New</span>&nbsp;<span class="keyword" id="1414357">func</span><span class="op" id="1414361">(</span><span class="op" id="1414362">)</span>&nbsp;<span class="keyword" id="1414364">interface</span><span class="op" id="1414373">{</span><span class="op" id="1414374">}</span><br>
<span class="lineno">50</span><span class="op" id="1414376">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1414379">//&nbsp;Local&nbsp;per-P&nbsp;Pool&nbsp;appendix.</span><br>
<span class="lineno"></span><span class="keyword" id="1414409">type</span>&nbsp;<span class="ident" id="1414414">poolLocal</span>&nbsp;<span class="keyword" id="1414424">struct</span>&nbsp;<span class="op" id="1414431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1414434">private</span>&nbsp;<span class="keyword" id="1414442">interface</span><span class="op" id="1414451">{</span><span class="op" id="1414452">}</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="1414456">//&nbsp;Can&nbsp;be&nbsp;used&nbsp;only&nbsp;by&nbsp;the&nbsp;respective&nbsp;P.</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1414498">shared</span>&nbsp;&nbsp;<span class="op" id="1414506">[</span><span class="op" id="1414507">]</span><span class="keyword" id="1414508">interface</span><span class="op" id="1414517">{</span><span class="op" id="1414518">}</span>&nbsp;<span class="comment" id="1414520">//&nbsp;Can&nbsp;be&nbsp;used&nbsp;by&nbsp;any&nbsp;P.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1414546">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1414568">//&nbsp;Protects&nbsp;shared.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1414589">pad</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1414597">[</span><span class="num" id="1414598">128</span><span class="op" id="1414601">]</span><span class="builtintype" id="1414602">byte</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1414611">//&nbsp;Prevents&nbsp;false&nbsp;sharing.</span><br>
<span class="lineno"></span><span class="op" id="1414638">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="1414641">//&nbsp;Put&nbsp;adds&nbsp;x&nbsp;to&nbsp;the&nbsp;pool.</span><br>
<span class="lineno"></span><span class="keyword" id="1414668">func</span>&nbsp;<span class="op" id="1414673">(</span><span class="ident" id="1414674">p</span>&nbsp;<span class="op" id="1414676">*</span><span class="ident" id="1414677">Pool</span><span class="op" id="1414681">)</span>&nbsp;<span class="ident" id="1414683">Put</span><span class="op" id="1414686">(</span><span class="ident" id="1414687">x</span>&nbsp;<span class="keyword" id="1414689">interface</span><span class="op" id="1414698">{</span><span class="op" id="1414699">}</span><span class="op" id="1414700">)</span>&nbsp;<span class="op" id="1414702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1414705">if</span>&nbsp;<span class="ident" id="1414708">raceenabled</span>&nbsp;<span class="op" id="1414720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1414724">//&nbsp;Under&nbsp;race&nbsp;detector&nbsp;the&nbsp;Pool&nbsp;degenerates&nbsp;into&nbsp;no-op.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1414782">//&nbsp;It&#39;s&nbsp;conforming,&nbsp;simple&nbsp;and&nbsp;does&nbsp;not&nbsp;introduce&nbsp;excessive</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1414844">//&nbsp;happens-before&nbsp;edges&nbsp;between&nbsp;unrelated&nbsp;goroutines.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1414900">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1414908">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1414911">if</span>&nbsp;<span class="ident" id="1414914">x</span>&nbsp;<span class="op" id="1414916">==</span>&nbsp;<span class="builtintype" id="1414919">nil</span>&nbsp;<span class="op" id="1414923">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1414927">return</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1414935">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1414938">l</span>&nbsp;<span class="op" id="1414940">:=</span>&nbsp;<span class="ident" id="1414943">p</span><span class="op" id="1414944">.</span><span class="ident" id="1414945">pin</span><span class="op" id="1414948">(</span><span class="op" id="1414949">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1414952">if</span>&nbsp;<span class="ident" id="1414955">l</span><span class="op" id="1414956">.</span><span class="ident" id="1414957">private</span>&nbsp;<span class="op" id="1414965">==</span>&nbsp;<span class="builtintype" id="1414968">nil</span>&nbsp;<span class="op" id="1414972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1414976">l</span><span class="op" id="1414977">.</span><span class="ident" id="1414978">private</span>&nbsp;<span class="op" id="1414986">=</span>&nbsp;<span class="ident" id="1414988">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1414992">x</span>&nbsp;<span class="op" id="1414994">=</span>&nbsp;<span class="builtintype" id="1414996">nil</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1415001">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1415004">runtime_procUnpin</span><span class="op" id="1415021">(</span><span class="op" id="1415022">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1415025">if</span>&nbsp;<span class="ident" id="1415028">x</span>&nbsp;<span class="op" id="1415030">==</span>&nbsp;<span class="builtintype" id="1415033">nil</span>&nbsp;<span class="op" id="1415037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1415041">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1415049">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1415052">l</span><span class="op" id="1415053">.</span><span class="ident" id="1415054">Lock</span><span class="op" id="1415058">(</span><span class="op" id="1415059">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1415062">l</span><span class="op" id="1415063">.</span><span class="ident" id="1415064">shared</span>&nbsp;<span class="op" id="1415071">=</span>&nbsp;<span class="builtinfunc" id="1415073">append</span><span class="op" id="1415079">(</span><span class="ident" id="1415080">l</span><span class="op" id="1415081">.</span><span class="ident" id="1415082">shared</span><span class="op" id="1415088">,</span>&nbsp;<span class="ident" id="1415090">x</span><span class="op" id="1415091">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1415094">l</span><span class="op" id="1415095">.</span><span class="ident" id="1415096">Unlock</span><span class="op" id="1415102">(</span><span class="op" id="1415103">)</span><br>
<span class="lineno"></span><span class="op" id="1415105">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">85</span><span class="comment" id="1415108">//&nbsp;Get&nbsp;selects&nbsp;an&nbsp;arbitrary&nbsp;item&nbsp;from&nbsp;the&nbsp;Pool,&nbsp;removes&nbsp;it&nbsp;from&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="1415176">//&nbsp;Pool,&nbsp;and&nbsp;returns&nbsp;it&nbsp;to&nbsp;the&nbsp;caller.</span><br>
<span class="lineno"></span><span class="comment" id="1415215">//&nbsp;Get&nbsp;may&nbsp;choose&nbsp;to&nbsp;ignore&nbsp;the&nbsp;pool&nbsp;and&nbsp;treat&nbsp;it&nbsp;as&nbsp;empty.</span><br>
<span class="lineno"></span><span class="comment" id="1415275">//&nbsp;Callers&nbsp;should&nbsp;not&nbsp;assume&nbsp;any&nbsp;relation&nbsp;between&nbsp;values&nbsp;passed&nbsp;to&nbsp;Put&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="1415350">//&nbsp;the&nbsp;values&nbsp;returned&nbsp;by&nbsp;Get.</span><br>
<span class="lineno">90</span><span class="comment" id="1415381">//</span><br>
<span class="lineno"></span><span class="comment" id="1415384">//&nbsp;If&nbsp;Get&nbsp;would&nbsp;otherwise&nbsp;return&nbsp;nil&nbsp;and&nbsp;p.New&nbsp;is&nbsp;non-nil,&nbsp;Get&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="1415455">//&nbsp;the&nbsp;result&nbsp;of&nbsp;calling&nbsp;p.New.</span><br>
<span class="lineno"></span><span class="keyword" id="1415487">func</span>&nbsp;<span class="op" id="1415492">(</span><span class="ident" id="1415493">p</span>&nbsp;<span class="op" id="1415495">*</span><span class="ident" id="1415496">Pool</span><span class="op" id="1415500">)</span>&nbsp;<span class="ident" id="1415502">Get</span><span class="op" id="1415505">(</span><span class="op" id="1415506">)</span>&nbsp;<span class="keyword" id="1415508">interface</span><span class="op" id="1415517">{</span><span class="op" id="1415518">}</span>&nbsp;<span class="op" id="1415520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1415523">if</span>&nbsp;<span class="ident" id="1415526">raceenabled</span>&nbsp;<span class="op" id="1415538">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1415542">if</span>&nbsp;<span class="ident" id="1415545">p</span><span class="op" id="1415546">.</span><span class="ident" id="1415547">New</span>&nbsp;<span class="op" id="1415551">!=</span>&nbsp;<span class="builtintype" id="1415554">nil</span>&nbsp;<span class="op" id="1415558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1415563">return</span>&nbsp;<span class="ident" id="1415570">p</span><span class="op" id="1415571">.</span><span class="ident" id="1415572">New</span><span class="op" id="1415575">(</span><span class="op" id="1415576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1415580">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1415584">return</span>&nbsp;<span class="builtintype" id="1415591">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1415596">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1415599">l</span>&nbsp;<span class="op" id="1415601">:=</span>&nbsp;<span class="ident" id="1415604">p</span><span class="op" id="1415605">.</span><span class="ident" id="1415606">pin</span><span class="op" id="1415609">(</span><span class="op" id="1415610">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1415613">x</span>&nbsp;<span class="op" id="1415615">:=</span>&nbsp;<span class="ident" id="1415618">l</span><span class="op" id="1415619">.</span><span class="ident" id="1415620">private</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1415629">l</span><span class="op" id="1415630">.</span><span class="ident" id="1415631">private</span>&nbsp;<span class="op" id="1415639">=</span>&nbsp;<span class="builtintype" id="1415641">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1415646">runtime_procUnpin</span><span class="op" id="1415663">(</span><span class="op" id="1415664">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1415667">if</span>&nbsp;<span class="ident" id="1415670">x</span>&nbsp;<span class="op" id="1415672">!=</span>&nbsp;<span class="builtintype" id="1415675">nil</span>&nbsp;<span class="op" id="1415679">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1415683">return</span>&nbsp;<span class="ident" id="1415690">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1415693">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1415696">l</span><span class="op" id="1415697">.</span><span class="ident" id="1415698">Lock</span><span class="op" id="1415702">(</span><span class="op" id="1415703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1415706">last</span>&nbsp;<span class="op" id="1415711">:=</span>&nbsp;<span class="builtinfunc" id="1415714">len</span><span class="op" id="1415717">(</span><span class="ident" id="1415718">l</span><span class="op" id="1415719">.</span><span class="ident" id="1415720">shared</span><span class="op" id="1415726">)</span>&nbsp;<span class="op" id="1415728">-</span>&nbsp;<span class="num" id="1415730">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1415733">if</span>&nbsp;<span class="ident" id="1415736">last</span>&nbsp;<span class="op" id="1415741">&gt;=</span>&nbsp;<span class="num" id="1415744">0</span>&nbsp;<span class="op" id="1415746">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1415750">x</span>&nbsp;<span class="op" id="1415752">=</span>&nbsp;<span class="ident" id="1415754">l</span><span class="op" id="1415755">.</span><span class="ident" id="1415756">shared</span><span class="op" id="1415762">[</span><span class="ident" id="1415763">last</span><span class="op" id="1415767">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1415771">l</span><span class="op" id="1415772">.</span><span class="ident" id="1415773">shared</span>&nbsp;<span class="op" id="1415780">=</span>&nbsp;<span class="ident" id="1415782">l</span><span class="op" id="1415783">.</span><span class="ident" id="1415784">shared</span><span class="op" id="1415790">[</span><span class="op" id="1415791">:</span><span class="ident" id="1415792">last</span><span class="op" id="1415796">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1415799">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1415802">l</span><span class="op" id="1415803">.</span><span class="ident" id="1415804">Unlock</span><span class="op" id="1415810">(</span><span class="op" id="1415811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1415814">if</span>&nbsp;<span class="ident" id="1415817">x</span>&nbsp;<span class="op" id="1415819">!=</span>&nbsp;<span class="builtintype" id="1415822">nil</span>&nbsp;<span class="op" id="1415826">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1415830">return</span>&nbsp;<span class="ident" id="1415837">x</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1415840">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1415843">return</span>&nbsp;<span class="ident" id="1415850">p</span><span class="op" id="1415851">.</span><span class="ident" id="1415852">getSlow</span><span class="op" id="1415859">(</span><span class="op" id="1415860">)</span><br>
<span class="lineno"></span><span class="op" id="1415862">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="keyword" id="1415865">func</span>&nbsp;<span class="op" id="1415870">(</span><span class="ident" id="1415871">p</span>&nbsp;<span class="op" id="1415873">*</span><span class="ident" id="1415874">Pool</span><span class="op" id="1415878">)</span>&nbsp;<span class="ident" id="1415880">getSlow</span><span class="op" id="1415887">(</span><span class="op" id="1415888">)</span>&nbsp;<span class="op" id="1415890">(</span><span class="ident" id="1415891">x</span>&nbsp;<span class="keyword" id="1415893">interface</span><span class="op" id="1415902">{</span><span class="op" id="1415903">}</span><span class="op" id="1415904">)</span>&nbsp;<span class="op" id="1415906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1415909">//&nbsp;See&nbsp;the&nbsp;comment&nbsp;in&nbsp;pin&nbsp;regarding&nbsp;ordering&nbsp;of&nbsp;the&nbsp;loads.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1415969">size</span>&nbsp;<span class="op" id="1415974">:=</span>&nbsp;<span class="ident" id="1415977">atomic</span><span class="op" id="1415983">.</span><span class="ident" id="1415984">LoadUintptr</span><span class="op" id="1415995">(</span><span class="op" id="1415996">&amp;</span><span class="ident" id="1415997">p</span><span class="op" id="1415998">.</span><span class="ident" id="1415999">localSize</span><span class="op" id="1416008">)</span>&nbsp;<span class="comment" id="1416010">//&nbsp;load-acquire</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1416027">local</span>&nbsp;<span class="op" id="1416033">:=</span>&nbsp;<span class="ident" id="1416036">p</span><span class="op" id="1416037">.</span><span class="ident" id="1416038">local</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1416068">//&nbsp;load-consume</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1416085">//&nbsp;Try&nbsp;to&nbsp;steal&nbsp;one&nbsp;element&nbsp;from&nbsp;other&nbsp;procs.</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1416132">pid</span>&nbsp;<span class="op" id="1416136">:=</span>&nbsp;<span class="ident" id="1416139">runtime_procPin</span><span class="op" id="1416154">(</span><span class="op" id="1416155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1416158">runtime_procUnpin</span><span class="op" id="1416175">(</span><span class="op" id="1416176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1416179">for</span>&nbsp;<span class="ident" id="1416183">i</span>&nbsp;<span class="op" id="1416185">:=</span>&nbsp;<span class="num" id="1416188">0</span><span class="op" id="1416189">;</span>&nbsp;<span class="ident" id="1416191">i</span>&nbsp;<span class="op" id="1416193">&lt;</span>&nbsp;<span class="builtintype" id="1416195">int</span><span class="op" id="1416198">(</span><span class="ident" id="1416199">size</span><span class="op" id="1416203">)</span><span class="op" id="1416204">;</span>&nbsp;<span class="ident" id="1416206">i</span><span class="op" id="1416207">++</span>&nbsp;<span class="op" id="1416210">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1416214">l</span>&nbsp;<span class="op" id="1416216">:=</span>&nbsp;<span class="ident" id="1416219">indexLocal</span><span class="op" id="1416229">(</span><span class="ident" id="1416230">local</span><span class="op" id="1416235">,</span>&nbsp;<span class="op" id="1416237">(</span><span class="ident" id="1416238">pid</span><span class="op" id="1416241">+</span><span class="ident" id="1416242">i</span><span class="op" id="1416243">+</span><span class="num" id="1416244">1</span><span class="op" id="1416245">)</span><span class="op" id="1416246">%</span><span class="builtintype" id="1416247">int</span><span class="op" id="1416250">(</span><span class="ident" id="1416251">size</span><span class="op" id="1416255">)</span><span class="op" id="1416256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1416260">l</span><span class="op" id="1416261">.</span><span class="ident" id="1416262">Lock</span><span class="op" id="1416266">(</span><span class="op" id="1416267">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1416271">last</span>&nbsp;<span class="op" id="1416276">:=</span>&nbsp;<span class="builtinfunc" id="1416279">len</span><span class="op" id="1416282">(</span><span class="ident" id="1416283">l</span><span class="op" id="1416284">.</span><span class="ident" id="1416285">shared</span><span class="op" id="1416291">)</span>&nbsp;<span class="op" id="1416293">-</span>&nbsp;<span class="num" id="1416295">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1416299">if</span>&nbsp;<span class="ident" id="1416302">last</span>&nbsp;<span class="op" id="1416307">&gt;=</span>&nbsp;<span class="num" id="1416310">0</span>&nbsp;<span class="op" id="1416312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1416317">x</span>&nbsp;<span class="op" id="1416319">=</span>&nbsp;<span class="ident" id="1416321">l</span><span class="op" id="1416322">.</span><span class="ident" id="1416323">shared</span><span class="op" id="1416329">[</span><span class="ident" id="1416330">last</span><span class="op" id="1416334">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1416339">l</span><span class="op" id="1416340">.</span><span class="ident" id="1416341">shared</span>&nbsp;<span class="op" id="1416348">=</span>&nbsp;<span class="ident" id="1416350">l</span><span class="op" id="1416351">.</span><span class="ident" id="1416352">shared</span><span class="op" id="1416358">[</span><span class="op" id="1416359">:</span><span class="ident" id="1416360">last</span><span class="op" id="1416364">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1416369">l</span><span class="op" id="1416370">.</span><span class="ident" id="1416371">Unlock</span><span class="op" id="1416377">(</span><span class="op" id="1416378">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1416383">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1416391">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1416395">l</span><span class="op" id="1416396">.</span><span class="ident" id="1416397">Unlock</span><span class="op" id="1416403">(</span><span class="op" id="1416404">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1416407">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1416411">if</span>&nbsp;<span class="ident" id="1416414">x</span>&nbsp;<span class="op" id="1416416">==</span>&nbsp;<span class="builtintype" id="1416419">nil</span>&nbsp;<span class="op" id="1416423">&amp;&amp;</span>&nbsp;<span class="ident" id="1416426">p</span><span class="op" id="1416427">.</span><span class="ident" id="1416428">New</span>&nbsp;<span class="op" id="1416432">!=</span>&nbsp;<span class="builtintype" id="1416435">nil</span>&nbsp;<span class="op" id="1416439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1416443">x</span>&nbsp;<span class="op" id="1416445">=</span>&nbsp;<span class="ident" id="1416447">p</span><span class="op" id="1416448">.</span><span class="ident" id="1416449">New</span><span class="op" id="1416452">(</span><span class="op" id="1416453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1416456">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1416459">return</span>&nbsp;<span class="ident" id="1416466">x</span><br>
<span class="lineno"></span><span class="op" id="1416468">}</span><br>
<span class="lineno">145</span><br>
<span class="lineno"></span><span class="comment" id="1416471">//&nbsp;pin&nbsp;pins&nbsp;the&nbsp;current&nbsp;goroutine&nbsp;to&nbsp;P,&nbsp;disables&nbsp;preemption&nbsp;and&nbsp;returns&nbsp;poolLocal&nbsp;pool&nbsp;for&nbsp;the&nbsp;P.</span><br>
<span class="lineno"></span><span class="comment" id="1416569">//&nbsp;Caller&nbsp;must&nbsp;call&nbsp;runtime_procUnpin()&nbsp;when&nbsp;done&nbsp;with&nbsp;the&nbsp;pool.</span><br>
<span class="lineno"></span><span class="keyword" id="1416634">func</span>&nbsp;<span class="op" id="1416639">(</span><span class="ident" id="1416640">p</span>&nbsp;<span class="op" id="1416642">*</span><span class="ident" id="1416643">Pool</span><span class="op" id="1416647">)</span>&nbsp;<span class="ident" id="1416649">pin</span><span class="op" id="1416652">(</span><span class="op" id="1416653">)</span>&nbsp;<span class="op" id="1416655">*</span><span class="ident" id="1416656">poolLocal</span>&nbsp;<span class="op" id="1416666">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1416669">pid</span>&nbsp;<span class="op" id="1416673">:=</span>&nbsp;<span class="ident" id="1416676">runtime_procPin</span><span class="op" id="1416691">(</span><span class="op" id="1416692">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1416695">//&nbsp;In&nbsp;pinSlow&nbsp;we&nbsp;store&nbsp;to&nbsp;localSize&nbsp;and&nbsp;then&nbsp;to&nbsp;local,&nbsp;here&nbsp;we&nbsp;load&nbsp;in&nbsp;opposite&nbsp;order.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1416783">//&nbsp;Since&nbsp;we&#39;ve&nbsp;disabled&nbsp;preemption,&nbsp;GC&nbsp;can&nbsp;not&nbsp;happen&nbsp;in&nbsp;between.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1416850">//&nbsp;Thus&nbsp;here&nbsp;we&nbsp;must&nbsp;observe&nbsp;local&nbsp;at&nbsp;least&nbsp;as&nbsp;large&nbsp;localSize.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1416915">//&nbsp;We&nbsp;can&nbsp;observe&nbsp;a&nbsp;newer/larger&nbsp;local,&nbsp;it&nbsp;is&nbsp;fine&nbsp;(we&nbsp;must&nbsp;observe&nbsp;its&nbsp;zero-initialized-ness).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1417012">s</span>&nbsp;<span class="op" id="1417014">:=</span>&nbsp;<span class="ident" id="1417017">atomic</span><span class="op" id="1417023">.</span><span class="ident" id="1417024">LoadUintptr</span><span class="op" id="1417035">(</span><span class="op" id="1417036">&amp;</span><span class="ident" id="1417037">p</span><span class="op" id="1417038">.</span><span class="ident" id="1417039">localSize</span><span class="op" id="1417048">)</span>&nbsp;<span class="comment" id="1417050">//&nbsp;load-acquire</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1417067">l</span>&nbsp;<span class="op" id="1417069">:=</span>&nbsp;<span class="ident" id="1417072">p</span><span class="op" id="1417073">.</span><span class="ident" id="1417074">local</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1417105">//&nbsp;load-consume</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1417122">if</span>&nbsp;<span class="builtintype" id="1417125">uintptr</span><span class="op" id="1417132">(</span><span class="ident" id="1417133">pid</span><span class="op" id="1417136">)</span>&nbsp;<span class="op" id="1417138">&lt;</span>&nbsp;<span class="ident" id="1417140">s</span>&nbsp;<span class="op" id="1417142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1417146">return</span>&nbsp;<span class="ident" id="1417153">indexLocal</span><span class="op" id="1417163">(</span><span class="ident" id="1417164">l</span><span class="op" id="1417165">,</span>&nbsp;<span class="ident" id="1417167">pid</span><span class="op" id="1417170">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1417173">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1417176">return</span>&nbsp;<span class="ident" id="1417183">p</span><span class="op" id="1417184">.</span><span class="ident" id="1417185">pinSlow</span><span class="op" id="1417192">(</span><span class="op" id="1417193">)</span><br>
<span class="lineno">160</span><span class="op" id="1417195">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1417198">func</span>&nbsp;<span class="op" id="1417203">(</span><span class="ident" id="1417204">p</span>&nbsp;<span class="op" id="1417206">*</span><span class="ident" id="1417207">Pool</span><span class="op" id="1417211">)</span>&nbsp;<span class="ident" id="1417213">pinSlow</span><span class="op" id="1417220">(</span><span class="op" id="1417221">)</span>&nbsp;<span class="op" id="1417223">*</span><span class="ident" id="1417224">poolLocal</span>&nbsp;<span class="op" id="1417234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1417237">//&nbsp;Retry&nbsp;under&nbsp;the&nbsp;mutex.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1417264">//&nbsp;Can&nbsp;not&nbsp;lock&nbsp;the&nbsp;mutex&nbsp;while&nbsp;pinned.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1417305">runtime_procUnpin</span><span class="op" id="1417322">(</span><span class="op" id="1417323">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1417326">allPoolsMu</span><span class="op" id="1417336">.</span><span class="ident" id="1417337">Lock</span><span class="op" id="1417341">(</span><span class="op" id="1417342">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1417345">defer</span>&nbsp;<span class="ident" id="1417351">allPoolsMu</span><span class="op" id="1417361">.</span><span class="ident" id="1417362">Unlock</span><span class="op" id="1417368">(</span><span class="op" id="1417369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1417372">pid</span>&nbsp;<span class="op" id="1417376">:=</span>&nbsp;<span class="ident" id="1417379">runtime_procPin</span><span class="op" id="1417394">(</span><span class="op" id="1417395">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1417398">//&nbsp;poolCleanup&nbsp;won&#39;t&nbsp;be&nbsp;called&nbsp;while&nbsp;we&nbsp;are&nbsp;pinned.</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1417451">s</span>&nbsp;<span class="op" id="1417453">:=</span>&nbsp;<span class="ident" id="1417456">p</span><span class="op" id="1417457">.</span><span class="ident" id="1417458">localSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1417469">l</span>&nbsp;<span class="op" id="1417471">:=</span>&nbsp;<span class="ident" id="1417474">p</span><span class="op" id="1417475">.</span><span class="ident" id="1417476">local</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1417483">if</span>&nbsp;<span class="builtintype" id="1417486">uintptr</span><span class="op" id="1417493">(</span><span class="ident" id="1417494">pid</span><span class="op" id="1417497">)</span>&nbsp;<span class="op" id="1417499">&lt;</span>&nbsp;<span class="ident" id="1417501">s</span>&nbsp;<span class="op" id="1417503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1417507">return</span>&nbsp;<span class="ident" id="1417514">indexLocal</span><span class="op" id="1417524">(</span><span class="ident" id="1417525">l</span><span class="op" id="1417526">,</span>&nbsp;<span class="ident" id="1417528">pid</span><span class="op" id="1417531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1417534">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1417537">if</span>&nbsp;<span class="ident" id="1417540">p</span><span class="op" id="1417541">.</span><span class="ident" id="1417542">local</span>&nbsp;<span class="op" id="1417548">==</span>&nbsp;<span class="builtintype" id="1417551">nil</span>&nbsp;<span class="op" id="1417555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1417559">allPools</span>&nbsp;<span class="op" id="1417568">=</span>&nbsp;<span class="builtinfunc" id="1417570">append</span><span class="op" id="1417576">(</span><span class="ident" id="1417577">allPools</span><span class="op" id="1417585">,</span>&nbsp;<span class="ident" id="1417587">p</span><span class="op" id="1417588">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1417591">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1417594">//&nbsp;If&nbsp;GOMAXPROCS&nbsp;changes&nbsp;between&nbsp;GCs,&nbsp;we&nbsp;re-allocate&nbsp;the&nbsp;array&nbsp;and&nbsp;lose&nbsp;the&nbsp;old&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1417680">size</span>&nbsp;<span class="op" id="1417685">:=</span>&nbsp;<span class="ident" id="1417688">runtime</span><span class="op" id="1417695">.</span><span class="ident" id="1417696">GOMAXPROCS</span><span class="op" id="1417706">(</span><span class="num" id="1417707">0</span><span class="op" id="1417708">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1417711">local</span>&nbsp;<span class="op" id="1417717">:=</span>&nbsp;<span class="builtinfunc" id="1417720">make</span><span class="op" id="1417724">(</span><span class="op" id="1417725">[</span><span class="op" id="1417726">]</span><span class="ident" id="1417727">poolLocal</span><span class="op" id="1417736">,</span>&nbsp;<span class="ident" id="1417738">size</span><span class="op" id="1417742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1417745">atomic</span><span class="op" id="1417751">.</span><span class="ident" id="1417752">StorePointer</span><span class="op" id="1417764">(</span><span class="op" id="1417765">(</span><span class="op" id="1417766">*</span><span class="ident" id="1417767">unsafe</span><span class="op" id="1417773">.</span><span class="ident" id="1417774">Pointer</span><span class="op" id="1417781">)</span><span class="op" id="1417782">(</span><span class="op" id="1417783">&amp;</span><span class="ident" id="1417784">p</span><span class="op" id="1417785">.</span><span class="ident" id="1417786">local</span><span class="op" id="1417791">)</span><span class="op" id="1417792">,</span>&nbsp;<span class="ident" id="1417794">unsafe</span><span class="op" id="1417800">.</span><span class="ident" id="1417801">Pointer</span><span class="op" id="1417808">(</span><span class="op" id="1417809">&amp;</span><span class="ident" id="1417810">local</span><span class="op" id="1417815">[</span><span class="num" id="1417816">0</span><span class="op" id="1417817">]</span><span class="op" id="1417818">)</span><span class="op" id="1417819">)</span>&nbsp;<span class="comment" id="1417821">//&nbsp;store-release</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1417839">atomic</span><span class="op" id="1417845">.</span><span class="ident" id="1417846">StoreUintptr</span><span class="op" id="1417858">(</span><span class="op" id="1417859">&amp;</span><span class="ident" id="1417860">p</span><span class="op" id="1417861">.</span><span class="ident" id="1417862">localSize</span><span class="op" id="1417871">,</span>&nbsp;<span class="builtintype" id="1417873">uintptr</span><span class="op" id="1417880">(</span><span class="ident" id="1417881">size</span><span class="op" id="1417885">)</span><span class="op" id="1417886">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1417915">//&nbsp;store-release</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1417933">return</span>&nbsp;<span class="op" id="1417940">&amp;</span><span class="ident" id="1417941">local</span><span class="op" id="1417946">[</span><span class="ident" id="1417947">pid</span><span class="op" id="1417950">]</span><br>
<span class="lineno"></span><span class="op" id="1417952">}</span><br>
<span class="lineno">185</span><br>
<span class="lineno"></span><span class="keyword" id="1417955">func</span>&nbsp;<span class="ident" id="1417960">poolCleanup</span><span class="op" id="1417971">(</span><span class="op" id="1417972">)</span>&nbsp;<span class="op" id="1417974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1417977">//&nbsp;This&nbsp;function&nbsp;is&nbsp;called&nbsp;with&nbsp;the&nbsp;world&nbsp;stopped,&nbsp;at&nbsp;the&nbsp;beginning&nbsp;of&nbsp;a&nbsp;garbage&nbsp;collection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1418071">//&nbsp;It&nbsp;must&nbsp;not&nbsp;allocate&nbsp;and&nbsp;probably&nbsp;should&nbsp;not&nbsp;call&nbsp;any&nbsp;runtime&nbsp;functions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1418148">//&nbsp;Defensively&nbsp;zero&nbsp;out&nbsp;everything,&nbsp;2&nbsp;reasons:</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1418196">//&nbsp;1.&nbsp;To&nbsp;prevent&nbsp;false&nbsp;retention&nbsp;of&nbsp;whole&nbsp;Pools.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1418246">//&nbsp;2.&nbsp;If&nbsp;GC&nbsp;happens&nbsp;while&nbsp;a&nbsp;goroutine&nbsp;works&nbsp;with&nbsp;l.shared&nbsp;in&nbsp;Put/Get,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1418317">//&nbsp;&nbsp;&nbsp;&nbsp;it&nbsp;will&nbsp;retain&nbsp;whole&nbsp;Pool.&nbsp;So&nbsp;next&nbsp;cycle&nbsp;memory&nbsp;consumption&nbsp;would&nbsp;be&nbsp;doubled.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1418402">for</span>&nbsp;<span class="ident" id="1418406">i</span><span class="op" id="1418407">,</span>&nbsp;<span class="ident" id="1418409">p</span>&nbsp;<span class="op" id="1418411">:=</span>&nbsp;<span class="keyword" id="1418414">range</span>&nbsp;<span class="ident" id="1418420">allPools</span>&nbsp;<span class="op" id="1418429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1418433">allPools</span><span class="op" id="1418441">[</span><span class="ident" id="1418442">i</span><span class="op" id="1418443">]</span>&nbsp;<span class="op" id="1418445">=</span>&nbsp;<span class="builtintype" id="1418447">nil</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1418453">for</span>&nbsp;<span class="ident" id="1418457">i</span>&nbsp;<span class="op" id="1418459">:=</span>&nbsp;<span class="num" id="1418462">0</span><span class="op" id="1418463">;</span>&nbsp;<span class="ident" id="1418465">i</span>&nbsp;<span class="op" id="1418467">&lt;</span>&nbsp;<span class="builtintype" id="1418469">int</span><span class="op" id="1418472">(</span><span class="ident" id="1418473">p</span><span class="op" id="1418474">.</span><span class="ident" id="1418475">localSize</span><span class="op" id="1418484">)</span><span class="op" id="1418485">;</span>&nbsp;<span class="ident" id="1418487">i</span><span class="op" id="1418488">++</span>&nbsp;<span class="op" id="1418491">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1418496">l</span>&nbsp;<span class="op" id="1418498">:=</span>&nbsp;<span class="ident" id="1418501">indexLocal</span><span class="op" id="1418511">(</span><span class="ident" id="1418512">p</span><span class="op" id="1418513">.</span><span class="ident" id="1418514">local</span><span class="op" id="1418519">,</span>&nbsp;<span class="ident" id="1418521">i</span><span class="op" id="1418522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1418527">l</span><span class="op" id="1418528">.</span><span class="ident" id="1418529">private</span>&nbsp;<span class="op" id="1418537">=</span>&nbsp;<span class="builtintype" id="1418539">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1418546">for</span>&nbsp;<span class="ident" id="1418550">j</span>&nbsp;<span class="op" id="1418552">:=</span>&nbsp;<span class="keyword" id="1418555">range</span>&nbsp;<span class="ident" id="1418561">l</span><span class="op" id="1418562">.</span><span class="ident" id="1418563">shared</span>&nbsp;<span class="op" id="1418570">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1418576">l</span><span class="op" id="1418577">.</span><span class="ident" id="1418578">shared</span><span class="op" id="1418584">[</span><span class="ident" id="1418585">j</span><span class="op" id="1418586">]</span>&nbsp;<span class="op" id="1418588">=</span>&nbsp;<span class="builtintype" id="1418590">nil</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1418597">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1418602">l</span><span class="op" id="1418603">.</span><span class="ident" id="1418604">shared</span>&nbsp;<span class="op" id="1418611">=</span>&nbsp;<span class="builtintype" id="1418613">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1418619">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1418623">p</span><span class="op" id="1418624">.</span><span class="ident" id="1418625">local</span>&nbsp;<span class="op" id="1418631">=</span>&nbsp;<span class="builtintype" id="1418633">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1418639">p</span><span class="op" id="1418640">.</span><span class="ident" id="1418641">localSize</span>&nbsp;<span class="op" id="1418651">=</span>&nbsp;<span class="num" id="1418653">0</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1418656">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1418659">allPools</span>&nbsp;<span class="op" id="1418668">=</span>&nbsp;<span class="op" id="1418670">[</span><span class="op" id="1418671">]</span><span class="op" id="1418672">*</span><span class="ident" id="1418673">Pool</span><span class="op" id="1418677">{</span><span class="op" id="1418678">}</span><br>
<span class="lineno"></span><span class="op" id="1418680">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1418683">var</span>&nbsp;<span class="op" id="1418687">(</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1418690">allPoolsMu</span>&nbsp;<span class="ident" id="1418701">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1418708">allPools</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1418719">[</span><span class="op" id="1418720">]</span><span class="op" id="1418721">*</span><span class="ident" id="1418722">Pool</span><br>
<span class="lineno"></span><span class="op" id="1418727">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1418730">func</span>&nbsp;<span class="ident" id="1418735">init</span><span class="op" id="1418739">(</span><span class="op" id="1418740">)</span>&nbsp;<span class="op" id="1418742">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1418745">runtime_registerPoolCleanup</span><span class="op" id="1418772">(</span><span class="ident" id="1418773">poolCleanup</span><span class="op" id="1418784">)</span><br>
<span class="lineno"></span><span class="op" id="1418786">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1418789">func</span>&nbsp;<span class="ident" id="1418794">indexLocal</span><span class="op" id="1418804">(</span><span class="ident" id="1418805">l</span>&nbsp;<span class="ident" id="1418807">unsafe</span><span class="op" id="1418813">.</span><span class="ident" id="1418814">Pointer</span><span class="op" id="1418821">,</span>&nbsp;<span class="ident" id="1418823">i</span>&nbsp;<span class="builtintype" id="1418825">int</span><span class="op" id="1418828">)</span>&nbsp;<span class="op" id="1418830">*</span><span class="ident" id="1418831">poolLocal</span>&nbsp;<span class="op" id="1418841">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="1418844">return</span>&nbsp;<span class="op" id="1418851">&amp;</span><span class="op" id="1418852">(</span><span class="op" id="1418853">*</span><span class="op" id="1418854">[</span><span class="num" id="1418855">1000000</span><span class="op" id="1418862">]</span><span class="ident" id="1418863">poolLocal</span><span class="op" id="1418872">)</span><span class="op" id="1418873">(</span><span class="ident" id="1418874">l</span><span class="op" id="1418875">)</span><span class="op" id="1418876">[</span><span class="ident" id="1418877">i</span><span class="op" id="1418878">]</span><br>
<span class="lineno">220</span><span class="op" id="1418880">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1418883">//&nbsp;Implemented&nbsp;in&nbsp;runtime.</span><br>
<span class="lineno"></span><span class="keyword" id="1418910">func</span>&nbsp;<span class="ident" id="1418915">runtime_registerPoolCleanup</span><span class="op" id="1418942">(</span><span class="ident" id="1418943">cleanup</span>&nbsp;<span class="keyword" id="1418951">func</span><span class="op" id="1418955">(</span><span class="op" id="1418956">)</span><span class="op" id="1418957">)</span><br>
<span class="lineno"></span><span class="keyword" id="1418959">func</span>&nbsp;<span class="ident" id="1418964">runtime_procPin</span><span class="op" id="1418979">(</span><span class="op" id="1418980">)</span>&nbsp;<span class="builtintype" id="1418982">int</span><br>
<span class="lineno">225</span><span class="keyword" id="1418986">func</span>&nbsp;<span class="ident" id="1418991">runtime_procUnpin</span><span class="op" id="1419008">(</span><span class="op" id="1419009">)</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
