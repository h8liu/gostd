<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/cipher</h2>
<ul>
<li><a href="/gostd/crypto/cipher/benchmark_test.go.html">benchmark_test.go</a></li>
<li><a href="/gostd/crypto/cipher/cbc.go.html">cbc.go</a></li>
<li><a href="/gostd/crypto/cipher/cbc_aes_test.go.html">cbc_aes_test.go</a></li>
<li><a href="/gostd/crypto/cipher/cfb.go.html">cfb.go</a></li>
<li><a href="/gostd/crypto/cipher/cfb_test.go.html">cfb_test.go</a></li>
<li><a href="/gostd/crypto/cipher/cipher.go.html">cipher.go</a></li>
<li><a href="/gostd/crypto/cipher/cipher_test.go.html">cipher_test.go</a></li>
<li><a href="/gostd/crypto/cipher/common_test.go.html">common_test.go</a></li>
<li><a href="/gostd/crypto/cipher/ctr.go.html">ctr.go</a></li>
<li><a href="/gostd/crypto/cipher/ctr_aes_test.go.html">ctr_aes_test.go</a></li>
<li><a href="/gostd/crypto/cipher/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/cipher/gcm.go.html" class="current">gcm.go</a></li>
<li><a href="/gostd/crypto/cipher/gcm_test.go.html">gcm_test.go</a></li>
<li><a href="/gostd/crypto/cipher/io.go.html">io.go</a></li>
<li><a href="/gostd/crypto/cipher/ofb.go.html">ofb.go</a></li>
<li><a href="/gostd/crypto/cipher/ofb_test.go.html">ofb_test.go</a></li>
<li><a href="/gostd/crypto/cipher/xor.go.html">xor.go</a></li>
<li><a href="/gostd/crypto/cipher/xor_test.go.html">xor_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4031112">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4031167">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4031221">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4031272">package</span>&nbsp;<span class="ident" id="4031280">cipher</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4031288">import</span>&nbsp;<span class="op" id="4031295">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4031298">&#34;crypto/subtle&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4031315">&#34;errors&#34;</span><br>
<span class="lineno">10</span><span class="op" id="4031324">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4031327">//&nbsp;AEAD&nbsp;is&nbsp;a&nbsp;cipher&nbsp;mode&nbsp;providing&nbsp;authenticated&nbsp;encryption&nbsp;with&nbsp;associated</span><br>
<span class="lineno"></span><span class="comment" id="4031403">//&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="4031412">type</span>&nbsp;<span class="ident" id="4031417">AEAD</span>&nbsp;<span class="keyword" id="4031422">interface</span>&nbsp;<span class="op" id="4031432">{</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4031435">//&nbsp;NonceSize&nbsp;returns&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;nonce&nbsp;that&nbsp;must&nbsp;be&nbsp;passed&nbsp;to&nbsp;Seal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4031507">//&nbsp;and&nbsp;Open.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4031521">NonceSize</span><span class="op" id="4031530">(</span><span class="op" id="4031531">)</span>&nbsp;<span class="builtintype" id="4031533">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4031539">//&nbsp;Overhead&nbsp;returns&nbsp;the&nbsp;maximum&nbsp;difference&nbsp;between&nbsp;the&nbsp;lengths&nbsp;of&nbsp;a</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4031608">//&nbsp;plaintext&nbsp;and&nbsp;ciphertext.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4031638">Overhead</span><span class="op" id="4031646">(</span><span class="op" id="4031647">)</span>&nbsp;<span class="builtintype" id="4031649">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4031655">//&nbsp;Seal&nbsp;encrypts&nbsp;and&nbsp;authenticates&nbsp;plaintext,&nbsp;authenticates&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4031720">//&nbsp;additional&nbsp;data&nbsp;and&nbsp;appends&nbsp;the&nbsp;result&nbsp;to&nbsp;dst,&nbsp;returning&nbsp;the&nbsp;updated</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4031793">//&nbsp;slice.&nbsp;The&nbsp;nonce&nbsp;must&nbsp;be&nbsp;NonceSize()&nbsp;bytes&nbsp;long&nbsp;and&nbsp;unique&nbsp;for&nbsp;all</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4031864">//&nbsp;time,&nbsp;for&nbsp;a&nbsp;given&nbsp;key.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4031891">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4031895">//&nbsp;The&nbsp;plaintext&nbsp;and&nbsp;dst&nbsp;may&nbsp;alias&nbsp;exactly&nbsp;or&nbsp;not&nbsp;at&nbsp;all.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4031954">Seal</span><span class="op" id="4031958">(</span><span class="ident" id="4031959">dst</span><span class="op" id="4031962">,</span>&nbsp;<span class="ident" id="4031964">nonce</span><span class="op" id="4031969">,</span>&nbsp;<span class="ident" id="4031971">plaintext</span><span class="op" id="4031980">,</span>&nbsp;<span class="ident" id="4031982">data</span>&nbsp;<span class="op" id="4031987">[</span><span class="op" id="4031988">]</span><span class="builtintype" id="4031989">byte</span><span class="op" id="4031993">)</span>&nbsp;<span class="op" id="4031995">[</span><span class="op" id="4031996">]</span><span class="builtintype" id="4031997">byte</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4032004">//&nbsp;Open&nbsp;decrypts&nbsp;and&nbsp;authenticates&nbsp;ciphertext,&nbsp;authenticates&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4032070">//&nbsp;additional&nbsp;data&nbsp;and,&nbsp;if&nbsp;successful,&nbsp;appends&nbsp;the&nbsp;resulting&nbsp;plaintext</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4032142">//&nbsp;to&nbsp;dst,&nbsp;returning&nbsp;the&nbsp;updated&nbsp;slice.&nbsp;The&nbsp;nonce&nbsp;must&nbsp;be&nbsp;NonceSize()</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4032213">//&nbsp;bytes&nbsp;long&nbsp;and&nbsp;both&nbsp;it&nbsp;and&nbsp;the&nbsp;additional&nbsp;data&nbsp;must&nbsp;match&nbsp;the</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4032279">//&nbsp;value&nbsp;passed&nbsp;to&nbsp;Seal.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4032305">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4032309">//&nbsp;The&nbsp;ciphertext&nbsp;and&nbsp;dst&nbsp;may&nbsp;alias&nbsp;exactly&nbsp;or&nbsp;not&nbsp;at&nbsp;all.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4032369">Open</span><span class="op" id="4032373">(</span><span class="ident" id="4032374">dst</span><span class="op" id="4032377">,</span>&nbsp;<span class="ident" id="4032379">nonce</span><span class="op" id="4032384">,</span>&nbsp;<span class="ident" id="4032386">ciphertext</span><span class="op" id="4032396">,</span>&nbsp;<span class="ident" id="4032398">data</span>&nbsp;<span class="op" id="4032403">[</span><span class="op" id="4032404">]</span><span class="builtintype" id="4032405">byte</span><span class="op" id="4032409">)</span>&nbsp;<span class="op" id="4032411">(</span><span class="op" id="4032412">[</span><span class="op" id="4032413">]</span><span class="builtintype" id="4032414">byte</span><span class="op" id="4032418">,</span>&nbsp;<span class="builtintype" id="4032420">error</span><span class="op" id="4032425">)</span><br>
<span class="lineno"></span><span class="op" id="4032427">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="comment" id="4032430">//&nbsp;gcmFieldElement&nbsp;represents&nbsp;a&nbsp;value&nbsp;in&nbsp;GF(2¹²⁸).&nbsp;In&nbsp;order&nbsp;to&nbsp;reflect&nbsp;the&nbsp;GCM</span><br>
<span class="lineno"></span><span class="comment" id="4032513">//&nbsp;standard&nbsp;and&nbsp;make&nbsp;getUint64&nbsp;suitable&nbsp;for&nbsp;marshaling&nbsp;these&nbsp;values,&nbsp;the&nbsp;bits</span><br>
<span class="lineno"></span><span class="comment" id="4032591">//&nbsp;are&nbsp;stored&nbsp;backwards.&nbsp;For&nbsp;example:</span><br>
<span class="lineno"></span><span class="comment" id="4032629">//&nbsp;&nbsp;&nbsp;the&nbsp;coefficient&nbsp;of&nbsp;x⁰&nbsp;can&nbsp;be&nbsp;obtained&nbsp;by&nbsp;v.low&nbsp;&gt;&gt;&nbsp;63.</span><br>
<span class="lineno">45</span><span class="comment" id="4032690">//&nbsp;&nbsp;&nbsp;the&nbsp;coefficient&nbsp;of&nbsp;x⁶³&nbsp;can&nbsp;be&nbsp;obtained&nbsp;by&nbsp;v.low&nbsp;&amp;&nbsp;1.</span><br>
<span class="lineno"></span><span class="comment" id="4032751">//&nbsp;&nbsp;&nbsp;the&nbsp;coefficient&nbsp;of&nbsp;x⁶⁴&nbsp;can&nbsp;be&nbsp;obtained&nbsp;by&nbsp;v.high&nbsp;&gt;&gt;&nbsp;63.</span><br>
<span class="lineno"></span><span class="comment" id="4032816">//&nbsp;&nbsp;&nbsp;the&nbsp;coefficient&nbsp;of&nbsp;x¹²⁷&nbsp;can&nbsp;be&nbsp;obtained&nbsp;by&nbsp;v.high&nbsp;&amp;&nbsp;1.</span><br>
<span class="lineno"></span><span class="keyword" id="4032880">type</span>&nbsp;<span class="ident" id="4032885">gcmFieldElement</span>&nbsp;<span class="keyword" id="4032901">struct</span>&nbsp;<span class="op" id="4032908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4032911">low</span><span class="op" id="4032914">,</span>&nbsp;<span class="ident" id="4032916">high</span>&nbsp;<span class="builtintype" id="4032921">uint64</span><br>
<span class="lineno">50</span><span class="op" id="4032928">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4032931">//&nbsp;gcm&nbsp;represents&nbsp;a&nbsp;Galois&nbsp;Counter&nbsp;Mode&nbsp;with&nbsp;a&nbsp;specific&nbsp;key.&nbsp;See</span><br>
<span class="lineno"></span><span class="comment" id="4032996">//&nbsp;http://csrc.nist.gov/groups/ST/toolkit/BCM/documents/proposedmodes/gcm/gcm-revised-spec.pdf</span><br>
<span class="lineno"></span><span class="keyword" id="4033091">type</span>&nbsp;<span class="ident" id="4033096">gcm</span>&nbsp;<span class="keyword" id="4033100">struct</span>&nbsp;<span class="op" id="4033107">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4033110">cipher</span>&nbsp;<span class="ident" id="4033117">Block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4033124">//&nbsp;productTable&nbsp;contains&nbsp;the&nbsp;first&nbsp;sixteen&nbsp;powers&nbsp;of&nbsp;the&nbsp;key,&nbsp;H.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4033190">//&nbsp;However,&nbsp;they&nbsp;are&nbsp;in&nbsp;bit&nbsp;reversed&nbsp;order.&nbsp;See&nbsp;NewGCM.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4033247">productTable</span>&nbsp;<span class="op" id="4033260">[</span><span class="num" id="4033261">16</span><span class="op" id="4033263">]</span><span class="ident" id="4033264">gcmFieldElement</span><br>
<span class="lineno"></span><span class="op" id="4033280">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="comment" id="4033283">//&nbsp;NewGCM&nbsp;returns&nbsp;the&nbsp;given&nbsp;128-bit,&nbsp;block&nbsp;cipher&nbsp;wrapped&nbsp;in&nbsp;Galois&nbsp;Counter&nbsp;Mode.</span><br>
<span class="lineno"></span><span class="keyword" id="4033365">func</span>&nbsp;<span class="ident" id="4033370">NewGCM</span><span class="op" id="4033376">(</span><span class="ident" id="4033377">cipher</span>&nbsp;<span class="ident" id="4033384">Block</span><span class="op" id="4033389">)</span>&nbsp;<span class="op" id="4033391">(</span><span class="ident" id="4033392">AEAD</span><span class="op" id="4033396">,</span>&nbsp;<span class="builtintype" id="4033398">error</span><span class="op" id="4033403">)</span>&nbsp;<span class="op" id="4033405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4033408">if</span>&nbsp;<span class="ident" id="4033411">cipher</span><span class="op" id="4033417">.</span><span class="ident" id="4033418">BlockSize</span><span class="op" id="4033427">(</span><span class="op" id="4033428">)</span>&nbsp;<span class="op" id="4033430">!=</span>&nbsp;<span class="ident" id="4033433">gcmBlockSize</span>&nbsp;<span class="op" id="4033446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4033450">return</span>&nbsp;<span class="builtintype" id="4033457">nil</span><span class="op" id="4033460">,</span>&nbsp;<span class="ident" id="4033462">errors</span><span class="op" id="4033468">.</span><span class="ident" id="4033469">New</span><span class="op" id="4033472">(</span><span class="string" id="4033473">&#34;cipher:&nbsp;NewGCM&nbsp;requires&nbsp;128-bit&nbsp;block&nbsp;cipher&#34;</span><span class="op" id="4033519">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4033522">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4033526">var</span>&nbsp;<span class="ident" id="4033530">key</span>&nbsp;<span class="op" id="4033534">[</span><span class="ident" id="4033535">gcmBlockSize</span><span class="op" id="4033547">]</span><span class="builtintype" id="4033548">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4033554">cipher</span><span class="op" id="4033560">.</span><span class="ident" id="4033561">Encrypt</span><span class="op" id="4033568">(</span><span class="ident" id="4033569">key</span><span class="op" id="4033572">[</span><span class="op" id="4033573">:</span><span class="op" id="4033574">]</span><span class="op" id="4033575">,</span>&nbsp;<span class="ident" id="4033577">key</span><span class="op" id="4033580">[</span><span class="op" id="4033581">:</span><span class="op" id="4033582">]</span><span class="op" id="4033583">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4033587">g</span>&nbsp;<span class="op" id="4033589">:=</span>&nbsp;<span class="op" id="4033592">&amp;</span><span class="ident" id="4033593">gcm</span><span class="op" id="4033596">{</span><span class="ident" id="4033597">cipher</span><span class="op" id="4033603">:</span>&nbsp;<span class="ident" id="4033605">cipher</span><span class="op" id="4033611">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4033615">//&nbsp;We&nbsp;precompute&nbsp;16&nbsp;multiples&nbsp;of&nbsp;|key|.&nbsp;However,&nbsp;when&nbsp;we&nbsp;do&nbsp;lookups</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4033684">//&nbsp;into&nbsp;this&nbsp;table&nbsp;we&#39;ll&nbsp;be&nbsp;using&nbsp;bits&nbsp;from&nbsp;a&nbsp;field&nbsp;element&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4033749">//&nbsp;therefore&nbsp;the&nbsp;bits&nbsp;will&nbsp;be&nbsp;in&nbsp;the&nbsp;reverse&nbsp;order.&nbsp;So&nbsp;normally&nbsp;one</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4033818">//&nbsp;would&nbsp;expect,&nbsp;say,&nbsp;4*key&nbsp;to&nbsp;be&nbsp;in&nbsp;index&nbsp;4&nbsp;of&nbsp;the&nbsp;table&nbsp;but&nbsp;due&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4033888">//&nbsp;this&nbsp;bit&nbsp;ordering&nbsp;it&nbsp;will&nbsp;actually&nbsp;be&nbsp;in&nbsp;index&nbsp;0010&nbsp;(base&nbsp;2)&nbsp;=&nbsp;2.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4033958">x</span>&nbsp;<span class="op" id="4033960">:=</span>&nbsp;<span class="ident" id="4033963">gcmFieldElement</span><span class="op" id="4033978">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4033982">getUint64</span><span class="op" id="4033991">(</span><span class="ident" id="4033992">key</span><span class="op" id="4033995">[</span><span class="op" id="4033996">:</span><span class="num" id="4033997">8</span><span class="op" id="4033998">]</span><span class="op" id="4033999">)</span><span class="op" id="4034000">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4034004">getUint64</span><span class="op" id="4034013">(</span><span class="ident" id="4034014">key</span><span class="op" id="4034017">[</span><span class="num" id="4034018">8</span><span class="op" id="4034019">:</span><span class="op" id="4034020">]</span><span class="op" id="4034021">)</span><span class="op" id="4034022">,</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4034025">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4034028">g</span><span class="op" id="4034029">.</span><span class="ident" id="4034030">productTable</span><span class="op" id="4034042">[</span><span class="ident" id="4034043">reverseBits</span><span class="op" id="4034054">(</span><span class="num" id="4034055">1</span><span class="op" id="4034056">)</span><span class="op" id="4034057">]</span>&nbsp;<span class="op" id="4034059">=</span>&nbsp;<span class="ident" id="4034061">x</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4034065">for</span>&nbsp;<span class="ident" id="4034069">i</span>&nbsp;<span class="op" id="4034071">:=</span>&nbsp;<span class="num" id="4034074">2</span><span class="op" id="4034075">;</span>&nbsp;<span class="ident" id="4034077">i</span>&nbsp;<span class="op" id="4034079">&lt;</span>&nbsp;<span class="num" id="4034081">16</span><span class="op" id="4034083">;</span>&nbsp;<span class="ident" id="4034085">i</span>&nbsp;<span class="op" id="4034087">+=</span>&nbsp;<span class="num" id="4034090">2</span>&nbsp;<span class="op" id="4034092">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4034096">g</span><span class="op" id="4034097">.</span><span class="ident" id="4034098">productTable</span><span class="op" id="4034110">[</span><span class="ident" id="4034111">reverseBits</span><span class="op" id="4034122">(</span><span class="ident" id="4034123">i</span><span class="op" id="4034124">)</span><span class="op" id="4034125">]</span>&nbsp;<span class="op" id="4034127">=</span>&nbsp;<span class="ident" id="4034129">gcmDouble</span><span class="op" id="4034138">(</span><span class="op" id="4034139">&amp;</span><span class="ident" id="4034140">g</span><span class="op" id="4034141">.</span><span class="ident" id="4034142">productTable</span><span class="op" id="4034154">[</span><span class="ident" id="4034155">reverseBits</span><span class="op" id="4034166">(</span><span class="ident" id="4034167">i</span><span class="op" id="4034168">/</span><span class="num" id="4034169">2</span><span class="op" id="4034170">)</span><span class="op" id="4034171">]</span><span class="op" id="4034172">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4034176">g</span><span class="op" id="4034177">.</span><span class="ident" id="4034178">productTable</span><span class="op" id="4034190">[</span><span class="ident" id="4034191">reverseBits</span><span class="op" id="4034202">(</span><span class="ident" id="4034203">i</span><span class="op" id="4034204">+</span><span class="num" id="4034205">1</span><span class="op" id="4034206">)</span><span class="op" id="4034207">]</span>&nbsp;<span class="op" id="4034209">=</span>&nbsp;<span class="ident" id="4034211">gcmAdd</span><span class="op" id="4034217">(</span><span class="op" id="4034218">&amp;</span><span class="ident" id="4034219">g</span><span class="op" id="4034220">.</span><span class="ident" id="4034221">productTable</span><span class="op" id="4034233">[</span><span class="ident" id="4034234">reverseBits</span><span class="op" id="4034245">(</span><span class="ident" id="4034246">i</span><span class="op" id="4034247">)</span><span class="op" id="4034248">]</span><span class="op" id="4034249">,</span>&nbsp;<span class="op" id="4034251">&amp;</span><span class="ident" id="4034252">x</span><span class="op" id="4034253">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4034256">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4034260">return</span>&nbsp;<span class="ident" id="4034267">g</span><span class="op" id="4034268">,</span>&nbsp;<span class="builtintype" id="4034270">nil</span><br>
<span class="lineno"></span><span class="op" id="4034274">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="keyword" id="4034277">const</span>&nbsp;<span class="op" id="4034283">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4034286">gcmBlockSize</span>&nbsp;<span class="op" id="4034299">=</span>&nbsp;<span class="num" id="4034301">16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4034305">gcmTagSize</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4034318">=</span>&nbsp;<span class="num" id="4034320">16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4034324">gcmNonceSize</span>&nbsp;<span class="op" id="4034337">=</span>&nbsp;<span class="num" id="4034339">12</span><br>
<span class="lineno">95</span><span class="op" id="4034342">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4034345">func</span>&nbsp;<span class="op" id="4034350">(</span><span class="op" id="4034351">*</span><span class="ident" id="4034352">gcm</span><span class="op" id="4034355">)</span>&nbsp;<span class="ident" id="4034357">NonceSize</span><span class="op" id="4034366">(</span><span class="op" id="4034367">)</span>&nbsp;<span class="builtintype" id="4034369">int</span>&nbsp;<span class="op" id="4034373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4034376">return</span>&nbsp;<span class="ident" id="4034383">gcmNonceSize</span><br>
<span class="lineno"></span><span class="op" id="4034396">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword" id="4034399">func</span>&nbsp;<span class="op" id="4034404">(</span><span class="op" id="4034405">*</span><span class="ident" id="4034406">gcm</span><span class="op" id="4034409">)</span>&nbsp;<span class="ident" id="4034411">Overhead</span><span class="op" id="4034419">(</span><span class="op" id="4034420">)</span>&nbsp;<span class="builtintype" id="4034422">int</span>&nbsp;<span class="op" id="4034426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4034429">return</span>&nbsp;<span class="ident" id="4034436">gcmTagSize</span><br>
<span class="lineno"></span><span class="op" id="4034447">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="keyword" id="4034450">func</span>&nbsp;<span class="op" id="4034455">(</span><span class="ident" id="4034456">g</span>&nbsp;<span class="op" id="4034458">*</span><span class="ident" id="4034459">gcm</span><span class="op" id="4034462">)</span>&nbsp;<span class="ident" id="4034464">Seal</span><span class="op" id="4034468">(</span><span class="ident" id="4034469">dst</span><span class="op" id="4034472">,</span>&nbsp;<span class="ident" id="4034474">nonce</span><span class="op" id="4034479">,</span>&nbsp;<span class="ident" id="4034481">plaintext</span><span class="op" id="4034490">,</span>&nbsp;<span class="ident" id="4034492">data</span>&nbsp;<span class="op" id="4034497">[</span><span class="op" id="4034498">]</span><span class="builtintype" id="4034499">byte</span><span class="op" id="4034503">)</span>&nbsp;<span class="op" id="4034505">[</span><span class="op" id="4034506">]</span><span class="builtintype" id="4034507">byte</span>&nbsp;<span class="op" id="4034512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4034515">if</span>&nbsp;<span class="builtinfunc" id="4034518">len</span><span class="op" id="4034521">(</span><span class="ident" id="4034522">nonce</span><span class="op" id="4034527">)</span>&nbsp;<span class="op" id="4034529">!=</span>&nbsp;<span class="ident" id="4034532">gcmNonceSize</span>&nbsp;<span class="op" id="4034545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4034549">panic</span><span class="op" id="4034554">(</span><span class="string" id="4034555">&#34;cipher:&nbsp;incorrect&nbsp;nonce&nbsp;length&nbsp;given&nbsp;to&nbsp;GCM&#34;</span><span class="op" id="4034600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4034603">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4034607">ret</span><span class="op" id="4034610">,</span>&nbsp;<span class="ident" id="4034612">out</span>&nbsp;<span class="op" id="4034616">:=</span>&nbsp;<span class="ident" id="4034619">sliceForAppend</span><span class="op" id="4034633">(</span><span class="ident" id="4034634">dst</span><span class="op" id="4034637">,</span>&nbsp;<span class="builtinfunc" id="4034639">len</span><span class="op" id="4034642">(</span><span class="ident" id="4034643">plaintext</span><span class="op" id="4034652">)</span><span class="op" id="4034653">+</span><span class="ident" id="4034654">gcmTagSize</span><span class="op" id="4034664">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4034668">//&nbsp;See&nbsp;GCM&nbsp;spec,&nbsp;section&nbsp;7.1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4034699">var</span>&nbsp;<span class="ident" id="4034703">counter</span><span class="op" id="4034710">,</span>&nbsp;<span class="ident" id="4034712">tagMask</span>&nbsp;<span class="op" id="4034720">[</span><span class="ident" id="4034721">gcmBlockSize</span><span class="op" id="4034733">]</span><span class="builtintype" id="4034734">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4034740">copy</span><span class="op" id="4034744">(</span><span class="ident" id="4034745">counter</span><span class="op" id="4034752">[</span><span class="op" id="4034753">:</span><span class="op" id="4034754">]</span><span class="op" id="4034755">,</span>&nbsp;<span class="ident" id="4034757">nonce</span><span class="op" id="4034762">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4034765">counter</span><span class="op" id="4034772">[</span><span class="ident" id="4034773">gcmBlockSize</span><span class="op" id="4034785">-</span><span class="num" id="4034786">1</span><span class="op" id="4034787">]</span>&nbsp;<span class="op" id="4034789">=</span>&nbsp;<span class="num" id="4034791">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4034795">g</span><span class="op" id="4034796">.</span><span class="ident" id="4034797">cipher</span><span class="op" id="4034803">.</span><span class="ident" id="4034804">Encrypt</span><span class="op" id="4034811">(</span><span class="ident" id="4034812">tagMask</span><span class="op" id="4034819">[</span><span class="op" id="4034820">:</span><span class="op" id="4034821">]</span><span class="op" id="4034822">,</span>&nbsp;<span class="ident" id="4034824">counter</span><span class="op" id="4034831">[</span><span class="op" id="4034832">:</span><span class="op" id="4034833">]</span><span class="op" id="4034834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4034837">gcmInc32</span><span class="op" id="4034845">(</span><span class="op" id="4034846">&amp;</span><span class="ident" id="4034847">counter</span><span class="op" id="4034854">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4034858">g</span><span class="op" id="4034859">.</span><span class="ident" id="4034860">counterCrypt</span><span class="op" id="4034872">(</span><span class="ident" id="4034873">out</span><span class="op" id="4034876">,</span>&nbsp;<span class="ident" id="4034878">plaintext</span><span class="op" id="4034887">,</span>&nbsp;<span class="op" id="4034889">&amp;</span><span class="ident" id="4034890">counter</span><span class="op" id="4034897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4034900">g</span><span class="op" id="4034901">.</span><span class="ident" id="4034902">auth</span><span class="op" id="4034906">(</span><span class="ident" id="4034907">out</span><span class="op" id="4034910">[</span><span class="builtinfunc" id="4034911">len</span><span class="op" id="4034914">(</span><span class="ident" id="4034915">plaintext</span><span class="op" id="4034924">)</span><span class="op" id="4034925">:</span><span class="op" id="4034926">]</span><span class="op" id="4034927">,</span>&nbsp;<span class="ident" id="4034929">out</span><span class="op" id="4034932">[</span><span class="op" id="4034933">:</span><span class="builtinfunc" id="4034934">len</span><span class="op" id="4034937">(</span><span class="ident" id="4034938">plaintext</span><span class="op" id="4034947">)</span><span class="op" id="4034948">]</span><span class="op" id="4034949">,</span>&nbsp;<span class="ident" id="4034951">data</span><span class="op" id="4034955">,</span>&nbsp;<span class="op" id="4034957">&amp;</span><span class="ident" id="4034958">tagMask</span><span class="op" id="4034965">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4034969">return</span>&nbsp;<span class="ident" id="4034976">ret</span><br>
<span class="lineno"></span><span class="op" id="4034980">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="keyword" id="4034983">var</span>&nbsp;<span class="ident" id="4034987">errOpen</span>&nbsp;<span class="op" id="4034995">=</span>&nbsp;<span class="ident" id="4034997">errors</span><span class="op" id="4035003">.</span><span class="ident" id="4035004">New</span><span class="op" id="4035007">(</span><span class="string" id="4035008">&#34;cipher:&nbsp;message&nbsp;authentication&nbsp;failed&#34;</span><span class="op" id="4035047">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4035050">func</span>&nbsp;<span class="op" id="4035055">(</span><span class="ident" id="4035056">g</span>&nbsp;<span class="op" id="4035058">*</span><span class="ident" id="4035059">gcm</span><span class="op" id="4035062">)</span>&nbsp;<span class="ident" id="4035064">Open</span><span class="op" id="4035068">(</span><span class="ident" id="4035069">dst</span><span class="op" id="4035072">,</span>&nbsp;<span class="ident" id="4035074">nonce</span><span class="op" id="4035079">,</span>&nbsp;<span class="ident" id="4035081">ciphertext</span><span class="op" id="4035091">,</span>&nbsp;<span class="ident" id="4035093">data</span>&nbsp;<span class="op" id="4035098">[</span><span class="op" id="4035099">]</span><span class="builtintype" id="4035100">byte</span><span class="op" id="4035104">)</span>&nbsp;<span class="op" id="4035106">(</span><span class="op" id="4035107">[</span><span class="op" id="4035108">]</span><span class="builtintype" id="4035109">byte</span><span class="op" id="4035113">,</span>&nbsp;<span class="builtintype" id="4035115">error</span><span class="op" id="4035120">)</span>&nbsp;<span class="op" id="4035122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4035125">if</span>&nbsp;<span class="builtinfunc" id="4035128">len</span><span class="op" id="4035131">(</span><span class="ident" id="4035132">nonce</span><span class="op" id="4035137">)</span>&nbsp;<span class="op" id="4035139">!=</span>&nbsp;<span class="ident" id="4035142">gcmNonceSize</span>&nbsp;<span class="op" id="4035155">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4035159">panic</span><span class="op" id="4035164">(</span><span class="string" id="4035165">&#34;cipher:&nbsp;incorrect&nbsp;nonce&nbsp;length&nbsp;given&nbsp;to&nbsp;GCM&#34;</span><span class="op" id="4035210">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4035213">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4035217">if</span>&nbsp;<span class="builtinfunc" id="4035220">len</span><span class="op" id="4035223">(</span><span class="ident" id="4035224">ciphertext</span><span class="op" id="4035234">)</span>&nbsp;<span class="op" id="4035236">&lt;</span>&nbsp;<span class="ident" id="4035238">gcmTagSize</span>&nbsp;<span class="op" id="4035249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4035253">return</span>&nbsp;<span class="builtintype" id="4035260">nil</span><span class="op" id="4035263">,</span>&nbsp;<span class="ident" id="4035265">errOpen</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4035274">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4035277">tag</span>&nbsp;<span class="op" id="4035281">:=</span>&nbsp;<span class="ident" id="4035284">ciphertext</span><span class="op" id="4035294">[</span><span class="builtinfunc" id="4035295">len</span><span class="op" id="4035298">(</span><span class="ident" id="4035299">ciphertext</span><span class="op" id="4035309">)</span><span class="op" id="4035310">-</span><span class="ident" id="4035311">gcmTagSize</span><span class="op" id="4035321">:</span><span class="op" id="4035322">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4035325">ciphertext</span>&nbsp;<span class="op" id="4035336">=</span>&nbsp;<span class="ident" id="4035338">ciphertext</span><span class="op" id="4035348">[</span><span class="op" id="4035349">:</span><span class="builtinfunc" id="4035350">len</span><span class="op" id="4035353">(</span><span class="ident" id="4035354">ciphertext</span><span class="op" id="4035364">)</span><span class="op" id="4035365">-</span><span class="ident" id="4035366">gcmTagSize</span><span class="op" id="4035376">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4035380">//&nbsp;See&nbsp;GCM&nbsp;spec,&nbsp;section&nbsp;7.1.</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4035411">var</span>&nbsp;<span class="ident" id="4035415">counter</span><span class="op" id="4035422">,</span>&nbsp;<span class="ident" id="4035424">tagMask</span>&nbsp;<span class="op" id="4035432">[</span><span class="ident" id="4035433">gcmBlockSize</span><span class="op" id="4035445">]</span><span class="builtintype" id="4035446">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4035452">copy</span><span class="op" id="4035456">(</span><span class="ident" id="4035457">counter</span><span class="op" id="4035464">[</span><span class="op" id="4035465">:</span><span class="op" id="4035466">]</span><span class="op" id="4035467">,</span>&nbsp;<span class="ident" id="4035469">nonce</span><span class="op" id="4035474">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4035477">counter</span><span class="op" id="4035484">[</span><span class="ident" id="4035485">gcmBlockSize</span><span class="op" id="4035497">-</span><span class="num" id="4035498">1</span><span class="op" id="4035499">]</span>&nbsp;<span class="op" id="4035501">=</span>&nbsp;<span class="num" id="4035503">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4035507">g</span><span class="op" id="4035508">.</span><span class="ident" id="4035509">cipher</span><span class="op" id="4035515">.</span><span class="ident" id="4035516">Encrypt</span><span class="op" id="4035523">(</span><span class="ident" id="4035524">tagMask</span><span class="op" id="4035531">[</span><span class="op" id="4035532">:</span><span class="op" id="4035533">]</span><span class="op" id="4035534">,</span>&nbsp;<span class="ident" id="4035536">counter</span><span class="op" id="4035543">[</span><span class="op" id="4035544">:</span><span class="op" id="4035545">]</span><span class="op" id="4035546">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4035549">gcmInc32</span><span class="op" id="4035557">(</span><span class="op" id="4035558">&amp;</span><span class="ident" id="4035559">counter</span><span class="op" id="4035566">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4035570">var</span>&nbsp;<span class="ident" id="4035574">expectedTag</span>&nbsp;<span class="op" id="4035586">[</span><span class="ident" id="4035587">gcmTagSize</span><span class="op" id="4035597">]</span><span class="builtintype" id="4035598">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4035604">g</span><span class="op" id="4035605">.</span><span class="ident" id="4035606">auth</span><span class="op" id="4035610">(</span><span class="ident" id="4035611">expectedTag</span><span class="op" id="4035622">[</span><span class="op" id="4035623">:</span><span class="op" id="4035624">]</span><span class="op" id="4035625">,</span>&nbsp;<span class="ident" id="4035627">ciphertext</span><span class="op" id="4035637">,</span>&nbsp;<span class="ident" id="4035639">data</span><span class="op" id="4035643">,</span>&nbsp;<span class="op" id="4035645">&amp;</span><span class="ident" id="4035646">tagMask</span><span class="op" id="4035653">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4035657">if</span>&nbsp;<span class="ident" id="4035660">subtle</span><span class="op" id="4035666">.</span><span class="ident" id="4035667">ConstantTimeCompare</span><span class="op" id="4035686">(</span><span class="ident" id="4035687">expectedTag</span><span class="op" id="4035698">[</span><span class="op" id="4035699">:</span><span class="op" id="4035700">]</span><span class="op" id="4035701">,</span>&nbsp;<span class="ident" id="4035703">tag</span><span class="op" id="4035706">)</span>&nbsp;<span class="op" id="4035708">!=</span>&nbsp;<span class="num" id="4035711">1</span>&nbsp;<span class="op" id="4035713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4035717">return</span>&nbsp;<span class="builtintype" id="4035724">nil</span><span class="op" id="4035727">,</span>&nbsp;<span class="ident" id="4035729">errOpen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4035738">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4035742">ret</span><span class="op" id="4035745">,</span>&nbsp;<span class="ident" id="4035747">out</span>&nbsp;<span class="op" id="4035751">:=</span>&nbsp;<span class="ident" id="4035754">sliceForAppend</span><span class="op" id="4035768">(</span><span class="ident" id="4035769">dst</span><span class="op" id="4035772">,</span>&nbsp;<span class="builtinfunc" id="4035774">len</span><span class="op" id="4035777">(</span><span class="ident" id="4035778">ciphertext</span><span class="op" id="4035788">)</span><span class="op" id="4035789">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4035792">g</span><span class="op" id="4035793">.</span><span class="ident" id="4035794">counterCrypt</span><span class="op" id="4035806">(</span><span class="ident" id="4035807">out</span><span class="op" id="4035810">,</span>&nbsp;<span class="ident" id="4035812">ciphertext</span><span class="op" id="4035822">,</span>&nbsp;<span class="op" id="4035824">&amp;</span><span class="ident" id="4035825">counter</span><span class="op" id="4035832">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4035836">return</span>&nbsp;<span class="ident" id="4035843">ret</span><span class="op" id="4035846">,</span>&nbsp;<span class="builtintype" id="4035848">nil</span><br>
<span class="lineno"></span><span class="op" id="4035852">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="comment" id="4035855">//&nbsp;reverseBits&nbsp;reverses&nbsp;the&nbsp;order&nbsp;of&nbsp;the&nbsp;bits&nbsp;of&nbsp;4-bit&nbsp;number&nbsp;in&nbsp;i.</span><br>
<span class="lineno"></span><span class="keyword" id="4035923">func</span>&nbsp;<span class="ident" id="4035928">reverseBits</span><span class="op" id="4035939">(</span><span class="ident" id="4035940">i</span>&nbsp;<span class="builtintype" id="4035942">int</span><span class="op" id="4035945">)</span>&nbsp;<span class="builtintype" id="4035947">int</span>&nbsp;<span class="op" id="4035951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4035954">i</span>&nbsp;<span class="op" id="4035956">=</span>&nbsp;<span class="op" id="4035958">(</span><span class="op" id="4035959">(</span><span class="ident" id="4035960">i</span>&nbsp;<span class="op" id="4035962">&lt;&lt;</span>&nbsp;<span class="num" id="4035965">2</span><span class="op" id="4035966">)</span>&nbsp;<span class="op" id="4035968">&amp;</span>&nbsp;<span class="num" id="4035970">0xc</span><span class="op" id="4035973">)</span>&nbsp;<span class="op" id="4035975">|</span>&nbsp;<span class="op" id="4035977">(</span><span class="op" id="4035978">(</span><span class="ident" id="4035979">i</span>&nbsp;<span class="op" id="4035981">&gt;&gt;</span>&nbsp;<span class="num" id="4035984">2</span><span class="op" id="4035985">)</span>&nbsp;<span class="op" id="4035987">&amp;</span>&nbsp;<span class="num" id="4035989">0x3</span><span class="op" id="4035992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4035995">i</span>&nbsp;<span class="op" id="4035997">=</span>&nbsp;<span class="op" id="4035999">(</span><span class="op" id="4036000">(</span><span class="ident" id="4036001">i</span>&nbsp;<span class="op" id="4036003">&lt;&lt;</span>&nbsp;<span class="num" id="4036006">1</span><span class="op" id="4036007">)</span>&nbsp;<span class="op" id="4036009">&amp;</span>&nbsp;<span class="num" id="4036011">0xa</span><span class="op" id="4036014">)</span>&nbsp;<span class="op" id="4036016">|</span>&nbsp;<span class="op" id="4036018">(</span><span class="op" id="4036019">(</span><span class="ident" id="4036020">i</span>&nbsp;<span class="op" id="4036022">&gt;&gt;</span>&nbsp;<span class="num" id="4036025">1</span><span class="op" id="4036026">)</span>&nbsp;<span class="op" id="4036028">&amp;</span>&nbsp;<span class="num" id="4036030">0x5</span><span class="op" id="4036033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4036036">return</span>&nbsp;<span class="ident" id="4036043">i</span><br>
<span class="lineno">165</span><span class="op" id="4036045">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4036048">//&nbsp;gcmAdd&nbsp;adds&nbsp;two&nbsp;elements&nbsp;of&nbsp;GF(2¹²⁸)&nbsp;and&nbsp;returns&nbsp;the&nbsp;sum.</span><br>
<span class="lineno"></span><span class="keyword" id="4036113">func</span>&nbsp;<span class="ident" id="4036118">gcmAdd</span><span class="op" id="4036124">(</span><span class="ident" id="4036125">x</span><span class="op" id="4036126">,</span>&nbsp;<span class="ident" id="4036128">y</span>&nbsp;<span class="op" id="4036130">*</span><span class="ident" id="4036131">gcmFieldElement</span><span class="op" id="4036146">)</span>&nbsp;<span class="ident" id="4036148">gcmFieldElement</span>&nbsp;<span class="op" id="4036164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4036167">//&nbsp;Addition&nbsp;in&nbsp;a&nbsp;characteristic&nbsp;2&nbsp;field&nbsp;is&nbsp;just&nbsp;XOR.</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4036221">return</span>&nbsp;<span class="ident" id="4036228">gcmFieldElement</span><span class="op" id="4036243">{</span><span class="ident" id="4036244">x</span><span class="op" id="4036245">.</span><span class="ident" id="4036246">low</span>&nbsp;<span class="op" id="4036250">^</span>&nbsp;<span class="ident" id="4036252">y</span><span class="op" id="4036253">.</span><span class="ident" id="4036254">low</span><span class="op" id="4036257">,</span>&nbsp;<span class="ident" id="4036259">x</span><span class="op" id="4036260">.</span><span class="ident" id="4036261">high</span>&nbsp;<span class="op" id="4036266">^</span>&nbsp;<span class="ident" id="4036268">y</span><span class="op" id="4036269">.</span><span class="ident" id="4036270">high</span><span class="op" id="4036274">}</span><br>
<span class="lineno"></span><span class="op" id="4036276">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4036279">//&nbsp;gcmDouble&nbsp;returns&nbsp;the&nbsp;result&nbsp;of&nbsp;doubling&nbsp;an&nbsp;element&nbsp;of&nbsp;GF(2¹²⁸).</span><br>
<span class="lineno"></span><span class="keyword" id="4036351">func</span>&nbsp;<span class="ident" id="4036356">gcmDouble</span><span class="op" id="4036365">(</span><span class="ident" id="4036366">x</span>&nbsp;<span class="op" id="4036368">*</span><span class="ident" id="4036369">gcmFieldElement</span><span class="op" id="4036384">)</span>&nbsp;<span class="op" id="4036386">(</span><span class="ident" id="4036387">double</span>&nbsp;<span class="ident" id="4036394">gcmFieldElement</span><span class="op" id="4036409">)</span>&nbsp;<span class="op" id="4036411">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4036414">msbSet</span>&nbsp;<span class="op" id="4036421">:=</span>&nbsp;<span class="ident" id="4036424">x</span><span class="op" id="4036425">.</span><span class="ident" id="4036426">high</span><span class="op" id="4036430">&amp;</span><span class="num" id="4036431">1</span>&nbsp;<span class="op" id="4036433">==</span>&nbsp;<span class="num" id="4036436">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4036440">//&nbsp;Because&nbsp;of&nbsp;the&nbsp;bit-ordering,&nbsp;doubling&nbsp;is&nbsp;actually&nbsp;a&nbsp;right&nbsp;shift.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4036509">double</span><span class="op" id="4036515">.</span><span class="ident" id="4036516">high</span>&nbsp;<span class="op" id="4036521">=</span>&nbsp;<span class="ident" id="4036523">x</span><span class="op" id="4036524">.</span><span class="ident" id="4036525">high</span>&nbsp;<span class="op" id="4036530">&gt;&gt;</span>&nbsp;<span class="num" id="4036533">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4036536">double</span><span class="op" id="4036542">.</span><span class="ident" id="4036543">high</span>&nbsp;<span class="op" id="4036548">|=</span>&nbsp;<span class="ident" id="4036551">x</span><span class="op" id="4036552">.</span><span class="ident" id="4036553">low</span>&nbsp;<span class="op" id="4036557">&lt;&lt;</span>&nbsp;<span class="num" id="4036560">63</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4036564">double</span><span class="op" id="4036570">.</span><span class="ident" id="4036571">low</span>&nbsp;<span class="op" id="4036575">=</span>&nbsp;<span class="ident" id="4036577">x</span><span class="op" id="4036578">.</span><span class="ident" id="4036579">low</span>&nbsp;<span class="op" id="4036583">&gt;&gt;</span>&nbsp;<span class="num" id="4036586">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4036590">//&nbsp;If&nbsp;the&nbsp;most-significant&nbsp;bit&nbsp;was&nbsp;set&nbsp;before&nbsp;shifting&nbsp;then&nbsp;it,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4036655">//&nbsp;conceptually,&nbsp;becomes&nbsp;a&nbsp;term&nbsp;of&nbsp;x^128.&nbsp;This&nbsp;is&nbsp;greater&nbsp;than&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4036723">//&nbsp;irreducible&nbsp;polynomial&nbsp;so&nbsp;the&nbsp;result&nbsp;has&nbsp;to&nbsp;be&nbsp;reduced.&nbsp;The</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4036787">//&nbsp;irreducible&nbsp;polynomial&nbsp;is&nbsp;1+x+x^2+x^7+x^128.&nbsp;We&nbsp;can&nbsp;subtract&nbsp;that&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4036860">//&nbsp;eliminate&nbsp;the&nbsp;term&nbsp;at&nbsp;x^128&nbsp;which&nbsp;also&nbsp;means&nbsp;subtracting&nbsp;the&nbsp;other</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4036931">//&nbsp;four&nbsp;terms.&nbsp;In&nbsp;characteristic&nbsp;2&nbsp;fields,&nbsp;subtraction&nbsp;==&nbsp;addition&nbsp;==</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4037002">//&nbsp;XOR.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4037011">if</span>&nbsp;<span class="ident" id="4037014">msbSet</span>&nbsp;<span class="op" id="4037021">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4037025">double</span><span class="op" id="4037031">.</span><span class="ident" id="4037032">low</span>&nbsp;<span class="op" id="4037036">^=</span>&nbsp;<span class="num" id="4037039">0xe100000000000000</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4037059">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4037063">return</span><br>
<span class="lineno"></span><span class="op" id="4037070">}</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span><span class="keyword" id="4037073">var</span>&nbsp;<span class="ident" id="4037077">gcmReductionTable</span>&nbsp;<span class="op" id="4037095">=</span>&nbsp;<span class="op" id="4037097">[</span><span class="op" id="4037098">]</span><span class="builtintype" id="4037099">uint16</span><span class="op" id="4037105">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="4037108">0x0000</span><span class="op" id="4037114">,</span>&nbsp;<span class="num" id="4037116">0x1c20</span><span class="op" id="4037122">,</span>&nbsp;<span class="num" id="4037124">0x3840</span><span class="op" id="4037130">,</span>&nbsp;<span class="num" id="4037132">0x2460</span><span class="op" id="4037138">,</span>&nbsp;<span class="num" id="4037140">0x7080</span><span class="op" id="4037146">,</span>&nbsp;<span class="num" id="4037148">0x6ca0</span><span class="op" id="4037154">,</span>&nbsp;<span class="num" id="4037156">0x48c0</span><span class="op" id="4037162">,</span>&nbsp;<span class="num" id="4037164">0x54e0</span><span class="op" id="4037170">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="num" id="4037173">0xe100</span><span class="op" id="4037179">,</span>&nbsp;<span class="num" id="4037181">0xfd20</span><span class="op" id="4037187">,</span>&nbsp;<span class="num" id="4037189">0xd940</span><span class="op" id="4037195">,</span>&nbsp;<span class="num" id="4037197">0xc560</span><span class="op" id="4037203">,</span>&nbsp;<span class="num" id="4037205">0x9180</span><span class="op" id="4037211">,</span>&nbsp;<span class="num" id="4037213">0x8da0</span><span class="op" id="4037219">,</span>&nbsp;<span class="num" id="4037221">0xa9c0</span><span class="op" id="4037227">,</span>&nbsp;<span class="num" id="4037229">0xb5e0</span><span class="op" id="4037235">,</span><br>
<span class="lineno"></span><span class="op" id="4037237">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="comment" id="4037240">//&nbsp;mul&nbsp;sets&nbsp;y&nbsp;to&nbsp;y*H,&nbsp;where&nbsp;H&nbsp;is&nbsp;the&nbsp;GCM&nbsp;key,&nbsp;fixed&nbsp;during&nbsp;NewGCM.</span><br>
<span class="lineno"></span><span class="keyword" id="4037307">func</span>&nbsp;<span class="op" id="4037312">(</span><span class="ident" id="4037313">g</span>&nbsp;<span class="op" id="4037315">*</span><span class="ident" id="4037316">gcm</span><span class="op" id="4037319">)</span>&nbsp;<span class="ident" id="4037321">mul</span><span class="op" id="4037324">(</span><span class="ident" id="4037325">y</span>&nbsp;<span class="op" id="4037327">*</span><span class="ident" id="4037328">gcmFieldElement</span><span class="op" id="4037343">)</span>&nbsp;<span class="op" id="4037345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4037348">var</span>&nbsp;<span class="ident" id="4037352">z</span>&nbsp;<span class="ident" id="4037354">gcmFieldElement</span><br>
<span class="lineno"></span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4037372">for</span>&nbsp;<span class="ident" id="4037376">i</span>&nbsp;<span class="op" id="4037378">:=</span>&nbsp;<span class="num" id="4037381">0</span><span class="op" id="4037382">;</span>&nbsp;<span class="ident" id="4037384">i</span>&nbsp;<span class="op" id="4037386">&lt;</span>&nbsp;<span class="num" id="4037388">2</span><span class="op" id="4037389">;</span>&nbsp;<span class="ident" id="4037391">i</span><span class="op" id="4037392">++</span>&nbsp;<span class="op" id="4037395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4037399">word</span>&nbsp;<span class="op" id="4037404">:=</span>&nbsp;<span class="ident" id="4037407">y</span><span class="op" id="4037408">.</span><span class="ident" id="4037409">high</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4037416">if</span>&nbsp;<span class="ident" id="4037419">i</span>&nbsp;<span class="op" id="4037421">==</span>&nbsp;<span class="num" id="4037424">1</span>&nbsp;<span class="op" id="4037426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4037431">word</span>&nbsp;<span class="op" id="4037436">=</span>&nbsp;<span class="ident" id="4037438">y</span><span class="op" id="4037439">.</span><span class="ident" id="4037440">low</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4037446">}</span><br>
<span class="lineno">210</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4037451">//&nbsp;Multiplication&nbsp;works&nbsp;by&nbsp;multiplying&nbsp;z&nbsp;by&nbsp;16&nbsp;and&nbsp;adding&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4037514">//&nbsp;one&nbsp;of&nbsp;the&nbsp;precomputed&nbsp;multiples&nbsp;of&nbsp;H.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4037558">for</span>&nbsp;<span class="ident" id="4037562">j</span>&nbsp;<span class="op" id="4037564">:=</span>&nbsp;<span class="num" id="4037567">0</span><span class="op" id="4037568">;</span>&nbsp;<span class="ident" id="4037570">j</span>&nbsp;<span class="op" id="4037572">&lt;</span>&nbsp;<span class="num" id="4037574">64</span><span class="op" id="4037576">;</span>&nbsp;<span class="ident" id="4037578">j</span>&nbsp;<span class="op" id="4037580">+=</span>&nbsp;<span class="num" id="4037583">4</span>&nbsp;<span class="op" id="4037585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4037590">msw</span>&nbsp;<span class="op" id="4037594">:=</span>&nbsp;<span class="ident" id="4037597">z</span><span class="op" id="4037598">.</span><span class="ident" id="4037599">high</span>&nbsp;<span class="op" id="4037604">&amp;</span>&nbsp;<span class="num" id="4037606">0xf</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4037613">z</span><span class="op" id="4037614">.</span><span class="ident" id="4037615">high</span>&nbsp;<span class="op" id="4037620">&gt;&gt;=</span>&nbsp;<span class="num" id="4037624">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4037629">z</span><span class="op" id="4037630">.</span><span class="ident" id="4037631">high</span>&nbsp;<span class="op" id="4037636">|=</span>&nbsp;<span class="ident" id="4037639">z</span><span class="op" id="4037640">.</span><span class="ident" id="4037641">low</span>&nbsp;<span class="op" id="4037645">&lt;&lt;</span>&nbsp;<span class="num" id="4037648">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4037654">z</span><span class="op" id="4037655">.</span><span class="ident" id="4037656">low</span>&nbsp;<span class="op" id="4037660">&gt;&gt;=</span>&nbsp;<span class="num" id="4037664">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4037669">z</span><span class="op" id="4037670">.</span><span class="ident" id="4037671">low</span>&nbsp;<span class="op" id="4037675">^=</span>&nbsp;<span class="builtintype" id="4037678">uint64</span><span class="op" id="4037684">(</span><span class="ident" id="4037685">gcmReductionTable</span><span class="op" id="4037702">[</span><span class="ident" id="4037703">msw</span><span class="op" id="4037706">]</span><span class="op" id="4037707">)</span>&nbsp;<span class="op" id="4037709">&lt;&lt;</span>&nbsp;<span class="num" id="4037712">48</span><br>
<span class="lineno"></span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4037719">//&nbsp;the&nbsp;values&nbsp;in&nbsp;|table|&nbsp;are&nbsp;ordered&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4037763">//&nbsp;little-endian&nbsp;bit&nbsp;positions.&nbsp;See&nbsp;the&nbsp;comment</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4037814">//&nbsp;in&nbsp;NewGCM.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4037831">t</span>&nbsp;<span class="op" id="4037833">:=</span>&nbsp;<span class="op" id="4037836">&amp;</span><span class="ident" id="4037837">g</span><span class="op" id="4037838">.</span><span class="ident" id="4037839">productTable</span><span class="op" id="4037851">[</span><span class="ident" id="4037852">word</span><span class="op" id="4037856">&amp;</span><span class="num" id="4037857">0xf</span><span class="op" id="4037860">]</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4037866">z</span><span class="op" id="4037867">.</span><span class="ident" id="4037868">low</span>&nbsp;<span class="op" id="4037872">^=</span>&nbsp;<span class="ident" id="4037875">t</span><span class="op" id="4037876">.</span><span class="ident" id="4037877">low</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4037884">z</span><span class="op" id="4037885">.</span><span class="ident" id="4037886">high</span>&nbsp;<span class="op" id="4037891">^=</span>&nbsp;<span class="ident" id="4037894">t</span><span class="op" id="4037895">.</span><span class="ident" id="4037896">high</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4037904">word</span>&nbsp;<span class="op" id="4037909">&gt;&gt;=</span>&nbsp;<span class="num" id="4037913">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4037917">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4037920">}</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4037924">*</span><span class="ident" id="4037925">y</span>&nbsp;<span class="op" id="4037927">=</span>&nbsp;<span class="ident" id="4037929">z</span><br>
<span class="lineno"></span><span class="op" id="4037931">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4037934">//&nbsp;updateBlocks&nbsp;extends&nbsp;y&nbsp;with&nbsp;more&nbsp;polynomial&nbsp;terms&nbsp;from&nbsp;blocks,&nbsp;based&nbsp;on</span><br>
<span class="lineno">235</span><span class="comment" id="4038009">//&nbsp;Horner&#39;s&nbsp;rule.&nbsp;There&nbsp;must&nbsp;be&nbsp;a&nbsp;multiple&nbsp;of&nbsp;gcmBlockSize&nbsp;bytes&nbsp;in&nbsp;blocks.</span><br>
<span class="lineno"></span><span class="keyword" id="4038085">func</span>&nbsp;<span class="op" id="4038090">(</span><span class="ident" id="4038091">g</span>&nbsp;<span class="op" id="4038093">*</span><span class="ident" id="4038094">gcm</span><span class="op" id="4038097">)</span>&nbsp;<span class="ident" id="4038099">updateBlocks</span><span class="op" id="4038111">(</span><span class="ident" id="4038112">y</span>&nbsp;<span class="op" id="4038114">*</span><span class="ident" id="4038115">gcmFieldElement</span><span class="op" id="4038130">,</span>&nbsp;<span class="ident" id="4038132">blocks</span>&nbsp;<span class="op" id="4038139">[</span><span class="op" id="4038140">]</span><span class="builtintype" id="4038141">byte</span><span class="op" id="4038145">)</span>&nbsp;<span class="op" id="4038147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4038150">for</span>&nbsp;<span class="builtinfunc" id="4038154">len</span><span class="op" id="4038157">(</span><span class="ident" id="4038158">blocks</span><span class="op" id="4038164">)</span>&nbsp;<span class="op" id="4038166">&gt;</span>&nbsp;<span class="num" id="4038168">0</span>&nbsp;<span class="op" id="4038170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4038174">y</span><span class="op" id="4038175">.</span><span class="ident" id="4038176">low</span>&nbsp;<span class="op" id="4038180">^=</span>&nbsp;<span class="ident" id="4038183">getUint64</span><span class="op" id="4038192">(</span><span class="ident" id="4038193">blocks</span><span class="op" id="4038199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4038203">y</span><span class="op" id="4038204">.</span><span class="ident" id="4038205">high</span>&nbsp;<span class="op" id="4038210">^=</span>&nbsp;<span class="ident" id="4038213">getUint64</span><span class="op" id="4038222">(</span><span class="ident" id="4038223">blocks</span><span class="op" id="4038229">[</span><span class="num" id="4038230">8</span><span class="op" id="4038231">:</span><span class="op" id="4038232">]</span><span class="op" id="4038233">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4038237">g</span><span class="op" id="4038238">.</span><span class="ident" id="4038239">mul</span><span class="op" id="4038242">(</span><span class="ident" id="4038243">y</span><span class="op" id="4038244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4038248">blocks</span>&nbsp;<span class="op" id="4038255">=</span>&nbsp;<span class="ident" id="4038257">blocks</span><span class="op" id="4038263">[</span><span class="ident" id="4038264">gcmBlockSize</span><span class="op" id="4038276">:</span><span class="op" id="4038277">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4038280">}</span><br>
<span class="lineno"></span><span class="op" id="4038282">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span><span class="comment" id="4038285">//&nbsp;update&nbsp;extends&nbsp;y&nbsp;with&nbsp;more&nbsp;polynomial&nbsp;terms&nbsp;from&nbsp;data.&nbsp;If&nbsp;data&nbsp;is&nbsp;not&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4038360">//&nbsp;multiple&nbsp;of&nbsp;gcmBlockSize&nbsp;bytes&nbsp;long&nbsp;then&nbsp;the&nbsp;remainder&nbsp;is&nbsp;zero&nbsp;padded.</span><br>
<span class="lineno"></span><span class="keyword" id="4038434">func</span>&nbsp;<span class="op" id="4038439">(</span><span class="ident" id="4038440">g</span>&nbsp;<span class="op" id="4038442">*</span><span class="ident" id="4038443">gcm</span><span class="op" id="4038446">)</span>&nbsp;<span class="ident" id="4038448">update</span><span class="op" id="4038454">(</span><span class="ident" id="4038455">y</span>&nbsp;<span class="op" id="4038457">*</span><span class="ident" id="4038458">gcmFieldElement</span><span class="op" id="4038473">,</span>&nbsp;<span class="ident" id="4038475">data</span>&nbsp;<span class="op" id="4038480">[</span><span class="op" id="4038481">]</span><span class="builtintype" id="4038482">byte</span><span class="op" id="4038486">)</span>&nbsp;<span class="op" id="4038488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4038491">fullBlocks</span>&nbsp;<span class="op" id="4038502">:=</span>&nbsp;<span class="op" id="4038505">(</span><span class="builtinfunc" id="4038506">len</span><span class="op" id="4038509">(</span><span class="ident" id="4038510">data</span><span class="op" id="4038514">)</span>&nbsp;<span class="op" id="4038516">&gt;&gt;</span>&nbsp;<span class="num" id="4038519">4</span><span class="op" id="4038520">)</span>&nbsp;<span class="op" id="4038522">&lt;&lt;</span>&nbsp;<span class="num" id="4038525">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4038528">g</span><span class="op" id="4038529">.</span><span class="ident" id="4038530">updateBlocks</span><span class="op" id="4038542">(</span><span class="ident" id="4038543">y</span><span class="op" id="4038544">,</span>&nbsp;<span class="ident" id="4038546">data</span><span class="op" id="4038550">[</span><span class="op" id="4038551">:</span><span class="ident" id="4038552">fullBlocks</span><span class="op" id="4038562">]</span><span class="op" id="4038563">)</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4038567">if</span>&nbsp;<span class="builtinfunc" id="4038570">len</span><span class="op" id="4038573">(</span><span class="ident" id="4038574">data</span><span class="op" id="4038578">)</span>&nbsp;<span class="op" id="4038580">!=</span>&nbsp;<span class="ident" id="4038583">fullBlocks</span>&nbsp;<span class="op" id="4038594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4038598">var</span>&nbsp;<span class="ident" id="4038602">partialBlock</span>&nbsp;<span class="op" id="4038615">[</span><span class="ident" id="4038616">gcmBlockSize</span><span class="op" id="4038628">]</span><span class="builtintype" id="4038629">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4038636">copy</span><span class="op" id="4038640">(</span><span class="ident" id="4038641">partialBlock</span><span class="op" id="4038653">[</span><span class="op" id="4038654">:</span><span class="op" id="4038655">]</span><span class="op" id="4038656">,</span>&nbsp;<span class="ident" id="4038658">data</span><span class="op" id="4038662">[</span><span class="ident" id="4038663">fullBlocks</span><span class="op" id="4038673">:</span><span class="op" id="4038674">]</span><span class="op" id="4038675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4038679">g</span><span class="op" id="4038680">.</span><span class="ident" id="4038681">updateBlocks</span><span class="op" id="4038693">(</span><span class="ident" id="4038694">y</span><span class="op" id="4038695">,</span>&nbsp;<span class="ident" id="4038697">partialBlock</span><span class="op" id="4038709">[</span><span class="op" id="4038710">:</span><span class="op" id="4038711">]</span><span class="op" id="4038712">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4038715">}</span><br>
<span class="lineno"></span><span class="op" id="4038717">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4038720">//&nbsp;gcmInc32&nbsp;treats&nbsp;the&nbsp;final&nbsp;four&nbsp;bytes&nbsp;of&nbsp;counterBlock&nbsp;as&nbsp;a&nbsp;big-endian&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="4038798">//&nbsp;and&nbsp;increments&nbsp;it.</span><br>
<span class="lineno">260</span><span class="keyword" id="4038820">func</span>&nbsp;<span class="ident" id="4038825">gcmInc32</span><span class="op" id="4038833">(</span><span class="ident" id="4038834">counterBlock</span>&nbsp;<span class="op" id="4038847">*</span><span class="op" id="4038848">[</span><span class="num" id="4038849">16</span><span class="op" id="4038851">]</span><span class="builtintype" id="4038852">byte</span><span class="op" id="4038856">)</span>&nbsp;<span class="op" id="4038858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4038861">for</span>&nbsp;<span class="ident" id="4038865">i</span>&nbsp;<span class="op" id="4038867">:=</span>&nbsp;<span class="ident" id="4038870">gcmBlockSize</span>&nbsp;<span class="op" id="4038883">-</span>&nbsp;<span class="num" id="4038885">1</span><span class="op" id="4038886">;</span>&nbsp;<span class="ident" id="4038888">i</span>&nbsp;<span class="op" id="4038890">&gt;=</span>&nbsp;<span class="ident" id="4038893">gcmBlockSize</span><span class="op" id="4038905">-</span><span class="num" id="4038906">4</span><span class="op" id="4038907">;</span>&nbsp;<span class="ident" id="4038909">i</span><span class="op" id="4038910">--</span>&nbsp;<span class="op" id="4038913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4038917">counterBlock</span><span class="op" id="4038929">[</span><span class="ident" id="4038930">i</span><span class="op" id="4038931">]</span><span class="op" id="4038932">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4038937">if</span>&nbsp;<span class="ident" id="4038940">counterBlock</span><span class="op" id="4038952">[</span><span class="ident" id="4038953">i</span><span class="op" id="4038954">]</span>&nbsp;<span class="op" id="4038956">!=</span>&nbsp;<span class="num" id="4038959">0</span>&nbsp;<span class="op" id="4038961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4038966">break</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4038974">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4038977">}</span><br>
<span class="lineno"></span><span class="op" id="4038979">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4038982">//&nbsp;sliceForAppend&nbsp;takes&nbsp;a&nbsp;slice&nbsp;and&nbsp;a&nbsp;requested&nbsp;number&nbsp;of&nbsp;bytes.&nbsp;It&nbsp;returns&nbsp;a</span><br>
<span class="lineno">270</span><span class="comment" id="4039060">//&nbsp;slice&nbsp;with&nbsp;the&nbsp;contents&nbsp;of&nbsp;the&nbsp;given&nbsp;slice&nbsp;followed&nbsp;by&nbsp;that&nbsp;many&nbsp;bytes&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4039140">//&nbsp;second&nbsp;slice&nbsp;that&nbsp;aliases&nbsp;into&nbsp;it&nbsp;and&nbsp;contains&nbsp;only&nbsp;the&nbsp;extra&nbsp;bytes.&nbsp;If&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4039219">//&nbsp;original&nbsp;slice&nbsp;has&nbsp;sufficient&nbsp;capacity&nbsp;then&nbsp;no&nbsp;allocation&nbsp;is&nbsp;performed.</span><br>
<span class="lineno"></span><span class="keyword" id="4039294">func</span>&nbsp;<span class="ident" id="4039299">sliceForAppend</span><span class="op" id="4039313">(</span><span class="ident" id="4039314">in</span>&nbsp;<span class="op" id="4039317">[</span><span class="op" id="4039318">]</span><span class="builtintype" id="4039319">byte</span><span class="op" id="4039323">,</span>&nbsp;<span class="ident" id="4039325">n</span>&nbsp;<span class="builtintype" id="4039327">int</span><span class="op" id="4039330">)</span>&nbsp;<span class="op" id="4039332">(</span><span class="ident" id="4039333">head</span><span class="op" id="4039337">,</span>&nbsp;<span class="ident" id="4039339">tail</span>&nbsp;<span class="op" id="4039344">[</span><span class="op" id="4039345">]</span><span class="builtintype" id="4039346">byte</span><span class="op" id="4039350">)</span>&nbsp;<span class="op" id="4039352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4039355">if</span>&nbsp;<span class="ident" id="4039358">total</span>&nbsp;<span class="op" id="4039364">:=</span>&nbsp;<span class="builtinfunc" id="4039367">len</span><span class="op" id="4039370">(</span><span class="ident" id="4039371">in</span><span class="op" id="4039373">)</span>&nbsp;<span class="op" id="4039375">+</span>&nbsp;<span class="ident" id="4039377">n</span><span class="op" id="4039378">;</span>&nbsp;<span class="builtinfunc" id="4039380">cap</span><span class="op" id="4039383">(</span><span class="ident" id="4039384">in</span><span class="op" id="4039386">)</span>&nbsp;<span class="op" id="4039388">&gt;=</span>&nbsp;<span class="ident" id="4039391">total</span>&nbsp;<span class="op" id="4039397">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4039401">head</span>&nbsp;<span class="op" id="4039406">=</span>&nbsp;<span class="ident" id="4039408">in</span><span class="op" id="4039410">[</span><span class="op" id="4039411">:</span><span class="ident" id="4039412">total</span><span class="op" id="4039417">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4039420">}</span>&nbsp;<span class="keyword" id="4039422">else</span>&nbsp;<span class="op" id="4039427">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4039431">head</span>&nbsp;<span class="op" id="4039436">=</span>&nbsp;<span class="builtinfunc" id="4039438">make</span><span class="op" id="4039442">(</span><span class="op" id="4039443">[</span><span class="op" id="4039444">]</span><span class="builtintype" id="4039445">byte</span><span class="op" id="4039449">,</span>&nbsp;<span class="ident" id="4039451">total</span><span class="op" id="4039456">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4039460">copy</span><span class="op" id="4039464">(</span><span class="ident" id="4039465">head</span><span class="op" id="4039469">,</span>&nbsp;<span class="ident" id="4039471">in</span><span class="op" id="4039473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4039476">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4039479">tail</span>&nbsp;<span class="op" id="4039484">=</span>&nbsp;<span class="ident" id="4039486">head</span><span class="op" id="4039490">[</span><span class="builtinfunc" id="4039491">len</span><span class="op" id="4039494">(</span><span class="ident" id="4039495">in</span><span class="op" id="4039497">)</span><span class="op" id="4039498">:</span><span class="op" id="4039499">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4039502">return</span><br>
<span class="lineno"></span><span class="op" id="4039509">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4039512">//&nbsp;counterCrypt&nbsp;crypts&nbsp;in&nbsp;to&nbsp;out&nbsp;using&nbsp;g.cipher&nbsp;in&nbsp;counter&nbsp;mode.</span><br>
<span class="lineno">285</span><span class="keyword" id="4039577">func</span>&nbsp;<span class="op" id="4039582">(</span><span class="ident" id="4039583">g</span>&nbsp;<span class="op" id="4039585">*</span><span class="ident" id="4039586">gcm</span><span class="op" id="4039589">)</span>&nbsp;<span class="ident" id="4039591">counterCrypt</span><span class="op" id="4039603">(</span><span class="ident" id="4039604">out</span><span class="op" id="4039607">,</span>&nbsp;<span class="ident" id="4039609">in</span>&nbsp;<span class="op" id="4039612">[</span><span class="op" id="4039613">]</span><span class="builtintype" id="4039614">byte</span><span class="op" id="4039618">,</span>&nbsp;<span class="ident" id="4039620">counter</span>&nbsp;<span class="op" id="4039628">*</span><span class="op" id="4039629">[</span><span class="ident" id="4039630">gcmBlockSize</span><span class="op" id="4039642">]</span><span class="builtintype" id="4039643">byte</span><span class="op" id="4039647">)</span>&nbsp;<span class="op" id="4039649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4039652">var</span>&nbsp;<span class="ident" id="4039656">mask</span>&nbsp;<span class="op" id="4039661">[</span><span class="ident" id="4039662">gcmBlockSize</span><span class="op" id="4039674">]</span><span class="builtintype" id="4039675">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4039682">for</span>&nbsp;<span class="builtinfunc" id="4039686">len</span><span class="op" id="4039689">(</span><span class="ident" id="4039690">in</span><span class="op" id="4039692">)</span>&nbsp;<span class="op" id="4039694">&gt;=</span>&nbsp;<span class="ident" id="4039697">gcmBlockSize</span>&nbsp;<span class="op" id="4039710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4039714">g</span><span class="op" id="4039715">.</span><span class="ident" id="4039716">cipher</span><span class="op" id="4039722">.</span><span class="ident" id="4039723">Encrypt</span><span class="op" id="4039730">(</span><span class="ident" id="4039731">mask</span><span class="op" id="4039735">[</span><span class="op" id="4039736">:</span><span class="op" id="4039737">]</span><span class="op" id="4039738">,</span>&nbsp;<span class="ident" id="4039740">counter</span><span class="op" id="4039747">[</span><span class="op" id="4039748">:</span><span class="op" id="4039749">]</span><span class="op" id="4039750">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4039754">gcmInc32</span><span class="op" id="4039762">(</span><span class="ident" id="4039763">counter</span><span class="op" id="4039770">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4039775">xorWords</span><span class="op" id="4039783">(</span><span class="ident" id="4039784">out</span><span class="op" id="4039787">,</span>&nbsp;<span class="ident" id="4039789">in</span><span class="op" id="4039791">,</span>&nbsp;<span class="ident" id="4039793">mask</span><span class="op" id="4039797">[</span><span class="op" id="4039798">:</span><span class="op" id="4039799">]</span><span class="op" id="4039800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4039804">out</span>&nbsp;<span class="op" id="4039808">=</span>&nbsp;<span class="ident" id="4039810">out</span><span class="op" id="4039813">[</span><span class="ident" id="4039814">gcmBlockSize</span><span class="op" id="4039826">:</span><span class="op" id="4039827">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4039831">in</span>&nbsp;<span class="op" id="4039834">=</span>&nbsp;<span class="ident" id="4039836">in</span><span class="op" id="4039838">[</span><span class="ident" id="4039839">gcmBlockSize</span><span class="op" id="4039851">:</span><span class="op" id="4039852">]</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4039855">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4039859">if</span>&nbsp;<span class="builtinfunc" id="4039862">len</span><span class="op" id="4039865">(</span><span class="ident" id="4039866">in</span><span class="op" id="4039868">)</span>&nbsp;<span class="op" id="4039870">&gt;</span>&nbsp;<span class="num" id="4039872">0</span>&nbsp;<span class="op" id="4039874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4039878">g</span><span class="op" id="4039879">.</span><span class="ident" id="4039880">cipher</span><span class="op" id="4039886">.</span><span class="ident" id="4039887">Encrypt</span><span class="op" id="4039894">(</span><span class="ident" id="4039895">mask</span><span class="op" id="4039899">[</span><span class="op" id="4039900">:</span><span class="op" id="4039901">]</span><span class="op" id="4039902">,</span>&nbsp;<span class="ident" id="4039904">counter</span><span class="op" id="4039911">[</span><span class="op" id="4039912">:</span><span class="op" id="4039913">]</span><span class="op" id="4039914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4039918">gcmInc32</span><span class="op" id="4039926">(</span><span class="ident" id="4039927">counter</span><span class="op" id="4039934">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4039938">xorBytes</span><span class="op" id="4039946">(</span><span class="ident" id="4039947">out</span><span class="op" id="4039950">,</span>&nbsp;<span class="ident" id="4039952">in</span><span class="op" id="4039954">,</span>&nbsp;<span class="ident" id="4039956">mask</span><span class="op" id="4039960">[</span><span class="op" id="4039961">:</span><span class="op" id="4039962">]</span><span class="op" id="4039963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4039966">}</span><br>
<span class="lineno"></span><span class="op" id="4039968">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4039971">//&nbsp;auth&nbsp;calculates&nbsp;GHASH(ciphertext,&nbsp;additionalData),&nbsp;masks&nbsp;the&nbsp;result&nbsp;with</span><br>
<span class="lineno">305</span><span class="comment" id="4040047">//&nbsp;tagMask&nbsp;and&nbsp;writes&nbsp;the&nbsp;result&nbsp;to&nbsp;out.</span><br>
<span class="lineno"></span><span class="keyword" id="4040088">func</span>&nbsp;<span class="op" id="4040093">(</span><span class="ident" id="4040094">g</span>&nbsp;<span class="op" id="4040096">*</span><span class="ident" id="4040097">gcm</span><span class="op" id="4040100">)</span>&nbsp;<span class="ident" id="4040102">auth</span><span class="op" id="4040106">(</span><span class="ident" id="4040107">out</span><span class="op" id="4040110">,</span>&nbsp;<span class="ident" id="4040112">ciphertext</span><span class="op" id="4040122">,</span>&nbsp;<span class="ident" id="4040124">additionalData</span>&nbsp;<span class="op" id="4040139">[</span><span class="op" id="4040140">]</span><span class="builtintype" id="4040141">byte</span><span class="op" id="4040145">,</span>&nbsp;<span class="ident" id="4040147">tagMask</span>&nbsp;<span class="op" id="4040155">*</span><span class="op" id="4040156">[</span><span class="ident" id="4040157">gcmTagSize</span><span class="op" id="4040167">]</span><span class="builtintype" id="4040168">byte</span><span class="op" id="4040172">)</span>&nbsp;<span class="op" id="4040174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4040177">var</span>&nbsp;<span class="ident" id="4040181">y</span>&nbsp;<span class="ident" id="4040183">gcmFieldElement</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4040200">g</span><span class="op" id="4040201">.</span><span class="ident" id="4040202">update</span><span class="op" id="4040208">(</span><span class="op" id="4040209">&amp;</span><span class="ident" id="4040210">y</span><span class="op" id="4040211">,</span>&nbsp;<span class="ident" id="4040213">additionalData</span><span class="op" id="4040227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4040230">g</span><span class="op" id="4040231">.</span><span class="ident" id="4040232">update</span><span class="op" id="4040238">(</span><span class="op" id="4040239">&amp;</span><span class="ident" id="4040240">y</span><span class="op" id="4040241">,</span>&nbsp;<span class="ident" id="4040243">ciphertext</span><span class="op" id="4040253">)</span><br>
<span class="lineno">310</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4040257">y</span><span class="op" id="4040258">.</span><span class="ident" id="4040259">low</span>&nbsp;<span class="op" id="4040263">^=</span>&nbsp;<span class="builtintype" id="4040266">uint64</span><span class="op" id="4040272">(</span><span class="builtinfunc" id="4040273">len</span><span class="op" id="4040276">(</span><span class="ident" id="4040277">additionalData</span><span class="op" id="4040291">)</span><span class="op" id="4040292">)</span>&nbsp;<span class="op" id="4040294">*</span>&nbsp;<span class="num" id="4040296">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4040299">y</span><span class="op" id="4040300">.</span><span class="ident" id="4040301">high</span>&nbsp;<span class="op" id="4040306">^=</span>&nbsp;<span class="builtintype" id="4040309">uint64</span><span class="op" id="4040315">(</span><span class="builtinfunc" id="4040316">len</span><span class="op" id="4040319">(</span><span class="ident" id="4040320">ciphertext</span><span class="op" id="4040330">)</span><span class="op" id="4040331">)</span>&nbsp;<span class="op" id="4040333">*</span>&nbsp;<span class="num" id="4040335">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4040339">g</span><span class="op" id="4040340">.</span><span class="ident" id="4040341">mul</span><span class="op" id="4040344">(</span><span class="op" id="4040345">&amp;</span><span class="ident" id="4040346">y</span><span class="op" id="4040347">)</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4040351">putUint64</span><span class="op" id="4040360">(</span><span class="ident" id="4040361">out</span><span class="op" id="4040364">,</span>&nbsp;<span class="ident" id="4040366">y</span><span class="op" id="4040367">.</span><span class="ident" id="4040368">low</span><span class="op" id="4040371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4040374">putUint64</span><span class="op" id="4040383">(</span><span class="ident" id="4040384">out</span><span class="op" id="4040387">[</span><span class="num" id="4040388">8</span><span class="op" id="4040389">:</span><span class="op" id="4040390">]</span><span class="op" id="4040391">,</span>&nbsp;<span class="ident" id="4040393">y</span><span class="op" id="4040394">.</span><span class="ident" id="4040395">high</span><span class="op" id="4040399">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4040403">xorWords</span><span class="op" id="4040411">(</span><span class="ident" id="4040412">out</span><span class="op" id="4040415">,</span>&nbsp;<span class="ident" id="4040417">out</span><span class="op" id="4040420">,</span>&nbsp;<span class="ident" id="4040422">tagMask</span><span class="op" id="4040429">[</span><span class="op" id="4040430">:</span><span class="op" id="4040431">]</span><span class="op" id="4040432">)</span><br>
<span class="lineno">320</span><span class="op" id="4040434">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4040437">func</span>&nbsp;<span class="ident" id="4040442">getUint64</span><span class="op" id="4040451">(</span><span class="ident" id="4040452">data</span>&nbsp;<span class="op" id="4040457">[</span><span class="op" id="4040458">]</span><span class="builtintype" id="4040459">byte</span><span class="op" id="4040463">)</span>&nbsp;<span class="builtintype" id="4040465">uint64</span>&nbsp;<span class="op" id="4040472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4040475">r</span>&nbsp;<span class="op" id="4040477">:=</span>&nbsp;<span class="builtintype" id="4040480">uint64</span><span class="op" id="4040486">(</span><span class="ident" id="4040487">data</span><span class="op" id="4040491">[</span><span class="num" id="4040492">0</span><span class="op" id="4040493">]</span><span class="op" id="4040494">)</span><span class="op" id="4040495">&lt;&lt;</span><span class="num" id="4040497">56</span>&nbsp;<span class="op" id="4040500">|</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4040504">uint64</span><span class="op" id="4040510">(</span><span class="ident" id="4040511">data</span><span class="op" id="4040515">[</span><span class="num" id="4040516">1</span><span class="op" id="4040517">]</span><span class="op" id="4040518">)</span><span class="op" id="4040519">&lt;&lt;</span><span class="num" id="4040521">48</span>&nbsp;<span class="op" id="4040524">|</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4040528">uint64</span><span class="op" id="4040534">(</span><span class="ident" id="4040535">data</span><span class="op" id="4040539">[</span><span class="num" id="4040540">2</span><span class="op" id="4040541">]</span><span class="op" id="4040542">)</span><span class="op" id="4040543">&lt;&lt;</span><span class="num" id="4040545">40</span>&nbsp;<span class="op" id="4040548">|</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4040552">uint64</span><span class="op" id="4040558">(</span><span class="ident" id="4040559">data</span><span class="op" id="4040563">[</span><span class="num" id="4040564">3</span><span class="op" id="4040565">]</span><span class="op" id="4040566">)</span><span class="op" id="4040567">&lt;&lt;</span><span class="num" id="4040569">32</span>&nbsp;<span class="op" id="4040572">|</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4040576">uint64</span><span class="op" id="4040582">(</span><span class="ident" id="4040583">data</span><span class="op" id="4040587">[</span><span class="num" id="4040588">4</span><span class="op" id="4040589">]</span><span class="op" id="4040590">)</span><span class="op" id="4040591">&lt;&lt;</span><span class="num" id="4040593">24</span>&nbsp;<span class="op" id="4040596">|</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4040600">uint64</span><span class="op" id="4040606">(</span><span class="ident" id="4040607">data</span><span class="op" id="4040611">[</span><span class="num" id="4040612">5</span><span class="op" id="4040613">]</span><span class="op" id="4040614">)</span><span class="op" id="4040615">&lt;&lt;</span><span class="num" id="4040617">16</span>&nbsp;<span class="op" id="4040620">|</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4040624">uint64</span><span class="op" id="4040630">(</span><span class="ident" id="4040631">data</span><span class="op" id="4040635">[</span><span class="num" id="4040636">6</span><span class="op" id="4040637">]</span><span class="op" id="4040638">)</span><span class="op" id="4040639">&lt;&lt;</span><span class="num" id="4040641">8</span>&nbsp;<span class="op" id="4040643">|</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4040647">uint64</span><span class="op" id="4040653">(</span><span class="ident" id="4040654">data</span><span class="op" id="4040658">[</span><span class="num" id="4040659">7</span><span class="op" id="4040660">]</span><span class="op" id="4040661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4040664">return</span>&nbsp;<span class="ident" id="4040671">r</span><br>
<span class="lineno"></span><span class="op" id="4040673">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4040676">func</span>&nbsp;<span class="ident" id="4040681">putUint64</span><span class="op" id="4040690">(</span><span class="ident" id="4040691">out</span>&nbsp;<span class="op" id="4040695">[</span><span class="op" id="4040696">]</span><span class="builtintype" id="4040697">byte</span><span class="op" id="4040701">,</span>&nbsp;<span class="ident" id="4040703">v</span>&nbsp;<span class="builtintype" id="4040705">uint64</span><span class="op" id="4040711">)</span>&nbsp;<span class="op" id="4040713">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4040716">out</span><span class="op" id="4040719">[</span><span class="num" id="4040720">0</span><span class="op" id="4040721">]</span>&nbsp;<span class="op" id="4040723">=</span>&nbsp;<span class="builtintype" id="4040725">byte</span><span class="op" id="4040729">(</span><span class="ident" id="4040730">v</span>&nbsp;<span class="op" id="4040732">&gt;&gt;</span>&nbsp;<span class="num" id="4040735">56</span><span class="op" id="4040737">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4040740">out</span><span class="op" id="4040743">[</span><span class="num" id="4040744">1</span><span class="op" id="4040745">]</span>&nbsp;<span class="op" id="4040747">=</span>&nbsp;<span class="builtintype" id="4040749">byte</span><span class="op" id="4040753">(</span><span class="ident" id="4040754">v</span>&nbsp;<span class="op" id="4040756">&gt;&gt;</span>&nbsp;<span class="num" id="4040759">48</span><span class="op" id="4040761">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4040764">out</span><span class="op" id="4040767">[</span><span class="num" id="4040768">2</span><span class="op" id="4040769">]</span>&nbsp;<span class="op" id="4040771">=</span>&nbsp;<span class="builtintype" id="4040773">byte</span><span class="op" id="4040777">(</span><span class="ident" id="4040778">v</span>&nbsp;<span class="op" id="4040780">&gt;&gt;</span>&nbsp;<span class="num" id="4040783">40</span><span class="op" id="4040785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4040788">out</span><span class="op" id="4040791">[</span><span class="num" id="4040792">3</span><span class="op" id="4040793">]</span>&nbsp;<span class="op" id="4040795">=</span>&nbsp;<span class="builtintype" id="4040797">byte</span><span class="op" id="4040801">(</span><span class="ident" id="4040802">v</span>&nbsp;<span class="op" id="4040804">&gt;&gt;</span>&nbsp;<span class="num" id="4040807">32</span><span class="op" id="4040809">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4040812">out</span><span class="op" id="4040815">[</span><span class="num" id="4040816">4</span><span class="op" id="4040817">]</span>&nbsp;<span class="op" id="4040819">=</span>&nbsp;<span class="builtintype" id="4040821">byte</span><span class="op" id="4040825">(</span><span class="ident" id="4040826">v</span>&nbsp;<span class="op" id="4040828">&gt;&gt;</span>&nbsp;<span class="num" id="4040831">24</span><span class="op" id="4040833">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4040836">out</span><span class="op" id="4040839">[</span><span class="num" id="4040840">5</span><span class="op" id="4040841">]</span>&nbsp;<span class="op" id="4040843">=</span>&nbsp;<span class="builtintype" id="4040845">byte</span><span class="op" id="4040849">(</span><span class="ident" id="4040850">v</span>&nbsp;<span class="op" id="4040852">&gt;&gt;</span>&nbsp;<span class="num" id="4040855">16</span><span class="op" id="4040857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4040860">out</span><span class="op" id="4040863">[</span><span class="num" id="4040864">6</span><span class="op" id="4040865">]</span>&nbsp;<span class="op" id="4040867">=</span>&nbsp;<span class="builtintype" id="4040869">byte</span><span class="op" id="4040873">(</span><span class="ident" id="4040874">v</span>&nbsp;<span class="op" id="4040876">&gt;&gt;</span>&nbsp;<span class="num" id="4040879">8</span><span class="op" id="4040880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4040883">out</span><span class="op" id="4040886">[</span><span class="num" id="4040887">7</span><span class="op" id="4040888">]</span>&nbsp;<span class="op" id="4040890">=</span>&nbsp;<span class="builtintype" id="4040892">byte</span><span class="op" id="4040896">(</span><span class="ident" id="4040897">v</span><span class="op" id="4040898">)</span><br>
<span class="lineno"></span><span class="op" id="4040900">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
