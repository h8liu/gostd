<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/httputil</h2>
<ul>
<li><a href="/gostd/net/http/httputil/dump.go.html">dump.go</a></li>
<li><a href="/gostd/net/http/httputil/dump_test.go.html">dump_test.go</a></li>
<li><a href="/gostd/net/http/httputil/httputil.go.html">httputil.go</a></li>
<li><a href="/gostd/net/http/httputil/persist.go.html">persist.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy.go.html">reverseproxy.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy_test.go.html">reverseproxy_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6130930">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6130985">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6131039">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6131090">package</span>&nbsp;<span class="ident" id="6131098">httputil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6131108">import</span>&nbsp;<span class="op" id="6131115">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6131118">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6131127">&#34;errors&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6131137">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6131143">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6131150">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6131162">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="6131179">&#34;sync&#34;</span><br>
<span class="lineno">15</span><span class="op" id="6131186">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6131189">var</span>&nbsp;<span class="op" id="6131193">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6131196">ErrPersistEOF</span>&nbsp;<span class="op" id="6131210">=</span>&nbsp;<span class="op" id="6131212">&amp;</span><span class="ident" id="6131213">http</span><span class="op" id="6131217">.</span><span class="ident" id="6131218">ProtocolError</span><span class="op" id="6131231">{</span><span class="ident" id="6131232">ErrorString</span><span class="op" id="6131243">:</span>&nbsp;<span class="string" id="6131245">&#34;persistent&nbsp;connection&nbsp;closed&#34;</span><span class="op" id="6131275">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6131278">ErrClosed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6131292">=</span>&nbsp;<span class="op" id="6131294">&amp;</span><span class="ident" id="6131295">http</span><span class="op" id="6131299">.</span><span class="ident" id="6131300">ProtocolError</span><span class="op" id="6131313">{</span><span class="ident" id="6131314">ErrorString</span><span class="op" id="6131325">:</span>&nbsp;<span class="string" id="6131327">&#34;connection&nbsp;closed&nbsp;by&nbsp;user&#34;</span><span class="op" id="6131354">}</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6131357">ErrPipeline</span>&nbsp;&nbsp;&nbsp;<span class="op" id="6131371">=</span>&nbsp;<span class="op" id="6131373">&amp;</span><span class="ident" id="6131374">http</span><span class="op" id="6131378">.</span><span class="ident" id="6131379">ProtocolError</span><span class="op" id="6131392">{</span><span class="ident" id="6131393">ErrorString</span><span class="op" id="6131404">:</span>&nbsp;<span class="string" id="6131406">&#34;pipeline&nbsp;error&#34;</span><span class="op" id="6131422">}</span><br>
<span class="lineno"></span><span class="op" id="6131424">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6131427">//&nbsp;This&nbsp;is&nbsp;an&nbsp;API&nbsp;usage&nbsp;error&nbsp;-&nbsp;the&nbsp;local&nbsp;side&nbsp;is&nbsp;closed.</span><br>
<span class="lineno"></span><span class="comment" id="6131485">//&nbsp;ErrPersistEOF&nbsp;(above)&nbsp;reports&nbsp;that&nbsp;the&nbsp;remote&nbsp;side&nbsp;is&nbsp;closed.</span><br>
<span class="lineno">25</span><span class="keyword" id="6131550">var</span>&nbsp;<span class="ident" id="6131554">errClosed</span>&nbsp;<span class="op" id="6131564">=</span>&nbsp;<span class="ident" id="6131566">errors</span><span class="op" id="6131572">.</span><span class="ident" id="6131573">New</span><span class="op" id="6131576">(</span><span class="string" id="6131577">&#34;i/o&nbsp;operation&nbsp;on&nbsp;closed&nbsp;connection&#34;</span><span class="op" id="6131613">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6131616">//&nbsp;A&nbsp;ServerConn&nbsp;reads&nbsp;requests&nbsp;and&nbsp;sends&nbsp;responses&nbsp;over&nbsp;an&nbsp;underlying</span><br>
<span class="lineno"></span><span class="comment" id="6131686">//&nbsp;connection,&nbsp;until&nbsp;the&nbsp;HTTP&nbsp;keepalive&nbsp;logic&nbsp;commands&nbsp;an&nbsp;end.&nbsp;ServerConn</span><br>
<span class="lineno"></span><span class="comment" id="6131760">//&nbsp;also&nbsp;allows&nbsp;hijacking&nbsp;the&nbsp;underlying&nbsp;connection&nbsp;by&nbsp;calling&nbsp;Hijack</span><br>
<span class="lineno">30</span><span class="comment" id="6131829">//&nbsp;to&nbsp;regain&nbsp;control&nbsp;over&nbsp;the&nbsp;connection.&nbsp;ServerConn&nbsp;supports&nbsp;pipe-lining,</span><br>
<span class="lineno"></span><span class="comment" id="6131904">//&nbsp;i.e.&nbsp;requests&nbsp;can&nbsp;be&nbsp;read&nbsp;out&nbsp;of&nbsp;sync&nbsp;(but&nbsp;in&nbsp;the&nbsp;same&nbsp;order)&nbsp;while&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6131979">//&nbsp;respective&nbsp;responses&nbsp;are&nbsp;sent.</span><br>
<span class="lineno"></span><span class="comment" id="6132013">//</span><br>
<span class="lineno"></span><span class="comment" id="6132016">//&nbsp;ServerConn&nbsp;is&nbsp;low-level&nbsp;and&nbsp;old.&nbsp;Applications&nbsp;should&nbsp;instead&nbsp;use&nbsp;Server</span><br>
<span class="lineno">35</span><span class="comment" id="6132091">//&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="6132119">type</span>&nbsp;<span class="ident" id="6132124">ServerConn</span>&nbsp;<span class="keyword" id="6132135">struct</span>&nbsp;<span class="op" id="6132142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6132145">lk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6132161">sync</span><span class="op" id="6132165">.</span><span class="ident" id="6132166">Mutex</span>&nbsp;<span class="comment" id="6132172">//&nbsp;read-write&nbsp;protects&nbsp;the&nbsp;following&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6132217">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6132233">net</span><span class="op" id="6132236">.</span><span class="ident" id="6132237">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6132243">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6132259">*</span><span class="ident" id="6132260">bufio</span><span class="op" id="6132265">.</span><span class="ident" id="6132266">Reader</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6132274">re</span><span class="op" id="6132276">,</span>&nbsp;<span class="ident" id="6132278">we</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6132290">error</span>&nbsp;<span class="comment" id="6132296">//&nbsp;read/write&nbsp;errors</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6132318">lastbody</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6132334">io</span><span class="op" id="6132336">.</span><span class="ident" id="6132337">ReadCloser</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6132349">nread</span><span class="op" id="6132354">,</span>&nbsp;<span class="ident" id="6132356">nwritten</span>&nbsp;<span class="builtintype" id="6132365">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6132370">pipereq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6132386">map</span><span class="op" id="6132389">[</span><span class="op" id="6132390">*</span><span class="ident" id="6132391">http</span><span class="op" id="6132395">.</span><span class="ident" id="6132396">Request</span><span class="op" id="6132403">]</span><span class="builtintype" id="6132404">uint</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6132411">pipe</span>&nbsp;<span class="ident" id="6132416">textproto</span><span class="op" id="6132425">.</span><span class="ident" id="6132426">Pipeline</span><br>
<span class="lineno"></span><span class="op" id="6132435">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6132438">//&nbsp;NewServerConn&nbsp;returns&nbsp;a&nbsp;new&nbsp;ServerConn&nbsp;reading&nbsp;and&nbsp;writing&nbsp;c.&nbsp;If&nbsp;r&nbsp;is&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="6132515">//&nbsp;nil,&nbsp;it&nbsp;is&nbsp;the&nbsp;buffer&nbsp;to&nbsp;use&nbsp;when&nbsp;reading&nbsp;c.</span><br>
<span class="lineno">50</span><span class="comment" id="6132563">//</span><br>
<span class="lineno"></span><span class="comment" id="6132566">//&nbsp;ServerConn&nbsp;is&nbsp;low-level&nbsp;and&nbsp;old.&nbsp;Applications&nbsp;should&nbsp;instead&nbsp;use&nbsp;Server</span><br>
<span class="lineno"></span><span class="comment" id="6132641">//&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="6132669">func</span>&nbsp;<span class="ident" id="6132674">NewServerConn</span><span class="op" id="6132687">(</span><span class="ident" id="6132688">c</span>&nbsp;<span class="ident" id="6132690">net</span><span class="op" id="6132693">.</span><span class="ident" id="6132694">Conn</span><span class="op" id="6132698">,</span>&nbsp;<span class="ident" id="6132700">r</span>&nbsp;<span class="op" id="6132702">*</span><span class="ident" id="6132703">bufio</span><span class="op" id="6132708">.</span><span class="ident" id="6132709">Reader</span><span class="op" id="6132715">)</span>&nbsp;<span class="op" id="6132717">*</span><span class="ident" id="6132718">ServerConn</span>&nbsp;<span class="op" id="6132729">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6132732">if</span>&nbsp;<span class="ident" id="6132735">r</span>&nbsp;<span class="op" id="6132737">==</span>&nbsp;<span class="ident" id="6132740">nil</span>&nbsp;<span class="op" id="6132744">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6132748">r</span>&nbsp;<span class="op" id="6132750">=</span>&nbsp;<span class="ident" id="6132752">bufio</span><span class="op" id="6132757">.</span><span class="ident" id="6132758">NewReader</span><span class="op" id="6132767">(</span><span class="ident" id="6132768">c</span><span class="op" id="6132769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6132772">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6132775">return</span>&nbsp;<span class="op" id="6132782">&amp;</span><span class="ident" id="6132783">ServerConn</span><span class="op" id="6132793">{</span><span class="ident" id="6132794">c</span><span class="op" id="6132795">:</span>&nbsp;<span class="ident" id="6132797">c</span><span class="op" id="6132798">,</span>&nbsp;<span class="ident" id="6132800">r</span><span class="op" id="6132801">:</span>&nbsp;<span class="ident" id="6132803">r</span><span class="op" id="6132804">,</span>&nbsp;<span class="ident" id="6132806">pipereq</span><span class="op" id="6132813">:</span>&nbsp;<span class="builtinfunc" id="6132815">make</span><span class="op" id="6132819">(</span><span class="keyword" id="6132820">map</span><span class="op" id="6132823">[</span><span class="op" id="6132824">*</span><span class="ident" id="6132825">http</span><span class="op" id="6132829">.</span><span class="ident" id="6132830">Request</span><span class="op" id="6132837">]</span><span class="builtintype" id="6132838">uint</span><span class="op" id="6132842">)</span><span class="op" id="6132843">}</span><br>
<span class="lineno"></span><span class="op" id="6132845">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="6132848">//&nbsp;Hijack&nbsp;detaches&nbsp;the&nbsp;ServerConn&nbsp;and&nbsp;returns&nbsp;the&nbsp;underlying&nbsp;connection&nbsp;as&nbsp;well</span><br>
<span class="lineno"></span><span class="comment" id="6132928">//&nbsp;as&nbsp;the&nbsp;read-side&nbsp;bufio&nbsp;which&nbsp;may&nbsp;have&nbsp;some&nbsp;left&nbsp;over&nbsp;data.&nbsp;Hijack&nbsp;may&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="6133004">//&nbsp;called&nbsp;before&nbsp;Read&nbsp;has&nbsp;signaled&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;keep-alive&nbsp;logic.&nbsp;The&nbsp;user</span><br>
<span class="lineno"></span><span class="comment" id="6133081">//&nbsp;should&nbsp;not&nbsp;call&nbsp;Hijack&nbsp;while&nbsp;Read&nbsp;or&nbsp;Write&nbsp;is&nbsp;in&nbsp;progress.</span><br>
<span class="lineno"></span><span class="keyword" id="6133143">func</span>&nbsp;<span class="op" id="6133148">(</span><span class="ident" id="6133149">sc</span>&nbsp;<span class="op" id="6133152">*</span><span class="ident" id="6133153">ServerConn</span><span class="op" id="6133163">)</span>&nbsp;<span class="ident" id="6133165">Hijack</span><span class="op" id="6133171">(</span><span class="op" id="6133172">)</span>&nbsp;<span class="op" id="6133174">(</span><span class="ident" id="6133175">c</span>&nbsp;<span class="ident" id="6133177">net</span><span class="op" id="6133180">.</span><span class="ident" id="6133181">Conn</span><span class="op" id="6133185">,</span>&nbsp;<span class="ident" id="6133187">r</span>&nbsp;<span class="op" id="6133189">*</span><span class="ident" id="6133190">bufio</span><span class="op" id="6133195">.</span><span class="ident" id="6133196">Reader</span><span class="op" id="6133202">)</span>&nbsp;<span class="op" id="6133204">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6133207">sc</span><span class="op" id="6133209">.</span><span class="ident" id="6133210">lk</span><span class="op" id="6133212">.</span><span class="ident" id="6133213">Lock</span><span class="op" id="6133217">(</span><span class="op" id="6133218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6133221">defer</span>&nbsp;<span class="ident" id="6133227">sc</span><span class="op" id="6133229">.</span><span class="ident" id="6133230">lk</span><span class="op" id="6133232">.</span><span class="ident" id="6133233">Unlock</span><span class="op" id="6133239">(</span><span class="op" id="6133240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6133243">c</span>&nbsp;<span class="op" id="6133245">=</span>&nbsp;<span class="ident" id="6133247">sc</span><span class="op" id="6133249">.</span><span class="ident" id="6133250">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6133253">r</span>&nbsp;<span class="op" id="6133255">=</span>&nbsp;<span class="ident" id="6133257">sc</span><span class="op" id="6133259">.</span><span class="ident" id="6133260">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6133263">sc</span><span class="op" id="6133265">.</span><span class="ident" id="6133266">c</span>&nbsp;<span class="op" id="6133268">=</span>&nbsp;<span class="ident" id="6133270">nil</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6133275">sc</span><span class="op" id="6133277">.</span><span class="ident" id="6133278">r</span>&nbsp;<span class="op" id="6133280">=</span>&nbsp;<span class="ident" id="6133282">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6133287">return</span><br>
<span class="lineno"></span><span class="op" id="6133294">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6133297">//&nbsp;Close&nbsp;calls&nbsp;Hijack&nbsp;and&nbsp;then&nbsp;also&nbsp;closes&nbsp;the&nbsp;underlying&nbsp;connection</span><br>
<span class="lineno">75</span><span class="keyword" id="6133366">func</span>&nbsp;<span class="op" id="6133371">(</span><span class="ident" id="6133372">sc</span>&nbsp;<span class="op" id="6133375">*</span><span class="ident" id="6133376">ServerConn</span><span class="op" id="6133386">)</span>&nbsp;<span class="ident" id="6133388">Close</span><span class="op" id="6133393">(</span><span class="op" id="6133394">)</span>&nbsp;<span class="builtintype" id="6133396">error</span>&nbsp;<span class="op" id="6133402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6133405">c</span><span class="op" id="6133406">,</span>&nbsp;<span class="ident" id="6133408">_</span>&nbsp;<span class="op" id="6133410">:=</span>&nbsp;<span class="ident" id="6133413">sc</span><span class="op" id="6133415">.</span><span class="ident" id="6133416">Hijack</span><span class="op" id="6133422">(</span><span class="op" id="6133423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6133426">if</span>&nbsp;<span class="ident" id="6133429">c</span>&nbsp;<span class="op" id="6133431">!=</span>&nbsp;<span class="ident" id="6133434">nil</span>&nbsp;<span class="op" id="6133438">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6133442">return</span>&nbsp;<span class="ident" id="6133449">c</span><span class="op" id="6133450">.</span><span class="ident" id="6133451">Close</span><span class="op" id="6133456">(</span><span class="op" id="6133457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6133460">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6133463">return</span>&nbsp;<span class="ident" id="6133470">nil</span><br>
<span class="lineno"></span><span class="op" id="6133474">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6133477">//&nbsp;Read&nbsp;returns&nbsp;the&nbsp;next&nbsp;request&nbsp;on&nbsp;the&nbsp;wire.&nbsp;An&nbsp;ErrPersistEOF&nbsp;is&nbsp;returned&nbsp;if</span><br>
<span class="lineno"></span><span class="comment" id="6133555">//&nbsp;it&nbsp;is&nbsp;gracefully&nbsp;determined&nbsp;that&nbsp;there&nbsp;are&nbsp;no&nbsp;more&nbsp;requests&nbsp;(e.g.&nbsp;after&nbsp;the</span><br>
<span class="lineno">85</span><span class="comment" id="6133634">//&nbsp;first&nbsp;request&nbsp;on&nbsp;an&nbsp;HTTP/1.0&nbsp;connection,&nbsp;or&nbsp;after&nbsp;a&nbsp;Connection:close&nbsp;on&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="6133711">//&nbsp;HTTP/1.1&nbsp;connection).</span><br>
<span class="lineno"></span><span class="keyword" id="6133736">func</span>&nbsp;<span class="op" id="6133741">(</span><span class="ident" id="6133742">sc</span>&nbsp;<span class="op" id="6133745">*</span><span class="ident" id="6133746">ServerConn</span><span class="op" id="6133756">)</span>&nbsp;<span class="ident" id="6133758">Read</span><span class="op" id="6133762">(</span><span class="op" id="6133763">)</span>&nbsp;<span class="op" id="6133765">(</span><span class="ident" id="6133766">req</span>&nbsp;<span class="op" id="6133770">*</span><span class="ident" id="6133771">http</span><span class="op" id="6133775">.</span><span class="ident" id="6133776">Request</span><span class="op" id="6133783">,</span>&nbsp;<span class="ident" id="6133785">err</span>&nbsp;<span class="builtintype" id="6133789">error</span><span class="op" id="6133794">)</span>&nbsp;<span class="op" id="6133796">{</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6133800">//&nbsp;Ensure&nbsp;ordered&nbsp;execution&nbsp;of&nbsp;Reads&nbsp;and&nbsp;Writes</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6133849">id</span>&nbsp;<span class="op" id="6133852">:=</span>&nbsp;<span class="ident" id="6133855">sc</span><span class="op" id="6133857">.</span><span class="ident" id="6133858">pipe</span><span class="op" id="6133862">.</span><span class="ident" id="6133863">Next</span><span class="op" id="6133867">(</span><span class="op" id="6133868">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6133871">sc</span><span class="op" id="6133873">.</span><span class="ident" id="6133874">pipe</span><span class="op" id="6133878">.</span><span class="ident" id="6133879">StartRequest</span><span class="op" id="6133891">(</span><span class="ident" id="6133892">id</span><span class="op" id="6133894">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6133897">defer</span>&nbsp;<span class="keyword" id="6133903">func</span><span class="op" id="6133907">(</span><span class="op" id="6133908">)</span>&nbsp;<span class="op" id="6133910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6133914">sc</span><span class="op" id="6133916">.</span><span class="ident" id="6133917">pipe</span><span class="op" id="6133921">.</span><span class="ident" id="6133922">EndRequest</span><span class="op" id="6133932">(</span><span class="ident" id="6133933">id</span><span class="op" id="6133935">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6133939">if</span>&nbsp;<span class="ident" id="6133942">req</span>&nbsp;<span class="op" id="6133946">==</span>&nbsp;<span class="ident" id="6133949">nil</span>&nbsp;<span class="op" id="6133953">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6133958">sc</span><span class="op" id="6133960">.</span><span class="ident" id="6133961">pipe</span><span class="op" id="6133965">.</span><span class="ident" id="6133966">StartResponse</span><span class="op" id="6133979">(</span><span class="ident" id="6133980">id</span><span class="op" id="6133982">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6133987">sc</span><span class="op" id="6133989">.</span><span class="ident" id="6133990">pipe</span><span class="op" id="6133994">.</span><span class="ident" id="6133995">EndResponse</span><span class="op" id="6134006">(</span><span class="ident" id="6134007">id</span><span class="op" id="6134009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6134013">}</span>&nbsp;<span class="keyword" id="6134015">else</span>&nbsp;<span class="op" id="6134020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6134025">//&nbsp;Remember&nbsp;the&nbsp;pipeline&nbsp;id&nbsp;of&nbsp;this&nbsp;request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6134072">sc</span><span class="op" id="6134074">.</span><span class="ident" id="6134075">lk</span><span class="op" id="6134077">.</span><span class="ident" id="6134078">Lock</span><span class="op" id="6134082">(</span><span class="op" id="6134083">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6134088">sc</span><span class="op" id="6134090">.</span><span class="ident" id="6134091">pipereq</span><span class="op" id="6134098">[</span><span class="ident" id="6134099">req</span><span class="op" id="6134102">]</span>&nbsp;<span class="op" id="6134104">=</span>&nbsp;<span class="ident" id="6134106">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6134112">sc</span><span class="op" id="6134114">.</span><span class="ident" id="6134115">lk</span><span class="op" id="6134117">.</span><span class="ident" id="6134118">Unlock</span><span class="op" id="6134124">(</span><span class="op" id="6134125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6134129">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6134132">}</span><span class="op" id="6134133">(</span><span class="op" id="6134134">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6134138">sc</span><span class="op" id="6134140">.</span><span class="ident" id="6134141">lk</span><span class="op" id="6134143">.</span><span class="ident" id="6134144">Lock</span><span class="op" id="6134148">(</span><span class="op" id="6134149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6134152">if</span>&nbsp;<span class="ident" id="6134155">sc</span><span class="op" id="6134157">.</span><span class="ident" id="6134158">we</span>&nbsp;<span class="op" id="6134161">!=</span>&nbsp;<span class="ident" id="6134164">nil</span>&nbsp;<span class="op" id="6134168">{</span>&nbsp;<span class="comment" id="6134170">//&nbsp;no&nbsp;point&nbsp;receiving&nbsp;if&nbsp;write-side&nbsp;broken&nbsp;or&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6134225">defer</span>&nbsp;<span class="ident" id="6134231">sc</span><span class="op" id="6134233">.</span><span class="ident" id="6134234">lk</span><span class="op" id="6134236">.</span><span class="ident" id="6134237">Unlock</span><span class="op" id="6134243">(</span><span class="op" id="6134244">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6134248">return</span>&nbsp;<span class="ident" id="6134255">nil</span><span class="op" id="6134258">,</span>&nbsp;<span class="ident" id="6134260">sc</span><span class="op" id="6134262">.</span><span class="ident" id="6134263">we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6134267">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6134270">if</span>&nbsp;<span class="ident" id="6134273">sc</span><span class="op" id="6134275">.</span><span class="ident" id="6134276">re</span>&nbsp;<span class="op" id="6134279">!=</span>&nbsp;<span class="ident" id="6134282">nil</span>&nbsp;<span class="op" id="6134286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6134290">defer</span>&nbsp;<span class="ident" id="6134296">sc</span><span class="op" id="6134298">.</span><span class="ident" id="6134299">lk</span><span class="op" id="6134301">.</span><span class="ident" id="6134302">Unlock</span><span class="op" id="6134308">(</span><span class="op" id="6134309">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6134313">return</span>&nbsp;<span class="ident" id="6134320">nil</span><span class="op" id="6134323">,</span>&nbsp;<span class="ident" id="6134325">sc</span><span class="op" id="6134327">.</span><span class="ident" id="6134328">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6134332">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6134335">if</span>&nbsp;<span class="ident" id="6134338">sc</span><span class="op" id="6134340">.</span><span class="ident" id="6134341">r</span>&nbsp;<span class="op" id="6134343">==</span>&nbsp;<span class="ident" id="6134346">nil</span>&nbsp;<span class="op" id="6134350">{</span>&nbsp;<span class="comment" id="6134352">//&nbsp;connection&nbsp;closed&nbsp;by&nbsp;user&nbsp;in&nbsp;the&nbsp;meantime</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6134399">defer</span>&nbsp;<span class="ident" id="6134405">sc</span><span class="op" id="6134407">.</span><span class="ident" id="6134408">lk</span><span class="op" id="6134410">.</span><span class="ident" id="6134411">Unlock</span><span class="op" id="6134417">(</span><span class="op" id="6134418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6134422">return</span>&nbsp;<span class="ident" id="6134429">nil</span><span class="op" id="6134432">,</span>&nbsp;<span class="ident" id="6134434">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6134445">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6134448">r</span>&nbsp;<span class="op" id="6134450">:=</span>&nbsp;<span class="ident" id="6134453">sc</span><span class="op" id="6134455">.</span><span class="ident" id="6134456">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6134459">lastbody</span>&nbsp;<span class="op" id="6134468">:=</span>&nbsp;<span class="ident" id="6134471">sc</span><span class="op" id="6134473">.</span><span class="ident" id="6134474">lastbody</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6134484">sc</span><span class="op" id="6134486">.</span><span class="ident" id="6134487">lastbody</span>&nbsp;<span class="op" id="6134496">=</span>&nbsp;<span class="ident" id="6134498">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6134503">sc</span><span class="op" id="6134505">.</span><span class="ident" id="6134506">lk</span><span class="op" id="6134508">.</span><span class="ident" id="6134509">Unlock</span><span class="op" id="6134515">(</span><span class="op" id="6134516">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6134520">//&nbsp;Make&nbsp;sure&nbsp;body&nbsp;is&nbsp;fully&nbsp;consumed,&nbsp;even&nbsp;if&nbsp;user&nbsp;does&nbsp;not&nbsp;call&nbsp;body.Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6134596">if</span>&nbsp;<span class="ident" id="6134599">lastbody</span>&nbsp;<span class="op" id="6134608">!=</span>&nbsp;<span class="ident" id="6134611">nil</span>&nbsp;<span class="op" id="6134615">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6134619">//&nbsp;body.Close&nbsp;is&nbsp;assumed&nbsp;to&nbsp;be&nbsp;idempotent&nbsp;and&nbsp;multiple&nbsp;calls&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6134685">//&nbsp;it&nbsp;should&nbsp;return&nbsp;the&nbsp;error&nbsp;that&nbsp;its&nbsp;first&nbsp;invocation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6134743">//&nbsp;returned.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6134758">err</span>&nbsp;<span class="op" id="6134762">=</span>&nbsp;<span class="ident" id="6134764">lastbody</span><span class="op" id="6134772">.</span><span class="ident" id="6134773">Close</span><span class="op" id="6134778">(</span><span class="op" id="6134779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6134783">if</span>&nbsp;<span class="ident" id="6134786">err</span>&nbsp;<span class="op" id="6134790">!=</span>&nbsp;<span class="ident" id="6134793">nil</span>&nbsp;<span class="op" id="6134797">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6134802">sc</span><span class="op" id="6134804">.</span><span class="ident" id="6134805">lk</span><span class="op" id="6134807">.</span><span class="ident" id="6134808">Lock</span><span class="op" id="6134812">(</span><span class="op" id="6134813">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6134818">defer</span>&nbsp;<span class="ident" id="6134824">sc</span><span class="op" id="6134826">.</span><span class="ident" id="6134827">lk</span><span class="op" id="6134829">.</span><span class="ident" id="6134830">Unlock</span><span class="op" id="6134836">(</span><span class="op" id="6134837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6134842">sc</span><span class="op" id="6134844">.</span><span class="ident" id="6134845">re</span>&nbsp;<span class="op" id="6134848">=</span>&nbsp;<span class="ident" id="6134850">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6134857">return</span>&nbsp;<span class="ident" id="6134864">nil</span><span class="op" id="6134867">,</span>&nbsp;<span class="ident" id="6134869">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6134875">}</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6134878">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6134882">req</span><span class="op" id="6134885">,</span>&nbsp;<span class="ident" id="6134887">err</span>&nbsp;<span class="op" id="6134891">=</span>&nbsp;<span class="ident" id="6134893">http</span><span class="op" id="6134897">.</span><span class="ident" id="6134898">ReadRequest</span><span class="op" id="6134909">(</span><span class="ident" id="6134910">r</span><span class="op" id="6134911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6134914">sc</span><span class="op" id="6134916">.</span><span class="ident" id="6134917">lk</span><span class="op" id="6134919">.</span><span class="ident" id="6134920">Lock</span><span class="op" id="6134924">(</span><span class="op" id="6134925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6134928">defer</span>&nbsp;<span class="ident" id="6134934">sc</span><span class="op" id="6134936">.</span><span class="ident" id="6134937">lk</span><span class="op" id="6134939">.</span><span class="ident" id="6134940">Unlock</span><span class="op" id="6134946">(</span><span class="op" id="6134947">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6134950">if</span>&nbsp;<span class="ident" id="6134953">err</span>&nbsp;<span class="op" id="6134957">!=</span>&nbsp;<span class="ident" id="6134960">nil</span>&nbsp;<span class="op" id="6134964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6134968">if</span>&nbsp;<span class="ident" id="6134971">err</span>&nbsp;<span class="op" id="6134975">==</span>&nbsp;<span class="ident" id="6134978">io</span><span class="op" id="6134980">.</span><span class="ident" id="6134981">ErrUnexpectedEOF</span>&nbsp;<span class="op" id="6134998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6135003">//&nbsp;A&nbsp;close&nbsp;from&nbsp;the&nbsp;opposing&nbsp;client&nbsp;is&nbsp;treated&nbsp;as&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6135058">//&nbsp;graceful&nbsp;close,&nbsp;even&nbsp;if&nbsp;there&nbsp;was&nbsp;some&nbsp;unparse-able</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6135116">//&nbsp;data&nbsp;before&nbsp;the&nbsp;close.</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6135145">sc</span><span class="op" id="6135147">.</span><span class="ident" id="6135148">re</span>&nbsp;<span class="op" id="6135151">=</span>&nbsp;<span class="ident" id="6135153">ErrPersistEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6135170">return</span>&nbsp;<span class="ident" id="6135177">nil</span><span class="op" id="6135180">,</span>&nbsp;<span class="ident" id="6135182">sc</span><span class="op" id="6135184">.</span><span class="ident" id="6135185">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6135190">}</span>&nbsp;<span class="keyword" id="6135192">else</span>&nbsp;<span class="op" id="6135197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6135202">sc</span><span class="op" id="6135204">.</span><span class="ident" id="6135205">re</span>&nbsp;<span class="op" id="6135208">=</span>&nbsp;<span class="ident" id="6135210">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6135217">return</span>&nbsp;<span class="ident" id="6135224">req</span><span class="op" id="6135227">,</span>&nbsp;<span class="ident" id="6135229">err</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6135235">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6135238">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6135241">sc</span><span class="op" id="6135243">.</span><span class="ident" id="6135244">lastbody</span>&nbsp;<span class="op" id="6135253">=</span>&nbsp;<span class="ident" id="6135255">req</span><span class="op" id="6135258">.</span><span class="ident" id="6135259">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6135265">sc</span><span class="op" id="6135267">.</span><span class="ident" id="6135268">nread</span><span class="op" id="6135273">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6135277">if</span>&nbsp;<span class="ident" id="6135280">req</span><span class="op" id="6135283">.</span><span class="ident" id="6135284">Close</span>&nbsp;<span class="op" id="6135290">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6135294">sc</span><span class="op" id="6135296">.</span><span class="ident" id="6135297">re</span>&nbsp;<span class="op" id="6135300">=</span>&nbsp;<span class="ident" id="6135302">ErrPersistEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6135318">return</span>&nbsp;<span class="ident" id="6135325">req</span><span class="op" id="6135328">,</span>&nbsp;<span class="ident" id="6135330">sc</span><span class="op" id="6135332">.</span><span class="ident" id="6135333">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6135337">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6135340">return</span>&nbsp;<span class="ident" id="6135347">req</span><span class="op" id="6135350">,</span>&nbsp;<span class="ident" id="6135352">err</span><br>
<span class="lineno"></span><span class="op" id="6135356">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span><span class="comment" id="6135359">//&nbsp;Pending&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;unanswered&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="6135412">//&nbsp;that&nbsp;have&nbsp;been&nbsp;received&nbsp;on&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="6135458">func</span>&nbsp;<span class="op" id="6135463">(</span><span class="ident" id="6135464">sc</span>&nbsp;<span class="op" id="6135467">*</span><span class="ident" id="6135468">ServerConn</span><span class="op" id="6135478">)</span>&nbsp;<span class="ident" id="6135480">Pending</span><span class="op" id="6135487">(</span><span class="op" id="6135488">)</span>&nbsp;<span class="builtintype" id="6135490">int</span>&nbsp;<span class="op" id="6135494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6135497">sc</span><span class="op" id="6135499">.</span><span class="ident" id="6135500">lk</span><span class="op" id="6135502">.</span><span class="ident" id="6135503">Lock</span><span class="op" id="6135507">(</span><span class="op" id="6135508">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6135511">defer</span>&nbsp;<span class="ident" id="6135517">sc</span><span class="op" id="6135519">.</span><span class="ident" id="6135520">lk</span><span class="op" id="6135522">.</span><span class="ident" id="6135523">Unlock</span><span class="op" id="6135529">(</span><span class="op" id="6135530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6135533">return</span>&nbsp;<span class="ident" id="6135540">sc</span><span class="op" id="6135542">.</span><span class="ident" id="6135543">nread</span>&nbsp;<span class="op" id="6135549">-</span>&nbsp;<span class="ident" id="6135551">sc</span><span class="op" id="6135553">.</span><span class="ident" id="6135554">nwritten</span><br>
<span class="lineno"></span><span class="op" id="6135563">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6135566">//&nbsp;Write&nbsp;writes&nbsp;resp&nbsp;in&nbsp;response&nbsp;to&nbsp;req.&nbsp;To&nbsp;close&nbsp;the&nbsp;connection&nbsp;gracefully,&nbsp;set&nbsp;the</span><br>
<span class="lineno">170</span><span class="comment" id="6135651">//&nbsp;Response.Close&nbsp;field&nbsp;to&nbsp;true.&nbsp;Write&nbsp;should&nbsp;be&nbsp;considered&nbsp;operational&nbsp;until</span><br>
<span class="lineno"></span><span class="comment" id="6135729">//&nbsp;it&nbsp;returns&nbsp;an&nbsp;error,&nbsp;regardless&nbsp;of&nbsp;any&nbsp;errors&nbsp;returned&nbsp;on&nbsp;the&nbsp;Read&nbsp;side.</span><br>
<span class="lineno"></span><span class="keyword" id="6135805">func</span>&nbsp;<span class="op" id="6135810">(</span><span class="ident" id="6135811">sc</span>&nbsp;<span class="op" id="6135814">*</span><span class="ident" id="6135815">ServerConn</span><span class="op" id="6135825">)</span>&nbsp;<span class="ident" id="6135827">Write</span><span class="op" id="6135832">(</span><span class="ident" id="6135833">req</span>&nbsp;<span class="op" id="6135837">*</span><span class="ident" id="6135838">http</span><span class="op" id="6135842">.</span><span class="ident" id="6135843">Request</span><span class="op" id="6135850">,</span>&nbsp;<span class="ident" id="6135852">resp</span>&nbsp;<span class="op" id="6135857">*</span><span class="ident" id="6135858">http</span><span class="op" id="6135862">.</span><span class="ident" id="6135863">Response</span><span class="op" id="6135871">)</span>&nbsp;<span class="builtintype" id="6135873">error</span>&nbsp;<span class="op" id="6135879">{</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6135883">//&nbsp;Retrieve&nbsp;the&nbsp;pipeline&nbsp;ID&nbsp;of&nbsp;this&nbsp;request/response&nbsp;pair</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6135942">sc</span><span class="op" id="6135944">.</span><span class="ident" id="6135945">lk</span><span class="op" id="6135947">.</span><span class="ident" id="6135948">Lock</span><span class="op" id="6135952">(</span><span class="op" id="6135953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6135956">id</span><span class="op" id="6135958">,</span>&nbsp;<span class="ident" id="6135960">ok</span>&nbsp;<span class="op" id="6135963">:=</span>&nbsp;<span class="ident" id="6135966">sc</span><span class="op" id="6135968">.</span><span class="ident" id="6135969">pipereq</span><span class="op" id="6135976">[</span><span class="ident" id="6135977">req</span><span class="op" id="6135980">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6135983">delete</span><span class="op" id="6135989">(</span><span class="ident" id="6135990">sc</span><span class="op" id="6135992">.</span><span class="ident" id="6135993">pipereq</span><span class="op" id="6136000">,</span>&nbsp;<span class="ident" id="6136002">req</span><span class="op" id="6136005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6136008">if</span>&nbsp;<span class="op" id="6136011">!</span><span class="ident" id="6136012">ok</span>&nbsp;<span class="op" id="6136015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6136019">sc</span><span class="op" id="6136021">.</span><span class="ident" id="6136022">lk</span><span class="op" id="6136024">.</span><span class="ident" id="6136025">Unlock</span><span class="op" id="6136031">(</span><span class="op" id="6136032">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6136036">return</span>&nbsp;<span class="ident" id="6136043">ErrPipeline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6136056">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6136059">sc</span><span class="op" id="6136061">.</span><span class="ident" id="6136062">lk</span><span class="op" id="6136064">.</span><span class="ident" id="6136065">Unlock</span><span class="op" id="6136071">(</span><span class="op" id="6136072">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6136076">//&nbsp;Ensure&nbsp;pipeline&nbsp;order</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6136102">sc</span><span class="op" id="6136104">.</span><span class="ident" id="6136105">pipe</span><span class="op" id="6136109">.</span><span class="ident" id="6136110">StartResponse</span><span class="op" id="6136123">(</span><span class="ident" id="6136124">id</span><span class="op" id="6136126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6136129">defer</span>&nbsp;<span class="ident" id="6136135">sc</span><span class="op" id="6136137">.</span><span class="ident" id="6136138">pipe</span><span class="op" id="6136142">.</span><span class="ident" id="6136143">EndResponse</span><span class="op" id="6136154">(</span><span class="ident" id="6136155">id</span><span class="op" id="6136157">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6136161">sc</span><span class="op" id="6136163">.</span><span class="ident" id="6136164">lk</span><span class="op" id="6136166">.</span><span class="ident" id="6136167">Lock</span><span class="op" id="6136171">(</span><span class="op" id="6136172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6136175">if</span>&nbsp;<span class="ident" id="6136178">sc</span><span class="op" id="6136180">.</span><span class="ident" id="6136181">we</span>&nbsp;<span class="op" id="6136184">!=</span>&nbsp;<span class="ident" id="6136187">nil</span>&nbsp;<span class="op" id="6136191">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6136195">defer</span>&nbsp;<span class="ident" id="6136201">sc</span><span class="op" id="6136203">.</span><span class="ident" id="6136204">lk</span><span class="op" id="6136206">.</span><span class="ident" id="6136207">Unlock</span><span class="op" id="6136213">(</span><span class="op" id="6136214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6136218">return</span>&nbsp;<span class="ident" id="6136225">sc</span><span class="op" id="6136227">.</span><span class="ident" id="6136228">we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6136232">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6136235">if</span>&nbsp;<span class="ident" id="6136238">sc</span><span class="op" id="6136240">.</span><span class="ident" id="6136241">c</span>&nbsp;<span class="op" id="6136243">==</span>&nbsp;<span class="ident" id="6136246">nil</span>&nbsp;<span class="op" id="6136250">{</span>&nbsp;<span class="comment" id="6136252">//&nbsp;connection&nbsp;closed&nbsp;by&nbsp;user&nbsp;in&nbsp;the&nbsp;meantime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6136299">defer</span>&nbsp;<span class="ident" id="6136305">sc</span><span class="op" id="6136307">.</span><span class="ident" id="6136308">lk</span><span class="op" id="6136310">.</span><span class="ident" id="6136311">Unlock</span><span class="op" id="6136317">(</span><span class="op" id="6136318">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6136322">return</span>&nbsp;<span class="ident" id="6136329">ErrClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6136340">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6136343">c</span>&nbsp;<span class="op" id="6136345">:=</span>&nbsp;<span class="ident" id="6136348">sc</span><span class="op" id="6136350">.</span><span class="ident" id="6136351">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6136354">if</span>&nbsp;<span class="ident" id="6136357">sc</span><span class="op" id="6136359">.</span><span class="ident" id="6136360">nread</span>&nbsp;<span class="op" id="6136366">&lt;=</span>&nbsp;<span class="ident" id="6136369">sc</span><span class="op" id="6136371">.</span><span class="ident" id="6136372">nwritten</span>&nbsp;<span class="op" id="6136381">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6136385">defer</span>&nbsp;<span class="ident" id="6136391">sc</span><span class="op" id="6136393">.</span><span class="ident" id="6136394">lk</span><span class="op" id="6136396">.</span><span class="ident" id="6136397">Unlock</span><span class="op" id="6136403">(</span><span class="op" id="6136404">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6136408">return</span>&nbsp;<span class="ident" id="6136415">errors</span><span class="op" id="6136421">.</span><span class="ident" id="6136422">New</span><span class="op" id="6136425">(</span><span class="string" id="6136426">&#34;persist&nbsp;server&nbsp;pipe&nbsp;count&#34;</span><span class="op" id="6136453">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6136456">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6136459">if</span>&nbsp;<span class="ident" id="6136462">resp</span><span class="op" id="6136466">.</span><span class="ident" id="6136467">Close</span>&nbsp;<span class="op" id="6136473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6136477">//&nbsp;After&nbsp;signaling&nbsp;a&nbsp;keep-alive&nbsp;close,&nbsp;any&nbsp;pipelined&nbsp;unread</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6136539">//&nbsp;requests&nbsp;will&nbsp;be&nbsp;lost.&nbsp;It&nbsp;is&nbsp;up&nbsp;to&nbsp;the&nbsp;user&nbsp;to&nbsp;drain&nbsp;them</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6136602">//&nbsp;before&nbsp;signaling.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6136625">sc</span><span class="op" id="6136627">.</span><span class="ident" id="6136628">re</span>&nbsp;<span class="op" id="6136631">=</span>&nbsp;<span class="ident" id="6136633">ErrPersistEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6136648">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6136651">sc</span><span class="op" id="6136653">.</span><span class="ident" id="6136654">lk</span><span class="op" id="6136656">.</span><span class="ident" id="6136657">Unlock</span><span class="op" id="6136663">(</span><span class="op" id="6136664">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6136668">err</span>&nbsp;<span class="op" id="6136672">:=</span>&nbsp;<span class="ident" id="6136675">resp</span><span class="op" id="6136679">.</span><span class="ident" id="6136680">Write</span><span class="op" id="6136685">(</span><span class="ident" id="6136686">c</span><span class="op" id="6136687">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6136690">sc</span><span class="op" id="6136692">.</span><span class="ident" id="6136693">lk</span><span class="op" id="6136695">.</span><span class="ident" id="6136696">Lock</span><span class="op" id="6136700">(</span><span class="op" id="6136701">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6136704">defer</span>&nbsp;<span class="ident" id="6136710">sc</span><span class="op" id="6136712">.</span><span class="ident" id="6136713">lk</span><span class="op" id="6136715">.</span><span class="ident" id="6136716">Unlock</span><span class="op" id="6136722">(</span><span class="op" id="6136723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6136726">if</span>&nbsp;<span class="ident" id="6136729">err</span>&nbsp;<span class="op" id="6136733">!=</span>&nbsp;<span class="ident" id="6136736">nil</span>&nbsp;<span class="op" id="6136740">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6136744">sc</span><span class="op" id="6136746">.</span><span class="ident" id="6136747">we</span>&nbsp;<span class="op" id="6136750">=</span>&nbsp;<span class="ident" id="6136752">err</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6136758">return</span>&nbsp;<span class="ident" id="6136765">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6136770">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6136773">sc</span><span class="op" id="6136775">.</span><span class="ident" id="6136776">nwritten</span><span class="op" id="6136784">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6136789">return</span>&nbsp;<span class="ident" id="6136796">nil</span><br>
<span class="lineno">220</span><span class="op" id="6136800">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6136803">//&nbsp;A&nbsp;ClientConn&nbsp;sends&nbsp;request&nbsp;and&nbsp;receives&nbsp;headers&nbsp;over&nbsp;an&nbsp;underlying</span><br>
<span class="lineno"></span><span class="comment" id="6136873">//&nbsp;connection,&nbsp;while&nbsp;respecting&nbsp;the&nbsp;HTTP&nbsp;keepalive&nbsp;logic.&nbsp;ClientConn</span><br>
<span class="lineno"></span><span class="comment" id="6136942">//&nbsp;supports&nbsp;hijacking&nbsp;the&nbsp;connection&nbsp;calling&nbsp;Hijack&nbsp;to</span><br>
<span class="lineno">225</span><span class="comment" id="6136997">//&nbsp;regain&nbsp;control&nbsp;of&nbsp;the&nbsp;underlying&nbsp;net.Conn&nbsp;and&nbsp;deal&nbsp;with&nbsp;it&nbsp;as&nbsp;desired.</span><br>
<span class="lineno"></span><span class="comment" id="6137071">//</span><br>
<span class="lineno"></span><span class="comment" id="6137074">//&nbsp;ClientConn&nbsp;is&nbsp;low-level&nbsp;and&nbsp;old.&nbsp;Applications&nbsp;should&nbsp;instead&nbsp;use</span><br>
<span class="lineno"></span><span class="comment" id="6137142">//&nbsp;Client&nbsp;or&nbsp;Transport&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="6137190">type</span>&nbsp;<span class="ident" id="6137195">ClientConn</span>&nbsp;<span class="keyword" id="6137206">struct</span>&nbsp;<span class="op" id="6137213">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6137216">lk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6137232">sync</span><span class="op" id="6137236">.</span><span class="ident" id="6137237">Mutex</span>&nbsp;<span class="comment" id="6137243">//&nbsp;read-write&nbsp;protects&nbsp;the&nbsp;following&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6137288">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6137304">net</span><span class="op" id="6137307">.</span><span class="ident" id="6137308">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6137314">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6137330">*</span><span class="ident" id="6137331">bufio</span><span class="op" id="6137336">.</span><span class="ident" id="6137337">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6137345">re</span><span class="op" id="6137347">,</span>&nbsp;<span class="ident" id="6137349">we</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6137361">error</span>&nbsp;<span class="comment" id="6137367">//&nbsp;read/write&nbsp;errors</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6137389">lastbody</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6137405">io</span><span class="op" id="6137407">.</span><span class="ident" id="6137408">ReadCloser</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6137420">nread</span><span class="op" id="6137425">,</span>&nbsp;<span class="ident" id="6137427">nwritten</span>&nbsp;<span class="builtintype" id="6137436">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6137441">pipereq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6137457">map</span><span class="op" id="6137460">[</span><span class="op" id="6137461">*</span><span class="ident" id="6137462">http</span><span class="op" id="6137466">.</span><span class="ident" id="6137467">Request</span><span class="op" id="6137474">]</span><span class="builtintype" id="6137475">uint</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6137482">pipe</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6137491">textproto</span><span class="op" id="6137500">.</span><span class="ident" id="6137501">Pipeline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6137511">writeReq</span>&nbsp;<span class="keyword" id="6137520">func</span><span class="op" id="6137524">(</span><span class="op" id="6137525">*</span><span class="ident" id="6137526">http</span><span class="op" id="6137530">.</span><span class="ident" id="6137531">Request</span><span class="op" id="6137538">,</span>&nbsp;<span class="ident" id="6137540">io</span><span class="op" id="6137542">.</span><span class="ident" id="6137543">Writer</span><span class="op" id="6137549">)</span>&nbsp;<span class="builtintype" id="6137551">error</span><br>
<span class="lineno">240</span><span class="op" id="6137557">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6137560">//&nbsp;NewClientConn&nbsp;returns&nbsp;a&nbsp;new&nbsp;ClientConn&nbsp;reading&nbsp;and&nbsp;writing&nbsp;c.&nbsp;&nbsp;If&nbsp;r&nbsp;is&nbsp;not</span><br>
<span class="lineno"></span><span class="comment" id="6137638">//&nbsp;nil,&nbsp;it&nbsp;is&nbsp;the&nbsp;buffer&nbsp;to&nbsp;use&nbsp;when&nbsp;reading&nbsp;c.</span><br>
<span class="lineno"></span><span class="comment" id="6137686">//</span><br>
<span class="lineno">245</span><span class="comment" id="6137689">//&nbsp;ClientConn&nbsp;is&nbsp;low-level&nbsp;and&nbsp;old.&nbsp;Applications&nbsp;should&nbsp;use&nbsp;Client&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="6137759">//&nbsp;Transport&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="6137797">func</span>&nbsp;<span class="ident" id="6137802">NewClientConn</span><span class="op" id="6137815">(</span><span class="ident" id="6137816">c</span>&nbsp;<span class="ident" id="6137818">net</span><span class="op" id="6137821">.</span><span class="ident" id="6137822">Conn</span><span class="op" id="6137826">,</span>&nbsp;<span class="ident" id="6137828">r</span>&nbsp;<span class="op" id="6137830">*</span><span class="ident" id="6137831">bufio</span><span class="op" id="6137836">.</span><span class="ident" id="6137837">Reader</span><span class="op" id="6137843">)</span>&nbsp;<span class="op" id="6137845">*</span><span class="ident" id="6137846">ClientConn</span>&nbsp;<span class="op" id="6137857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6137860">if</span>&nbsp;<span class="ident" id="6137863">r</span>&nbsp;<span class="op" id="6137865">==</span>&nbsp;<span class="ident" id="6137868">nil</span>&nbsp;<span class="op" id="6137872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6137876">r</span>&nbsp;<span class="op" id="6137878">=</span>&nbsp;<span class="ident" id="6137880">bufio</span><span class="op" id="6137885">.</span><span class="ident" id="6137886">NewReader</span><span class="op" id="6137895">(</span><span class="ident" id="6137896">c</span><span class="op" id="6137897">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6137900">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6137903">return</span>&nbsp;<span class="op" id="6137910">&amp;</span><span class="ident" id="6137911">ClientConn</span><span class="op" id="6137921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6137925">c</span><span class="op" id="6137926">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6137935">c</span><span class="op" id="6137936">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6137940">r</span><span class="op" id="6137941">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6137950">r</span><span class="op" id="6137951">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6137955">pipereq</span><span class="op" id="6137962">:</span>&nbsp;&nbsp;<span class="builtinfunc" id="6137965">make</span><span class="op" id="6137969">(</span><span class="keyword" id="6137970">map</span><span class="op" id="6137973">[</span><span class="op" id="6137974">*</span><span class="ident" id="6137975">http</span><span class="op" id="6137979">.</span><span class="ident" id="6137980">Request</span><span class="op" id="6137987">]</span><span class="builtintype" id="6137988">uint</span><span class="op" id="6137992">)</span><span class="op" id="6137993">,</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6137997">writeReq</span><span class="op" id="6138005">:</span>&nbsp;<span class="op" id="6138007">(</span><span class="op" id="6138008">*</span><span class="ident" id="6138009">http</span><span class="op" id="6138013">.</span><span class="ident" id="6138014">Request</span><span class="op" id="6138021">)</span><span class="op" id="6138022">.</span><span class="ident" id="6138023">Write</span><span class="op" id="6138028">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6138031">}</span><br>
<span class="lineno"></span><span class="op" id="6138033">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6138036">//&nbsp;NewProxyClientConn&nbsp;works&nbsp;like&nbsp;NewClientConn&nbsp;but&nbsp;writes&nbsp;Requests</span><br>
<span class="lineno">260</span><span class="comment" id="6138103">//&nbsp;using&nbsp;Request&#39;s&nbsp;WriteProxy&nbsp;method.</span><br>
<span class="lineno"></span><span class="comment" id="6138141">//</span><br>
<span class="lineno"></span><span class="comment" id="6138144">//&nbsp;New&nbsp;code&nbsp;should&nbsp;not&nbsp;use&nbsp;NewProxyClientConn.&nbsp;See&nbsp;Client&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="6138205">//&nbsp;Transport&nbsp;in&nbsp;the&nbsp;net/http&nbsp;package&nbsp;instead.</span><br>
<span class="lineno"></span><span class="keyword" id="6138251">func</span>&nbsp;<span class="ident" id="6138256">NewProxyClientConn</span><span class="op" id="6138274">(</span><span class="ident" id="6138275">c</span>&nbsp;<span class="ident" id="6138277">net</span><span class="op" id="6138280">.</span><span class="ident" id="6138281">Conn</span><span class="op" id="6138285">,</span>&nbsp;<span class="ident" id="6138287">r</span>&nbsp;<span class="op" id="6138289">*</span><span class="ident" id="6138290">bufio</span><span class="op" id="6138295">.</span><span class="ident" id="6138296">Reader</span><span class="op" id="6138302">)</span>&nbsp;<span class="op" id="6138304">*</span><span class="ident" id="6138305">ClientConn</span>&nbsp;<span class="op" id="6138316">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6138319">cc</span>&nbsp;<span class="op" id="6138322">:=</span>&nbsp;<span class="ident" id="6138325">NewClientConn</span><span class="op" id="6138338">(</span><span class="ident" id="6138339">c</span><span class="op" id="6138340">,</span>&nbsp;<span class="ident" id="6138342">r</span><span class="op" id="6138343">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6138346">cc</span><span class="op" id="6138348">.</span><span class="ident" id="6138349">writeReq</span>&nbsp;<span class="op" id="6138358">=</span>&nbsp;<span class="op" id="6138360">(</span><span class="op" id="6138361">*</span><span class="ident" id="6138362">http</span><span class="op" id="6138366">.</span><span class="ident" id="6138367">Request</span><span class="op" id="6138374">)</span><span class="op" id="6138375">.</span><span class="ident" id="6138376">WriteProxy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6138388">return</span>&nbsp;<span class="ident" id="6138395">cc</span><br>
<span class="lineno"></span><span class="op" id="6138398">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">270</span><span class="comment" id="6138401">//&nbsp;Hijack&nbsp;detaches&nbsp;the&nbsp;ClientConn&nbsp;and&nbsp;returns&nbsp;the&nbsp;underlying&nbsp;connection&nbsp;as&nbsp;well</span><br>
<span class="lineno"></span><span class="comment" id="6138481">//&nbsp;as&nbsp;the&nbsp;read-side&nbsp;bufio&nbsp;which&nbsp;may&nbsp;have&nbsp;some&nbsp;left&nbsp;over&nbsp;data.&nbsp;Hijack&nbsp;may&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="6138557">//&nbsp;called&nbsp;before&nbsp;the&nbsp;user&nbsp;or&nbsp;Read&nbsp;have&nbsp;signaled&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;keep-alive</span><br>
<span class="lineno"></span><span class="comment" id="6138631">//&nbsp;logic.&nbsp;The&nbsp;user&nbsp;should&nbsp;not&nbsp;call&nbsp;Hijack&nbsp;while&nbsp;Read&nbsp;or&nbsp;Write&nbsp;is&nbsp;in&nbsp;progress.</span><br>
<span class="lineno"></span><span class="keyword" id="6138709">func</span>&nbsp;<span class="op" id="6138714">(</span><span class="ident" id="6138715">cc</span>&nbsp;<span class="op" id="6138718">*</span><span class="ident" id="6138719">ClientConn</span><span class="op" id="6138729">)</span>&nbsp;<span class="ident" id="6138731">Hijack</span><span class="op" id="6138737">(</span><span class="op" id="6138738">)</span>&nbsp;<span class="op" id="6138740">(</span><span class="ident" id="6138741">c</span>&nbsp;<span class="ident" id="6138743">net</span><span class="op" id="6138746">.</span><span class="ident" id="6138747">Conn</span><span class="op" id="6138751">,</span>&nbsp;<span class="ident" id="6138753">r</span>&nbsp;<span class="op" id="6138755">*</span><span class="ident" id="6138756">bufio</span><span class="op" id="6138761">.</span><span class="ident" id="6138762">Reader</span><span class="op" id="6138768">)</span>&nbsp;<span class="op" id="6138770">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6138773">cc</span><span class="op" id="6138775">.</span><span class="ident" id="6138776">lk</span><span class="op" id="6138778">.</span><span class="ident" id="6138779">Lock</span><span class="op" id="6138783">(</span><span class="op" id="6138784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6138787">defer</span>&nbsp;<span class="ident" id="6138793">cc</span><span class="op" id="6138795">.</span><span class="ident" id="6138796">lk</span><span class="op" id="6138798">.</span><span class="ident" id="6138799">Unlock</span><span class="op" id="6138805">(</span><span class="op" id="6138806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6138809">c</span>&nbsp;<span class="op" id="6138811">=</span>&nbsp;<span class="ident" id="6138813">cc</span><span class="op" id="6138815">.</span><span class="ident" id="6138816">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6138819">r</span>&nbsp;<span class="op" id="6138821">=</span>&nbsp;<span class="ident" id="6138823">cc</span><span class="op" id="6138825">.</span><span class="ident" id="6138826">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6138829">cc</span><span class="op" id="6138831">.</span><span class="ident" id="6138832">c</span>&nbsp;<span class="op" id="6138834">=</span>&nbsp;<span class="ident" id="6138836">nil</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6138841">cc</span><span class="op" id="6138843">.</span><span class="ident" id="6138844">r</span>&nbsp;<span class="op" id="6138846">=</span>&nbsp;<span class="ident" id="6138848">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6138853">return</span><br>
<span class="lineno"></span><span class="op" id="6138860">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6138863">//&nbsp;Close&nbsp;calls&nbsp;Hijack&nbsp;and&nbsp;then&nbsp;also&nbsp;closes&nbsp;the&nbsp;underlying&nbsp;connection</span><br>
<span class="lineno">285</span><span class="keyword" id="6138932">func</span>&nbsp;<span class="op" id="6138937">(</span><span class="ident" id="6138938">cc</span>&nbsp;<span class="op" id="6138941">*</span><span class="ident" id="6138942">ClientConn</span><span class="op" id="6138952">)</span>&nbsp;<span class="ident" id="6138954">Close</span><span class="op" id="6138959">(</span><span class="op" id="6138960">)</span>&nbsp;<span class="builtintype" id="6138962">error</span>&nbsp;<span class="op" id="6138968">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6138971">c</span><span class="op" id="6138972">,</span>&nbsp;<span class="ident" id="6138974">_</span>&nbsp;<span class="op" id="6138976">:=</span>&nbsp;<span class="ident" id="6138979">cc</span><span class="op" id="6138981">.</span><span class="ident" id="6138982">Hijack</span><span class="op" id="6138988">(</span><span class="op" id="6138989">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6138992">if</span>&nbsp;<span class="ident" id="6138995">c</span>&nbsp;<span class="op" id="6138997">!=</span>&nbsp;<span class="ident" id="6139000">nil</span>&nbsp;<span class="op" id="6139004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6139008">return</span>&nbsp;<span class="ident" id="6139015">c</span><span class="op" id="6139016">.</span><span class="ident" id="6139017">Close</span><span class="op" id="6139022">(</span><span class="op" id="6139023">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6139026">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6139029">return</span>&nbsp;<span class="ident" id="6139036">nil</span><br>
<span class="lineno"></span><span class="op" id="6139040">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6139043">//&nbsp;Write&nbsp;writes&nbsp;a&nbsp;request.&nbsp;An&nbsp;ErrPersistEOF&nbsp;error&nbsp;is&nbsp;returned&nbsp;if&nbsp;the&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="6139123">//&nbsp;has&nbsp;been&nbsp;closed&nbsp;in&nbsp;an&nbsp;HTTP&nbsp;keepalive&nbsp;sense.&nbsp;If&nbsp;req.Close&nbsp;equals&nbsp;true,&nbsp;the</span><br>
<span class="lineno">295</span><span class="comment" id="6139200">//&nbsp;keepalive&nbsp;connection&nbsp;is&nbsp;logically&nbsp;closed&nbsp;after&nbsp;this&nbsp;request&nbsp;and&nbsp;the&nbsp;opposing</span><br>
<span class="lineno"></span><span class="comment" id="6139280">//&nbsp;server&nbsp;is&nbsp;informed.&nbsp;An&nbsp;ErrUnexpectedEOF&nbsp;indicates&nbsp;the&nbsp;remote&nbsp;closed&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6139355">//&nbsp;underlying&nbsp;TCP&nbsp;connection,&nbsp;which&nbsp;is&nbsp;usually&nbsp;considered&nbsp;as&nbsp;graceful&nbsp;close.</span><br>
<span class="lineno"></span><span class="keyword" id="6139432">func</span>&nbsp;<span class="op" id="6139437">(</span><span class="ident" id="6139438">cc</span>&nbsp;<span class="op" id="6139441">*</span><span class="ident" id="6139442">ClientConn</span><span class="op" id="6139452">)</span>&nbsp;<span class="ident" id="6139454">Write</span><span class="op" id="6139459">(</span><span class="ident" id="6139460">req</span>&nbsp;<span class="op" id="6139464">*</span><span class="ident" id="6139465">http</span><span class="op" id="6139469">.</span><span class="ident" id="6139470">Request</span><span class="op" id="6139477">)</span>&nbsp;<span class="op" id="6139479">(</span><span class="ident" id="6139480">err</span>&nbsp;<span class="builtintype" id="6139484">error</span><span class="op" id="6139489">)</span>&nbsp;<span class="op" id="6139491">{</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6139495">//&nbsp;Ensure&nbsp;ordered&nbsp;execution&nbsp;of&nbsp;Writes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6139534">id</span>&nbsp;<span class="op" id="6139537">:=</span>&nbsp;<span class="ident" id="6139540">cc</span><span class="op" id="6139542">.</span><span class="ident" id="6139543">pipe</span><span class="op" id="6139547">.</span><span class="ident" id="6139548">Next</span><span class="op" id="6139552">(</span><span class="op" id="6139553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6139556">cc</span><span class="op" id="6139558">.</span><span class="ident" id="6139559">pipe</span><span class="op" id="6139563">.</span><span class="ident" id="6139564">StartRequest</span><span class="op" id="6139576">(</span><span class="ident" id="6139577">id</span><span class="op" id="6139579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6139582">defer</span>&nbsp;<span class="keyword" id="6139588">func</span><span class="op" id="6139592">(</span><span class="op" id="6139593">)</span>&nbsp;<span class="op" id="6139595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6139599">cc</span><span class="op" id="6139601">.</span><span class="ident" id="6139602">pipe</span><span class="op" id="6139606">.</span><span class="ident" id="6139607">EndRequest</span><span class="op" id="6139617">(</span><span class="ident" id="6139618">id</span><span class="op" id="6139620">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6139624">if</span>&nbsp;<span class="ident" id="6139627">err</span>&nbsp;<span class="op" id="6139631">!=</span>&nbsp;<span class="ident" id="6139634">nil</span>&nbsp;<span class="op" id="6139638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6139643">cc</span><span class="op" id="6139645">.</span><span class="ident" id="6139646">pipe</span><span class="op" id="6139650">.</span><span class="ident" id="6139651">StartResponse</span><span class="op" id="6139664">(</span><span class="ident" id="6139665">id</span><span class="op" id="6139667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6139672">cc</span><span class="op" id="6139674">.</span><span class="ident" id="6139675">pipe</span><span class="op" id="6139679">.</span><span class="ident" id="6139680">EndResponse</span><span class="op" id="6139691">(</span><span class="ident" id="6139692">id</span><span class="op" id="6139694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6139698">}</span>&nbsp;<span class="keyword" id="6139700">else</span>&nbsp;<span class="op" id="6139705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6139710">//&nbsp;Remember&nbsp;the&nbsp;pipeline&nbsp;id&nbsp;of&nbsp;this&nbsp;request</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6139757">cc</span><span class="op" id="6139759">.</span><span class="ident" id="6139760">lk</span><span class="op" id="6139762">.</span><span class="ident" id="6139763">Lock</span><span class="op" id="6139767">(</span><span class="op" id="6139768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6139773">cc</span><span class="op" id="6139775">.</span><span class="ident" id="6139776">pipereq</span><span class="op" id="6139783">[</span><span class="ident" id="6139784">req</span><span class="op" id="6139787">]</span>&nbsp;<span class="op" id="6139789">=</span>&nbsp;<span class="ident" id="6139791">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6139797">cc</span><span class="op" id="6139799">.</span><span class="ident" id="6139800">lk</span><span class="op" id="6139802">.</span><span class="ident" id="6139803">Unlock</span><span class="op" id="6139809">(</span><span class="op" id="6139810">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6139814">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6139817">}</span><span class="op" id="6139818">(</span><span class="op" id="6139819">)</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6139823">cc</span><span class="op" id="6139825">.</span><span class="ident" id="6139826">lk</span><span class="op" id="6139828">.</span><span class="ident" id="6139829">Lock</span><span class="op" id="6139833">(</span><span class="op" id="6139834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6139837">if</span>&nbsp;<span class="ident" id="6139840">cc</span><span class="op" id="6139842">.</span><span class="ident" id="6139843">re</span>&nbsp;<span class="op" id="6139846">!=</span>&nbsp;<span class="ident" id="6139849">nil</span>&nbsp;<span class="op" id="6139853">{</span>&nbsp;<span class="comment" id="6139855">//&nbsp;no&nbsp;point&nbsp;sending&nbsp;if&nbsp;read-side&nbsp;closed&nbsp;or&nbsp;broken</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6139907">defer</span>&nbsp;<span class="ident" id="6139913">cc</span><span class="op" id="6139915">.</span><span class="ident" id="6139916">lk</span><span class="op" id="6139918">.</span><span class="ident" id="6139919">Unlock</span><span class="op" id="6139925">(</span><span class="op" id="6139926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6139930">return</span>&nbsp;<span class="ident" id="6139937">cc</span><span class="op" id="6139939">.</span><span class="ident" id="6139940">re</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6139944">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6139947">if</span>&nbsp;<span class="ident" id="6139950">cc</span><span class="op" id="6139952">.</span><span class="ident" id="6139953">we</span>&nbsp;<span class="op" id="6139956">!=</span>&nbsp;<span class="ident" id="6139959">nil</span>&nbsp;<span class="op" id="6139963">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6139967">defer</span>&nbsp;<span class="ident" id="6139973">cc</span><span class="op" id="6139975">.</span><span class="ident" id="6139976">lk</span><span class="op" id="6139978">.</span><span class="ident" id="6139979">Unlock</span><span class="op" id="6139985">(</span><span class="op" id="6139986">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6139990">return</span>&nbsp;<span class="ident" id="6139997">cc</span><span class="op" id="6139999">.</span><span class="ident" id="6140000">we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6140004">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6140007">if</span>&nbsp;<span class="ident" id="6140010">cc</span><span class="op" id="6140012">.</span><span class="ident" id="6140013">c</span>&nbsp;<span class="op" id="6140015">==</span>&nbsp;<span class="ident" id="6140018">nil</span>&nbsp;<span class="op" id="6140022">{</span>&nbsp;<span class="comment" id="6140024">//&nbsp;connection&nbsp;closed&nbsp;by&nbsp;user&nbsp;in&nbsp;the&nbsp;meantime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6140071">defer</span>&nbsp;<span class="ident" id="6140077">cc</span><span class="op" id="6140079">.</span><span class="ident" id="6140080">lk</span><span class="op" id="6140082">.</span><span class="ident" id="6140083">Unlock</span><span class="op" id="6140089">(</span><span class="op" id="6140090">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6140094">return</span>&nbsp;<span class="ident" id="6140101">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6140112">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6140115">c</span>&nbsp;<span class="op" id="6140117">:=</span>&nbsp;<span class="ident" id="6140120">cc</span><span class="op" id="6140122">.</span><span class="ident" id="6140123">c</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6140126">if</span>&nbsp;<span class="ident" id="6140129">req</span><span class="op" id="6140132">.</span><span class="ident" id="6140133">Close</span>&nbsp;<span class="op" id="6140139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6140143">//&nbsp;We&nbsp;write&nbsp;the&nbsp;EOF&nbsp;to&nbsp;the&nbsp;write-side&nbsp;error,&nbsp;because&nbsp;there</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6140204">//&nbsp;still&nbsp;might&nbsp;be&nbsp;some&nbsp;pipelined&nbsp;reads</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6140245">cc</span><span class="op" id="6140247">.</span><span class="ident" id="6140248">we</span>&nbsp;<span class="op" id="6140251">=</span>&nbsp;<span class="ident" id="6140253">ErrPersistEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6140268">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6140271">cc</span><span class="op" id="6140273">.</span><span class="ident" id="6140274">lk</span><span class="op" id="6140276">.</span><span class="ident" id="6140277">Unlock</span><span class="op" id="6140283">(</span><span class="op" id="6140284">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6140288">err</span>&nbsp;<span class="op" id="6140292">=</span>&nbsp;<span class="ident" id="6140294">cc</span><span class="op" id="6140296">.</span><span class="ident" id="6140297">writeReq</span><span class="op" id="6140305">(</span><span class="ident" id="6140306">req</span><span class="op" id="6140309">,</span>&nbsp;<span class="ident" id="6140311">c</span><span class="op" id="6140312">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6140315">cc</span><span class="op" id="6140317">.</span><span class="ident" id="6140318">lk</span><span class="op" id="6140320">.</span><span class="ident" id="6140321">Lock</span><span class="op" id="6140325">(</span><span class="op" id="6140326">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6140329">defer</span>&nbsp;<span class="ident" id="6140335">cc</span><span class="op" id="6140337">.</span><span class="ident" id="6140338">lk</span><span class="op" id="6140340">.</span><span class="ident" id="6140341">Unlock</span><span class="op" id="6140347">(</span><span class="op" id="6140348">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6140351">if</span>&nbsp;<span class="ident" id="6140354">err</span>&nbsp;<span class="op" id="6140358">!=</span>&nbsp;<span class="ident" id="6140361">nil</span>&nbsp;<span class="op" id="6140365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6140369">cc</span><span class="op" id="6140371">.</span><span class="ident" id="6140372">we</span>&nbsp;<span class="op" id="6140375">=</span>&nbsp;<span class="ident" id="6140377">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6140383">return</span>&nbsp;<span class="ident" id="6140390">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6140395">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6140398">cc</span><span class="op" id="6140400">.</span><span class="ident" id="6140401">nwritten</span><span class="op" id="6140409">++</span><br>
<span class="lineno">345</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6140414">return</span>&nbsp;<span class="ident" id="6140421">nil</span><br>
<span class="lineno"></span><span class="op" id="6140425">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6140428">//&nbsp;Pending&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;unanswered&nbsp;requests</span><br>
<span class="lineno">350</span><span class="comment" id="6140481">//&nbsp;that&nbsp;have&nbsp;been&nbsp;sent&nbsp;on&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="6140523">func</span>&nbsp;<span class="op" id="6140528">(</span><span class="ident" id="6140529">cc</span>&nbsp;<span class="op" id="6140532">*</span><span class="ident" id="6140533">ClientConn</span><span class="op" id="6140543">)</span>&nbsp;<span class="ident" id="6140545">Pending</span><span class="op" id="6140552">(</span><span class="op" id="6140553">)</span>&nbsp;<span class="builtintype" id="6140555">int</span>&nbsp;<span class="op" id="6140559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6140562">cc</span><span class="op" id="6140564">.</span><span class="ident" id="6140565">lk</span><span class="op" id="6140567">.</span><span class="ident" id="6140568">Lock</span><span class="op" id="6140572">(</span><span class="op" id="6140573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6140576">defer</span>&nbsp;<span class="ident" id="6140582">cc</span><span class="op" id="6140584">.</span><span class="ident" id="6140585">lk</span><span class="op" id="6140587">.</span><span class="ident" id="6140588">Unlock</span><span class="op" id="6140594">(</span><span class="op" id="6140595">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6140598">return</span>&nbsp;<span class="ident" id="6140605">cc</span><span class="op" id="6140607">.</span><span class="ident" id="6140608">nwritten</span>&nbsp;<span class="op" id="6140617">-</span>&nbsp;<span class="ident" id="6140619">cc</span><span class="op" id="6140621">.</span><span class="ident" id="6140622">nread</span><br>
<span class="lineno">355</span><span class="op" id="6140628">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6140631">//&nbsp;Read&nbsp;reads&nbsp;the&nbsp;next&nbsp;response&nbsp;from&nbsp;the&nbsp;wire.&nbsp;A&nbsp;valid&nbsp;response&nbsp;might&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="6140704">//&nbsp;returned&nbsp;together&nbsp;with&nbsp;an&nbsp;ErrPersistEOF,&nbsp;which&nbsp;means&nbsp;that&nbsp;the&nbsp;remote</span><br>
<span class="lineno"></span><span class="comment" id="6140776">//&nbsp;requested&nbsp;that&nbsp;this&nbsp;be&nbsp;the&nbsp;last&nbsp;request&nbsp;serviced.&nbsp;Read&nbsp;can&nbsp;be&nbsp;called</span><br>
<span class="lineno">360</span><span class="comment" id="6140848">//&nbsp;concurrently&nbsp;with&nbsp;Write,&nbsp;but&nbsp;not&nbsp;with&nbsp;another&nbsp;Read.</span><br>
<span class="lineno"></span><span class="keyword" id="6140903">func</span>&nbsp;<span class="op" id="6140908">(</span><span class="ident" id="6140909">cc</span>&nbsp;<span class="op" id="6140912">*</span><span class="ident" id="6140913">ClientConn</span><span class="op" id="6140923">)</span>&nbsp;<span class="ident" id="6140925">Read</span><span class="op" id="6140929">(</span><span class="ident" id="6140930">req</span>&nbsp;<span class="op" id="6140934">*</span><span class="ident" id="6140935">http</span><span class="op" id="6140939">.</span><span class="ident" id="6140940">Request</span><span class="op" id="6140947">)</span>&nbsp;<span class="op" id="6140949">(</span><span class="ident" id="6140950">resp</span>&nbsp;<span class="op" id="6140955">*</span><span class="ident" id="6140956">http</span><span class="op" id="6140960">.</span><span class="ident" id="6140961">Response</span><span class="op" id="6140969">,</span>&nbsp;<span class="ident" id="6140971">err</span>&nbsp;<span class="builtintype" id="6140975">error</span><span class="op" id="6140980">)</span>&nbsp;<span class="op" id="6140982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6140985">//&nbsp;Retrieve&nbsp;the&nbsp;pipeline&nbsp;ID&nbsp;of&nbsp;this&nbsp;request/response&nbsp;pair</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6141044">cc</span><span class="op" id="6141046">.</span><span class="ident" id="6141047">lk</span><span class="op" id="6141049">.</span><span class="ident" id="6141050">Lock</span><span class="op" id="6141054">(</span><span class="op" id="6141055">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6141058">id</span><span class="op" id="6141060">,</span>&nbsp;<span class="ident" id="6141062">ok</span>&nbsp;<span class="op" id="6141065">:=</span>&nbsp;<span class="ident" id="6141068">cc</span><span class="op" id="6141070">.</span><span class="ident" id="6141071">pipereq</span><span class="op" id="6141078">[</span><span class="ident" id="6141079">req</span><span class="op" id="6141082">]</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="6141085">delete</span><span class="op" id="6141091">(</span><span class="ident" id="6141092">cc</span><span class="op" id="6141094">.</span><span class="ident" id="6141095">pipereq</span><span class="op" id="6141102">,</span>&nbsp;<span class="ident" id="6141104">req</span><span class="op" id="6141107">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6141110">if</span>&nbsp;<span class="op" id="6141113">!</span><span class="ident" id="6141114">ok</span>&nbsp;<span class="op" id="6141117">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6141121">cc</span><span class="op" id="6141123">.</span><span class="ident" id="6141124">lk</span><span class="op" id="6141126">.</span><span class="ident" id="6141127">Unlock</span><span class="op" id="6141133">(</span><span class="op" id="6141134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6141138">return</span>&nbsp;<span class="ident" id="6141145">nil</span><span class="op" id="6141148">,</span>&nbsp;<span class="ident" id="6141150">ErrPipeline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6141163">}</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6141166">cc</span><span class="op" id="6141168">.</span><span class="ident" id="6141169">lk</span><span class="op" id="6141171">.</span><span class="ident" id="6141172">Unlock</span><span class="op" id="6141178">(</span><span class="op" id="6141179">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6141183">//&nbsp;Ensure&nbsp;pipeline&nbsp;order</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6141209">cc</span><span class="op" id="6141211">.</span><span class="ident" id="6141212">pipe</span><span class="op" id="6141216">.</span><span class="ident" id="6141217">StartResponse</span><span class="op" id="6141230">(</span><span class="ident" id="6141231">id</span><span class="op" id="6141233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6141236">defer</span>&nbsp;<span class="ident" id="6141242">cc</span><span class="op" id="6141244">.</span><span class="ident" id="6141245">pipe</span><span class="op" id="6141249">.</span><span class="ident" id="6141250">EndResponse</span><span class="op" id="6141261">(</span><span class="ident" id="6141262">id</span><span class="op" id="6141264">)</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6141268">cc</span><span class="op" id="6141270">.</span><span class="ident" id="6141271">lk</span><span class="op" id="6141273">.</span><span class="ident" id="6141274">Lock</span><span class="op" id="6141278">(</span><span class="op" id="6141279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6141282">if</span>&nbsp;<span class="ident" id="6141285">cc</span><span class="op" id="6141287">.</span><span class="ident" id="6141288">re</span>&nbsp;<span class="op" id="6141291">!=</span>&nbsp;<span class="ident" id="6141294">nil</span>&nbsp;<span class="op" id="6141298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6141302">defer</span>&nbsp;<span class="ident" id="6141308">cc</span><span class="op" id="6141310">.</span><span class="ident" id="6141311">lk</span><span class="op" id="6141313">.</span><span class="ident" id="6141314">Unlock</span><span class="op" id="6141320">(</span><span class="op" id="6141321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6141325">return</span>&nbsp;<span class="ident" id="6141332">nil</span><span class="op" id="6141335">,</span>&nbsp;<span class="ident" id="6141337">cc</span><span class="op" id="6141339">.</span><span class="ident" id="6141340">re</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6141344">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6141347">if</span>&nbsp;<span class="ident" id="6141350">cc</span><span class="op" id="6141352">.</span><span class="ident" id="6141353">r</span>&nbsp;<span class="op" id="6141355">==</span>&nbsp;<span class="ident" id="6141358">nil</span>&nbsp;<span class="op" id="6141362">{</span>&nbsp;<span class="comment" id="6141364">//&nbsp;connection&nbsp;closed&nbsp;by&nbsp;user&nbsp;in&nbsp;the&nbsp;meantime</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6141411">defer</span>&nbsp;<span class="ident" id="6141417">cc</span><span class="op" id="6141419">.</span><span class="ident" id="6141420">lk</span><span class="op" id="6141422">.</span><span class="ident" id="6141423">Unlock</span><span class="op" id="6141429">(</span><span class="op" id="6141430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6141434">return</span>&nbsp;<span class="ident" id="6141441">nil</span><span class="op" id="6141444">,</span>&nbsp;<span class="ident" id="6141446">errClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6141457">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6141460">r</span>&nbsp;<span class="op" id="6141462">:=</span>&nbsp;<span class="ident" id="6141465">cc</span><span class="op" id="6141467">.</span><span class="ident" id="6141468">r</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6141471">lastbody</span>&nbsp;<span class="op" id="6141480">:=</span>&nbsp;<span class="ident" id="6141483">cc</span><span class="op" id="6141485">.</span><span class="ident" id="6141486">lastbody</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6141496">cc</span><span class="op" id="6141498">.</span><span class="ident" id="6141499">lastbody</span>&nbsp;<span class="op" id="6141508">=</span>&nbsp;<span class="ident" id="6141510">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6141515">cc</span><span class="op" id="6141517">.</span><span class="ident" id="6141518">lk</span><span class="op" id="6141520">.</span><span class="ident" id="6141521">Unlock</span><span class="op" id="6141527">(</span><span class="op" id="6141528">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6141532">//&nbsp;Make&nbsp;sure&nbsp;body&nbsp;is&nbsp;fully&nbsp;consumed,&nbsp;even&nbsp;if&nbsp;user&nbsp;does&nbsp;not&nbsp;call&nbsp;body.Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6141608">if</span>&nbsp;<span class="ident" id="6141611">lastbody</span>&nbsp;<span class="op" id="6141620">!=</span>&nbsp;<span class="ident" id="6141623">nil</span>&nbsp;<span class="op" id="6141627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6141631">//&nbsp;body.Close&nbsp;is&nbsp;assumed&nbsp;to&nbsp;be&nbsp;idempotent&nbsp;and&nbsp;multiple&nbsp;calls&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6141697">//&nbsp;it&nbsp;should&nbsp;return&nbsp;the&nbsp;error&nbsp;that&nbsp;its&nbsp;first&nbsp;invocation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6141755">//&nbsp;returned.</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6141770">err</span>&nbsp;<span class="op" id="6141774">=</span>&nbsp;<span class="ident" id="6141776">lastbody</span><span class="op" id="6141784">.</span><span class="ident" id="6141785">Close</span><span class="op" id="6141790">(</span><span class="op" id="6141791">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6141795">if</span>&nbsp;<span class="ident" id="6141798">err</span>&nbsp;<span class="op" id="6141802">!=</span>&nbsp;<span class="ident" id="6141805">nil</span>&nbsp;<span class="op" id="6141809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6141814">cc</span><span class="op" id="6141816">.</span><span class="ident" id="6141817">lk</span><span class="op" id="6141819">.</span><span class="ident" id="6141820">Lock</span><span class="op" id="6141824">(</span><span class="op" id="6141825">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6141830">defer</span>&nbsp;<span class="ident" id="6141836">cc</span><span class="op" id="6141838">.</span><span class="ident" id="6141839">lk</span><span class="op" id="6141841">.</span><span class="ident" id="6141842">Unlock</span><span class="op" id="6141848">(</span><span class="op" id="6141849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6141854">cc</span><span class="op" id="6141856">.</span><span class="ident" id="6141857">re</span>&nbsp;<span class="op" id="6141860">=</span>&nbsp;<span class="ident" id="6141862">err</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6141869">return</span>&nbsp;<span class="ident" id="6141876">nil</span><span class="op" id="6141879">,</span>&nbsp;<span class="ident" id="6141881">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6141887">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6141890">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6141894">resp</span><span class="op" id="6141898">,</span>&nbsp;<span class="ident" id="6141900">err</span>&nbsp;<span class="op" id="6141904">=</span>&nbsp;<span class="ident" id="6141906">http</span><span class="op" id="6141910">.</span><span class="ident" id="6141911">ReadResponse</span><span class="op" id="6141923">(</span><span class="ident" id="6141924">r</span><span class="op" id="6141925">,</span>&nbsp;<span class="ident" id="6141927">req</span><span class="op" id="6141930">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6141933">cc</span><span class="op" id="6141935">.</span><span class="ident" id="6141936">lk</span><span class="op" id="6141938">.</span><span class="ident" id="6141939">Lock</span><span class="op" id="6141943">(</span><span class="op" id="6141944">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6141947">defer</span>&nbsp;<span class="ident" id="6141953">cc</span><span class="op" id="6141955">.</span><span class="ident" id="6141956">lk</span><span class="op" id="6141958">.</span><span class="ident" id="6141959">Unlock</span><span class="op" id="6141965">(</span><span class="op" id="6141966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6141969">if</span>&nbsp;<span class="ident" id="6141972">err</span>&nbsp;<span class="op" id="6141976">!=</span>&nbsp;<span class="ident" id="6141979">nil</span>&nbsp;<span class="op" id="6141983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6141987">cc</span><span class="op" id="6141989">.</span><span class="ident" id="6141990">re</span>&nbsp;<span class="op" id="6141993">=</span>&nbsp;<span class="ident" id="6141995">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6142001">return</span>&nbsp;<span class="ident" id="6142008">resp</span><span class="op" id="6142012">,</span>&nbsp;<span class="ident" id="6142014">err</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6142019">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6142022">cc</span><span class="op" id="6142024">.</span><span class="ident" id="6142025">lastbody</span>&nbsp;<span class="op" id="6142034">=</span>&nbsp;<span class="ident" id="6142036">resp</span><span class="op" id="6142040">.</span><span class="ident" id="6142041">Body</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6142048">cc</span><span class="op" id="6142050">.</span><span class="ident" id="6142051">nread</span><span class="op" id="6142056">++</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6142061">if</span>&nbsp;<span class="ident" id="6142064">resp</span><span class="op" id="6142068">.</span><span class="ident" id="6142069">Close</span>&nbsp;<span class="op" id="6142075">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6142079">cc</span><span class="op" id="6142081">.</span><span class="ident" id="6142082">re</span>&nbsp;<span class="op" id="6142085">=</span>&nbsp;<span class="ident" id="6142087">ErrPersistEOF</span>&nbsp;<span class="comment" id="6142101">//&nbsp;don&#39;t&nbsp;send&nbsp;any&nbsp;more&nbsp;requests</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6142135">return</span>&nbsp;<span class="ident" id="6142142">resp</span><span class="op" id="6142146">,</span>&nbsp;<span class="ident" id="6142148">cc</span><span class="op" id="6142150">.</span><span class="ident" id="6142151">re</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6142155">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6142158">return</span>&nbsp;<span class="ident" id="6142165">resp</span><span class="op" id="6142169">,</span>&nbsp;<span class="ident" id="6142171">err</span><br>
<span class="lineno">420</span><span class="op" id="6142175">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6142178">//&nbsp;Do&nbsp;is&nbsp;convenience&nbsp;method&nbsp;that&nbsp;writes&nbsp;a&nbsp;request&nbsp;and&nbsp;reads&nbsp;a&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="6142250">func</span>&nbsp;<span class="op" id="6142255">(</span><span class="ident" id="6142256">cc</span>&nbsp;<span class="op" id="6142259">*</span><span class="ident" id="6142260">ClientConn</span><span class="op" id="6142270">)</span>&nbsp;<span class="ident" id="6142272">Do</span><span class="op" id="6142274">(</span><span class="ident" id="6142275">req</span>&nbsp;<span class="op" id="6142279">*</span><span class="ident" id="6142280">http</span><span class="op" id="6142284">.</span><span class="ident" id="6142285">Request</span><span class="op" id="6142292">)</span>&nbsp;<span class="op" id="6142294">(</span><span class="ident" id="6142295">resp</span>&nbsp;<span class="op" id="6142300">*</span><span class="ident" id="6142301">http</span><span class="op" id="6142305">.</span><span class="ident" id="6142306">Response</span><span class="op" id="6142314">,</span>&nbsp;<span class="ident" id="6142316">err</span>&nbsp;<span class="builtintype" id="6142320">error</span><span class="op" id="6142325">)</span>&nbsp;<span class="op" id="6142327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6142330">err</span>&nbsp;<span class="op" id="6142334">=</span>&nbsp;<span class="ident" id="6142336">cc</span><span class="op" id="6142338">.</span><span class="ident" id="6142339">Write</span><span class="op" id="6142344">(</span><span class="ident" id="6142345">req</span><span class="op" id="6142348">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6142351">if</span>&nbsp;<span class="ident" id="6142354">err</span>&nbsp;<span class="op" id="6142358">!=</span>&nbsp;<span class="ident" id="6142361">nil</span>&nbsp;<span class="op" id="6142365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6142369">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6142377">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6142380">return</span>&nbsp;<span class="ident" id="6142387">cc</span><span class="op" id="6142389">.</span><span class="ident" id="6142390">Read</span><span class="op" id="6142394">(</span><span class="ident" id="6142395">req</span><span class="op" id="6142398">)</span><br>
<span class="lineno"></span><span class="op" id="6142400">}</span>
</div>
</body>
</html>
