<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>image/png</h2>
<ul>
<li><a href="/gostd/image/png/paeth.go.html">paeth.go</a></li>
<li><a href="/gostd/image/png/paeth_test.go.html">paeth_test.go</a></li>
<li><a href="/gostd/image/png/reader.go.html">reader.go</a></li>
<li><a href="/gostd/image/png/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/image/png/writer.go.html">writer.go</a></li>
<li><a href="/gostd/image/png/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5827243">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5827298">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5827352">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5827403">package</span>&nbsp;<span class="ident" id="5827411">png</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5827416">import</span>&nbsp;<span class="op" id="5827423">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5827426">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5827435">&#34;compress/zlib&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5827452">&#34;hash/crc32&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5827466">&#34;image&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5827475">&#34;image/color&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5827490">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5827496">&#34;strconv&#34;</span><br>
<span class="lineno">15</span><span class="op" id="5827506">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5827509">//&nbsp;Encoder&nbsp;configures&nbsp;encoding&nbsp;PNG&nbsp;images.</span><br>
<span class="lineno"></span><span class="keyword" id="5827552">type</span>&nbsp;<span class="ident" id="5827557">Encoder</span>&nbsp;<span class="keyword" id="5827565">struct</span>&nbsp;<span class="op" id="5827572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5827575">CompressionLevel</span>&nbsp;<span class="ident" id="5827592">CompressionLevel</span><br>
<span class="lineno">20</span><span class="op" id="5827609">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5827612">type</span>&nbsp;<span class="ident" id="5827617">encoder</span>&nbsp;<span class="keyword" id="5827625">struct</span>&nbsp;<span class="op" id="5827632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5827635">enc</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5827642">*</span><span class="ident" id="5827643">Encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5827652">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5827659">io</span><span class="op" id="5827661">.</span><span class="ident" id="5827662">Writer</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5827670">m</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5827677">image</span><span class="op" id="5827682">.</span><span class="ident" id="5827683">Image</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5827690">cb</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5827697">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5827702">err</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5827709">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5827716">header</span>&nbsp;<span class="op" id="5827723">[</span><span class="num" id="5827724">8</span><span class="op" id="5827725">]</span><span class="builtintype" id="5827726">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5827732">footer</span>&nbsp;<span class="op" id="5827739">[</span><span class="num" id="5827740">4</span><span class="op" id="5827741">]</span><span class="builtintype" id="5827742">byte</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5827748">tmp</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5827755">[</span><span class="num" id="5827756">4</span>&nbsp;<span class="op" id="5827758">*</span>&nbsp;<span class="num" id="5827760">256</span><span class="op" id="5827763">]</span><span class="builtintype" id="5827764">byte</span><br>
<span class="lineno"></span><span class="op" id="5827769">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5827772">type</span>&nbsp;<span class="ident" id="5827777">CompressionLevel</span>&nbsp;<span class="builtintype" id="5827794">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="keyword" id="5827799">const</span>&nbsp;<span class="op" id="5827805">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5827808">DefaultCompression</span>&nbsp;<span class="ident" id="5827827">CompressionLevel</span>&nbsp;<span class="op" id="5827844">=</span>&nbsp;<span class="num" id="5827846">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5827849">NoCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5827868">CompressionLevel</span>&nbsp;<span class="op" id="5827885">=</span>&nbsp;<span class="op" id="5827887">-</span><span class="num" id="5827888">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5827891">BestSpeed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5827910">CompressionLevel</span>&nbsp;<span class="op" id="5827927">=</span>&nbsp;<span class="op" id="5827929">-</span><span class="num" id="5827930">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5827933">BestCompression</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5827952">CompressionLevel</span>&nbsp;<span class="op" id="5827969">=</span>&nbsp;<span class="op" id="5827971">-</span><span class="num" id="5827972">3</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5827976">//&nbsp;Positive&nbsp;CompressionLevel&nbsp;values&nbsp;are&nbsp;reserved&nbsp;to&nbsp;mean&nbsp;a&nbsp;numeric&nbsp;zlib</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5828049">//&nbsp;compression&nbsp;level,&nbsp;although&nbsp;that&nbsp;is&nbsp;not&nbsp;implemented&nbsp;yet.</span><br>
<span class="lineno"></span><span class="op" id="5828109">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="5828112">//&nbsp;Big-endian.</span><br>
<span class="lineno"></span><span class="keyword" id="5828127">func</span>&nbsp;<span class="ident" id="5828132">writeUint32</span><span class="op" id="5828143">(</span><span class="ident" id="5828144">b</span>&nbsp;<span class="op" id="5828146">[</span><span class="op" id="5828147">]</span><span class="builtintype" id="5828148">uint8</span><span class="op" id="5828153">,</span>&nbsp;<span class="ident" id="5828155">u</span>&nbsp;<span class="builtintype" id="5828157">uint32</span><span class="op" id="5828163">)</span>&nbsp;<span class="op" id="5828165">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5828168">b</span><span class="op" id="5828169">[</span><span class="num" id="5828170">0</span><span class="op" id="5828171">]</span>&nbsp;<span class="op" id="5828173">=</span>&nbsp;<span class="builtintype" id="5828175">uint8</span><span class="op" id="5828180">(</span><span class="ident" id="5828181">u</span>&nbsp;<span class="op" id="5828183">&gt;&gt;</span>&nbsp;<span class="num" id="5828186">24</span><span class="op" id="5828188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5828191">b</span><span class="op" id="5828192">[</span><span class="num" id="5828193">1</span><span class="op" id="5828194">]</span>&nbsp;<span class="op" id="5828196">=</span>&nbsp;<span class="builtintype" id="5828198">uint8</span><span class="op" id="5828203">(</span><span class="ident" id="5828204">u</span>&nbsp;<span class="op" id="5828206">&gt;&gt;</span>&nbsp;<span class="num" id="5828209">16</span><span class="op" id="5828211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5828214">b</span><span class="op" id="5828215">[</span><span class="num" id="5828216">2</span><span class="op" id="5828217">]</span>&nbsp;<span class="op" id="5828219">=</span>&nbsp;<span class="builtintype" id="5828221">uint8</span><span class="op" id="5828226">(</span><span class="ident" id="5828227">u</span>&nbsp;<span class="op" id="5828229">&gt;&gt;</span>&nbsp;<span class="num" id="5828232">8</span><span class="op" id="5828233">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5828236">b</span><span class="op" id="5828237">[</span><span class="num" id="5828238">3</span><span class="op" id="5828239">]</span>&nbsp;<span class="op" id="5828241">=</span>&nbsp;<span class="builtintype" id="5828243">uint8</span><span class="op" id="5828248">(</span><span class="ident" id="5828249">u</span>&nbsp;<span class="op" id="5828251">&gt;&gt;</span>&nbsp;<span class="num" id="5828254">0</span><span class="op" id="5828255">)</span><br>
<span class="lineno"></span><span class="op" id="5828257">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5828260">type</span>&nbsp;<span class="ident" id="5828265">opaquer</span>&nbsp;<span class="keyword" id="5828273">interface</span>&nbsp;<span class="op" id="5828283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5828286">Opaque</span><span class="op" id="5828292">(</span><span class="op" id="5828293">)</span>&nbsp;<span class="builtintype" id="5828295">bool</span><br>
<span class="lineno">55</span><span class="op" id="5828300">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5828303">//&nbsp;Returns&nbsp;whether&nbsp;or&nbsp;not&nbsp;the&nbsp;image&nbsp;is&nbsp;fully&nbsp;opaque.</span><br>
<span class="lineno"></span><span class="keyword" id="5828356">func</span>&nbsp;<span class="ident" id="5828361">opaque</span><span class="op" id="5828367">(</span><span class="ident" id="5828368">m</span>&nbsp;<span class="ident" id="5828370">image</span><span class="op" id="5828375">.</span><span class="ident" id="5828376">Image</span><span class="op" id="5828381">)</span>&nbsp;<span class="builtintype" id="5828383">bool</span>&nbsp;<span class="op" id="5828388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5828391">if</span>&nbsp;<span class="ident" id="5828394">o</span><span class="op" id="5828395">,</span>&nbsp;<span class="ident" id="5828397">ok</span>&nbsp;<span class="op" id="5828400">:=</span>&nbsp;<span class="ident" id="5828403">m</span><span class="op" id="5828404">.</span><span class="op" id="5828405">(</span><span class="ident" id="5828406">opaquer</span><span class="op" id="5828413">)</span><span class="op" id="5828414">;</span>&nbsp;<span class="ident" id="5828416">ok</span>&nbsp;<span class="op" id="5828419">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5828423">return</span>&nbsp;<span class="ident" id="5828430">o</span><span class="op" id="5828431">.</span><span class="ident" id="5828432">Opaque</span><span class="op" id="5828438">(</span><span class="op" id="5828439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5828442">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5828445">b</span>&nbsp;<span class="op" id="5828447">:=</span>&nbsp;<span class="ident" id="5828450">m</span><span class="op" id="5828451">.</span><span class="ident" id="5828452">Bounds</span><span class="op" id="5828458">(</span><span class="op" id="5828459">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5828462">for</span>&nbsp;<span class="ident" id="5828466">y</span>&nbsp;<span class="op" id="5828468">:=</span>&nbsp;<span class="ident" id="5828471">b</span><span class="op" id="5828472">.</span><span class="ident" id="5828473">Min</span><span class="op" id="5828476">.</span><span class="ident" id="5828477">Y</span><span class="op" id="5828478">;</span>&nbsp;<span class="ident" id="5828480">y</span>&nbsp;<span class="op" id="5828482">&lt;</span>&nbsp;<span class="ident" id="5828484">b</span><span class="op" id="5828485">.</span><span class="ident" id="5828486">Max</span><span class="op" id="5828489">.</span><span class="ident" id="5828490">Y</span><span class="op" id="5828491">;</span>&nbsp;<span class="ident" id="5828493">y</span><span class="op" id="5828494">++</span>&nbsp;<span class="op" id="5828497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5828501">for</span>&nbsp;<span class="ident" id="5828505">x</span>&nbsp;<span class="op" id="5828507">:=</span>&nbsp;<span class="ident" id="5828510">b</span><span class="op" id="5828511">.</span><span class="ident" id="5828512">Min</span><span class="op" id="5828515">.</span><span class="ident" id="5828516">X</span><span class="op" id="5828517">;</span>&nbsp;<span class="ident" id="5828519">x</span>&nbsp;<span class="op" id="5828521">&lt;</span>&nbsp;<span class="ident" id="5828523">b</span><span class="op" id="5828524">.</span><span class="ident" id="5828525">Max</span><span class="op" id="5828528">.</span><span class="ident" id="5828529">X</span><span class="op" id="5828530">;</span>&nbsp;<span class="ident" id="5828532">x</span><span class="op" id="5828533">++</span>&nbsp;<span class="op" id="5828536">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5828541">_</span><span class="op" id="5828542">,</span>&nbsp;<span class="ident" id="5828544">_</span><span class="op" id="5828545">,</span>&nbsp;<span class="ident" id="5828547">_</span><span class="op" id="5828548">,</span>&nbsp;<span class="ident" id="5828550">a</span>&nbsp;<span class="op" id="5828552">:=</span>&nbsp;<span class="ident" id="5828555">m</span><span class="op" id="5828556">.</span><span class="ident" id="5828557">At</span><span class="op" id="5828559">(</span><span class="ident" id="5828560">x</span><span class="op" id="5828561">,</span>&nbsp;<span class="ident" id="5828563">y</span><span class="op" id="5828564">)</span><span class="op" id="5828565">.</span><span class="ident" id="5828566">RGBA</span><span class="op" id="5828570">(</span><span class="op" id="5828571">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5828576">if</span>&nbsp;<span class="ident" id="5828579">a</span>&nbsp;<span class="op" id="5828581">!=</span>&nbsp;<span class="num" id="5828584">0xffff</span>&nbsp;<span class="op" id="5828591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5828597">return</span>&nbsp;<span class="builtintype" id="5828604">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5828613">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5828617">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5828620">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5828623">return</span>&nbsp;<span class="builtintype" id="5828630">true</span><br>
<span class="lineno"></span><span class="op" id="5828635">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5828638">//&nbsp;The&nbsp;absolute&nbsp;value&nbsp;of&nbsp;a&nbsp;byte&nbsp;interpreted&nbsp;as&nbsp;a&nbsp;signed&nbsp;int8.</span><br>
<span class="lineno">75</span><span class="keyword" id="5828700">func</span>&nbsp;<span class="ident" id="5828705">abs8</span><span class="op" id="5828709">(</span><span class="ident" id="5828710">d</span>&nbsp;<span class="builtintype" id="5828712">uint8</span><span class="op" id="5828717">)</span>&nbsp;<span class="builtintype" id="5828719">int</span>&nbsp;<span class="op" id="5828723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5828726">if</span>&nbsp;<span class="ident" id="5828729">d</span>&nbsp;<span class="op" id="5828731">&lt;</span>&nbsp;<span class="num" id="5828733">128</span>&nbsp;<span class="op" id="5828737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5828741">return</span>&nbsp;<span class="builtintype" id="5828748">int</span><span class="op" id="5828751">(</span><span class="ident" id="5828752">d</span><span class="op" id="5828753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5828756">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5828759">return</span>&nbsp;<span class="num" id="5828766">256</span>&nbsp;<span class="op" id="5828770">-</span>&nbsp;<span class="builtintype" id="5828772">int</span><span class="op" id="5828775">(</span><span class="ident" id="5828776">d</span><span class="op" id="5828777">)</span><br>
<span class="lineno">80</span><span class="op" id="5828779">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5828782">func</span>&nbsp;<span class="op" id="5828787">(</span><span class="ident" id="5828788">e</span>&nbsp;<span class="op" id="5828790">*</span><span class="ident" id="5828791">encoder</span><span class="op" id="5828798">)</span>&nbsp;<span class="ident" id="5828800">writeChunk</span><span class="op" id="5828810">(</span><span class="ident" id="5828811">b</span>&nbsp;<span class="op" id="5828813">[</span><span class="op" id="5828814">]</span><span class="builtintype" id="5828815">byte</span><span class="op" id="5828819">,</span>&nbsp;<span class="ident" id="5828821">name</span>&nbsp;<span class="builtintype" id="5828826">string</span><span class="op" id="5828832">)</span>&nbsp;<span class="op" id="5828834">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5828837">if</span>&nbsp;<span class="ident" id="5828840">e</span><span class="op" id="5828841">.</span><span class="ident" id="5828842">err</span>&nbsp;<span class="op" id="5828846">!=</span>&nbsp;<span class="ident" id="5828849">nil</span>&nbsp;<span class="op" id="5828853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5828857">return</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5828865">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5828868">n</span>&nbsp;<span class="op" id="5828870">:=</span>&nbsp;<span class="builtintype" id="5828873">uint32</span><span class="op" id="5828879">(</span><span class="builtinfunc" id="5828880">len</span><span class="op" id="5828883">(</span><span class="ident" id="5828884">b</span><span class="op" id="5828885">)</span><span class="op" id="5828886">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5828889">if</span>&nbsp;<span class="builtintype" id="5828892">int</span><span class="op" id="5828895">(</span><span class="ident" id="5828896">n</span><span class="op" id="5828897">)</span>&nbsp;<span class="op" id="5828899">!=</span>&nbsp;<span class="builtinfunc" id="5828902">len</span><span class="op" id="5828905">(</span><span class="ident" id="5828906">b</span><span class="op" id="5828907">)</span>&nbsp;<span class="op" id="5828909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5828913">e</span><span class="op" id="5828914">.</span><span class="ident" id="5828915">err</span>&nbsp;<span class="op" id="5828919">=</span>&nbsp;<span class="ident" id="5828921">UnsupportedError</span><span class="op" id="5828937">(</span><span class="ident" id="5828938">name</span>&nbsp;<span class="op" id="5828943">+</span>&nbsp;<span class="string" id="5828945">&#34;&nbsp;chunk&nbsp;is&nbsp;too&nbsp;large:&nbsp;&#34;</span>&nbsp;<span class="op" id="5828969">+</span>&nbsp;<span class="ident" id="5828971">strconv</span><span class="op" id="5828978">.</span><span class="ident" id="5828979">Itoa</span><span class="op" id="5828983">(</span><span class="builtinfunc" id="5828984">len</span><span class="op" id="5828987">(</span><span class="ident" id="5828988">b</span><span class="op" id="5828989">)</span><span class="op" id="5828990">)</span><span class="op" id="5828991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5828995">return</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5829003">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5829006">writeUint32</span><span class="op" id="5829017">(</span><span class="ident" id="5829018">e</span><span class="op" id="5829019">.</span><span class="ident" id="5829020">header</span><span class="op" id="5829026">[</span><span class="op" id="5829027">:</span><span class="num" id="5829028">4</span><span class="op" id="5829029">]</span><span class="op" id="5829030">,</span>&nbsp;<span class="ident" id="5829032">n</span><span class="op" id="5829033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5829036">e</span><span class="op" id="5829037">.</span><span class="ident" id="5829038">header</span><span class="op" id="5829044">[</span><span class="num" id="5829045">4</span><span class="op" id="5829046">]</span>&nbsp;<span class="op" id="5829048">=</span>&nbsp;<span class="ident" id="5829050">name</span><span class="op" id="5829054">[</span><span class="num" id="5829055">0</span><span class="op" id="5829056">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5829059">e</span><span class="op" id="5829060">.</span><span class="ident" id="5829061">header</span><span class="op" id="5829067">[</span><span class="num" id="5829068">5</span><span class="op" id="5829069">]</span>&nbsp;<span class="op" id="5829071">=</span>&nbsp;<span class="ident" id="5829073">name</span><span class="op" id="5829077">[</span><span class="num" id="5829078">1</span><span class="op" id="5829079">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5829082">e</span><span class="op" id="5829083">.</span><span class="ident" id="5829084">header</span><span class="op" id="5829090">[</span><span class="num" id="5829091">6</span><span class="op" id="5829092">]</span>&nbsp;<span class="op" id="5829094">=</span>&nbsp;<span class="ident" id="5829096">name</span><span class="op" id="5829100">[</span><span class="num" id="5829101">2</span><span class="op" id="5829102">]</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5829105">e</span><span class="op" id="5829106">.</span><span class="ident" id="5829107">header</span><span class="op" id="5829113">[</span><span class="num" id="5829114">7</span><span class="op" id="5829115">]</span>&nbsp;<span class="op" id="5829117">=</span>&nbsp;<span class="ident" id="5829119">name</span><span class="op" id="5829123">[</span><span class="num" id="5829124">3</span><span class="op" id="5829125">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5829128">crc</span>&nbsp;<span class="op" id="5829132">:=</span>&nbsp;<span class="ident" id="5829135">crc32</span><span class="op" id="5829140">.</span><span class="ident" id="5829141">NewIEEE</span><span class="op" id="5829148">(</span><span class="op" id="5829149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5829152">crc</span><span class="op" id="5829155">.</span><span class="ident" id="5829156">Write</span><span class="op" id="5829161">(</span><span class="ident" id="5829162">e</span><span class="op" id="5829163">.</span><span class="ident" id="5829164">header</span><span class="op" id="5829170">[</span><span class="num" id="5829171">4</span><span class="op" id="5829172">:</span><span class="num" id="5829173">8</span><span class="op" id="5829174">]</span><span class="op" id="5829175">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5829178">crc</span><span class="op" id="5829181">.</span><span class="ident" id="5829182">Write</span><span class="op" id="5829187">(</span><span class="ident" id="5829188">b</span><span class="op" id="5829189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5829192">writeUint32</span><span class="op" id="5829203">(</span><span class="ident" id="5829204">e</span><span class="op" id="5829205">.</span><span class="ident" id="5829206">footer</span><span class="op" id="5829212">[</span><span class="op" id="5829213">:</span><span class="num" id="5829214">4</span><span class="op" id="5829215">]</span><span class="op" id="5829216">,</span>&nbsp;<span class="ident" id="5829218">crc</span><span class="op" id="5829221">.</span><span class="ident" id="5829222">Sum32</span><span class="op" id="5829227">(</span><span class="op" id="5829228">)</span><span class="op" id="5829229">)</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5829233">_</span><span class="op" id="5829234">,</span>&nbsp;<span class="ident" id="5829236">e</span><span class="op" id="5829237">.</span><span class="ident" id="5829238">err</span>&nbsp;<span class="op" id="5829242">=</span>&nbsp;<span class="ident" id="5829244">e</span><span class="op" id="5829245">.</span><span class="ident" id="5829246">w</span><span class="op" id="5829247">.</span><span class="ident" id="5829248">Write</span><span class="op" id="5829253">(</span><span class="ident" id="5829254">e</span><span class="op" id="5829255">.</span><span class="ident" id="5829256">header</span><span class="op" id="5829262">[</span><span class="op" id="5829263">:</span><span class="num" id="5829264">8</span><span class="op" id="5829265">]</span><span class="op" id="5829266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5829269">if</span>&nbsp;<span class="ident" id="5829272">e</span><span class="op" id="5829273">.</span><span class="ident" id="5829274">err</span>&nbsp;<span class="op" id="5829278">!=</span>&nbsp;<span class="ident" id="5829281">nil</span>&nbsp;<span class="op" id="5829285">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5829289">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5829297">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5829300">_</span><span class="op" id="5829301">,</span>&nbsp;<span class="ident" id="5829303">e</span><span class="op" id="5829304">.</span><span class="ident" id="5829305">err</span>&nbsp;<span class="op" id="5829309">=</span>&nbsp;<span class="ident" id="5829311">e</span><span class="op" id="5829312">.</span><span class="ident" id="5829313">w</span><span class="op" id="5829314">.</span><span class="ident" id="5829315">Write</span><span class="op" id="5829320">(</span><span class="ident" id="5829321">b</span><span class="op" id="5829322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5829325">if</span>&nbsp;<span class="ident" id="5829328">e</span><span class="op" id="5829329">.</span><span class="ident" id="5829330">err</span>&nbsp;<span class="op" id="5829334">!=</span>&nbsp;<span class="ident" id="5829337">nil</span>&nbsp;<span class="op" id="5829341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5829345">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5829353">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5829356">_</span><span class="op" id="5829357">,</span>&nbsp;<span class="ident" id="5829359">e</span><span class="op" id="5829360">.</span><span class="ident" id="5829361">err</span>&nbsp;<span class="op" id="5829365">=</span>&nbsp;<span class="ident" id="5829367">e</span><span class="op" id="5829368">.</span><span class="ident" id="5829369">w</span><span class="op" id="5829370">.</span><span class="ident" id="5829371">Write</span><span class="op" id="5829376">(</span><span class="ident" id="5829377">e</span><span class="op" id="5829378">.</span><span class="ident" id="5829379">footer</span><span class="op" id="5829385">[</span><span class="op" id="5829386">:</span><span class="num" id="5829387">4</span><span class="op" id="5829388">]</span><span class="op" id="5829389">)</span><br>
<span class="lineno">110</span><span class="op" id="5829391">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5829394">func</span>&nbsp;<span class="op" id="5829399">(</span><span class="ident" id="5829400">e</span>&nbsp;<span class="op" id="5829402">*</span><span class="ident" id="5829403">encoder</span><span class="op" id="5829410">)</span>&nbsp;<span class="ident" id="5829412">writeIHDR</span><span class="op" id="5829421">(</span><span class="op" id="5829422">)</span>&nbsp;<span class="op" id="5829424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5829427">b</span>&nbsp;<span class="op" id="5829429">:=</span>&nbsp;<span class="ident" id="5829432">e</span><span class="op" id="5829433">.</span><span class="ident" id="5829434">m</span><span class="op" id="5829435">.</span><span class="ident" id="5829436">Bounds</span><span class="op" id="5829442">(</span><span class="op" id="5829443">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5829446">writeUint32</span><span class="op" id="5829457">(</span><span class="ident" id="5829458">e</span><span class="op" id="5829459">.</span><span class="ident" id="5829460">tmp</span><span class="op" id="5829463">[</span><span class="num" id="5829464">0</span><span class="op" id="5829465">:</span><span class="num" id="5829466">4</span><span class="op" id="5829467">]</span><span class="op" id="5829468">,</span>&nbsp;<span class="builtintype" id="5829470">uint32</span><span class="op" id="5829476">(</span><span class="ident" id="5829477">b</span><span class="op" id="5829478">.</span><span class="ident" id="5829479">Dx</span><span class="op" id="5829481">(</span><span class="op" id="5829482">)</span><span class="op" id="5829483">)</span><span class="op" id="5829484">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5829487">writeUint32</span><span class="op" id="5829498">(</span><span class="ident" id="5829499">e</span><span class="op" id="5829500">.</span><span class="ident" id="5829501">tmp</span><span class="op" id="5829504">[</span><span class="num" id="5829505">4</span><span class="op" id="5829506">:</span><span class="num" id="5829507">8</span><span class="op" id="5829508">]</span><span class="op" id="5829509">,</span>&nbsp;<span class="builtintype" id="5829511">uint32</span><span class="op" id="5829517">(</span><span class="ident" id="5829518">b</span><span class="op" id="5829519">.</span><span class="ident" id="5829520">Dy</span><span class="op" id="5829522">(</span><span class="op" id="5829523">)</span><span class="op" id="5829524">)</span><span class="op" id="5829525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5829528">//&nbsp;Set&nbsp;bit&nbsp;depth&nbsp;and&nbsp;color&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5829562">switch</span>&nbsp;<span class="ident" id="5829569">e</span><span class="op" id="5829570">.</span><span class="ident" id="5829571">cb</span>&nbsp;<span class="op" id="5829574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5829577">case</span>&nbsp;<span class="ident" id="5829582">cbG8</span><span class="op" id="5829586">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5829590">e</span><span class="op" id="5829591">.</span><span class="ident" id="5829592">tmp</span><span class="op" id="5829595">[</span><span class="num" id="5829596">8</span><span class="op" id="5829597">]</span>&nbsp;<span class="op" id="5829599">=</span>&nbsp;<span class="num" id="5829601">8</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5829605">e</span><span class="op" id="5829606">.</span><span class="ident" id="5829607">tmp</span><span class="op" id="5829610">[</span><span class="num" id="5829611">9</span><span class="op" id="5829612">]</span>&nbsp;<span class="op" id="5829614">=</span>&nbsp;<span class="ident" id="5829616">ctGrayscale</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5829629">case</span>&nbsp;<span class="ident" id="5829634">cbTC8</span><span class="op" id="5829639">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5829643">e</span><span class="op" id="5829644">.</span><span class="ident" id="5829645">tmp</span><span class="op" id="5829648">[</span><span class="num" id="5829649">8</span><span class="op" id="5829650">]</span>&nbsp;<span class="op" id="5829652">=</span>&nbsp;<span class="num" id="5829654">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5829658">e</span><span class="op" id="5829659">.</span><span class="ident" id="5829660">tmp</span><span class="op" id="5829663">[</span><span class="num" id="5829664">9</span><span class="op" id="5829665">]</span>&nbsp;<span class="op" id="5829667">=</span>&nbsp;<span class="ident" id="5829669">ctTrueColor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5829682">case</span>&nbsp;<span class="ident" id="5829687">cbP8</span><span class="op" id="5829691">:</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5829695">e</span><span class="op" id="5829696">.</span><span class="ident" id="5829697">tmp</span><span class="op" id="5829700">[</span><span class="num" id="5829701">8</span><span class="op" id="5829702">]</span>&nbsp;<span class="op" id="5829704">=</span>&nbsp;<span class="num" id="5829706">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5829710">e</span><span class="op" id="5829711">.</span><span class="ident" id="5829712">tmp</span><span class="op" id="5829715">[</span><span class="num" id="5829716">9</span><span class="op" id="5829717">]</span>&nbsp;<span class="op" id="5829719">=</span>&nbsp;<span class="ident" id="5829721">ctPaletted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5829733">case</span>&nbsp;<span class="ident" id="5829738">cbTCA8</span><span class="op" id="5829744">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5829748">e</span><span class="op" id="5829749">.</span><span class="ident" id="5829750">tmp</span><span class="op" id="5829753">[</span><span class="num" id="5829754">8</span><span class="op" id="5829755">]</span>&nbsp;<span class="op" id="5829757">=</span>&nbsp;<span class="num" id="5829759">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5829763">e</span><span class="op" id="5829764">.</span><span class="ident" id="5829765">tmp</span><span class="op" id="5829768">[</span><span class="num" id="5829769">9</span><span class="op" id="5829770">]</span>&nbsp;<span class="op" id="5829772">=</span>&nbsp;<span class="ident" id="5829774">ctTrueColorAlpha</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5829792">case</span>&nbsp;<span class="ident" id="5829797">cbG16</span><span class="op" id="5829802">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5829806">e</span><span class="op" id="5829807">.</span><span class="ident" id="5829808">tmp</span><span class="op" id="5829811">[</span><span class="num" id="5829812">8</span><span class="op" id="5829813">]</span>&nbsp;<span class="op" id="5829815">=</span>&nbsp;<span class="num" id="5829817">16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5829822">e</span><span class="op" id="5829823">.</span><span class="ident" id="5829824">tmp</span><span class="op" id="5829827">[</span><span class="num" id="5829828">9</span><span class="op" id="5829829">]</span>&nbsp;<span class="op" id="5829831">=</span>&nbsp;<span class="ident" id="5829833">ctGrayscale</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5829846">case</span>&nbsp;<span class="ident" id="5829851">cbTC16</span><span class="op" id="5829857">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5829861">e</span><span class="op" id="5829862">.</span><span class="ident" id="5829863">tmp</span><span class="op" id="5829866">[</span><span class="num" id="5829867">8</span><span class="op" id="5829868">]</span>&nbsp;<span class="op" id="5829870">=</span>&nbsp;<span class="num" id="5829872">16</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5829877">e</span><span class="op" id="5829878">.</span><span class="ident" id="5829879">tmp</span><span class="op" id="5829882">[</span><span class="num" id="5829883">9</span><span class="op" id="5829884">]</span>&nbsp;<span class="op" id="5829886">=</span>&nbsp;<span class="ident" id="5829888">ctTrueColor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5829901">case</span>&nbsp;<span class="ident" id="5829906">cbTCA16</span><span class="op" id="5829913">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5829917">e</span><span class="op" id="5829918">.</span><span class="ident" id="5829919">tmp</span><span class="op" id="5829922">[</span><span class="num" id="5829923">8</span><span class="op" id="5829924">]</span>&nbsp;<span class="op" id="5829926">=</span>&nbsp;<span class="num" id="5829928">16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5829933">e</span><span class="op" id="5829934">.</span><span class="ident" id="5829935">tmp</span><span class="op" id="5829938">[</span><span class="num" id="5829939">9</span><span class="op" id="5829940">]</span>&nbsp;<span class="op" id="5829942">=</span>&nbsp;<span class="ident" id="5829944">ctTrueColorAlpha</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5829962">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5829965">e</span><span class="op" id="5829966">.</span><span class="ident" id="5829967">tmp</span><span class="op" id="5829970">[</span><span class="num" id="5829971">10</span><span class="op" id="5829973">]</span>&nbsp;<span class="op" id="5829975">=</span>&nbsp;<span class="num" id="5829977">0</span>&nbsp;<span class="comment" id="5829979">//&nbsp;default&nbsp;compression&nbsp;method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5830010">e</span><span class="op" id="5830011">.</span><span class="ident" id="5830012">tmp</span><span class="op" id="5830015">[</span><span class="num" id="5830016">11</span><span class="op" id="5830018">]</span>&nbsp;<span class="op" id="5830020">=</span>&nbsp;<span class="num" id="5830022">0</span>&nbsp;<span class="comment" id="5830024">//&nbsp;default&nbsp;filter&nbsp;method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5830050">e</span><span class="op" id="5830051">.</span><span class="ident" id="5830052">tmp</span><span class="op" id="5830055">[</span><span class="num" id="5830056">12</span><span class="op" id="5830058">]</span>&nbsp;<span class="op" id="5830060">=</span>&nbsp;<span class="num" id="5830062">0</span>&nbsp;<span class="comment" id="5830064">//&nbsp;non-interlaced</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5830083">e</span><span class="op" id="5830084">.</span><span class="ident" id="5830085">writeChunk</span><span class="op" id="5830095">(</span><span class="ident" id="5830096">e</span><span class="op" id="5830097">.</span><span class="ident" id="5830098">tmp</span><span class="op" id="5830101">[</span><span class="op" id="5830102">:</span><span class="num" id="5830103">13</span><span class="op" id="5830105">]</span><span class="op" id="5830106">,</span>&nbsp;<span class="string" id="5830108">&#34;IHDR&#34;</span><span class="op" id="5830114">)</span><br>
<span class="lineno"></span><span class="op" id="5830116">}</span><br>
<span class="lineno">145</span><br>
<span class="lineno"></span><span class="keyword" id="5830119">func</span>&nbsp;<span class="op" id="5830124">(</span><span class="ident" id="5830125">e</span>&nbsp;<span class="op" id="5830127">*</span><span class="ident" id="5830128">encoder</span><span class="op" id="5830135">)</span>&nbsp;<span class="ident" id="5830137">writePLTEAndTRNS</span><span class="op" id="5830153">(</span><span class="ident" id="5830154">p</span>&nbsp;<span class="ident" id="5830156">color</span><span class="op" id="5830161">.</span><span class="ident" id="5830162">Palette</span><span class="op" id="5830169">)</span>&nbsp;<span class="op" id="5830171">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5830174">if</span>&nbsp;<span class="builtinfunc" id="5830177">len</span><span class="op" id="5830180">(</span><span class="ident" id="5830181">p</span><span class="op" id="5830182">)</span>&nbsp;<span class="op" id="5830184">&lt;</span>&nbsp;<span class="num" id="5830186">1</span>&nbsp;<span class="op" id="5830188">||</span>&nbsp;<span class="builtinfunc" id="5830191">len</span><span class="op" id="5830194">(</span><span class="ident" id="5830195">p</span><span class="op" id="5830196">)</span>&nbsp;<span class="op" id="5830198">&gt;</span>&nbsp;<span class="num" id="5830200">256</span>&nbsp;<span class="op" id="5830204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5830208">e</span><span class="op" id="5830209">.</span><span class="ident" id="5830210">err</span>&nbsp;<span class="op" id="5830214">=</span>&nbsp;<span class="ident" id="5830216">FormatError</span><span class="op" id="5830227">(</span><span class="string" id="5830228">&#34;bad&nbsp;palette&nbsp;length:&nbsp;&#34;</span>&nbsp;<span class="op" id="5830251">+</span>&nbsp;<span class="ident" id="5830253">strconv</span><span class="op" id="5830260">.</span><span class="ident" id="5830261">Itoa</span><span class="op" id="5830265">(</span><span class="builtinfunc" id="5830266">len</span><span class="op" id="5830269">(</span><span class="ident" id="5830270">p</span><span class="op" id="5830271">)</span><span class="op" id="5830272">)</span><span class="op" id="5830273">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5830277">return</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5830285">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5830288">last</span>&nbsp;<span class="op" id="5830293">:=</span>&nbsp;<span class="op" id="5830296">-</span><span class="num" id="5830297">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5830300">for</span>&nbsp;<span class="ident" id="5830304">i</span><span class="op" id="5830305">,</span>&nbsp;<span class="ident" id="5830307">c</span>&nbsp;<span class="op" id="5830309">:=</span>&nbsp;<span class="keyword" id="5830312">range</span>&nbsp;<span class="ident" id="5830318">p</span>&nbsp;<span class="op" id="5830320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5830324">c1</span>&nbsp;<span class="op" id="5830327">:=</span>&nbsp;<span class="ident" id="5830330">color</span><span class="op" id="5830335">.</span><span class="ident" id="5830336">NRGBAModel</span><span class="op" id="5830346">.</span><span class="ident" id="5830347">Convert</span><span class="op" id="5830354">(</span><span class="ident" id="5830355">c</span><span class="op" id="5830356">)</span><span class="op" id="5830357">.</span><span class="op" id="5830358">(</span><span class="ident" id="5830359">color</span><span class="op" id="5830364">.</span><span class="ident" id="5830365">NRGBA</span><span class="op" id="5830370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5830374">e</span><span class="op" id="5830375">.</span><span class="ident" id="5830376">tmp</span><span class="op" id="5830379">[</span><span class="num" id="5830380">3</span><span class="op" id="5830381">*</span><span class="ident" id="5830382">i</span><span class="op" id="5830383">+</span><span class="num" id="5830384">0</span><span class="op" id="5830385">]</span>&nbsp;<span class="op" id="5830387">=</span>&nbsp;<span class="ident" id="5830389">c1</span><span class="op" id="5830391">.</span><span class="ident" id="5830392">R</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5830396">e</span><span class="op" id="5830397">.</span><span class="ident" id="5830398">tmp</span><span class="op" id="5830401">[</span><span class="num" id="5830402">3</span><span class="op" id="5830403">*</span><span class="ident" id="5830404">i</span><span class="op" id="5830405">+</span><span class="num" id="5830406">1</span><span class="op" id="5830407">]</span>&nbsp;<span class="op" id="5830409">=</span>&nbsp;<span class="ident" id="5830411">c1</span><span class="op" id="5830413">.</span><span class="ident" id="5830414">G</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5830418">e</span><span class="op" id="5830419">.</span><span class="ident" id="5830420">tmp</span><span class="op" id="5830423">[</span><span class="num" id="5830424">3</span><span class="op" id="5830425">*</span><span class="ident" id="5830426">i</span><span class="op" id="5830427">+</span><span class="num" id="5830428">2</span><span class="op" id="5830429">]</span>&nbsp;<span class="op" id="5830431">=</span>&nbsp;<span class="ident" id="5830433">c1</span><span class="op" id="5830435">.</span><span class="ident" id="5830436">B</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5830440">if</span>&nbsp;<span class="ident" id="5830443">c1</span><span class="op" id="5830445">.</span><span class="ident" id="5830446">A</span>&nbsp;<span class="op" id="5830448">!=</span>&nbsp;<span class="num" id="5830451">0xff</span>&nbsp;<span class="op" id="5830456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5830461">last</span>&nbsp;<span class="op" id="5830466">=</span>&nbsp;<span class="ident" id="5830468">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5830472">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5830476">e</span><span class="op" id="5830477">.</span><span class="ident" id="5830478">tmp</span><span class="op" id="5830481">[</span><span class="num" id="5830482">3</span><span class="op" id="5830483">*</span><span class="num" id="5830484">256</span><span class="op" id="5830487">+</span><span class="ident" id="5830488">i</span><span class="op" id="5830489">]</span>&nbsp;<span class="op" id="5830491">=</span>&nbsp;<span class="ident" id="5830493">c1</span><span class="op" id="5830495">.</span><span class="ident" id="5830496">A</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5830499">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5830502">e</span><span class="op" id="5830503">.</span><span class="ident" id="5830504">writeChunk</span><span class="op" id="5830514">(</span><span class="ident" id="5830515">e</span><span class="op" id="5830516">.</span><span class="ident" id="5830517">tmp</span><span class="op" id="5830520">[</span><span class="op" id="5830521">:</span><span class="num" id="5830522">3</span><span class="op" id="5830523">*</span><span class="builtinfunc" id="5830524">len</span><span class="op" id="5830527">(</span><span class="ident" id="5830528">p</span><span class="op" id="5830529">)</span><span class="op" id="5830530">]</span><span class="op" id="5830531">,</span>&nbsp;<span class="string" id="5830533">&#34;PLTE&#34;</span><span class="op" id="5830539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5830542">if</span>&nbsp;<span class="ident" id="5830545">last</span>&nbsp;<span class="op" id="5830550">!=</span>&nbsp;<span class="op" id="5830553">-</span><span class="num" id="5830554">1</span>&nbsp;<span class="op" id="5830556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5830560">e</span><span class="op" id="5830561">.</span><span class="ident" id="5830562">writeChunk</span><span class="op" id="5830572">(</span><span class="ident" id="5830573">e</span><span class="op" id="5830574">.</span><span class="ident" id="5830575">tmp</span><span class="op" id="5830578">[</span><span class="num" id="5830579">3</span><span class="op" id="5830580">*</span><span class="num" id="5830581">256</span><span class="op" id="5830584">:</span><span class="num" id="5830585">3</span><span class="op" id="5830586">*</span><span class="num" id="5830587">256</span><span class="op" id="5830590">+</span><span class="num" id="5830591">1</span><span class="op" id="5830592">+</span><span class="ident" id="5830593">last</span><span class="op" id="5830597">]</span><span class="op" id="5830598">,</span>&nbsp;<span class="string" id="5830600">&#34;tRNS&#34;</span><span class="op" id="5830606">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5830609">}</span><br>
<span class="lineno"></span><span class="op" id="5830611">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5830614">//&nbsp;An&nbsp;encoder&nbsp;is&nbsp;an&nbsp;io.Writer&nbsp;that&nbsp;satisfies&nbsp;writes&nbsp;by&nbsp;writing&nbsp;PNG&nbsp;IDAT&nbsp;chunks,</span><br>
<span class="lineno"></span><span class="comment" id="5830694">//&nbsp;including&nbsp;an&nbsp;8-byte&nbsp;header&nbsp;and&nbsp;4-byte&nbsp;CRC&nbsp;checksum&nbsp;per&nbsp;Write&nbsp;call.&nbsp;Such&nbsp;calls</span><br>
<span class="lineno">170</span><span class="comment" id="5830775">//&nbsp;should&nbsp;be&nbsp;relatively&nbsp;infrequent,&nbsp;since&nbsp;writeIDATs&nbsp;uses&nbsp;a&nbsp;bufio.Writer.</span><br>
<span class="lineno"></span><span class="comment" id="5830849">//</span><br>
<span class="lineno"></span><span class="comment" id="5830852">//&nbsp;This&nbsp;method&nbsp;should&nbsp;only&nbsp;be&nbsp;called&nbsp;from&nbsp;writeIDATs&nbsp;(via&nbsp;writeImage).</span><br>
<span class="lineno"></span><span class="comment" id="5830923">//&nbsp;No&nbsp;other&nbsp;code&nbsp;should&nbsp;treat&nbsp;an&nbsp;encoder&nbsp;as&nbsp;an&nbsp;io.Writer.</span><br>
<span class="lineno"></span><span class="keyword" id="5830981">func</span>&nbsp;<span class="op" id="5830986">(</span><span class="ident" id="5830987">e</span>&nbsp;<span class="op" id="5830989">*</span><span class="ident" id="5830990">encoder</span><span class="op" id="5830997">)</span>&nbsp;<span class="ident" id="5830999">Write</span><span class="op" id="5831004">(</span><span class="ident" id="5831005">b</span>&nbsp;<span class="op" id="5831007">[</span><span class="op" id="5831008">]</span><span class="builtintype" id="5831009">byte</span><span class="op" id="5831013">)</span>&nbsp;<span class="op" id="5831015">(</span><span class="builtintype" id="5831016">int</span><span class="op" id="5831019">,</span>&nbsp;<span class="builtintype" id="5831021">error</span><span class="op" id="5831026">)</span>&nbsp;<span class="op" id="5831028">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5831031">e</span><span class="op" id="5831032">.</span><span class="ident" id="5831033">writeChunk</span><span class="op" id="5831043">(</span><span class="ident" id="5831044">b</span><span class="op" id="5831045">,</span>&nbsp;<span class="string" id="5831047">&#34;IDAT&#34;</span><span class="op" id="5831053">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5831056">if</span>&nbsp;<span class="ident" id="5831059">e</span><span class="op" id="5831060">.</span><span class="ident" id="5831061">err</span>&nbsp;<span class="op" id="5831065">!=</span>&nbsp;<span class="ident" id="5831068">nil</span>&nbsp;<span class="op" id="5831072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5831076">return</span>&nbsp;<span class="num" id="5831083">0</span><span class="op" id="5831084">,</span>&nbsp;<span class="ident" id="5831086">e</span><span class="op" id="5831087">.</span><span class="ident" id="5831088">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5831093">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5831096">return</span>&nbsp;<span class="builtinfunc" id="5831103">len</span><span class="op" id="5831106">(</span><span class="ident" id="5831107">b</span><span class="op" id="5831108">)</span><span class="op" id="5831109">,</span>&nbsp;<span class="ident" id="5831111">nil</span><br>
<span class="lineno">180</span><span class="op" id="5831115">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5831118">//&nbsp;Chooses&nbsp;the&nbsp;filter&nbsp;to&nbsp;use&nbsp;for&nbsp;encoding&nbsp;the&nbsp;current&nbsp;row,&nbsp;and&nbsp;applies&nbsp;it.</span><br>
<span class="lineno"></span><span class="comment" id="5831193">//&nbsp;The&nbsp;return&nbsp;value&nbsp;is&nbsp;the&nbsp;index&nbsp;of&nbsp;the&nbsp;filter&nbsp;and&nbsp;also&nbsp;of&nbsp;the&nbsp;row&nbsp;in&nbsp;cr&nbsp;that&nbsp;has&nbsp;had&nbsp;it&nbsp;applied.</span><br>
<span class="lineno"></span><span class="keyword" id="5831291">func</span>&nbsp;<span class="ident" id="5831296">filter</span><span class="op" id="5831302">(</span><span class="ident" id="5831303">cr</span>&nbsp;<span class="op" id="5831306">*</span><span class="op" id="5831307">[</span><span class="ident" id="5831308">nFilter</span><span class="op" id="5831315">]</span><span class="op" id="5831316">[</span><span class="op" id="5831317">]</span><span class="builtintype" id="5831318">byte</span><span class="op" id="5831322">,</span>&nbsp;<span class="ident" id="5831324">pr</span>&nbsp;<span class="op" id="5831327">[</span><span class="op" id="5831328">]</span><span class="builtintype" id="5831329">byte</span><span class="op" id="5831333">,</span>&nbsp;<span class="ident" id="5831335">bpp</span>&nbsp;<span class="builtintype" id="5831339">int</span><span class="op" id="5831342">)</span>&nbsp;<span class="builtintype" id="5831344">int</span>&nbsp;<span class="op" id="5831348">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5831351">//&nbsp;We&nbsp;try&nbsp;all&nbsp;five&nbsp;filter&nbsp;types,&nbsp;and&nbsp;pick&nbsp;the&nbsp;one&nbsp;that&nbsp;minimizes&nbsp;the&nbsp;sum&nbsp;of&nbsp;absolute&nbsp;differences.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5831450">//&nbsp;This&nbsp;is&nbsp;the&nbsp;same&nbsp;heuristic&nbsp;that&nbsp;libpng&nbsp;uses,&nbsp;although&nbsp;the&nbsp;filters&nbsp;are&nbsp;attempted&nbsp;in&nbsp;order&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5831546">//&nbsp;estimated&nbsp;most&nbsp;likely&nbsp;to&nbsp;be&nbsp;minimal&nbsp;(ftUp,&nbsp;ftPaeth,&nbsp;ftNone,&nbsp;ftSub,&nbsp;ftAverage),&nbsp;rather&nbsp;than</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5831641">//&nbsp;in&nbsp;their&nbsp;enumeration&nbsp;order&nbsp;(ftNone,&nbsp;ftSub,&nbsp;ftUp,&nbsp;ftAverage,&nbsp;ftPaeth).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5831715">cdat0</span>&nbsp;<span class="op" id="5831721">:=</span>&nbsp;<span class="ident" id="5831724">cr</span><span class="op" id="5831726">[</span><span class="num" id="5831727">0</span><span class="op" id="5831728">]</span><span class="op" id="5831729">[</span><span class="num" id="5831730">1</span><span class="op" id="5831731">:</span><span class="op" id="5831732">]</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5831735">cdat1</span>&nbsp;<span class="op" id="5831741">:=</span>&nbsp;<span class="ident" id="5831744">cr</span><span class="op" id="5831746">[</span><span class="num" id="5831747">1</span><span class="op" id="5831748">]</span><span class="op" id="5831749">[</span><span class="num" id="5831750">1</span><span class="op" id="5831751">:</span><span class="op" id="5831752">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5831755">cdat2</span>&nbsp;<span class="op" id="5831761">:=</span>&nbsp;<span class="ident" id="5831764">cr</span><span class="op" id="5831766">[</span><span class="num" id="5831767">2</span><span class="op" id="5831768">]</span><span class="op" id="5831769">[</span><span class="num" id="5831770">1</span><span class="op" id="5831771">:</span><span class="op" id="5831772">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5831775">cdat3</span>&nbsp;<span class="op" id="5831781">:=</span>&nbsp;<span class="ident" id="5831784">cr</span><span class="op" id="5831786">[</span><span class="num" id="5831787">3</span><span class="op" id="5831788">]</span><span class="op" id="5831789">[</span><span class="num" id="5831790">1</span><span class="op" id="5831791">:</span><span class="op" id="5831792">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5831795">cdat4</span>&nbsp;<span class="op" id="5831801">:=</span>&nbsp;<span class="ident" id="5831804">cr</span><span class="op" id="5831806">[</span><span class="num" id="5831807">4</span><span class="op" id="5831808">]</span><span class="op" id="5831809">[</span><span class="num" id="5831810">1</span><span class="op" id="5831811">:</span><span class="op" id="5831812">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5831815">pdat</span>&nbsp;<span class="op" id="5831820">:=</span>&nbsp;<span class="ident" id="5831823">pr</span><span class="op" id="5831825">[</span><span class="num" id="5831826">1</span><span class="op" id="5831827">:</span><span class="op" id="5831828">]</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5831831">n</span>&nbsp;<span class="op" id="5831833">:=</span>&nbsp;<span class="builtinfunc" id="5831836">len</span><span class="op" id="5831839">(</span><span class="ident" id="5831840">cdat0</span><span class="op" id="5831845">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5831849">//&nbsp;The&nbsp;up&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5831868">sum</span>&nbsp;<span class="op" id="5831872">:=</span>&nbsp;<span class="num" id="5831875">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5831878">for</span>&nbsp;<span class="ident" id="5831882">i</span>&nbsp;<span class="op" id="5831884">:=</span>&nbsp;<span class="num" id="5831887">0</span><span class="op" id="5831888">;</span>&nbsp;<span class="ident" id="5831890">i</span>&nbsp;<span class="op" id="5831892">&lt;</span>&nbsp;<span class="ident" id="5831894">n</span><span class="op" id="5831895">;</span>&nbsp;<span class="ident" id="5831897">i</span><span class="op" id="5831898">++</span>&nbsp;<span class="op" id="5831901">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5831905">cdat2</span><span class="op" id="5831910">[</span><span class="ident" id="5831911">i</span><span class="op" id="5831912">]</span>&nbsp;<span class="op" id="5831914">=</span>&nbsp;<span class="ident" id="5831916">cdat0</span><span class="op" id="5831921">[</span><span class="ident" id="5831922">i</span><span class="op" id="5831923">]</span>&nbsp;<span class="op" id="5831925">-</span>&nbsp;<span class="ident" id="5831927">pdat</span><span class="op" id="5831931">[</span><span class="ident" id="5831932">i</span><span class="op" id="5831933">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5831937">sum</span>&nbsp;<span class="op" id="5831941">+=</span>&nbsp;<span class="ident" id="5831944">abs8</span><span class="op" id="5831948">(</span><span class="ident" id="5831949">cdat2</span><span class="op" id="5831954">[</span><span class="ident" id="5831955">i</span><span class="op" id="5831956">]</span><span class="op" id="5831957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5831960">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5831963">best</span>&nbsp;<span class="op" id="5831968">:=</span>&nbsp;<span class="ident" id="5831971">sum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5831976">filter</span>&nbsp;<span class="op" id="5831983">:=</span>&nbsp;<span class="ident" id="5831986">ftUp</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5831993">//&nbsp;The&nbsp;Paeth&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5832015">sum</span>&nbsp;<span class="op" id="5832019">=</span>&nbsp;<span class="num" id="5832021">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5832024">for</span>&nbsp;<span class="ident" id="5832028">i</span>&nbsp;<span class="op" id="5832030">:=</span>&nbsp;<span class="num" id="5832033">0</span><span class="op" id="5832034">;</span>&nbsp;<span class="ident" id="5832036">i</span>&nbsp;<span class="op" id="5832038">&lt;</span>&nbsp;<span class="ident" id="5832040">bpp</span><span class="op" id="5832043">;</span>&nbsp;<span class="ident" id="5832045">i</span><span class="op" id="5832046">++</span>&nbsp;<span class="op" id="5832049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5832053">cdat4</span><span class="op" id="5832058">[</span><span class="ident" id="5832059">i</span><span class="op" id="5832060">]</span>&nbsp;<span class="op" id="5832062">=</span>&nbsp;<span class="ident" id="5832064">cdat0</span><span class="op" id="5832069">[</span><span class="ident" id="5832070">i</span><span class="op" id="5832071">]</span>&nbsp;<span class="op" id="5832073">-</span>&nbsp;<span class="ident" id="5832075">pdat</span><span class="op" id="5832079">[</span><span class="ident" id="5832080">i</span><span class="op" id="5832081">]</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5832085">sum</span>&nbsp;<span class="op" id="5832089">+=</span>&nbsp;<span class="ident" id="5832092">abs8</span><span class="op" id="5832096">(</span><span class="ident" id="5832097">cdat4</span><span class="op" id="5832102">[</span><span class="ident" id="5832103">i</span><span class="op" id="5832104">]</span><span class="op" id="5832105">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5832108">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5832111">for</span>&nbsp;<span class="ident" id="5832115">i</span>&nbsp;<span class="op" id="5832117">:=</span>&nbsp;<span class="ident" id="5832120">bpp</span><span class="op" id="5832123">;</span>&nbsp;<span class="ident" id="5832125">i</span>&nbsp;<span class="op" id="5832127">&lt;</span>&nbsp;<span class="ident" id="5832129">n</span><span class="op" id="5832130">;</span>&nbsp;<span class="ident" id="5832132">i</span><span class="op" id="5832133">++</span>&nbsp;<span class="op" id="5832136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5832140">cdat4</span><span class="op" id="5832145">[</span><span class="ident" id="5832146">i</span><span class="op" id="5832147">]</span>&nbsp;<span class="op" id="5832149">=</span>&nbsp;<span class="ident" id="5832151">cdat0</span><span class="op" id="5832156">[</span><span class="ident" id="5832157">i</span><span class="op" id="5832158">]</span>&nbsp;<span class="op" id="5832160">-</span>&nbsp;<span class="ident" id="5832162">paeth</span><span class="op" id="5832167">(</span><span class="ident" id="5832168">cdat0</span><span class="op" id="5832173">[</span><span class="ident" id="5832174">i</span><span class="op" id="5832175">-</span><span class="ident" id="5832176">bpp</span><span class="op" id="5832179">]</span><span class="op" id="5832180">,</span>&nbsp;<span class="ident" id="5832182">pdat</span><span class="op" id="5832186">[</span><span class="ident" id="5832187">i</span><span class="op" id="5832188">]</span><span class="op" id="5832189">,</span>&nbsp;<span class="ident" id="5832191">pdat</span><span class="op" id="5832195">[</span><span class="ident" id="5832196">i</span><span class="op" id="5832197">-</span><span class="ident" id="5832198">bpp</span><span class="op" id="5832201">]</span><span class="op" id="5832202">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5832206">sum</span>&nbsp;<span class="op" id="5832210">+=</span>&nbsp;<span class="ident" id="5832213">abs8</span><span class="op" id="5832217">(</span><span class="ident" id="5832218">cdat4</span><span class="op" id="5832223">[</span><span class="ident" id="5832224">i</span><span class="op" id="5832225">]</span><span class="op" id="5832226">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5832230">if</span>&nbsp;<span class="ident" id="5832233">sum</span>&nbsp;<span class="op" id="5832237">&gt;=</span>&nbsp;<span class="ident" id="5832240">best</span>&nbsp;<span class="op" id="5832245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5832250">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5832258">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5832261">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5832264">if</span>&nbsp;<span class="ident" id="5832267">sum</span>&nbsp;<span class="op" id="5832271">&lt;</span>&nbsp;<span class="ident" id="5832273">best</span>&nbsp;<span class="op" id="5832278">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5832282">best</span>&nbsp;<span class="op" id="5832287">=</span>&nbsp;<span class="ident" id="5832289">sum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5832295">filter</span>&nbsp;<span class="op" id="5832302">=</span>&nbsp;<span class="ident" id="5832304">ftPaeth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5832313">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5832317">//&nbsp;The&nbsp;none&nbsp;filter.</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5832338">sum</span>&nbsp;<span class="op" id="5832342">=</span>&nbsp;<span class="num" id="5832344">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5832347">for</span>&nbsp;<span class="ident" id="5832351">i</span>&nbsp;<span class="op" id="5832353">:=</span>&nbsp;<span class="num" id="5832356">0</span><span class="op" id="5832357">;</span>&nbsp;<span class="ident" id="5832359">i</span>&nbsp;<span class="op" id="5832361">&lt;</span>&nbsp;<span class="ident" id="5832363">n</span><span class="op" id="5832364">;</span>&nbsp;<span class="ident" id="5832366">i</span><span class="op" id="5832367">++</span>&nbsp;<span class="op" id="5832370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5832374">sum</span>&nbsp;<span class="op" id="5832378">+=</span>&nbsp;<span class="ident" id="5832381">abs8</span><span class="op" id="5832385">(</span><span class="ident" id="5832386">cdat0</span><span class="op" id="5832391">[</span><span class="ident" id="5832392">i</span><span class="op" id="5832393">]</span><span class="op" id="5832394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5832398">if</span>&nbsp;<span class="ident" id="5832401">sum</span>&nbsp;<span class="op" id="5832405">&gt;=</span>&nbsp;<span class="ident" id="5832408">best</span>&nbsp;<span class="op" id="5832413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5832418">break</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5832426">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5832429">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5832432">if</span>&nbsp;<span class="ident" id="5832435">sum</span>&nbsp;<span class="op" id="5832439">&lt;</span>&nbsp;<span class="ident" id="5832441">best</span>&nbsp;<span class="op" id="5832446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5832450">best</span>&nbsp;<span class="op" id="5832455">=</span>&nbsp;<span class="ident" id="5832457">sum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5832463">filter</span>&nbsp;<span class="op" id="5832470">=</span>&nbsp;<span class="ident" id="5832472">ftNone</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5832480">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5832484">//&nbsp;The&nbsp;sub&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5832504">sum</span>&nbsp;<span class="op" id="5832508">=</span>&nbsp;<span class="num" id="5832510">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5832513">for</span>&nbsp;<span class="ident" id="5832517">i</span>&nbsp;<span class="op" id="5832519">:=</span>&nbsp;<span class="num" id="5832522">0</span><span class="op" id="5832523">;</span>&nbsp;<span class="ident" id="5832525">i</span>&nbsp;<span class="op" id="5832527">&lt;</span>&nbsp;<span class="ident" id="5832529">bpp</span><span class="op" id="5832532">;</span>&nbsp;<span class="ident" id="5832534">i</span><span class="op" id="5832535">++</span>&nbsp;<span class="op" id="5832538">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5832542">cdat1</span><span class="op" id="5832547">[</span><span class="ident" id="5832548">i</span><span class="op" id="5832549">]</span>&nbsp;<span class="op" id="5832551">=</span>&nbsp;<span class="ident" id="5832553">cdat0</span><span class="op" id="5832558">[</span><span class="ident" id="5832559">i</span><span class="op" id="5832560">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5832564">sum</span>&nbsp;<span class="op" id="5832568">+=</span>&nbsp;<span class="ident" id="5832571">abs8</span><span class="op" id="5832575">(</span><span class="ident" id="5832576">cdat1</span><span class="op" id="5832581">[</span><span class="ident" id="5832582">i</span><span class="op" id="5832583">]</span><span class="op" id="5832584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5832587">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5832590">for</span>&nbsp;<span class="ident" id="5832594">i</span>&nbsp;<span class="op" id="5832596">:=</span>&nbsp;<span class="ident" id="5832599">bpp</span><span class="op" id="5832602">;</span>&nbsp;<span class="ident" id="5832604">i</span>&nbsp;<span class="op" id="5832606">&lt;</span>&nbsp;<span class="ident" id="5832608">n</span><span class="op" id="5832609">;</span>&nbsp;<span class="ident" id="5832611">i</span><span class="op" id="5832612">++</span>&nbsp;<span class="op" id="5832615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5832619">cdat1</span><span class="op" id="5832624">[</span><span class="ident" id="5832625">i</span><span class="op" id="5832626">]</span>&nbsp;<span class="op" id="5832628">=</span>&nbsp;<span class="ident" id="5832630">cdat0</span><span class="op" id="5832635">[</span><span class="ident" id="5832636">i</span><span class="op" id="5832637">]</span>&nbsp;<span class="op" id="5832639">-</span>&nbsp;<span class="ident" id="5832641">cdat0</span><span class="op" id="5832646">[</span><span class="ident" id="5832647">i</span><span class="op" id="5832648">-</span><span class="ident" id="5832649">bpp</span><span class="op" id="5832652">]</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5832656">sum</span>&nbsp;<span class="op" id="5832660">+=</span>&nbsp;<span class="ident" id="5832663">abs8</span><span class="op" id="5832667">(</span><span class="ident" id="5832668">cdat1</span><span class="op" id="5832673">[</span><span class="ident" id="5832674">i</span><span class="op" id="5832675">]</span><span class="op" id="5832676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5832680">if</span>&nbsp;<span class="ident" id="5832683">sum</span>&nbsp;<span class="op" id="5832687">&gt;=</span>&nbsp;<span class="ident" id="5832690">best</span>&nbsp;<span class="op" id="5832695">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5832700">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5832708">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5832711">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5832714">if</span>&nbsp;<span class="ident" id="5832717">sum</span>&nbsp;<span class="op" id="5832721">&lt;</span>&nbsp;<span class="ident" id="5832723">best</span>&nbsp;<span class="op" id="5832728">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5832732">best</span>&nbsp;<span class="op" id="5832737">=</span>&nbsp;<span class="ident" id="5832739">sum</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5832745">filter</span>&nbsp;<span class="op" id="5832752">=</span>&nbsp;<span class="ident" id="5832754">ftSub</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5832761">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5832765">//&nbsp;The&nbsp;average&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5832789">sum</span>&nbsp;<span class="op" id="5832793">=</span>&nbsp;<span class="num" id="5832795">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5832798">for</span>&nbsp;<span class="ident" id="5832802">i</span>&nbsp;<span class="op" id="5832804">:=</span>&nbsp;<span class="num" id="5832807">0</span><span class="op" id="5832808">;</span>&nbsp;<span class="ident" id="5832810">i</span>&nbsp;<span class="op" id="5832812">&lt;</span>&nbsp;<span class="ident" id="5832814">bpp</span><span class="op" id="5832817">;</span>&nbsp;<span class="ident" id="5832819">i</span><span class="op" id="5832820">++</span>&nbsp;<span class="op" id="5832823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5832827">cdat3</span><span class="op" id="5832832">[</span><span class="ident" id="5832833">i</span><span class="op" id="5832834">]</span>&nbsp;<span class="op" id="5832836">=</span>&nbsp;<span class="ident" id="5832838">cdat0</span><span class="op" id="5832843">[</span><span class="ident" id="5832844">i</span><span class="op" id="5832845">]</span>&nbsp;<span class="op" id="5832847">-</span>&nbsp;<span class="ident" id="5832849">pdat</span><span class="op" id="5832853">[</span><span class="ident" id="5832854">i</span><span class="op" id="5832855">]</span><span class="op" id="5832856">/</span><span class="num" id="5832857">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5832861">sum</span>&nbsp;<span class="op" id="5832865">+=</span>&nbsp;<span class="ident" id="5832868">abs8</span><span class="op" id="5832872">(</span><span class="ident" id="5832873">cdat3</span><span class="op" id="5832878">[</span><span class="ident" id="5832879">i</span><span class="op" id="5832880">]</span><span class="op" id="5832881">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5832884">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5832887">for</span>&nbsp;<span class="ident" id="5832891">i</span>&nbsp;<span class="op" id="5832893">:=</span>&nbsp;<span class="ident" id="5832896">bpp</span><span class="op" id="5832899">;</span>&nbsp;<span class="ident" id="5832901">i</span>&nbsp;<span class="op" id="5832903">&lt;</span>&nbsp;<span class="ident" id="5832905">n</span><span class="op" id="5832906">;</span>&nbsp;<span class="ident" id="5832908">i</span><span class="op" id="5832909">++</span>&nbsp;<span class="op" id="5832912">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5832916">cdat3</span><span class="op" id="5832921">[</span><span class="ident" id="5832922">i</span><span class="op" id="5832923">]</span>&nbsp;<span class="op" id="5832925">=</span>&nbsp;<span class="ident" id="5832927">cdat0</span><span class="op" id="5832932">[</span><span class="ident" id="5832933">i</span><span class="op" id="5832934">]</span>&nbsp;<span class="op" id="5832936">-</span>&nbsp;<span class="builtintype" id="5832938">uint8</span><span class="op" id="5832943">(</span><span class="op" id="5832944">(</span><span class="builtintype" id="5832945">int</span><span class="op" id="5832948">(</span><span class="ident" id="5832949">cdat0</span><span class="op" id="5832954">[</span><span class="ident" id="5832955">i</span><span class="op" id="5832956">-</span><span class="ident" id="5832957">bpp</span><span class="op" id="5832960">]</span><span class="op" id="5832961">)</span><span class="op" id="5832962">+</span><span class="builtintype" id="5832963">int</span><span class="op" id="5832966">(</span><span class="ident" id="5832967">pdat</span><span class="op" id="5832971">[</span><span class="ident" id="5832972">i</span><span class="op" id="5832973">]</span><span class="op" id="5832974">)</span><span class="op" id="5832975">)</span><span class="op" id="5832976">/</span><span class="num" id="5832977">2</span><span class="op" id="5832978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5832982">sum</span>&nbsp;<span class="op" id="5832986">+=</span>&nbsp;<span class="ident" id="5832989">abs8</span><span class="op" id="5832993">(</span><span class="ident" id="5832994">cdat3</span><span class="op" id="5832999">[</span><span class="ident" id="5833000">i</span><span class="op" id="5833001">]</span><span class="op" id="5833002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5833006">if</span>&nbsp;<span class="ident" id="5833009">sum</span>&nbsp;<span class="op" id="5833013">&gt;=</span>&nbsp;<span class="ident" id="5833016">best</span>&nbsp;<span class="op" id="5833021">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5833026">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5833034">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5833037">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5833040">if</span>&nbsp;<span class="ident" id="5833043">sum</span>&nbsp;<span class="op" id="5833047">&lt;</span>&nbsp;<span class="ident" id="5833049">best</span>&nbsp;<span class="op" id="5833054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5833058">best</span>&nbsp;<span class="op" id="5833063">=</span>&nbsp;<span class="ident" id="5833065">sum</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5833071">filter</span>&nbsp;<span class="op" id="5833078">=</span>&nbsp;<span class="ident" id="5833080">ftAverage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5833091">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5833095">return</span>&nbsp;<span class="ident" id="5833102">filter</span><br>
<span class="lineno"></span><span class="op" id="5833109">}</span><br>
<span class="lineno">275</span><br>
<span class="lineno"></span><span class="keyword" id="5833112">func</span>&nbsp;<span class="ident" id="5833117">writeImage</span><span class="op" id="5833127">(</span><span class="ident" id="5833128">w</span>&nbsp;<span class="ident" id="5833130">io</span><span class="op" id="5833132">.</span><span class="ident" id="5833133">Writer</span><span class="op" id="5833139">,</span>&nbsp;<span class="ident" id="5833141">m</span>&nbsp;<span class="ident" id="5833143">image</span><span class="op" id="5833148">.</span><span class="ident" id="5833149">Image</span><span class="op" id="5833154">,</span>&nbsp;<span class="ident" id="5833156">cb</span>&nbsp;<span class="builtintype" id="5833159">int</span><span class="op" id="5833162">,</span>&nbsp;<span class="ident" id="5833164">level</span>&nbsp;<span class="builtintype" id="5833170">int</span><span class="op" id="5833173">)</span>&nbsp;<span class="builtintype" id="5833175">error</span>&nbsp;<span class="op" id="5833181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5833184">zw</span><span class="op" id="5833186">,</span>&nbsp;<span class="ident" id="5833188">err</span>&nbsp;<span class="op" id="5833192">:=</span>&nbsp;<span class="ident" id="5833195">zlib</span><span class="op" id="5833199">.</span><span class="ident" id="5833200">NewWriterLevel</span><span class="op" id="5833214">(</span><span class="ident" id="5833215">w</span><span class="op" id="5833216">,</span>&nbsp;<span class="ident" id="5833218">level</span><span class="op" id="5833223">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5833226">if</span>&nbsp;<span class="ident" id="5833229">err</span>&nbsp;<span class="op" id="5833233">!=</span>&nbsp;<span class="ident" id="5833236">nil</span>&nbsp;<span class="op" id="5833240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5833244">return</span>&nbsp;<span class="ident" id="5833251">err</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5833256">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5833259">defer</span>&nbsp;<span class="ident" id="5833265">zw</span><span class="op" id="5833267">.</span><span class="ident" id="5833268">Close</span><span class="op" id="5833273">(</span><span class="op" id="5833274">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5833278">bpp</span>&nbsp;<span class="op" id="5833282">:=</span>&nbsp;<span class="num" id="5833285">0</span>&nbsp;<span class="comment" id="5833287">//&nbsp;Bytes&nbsp;per&nbsp;pixel.</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5833309">switch</span>&nbsp;<span class="ident" id="5833316">cb</span>&nbsp;<span class="op" id="5833319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5833322">case</span>&nbsp;<span class="ident" id="5833327">cbG8</span><span class="op" id="5833331">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5833335">bpp</span>&nbsp;<span class="op" id="5833339">=</span>&nbsp;<span class="num" id="5833341">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5833344">case</span>&nbsp;<span class="ident" id="5833349">cbTC8</span><span class="op" id="5833354">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5833358">bpp</span>&nbsp;<span class="op" id="5833362">=</span>&nbsp;<span class="num" id="5833364">3</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5833367">case</span>&nbsp;<span class="ident" id="5833372">cbP8</span><span class="op" id="5833376">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5833380">bpp</span>&nbsp;<span class="op" id="5833384">=</span>&nbsp;<span class="num" id="5833386">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5833389">case</span>&nbsp;<span class="ident" id="5833394">cbTCA8</span><span class="op" id="5833400">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5833404">bpp</span>&nbsp;<span class="op" id="5833408">=</span>&nbsp;<span class="num" id="5833410">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5833413">case</span>&nbsp;<span class="ident" id="5833418">cbTC16</span><span class="op" id="5833424">:</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5833428">bpp</span>&nbsp;<span class="op" id="5833432">=</span>&nbsp;<span class="num" id="5833434">6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5833437">case</span>&nbsp;<span class="ident" id="5833442">cbTCA16</span><span class="op" id="5833449">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5833453">bpp</span>&nbsp;<span class="op" id="5833457">=</span>&nbsp;<span class="num" id="5833459">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5833462">case</span>&nbsp;<span class="ident" id="5833467">cbG16</span><span class="op" id="5833472">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5833476">bpp</span>&nbsp;<span class="op" id="5833480">=</span>&nbsp;<span class="num" id="5833482">2</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5833485">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5833488">//&nbsp;cr[*]&nbsp;and&nbsp;pr&nbsp;are&nbsp;the&nbsp;bytes&nbsp;for&nbsp;the&nbsp;current&nbsp;and&nbsp;previous&nbsp;row.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5833553">//&nbsp;cr[0]&nbsp;is&nbsp;unfiltered&nbsp;(or&nbsp;equivalently,&nbsp;filtered&nbsp;with&nbsp;the&nbsp;ftNone&nbsp;filter).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5833629">//&nbsp;cr[ft],&nbsp;for&nbsp;non-zero&nbsp;filter&nbsp;types&nbsp;ft,&nbsp;are&nbsp;buffers&nbsp;for&nbsp;transforming&nbsp;cr[0]&nbsp;under&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5833716">//&nbsp;other&nbsp;PNG&nbsp;filter&nbsp;types.&nbsp;These&nbsp;buffers&nbsp;are&nbsp;allocated&nbsp;once&nbsp;and&nbsp;re-used&nbsp;for&nbsp;each&nbsp;row.</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5833803">//&nbsp;The&nbsp;+1&nbsp;is&nbsp;for&nbsp;the&nbsp;per-row&nbsp;filter&nbsp;type,&nbsp;which&nbsp;is&nbsp;at&nbsp;cr[*][0].</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5833868">b</span>&nbsp;<span class="op" id="5833870">:=</span>&nbsp;<span class="ident" id="5833873">m</span><span class="op" id="5833874">.</span><span class="ident" id="5833875">Bounds</span><span class="op" id="5833881">(</span><span class="op" id="5833882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5833885">var</span>&nbsp;<span class="ident" id="5833889">cr</span>&nbsp;<span class="op" id="5833892">[</span><span class="ident" id="5833893">nFilter</span><span class="op" id="5833900">]</span><span class="op" id="5833901">[</span><span class="op" id="5833902">]</span><span class="builtintype" id="5833903">uint8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5833910">for</span>&nbsp;<span class="ident" id="5833914">i</span>&nbsp;<span class="op" id="5833916">:=</span>&nbsp;<span class="keyword" id="5833919">range</span>&nbsp;<span class="ident" id="5833925">cr</span>&nbsp;<span class="op" id="5833928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5833932">cr</span><span class="op" id="5833934">[</span><span class="ident" id="5833935">i</span><span class="op" id="5833936">]</span>&nbsp;<span class="op" id="5833938">=</span>&nbsp;<span class="builtinfunc" id="5833940">make</span><span class="op" id="5833944">(</span><span class="op" id="5833945">[</span><span class="op" id="5833946">]</span><span class="builtintype" id="5833947">uint8</span><span class="op" id="5833952">,</span>&nbsp;<span class="num" id="5833954">1</span><span class="op" id="5833955">+</span><span class="ident" id="5833956">bpp</span><span class="op" id="5833959">*</span><span class="ident" id="5833960">b</span><span class="op" id="5833961">.</span><span class="ident" id="5833962">Dx</span><span class="op" id="5833964">(</span><span class="op" id="5833965">)</span><span class="op" id="5833966">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5833970">cr</span><span class="op" id="5833972">[</span><span class="ident" id="5833973">i</span><span class="op" id="5833974">]</span><span class="op" id="5833975">[</span><span class="num" id="5833976">0</span><span class="op" id="5833977">]</span>&nbsp;<span class="op" id="5833979">=</span>&nbsp;<span class="builtintype" id="5833981">uint8</span><span class="op" id="5833986">(</span><span class="ident" id="5833987">i</span><span class="op" id="5833988">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5833991">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5833994">pr</span>&nbsp;<span class="op" id="5833997">:=</span>&nbsp;<span class="builtinfunc" id="5834000">make</span><span class="op" id="5834004">(</span><span class="op" id="5834005">[</span><span class="op" id="5834006">]</span><span class="builtintype" id="5834007">uint8</span><span class="op" id="5834012">,</span>&nbsp;<span class="num" id="5834014">1</span><span class="op" id="5834015">+</span><span class="ident" id="5834016">bpp</span><span class="op" id="5834019">*</span><span class="ident" id="5834020">b</span><span class="op" id="5834021">.</span><span class="ident" id="5834022">Dx</span><span class="op" id="5834024">(</span><span class="op" id="5834025">)</span><span class="op" id="5834026">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5834030">gray</span><span class="op" id="5834034">,</span>&nbsp;<span class="ident" id="5834036">_</span>&nbsp;<span class="op" id="5834038">:=</span>&nbsp;<span class="ident" id="5834041">m</span><span class="op" id="5834042">.</span><span class="op" id="5834043">(</span><span class="op" id="5834044">*</span><span class="ident" id="5834045">image</span><span class="op" id="5834050">.</span><span class="ident" id="5834051">Gray</span><span class="op" id="5834055">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5834058">rgba</span><span class="op" id="5834062">,</span>&nbsp;<span class="ident" id="5834064">_</span>&nbsp;<span class="op" id="5834066">:=</span>&nbsp;<span class="ident" id="5834069">m</span><span class="op" id="5834070">.</span><span class="op" id="5834071">(</span><span class="op" id="5834072">*</span><span class="ident" id="5834073">image</span><span class="op" id="5834078">.</span><span class="ident" id="5834079">RGBA</span><span class="op" id="5834083">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5834086">paletted</span><span class="op" id="5834094">,</span>&nbsp;<span class="ident" id="5834096">_</span>&nbsp;<span class="op" id="5834098">:=</span>&nbsp;<span class="ident" id="5834101">m</span><span class="op" id="5834102">.</span><span class="op" id="5834103">(</span><span class="op" id="5834104">*</span><span class="ident" id="5834105">image</span><span class="op" id="5834110">.</span><span class="ident" id="5834111">Paletted</span><span class="op" id="5834119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5834122">nrgba</span><span class="op" id="5834127">,</span>&nbsp;<span class="ident" id="5834129">_</span>&nbsp;<span class="op" id="5834131">:=</span>&nbsp;<span class="ident" id="5834134">m</span><span class="op" id="5834135">.</span><span class="op" id="5834136">(</span><span class="op" id="5834137">*</span><span class="ident" id="5834138">image</span><span class="op" id="5834143">.</span><span class="ident" id="5834144">NRGBA</span><span class="op" id="5834149">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5834153">for</span>&nbsp;<span class="ident" id="5834157">y</span>&nbsp;<span class="op" id="5834159">:=</span>&nbsp;<span class="ident" id="5834162">b</span><span class="op" id="5834163">.</span><span class="ident" id="5834164">Min</span><span class="op" id="5834167">.</span><span class="ident" id="5834168">Y</span><span class="op" id="5834169">;</span>&nbsp;<span class="ident" id="5834171">y</span>&nbsp;<span class="op" id="5834173">&lt;</span>&nbsp;<span class="ident" id="5834175">b</span><span class="op" id="5834176">.</span><span class="ident" id="5834177">Max</span><span class="op" id="5834180">.</span><span class="ident" id="5834181">Y</span><span class="op" id="5834182">;</span>&nbsp;<span class="ident" id="5834184">y</span><span class="op" id="5834185">++</span>&nbsp;<span class="op" id="5834188">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5834192">//&nbsp;Convert&nbsp;from&nbsp;colors&nbsp;to&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5834227">i</span>&nbsp;<span class="op" id="5834229">:=</span>&nbsp;<span class="num" id="5834232">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5834236">switch</span>&nbsp;<span class="ident" id="5834243">cb</span>&nbsp;<span class="op" id="5834246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5834250">case</span>&nbsp;<span class="ident" id="5834255">cbG8</span><span class="op" id="5834259">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5834264">if</span>&nbsp;<span class="ident" id="5834267">gray</span>&nbsp;<span class="op" id="5834272">!=</span>&nbsp;<span class="ident" id="5834275">nil</span>&nbsp;<span class="op" id="5834279">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5834285">offset</span>&nbsp;<span class="op" id="5834292">:=</span>&nbsp;<span class="op" id="5834295">(</span><span class="ident" id="5834296">y</span>&nbsp;<span class="op" id="5834298">-</span>&nbsp;<span class="ident" id="5834300">b</span><span class="op" id="5834301">.</span><span class="ident" id="5834302">Min</span><span class="op" id="5834305">.</span><span class="ident" id="5834306">Y</span><span class="op" id="5834307">)</span>&nbsp;<span class="op" id="5834309">*</span>&nbsp;<span class="ident" id="5834311">gray</span><span class="op" id="5834315">.</span><span class="ident" id="5834316">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5834327">copy</span><span class="op" id="5834331">(</span><span class="ident" id="5834332">cr</span><span class="op" id="5834334">[</span><span class="num" id="5834335">0</span><span class="op" id="5834336">]</span><span class="op" id="5834337">[</span><span class="num" id="5834338">1</span><span class="op" id="5834339">:</span><span class="op" id="5834340">]</span><span class="op" id="5834341">,</span>&nbsp;<span class="ident" id="5834343">gray</span><span class="op" id="5834347">.</span><span class="ident" id="5834348">Pix</span><span class="op" id="5834351">[</span><span class="ident" id="5834352">offset</span><span class="op" id="5834358">:</span><span class="ident" id="5834359">offset</span><span class="op" id="5834365">+</span><span class="ident" id="5834366">b</span><span class="op" id="5834367">.</span><span class="ident" id="5834368">Dx</span><span class="op" id="5834370">(</span><span class="op" id="5834371">)</span><span class="op" id="5834372">]</span><span class="op" id="5834373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5834378">}</span>&nbsp;<span class="keyword" id="5834380">else</span>&nbsp;<span class="op" id="5834385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5834391">for</span>&nbsp;<span class="ident" id="5834395">x</span>&nbsp;<span class="op" id="5834397">:=</span>&nbsp;<span class="ident" id="5834400">b</span><span class="op" id="5834401">.</span><span class="ident" id="5834402">Min</span><span class="op" id="5834405">.</span><span class="ident" id="5834406">X</span><span class="op" id="5834407">;</span>&nbsp;<span class="ident" id="5834409">x</span>&nbsp;<span class="op" id="5834411">&lt;</span>&nbsp;<span class="ident" id="5834413">b</span><span class="op" id="5834414">.</span><span class="ident" id="5834415">Max</span><span class="op" id="5834418">.</span><span class="ident" id="5834419">X</span><span class="op" id="5834420">;</span>&nbsp;<span class="ident" id="5834422">x</span><span class="op" id="5834423">++</span>&nbsp;<span class="op" id="5834426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5834433">c</span>&nbsp;<span class="op" id="5834435">:=</span>&nbsp;<span class="ident" id="5834438">color</span><span class="op" id="5834443">.</span><span class="ident" id="5834444">GrayModel</span><span class="op" id="5834453">.</span><span class="ident" id="5834454">Convert</span><span class="op" id="5834461">(</span><span class="ident" id="5834462">m</span><span class="op" id="5834463">.</span><span class="ident" id="5834464">At</span><span class="op" id="5834466">(</span><span class="ident" id="5834467">x</span><span class="op" id="5834468">,</span>&nbsp;<span class="ident" id="5834470">y</span><span class="op" id="5834471">)</span><span class="op" id="5834472">)</span><span class="op" id="5834473">.</span><span class="op" id="5834474">(</span><span class="ident" id="5834475">color</span><span class="op" id="5834480">.</span><span class="ident" id="5834481">Gray</span><span class="op" id="5834485">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5834492">cr</span><span class="op" id="5834494">[</span><span class="num" id="5834495">0</span><span class="op" id="5834496">]</span><span class="op" id="5834497">[</span><span class="ident" id="5834498">i</span><span class="op" id="5834499">]</span>&nbsp;<span class="op" id="5834501">=</span>&nbsp;<span class="ident" id="5834503">c</span><span class="op" id="5834504">.</span><span class="ident" id="5834505">Y</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5834512">i</span><span class="op" id="5834513">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5834520">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5834525">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5834529">case</span>&nbsp;<span class="ident" id="5834534">cbTC8</span><span class="op" id="5834539">:</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5834544">//&nbsp;We&nbsp;have&nbsp;previously&nbsp;verified&nbsp;that&nbsp;the&nbsp;alpha&nbsp;value&nbsp;is&nbsp;fully&nbsp;opaque.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5834616">cr0</span>&nbsp;<span class="op" id="5834620">:=</span>&nbsp;<span class="ident" id="5834623">cr</span><span class="op" id="5834625">[</span><span class="num" id="5834626">0</span><span class="op" id="5834627">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5834632">stride</span><span class="op" id="5834638">,</span>&nbsp;<span class="ident" id="5834640">pix</span>&nbsp;<span class="op" id="5834644">:=</span>&nbsp;<span class="num" id="5834647">0</span><span class="op" id="5834648">,</span>&nbsp;<span class="op" id="5834650">[</span><span class="op" id="5834651">]</span><span class="builtintype" id="5834652">byte</span><span class="op" id="5834656">(</span><span class="ident" id="5834657">nil</span><span class="op" id="5834660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5834665">if</span>&nbsp;<span class="ident" id="5834668">rgba</span>&nbsp;<span class="op" id="5834673">!=</span>&nbsp;<span class="ident" id="5834676">nil</span>&nbsp;<span class="op" id="5834680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5834686">stride</span><span class="op" id="5834692">,</span>&nbsp;<span class="ident" id="5834694">pix</span>&nbsp;<span class="op" id="5834698">=</span>&nbsp;<span class="ident" id="5834700">rgba</span><span class="op" id="5834704">.</span><span class="ident" id="5834705">Stride</span><span class="op" id="5834711">,</span>&nbsp;<span class="ident" id="5834713">rgba</span><span class="op" id="5834717">.</span><span class="ident" id="5834718">Pix</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5834725">}</span>&nbsp;<span class="keyword" id="5834727">else</span>&nbsp;<span class="keyword" id="5834732">if</span>&nbsp;<span class="ident" id="5834735">nrgba</span>&nbsp;<span class="op" id="5834741">!=</span>&nbsp;<span class="ident" id="5834744">nil</span>&nbsp;<span class="op" id="5834748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5834754">stride</span><span class="op" id="5834760">,</span>&nbsp;<span class="ident" id="5834762">pix</span>&nbsp;<span class="op" id="5834766">=</span>&nbsp;<span class="ident" id="5834768">nrgba</span><span class="op" id="5834773">.</span><span class="ident" id="5834774">Stride</span><span class="op" id="5834780">,</span>&nbsp;<span class="ident" id="5834782">nrgba</span><span class="op" id="5834787">.</span><span class="ident" id="5834788">Pix</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5834795">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5834800">if</span>&nbsp;<span class="ident" id="5834803">stride</span>&nbsp;<span class="op" id="5834810">!=</span>&nbsp;<span class="num" id="5834813">0</span>&nbsp;<span class="op" id="5834815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5834821">j0</span>&nbsp;<span class="op" id="5834824">:=</span>&nbsp;<span class="op" id="5834827">(</span><span class="ident" id="5834828">y</span>&nbsp;<span class="op" id="5834830">-</span>&nbsp;<span class="ident" id="5834832">b</span><span class="op" id="5834833">.</span><span class="ident" id="5834834">Min</span><span class="op" id="5834837">.</span><span class="ident" id="5834838">Y</span><span class="op" id="5834839">)</span>&nbsp;<span class="op" id="5834841">*</span>&nbsp;<span class="ident" id="5834843">stride</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5834854">j1</span>&nbsp;<span class="op" id="5834857">:=</span>&nbsp;<span class="ident" id="5834860">j0</span>&nbsp;<span class="op" id="5834863">+</span>&nbsp;<span class="ident" id="5834865">b</span><span class="op" id="5834866">.</span><span class="ident" id="5834867">Dx</span><span class="op" id="5834869">(</span><span class="op" id="5834870">)</span><span class="op" id="5834871">*</span><span class="num" id="5834872">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5834878">for</span>&nbsp;<span class="ident" id="5834882">j</span>&nbsp;<span class="op" id="5834884">:=</span>&nbsp;<span class="ident" id="5834887">j0</span><span class="op" id="5834889">;</span>&nbsp;<span class="ident" id="5834891">j</span>&nbsp;<span class="op" id="5834893">&lt;</span>&nbsp;<span class="ident" id="5834895">j1</span><span class="op" id="5834897">;</span>&nbsp;<span class="ident" id="5834899">j</span>&nbsp;<span class="op" id="5834901">+=</span>&nbsp;<span class="num" id="5834904">4</span>&nbsp;<span class="op" id="5834906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5834913">cr0</span><span class="op" id="5834916">[</span><span class="ident" id="5834917">i</span><span class="op" id="5834918">+</span><span class="num" id="5834919">0</span><span class="op" id="5834920">]</span>&nbsp;<span class="op" id="5834922">=</span>&nbsp;<span class="ident" id="5834924">pix</span><span class="op" id="5834927">[</span><span class="ident" id="5834928">j</span><span class="op" id="5834929">+</span><span class="num" id="5834930">0</span><span class="op" id="5834931">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5834938">cr0</span><span class="op" id="5834941">[</span><span class="ident" id="5834942">i</span><span class="op" id="5834943">+</span><span class="num" id="5834944">1</span><span class="op" id="5834945">]</span>&nbsp;<span class="op" id="5834947">=</span>&nbsp;<span class="ident" id="5834949">pix</span><span class="op" id="5834952">[</span><span class="ident" id="5834953">j</span><span class="op" id="5834954">+</span><span class="num" id="5834955">1</span><span class="op" id="5834956">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5834963">cr0</span><span class="op" id="5834966">[</span><span class="ident" id="5834967">i</span><span class="op" id="5834968">+</span><span class="num" id="5834969">2</span><span class="op" id="5834970">]</span>&nbsp;<span class="op" id="5834972">=</span>&nbsp;<span class="ident" id="5834974">pix</span><span class="op" id="5834977">[</span><span class="ident" id="5834978">j</span><span class="op" id="5834979">+</span><span class="num" id="5834980">2</span><span class="op" id="5834981">]</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5834988">i</span>&nbsp;<span class="op" id="5834990">+=</span>&nbsp;<span class="num" id="5834993">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5834999">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5835004">}</span>&nbsp;<span class="keyword" id="5835006">else</span>&nbsp;<span class="op" id="5835011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5835017">for</span>&nbsp;<span class="ident" id="5835021">x</span>&nbsp;<span class="op" id="5835023">:=</span>&nbsp;<span class="ident" id="5835026">b</span><span class="op" id="5835027">.</span><span class="ident" id="5835028">Min</span><span class="op" id="5835031">.</span><span class="ident" id="5835032">X</span><span class="op" id="5835033">;</span>&nbsp;<span class="ident" id="5835035">x</span>&nbsp;<span class="op" id="5835037">&lt;</span>&nbsp;<span class="ident" id="5835039">b</span><span class="op" id="5835040">.</span><span class="ident" id="5835041">Max</span><span class="op" id="5835044">.</span><span class="ident" id="5835045">X</span><span class="op" id="5835046">;</span>&nbsp;<span class="ident" id="5835048">x</span><span class="op" id="5835049">++</span>&nbsp;<span class="op" id="5835052">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5835059">r</span><span class="op" id="5835060">,</span>&nbsp;<span class="ident" id="5835062">g</span><span class="op" id="5835063">,</span>&nbsp;<span class="ident" id="5835065">b</span><span class="op" id="5835066">,</span>&nbsp;<span class="ident" id="5835068">_</span>&nbsp;<span class="op" id="5835070">:=</span>&nbsp;<span class="ident" id="5835073">m</span><span class="op" id="5835074">.</span><span class="ident" id="5835075">At</span><span class="op" id="5835077">(</span><span class="ident" id="5835078">x</span><span class="op" id="5835079">,</span>&nbsp;<span class="ident" id="5835081">y</span><span class="op" id="5835082">)</span><span class="op" id="5835083">.</span><span class="ident" id="5835084">RGBA</span><span class="op" id="5835088">(</span><span class="op" id="5835089">)</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5835096">cr0</span><span class="op" id="5835099">[</span><span class="ident" id="5835100">i</span><span class="op" id="5835101">+</span><span class="num" id="5835102">0</span><span class="op" id="5835103">]</span>&nbsp;<span class="op" id="5835105">=</span>&nbsp;<span class="builtintype" id="5835107">uint8</span><span class="op" id="5835112">(</span><span class="ident" id="5835113">r</span>&nbsp;<span class="op" id="5835115">&gt;&gt;</span>&nbsp;<span class="num" id="5835118">8</span><span class="op" id="5835119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5835126">cr0</span><span class="op" id="5835129">[</span><span class="ident" id="5835130">i</span><span class="op" id="5835131">+</span><span class="num" id="5835132">1</span><span class="op" id="5835133">]</span>&nbsp;<span class="op" id="5835135">=</span>&nbsp;<span class="builtintype" id="5835137">uint8</span><span class="op" id="5835142">(</span><span class="ident" id="5835143">g</span>&nbsp;<span class="op" id="5835145">&gt;&gt;</span>&nbsp;<span class="num" id="5835148">8</span><span class="op" id="5835149">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5835156">cr0</span><span class="op" id="5835159">[</span><span class="ident" id="5835160">i</span><span class="op" id="5835161">+</span><span class="num" id="5835162">2</span><span class="op" id="5835163">]</span>&nbsp;<span class="op" id="5835165">=</span>&nbsp;<span class="builtintype" id="5835167">uint8</span><span class="op" id="5835172">(</span><span class="ident" id="5835173">b</span>&nbsp;<span class="op" id="5835175">&gt;&gt;</span>&nbsp;<span class="num" id="5835178">8</span><span class="op" id="5835179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5835186">i</span>&nbsp;<span class="op" id="5835188">+=</span>&nbsp;<span class="num" id="5835191">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5835197">}</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5835202">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5835206">case</span>&nbsp;<span class="ident" id="5835211">cbP8</span><span class="op" id="5835215">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5835220">if</span>&nbsp;<span class="ident" id="5835223">paletted</span>&nbsp;<span class="op" id="5835232">!=</span>&nbsp;<span class="ident" id="5835235">nil</span>&nbsp;<span class="op" id="5835239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5835245">offset</span>&nbsp;<span class="op" id="5835252">:=</span>&nbsp;<span class="op" id="5835255">(</span><span class="ident" id="5835256">y</span>&nbsp;<span class="op" id="5835258">-</span>&nbsp;<span class="ident" id="5835260">b</span><span class="op" id="5835261">.</span><span class="ident" id="5835262">Min</span><span class="op" id="5835265">.</span><span class="ident" id="5835266">Y</span><span class="op" id="5835267">)</span>&nbsp;<span class="op" id="5835269">*</span>&nbsp;<span class="ident" id="5835271">paletted</span><span class="op" id="5835279">.</span><span class="ident" id="5835280">Stride</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5835291">copy</span><span class="op" id="5835295">(</span><span class="ident" id="5835296">cr</span><span class="op" id="5835298">[</span><span class="num" id="5835299">0</span><span class="op" id="5835300">]</span><span class="op" id="5835301">[</span><span class="num" id="5835302">1</span><span class="op" id="5835303">:</span><span class="op" id="5835304">]</span><span class="op" id="5835305">,</span>&nbsp;<span class="ident" id="5835307">paletted</span><span class="op" id="5835315">.</span><span class="ident" id="5835316">Pix</span><span class="op" id="5835319">[</span><span class="ident" id="5835320">offset</span><span class="op" id="5835326">:</span><span class="ident" id="5835327">offset</span><span class="op" id="5835333">+</span><span class="ident" id="5835334">b</span><span class="op" id="5835335">.</span><span class="ident" id="5835336">Dx</span><span class="op" id="5835338">(</span><span class="op" id="5835339">)</span><span class="op" id="5835340">]</span><span class="op" id="5835341">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5835346">}</span>&nbsp;<span class="keyword" id="5835348">else</span>&nbsp;<span class="op" id="5835353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5835359">pi</span>&nbsp;<span class="op" id="5835362">:=</span>&nbsp;<span class="ident" id="5835365">m</span><span class="op" id="5835366">.</span><span class="op" id="5835367">(</span><span class="ident" id="5835368">image</span><span class="op" id="5835373">.</span><span class="ident" id="5835374">PalettedImage</span><span class="op" id="5835387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5835393">for</span>&nbsp;<span class="ident" id="5835397">x</span>&nbsp;<span class="op" id="5835399">:=</span>&nbsp;<span class="ident" id="5835402">b</span><span class="op" id="5835403">.</span><span class="ident" id="5835404">Min</span><span class="op" id="5835407">.</span><span class="ident" id="5835408">X</span><span class="op" id="5835409">;</span>&nbsp;<span class="ident" id="5835411">x</span>&nbsp;<span class="op" id="5835413">&lt;</span>&nbsp;<span class="ident" id="5835415">b</span><span class="op" id="5835416">.</span><span class="ident" id="5835417">Max</span><span class="op" id="5835420">.</span><span class="ident" id="5835421">X</span><span class="op" id="5835422">;</span>&nbsp;<span class="ident" id="5835424">x</span><span class="op" id="5835425">++</span>&nbsp;<span class="op" id="5835428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5835435">cr</span><span class="op" id="5835437">[</span><span class="num" id="5835438">0</span><span class="op" id="5835439">]</span><span class="op" id="5835440">[</span><span class="ident" id="5835441">i</span><span class="op" id="5835442">]</span>&nbsp;<span class="op" id="5835444">=</span>&nbsp;<span class="ident" id="5835446">pi</span><span class="op" id="5835448">.</span><span class="ident" id="5835449">ColorIndexAt</span><span class="op" id="5835461">(</span><span class="ident" id="5835462">x</span><span class="op" id="5835463">,</span>&nbsp;<span class="ident" id="5835465">y</span><span class="op" id="5835466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5835473">i</span>&nbsp;<span class="op" id="5835475">+=</span>&nbsp;<span class="num" id="5835478">1</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5835484">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5835489">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5835493">case</span>&nbsp;<span class="ident" id="5835498">cbTCA8</span><span class="op" id="5835504">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5835509">if</span>&nbsp;<span class="ident" id="5835512">nrgba</span>&nbsp;<span class="op" id="5835518">!=</span>&nbsp;<span class="ident" id="5835521">nil</span>&nbsp;<span class="op" id="5835525">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5835531">offset</span>&nbsp;<span class="op" id="5835538">:=</span>&nbsp;<span class="op" id="5835541">(</span><span class="ident" id="5835542">y</span>&nbsp;<span class="op" id="5835544">-</span>&nbsp;<span class="ident" id="5835546">b</span><span class="op" id="5835547">.</span><span class="ident" id="5835548">Min</span><span class="op" id="5835551">.</span><span class="ident" id="5835552">Y</span><span class="op" id="5835553">)</span>&nbsp;<span class="op" id="5835555">*</span>&nbsp;<span class="ident" id="5835557">nrgba</span><span class="op" id="5835562">.</span><span class="ident" id="5835563">Stride</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5835574">copy</span><span class="op" id="5835578">(</span><span class="ident" id="5835579">cr</span><span class="op" id="5835581">[</span><span class="num" id="5835582">0</span><span class="op" id="5835583">]</span><span class="op" id="5835584">[</span><span class="num" id="5835585">1</span><span class="op" id="5835586">:</span><span class="op" id="5835587">]</span><span class="op" id="5835588">,</span>&nbsp;<span class="ident" id="5835590">nrgba</span><span class="op" id="5835595">.</span><span class="ident" id="5835596">Pix</span><span class="op" id="5835599">[</span><span class="ident" id="5835600">offset</span><span class="op" id="5835606">:</span><span class="ident" id="5835607">offset</span><span class="op" id="5835613">+</span><span class="ident" id="5835614">b</span><span class="op" id="5835615">.</span><span class="ident" id="5835616">Dx</span><span class="op" id="5835618">(</span><span class="op" id="5835619">)</span><span class="op" id="5835620">*</span><span class="num" id="5835621">4</span><span class="op" id="5835622">]</span><span class="op" id="5835623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5835628">}</span>&nbsp;<span class="keyword" id="5835630">else</span>&nbsp;<span class="op" id="5835635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5835641">//&nbsp;Convert&nbsp;from&nbsp;image.Image&nbsp;(which&nbsp;is&nbsp;alpha-premultiplied)&nbsp;to&nbsp;PNG&#39;s&nbsp;non-alpha-premultiplied.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5835738">for</span>&nbsp;<span class="ident" id="5835742">x</span>&nbsp;<span class="op" id="5835744">:=</span>&nbsp;<span class="ident" id="5835747">b</span><span class="op" id="5835748">.</span><span class="ident" id="5835749">Min</span><span class="op" id="5835752">.</span><span class="ident" id="5835753">X</span><span class="op" id="5835754">;</span>&nbsp;<span class="ident" id="5835756">x</span>&nbsp;<span class="op" id="5835758">&lt;</span>&nbsp;<span class="ident" id="5835760">b</span><span class="op" id="5835761">.</span><span class="ident" id="5835762">Max</span><span class="op" id="5835765">.</span><span class="ident" id="5835766">X</span><span class="op" id="5835767">;</span>&nbsp;<span class="ident" id="5835769">x</span><span class="op" id="5835770">++</span>&nbsp;<span class="op" id="5835773">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5835780">c</span>&nbsp;<span class="op" id="5835782">:=</span>&nbsp;<span class="ident" id="5835785">color</span><span class="op" id="5835790">.</span><span class="ident" id="5835791">NRGBAModel</span><span class="op" id="5835801">.</span><span class="ident" id="5835802">Convert</span><span class="op" id="5835809">(</span><span class="ident" id="5835810">m</span><span class="op" id="5835811">.</span><span class="ident" id="5835812">At</span><span class="op" id="5835814">(</span><span class="ident" id="5835815">x</span><span class="op" id="5835816">,</span>&nbsp;<span class="ident" id="5835818">y</span><span class="op" id="5835819">)</span><span class="op" id="5835820">)</span><span class="op" id="5835821">.</span><span class="op" id="5835822">(</span><span class="ident" id="5835823">color</span><span class="op" id="5835828">.</span><span class="ident" id="5835829">NRGBA</span><span class="op" id="5835834">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5835841">cr</span><span class="op" id="5835843">[</span><span class="num" id="5835844">0</span><span class="op" id="5835845">]</span><span class="op" id="5835846">[</span><span class="ident" id="5835847">i</span><span class="op" id="5835848">+</span><span class="num" id="5835849">0</span><span class="op" id="5835850">]</span>&nbsp;<span class="op" id="5835852">=</span>&nbsp;<span class="ident" id="5835854">c</span><span class="op" id="5835855">.</span><span class="ident" id="5835856">R</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5835863">cr</span><span class="op" id="5835865">[</span><span class="num" id="5835866">0</span><span class="op" id="5835867">]</span><span class="op" id="5835868">[</span><span class="ident" id="5835869">i</span><span class="op" id="5835870">+</span><span class="num" id="5835871">1</span><span class="op" id="5835872">]</span>&nbsp;<span class="op" id="5835874">=</span>&nbsp;<span class="ident" id="5835876">c</span><span class="op" id="5835877">.</span><span class="ident" id="5835878">G</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5835885">cr</span><span class="op" id="5835887">[</span><span class="num" id="5835888">0</span><span class="op" id="5835889">]</span><span class="op" id="5835890">[</span><span class="ident" id="5835891">i</span><span class="op" id="5835892">+</span><span class="num" id="5835893">2</span><span class="op" id="5835894">]</span>&nbsp;<span class="op" id="5835896">=</span>&nbsp;<span class="ident" id="5835898">c</span><span class="op" id="5835899">.</span><span class="ident" id="5835900">B</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5835907">cr</span><span class="op" id="5835909">[</span><span class="num" id="5835910">0</span><span class="op" id="5835911">]</span><span class="op" id="5835912">[</span><span class="ident" id="5835913">i</span><span class="op" id="5835914">+</span><span class="num" id="5835915">3</span><span class="op" id="5835916">]</span>&nbsp;<span class="op" id="5835918">=</span>&nbsp;<span class="ident" id="5835920">c</span><span class="op" id="5835921">.</span><span class="ident" id="5835922">A</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5835929">i</span>&nbsp;<span class="op" id="5835931">+=</span>&nbsp;<span class="num" id="5835934">4</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5835940">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5835945">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5835949">case</span>&nbsp;<span class="ident" id="5835954">cbG16</span><span class="op" id="5835959">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5835964">for</span>&nbsp;<span class="ident" id="5835968">x</span>&nbsp;<span class="op" id="5835970">:=</span>&nbsp;<span class="ident" id="5835973">b</span><span class="op" id="5835974">.</span><span class="ident" id="5835975">Min</span><span class="op" id="5835978">.</span><span class="ident" id="5835979">X</span><span class="op" id="5835980">;</span>&nbsp;<span class="ident" id="5835982">x</span>&nbsp;<span class="op" id="5835984">&lt;</span>&nbsp;<span class="ident" id="5835986">b</span><span class="op" id="5835987">.</span><span class="ident" id="5835988">Max</span><span class="op" id="5835991">.</span><span class="ident" id="5835992">X</span><span class="op" id="5835993">;</span>&nbsp;<span class="ident" id="5835995">x</span><span class="op" id="5835996">++</span>&nbsp;<span class="op" id="5835999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5836005">c</span>&nbsp;<span class="op" id="5836007">:=</span>&nbsp;<span class="ident" id="5836010">color</span><span class="op" id="5836015">.</span><span class="ident" id="5836016">Gray16Model</span><span class="op" id="5836027">.</span><span class="ident" id="5836028">Convert</span><span class="op" id="5836035">(</span><span class="ident" id="5836036">m</span><span class="op" id="5836037">.</span><span class="ident" id="5836038">At</span><span class="op" id="5836040">(</span><span class="ident" id="5836041">x</span><span class="op" id="5836042">,</span>&nbsp;<span class="ident" id="5836044">y</span><span class="op" id="5836045">)</span><span class="op" id="5836046">)</span><span class="op" id="5836047">.</span><span class="op" id="5836048">(</span><span class="ident" id="5836049">color</span><span class="op" id="5836054">.</span><span class="ident" id="5836055">Gray16</span><span class="op" id="5836061">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5836067">cr</span><span class="op" id="5836069">[</span><span class="num" id="5836070">0</span><span class="op" id="5836071">]</span><span class="op" id="5836072">[</span><span class="ident" id="5836073">i</span><span class="op" id="5836074">+</span><span class="num" id="5836075">0</span><span class="op" id="5836076">]</span>&nbsp;<span class="op" id="5836078">=</span>&nbsp;<span class="builtintype" id="5836080">uint8</span><span class="op" id="5836085">(</span><span class="ident" id="5836086">c</span><span class="op" id="5836087">.</span><span class="ident" id="5836088">Y</span>&nbsp;<span class="op" id="5836090">&gt;&gt;</span>&nbsp;<span class="num" id="5836093">8</span><span class="op" id="5836094">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5836100">cr</span><span class="op" id="5836102">[</span><span class="num" id="5836103">0</span><span class="op" id="5836104">]</span><span class="op" id="5836105">[</span><span class="ident" id="5836106">i</span><span class="op" id="5836107">+</span><span class="num" id="5836108">1</span><span class="op" id="5836109">]</span>&nbsp;<span class="op" id="5836111">=</span>&nbsp;<span class="builtintype" id="5836113">uint8</span><span class="op" id="5836118">(</span><span class="ident" id="5836119">c</span><span class="op" id="5836120">.</span><span class="ident" id="5836121">Y</span><span class="op" id="5836122">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5836128">i</span>&nbsp;<span class="op" id="5836130">+=</span>&nbsp;<span class="num" id="5836133">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5836138">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5836142">case</span>&nbsp;<span class="ident" id="5836147">cbTC16</span><span class="op" id="5836153">:</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5836158">//&nbsp;We&nbsp;have&nbsp;previously&nbsp;verified&nbsp;that&nbsp;the&nbsp;alpha&nbsp;value&nbsp;is&nbsp;fully&nbsp;opaque.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5836230">for</span>&nbsp;<span class="ident" id="5836234">x</span>&nbsp;<span class="op" id="5836236">:=</span>&nbsp;<span class="ident" id="5836239">b</span><span class="op" id="5836240">.</span><span class="ident" id="5836241">Min</span><span class="op" id="5836244">.</span><span class="ident" id="5836245">X</span><span class="op" id="5836246">;</span>&nbsp;<span class="ident" id="5836248">x</span>&nbsp;<span class="op" id="5836250">&lt;</span>&nbsp;<span class="ident" id="5836252">b</span><span class="op" id="5836253">.</span><span class="ident" id="5836254">Max</span><span class="op" id="5836257">.</span><span class="ident" id="5836258">X</span><span class="op" id="5836259">;</span>&nbsp;<span class="ident" id="5836261">x</span><span class="op" id="5836262">++</span>&nbsp;<span class="op" id="5836265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5836271">r</span><span class="op" id="5836272">,</span>&nbsp;<span class="ident" id="5836274">g</span><span class="op" id="5836275">,</span>&nbsp;<span class="ident" id="5836277">b</span><span class="op" id="5836278">,</span>&nbsp;<span class="ident" id="5836280">_</span>&nbsp;<span class="op" id="5836282">:=</span>&nbsp;<span class="ident" id="5836285">m</span><span class="op" id="5836286">.</span><span class="ident" id="5836287">At</span><span class="op" id="5836289">(</span><span class="ident" id="5836290">x</span><span class="op" id="5836291">,</span>&nbsp;<span class="ident" id="5836293">y</span><span class="op" id="5836294">)</span><span class="op" id="5836295">.</span><span class="ident" id="5836296">RGBA</span><span class="op" id="5836300">(</span><span class="op" id="5836301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5836307">cr</span><span class="op" id="5836309">[</span><span class="num" id="5836310">0</span><span class="op" id="5836311">]</span><span class="op" id="5836312">[</span><span class="ident" id="5836313">i</span><span class="op" id="5836314">+</span><span class="num" id="5836315">0</span><span class="op" id="5836316">]</span>&nbsp;<span class="op" id="5836318">=</span>&nbsp;<span class="builtintype" id="5836320">uint8</span><span class="op" id="5836325">(</span><span class="ident" id="5836326">r</span>&nbsp;<span class="op" id="5836328">&gt;&gt;</span>&nbsp;<span class="num" id="5836331">8</span><span class="op" id="5836332">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5836338">cr</span><span class="op" id="5836340">[</span><span class="num" id="5836341">0</span><span class="op" id="5836342">]</span><span class="op" id="5836343">[</span><span class="ident" id="5836344">i</span><span class="op" id="5836345">+</span><span class="num" id="5836346">1</span><span class="op" id="5836347">]</span>&nbsp;<span class="op" id="5836349">=</span>&nbsp;<span class="builtintype" id="5836351">uint8</span><span class="op" id="5836356">(</span><span class="ident" id="5836357">r</span><span class="op" id="5836358">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5836364">cr</span><span class="op" id="5836366">[</span><span class="num" id="5836367">0</span><span class="op" id="5836368">]</span><span class="op" id="5836369">[</span><span class="ident" id="5836370">i</span><span class="op" id="5836371">+</span><span class="num" id="5836372">2</span><span class="op" id="5836373">]</span>&nbsp;<span class="op" id="5836375">=</span>&nbsp;<span class="builtintype" id="5836377">uint8</span><span class="op" id="5836382">(</span><span class="ident" id="5836383">g</span>&nbsp;<span class="op" id="5836385">&gt;&gt;</span>&nbsp;<span class="num" id="5836388">8</span><span class="op" id="5836389">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5836395">cr</span><span class="op" id="5836397">[</span><span class="num" id="5836398">0</span><span class="op" id="5836399">]</span><span class="op" id="5836400">[</span><span class="ident" id="5836401">i</span><span class="op" id="5836402">+</span><span class="num" id="5836403">3</span><span class="op" id="5836404">]</span>&nbsp;<span class="op" id="5836406">=</span>&nbsp;<span class="builtintype" id="5836408">uint8</span><span class="op" id="5836413">(</span><span class="ident" id="5836414">g</span><span class="op" id="5836415">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5836421">cr</span><span class="op" id="5836423">[</span><span class="num" id="5836424">0</span><span class="op" id="5836425">]</span><span class="op" id="5836426">[</span><span class="ident" id="5836427">i</span><span class="op" id="5836428">+</span><span class="num" id="5836429">4</span><span class="op" id="5836430">]</span>&nbsp;<span class="op" id="5836432">=</span>&nbsp;<span class="builtintype" id="5836434">uint8</span><span class="op" id="5836439">(</span><span class="ident" id="5836440">b</span>&nbsp;<span class="op" id="5836442">&gt;&gt;</span>&nbsp;<span class="num" id="5836445">8</span><span class="op" id="5836446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5836452">cr</span><span class="op" id="5836454">[</span><span class="num" id="5836455">0</span><span class="op" id="5836456">]</span><span class="op" id="5836457">[</span><span class="ident" id="5836458">i</span><span class="op" id="5836459">+</span><span class="num" id="5836460">5</span><span class="op" id="5836461">]</span>&nbsp;<span class="op" id="5836463">=</span>&nbsp;<span class="builtintype" id="5836465">uint8</span><span class="op" id="5836470">(</span><span class="ident" id="5836471">b</span><span class="op" id="5836472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5836478">i</span>&nbsp;<span class="op" id="5836480">+=</span>&nbsp;<span class="num" id="5836483">6</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5836488">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5836492">case</span>&nbsp;<span class="ident" id="5836497">cbTCA16</span><span class="op" id="5836504">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5836509">//&nbsp;Convert&nbsp;from&nbsp;image.Image&nbsp;(which&nbsp;is&nbsp;alpha-premultiplied)&nbsp;to&nbsp;PNG&#39;s&nbsp;non-alpha-premultiplied.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5836605">for</span>&nbsp;<span class="ident" id="5836609">x</span>&nbsp;<span class="op" id="5836611">:=</span>&nbsp;<span class="ident" id="5836614">b</span><span class="op" id="5836615">.</span><span class="ident" id="5836616">Min</span><span class="op" id="5836619">.</span><span class="ident" id="5836620">X</span><span class="op" id="5836621">;</span>&nbsp;<span class="ident" id="5836623">x</span>&nbsp;<span class="op" id="5836625">&lt;</span>&nbsp;<span class="ident" id="5836627">b</span><span class="op" id="5836628">.</span><span class="ident" id="5836629">Max</span><span class="op" id="5836632">.</span><span class="ident" id="5836633">X</span><span class="op" id="5836634">;</span>&nbsp;<span class="ident" id="5836636">x</span><span class="op" id="5836637">++</span>&nbsp;<span class="op" id="5836640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5836646">c</span>&nbsp;<span class="op" id="5836648">:=</span>&nbsp;<span class="ident" id="5836651">color</span><span class="op" id="5836656">.</span><span class="ident" id="5836657">NRGBA64Model</span><span class="op" id="5836669">.</span><span class="ident" id="5836670">Convert</span><span class="op" id="5836677">(</span><span class="ident" id="5836678">m</span><span class="op" id="5836679">.</span><span class="ident" id="5836680">At</span><span class="op" id="5836682">(</span><span class="ident" id="5836683">x</span><span class="op" id="5836684">,</span>&nbsp;<span class="ident" id="5836686">y</span><span class="op" id="5836687">)</span><span class="op" id="5836688">)</span><span class="op" id="5836689">.</span><span class="op" id="5836690">(</span><span class="ident" id="5836691">color</span><span class="op" id="5836696">.</span><span class="ident" id="5836697">NRGBA64</span><span class="op" id="5836704">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5836710">cr</span><span class="op" id="5836712">[</span><span class="num" id="5836713">0</span><span class="op" id="5836714">]</span><span class="op" id="5836715">[</span><span class="ident" id="5836716">i</span><span class="op" id="5836717">+</span><span class="num" id="5836718">0</span><span class="op" id="5836719">]</span>&nbsp;<span class="op" id="5836721">=</span>&nbsp;<span class="builtintype" id="5836723">uint8</span><span class="op" id="5836728">(</span><span class="ident" id="5836729">c</span><span class="op" id="5836730">.</span><span class="ident" id="5836731">R</span>&nbsp;<span class="op" id="5836733">&gt;&gt;</span>&nbsp;<span class="num" id="5836736">8</span><span class="op" id="5836737">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5836743">cr</span><span class="op" id="5836745">[</span><span class="num" id="5836746">0</span><span class="op" id="5836747">]</span><span class="op" id="5836748">[</span><span class="ident" id="5836749">i</span><span class="op" id="5836750">+</span><span class="num" id="5836751">1</span><span class="op" id="5836752">]</span>&nbsp;<span class="op" id="5836754">=</span>&nbsp;<span class="builtintype" id="5836756">uint8</span><span class="op" id="5836761">(</span><span class="ident" id="5836762">c</span><span class="op" id="5836763">.</span><span class="ident" id="5836764">R</span><span class="op" id="5836765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5836771">cr</span><span class="op" id="5836773">[</span><span class="num" id="5836774">0</span><span class="op" id="5836775">]</span><span class="op" id="5836776">[</span><span class="ident" id="5836777">i</span><span class="op" id="5836778">+</span><span class="num" id="5836779">2</span><span class="op" id="5836780">]</span>&nbsp;<span class="op" id="5836782">=</span>&nbsp;<span class="builtintype" id="5836784">uint8</span><span class="op" id="5836789">(</span><span class="ident" id="5836790">c</span><span class="op" id="5836791">.</span><span class="ident" id="5836792">G</span>&nbsp;<span class="op" id="5836794">&gt;&gt;</span>&nbsp;<span class="num" id="5836797">8</span><span class="op" id="5836798">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5836804">cr</span><span class="op" id="5836806">[</span><span class="num" id="5836807">0</span><span class="op" id="5836808">]</span><span class="op" id="5836809">[</span><span class="ident" id="5836810">i</span><span class="op" id="5836811">+</span><span class="num" id="5836812">3</span><span class="op" id="5836813">]</span>&nbsp;<span class="op" id="5836815">=</span>&nbsp;<span class="builtintype" id="5836817">uint8</span><span class="op" id="5836822">(</span><span class="ident" id="5836823">c</span><span class="op" id="5836824">.</span><span class="ident" id="5836825">G</span><span class="op" id="5836826">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5836832">cr</span><span class="op" id="5836834">[</span><span class="num" id="5836835">0</span><span class="op" id="5836836">]</span><span class="op" id="5836837">[</span><span class="ident" id="5836838">i</span><span class="op" id="5836839">+</span><span class="num" id="5836840">4</span><span class="op" id="5836841">]</span>&nbsp;<span class="op" id="5836843">=</span>&nbsp;<span class="builtintype" id="5836845">uint8</span><span class="op" id="5836850">(</span><span class="ident" id="5836851">c</span><span class="op" id="5836852">.</span><span class="ident" id="5836853">B</span>&nbsp;<span class="op" id="5836855">&gt;&gt;</span>&nbsp;<span class="num" id="5836858">8</span><span class="op" id="5836859">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5836865">cr</span><span class="op" id="5836867">[</span><span class="num" id="5836868">0</span><span class="op" id="5836869">]</span><span class="op" id="5836870">[</span><span class="ident" id="5836871">i</span><span class="op" id="5836872">+</span><span class="num" id="5836873">5</span><span class="op" id="5836874">]</span>&nbsp;<span class="op" id="5836876">=</span>&nbsp;<span class="builtintype" id="5836878">uint8</span><span class="op" id="5836883">(</span><span class="ident" id="5836884">c</span><span class="op" id="5836885">.</span><span class="ident" id="5836886">B</span><span class="op" id="5836887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5836893">cr</span><span class="op" id="5836895">[</span><span class="num" id="5836896">0</span><span class="op" id="5836897">]</span><span class="op" id="5836898">[</span><span class="ident" id="5836899">i</span><span class="op" id="5836900">+</span><span class="num" id="5836901">6</span><span class="op" id="5836902">]</span>&nbsp;<span class="op" id="5836904">=</span>&nbsp;<span class="builtintype" id="5836906">uint8</span><span class="op" id="5836911">(</span><span class="ident" id="5836912">c</span><span class="op" id="5836913">.</span><span class="ident" id="5836914">A</span>&nbsp;<span class="op" id="5836916">&gt;&gt;</span>&nbsp;<span class="num" id="5836919">8</span><span class="op" id="5836920">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5836926">cr</span><span class="op" id="5836928">[</span><span class="num" id="5836929">0</span><span class="op" id="5836930">]</span><span class="op" id="5836931">[</span><span class="ident" id="5836932">i</span><span class="op" id="5836933">+</span><span class="num" id="5836934">7</span><span class="op" id="5836935">]</span>&nbsp;<span class="op" id="5836937">=</span>&nbsp;<span class="builtintype" id="5836939">uint8</span><span class="op" id="5836944">(</span><span class="ident" id="5836945">c</span><span class="op" id="5836946">.</span><span class="ident" id="5836947">A</span><span class="op" id="5836948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5836954">i</span>&nbsp;<span class="op" id="5836956">+=</span>&nbsp;<span class="num" id="5836959">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5836964">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5836968">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5836973">//&nbsp;Apply&nbsp;the&nbsp;filter.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5836996">f</span>&nbsp;<span class="op" id="5836998">:=</span>&nbsp;<span class="ident" id="5837001">ftNone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5837010">if</span>&nbsp;<span class="ident" id="5837013">level</span>&nbsp;<span class="op" id="5837019">!=</span>&nbsp;<span class="ident" id="5837022">zlib</span><span class="op" id="5837026">.</span><span class="ident" id="5837027">NoCompression</span>&nbsp;<span class="op" id="5837041">{</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5837046">f</span>&nbsp;<span class="op" id="5837048">=</span>&nbsp;<span class="ident" id="5837050">filter</span><span class="op" id="5837056">(</span><span class="op" id="5837057">&amp;</span><span class="ident" id="5837058">cr</span><span class="op" id="5837060">,</span>&nbsp;<span class="ident" id="5837062">pr</span><span class="op" id="5837064">,</span>&nbsp;<span class="ident" id="5837066">bpp</span><span class="op" id="5837069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5837073">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5837078">//&nbsp;Write&nbsp;the&nbsp;compressed&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5837111">if</span>&nbsp;<span class="ident" id="5837114">_</span><span class="op" id="5837115">,</span>&nbsp;<span class="ident" id="5837117">err</span>&nbsp;<span class="op" id="5837121">:=</span>&nbsp;<span class="ident" id="5837124">zw</span><span class="op" id="5837126">.</span><span class="ident" id="5837127">Write</span><span class="op" id="5837132">(</span><span class="ident" id="5837133">cr</span><span class="op" id="5837135">[</span><span class="ident" id="5837136">f</span><span class="op" id="5837137">]</span><span class="op" id="5837138">)</span><span class="op" id="5837139">;</span>&nbsp;<span class="ident" id="5837141">err</span>&nbsp;<span class="op" id="5837145">!=</span>&nbsp;<span class="ident" id="5837148">nil</span>&nbsp;<span class="op" id="5837152">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5837157">return</span>&nbsp;<span class="ident" id="5837164">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5837170">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5837175">//&nbsp;The&nbsp;current&nbsp;row&nbsp;for&nbsp;y&nbsp;is&nbsp;the&nbsp;previous&nbsp;row&nbsp;for&nbsp;y+1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5837231">pr</span><span class="op" id="5837233">,</span>&nbsp;<span class="ident" id="5837235">cr</span><span class="op" id="5837237">[</span><span class="num" id="5837238">0</span><span class="op" id="5837239">]</span>&nbsp;<span class="op" id="5837241">=</span>&nbsp;<span class="ident" id="5837243">cr</span><span class="op" id="5837245">[</span><span class="num" id="5837246">0</span><span class="op" id="5837247">]</span><span class="op" id="5837248">,</span>&nbsp;<span class="ident" id="5837250">pr</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5837254">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5837257">return</span>&nbsp;<span class="ident" id="5837264">nil</span><br>
<span class="lineno"></span><span class="op" id="5837268">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5837271">//&nbsp;Write&nbsp;the&nbsp;actual&nbsp;image&nbsp;data&nbsp;to&nbsp;one&nbsp;or&nbsp;more&nbsp;IDAT&nbsp;chunks.</span><br>
<span class="lineno">440</span><span class="keyword" id="5837330">func</span>&nbsp;<span class="op" id="5837335">(</span><span class="ident" id="5837336">e</span>&nbsp;<span class="op" id="5837338">*</span><span class="ident" id="5837339">encoder</span><span class="op" id="5837346">)</span>&nbsp;<span class="ident" id="5837348">writeIDATs</span><span class="op" id="5837358">(</span><span class="op" id="5837359">)</span>&nbsp;<span class="op" id="5837361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5837364">if</span>&nbsp;<span class="ident" id="5837367">e</span><span class="op" id="5837368">.</span><span class="ident" id="5837369">err</span>&nbsp;<span class="op" id="5837373">!=</span>&nbsp;<span class="ident" id="5837376">nil</span>&nbsp;<span class="op" id="5837380">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5837384">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5837392">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5837395">var</span>&nbsp;<span class="ident" id="5837399">bw</span>&nbsp;<span class="op" id="5837402">*</span><span class="ident" id="5837403">bufio</span><span class="op" id="5837408">.</span><span class="ident" id="5837409">Writer</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5837417">bw</span>&nbsp;<span class="op" id="5837420">=</span>&nbsp;<span class="ident" id="5837422">bufio</span><span class="op" id="5837427">.</span><span class="ident" id="5837428">NewWriterSize</span><span class="op" id="5837441">(</span><span class="ident" id="5837442">e</span><span class="op" id="5837443">,</span>&nbsp;<span class="num" id="5837445">1</span><span class="op" id="5837446">&lt;&lt;</span><span class="num" id="5837448">15</span><span class="op" id="5837450">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5837453">e</span><span class="op" id="5837454">.</span><span class="ident" id="5837455">err</span>&nbsp;<span class="op" id="5837459">=</span>&nbsp;<span class="ident" id="5837461">writeImage</span><span class="op" id="5837471">(</span><span class="ident" id="5837472">bw</span><span class="op" id="5837474">,</span>&nbsp;<span class="ident" id="5837476">e</span><span class="op" id="5837477">.</span><span class="ident" id="5837478">m</span><span class="op" id="5837479">,</span>&nbsp;<span class="ident" id="5837481">e</span><span class="op" id="5837482">.</span><span class="ident" id="5837483">cb</span><span class="op" id="5837485">,</span>&nbsp;<span class="ident" id="5837487">levelToZlib</span><span class="op" id="5837498">(</span><span class="ident" id="5837499">e</span><span class="op" id="5837500">.</span><span class="ident" id="5837501">enc</span><span class="op" id="5837504">.</span><span class="ident" id="5837505">CompressionLevel</span><span class="op" id="5837521">)</span><span class="op" id="5837522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5837525">if</span>&nbsp;<span class="ident" id="5837528">e</span><span class="op" id="5837529">.</span><span class="ident" id="5837530">err</span>&nbsp;<span class="op" id="5837534">!=</span>&nbsp;<span class="ident" id="5837537">nil</span>&nbsp;<span class="op" id="5837541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5837545">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5837553">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5837556">e</span><span class="op" id="5837557">.</span><span class="ident" id="5837558">err</span>&nbsp;<span class="op" id="5837562">=</span>&nbsp;<span class="ident" id="5837564">bw</span><span class="op" id="5837566">.</span><span class="ident" id="5837567">Flush</span><span class="op" id="5837572">(</span><span class="op" id="5837573">)</span><br>
<span class="lineno"></span><span class="op" id="5837575">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5837578">//&nbsp;This&nbsp;function&nbsp;is&nbsp;required&nbsp;because&nbsp;we&nbsp;want&nbsp;the&nbsp;zero&nbsp;value&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="5837641">//&nbsp;Encoder.CompressionLevel&nbsp;to&nbsp;map&nbsp;to&nbsp;zlib.DefaultCompression.</span><br>
<span class="lineno">455</span><span class="keyword" id="5837704">func</span>&nbsp;<span class="ident" id="5837709">levelToZlib</span><span class="op" id="5837720">(</span><span class="ident" id="5837721">l</span>&nbsp;<span class="ident" id="5837723">CompressionLevel</span><span class="op" id="5837739">)</span>&nbsp;<span class="builtintype" id="5837741">int</span>&nbsp;<span class="op" id="5837745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5837748">switch</span>&nbsp;<span class="ident" id="5837755">l</span>&nbsp;<span class="op" id="5837757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5837760">case</span>&nbsp;<span class="ident" id="5837765">DefaultCompression</span><span class="op" id="5837783">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5837787">return</span>&nbsp;<span class="ident" id="5837794">zlib</span><span class="op" id="5837798">.</span><span class="ident" id="5837799">DefaultCompression</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5837819">case</span>&nbsp;<span class="ident" id="5837824">NoCompression</span><span class="op" id="5837837">:</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5837841">return</span>&nbsp;<span class="ident" id="5837848">zlib</span><span class="op" id="5837852">.</span><span class="ident" id="5837853">NoCompression</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5837868">case</span>&nbsp;<span class="ident" id="5837873">BestSpeed</span><span class="op" id="5837882">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5837886">return</span>&nbsp;<span class="ident" id="5837893">zlib</span><span class="op" id="5837897">.</span><span class="ident" id="5837898">BestSpeed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5837909">case</span>&nbsp;<span class="ident" id="5837914">BestCompression</span><span class="op" id="5837929">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5837933">return</span>&nbsp;<span class="ident" id="5837940">zlib</span><span class="op" id="5837944">.</span><span class="ident" id="5837945">BestCompression</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5837962">default</span><span class="op" id="5837969">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5837973">return</span>&nbsp;<span class="ident" id="5837980">zlib</span><span class="op" id="5837984">.</span><span class="ident" id="5837985">DefaultCompression</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5838005">}</span><br>
<span class="lineno"></span><span class="op" id="5838007">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">470</span><span class="keyword" id="5838010">func</span>&nbsp;<span class="op" id="5838015">(</span><span class="ident" id="5838016">e</span>&nbsp;<span class="op" id="5838018">*</span><span class="ident" id="5838019">encoder</span><span class="op" id="5838026">)</span>&nbsp;<span class="ident" id="5838028">writeIEND</span><span class="op" id="5838037">(</span><span class="op" id="5838038">)</span>&nbsp;<span class="op" id="5838040">{</span>&nbsp;<span class="ident" id="5838042">e</span><span class="op" id="5838043">.</span><span class="ident" id="5838044">writeChunk</span><span class="op" id="5838054">(</span><span class="ident" id="5838055">nil</span><span class="op" id="5838058">,</span>&nbsp;<span class="string" id="5838060">&#34;IEND&#34;</span><span class="op" id="5838066">)</span>&nbsp;<span class="op" id="5838068">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5838071">//&nbsp;Encode&nbsp;writes&nbsp;the&nbsp;Image&nbsp;m&nbsp;to&nbsp;w&nbsp;in&nbsp;PNG&nbsp;format.&nbsp;Any&nbsp;Image&nbsp;may&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="5838137">//&nbsp;encoded,&nbsp;but&nbsp;images&nbsp;that&nbsp;are&nbsp;not&nbsp;image.NRGBA&nbsp;might&nbsp;be&nbsp;encoded&nbsp;lossily.</span><br>
<span class="lineno"></span><span class="keyword" id="5838211">func</span>&nbsp;<span class="ident" id="5838216">Encode</span><span class="op" id="5838222">(</span><span class="ident" id="5838223">w</span>&nbsp;<span class="ident" id="5838225">io</span><span class="op" id="5838227">.</span><span class="ident" id="5838228">Writer</span><span class="op" id="5838234">,</span>&nbsp;<span class="ident" id="5838236">m</span>&nbsp;<span class="ident" id="5838238">image</span><span class="op" id="5838243">.</span><span class="ident" id="5838244">Image</span><span class="op" id="5838249">)</span>&nbsp;<span class="builtintype" id="5838251">error</span>&nbsp;<span class="op" id="5838257">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5838260">var</span>&nbsp;<span class="ident" id="5838264">e</span>&nbsp;<span class="ident" id="5838266">Encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5838275">return</span>&nbsp;<span class="ident" id="5838282">e</span><span class="op" id="5838283">.</span><span class="ident" id="5838284">Encode</span><span class="op" id="5838290">(</span><span class="ident" id="5838291">w</span><span class="op" id="5838292">,</span>&nbsp;<span class="ident" id="5838294">m</span><span class="op" id="5838295">)</span><br>
<span class="lineno"></span><span class="op" id="5838297">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5838300">//&nbsp;Encode&nbsp;writes&nbsp;the&nbsp;Image&nbsp;m&nbsp;to&nbsp;w&nbsp;in&nbsp;PNG&nbsp;format.</span><br>
<span class="lineno">480</span><span class="keyword" id="5838349">func</span>&nbsp;<span class="op" id="5838354">(</span><span class="ident" id="5838355">enc</span>&nbsp;<span class="op" id="5838359">*</span><span class="ident" id="5838360">Encoder</span><span class="op" id="5838367">)</span>&nbsp;<span class="ident" id="5838369">Encode</span><span class="op" id="5838375">(</span><span class="ident" id="5838376">w</span>&nbsp;<span class="ident" id="5838378">io</span><span class="op" id="5838380">.</span><span class="ident" id="5838381">Writer</span><span class="op" id="5838387">,</span>&nbsp;<span class="ident" id="5838389">m</span>&nbsp;<span class="ident" id="5838391">image</span><span class="op" id="5838396">.</span><span class="ident" id="5838397">Image</span><span class="op" id="5838402">)</span>&nbsp;<span class="builtintype" id="5838404">error</span>&nbsp;<span class="op" id="5838410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5838413">//&nbsp;Obviously,&nbsp;negative&nbsp;widths&nbsp;and&nbsp;heights&nbsp;are&nbsp;invalid.&nbsp;Furthermore,&nbsp;the&nbsp;PNG</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5838490">//&nbsp;spec&nbsp;section&nbsp;11.2.2&nbsp;says&nbsp;that&nbsp;zero&nbsp;is&nbsp;invalid.&nbsp;Excessively&nbsp;large&nbsp;images&nbsp;are</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5838570">//&nbsp;also&nbsp;rejected.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5838589">mw</span><span class="op" id="5838591">,</span>&nbsp;<span class="ident" id="5838593">mh</span>&nbsp;<span class="op" id="5838596">:=</span>&nbsp;<span class="ident" id="5838599">int64</span><span class="op" id="5838604">(</span><span class="ident" id="5838605">m</span><span class="op" id="5838606">.</span><span class="ident" id="5838607">Bounds</span><span class="op" id="5838613">(</span><span class="op" id="5838614">)</span><span class="op" id="5838615">.</span><span class="ident" id="5838616">Dx</span><span class="op" id="5838618">(</span><span class="op" id="5838619">)</span><span class="op" id="5838620">)</span><span class="op" id="5838621">,</span>&nbsp;<span class="ident" id="5838623">int64</span><span class="op" id="5838628">(</span><span class="ident" id="5838629">m</span><span class="op" id="5838630">.</span><span class="ident" id="5838631">Bounds</span><span class="op" id="5838637">(</span><span class="op" id="5838638">)</span><span class="op" id="5838639">.</span><span class="ident" id="5838640">Dy</span><span class="op" id="5838642">(</span><span class="op" id="5838643">)</span><span class="op" id="5838644">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5838647">if</span>&nbsp;<span class="ident" id="5838650">mw</span>&nbsp;<span class="op" id="5838653">&lt;=</span>&nbsp;<span class="num" id="5838656">0</span>&nbsp;<span class="op" id="5838658">||</span>&nbsp;<span class="ident" id="5838661">mh</span>&nbsp;<span class="op" id="5838664">&lt;=</span>&nbsp;<span class="num" id="5838667">0</span>&nbsp;<span class="op" id="5838669">||</span>&nbsp;<span class="ident" id="5838672">mw</span>&nbsp;<span class="op" id="5838675">&gt;=</span>&nbsp;<span class="num" id="5838678">1</span><span class="op" id="5838679">&lt;&lt;</span><span class="num" id="5838681">32</span>&nbsp;<span class="op" id="5838684">||</span>&nbsp;<span class="ident" id="5838687">mh</span>&nbsp;<span class="op" id="5838690">&gt;=</span>&nbsp;<span class="num" id="5838693">1</span><span class="op" id="5838694">&lt;&lt;</span><span class="num" id="5838696">32</span>&nbsp;<span class="op" id="5838699">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5838703">return</span>&nbsp;<span class="ident" id="5838710">FormatError</span><span class="op" id="5838721">(</span><span class="string" id="5838722">&#34;invalid&nbsp;image&nbsp;size:&nbsp;&#34;</span>&nbsp;<span class="op" id="5838745">+</span>&nbsp;<span class="ident" id="5838747">strconv</span><span class="op" id="5838754">.</span><span class="ident" id="5838755">FormatInt</span><span class="op" id="5838764">(</span><span class="ident" id="5838765">mw</span><span class="op" id="5838767">,</span>&nbsp;<span class="num" id="5838769">10</span><span class="op" id="5838771">)</span>&nbsp;<span class="op" id="5838773">+</span>&nbsp;<span class="string" id="5838775">&#34;x&#34;</span>&nbsp;<span class="op" id="5838779">+</span>&nbsp;<span class="ident" id="5838781">strconv</span><span class="op" id="5838788">.</span><span class="ident" id="5838789">FormatInt</span><span class="op" id="5838798">(</span><span class="ident" id="5838799">mh</span><span class="op" id="5838801">,</span>&nbsp;<span class="num" id="5838803">10</span><span class="op" id="5838805">)</span><span class="op" id="5838806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5838809">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5838813">var</span>&nbsp;<span class="ident" id="5838817">e</span>&nbsp;<span class="ident" id="5838819">encoder</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5838828">e</span><span class="op" id="5838829">.</span><span class="ident" id="5838830">enc</span>&nbsp;<span class="op" id="5838834">=</span>&nbsp;<span class="ident" id="5838836">enc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5838841">e</span><span class="op" id="5838842">.</span><span class="ident" id="5838843">w</span>&nbsp;<span class="op" id="5838845">=</span>&nbsp;<span class="ident" id="5838847">w</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5838850">e</span><span class="op" id="5838851">.</span><span class="ident" id="5838852">m</span>&nbsp;<span class="op" id="5838854">=</span>&nbsp;<span class="ident" id="5838856">m</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5838860">var</span>&nbsp;<span class="ident" id="5838864">pal</span>&nbsp;<span class="ident" id="5838868">color</span><span class="op" id="5838873">.</span><span class="ident" id="5838874">Palette</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5838883">//&nbsp;cbP8&nbsp;encoding&nbsp;needs&nbsp;PalettedImage&#39;s&nbsp;ColorIndexAt&nbsp;method.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5838944">if</span>&nbsp;<span class="ident" id="5838947">_</span><span class="op" id="5838948">,</span>&nbsp;<span class="ident" id="5838950">ok</span>&nbsp;<span class="op" id="5838953">:=</span>&nbsp;<span class="ident" id="5838956">m</span><span class="op" id="5838957">.</span><span class="op" id="5838958">(</span><span class="ident" id="5838959">image</span><span class="op" id="5838964">.</span><span class="ident" id="5838965">PalettedImage</span><span class="op" id="5838978">)</span><span class="op" id="5838979">;</span>&nbsp;<span class="ident" id="5838981">ok</span>&nbsp;<span class="op" id="5838984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5838988">pal</span><span class="op" id="5838991">,</span>&nbsp;<span class="ident" id="5838993">_</span>&nbsp;<span class="op" id="5838995">=</span>&nbsp;<span class="ident" id="5838997">m</span><span class="op" id="5838998">.</span><span class="ident" id="5838999">ColorModel</span><span class="op" id="5839009">(</span><span class="op" id="5839010">)</span><span class="op" id="5839011">.</span><span class="op" id="5839012">(</span><span class="ident" id="5839013">color</span><span class="op" id="5839018">.</span><span class="ident" id="5839019">Palette</span><span class="op" id="5839026">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5839029">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5839032">if</span>&nbsp;<span class="ident" id="5839035">pal</span>&nbsp;<span class="op" id="5839039">!=</span>&nbsp;<span class="ident" id="5839042">nil</span>&nbsp;<span class="op" id="5839046">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5839050">e</span><span class="op" id="5839051">.</span><span class="ident" id="5839052">cb</span>&nbsp;<span class="op" id="5839055">=</span>&nbsp;<span class="ident" id="5839057">cbP8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5839063">}</span>&nbsp;<span class="keyword" id="5839065">else</span>&nbsp;<span class="op" id="5839070">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5839074">switch</span>&nbsp;<span class="ident" id="5839081">m</span><span class="op" id="5839082">.</span><span class="ident" id="5839083">ColorModel</span><span class="op" id="5839093">(</span><span class="op" id="5839094">)</span>&nbsp;<span class="op" id="5839096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5839100">case</span>&nbsp;<span class="ident" id="5839105">color</span><span class="op" id="5839110">.</span><span class="ident" id="5839111">GrayModel</span><span class="op" id="5839120">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5839125">e</span><span class="op" id="5839126">.</span><span class="ident" id="5839127">cb</span>&nbsp;<span class="op" id="5839130">=</span>&nbsp;<span class="ident" id="5839132">cbG8</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5839139">case</span>&nbsp;<span class="ident" id="5839144">color</span><span class="op" id="5839149">.</span><span class="ident" id="5839150">Gray16Model</span><span class="op" id="5839161">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5839166">e</span><span class="op" id="5839167">.</span><span class="ident" id="5839168">cb</span>&nbsp;<span class="op" id="5839171">=</span>&nbsp;<span class="ident" id="5839173">cbG16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5839181">case</span>&nbsp;<span class="ident" id="5839186">color</span><span class="op" id="5839191">.</span><span class="ident" id="5839192">RGBAModel</span><span class="op" id="5839201">,</span>&nbsp;<span class="ident" id="5839203">color</span><span class="op" id="5839208">.</span><span class="ident" id="5839209">NRGBAModel</span><span class="op" id="5839219">,</span>&nbsp;<span class="ident" id="5839221">color</span><span class="op" id="5839226">.</span><span class="ident" id="5839227">AlphaModel</span><span class="op" id="5839237">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5839242">if</span>&nbsp;<span class="ident" id="5839245">opaque</span><span class="op" id="5839251">(</span><span class="ident" id="5839252">m</span><span class="op" id="5839253">)</span>&nbsp;<span class="op" id="5839255">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5839261">e</span><span class="op" id="5839262">.</span><span class="ident" id="5839263">cb</span>&nbsp;<span class="op" id="5839266">=</span>&nbsp;<span class="ident" id="5839268">cbTC8</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5839277">}</span>&nbsp;<span class="keyword" id="5839279">else</span>&nbsp;<span class="op" id="5839284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5839290">e</span><span class="op" id="5839291">.</span><span class="ident" id="5839292">cb</span>&nbsp;<span class="op" id="5839295">=</span>&nbsp;<span class="ident" id="5839297">cbTCA8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5839307">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5839311">default</span><span class="op" id="5839318">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5839323">if</span>&nbsp;<span class="ident" id="5839326">opaque</span><span class="op" id="5839332">(</span><span class="ident" id="5839333">m</span><span class="op" id="5839334">)</span>&nbsp;<span class="op" id="5839336">{</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5839342">e</span><span class="op" id="5839343">.</span><span class="ident" id="5839344">cb</span>&nbsp;<span class="op" id="5839347">=</span>&nbsp;<span class="ident" id="5839349">cbTC16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5839359">}</span>&nbsp;<span class="keyword" id="5839361">else</span>&nbsp;<span class="op" id="5839366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5839372">e</span><span class="op" id="5839373">.</span><span class="ident" id="5839374">cb</span>&nbsp;<span class="op" id="5839377">=</span>&nbsp;<span class="ident" id="5839379">cbTCA16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5839390">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5839394">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5839397">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5839401">_</span><span class="op" id="5839402">,</span>&nbsp;<span class="ident" id="5839404">e</span><span class="op" id="5839405">.</span><span class="ident" id="5839406">err</span>&nbsp;<span class="op" id="5839410">=</span>&nbsp;<span class="ident" id="5839412">io</span><span class="op" id="5839414">.</span><span class="ident" id="5839415">WriteString</span><span class="op" id="5839426">(</span><span class="ident" id="5839427">w</span><span class="op" id="5839428">,</span>&nbsp;<span class="ident" id="5839430">pngHeader</span><span class="op" id="5839439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5839442">e</span><span class="op" id="5839443">.</span><span class="ident" id="5839444">writeIHDR</span><span class="op" id="5839453">(</span><span class="op" id="5839454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5839457">if</span>&nbsp;<span class="ident" id="5839460">pal</span>&nbsp;<span class="op" id="5839464">!=</span>&nbsp;<span class="ident" id="5839467">nil</span>&nbsp;<span class="op" id="5839471">{</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5839475">e</span><span class="op" id="5839476">.</span><span class="ident" id="5839477">writePLTEAndTRNS</span><span class="op" id="5839493">(</span><span class="ident" id="5839494">pal</span><span class="op" id="5839497">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5839500">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5839503">e</span><span class="op" id="5839504">.</span><span class="ident" id="5839505">writeIDATs</span><span class="op" id="5839515">(</span><span class="op" id="5839516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5839519">e</span><span class="op" id="5839520">.</span><span class="ident" id="5839521">writeIEND</span><span class="op" id="5839530">(</span><span class="op" id="5839531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5839534">return</span>&nbsp;<span class="ident" id="5839541">e</span><span class="op" id="5839542">.</span><span class="ident" id="5839543">err</span><br>
<span class="lineno">530</span><span class="op" id="5839547">}</span>
</div>
</body>
</html>
