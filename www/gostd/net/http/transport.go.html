<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http</h2>
<ul>
<li><a href="/gostd/net/http/client.go.html">client.go</a></li>
<li><a href="/gostd/net/http/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/http/cookie.go.html">cookie.go</a></li>
<li><a href="/gostd/net/http/cookie_test.go.html">cookie_test.go</a></li>
<li><a href="/gostd/net/http/doc.go.html">doc.go</a></li>
<li><a href="/gostd/net/http/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/net/http/filetransport.go.html">filetransport.go</a></li>
<li><a href="/gostd/net/http/filetransport_test.go.html">filetransport_test.go</a></li>
<li><a href="/gostd/net/http/fs.go.html">fs.go</a></li>
<li><a href="/gostd/net/http/fs_test.go.html">fs_test.go</a></li>
<li><a href="/gostd/net/http/header.go.html">header.go</a></li>
<li><a href="/gostd/net/http/header_test.go.html">header_test.go</a></li>
<li><a href="/gostd/net/http/jar.go.html">jar.go</a></li>
<li><a href="/gostd/net/http/lex.go.html">lex.go</a></li>
<li><a href="/gostd/net/http/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/net/http/main_test.go.html">main_test.go</a></li>
<li><a href="/gostd/net/http/npn_test.go.html">npn_test.go</a></li>
<li><a href="/gostd/net/http/proxy_test.go.html">proxy_test.go</a></li>
<li><a href="/gostd/net/http/range_test.go.html">range_test.go</a></li>
<li><a href="/gostd/net/http/readrequest_test.go.html">readrequest_test.go</a></li>
<li><a href="/gostd/net/http/request.go.html">request.go</a></li>
<li><a href="/gostd/net/http/request_test.go.html">request_test.go</a></li>
<li><a href="/gostd/net/http/requestwrite_test.go.html">requestwrite_test.go</a></li>
<li><a href="/gostd/net/http/response.go.html">response.go</a></li>
<li><a href="/gostd/net/http/response_test.go.html">response_test.go</a></li>
<li><a href="/gostd/net/http/responsewrite_test.go.html">responsewrite_test.go</a></li>
<li><a href="/gostd/net/http/serve_test.go.html">serve_test.go</a></li>
<li><a href="/gostd/net/http/server.go.html">server.go</a></li>
<li><a href="/gostd/net/http/sniff.go.html">sniff.go</a></li>
<li><a href="/gostd/net/http/sniff_test.go.html">sniff_test.go</a></li>
<li><a href="/gostd/net/http/status.go.html">status.go</a></li>
<li><a href="/gostd/net/http/transfer.go.html">transfer.go</a></li>
<li><a href="/gostd/net/http/transfer_test.go.html">transfer_test.go</a></li>
<li><a href="/gostd/net/http/transport.go.html" class="current">transport.go</a></li>
<li><a href="/gostd/net/http/transport_test.go.html">transport_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3967286">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3967341">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3967395">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3967446">//&nbsp;HTTP&nbsp;client&nbsp;implementation.&nbsp;See&nbsp;RFC&nbsp;2616.</span><br>
<span class="lineno"></span><span class="comment" id="3967491">//</span><br>
<span class="lineno"></span><span class="comment" id="3967494">//&nbsp;This&nbsp;is&nbsp;the&nbsp;low-level&nbsp;Transport&nbsp;implementation&nbsp;of&nbsp;RoundTripper.</span><br>
<span class="lineno"></span><span class="comment" id="3967561">//&nbsp;The&nbsp;high-level&nbsp;interface&nbsp;is&nbsp;in&nbsp;client.go.</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="keyword" id="3967607">package</span>&nbsp;<span class="ident" id="3967615">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3967621">import</span>&nbsp;<span class="op" id="3967628">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3967631">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3967640">&#34;compress/gzip&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3967657">&#34;crypto/tls&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3967671">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3967681">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3967688">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3967694">&#34;log&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3967701">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3967708">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3967719">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3967725">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3967736">&#34;sync&#34;</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3967744">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3967751">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3967754">//&nbsp;DefaultTransport&nbsp;is&nbsp;the&nbsp;default&nbsp;implementation&nbsp;of&nbsp;Transport&nbsp;and&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3967824">//&nbsp;used&nbsp;by&nbsp;DefaultClient.&nbsp;It&nbsp;establishes&nbsp;network&nbsp;connections&nbsp;as&nbsp;needed</span><br>
<span class="lineno">30</span><span class="comment" id="3967895">//&nbsp;and&nbsp;caches&nbsp;them&nbsp;for&nbsp;reuse&nbsp;by&nbsp;subsequent&nbsp;calls.&nbsp;It&nbsp;uses&nbsp;HTTP&nbsp;proxies</span><br>
<span class="lineno"></span><span class="comment" id="3967966">//&nbsp;as&nbsp;directed&nbsp;by&nbsp;the&nbsp;$HTTP_PROXY&nbsp;and&nbsp;$NO_PROXY&nbsp;(or&nbsp;$http_proxy&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3968034">//&nbsp;$no_proxy)&nbsp;environment&nbsp;variables.</span><br>
<span class="lineno"></span><span class="keyword" id="3968071">var</span>&nbsp;<span class="ident" id="3968075">DefaultTransport</span>&nbsp;<span class="ident" id="3968092">RoundTripper</span>&nbsp;<span class="op" id="3968105">=</span>&nbsp;<span class="op" id="3968107">&amp;</span><span class="ident" id="3968108">Transport</span><span class="op" id="3968117">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3968120">Proxy</span><span class="op" id="3968125">:</span>&nbsp;<span class="ident" id="3968127">ProxyFromEnvironment</span><span class="op" id="3968147">,</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3968150">Dial</span><span class="op" id="3968154">:</span>&nbsp;<span class="op" id="3968156">(</span><span class="op" id="3968157">&amp;</span><span class="ident" id="3968158">net</span><span class="op" id="3968161">.</span><span class="ident" id="3968162">Dialer</span><span class="op" id="3968168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3968172">Timeout</span><span class="op" id="3968179">:</span>&nbsp;&nbsp;&nbsp;<span class="num" id="3968183">30</span>&nbsp;<span class="op" id="3968186">*</span>&nbsp;<span class="ident" id="3968188">time</span><span class="op" id="3968192">.</span><span class="ident" id="3968193">Second</span><span class="op" id="3968199">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3968203">KeepAlive</span><span class="op" id="3968212">:</span>&nbsp;<span class="num" id="3968214">30</span>&nbsp;<span class="op" id="3968217">*</span>&nbsp;<span class="ident" id="3968219">time</span><span class="op" id="3968223">.</span><span class="ident" id="3968224">Second</span><span class="op" id="3968230">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3968233">}</span><span class="op" id="3968234">)</span><span class="op" id="3968235">.</span><span class="ident" id="3968236">Dial</span><span class="op" id="3968240">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3968243">TLSHandshakeTimeout</span><span class="op" id="3968262">:</span>&nbsp;<span class="num" id="3968264">10</span>&nbsp;<span class="op" id="3968267">*</span>&nbsp;<span class="ident" id="3968269">time</span><span class="op" id="3968273">.</span><span class="ident" id="3968274">Second</span><span class="op" id="3968280">,</span><br>
<span class="lineno">40</span><span class="op" id="3968282">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3968285">//&nbsp;DefaultMaxIdleConnsPerHost&nbsp;is&nbsp;the&nbsp;default&nbsp;value&nbsp;of&nbsp;Transport&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="3968351">//&nbsp;MaxIdleConnsPerHost.</span><br>
<span class="lineno"></span><span class="keyword" id="3968375">const</span>&nbsp;<span class="ident" id="3968381">DefaultMaxIdleConnsPerHost</span>&nbsp;<span class="op" id="3968408">=</span>&nbsp;<span class="num" id="3968410">2</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="comment" id="3968413">//&nbsp;Transport&nbsp;is&nbsp;an&nbsp;implementation&nbsp;of&nbsp;RoundTripper&nbsp;that&nbsp;supports&nbsp;HTTP,</span><br>
<span class="lineno"></span><span class="comment" id="3968483">//&nbsp;HTTPS,&nbsp;and&nbsp;HTTP&nbsp;proxies&nbsp;(for&nbsp;either&nbsp;HTTP&nbsp;or&nbsp;HTTPS&nbsp;with&nbsp;CONNECT).</span><br>
<span class="lineno"></span><span class="comment" id="3968551">//&nbsp;Transport&nbsp;can&nbsp;also&nbsp;cache&nbsp;connections&nbsp;for&nbsp;future&nbsp;re-use.</span><br>
<span class="lineno"></span><span class="keyword" id="3968610">type</span>&nbsp;<span class="ident" id="3968615">Transport</span>&nbsp;<span class="keyword" id="3968625">struct</span>&nbsp;<span class="op" id="3968632">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3968635">idleMu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3968646">sync</span><span class="op" id="3968650">.</span><span class="ident" id="3968651">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3968658">wantIdle</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3968669">bool</span>&nbsp;<span class="comment" id="3968674">//&nbsp;user&nbsp;has&nbsp;requested&nbsp;to&nbsp;close&nbsp;all&nbsp;idle&nbsp;conns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3968721">idleConn</span>&nbsp;&nbsp;&nbsp;<span class="keyword" id="3968732">map</span><span class="op" id="3968735">[</span><span class="ident" id="3968736">connectMethodKey</span><span class="op" id="3968752">]</span><span class="op" id="3968753">[</span><span class="op" id="3968754">]</span><span class="op" id="3968755">*</span><span class="ident" id="3968756">persistConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3968769">idleConnCh</span>&nbsp;<span class="keyword" id="3968780">map</span><span class="op" id="3968783">[</span><span class="ident" id="3968784">connectMethodKey</span><span class="op" id="3968800">]</span><span class="keyword" id="3968801">chan</span>&nbsp;<span class="op" id="3968806">*</span><span class="ident" id="3968807">persistConn</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3968821">reqMu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3968833">sync</span><span class="op" id="3968837">.</span><span class="ident" id="3968838">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3968845">reqCanceler</span>&nbsp;<span class="keyword" id="3968857">map</span><span class="op" id="3968860">[</span><span class="op" id="3968861">*</span><span class="ident" id="3968862">Request</span><span class="op" id="3968869">]</span><span class="keyword" id="3968870">func</span><span class="op" id="3968874">(</span><span class="op" id="3968875">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3968879">altMu</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3968888">sync</span><span class="op" id="3968892">.</span><span class="ident" id="3968893">RWMutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3968902">altProto</span>&nbsp;<span class="keyword" id="3968911">map</span><span class="op" id="3968914">[</span><span class="builtintype" id="3968915">string</span><span class="op" id="3968921">]</span><span class="ident" id="3968922">RoundTripper</span>&nbsp;<span class="comment" id="3968935">//&nbsp;nil&nbsp;or&nbsp;map&nbsp;of&nbsp;URI&nbsp;scheme&nbsp;=&gt;&nbsp;RoundTripper</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3968981">//&nbsp;Proxy&nbsp;specifies&nbsp;a&nbsp;function&nbsp;to&nbsp;return&nbsp;a&nbsp;proxy&nbsp;for&nbsp;a&nbsp;given</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3969042">//&nbsp;Request.&nbsp;If&nbsp;the&nbsp;function&nbsp;returns&nbsp;a&nbsp;non-nil&nbsp;error,&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3969100">//&nbsp;request&nbsp;is&nbsp;aborted&nbsp;with&nbsp;the&nbsp;provided&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3969148">//&nbsp;If&nbsp;Proxy&nbsp;is&nbsp;nil&nbsp;or&nbsp;returns&nbsp;a&nbsp;nil&nbsp;*URL,&nbsp;no&nbsp;proxy&nbsp;is&nbsp;used.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3969209">Proxy</span>&nbsp;<span class="keyword" id="3969215">func</span><span class="op" id="3969219">(</span><span class="op" id="3969220">*</span><span class="ident" id="3969221">Request</span><span class="op" id="3969228">)</span>&nbsp;<span class="op" id="3969230">(</span><span class="op" id="3969231">*</span><span class="ident" id="3969232">url</span><span class="op" id="3969235">.</span><span class="ident" id="3969236">URL</span><span class="op" id="3969239">,</span>&nbsp;<span class="builtintype" id="3969241">error</span><span class="op" id="3969246">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3969250">//&nbsp;Dial&nbsp;specifies&nbsp;the&nbsp;dial&nbsp;function&nbsp;for&nbsp;creating&nbsp;unencrypted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3969312">//&nbsp;TCP&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3969333">//&nbsp;If&nbsp;Dial&nbsp;is&nbsp;nil,&nbsp;net.Dial&nbsp;is&nbsp;used.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3969371">Dial</span>&nbsp;<span class="keyword" id="3969376">func</span><span class="op" id="3969380">(</span><span class="ident" id="3969381">network</span><span class="op" id="3969388">,</span>&nbsp;<span class="ident" id="3969390">addr</span>&nbsp;<span class="builtintype" id="3969395">string</span><span class="op" id="3969401">)</span>&nbsp;<span class="op" id="3969403">(</span><span class="ident" id="3969404">net</span><span class="op" id="3969407">.</span><span class="ident" id="3969408">Conn</span><span class="op" id="3969412">,</span>&nbsp;<span class="builtintype" id="3969414">error</span><span class="op" id="3969419">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3969423">//&nbsp;DialTLS&nbsp;specifies&nbsp;an&nbsp;optional&nbsp;dial&nbsp;function&nbsp;for&nbsp;creating</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3969484">//&nbsp;TLS&nbsp;connections&nbsp;for&nbsp;non-proxied&nbsp;HTTPS&nbsp;requests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3969536">//</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3969540">//&nbsp;If&nbsp;DialTLS&nbsp;is&nbsp;nil,&nbsp;Dial&nbsp;and&nbsp;TLSClientConfig&nbsp;are&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3969598">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3969602">//&nbsp;If&nbsp;DialTLS&nbsp;is&nbsp;set,&nbsp;the&nbsp;Dial&nbsp;hook&nbsp;is&nbsp;not&nbsp;used&nbsp;for&nbsp;HTTPS</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3969661">//&nbsp;requests&nbsp;and&nbsp;the&nbsp;TLSClientConfig&nbsp;and&nbsp;TLSHandshakeTimeout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3969722">//&nbsp;are&nbsp;ignored.&nbsp;The&nbsp;returned&nbsp;net.Conn&nbsp;is&nbsp;assumed&nbsp;to&nbsp;already&nbsp;be</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3969786">//&nbsp;past&nbsp;the&nbsp;TLS&nbsp;handshake.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3969814">DialTLS</span>&nbsp;<span class="keyword" id="3969822">func</span><span class="op" id="3969826">(</span><span class="ident" id="3969827">network</span><span class="op" id="3969834">,</span>&nbsp;<span class="ident" id="3969836">addr</span>&nbsp;<span class="builtintype" id="3969841">string</span><span class="op" id="3969847">)</span>&nbsp;<span class="op" id="3969849">(</span><span class="ident" id="3969850">net</span><span class="op" id="3969853">.</span><span class="ident" id="3969854">Conn</span><span class="op" id="3969858">,</span>&nbsp;<span class="builtintype" id="3969860">error</span><span class="op" id="3969865">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3969869">//&nbsp;TLSClientConfig&nbsp;specifies&nbsp;the&nbsp;TLS&nbsp;configuration&nbsp;to&nbsp;use&nbsp;with</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3969933">//&nbsp;tls.Client.&nbsp;If&nbsp;nil,&nbsp;the&nbsp;default&nbsp;configuration&nbsp;is&nbsp;used.</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3969992">TLSClientConfig</span>&nbsp;<span class="op" id="3970008">*</span><span class="ident" id="3970009">tls</span><span class="op" id="3970012">.</span><span class="ident" id="3970013">Config</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3970022">//&nbsp;TLSHandshakeTimeout&nbsp;specifies&nbsp;the&nbsp;maximum&nbsp;amount&nbsp;of&nbsp;time&nbsp;waiting&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3970094">//&nbsp;wait&nbsp;for&nbsp;a&nbsp;TLS&nbsp;handshake.&nbsp;Zero&nbsp;means&nbsp;no&nbsp;timeout.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3970147">TLSHandshakeTimeout</span>&nbsp;<span class="ident" id="3970167">time</span><span class="op" id="3970171">.</span><span class="ident" id="3970172">Duration</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3970183">//&nbsp;DisableKeepAlives,&nbsp;if&nbsp;true,&nbsp;prevents&nbsp;re-use&nbsp;of&nbsp;TCP&nbsp;connections</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3970250">//&nbsp;between&nbsp;different&nbsp;HTTP&nbsp;requests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3970287">DisableKeepAlives</span>&nbsp;<span class="builtintype" id="3970305">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3970312">//&nbsp;DisableCompression,&nbsp;if&nbsp;true,&nbsp;prevents&nbsp;the&nbsp;Transport&nbsp;from</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3970373">//&nbsp;requesting&nbsp;compression&nbsp;with&nbsp;an&nbsp;&#34;Accept-Encoding:&nbsp;gzip&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3970432">//&nbsp;request&nbsp;header&nbsp;when&nbsp;the&nbsp;Request&nbsp;contains&nbsp;no&nbsp;existing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3970489">//&nbsp;Accept-Encoding&nbsp;value.&nbsp;If&nbsp;the&nbsp;Transport&nbsp;requests&nbsp;gzip&nbsp;on</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3970550">//&nbsp;its&nbsp;own&nbsp;and&nbsp;gets&nbsp;a&nbsp;gzipped&nbsp;response,&nbsp;it&#39;s&nbsp;transparently</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3970610">//&nbsp;decoded&nbsp;in&nbsp;the&nbsp;Response.Body.&nbsp;However,&nbsp;if&nbsp;the&nbsp;user</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3970665">//&nbsp;explicitly&nbsp;requested&nbsp;gzip&nbsp;it&nbsp;is&nbsp;not&nbsp;automatically</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3970719">//&nbsp;uncompressed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3970737">DisableCompression</span>&nbsp;<span class="builtintype" id="3970756">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3970763">//&nbsp;MaxIdleConnsPerHost,&nbsp;if&nbsp;non-zero,&nbsp;controls&nbsp;the&nbsp;maximum&nbsp;idle</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3970827">//&nbsp;(keep-alive)&nbsp;to&nbsp;keep&nbsp;per-host.&nbsp;&nbsp;If&nbsp;zero,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3970872">//&nbsp;DefaultMaxIdleConnsPerHost&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3970912">MaxIdleConnsPerHost</span>&nbsp;<span class="builtintype" id="3970932">int</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3970938">//&nbsp;ResponseHeaderTimeout,&nbsp;if&nbsp;non-zero,&nbsp;specifies&nbsp;the&nbsp;amount&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3971002">//&nbsp;time&nbsp;to&nbsp;wait&nbsp;for&nbsp;a&nbsp;server&#39;s&nbsp;response&nbsp;headers&nbsp;after&nbsp;fully</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3971063">//&nbsp;writing&nbsp;the&nbsp;request&nbsp;(including&nbsp;its&nbsp;body,&nbsp;if&nbsp;any).&nbsp;This</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3971122">//&nbsp;time&nbsp;does&nbsp;not&nbsp;include&nbsp;the&nbsp;time&nbsp;to&nbsp;read&nbsp;the&nbsp;response&nbsp;body.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3971184">ResponseHeaderTimeout</span>&nbsp;<span class="ident" id="3971206">time</span><span class="op" id="3971210">.</span><span class="ident" id="3971211">Duration</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3971222">//&nbsp;TODO:&nbsp;tunable&nbsp;on&nbsp;global&nbsp;max&nbsp;cached&nbsp;connections</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3971273">//&nbsp;TODO:&nbsp;tunable&nbsp;on&nbsp;timeout&nbsp;on&nbsp;cached&nbsp;connections</span><br>
<span class="lineno"></span><span class="op" id="3971323">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="comment" id="3971326">//&nbsp;ProxyFromEnvironment&nbsp;returns&nbsp;the&nbsp;URL&nbsp;of&nbsp;the&nbsp;proxy&nbsp;to&nbsp;use&nbsp;for&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3971392">//&nbsp;given&nbsp;request,&nbsp;as&nbsp;indicated&nbsp;by&nbsp;the&nbsp;environment&nbsp;variables</span><br>
<span class="lineno"></span><span class="comment" id="3971452">//&nbsp;HTTP_PROXY,&nbsp;HTTPS_PROXY&nbsp;and&nbsp;NO_PROXY&nbsp;(or&nbsp;the&nbsp;lowercase&nbsp;versions</span><br>
<span class="lineno"></span><span class="comment" id="3971519">//&nbsp;thereof).&nbsp;HTTPS_PROXY&nbsp;takes&nbsp;precedence&nbsp;over&nbsp;HTTP_PROXY&nbsp;for&nbsp;https</span><br>
<span class="lineno"></span><span class="comment" id="3971587">//&nbsp;requests.</span><br>
<span class="lineno">125</span><span class="comment" id="3971600">//</span><br>
<span class="lineno"></span><span class="comment" id="3971603">//&nbsp;The&nbsp;environment&nbsp;values&nbsp;may&nbsp;be&nbsp;either&nbsp;a&nbsp;complete&nbsp;URL&nbsp;or&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3971663">//&nbsp;&#34;host[:port]&#34;,&nbsp;in&nbsp;which&nbsp;case&nbsp;the&nbsp;&#34;http&#34;&nbsp;scheme&nbsp;is&nbsp;assumed.</span><br>
<span class="lineno"></span><span class="comment" id="3971725">//&nbsp;An&nbsp;error&nbsp;is&nbsp;returned&nbsp;if&nbsp;the&nbsp;value&nbsp;is&nbsp;a&nbsp;different&nbsp;form.</span><br>
<span class="lineno"></span><span class="comment" id="3971783">//</span><br>
<span class="lineno">130</span><span class="comment" id="3971786">//&nbsp;A&nbsp;nil&nbsp;URL&nbsp;and&nbsp;nil&nbsp;error&nbsp;are&nbsp;returned&nbsp;if&nbsp;no&nbsp;proxy&nbsp;is&nbsp;defined&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3971856">//&nbsp;environment,&nbsp;or&nbsp;a&nbsp;proxy&nbsp;should&nbsp;not&nbsp;be&nbsp;used&nbsp;for&nbsp;the&nbsp;given&nbsp;request,</span><br>
<span class="lineno"></span><span class="comment" id="3971925">//&nbsp;as&nbsp;defined&nbsp;by&nbsp;NO_PROXY.</span><br>
<span class="lineno"></span><span class="comment" id="3971952">//</span><br>
<span class="lineno"></span><span class="comment" id="3971955">//&nbsp;As&nbsp;a&nbsp;special&nbsp;case,&nbsp;if&nbsp;req.URL.Host&nbsp;is&nbsp;&#34;localhost&#34;&nbsp;(with&nbsp;or&nbsp;without</span><br>
<span class="lineno">135</span><span class="comment" id="3972025">//&nbsp;a&nbsp;port&nbsp;number),&nbsp;then&nbsp;a&nbsp;nil&nbsp;URL&nbsp;and&nbsp;nil&nbsp;error&nbsp;will&nbsp;be&nbsp;returned.</span><br>
<span class="lineno"></span><span class="keyword" id="3972091">func</span>&nbsp;<span class="ident" id="3972096">ProxyFromEnvironment</span><span class="op" id="3972116">(</span><span class="ident" id="3972117">req</span>&nbsp;<span class="op" id="3972121">*</span><span class="ident" id="3972122">Request</span><span class="op" id="3972129">)</span>&nbsp;<span class="op" id="3972131">(</span><span class="op" id="3972132">*</span><span class="ident" id="3972133">url</span><span class="op" id="3972136">.</span><span class="ident" id="3972137">URL</span><span class="op" id="3972140">,</span>&nbsp;<span class="builtintype" id="3972142">error</span><span class="op" id="3972147">)</span>&nbsp;<span class="op" id="3972149">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3972152">var</span>&nbsp;<span class="ident" id="3972156">proxy</span>&nbsp;<span class="builtintype" id="3972162">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3972170">if</span>&nbsp;<span class="ident" id="3972173">req</span><span class="op" id="3972176">.</span><span class="ident" id="3972177">URL</span><span class="op" id="3972180">.</span><span class="ident" id="3972181">Scheme</span>&nbsp;<span class="op" id="3972188">==</span>&nbsp;<span class="string" id="3972191">&#34;https&#34;</span>&nbsp;<span class="op" id="3972199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3972203">proxy</span>&nbsp;<span class="op" id="3972209">=</span>&nbsp;<span class="ident" id="3972211">httpsProxyEnv</span><span class="op" id="3972224">.</span><span class="ident" id="3972225">Get</span><span class="op" id="3972228">(</span><span class="op" id="3972229">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3972232">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3972235">if</span>&nbsp;<span class="ident" id="3972238">proxy</span>&nbsp;<span class="op" id="3972244">==</span>&nbsp;<span class="string" id="3972247">&#34;&#34;</span>&nbsp;<span class="op" id="3972250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3972254">proxy</span>&nbsp;<span class="op" id="3972260">=</span>&nbsp;<span class="ident" id="3972262">httpProxyEnv</span><span class="op" id="3972274">.</span><span class="ident" id="3972275">Get</span><span class="op" id="3972278">(</span><span class="op" id="3972279">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3972282">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3972285">if</span>&nbsp;<span class="ident" id="3972288">proxy</span>&nbsp;<span class="op" id="3972294">==</span>&nbsp;<span class="string" id="3972297">&#34;&#34;</span>&nbsp;<span class="op" id="3972300">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3972304">return</span>&nbsp;<span class="ident" id="3972311">nil</span><span class="op" id="3972314">,</span>&nbsp;<span class="ident" id="3972316">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3972321">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3972324">if</span>&nbsp;<span class="op" id="3972327">!</span><span class="ident" id="3972328">useProxy</span><span class="op" id="3972336">(</span><span class="ident" id="3972337">canonicalAddr</span><span class="op" id="3972350">(</span><span class="ident" id="3972351">req</span><span class="op" id="3972354">.</span><span class="ident" id="3972355">URL</span><span class="op" id="3972358">)</span><span class="op" id="3972359">)</span>&nbsp;<span class="op" id="3972361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3972365">return</span>&nbsp;<span class="ident" id="3972372">nil</span><span class="op" id="3972375">,</span>&nbsp;<span class="ident" id="3972377">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3972382">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3972385">proxyURL</span><span class="op" id="3972393">,</span>&nbsp;<span class="ident" id="3972395">err</span>&nbsp;<span class="op" id="3972399">:=</span>&nbsp;<span class="ident" id="3972402">url</span><span class="op" id="3972405">.</span><span class="ident" id="3972406">Parse</span><span class="op" id="3972411">(</span><span class="ident" id="3972412">proxy</span><span class="op" id="3972417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3972420">if</span>&nbsp;<span class="ident" id="3972423">err</span>&nbsp;<span class="op" id="3972427">!=</span>&nbsp;<span class="ident" id="3972430">nil</span>&nbsp;<span class="op" id="3972434">||</span>&nbsp;<span class="op" id="3972437">!</span><span class="ident" id="3972438">strings</span><span class="op" id="3972445">.</span><span class="ident" id="3972446">HasPrefix</span><span class="op" id="3972455">(</span><span class="ident" id="3972456">proxyURL</span><span class="op" id="3972464">.</span><span class="ident" id="3972465">Scheme</span><span class="op" id="3972471">,</span>&nbsp;<span class="string" id="3972473">&#34;http&#34;</span><span class="op" id="3972479">)</span>&nbsp;<span class="op" id="3972481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3972485">//&nbsp;proxy&nbsp;was&nbsp;bogus.&nbsp;Try&nbsp;prepending&nbsp;&#34;http://&#34;&nbsp;to&nbsp;it&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3972542">//&nbsp;see&nbsp;if&nbsp;that&nbsp;parses&nbsp;correctly.&nbsp;If&nbsp;not,&nbsp;we&nbsp;fall</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3972593">//&nbsp;through&nbsp;and&nbsp;complain&nbsp;about&nbsp;the&nbsp;original&nbsp;one.</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3972643">if</span>&nbsp;<span class="ident" id="3972646">proxyURL</span><span class="op" id="3972654">,</span>&nbsp;<span class="ident" id="3972656">err</span>&nbsp;<span class="op" id="3972660">:=</span>&nbsp;<span class="ident" id="3972663">url</span><span class="op" id="3972666">.</span><span class="ident" id="3972667">Parse</span><span class="op" id="3972672">(</span><span class="string" id="3972673">&#34;http://&#34;</span>&nbsp;<span class="op" id="3972683">+</span>&nbsp;<span class="ident" id="3972685">proxy</span><span class="op" id="3972690">)</span><span class="op" id="3972691">;</span>&nbsp;<span class="ident" id="3972693">err</span>&nbsp;<span class="op" id="3972697">==</span>&nbsp;<span class="ident" id="3972700">nil</span>&nbsp;<span class="op" id="3972704">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3972709">return</span>&nbsp;<span class="ident" id="3972716">proxyURL</span><span class="op" id="3972724">,</span>&nbsp;<span class="ident" id="3972726">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3972732">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3972735">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3972738">if</span>&nbsp;<span class="ident" id="3972741">err</span>&nbsp;<span class="op" id="3972745">!=</span>&nbsp;<span class="ident" id="3972748">nil</span>&nbsp;<span class="op" id="3972752">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3972756">return</span>&nbsp;<span class="ident" id="3972763">nil</span><span class="op" id="3972766">,</span>&nbsp;<span class="ident" id="3972768">fmt</span><span class="op" id="3972771">.</span><span class="ident" id="3972772">Errorf</span><span class="op" id="3972778">(</span><span class="string" id="3972779">&#34;invalid&nbsp;proxy&nbsp;address&nbsp;%q:&nbsp;%v&#34;</span><span class="op" id="3972809">,</span>&nbsp;<span class="ident" id="3972811">proxy</span><span class="op" id="3972816">,</span>&nbsp;<span class="ident" id="3972818">err</span><span class="op" id="3972821">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3972824">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3972827">return</span>&nbsp;<span class="ident" id="3972834">proxyURL</span><span class="op" id="3972842">,</span>&nbsp;<span class="ident" id="3972844">nil</span><br>
<span class="lineno"></span><span class="op" id="3972848">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="comment" id="3972851">//&nbsp;ProxyURL&nbsp;returns&nbsp;a&nbsp;proxy&nbsp;function&nbsp;(for&nbsp;use&nbsp;in&nbsp;a&nbsp;Transport)</span><br>
<span class="lineno"></span><span class="comment" id="3972913">//&nbsp;that&nbsp;always&nbsp;returns&nbsp;the&nbsp;same&nbsp;URL.</span><br>
<span class="lineno"></span><span class="keyword" id="3972950">func</span>&nbsp;<span class="ident" id="3972955">ProxyURL</span><span class="op" id="3972963">(</span><span class="ident" id="3972964">fixedURL</span>&nbsp;<span class="op" id="3972973">*</span><span class="ident" id="3972974">url</span><span class="op" id="3972977">.</span><span class="ident" id="3972978">URL</span><span class="op" id="3972981">)</span>&nbsp;<span class="keyword" id="3972983">func</span><span class="op" id="3972987">(</span><span class="op" id="3972988">*</span><span class="ident" id="3972989">Request</span><span class="op" id="3972996">)</span>&nbsp;<span class="op" id="3972998">(</span><span class="op" id="3972999">*</span><span class="ident" id="3973000">url</span><span class="op" id="3973003">.</span><span class="ident" id="3973004">URL</span><span class="op" id="3973007">,</span>&nbsp;<span class="builtintype" id="3973009">error</span><span class="op" id="3973014">)</span>&nbsp;<span class="op" id="3973016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3973019">return</span>&nbsp;<span class="keyword" id="3973026">func</span><span class="op" id="3973030">(</span><span class="op" id="3973031">*</span><span class="ident" id="3973032">Request</span><span class="op" id="3973039">)</span>&nbsp;<span class="op" id="3973041">(</span><span class="op" id="3973042">*</span><span class="ident" id="3973043">url</span><span class="op" id="3973046">.</span><span class="ident" id="3973047">URL</span><span class="op" id="3973050">,</span>&nbsp;<span class="builtintype" id="3973052">error</span><span class="op" id="3973057">)</span>&nbsp;<span class="op" id="3973059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3973063">return</span>&nbsp;<span class="ident" id="3973070">fixedURL</span><span class="op" id="3973078">,</span>&nbsp;<span class="ident" id="3973080">nil</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3973085">}</span><br>
<span class="lineno"></span><span class="op" id="3973087">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3973090">//&nbsp;transportRequest&nbsp;is&nbsp;a&nbsp;wrapper&nbsp;around&nbsp;a&nbsp;*Request&nbsp;that&nbsp;adds</span><br>
<span class="lineno"></span><span class="comment" id="3973151">//&nbsp;optional&nbsp;extra&nbsp;headers&nbsp;to&nbsp;write.</span><br>
<span class="lineno">175</span><span class="keyword" id="3973187">type</span>&nbsp;<span class="ident" id="3973192">transportRequest</span>&nbsp;<span class="keyword" id="3973209">struct</span>&nbsp;<span class="op" id="3973216">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3973219">*</span><span class="ident" id="3973220">Request</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3973235">//&nbsp;original&nbsp;request,&nbsp;not&nbsp;to&nbsp;be&nbsp;mutated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3973275">extra</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3973284">Header</span>&nbsp;<span class="comment" id="3973291">//&nbsp;extra&nbsp;headers&nbsp;to&nbsp;write,&nbsp;or&nbsp;nil</span><br>
<span class="lineno"></span><span class="op" id="3973325">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span><span class="keyword" id="3973328">func</span>&nbsp;<span class="op" id="3973333">(</span><span class="ident" id="3973334">tr</span>&nbsp;<span class="op" id="3973337">*</span><span class="ident" id="3973338">transportRequest</span><span class="op" id="3973354">)</span>&nbsp;<span class="ident" id="3973356">extraHeaders</span><span class="op" id="3973368">(</span><span class="op" id="3973369">)</span>&nbsp;<span class="ident" id="3973371">Header</span>&nbsp;<span class="op" id="3973378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3973381">if</span>&nbsp;<span class="ident" id="3973384">tr</span><span class="op" id="3973386">.</span><span class="ident" id="3973387">extra</span>&nbsp;<span class="op" id="3973393">==</span>&nbsp;<span class="ident" id="3973396">nil</span>&nbsp;<span class="op" id="3973400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3973404">tr</span><span class="op" id="3973406">.</span><span class="ident" id="3973407">extra</span>&nbsp;<span class="op" id="3973413">=</span>&nbsp;<span class="builtinfunc" id="3973415">make</span><span class="op" id="3973419">(</span><span class="ident" id="3973420">Header</span><span class="op" id="3973426">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3973429">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3973432">return</span>&nbsp;<span class="ident" id="3973439">tr</span><span class="op" id="3973441">.</span><span class="ident" id="3973442">extra</span><br>
<span class="lineno">185</span><span class="op" id="3973448">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3973451">//&nbsp;RoundTrip&nbsp;implements&nbsp;the&nbsp;RoundTripper&nbsp;interface.</span><br>
<span class="lineno"></span><span class="comment" id="3973503">//</span><br>
<span class="lineno"></span><span class="comment" id="3973506">//&nbsp;For&nbsp;higher-level&nbsp;HTTP&nbsp;client&nbsp;support&nbsp;(such&nbsp;as&nbsp;handling&nbsp;of&nbsp;cookies</span><br>
<span class="lineno">190</span><span class="comment" id="3973575">//&nbsp;and&nbsp;redirects),&nbsp;see&nbsp;Get,&nbsp;Post,&nbsp;and&nbsp;the&nbsp;Client&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="3973630">func</span>&nbsp;<span class="op" id="3973635">(</span><span class="ident" id="3973636">t</span>&nbsp;<span class="op" id="3973638">*</span><span class="ident" id="3973639">Transport</span><span class="op" id="3973648">)</span>&nbsp;<span class="ident" id="3973650">RoundTrip</span><span class="op" id="3973659">(</span><span class="ident" id="3973660">req</span>&nbsp;<span class="op" id="3973664">*</span><span class="ident" id="3973665">Request</span><span class="op" id="3973672">)</span>&nbsp;<span class="op" id="3973674">(</span><span class="ident" id="3973675">resp</span>&nbsp;<span class="op" id="3973680">*</span><span class="ident" id="3973681">Response</span><span class="op" id="3973689">,</span>&nbsp;<span class="ident" id="3973691">err</span>&nbsp;<span class="builtintype" id="3973695">error</span><span class="op" id="3973700">)</span>&nbsp;<span class="op" id="3973702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3973705">if</span>&nbsp;<span class="ident" id="3973708">req</span><span class="op" id="3973711">.</span><span class="ident" id="3973712">URL</span>&nbsp;<span class="op" id="3973716">==</span>&nbsp;<span class="ident" id="3973719">nil</span>&nbsp;<span class="op" id="3973723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3973727">req</span><span class="op" id="3973730">.</span><span class="ident" id="3973731">closeBody</span><span class="op" id="3973740">(</span><span class="op" id="3973741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3973745">return</span>&nbsp;<span class="ident" id="3973752">nil</span><span class="op" id="3973755">,</span>&nbsp;<span class="ident" id="3973757">errors</span><span class="op" id="3973763">.</span><span class="ident" id="3973764">New</span><span class="op" id="3973767">(</span><span class="string" id="3973768">&#34;http:&nbsp;nil&nbsp;Request.URL&#34;</span><span class="op" id="3973791">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3973794">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3973797">if</span>&nbsp;<span class="ident" id="3973800">req</span><span class="op" id="3973803">.</span><span class="ident" id="3973804">Header</span>&nbsp;<span class="op" id="3973811">==</span>&nbsp;<span class="ident" id="3973814">nil</span>&nbsp;<span class="op" id="3973818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3973822">req</span><span class="op" id="3973825">.</span><span class="ident" id="3973826">closeBody</span><span class="op" id="3973835">(</span><span class="op" id="3973836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3973840">return</span>&nbsp;<span class="ident" id="3973847">nil</span><span class="op" id="3973850">,</span>&nbsp;<span class="ident" id="3973852">errors</span><span class="op" id="3973858">.</span><span class="ident" id="3973859">New</span><span class="op" id="3973862">(</span><span class="string" id="3973863">&#34;http:&nbsp;nil&nbsp;Request.Header&#34;</span><span class="op" id="3973889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3973892">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3973895">if</span>&nbsp;<span class="ident" id="3973898">req</span><span class="op" id="3973901">.</span><span class="ident" id="3973902">URL</span><span class="op" id="3973905">.</span><span class="ident" id="3973906">Scheme</span>&nbsp;<span class="op" id="3973913">!=</span>&nbsp;<span class="string" id="3973916">&#34;http&#34;</span>&nbsp;<span class="op" id="3973923">&amp;&amp;</span>&nbsp;<span class="ident" id="3973926">req</span><span class="op" id="3973929">.</span><span class="ident" id="3973930">URL</span><span class="op" id="3973933">.</span><span class="ident" id="3973934">Scheme</span>&nbsp;<span class="op" id="3973941">!=</span>&nbsp;<span class="string" id="3973944">&#34;https&#34;</span>&nbsp;<span class="op" id="3973952">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3973956">t</span><span class="op" id="3973957">.</span><span class="ident" id="3973958">altMu</span><span class="op" id="3973963">.</span><span class="ident" id="3973964">RLock</span><span class="op" id="3973969">(</span><span class="op" id="3973970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3973974">var</span>&nbsp;<span class="ident" id="3973978">rt</span>&nbsp;<span class="ident" id="3973981">RoundTripper</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3973996">if</span>&nbsp;<span class="ident" id="3973999">t</span><span class="op" id="3974000">.</span><span class="ident" id="3974001">altProto</span>&nbsp;<span class="op" id="3974010">!=</span>&nbsp;<span class="ident" id="3974013">nil</span>&nbsp;<span class="op" id="3974017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3974022">rt</span>&nbsp;<span class="op" id="3974025">=</span>&nbsp;<span class="ident" id="3974027">t</span><span class="op" id="3974028">.</span><span class="ident" id="3974029">altProto</span><span class="op" id="3974037">[</span><span class="ident" id="3974038">req</span><span class="op" id="3974041">.</span><span class="ident" id="3974042">URL</span><span class="op" id="3974045">.</span><span class="ident" id="3974046">Scheme</span><span class="op" id="3974052">]</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3974056">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3974060">t</span><span class="op" id="3974061">.</span><span class="ident" id="3974062">altMu</span><span class="op" id="3974067">.</span><span class="ident" id="3974068">RUnlock</span><span class="op" id="3974075">(</span><span class="op" id="3974076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3974080">if</span>&nbsp;<span class="ident" id="3974083">rt</span>&nbsp;<span class="op" id="3974086">==</span>&nbsp;<span class="ident" id="3974089">nil</span>&nbsp;<span class="op" id="3974093">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3974098">req</span><span class="op" id="3974101">.</span><span class="ident" id="3974102">closeBody</span><span class="op" id="3974111">(</span><span class="op" id="3974112">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3974117">return</span>&nbsp;<span class="ident" id="3974124">nil</span><span class="op" id="3974127">,</span>&nbsp;<span class="op" id="3974129">&amp;</span><span class="ident" id="3974130">badStringError</span><span class="op" id="3974144">{</span><span class="string" id="3974145">&#34;unsupported&nbsp;protocol&nbsp;scheme&#34;</span><span class="op" id="3974174">,</span>&nbsp;<span class="ident" id="3974176">req</span><span class="op" id="3974179">.</span><span class="ident" id="3974180">URL</span><span class="op" id="3974183">.</span><span class="ident" id="3974184">Scheme</span><span class="op" id="3974190">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3974194">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3974198">return</span>&nbsp;<span class="ident" id="3974205">rt</span><span class="op" id="3974207">.</span><span class="ident" id="3974208">RoundTrip</span><span class="op" id="3974217">(</span><span class="ident" id="3974218">req</span><span class="op" id="3974221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3974224">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3974227">if</span>&nbsp;<span class="ident" id="3974230">req</span><span class="op" id="3974233">.</span><span class="ident" id="3974234">URL</span><span class="op" id="3974237">.</span><span class="ident" id="3974238">Host</span>&nbsp;<span class="op" id="3974243">==</span>&nbsp;<span class="string" id="3974246">&#34;&#34;</span>&nbsp;<span class="op" id="3974249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3974253">req</span><span class="op" id="3974256">.</span><span class="ident" id="3974257">closeBody</span><span class="op" id="3974266">(</span><span class="op" id="3974267">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3974271">return</span>&nbsp;<span class="ident" id="3974278">nil</span><span class="op" id="3974281">,</span>&nbsp;<span class="ident" id="3974283">errors</span><span class="op" id="3974289">.</span><span class="ident" id="3974290">New</span><span class="op" id="3974293">(</span><span class="string" id="3974294">&#34;http:&nbsp;no&nbsp;Host&nbsp;in&nbsp;request&nbsp;URL&#34;</span><span class="op" id="3974324">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3974327">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3974330">treq</span>&nbsp;<span class="op" id="3974335">:=</span>&nbsp;<span class="op" id="3974338">&amp;</span><span class="ident" id="3974339">transportRequest</span><span class="op" id="3974355">{</span><span class="ident" id="3974356">Request</span><span class="op" id="3974363">:</span>&nbsp;<span class="ident" id="3974365">req</span><span class="op" id="3974368">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3974371">cm</span><span class="op" id="3974373">,</span>&nbsp;<span class="ident" id="3974375">err</span>&nbsp;<span class="op" id="3974379">:=</span>&nbsp;<span class="ident" id="3974382">t</span><span class="op" id="3974383">.</span><span class="ident" id="3974384">connectMethodForRequest</span><span class="op" id="3974407">(</span><span class="ident" id="3974408">treq</span><span class="op" id="3974412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3974415">if</span>&nbsp;<span class="ident" id="3974418">err</span>&nbsp;<span class="op" id="3974422">!=</span>&nbsp;<span class="ident" id="3974425">nil</span>&nbsp;<span class="op" id="3974429">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3974433">req</span><span class="op" id="3974436">.</span><span class="ident" id="3974437">closeBody</span><span class="op" id="3974446">(</span><span class="op" id="3974447">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3974451">return</span>&nbsp;<span class="ident" id="3974458">nil</span><span class="op" id="3974461">,</span>&nbsp;<span class="ident" id="3974463">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3974468">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3974472">//&nbsp;Get&nbsp;the&nbsp;cached&nbsp;or&nbsp;newly-created&nbsp;connection&nbsp;to&nbsp;either&nbsp;the</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3974533">//&nbsp;host&nbsp;(for&nbsp;http&nbsp;or&nbsp;https),&nbsp;the&nbsp;http&nbsp;proxy,&nbsp;or&nbsp;the&nbsp;http&nbsp;proxy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3974597">//&nbsp;pre-CONNECTed&nbsp;to&nbsp;https&nbsp;server.&nbsp;&nbsp;In&nbsp;any&nbsp;case,&nbsp;we&#39;ll&nbsp;be&nbsp;ready</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3974661">//&nbsp;to&nbsp;send&nbsp;it&nbsp;requests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3974686">pconn</span><span class="op" id="3974691">,</span>&nbsp;<span class="ident" id="3974693">err</span>&nbsp;<span class="op" id="3974697">:=</span>&nbsp;<span class="ident" id="3974700">t</span><span class="op" id="3974701">.</span><span class="ident" id="3974702">getConn</span><span class="op" id="3974709">(</span><span class="ident" id="3974710">req</span><span class="op" id="3974713">,</span>&nbsp;<span class="ident" id="3974715">cm</span><span class="op" id="3974717">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3974720">if</span>&nbsp;<span class="ident" id="3974723">err</span>&nbsp;<span class="op" id="3974727">!=</span>&nbsp;<span class="ident" id="3974730">nil</span>&nbsp;<span class="op" id="3974734">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3974738">t</span><span class="op" id="3974739">.</span><span class="ident" id="3974740">setReqCanceler</span><span class="op" id="3974754">(</span><span class="ident" id="3974755">req</span><span class="op" id="3974758">,</span>&nbsp;<span class="ident" id="3974760">nil</span><span class="op" id="3974763">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3974767">req</span><span class="op" id="3974770">.</span><span class="ident" id="3974771">closeBody</span><span class="op" id="3974780">(</span><span class="op" id="3974781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3974785">return</span>&nbsp;<span class="ident" id="3974792">nil</span><span class="op" id="3974795">,</span>&nbsp;<span class="ident" id="3974797">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3974802">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3974806">return</span>&nbsp;<span class="ident" id="3974813">pconn</span><span class="op" id="3974818">.</span><span class="ident" id="3974819">roundTrip</span><span class="op" id="3974828">(</span><span class="ident" id="3974829">treq</span><span class="op" id="3974833">)</span><br>
<span class="lineno"></span><span class="op" id="3974835">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3974838">//&nbsp;RegisterProtocol&nbsp;registers&nbsp;a&nbsp;new&nbsp;protocol&nbsp;with&nbsp;scheme.</span><br>
<span class="lineno"></span><span class="comment" id="3974896">//&nbsp;The&nbsp;Transport&nbsp;will&nbsp;pass&nbsp;requests&nbsp;using&nbsp;the&nbsp;given&nbsp;scheme&nbsp;to&nbsp;rt.</span><br>
<span class="lineno">240</span><span class="comment" id="3974962">//&nbsp;It&nbsp;is&nbsp;rt&#39;s&nbsp;responsibility&nbsp;to&nbsp;simulate&nbsp;HTTP&nbsp;request&nbsp;semantics.</span><br>
<span class="lineno"></span><span class="comment" id="3975027">//</span><br>
<span class="lineno"></span><span class="comment" id="3975030">//&nbsp;RegisterProtocol&nbsp;can&nbsp;be&nbsp;used&nbsp;by&nbsp;other&nbsp;packages&nbsp;to&nbsp;provide</span><br>
<span class="lineno"></span><span class="comment" id="3975091">//&nbsp;implementations&nbsp;of&nbsp;protocol&nbsp;schemes&nbsp;like&nbsp;&#34;ftp&#34;&nbsp;or&nbsp;&#34;file&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="3975152">func</span>&nbsp;<span class="op" id="3975157">(</span><span class="ident" id="3975158">t</span>&nbsp;<span class="op" id="3975160">*</span><span class="ident" id="3975161">Transport</span><span class="op" id="3975170">)</span>&nbsp;<span class="ident" id="3975172">RegisterProtocol</span><span class="op" id="3975188">(</span><span class="ident" id="3975189">scheme</span>&nbsp;<span class="builtintype" id="3975196">string</span><span class="op" id="3975202">,</span>&nbsp;<span class="ident" id="3975204">rt</span>&nbsp;<span class="ident" id="3975207">RoundTripper</span><span class="op" id="3975219">)</span>&nbsp;<span class="op" id="3975221">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3975224">if</span>&nbsp;<span class="ident" id="3975227">scheme</span>&nbsp;<span class="op" id="3975234">==</span>&nbsp;<span class="string" id="3975237">&#34;http&#34;</span>&nbsp;<span class="op" id="3975244">||</span>&nbsp;<span class="ident" id="3975247">scheme</span>&nbsp;<span class="op" id="3975254">==</span>&nbsp;<span class="string" id="3975257">&#34;https&#34;</span>&nbsp;<span class="op" id="3975265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3975269">panic</span><span class="op" id="3975274">(</span><span class="string" id="3975275">&#34;protocol&nbsp;&#34;</span>&nbsp;<span class="op" id="3975287">+</span>&nbsp;<span class="ident" id="3975289">scheme</span>&nbsp;<span class="op" id="3975296">+</span>&nbsp;<span class="string" id="3975298">&#34;&nbsp;already&nbsp;registered&#34;</span><span class="op" id="3975319">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3975322">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3975325">t</span><span class="op" id="3975326">.</span><span class="ident" id="3975327">altMu</span><span class="op" id="3975332">.</span><span class="ident" id="3975333">Lock</span><span class="op" id="3975337">(</span><span class="op" id="3975338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3975341">defer</span>&nbsp;<span class="ident" id="3975347">t</span><span class="op" id="3975348">.</span><span class="ident" id="3975349">altMu</span><span class="op" id="3975354">.</span><span class="ident" id="3975355">Unlock</span><span class="op" id="3975361">(</span><span class="op" id="3975362">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3975365">if</span>&nbsp;<span class="ident" id="3975368">t</span><span class="op" id="3975369">.</span><span class="ident" id="3975370">altProto</span>&nbsp;<span class="op" id="3975379">==</span>&nbsp;<span class="ident" id="3975382">nil</span>&nbsp;<span class="op" id="3975386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3975390">t</span><span class="op" id="3975391">.</span><span class="ident" id="3975392">altProto</span>&nbsp;<span class="op" id="3975401">=</span>&nbsp;<span class="builtinfunc" id="3975403">make</span><span class="op" id="3975407">(</span><span class="keyword" id="3975408">map</span><span class="op" id="3975411">[</span><span class="builtintype" id="3975412">string</span><span class="op" id="3975418">]</span><span class="ident" id="3975419">RoundTripper</span><span class="op" id="3975431">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3975434">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3975437">if</span>&nbsp;<span class="ident" id="3975440">_</span><span class="op" id="3975441">,</span>&nbsp;<span class="ident" id="3975443">exists</span>&nbsp;<span class="op" id="3975450">:=</span>&nbsp;<span class="ident" id="3975453">t</span><span class="op" id="3975454">.</span><span class="ident" id="3975455">altProto</span><span class="op" id="3975463">[</span><span class="ident" id="3975464">scheme</span><span class="op" id="3975470">]</span><span class="op" id="3975471">;</span>&nbsp;<span class="ident" id="3975473">exists</span>&nbsp;<span class="op" id="3975480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3975484">panic</span><span class="op" id="3975489">(</span><span class="string" id="3975490">&#34;protocol&nbsp;&#34;</span>&nbsp;<span class="op" id="3975502">+</span>&nbsp;<span class="ident" id="3975504">scheme</span>&nbsp;<span class="op" id="3975511">+</span>&nbsp;<span class="string" id="3975513">&#34;&nbsp;already&nbsp;registered&#34;</span><span class="op" id="3975534">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3975537">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3975540">t</span><span class="op" id="3975541">.</span><span class="ident" id="3975542">altProto</span><span class="op" id="3975550">[</span><span class="ident" id="3975551">scheme</span><span class="op" id="3975557">]</span>&nbsp;<span class="op" id="3975559">=</span>&nbsp;<span class="ident" id="3975561">rt</span><br>
<span class="lineno"></span><span class="op" id="3975564">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3975567">//&nbsp;CloseIdleConnections&nbsp;closes&nbsp;any&nbsp;connections&nbsp;which&nbsp;were&nbsp;previously</span><br>
<span class="lineno">260</span><span class="comment" id="3975636">//&nbsp;connected&nbsp;from&nbsp;previous&nbsp;requests&nbsp;but&nbsp;are&nbsp;now&nbsp;sitting&nbsp;idle&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="3975700">//&nbsp;a&nbsp;&#34;keep-alive&#34;&nbsp;state.&nbsp;It&nbsp;does&nbsp;not&nbsp;interrupt&nbsp;any&nbsp;connections&nbsp;currently</span><br>
<span class="lineno"></span><span class="comment" id="3975773">//&nbsp;in&nbsp;use.</span><br>
<span class="lineno"></span><span class="keyword" id="3975784">func</span>&nbsp;<span class="op" id="3975789">(</span><span class="ident" id="3975790">t</span>&nbsp;<span class="op" id="3975792">*</span><span class="ident" id="3975793">Transport</span><span class="op" id="3975802">)</span>&nbsp;<span class="ident" id="3975804">CloseIdleConnections</span><span class="op" id="3975824">(</span><span class="op" id="3975825">)</span>&nbsp;<span class="op" id="3975827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3975830">t</span><span class="op" id="3975831">.</span><span class="ident" id="3975832">idleMu</span><span class="op" id="3975838">.</span><span class="ident" id="3975839">Lock</span><span class="op" id="3975843">(</span><span class="op" id="3975844">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3975847">m</span>&nbsp;<span class="op" id="3975849">:=</span>&nbsp;<span class="ident" id="3975852">t</span><span class="op" id="3975853">.</span><span class="ident" id="3975854">idleConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3975864">t</span><span class="op" id="3975865">.</span><span class="ident" id="3975866">idleConn</span>&nbsp;<span class="op" id="3975875">=</span>&nbsp;<span class="ident" id="3975877">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3975882">t</span><span class="op" id="3975883">.</span><span class="ident" id="3975884">idleConnCh</span>&nbsp;<span class="op" id="3975895">=</span>&nbsp;<span class="ident" id="3975897">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3975902">t</span><span class="op" id="3975903">.</span><span class="ident" id="3975904">wantIdle</span>&nbsp;<span class="op" id="3975913">=</span>&nbsp;<span class="builtintype" id="3975915">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3975921">t</span><span class="op" id="3975922">.</span><span class="ident" id="3975923">idleMu</span><span class="op" id="3975929">.</span><span class="ident" id="3975930">Unlock</span><span class="op" id="3975936">(</span><span class="op" id="3975937">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3975940">for</span>&nbsp;<span class="ident" id="3975944">_</span><span class="op" id="3975945">,</span>&nbsp;<span class="ident" id="3975947">conns</span>&nbsp;<span class="op" id="3975953">:=</span>&nbsp;<span class="keyword" id="3975956">range</span>&nbsp;<span class="ident" id="3975962">m</span>&nbsp;<span class="op" id="3975964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3975968">for</span>&nbsp;<span class="ident" id="3975972">_</span><span class="op" id="3975973">,</span>&nbsp;<span class="ident" id="3975975">pconn</span>&nbsp;<span class="op" id="3975981">:=</span>&nbsp;<span class="keyword" id="3975984">range</span>&nbsp;<span class="ident" id="3975990">conns</span>&nbsp;<span class="op" id="3975996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3976001">pconn</span><span class="op" id="3976006">.</span><span class="builtinfunc" id="3976007">close</span><span class="op" id="3976012">(</span><span class="op" id="3976013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3976017">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3976020">}</span><br>
<span class="lineno">275</span><span class="op" id="3976022">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3976025">//&nbsp;CancelRequest&nbsp;cancels&nbsp;an&nbsp;in-flight&nbsp;request&nbsp;by&nbsp;closing&nbsp;its</span><br>
<span class="lineno"></span><span class="comment" id="3976086">//&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3976101">func</span>&nbsp;<span class="op" id="3976106">(</span><span class="ident" id="3976107">t</span>&nbsp;<span class="op" id="3976109">*</span><span class="ident" id="3976110">Transport</span><span class="op" id="3976119">)</span>&nbsp;<span class="ident" id="3976121">CancelRequest</span><span class="op" id="3976134">(</span><span class="ident" id="3976135">req</span>&nbsp;<span class="op" id="3976139">*</span><span class="ident" id="3976140">Request</span><span class="op" id="3976147">)</span>&nbsp;<span class="op" id="3976149">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3976152">t</span><span class="op" id="3976153">.</span><span class="ident" id="3976154">reqMu</span><span class="op" id="3976159">.</span><span class="ident" id="3976160">Lock</span><span class="op" id="3976164">(</span><span class="op" id="3976165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3976168">cancel</span>&nbsp;<span class="op" id="3976175">:=</span>&nbsp;<span class="ident" id="3976178">t</span><span class="op" id="3976179">.</span><span class="ident" id="3976180">reqCanceler</span><span class="op" id="3976191">[</span><span class="ident" id="3976192">req</span><span class="op" id="3976195">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3976198">t</span><span class="op" id="3976199">.</span><span class="ident" id="3976200">reqMu</span><span class="op" id="3976205">.</span><span class="ident" id="3976206">Unlock</span><span class="op" id="3976212">(</span><span class="op" id="3976213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3976216">if</span>&nbsp;<span class="ident" id="3976219">cancel</span>&nbsp;<span class="op" id="3976226">!=</span>&nbsp;<span class="ident" id="3976229">nil</span>&nbsp;<span class="op" id="3976233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3976237">cancel</span><span class="op" id="3976243">(</span><span class="op" id="3976244">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3976247">}</span><br>
<span class="lineno"></span><span class="op" id="3976249">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3976252">//</span><br>
<span class="lineno"></span><span class="comment" id="3976255">//&nbsp;Private&nbsp;implementation&nbsp;past&nbsp;this&nbsp;point.</span><br>
<span class="lineno">290</span><span class="comment" id="3976298">//</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3976302">var</span>&nbsp;<span class="op" id="3976306">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3976309">httpProxyEnv</span>&nbsp;<span class="op" id="3976322">=</span>&nbsp;<span class="op" id="3976324">&amp;</span><span class="ident" id="3976325">envOnce</span><span class="op" id="3976332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3976336">names</span><span class="op" id="3976341">:</span>&nbsp;<span class="op" id="3976343">[</span><span class="op" id="3976344">]</span><span class="builtintype" id="3976345">string</span><span class="op" id="3976351">{</span><span class="string" id="3976352">&#34;HTTP_PROXY&#34;</span><span class="op" id="3976364">,</span>&nbsp;<span class="string" id="3976366">&#34;http_proxy&#34;</span><span class="op" id="3976378">}</span><span class="op" id="3976379">,</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3976382">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3976385">httpsProxyEnv</span>&nbsp;<span class="op" id="3976399">=</span>&nbsp;<span class="op" id="3976401">&amp;</span><span class="ident" id="3976402">envOnce</span><span class="op" id="3976409">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3976413">names</span><span class="op" id="3976418">:</span>&nbsp;<span class="op" id="3976420">[</span><span class="op" id="3976421">]</span><span class="builtintype" id="3976422">string</span><span class="op" id="3976428">{</span><span class="string" id="3976429">&#34;HTTPS_PROXY&#34;</span><span class="op" id="3976442">,</span>&nbsp;<span class="string" id="3976444">&#34;https_proxy&#34;</span><span class="op" id="3976457">}</span><span class="op" id="3976458">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3976461">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3976464">noProxyEnv</span>&nbsp;<span class="op" id="3976475">=</span>&nbsp;<span class="op" id="3976477">&amp;</span><span class="ident" id="3976478">envOnce</span><span class="op" id="3976485">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3976489">names</span><span class="op" id="3976494">:</span>&nbsp;<span class="op" id="3976496">[</span><span class="op" id="3976497">]</span><span class="builtintype" id="3976498">string</span><span class="op" id="3976504">{</span><span class="string" id="3976505">&#34;NO_PROXY&#34;</span><span class="op" id="3976515">,</span>&nbsp;<span class="string" id="3976517">&#34;no_proxy&#34;</span><span class="op" id="3976527">}</span><span class="op" id="3976528">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3976531">}</span><br>
<span class="lineno"></span><span class="op" id="3976533">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3976536">//&nbsp;envOnce&nbsp;looks&nbsp;up&nbsp;an&nbsp;environment&nbsp;variable&nbsp;(optionally&nbsp;by&nbsp;multiple</span><br>
<span class="lineno">305</span><span class="comment" id="3976604">//&nbsp;names)&nbsp;once.&nbsp;It&nbsp;mitigates&nbsp;expensive&nbsp;lookups&nbsp;on&nbsp;some&nbsp;platforms</span><br>
<span class="lineno"></span><span class="comment" id="3976669">//&nbsp;(e.g.&nbsp;Windows).</span><br>
<span class="lineno"></span><span class="keyword" id="3976688">type</span>&nbsp;<span class="ident" id="3976693">envOnce</span>&nbsp;<span class="keyword" id="3976701">struct</span>&nbsp;<span class="op" id="3976708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3976711">names</span>&nbsp;<span class="op" id="3976717">[</span><span class="op" id="3976718">]</span><span class="builtintype" id="3976719">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3976727">once</span>&nbsp;&nbsp;<span class="ident" id="3976733">sync</span><span class="op" id="3976737">.</span><span class="ident" id="3976738">Once</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3976744">val</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3976750">string</span><br>
<span class="lineno"></span><span class="op" id="3976757">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3976760">func</span>&nbsp;<span class="op" id="3976765">(</span><span class="ident" id="3976766">e</span>&nbsp;<span class="op" id="3976768">*</span><span class="ident" id="3976769">envOnce</span><span class="op" id="3976776">)</span>&nbsp;<span class="ident" id="3976778">Get</span><span class="op" id="3976781">(</span><span class="op" id="3976782">)</span>&nbsp;<span class="builtintype" id="3976784">string</span>&nbsp;<span class="op" id="3976791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3976794">e</span><span class="op" id="3976795">.</span><span class="ident" id="3976796">once</span><span class="op" id="3976800">.</span><span class="ident" id="3976801">Do</span><span class="op" id="3976803">(</span><span class="ident" id="3976804">e</span><span class="op" id="3976805">.</span><span class="ident" id="3976806">init</span><span class="op" id="3976810">)</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3976813">return</span>&nbsp;<span class="ident" id="3976820">e</span><span class="op" id="3976821">.</span><span class="ident" id="3976822">val</span><br>
<span class="lineno"></span><span class="op" id="3976826">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3976829">func</span>&nbsp;<span class="op" id="3976834">(</span><span class="ident" id="3976835">e</span>&nbsp;<span class="op" id="3976837">*</span><span class="ident" id="3976838">envOnce</span><span class="op" id="3976845">)</span>&nbsp;<span class="ident" id="3976847">init</span><span class="op" id="3976851">(</span><span class="op" id="3976852">)</span>&nbsp;<span class="op" id="3976854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3976857">for</span>&nbsp;<span class="ident" id="3976861">_</span><span class="op" id="3976862">,</span>&nbsp;<span class="ident" id="3976864">n</span>&nbsp;<span class="op" id="3976866">:=</span>&nbsp;<span class="keyword" id="3976869">range</span>&nbsp;<span class="ident" id="3976875">e</span><span class="op" id="3976876">.</span><span class="ident" id="3976877">names</span>&nbsp;<span class="op" id="3976883">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3976887">e</span><span class="op" id="3976888">.</span><span class="ident" id="3976889">val</span>&nbsp;<span class="op" id="3976893">=</span>&nbsp;<span class="ident" id="3976895">os</span><span class="op" id="3976897">.</span><span class="ident" id="3976898">Getenv</span><span class="op" id="3976904">(</span><span class="ident" id="3976905">n</span><span class="op" id="3976906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3976910">if</span>&nbsp;<span class="ident" id="3976913">e</span><span class="op" id="3976914">.</span><span class="ident" id="3976915">val</span>&nbsp;<span class="op" id="3976919">!=</span>&nbsp;<span class="string" id="3976922">&#34;&#34;</span>&nbsp;<span class="op" id="3976925">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3976930">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3976939">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3976942">}</span><br>
<span class="lineno">325</span><span class="op" id="3976944">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3976947">//&nbsp;reset&nbsp;is&nbsp;used&nbsp;by&nbsp;tests</span><br>
<span class="lineno"></span><span class="keyword" id="3976973">func</span>&nbsp;<span class="op" id="3976978">(</span><span class="ident" id="3976979">e</span>&nbsp;<span class="op" id="3976981">*</span><span class="ident" id="3976982">envOnce</span><span class="op" id="3976989">)</span>&nbsp;<span class="ident" id="3976991">reset</span><span class="op" id="3976996">(</span><span class="op" id="3976997">)</span>&nbsp;<span class="op" id="3976999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3977002">e</span><span class="op" id="3977003">.</span><span class="ident" id="3977004">once</span>&nbsp;<span class="op" id="3977009">=</span>&nbsp;<span class="ident" id="3977011">sync</span><span class="op" id="3977015">.</span><span class="ident" id="3977016">Once</span><span class="op" id="3977020">{</span><span class="op" id="3977021">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3977024">e</span><span class="op" id="3977025">.</span><span class="ident" id="3977026">val</span>&nbsp;<span class="op" id="3977030">=</span>&nbsp;<span class="string" id="3977032">&#34;&#34;</span><br>
<span class="lineno"></span><span class="op" id="3977035">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3977038">func</span>&nbsp;<span class="op" id="3977043">(</span><span class="ident" id="3977044">t</span>&nbsp;<span class="op" id="3977046">*</span><span class="ident" id="3977047">Transport</span><span class="op" id="3977056">)</span>&nbsp;<span class="ident" id="3977058">connectMethodForRequest</span><span class="op" id="3977081">(</span><span class="ident" id="3977082">treq</span>&nbsp;<span class="op" id="3977087">*</span><span class="ident" id="3977088">transportRequest</span><span class="op" id="3977104">)</span>&nbsp;<span class="op" id="3977106">(</span><span class="ident" id="3977107">cm</span>&nbsp;<span class="ident" id="3977110">connectMethod</span><span class="op" id="3977123">,</span>&nbsp;<span class="ident" id="3977125">err</span>&nbsp;<span class="builtintype" id="3977129">error</span><span class="op" id="3977134">)</span>&nbsp;<span class="op" id="3977136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3977139">cm</span><span class="op" id="3977141">.</span><span class="ident" id="3977142">targetScheme</span>&nbsp;<span class="op" id="3977155">=</span>&nbsp;<span class="ident" id="3977157">treq</span><span class="op" id="3977161">.</span><span class="ident" id="3977162">URL</span><span class="op" id="3977165">.</span><span class="ident" id="3977166">Scheme</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3977174">cm</span><span class="op" id="3977176">.</span><span class="ident" id="3977177">targetAddr</span>&nbsp;<span class="op" id="3977188">=</span>&nbsp;<span class="ident" id="3977190">canonicalAddr</span><span class="op" id="3977203">(</span><span class="ident" id="3977204">treq</span><span class="op" id="3977208">.</span><span class="ident" id="3977209">URL</span><span class="op" id="3977212">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3977215">if</span>&nbsp;<span class="ident" id="3977218">t</span><span class="op" id="3977219">.</span><span class="ident" id="3977220">Proxy</span>&nbsp;<span class="op" id="3977226">!=</span>&nbsp;<span class="ident" id="3977229">nil</span>&nbsp;<span class="op" id="3977233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3977237">cm</span><span class="op" id="3977239">.</span><span class="ident" id="3977240">proxyURL</span><span class="op" id="3977248">,</span>&nbsp;<span class="ident" id="3977250">err</span>&nbsp;<span class="op" id="3977254">=</span>&nbsp;<span class="ident" id="3977256">t</span><span class="op" id="3977257">.</span><span class="ident" id="3977258">Proxy</span><span class="op" id="3977263">(</span><span class="ident" id="3977264">treq</span><span class="op" id="3977268">.</span><span class="ident" id="3977269">Request</span><span class="op" id="3977276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3977279">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3977282">return</span>&nbsp;<span class="ident" id="3977289">cm</span><span class="op" id="3977291">,</span>&nbsp;<span class="ident" id="3977293">err</span><br>
<span class="lineno">340</span><span class="op" id="3977297">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3977300">//&nbsp;proxyAuth&nbsp;returns&nbsp;the&nbsp;Proxy-Authorization&nbsp;header&nbsp;to&nbsp;set</span><br>
<span class="lineno"></span><span class="comment" id="3977359">//&nbsp;on&nbsp;requests,&nbsp;if&nbsp;applicable.</span><br>
<span class="lineno"></span><span class="keyword" id="3977390">func</span>&nbsp;<span class="op" id="3977395">(</span><span class="ident" id="3977396">cm</span>&nbsp;<span class="op" id="3977399">*</span><span class="ident" id="3977400">connectMethod</span><span class="op" id="3977413">)</span>&nbsp;<span class="ident" id="3977415">proxyAuth</span><span class="op" id="3977424">(</span><span class="op" id="3977425">)</span>&nbsp;<span class="builtintype" id="3977427">string</span>&nbsp;<span class="op" id="3977434">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3977437">if</span>&nbsp;<span class="ident" id="3977440">cm</span><span class="op" id="3977442">.</span><span class="ident" id="3977443">proxyURL</span>&nbsp;<span class="op" id="3977452">==</span>&nbsp;<span class="ident" id="3977455">nil</span>&nbsp;<span class="op" id="3977459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3977463">return</span>&nbsp;<span class="string" id="3977470">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3977474">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3977477">if</span>&nbsp;<span class="ident" id="3977480">u</span>&nbsp;<span class="op" id="3977482">:=</span>&nbsp;<span class="ident" id="3977485">cm</span><span class="op" id="3977487">.</span><span class="ident" id="3977488">proxyURL</span><span class="op" id="3977496">.</span><span class="ident" id="3977497">User</span><span class="op" id="3977501">;</span>&nbsp;<span class="ident" id="3977503">u</span>&nbsp;<span class="op" id="3977505">!=</span>&nbsp;<span class="ident" id="3977508">nil</span>&nbsp;<span class="op" id="3977512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3977516">username</span>&nbsp;<span class="op" id="3977525">:=</span>&nbsp;<span class="ident" id="3977528">u</span><span class="op" id="3977529">.</span><span class="ident" id="3977530">Username</span><span class="op" id="3977538">(</span><span class="op" id="3977539">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3977543">password</span><span class="op" id="3977551">,</span>&nbsp;<span class="ident" id="3977553">_</span>&nbsp;<span class="op" id="3977555">:=</span>&nbsp;<span class="ident" id="3977558">u</span><span class="op" id="3977559">.</span><span class="ident" id="3977560">Password</span><span class="op" id="3977568">(</span><span class="op" id="3977569">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3977573">return</span>&nbsp;<span class="string" id="3977580">&#34;Basic&nbsp;&#34;</span>&nbsp;<span class="op" id="3977589">+</span>&nbsp;<span class="ident" id="3977591">basicAuth</span><span class="op" id="3977600">(</span><span class="ident" id="3977601">username</span><span class="op" id="3977609">,</span>&nbsp;<span class="ident" id="3977611">password</span><span class="op" id="3977619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3977622">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3977625">return</span>&nbsp;<span class="string" id="3977632">&#34;&#34;</span><br>
<span class="lineno"></span><span class="op" id="3977635">}</span><br>
<span class="lineno">355</span><br>
<span class="lineno"></span><span class="comment" id="3977638">//&nbsp;putIdleConn&nbsp;adds&nbsp;pconn&nbsp;to&nbsp;the&nbsp;list&nbsp;of&nbsp;idle&nbsp;persistent&nbsp;connections&nbsp;awaiting</span><br>
<span class="lineno"></span><span class="comment" id="3977716">//&nbsp;a&nbsp;new&nbsp;request.</span><br>
<span class="lineno"></span><span class="comment" id="3977734">//&nbsp;If&nbsp;pconn&nbsp;is&nbsp;no&nbsp;longer&nbsp;needed&nbsp;or&nbsp;not&nbsp;in&nbsp;a&nbsp;good&nbsp;state,&nbsp;putIdleConn</span><br>
<span class="lineno"></span><span class="comment" id="3977802">//&nbsp;returns&nbsp;false.</span><br>
<span class="lineno">360</span><span class="keyword" id="3977820">func</span>&nbsp;<span class="op" id="3977825">(</span><span class="ident" id="3977826">t</span>&nbsp;<span class="op" id="3977828">*</span><span class="ident" id="3977829">Transport</span><span class="op" id="3977838">)</span>&nbsp;<span class="ident" id="3977840">putIdleConn</span><span class="op" id="3977851">(</span><span class="ident" id="3977852">pconn</span>&nbsp;<span class="op" id="3977858">*</span><span class="ident" id="3977859">persistConn</span><span class="op" id="3977870">)</span>&nbsp;<span class="builtintype" id="3977872">bool</span>&nbsp;<span class="op" id="3977877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3977880">if</span>&nbsp;<span class="ident" id="3977883">t</span><span class="op" id="3977884">.</span><span class="ident" id="3977885">DisableKeepAlives</span>&nbsp;<span class="op" id="3977903">||</span>&nbsp;<span class="ident" id="3977906">t</span><span class="op" id="3977907">.</span><span class="ident" id="3977908">MaxIdleConnsPerHost</span>&nbsp;<span class="op" id="3977928">&lt;</span>&nbsp;<span class="num" id="3977930">0</span>&nbsp;<span class="op" id="3977932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3977936">pconn</span><span class="op" id="3977941">.</span><span class="builtinfunc" id="3977942">close</span><span class="op" id="3977947">(</span><span class="op" id="3977948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3977952">return</span>&nbsp;<span class="builtintype" id="3977959">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3977966">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3977969">if</span>&nbsp;<span class="ident" id="3977972">pconn</span><span class="op" id="3977977">.</span><span class="ident" id="3977978">isBroken</span><span class="op" id="3977986">(</span><span class="op" id="3977987">)</span>&nbsp;<span class="op" id="3977989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3977993">return</span>&nbsp;<span class="builtintype" id="3978000">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3978007">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3978010">key</span>&nbsp;<span class="op" id="3978014">:=</span>&nbsp;<span class="ident" id="3978017">pconn</span><span class="op" id="3978022">.</span><span class="ident" id="3978023">cacheKey</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3978033">max</span>&nbsp;<span class="op" id="3978037">:=</span>&nbsp;<span class="ident" id="3978040">t</span><span class="op" id="3978041">.</span><span class="ident" id="3978042">MaxIdleConnsPerHost</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3978063">if</span>&nbsp;<span class="ident" id="3978066">max</span>&nbsp;<span class="op" id="3978070">==</span>&nbsp;<span class="num" id="3978073">0</span>&nbsp;<span class="op" id="3978075">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3978079">max</span>&nbsp;<span class="op" id="3978083">=</span>&nbsp;<span class="ident" id="3978085">DefaultMaxIdleConnsPerHost</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3978113">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3978116">t</span><span class="op" id="3978117">.</span><span class="ident" id="3978118">idleMu</span><span class="op" id="3978124">.</span><span class="ident" id="3978125">Lock</span><span class="op" id="3978129">(</span><span class="op" id="3978130">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3978134">waitingDialer</span>&nbsp;<span class="op" id="3978148">:=</span>&nbsp;<span class="ident" id="3978151">t</span><span class="op" id="3978152">.</span><span class="ident" id="3978153">idleConnCh</span><span class="op" id="3978163">[</span><span class="ident" id="3978164">key</span><span class="op" id="3978167">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3978170">select</span>&nbsp;<span class="op" id="3978177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3978180">case</span>&nbsp;<span class="ident" id="3978185">waitingDialer</span>&nbsp;<span class="op" id="3978199">&lt;-</span>&nbsp;<span class="ident" id="3978202">pconn</span><span class="op" id="3978207">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3978211">//&nbsp;We&#39;re&nbsp;done&nbsp;with&nbsp;this&nbsp;pconn&nbsp;and&nbsp;somebody&nbsp;else&nbsp;is</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3978264">//&nbsp;currently&nbsp;waiting&nbsp;for&nbsp;a&nbsp;conn&nbsp;of&nbsp;this&nbsp;type&nbsp;(they&#39;re</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3978320">//&nbsp;actively&nbsp;dialing,&nbsp;but&nbsp;this&nbsp;conn&nbsp;is&nbsp;ready</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3978366">//&nbsp;first).&nbsp;Chrome&nbsp;calls&nbsp;this&nbsp;socket&nbsp;late&nbsp;binding.&nbsp;&nbsp;See</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3978423">//&nbsp;https://insouciant.org/tech/connection-management-in-chromium/</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3978491">t</span><span class="op" id="3978492">.</span><span class="ident" id="3978493">idleMu</span><span class="op" id="3978499">.</span><span class="ident" id="3978500">Unlock</span><span class="op" id="3978506">(</span><span class="op" id="3978507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3978511">return</span>&nbsp;<span class="builtintype" id="3978518">true</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3978524">default</span><span class="op" id="3978531">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3978535">if</span>&nbsp;<span class="ident" id="3978538">waitingDialer</span>&nbsp;<span class="op" id="3978552">!=</span>&nbsp;<span class="ident" id="3978555">nil</span>&nbsp;<span class="op" id="3978559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3978564">//&nbsp;They&nbsp;had&nbsp;populated&nbsp;this,&nbsp;but&nbsp;their&nbsp;dial&nbsp;won</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3978614">//&nbsp;first,&nbsp;so&nbsp;we&nbsp;can&nbsp;clean&nbsp;up&nbsp;this&nbsp;map&nbsp;entry.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3978662">delete</span><span class="op" id="3978668">(</span><span class="ident" id="3978669">t</span><span class="op" id="3978670">.</span><span class="ident" id="3978671">idleConnCh</span><span class="op" id="3978681">,</span>&nbsp;<span class="ident" id="3978683">key</span><span class="op" id="3978686">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3978690">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3978693">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3978696">if</span>&nbsp;<span class="ident" id="3978699">t</span><span class="op" id="3978700">.</span><span class="ident" id="3978701">wantIdle</span>&nbsp;<span class="op" id="3978710">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3978714">t</span><span class="op" id="3978715">.</span><span class="ident" id="3978716">idleMu</span><span class="op" id="3978722">.</span><span class="ident" id="3978723">Unlock</span><span class="op" id="3978729">(</span><span class="op" id="3978730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3978734">pconn</span><span class="op" id="3978739">.</span><span class="builtinfunc" id="3978740">close</span><span class="op" id="3978745">(</span><span class="op" id="3978746">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3978750">return</span>&nbsp;<span class="builtintype" id="3978757">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3978764">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3978767">if</span>&nbsp;<span class="ident" id="3978770">t</span><span class="op" id="3978771">.</span><span class="ident" id="3978772">idleConn</span>&nbsp;<span class="op" id="3978781">==</span>&nbsp;<span class="ident" id="3978784">nil</span>&nbsp;<span class="op" id="3978788">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3978792">t</span><span class="op" id="3978793">.</span><span class="ident" id="3978794">idleConn</span>&nbsp;<span class="op" id="3978803">=</span>&nbsp;<span class="builtinfunc" id="3978805">make</span><span class="op" id="3978809">(</span><span class="keyword" id="3978810">map</span><span class="op" id="3978813">[</span><span class="ident" id="3978814">connectMethodKey</span><span class="op" id="3978830">]</span><span class="op" id="3978831">[</span><span class="op" id="3978832">]</span><span class="op" id="3978833">*</span><span class="ident" id="3978834">persistConn</span><span class="op" id="3978845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3978848">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3978851">if</span>&nbsp;<span class="builtinfunc" id="3978854">len</span><span class="op" id="3978857">(</span><span class="ident" id="3978858">t</span><span class="op" id="3978859">.</span><span class="ident" id="3978860">idleConn</span><span class="op" id="3978868">[</span><span class="ident" id="3978869">key</span><span class="op" id="3978872">]</span><span class="op" id="3978873">)</span>&nbsp;<span class="op" id="3978875">&gt;=</span>&nbsp;<span class="ident" id="3978878">max</span>&nbsp;<span class="op" id="3978882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3978886">t</span><span class="op" id="3978887">.</span><span class="ident" id="3978888">idleMu</span><span class="op" id="3978894">.</span><span class="ident" id="3978895">Unlock</span><span class="op" id="3978901">(</span><span class="op" id="3978902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3978906">pconn</span><span class="op" id="3978911">.</span><span class="builtinfunc" id="3978912">close</span><span class="op" id="3978917">(</span><span class="op" id="3978918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3978922">return</span>&nbsp;<span class="builtintype" id="3978929">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3978936">}</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3978939">for</span>&nbsp;<span class="ident" id="3978943">_</span><span class="op" id="3978944">,</span>&nbsp;<span class="ident" id="3978946">exist</span>&nbsp;<span class="op" id="3978952">:=</span>&nbsp;<span class="keyword" id="3978955">range</span>&nbsp;<span class="ident" id="3978961">t</span><span class="op" id="3978962">.</span><span class="ident" id="3978963">idleConn</span><span class="op" id="3978971">[</span><span class="ident" id="3978972">key</span><span class="op" id="3978975">]</span>&nbsp;<span class="op" id="3978977">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3978981">if</span>&nbsp;<span class="ident" id="3978984">exist</span>&nbsp;<span class="op" id="3978990">==</span>&nbsp;<span class="ident" id="3978993">pconn</span>&nbsp;<span class="op" id="3978999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3979004">log</span><span class="op" id="3979007">.</span><span class="ident" id="3979008">Fatalf</span><span class="op" id="3979014">(</span><span class="string" id="3979015">&#34;dup&nbsp;idle&nbsp;pconn&nbsp;%p&nbsp;in&nbsp;freelist&#34;</span><span class="op" id="3979046">,</span>&nbsp;<span class="ident" id="3979048">pconn</span><span class="op" id="3979053">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3979057">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3979060">}</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3979063">t</span><span class="op" id="3979064">.</span><span class="ident" id="3979065">idleConn</span><span class="op" id="3979073">[</span><span class="ident" id="3979074">key</span><span class="op" id="3979077">]</span>&nbsp;<span class="op" id="3979079">=</span>&nbsp;<span class="builtinfunc" id="3979081">append</span><span class="op" id="3979087">(</span><span class="ident" id="3979088">t</span><span class="op" id="3979089">.</span><span class="ident" id="3979090">idleConn</span><span class="op" id="3979098">[</span><span class="ident" id="3979099">key</span><span class="op" id="3979102">]</span><span class="op" id="3979103">,</span>&nbsp;<span class="ident" id="3979105">pconn</span><span class="op" id="3979110">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3979113">t</span><span class="op" id="3979114">.</span><span class="ident" id="3979115">idleMu</span><span class="op" id="3979121">.</span><span class="ident" id="3979122">Unlock</span><span class="op" id="3979128">(</span><span class="op" id="3979129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3979132">return</span>&nbsp;<span class="builtintype" id="3979139">true</span><br>
<span class="lineno"></span><span class="op" id="3979144">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span><span class="comment" id="3979147">//&nbsp;getIdleConnCh&nbsp;returns&nbsp;a&nbsp;channel&nbsp;to&nbsp;receive&nbsp;and&nbsp;return&nbsp;idle</span><br>
<span class="lineno"></span><span class="comment" id="3979209">//&nbsp;persistent&nbsp;connection&nbsp;for&nbsp;the&nbsp;given&nbsp;connectMethod.</span><br>
<span class="lineno"></span><span class="comment" id="3979263">//&nbsp;It&nbsp;may&nbsp;return&nbsp;nil,&nbsp;if&nbsp;persistent&nbsp;connections&nbsp;are&nbsp;not&nbsp;being&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="3979331">func</span>&nbsp;<span class="op" id="3979336">(</span><span class="ident" id="3979337">t</span>&nbsp;<span class="op" id="3979339">*</span><span class="ident" id="3979340">Transport</span><span class="op" id="3979349">)</span>&nbsp;<span class="ident" id="3979351">getIdleConnCh</span><span class="op" id="3979364">(</span><span class="ident" id="3979365">cm</span>&nbsp;<span class="ident" id="3979368">connectMethod</span><span class="op" id="3979381">)</span>&nbsp;<span class="keyword" id="3979383">chan</span>&nbsp;<span class="op" id="3979388">*</span><span class="ident" id="3979389">persistConn</span>&nbsp;<span class="op" id="3979401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3979404">if</span>&nbsp;<span class="ident" id="3979407">t</span><span class="op" id="3979408">.</span><span class="ident" id="3979409">DisableKeepAlives</span>&nbsp;<span class="op" id="3979427">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3979431">return</span>&nbsp;<span class="ident" id="3979438">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3979443">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3979446">key</span>&nbsp;<span class="op" id="3979450">:=</span>&nbsp;<span class="ident" id="3979453">cm</span><span class="op" id="3979455">.</span><span class="ident" id="3979456">key</span><span class="op" id="3979459">(</span><span class="op" id="3979460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3979463">t</span><span class="op" id="3979464">.</span><span class="ident" id="3979465">idleMu</span><span class="op" id="3979471">.</span><span class="ident" id="3979472">Lock</span><span class="op" id="3979476">(</span><span class="op" id="3979477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3979480">defer</span>&nbsp;<span class="ident" id="3979486">t</span><span class="op" id="3979487">.</span><span class="ident" id="3979488">idleMu</span><span class="op" id="3979494">.</span><span class="ident" id="3979495">Unlock</span><span class="op" id="3979501">(</span><span class="op" id="3979502">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3979505">t</span><span class="op" id="3979506">.</span><span class="ident" id="3979507">wantIdle</span>&nbsp;<span class="op" id="3979516">=</span>&nbsp;<span class="builtintype" id="3979518">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3979525">if</span>&nbsp;<span class="ident" id="3979528">t</span><span class="op" id="3979529">.</span><span class="ident" id="3979530">idleConnCh</span>&nbsp;<span class="op" id="3979541">==</span>&nbsp;<span class="ident" id="3979544">nil</span>&nbsp;<span class="op" id="3979548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3979552">t</span><span class="op" id="3979553">.</span><span class="ident" id="3979554">idleConnCh</span>&nbsp;<span class="op" id="3979565">=</span>&nbsp;<span class="builtinfunc" id="3979567">make</span><span class="op" id="3979571">(</span><span class="keyword" id="3979572">map</span><span class="op" id="3979575">[</span><span class="ident" id="3979576">connectMethodKey</span><span class="op" id="3979592">]</span><span class="keyword" id="3979593">chan</span>&nbsp;<span class="op" id="3979598">*</span><span class="ident" id="3979599">persistConn</span><span class="op" id="3979610">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3979613">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3979616">ch</span><span class="op" id="3979618">,</span>&nbsp;<span class="ident" id="3979620">ok</span>&nbsp;<span class="op" id="3979623">:=</span>&nbsp;<span class="ident" id="3979626">t</span><span class="op" id="3979627">.</span><span class="ident" id="3979628">idleConnCh</span><span class="op" id="3979638">[</span><span class="ident" id="3979639">key</span><span class="op" id="3979642">]</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3979645">if</span>&nbsp;<span class="op" id="3979648">!</span><span class="ident" id="3979649">ok</span>&nbsp;<span class="op" id="3979652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3979656">ch</span>&nbsp;<span class="op" id="3979659">=</span>&nbsp;<span class="builtinfunc" id="3979661">make</span><span class="op" id="3979665">(</span><span class="keyword" id="3979666">chan</span>&nbsp;<span class="op" id="3979671">*</span><span class="ident" id="3979672">persistConn</span><span class="op" id="3979683">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3979687">t</span><span class="op" id="3979688">.</span><span class="ident" id="3979689">idleConnCh</span><span class="op" id="3979699">[</span><span class="ident" id="3979700">key</span><span class="op" id="3979703">]</span>&nbsp;<span class="op" id="3979705">=</span>&nbsp;<span class="ident" id="3979707">ch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3979711">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3979714">return</span>&nbsp;<span class="ident" id="3979721">ch</span><br>
<span class="lineno">435</span><span class="op" id="3979724">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3979727">func</span>&nbsp;<span class="op" id="3979732">(</span><span class="ident" id="3979733">t</span>&nbsp;<span class="op" id="3979735">*</span><span class="ident" id="3979736">Transport</span><span class="op" id="3979745">)</span>&nbsp;<span class="ident" id="3979747">getIdleConn</span><span class="op" id="3979758">(</span><span class="ident" id="3979759">cm</span>&nbsp;<span class="ident" id="3979762">connectMethod</span><span class="op" id="3979775">)</span>&nbsp;<span class="op" id="3979777">(</span><span class="ident" id="3979778">pconn</span>&nbsp;<span class="op" id="3979784">*</span><span class="ident" id="3979785">persistConn</span><span class="op" id="3979796">)</span>&nbsp;<span class="op" id="3979798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3979801">key</span>&nbsp;<span class="op" id="3979805">:=</span>&nbsp;<span class="ident" id="3979808">cm</span><span class="op" id="3979810">.</span><span class="ident" id="3979811">key</span><span class="op" id="3979814">(</span><span class="op" id="3979815">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3979818">t</span><span class="op" id="3979819">.</span><span class="ident" id="3979820">idleMu</span><span class="op" id="3979826">.</span><span class="ident" id="3979827">Lock</span><span class="op" id="3979831">(</span><span class="op" id="3979832">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3979835">defer</span>&nbsp;<span class="ident" id="3979841">t</span><span class="op" id="3979842">.</span><span class="ident" id="3979843">idleMu</span><span class="op" id="3979849">.</span><span class="ident" id="3979850">Unlock</span><span class="op" id="3979856">(</span><span class="op" id="3979857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3979860">if</span>&nbsp;<span class="ident" id="3979863">t</span><span class="op" id="3979864">.</span><span class="ident" id="3979865">idleConn</span>&nbsp;<span class="op" id="3979874">==</span>&nbsp;<span class="ident" id="3979877">nil</span>&nbsp;<span class="op" id="3979881">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3979885">return</span>&nbsp;<span class="ident" id="3979892">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3979897">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3979900">for</span>&nbsp;<span class="op" id="3979904">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3979908">pconns</span><span class="op" id="3979914">,</span>&nbsp;<span class="ident" id="3979916">ok</span>&nbsp;<span class="op" id="3979919">:=</span>&nbsp;<span class="ident" id="3979922">t</span><span class="op" id="3979923">.</span><span class="ident" id="3979924">idleConn</span><span class="op" id="3979932">[</span><span class="ident" id="3979933">key</span><span class="op" id="3979936">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3979940">if</span>&nbsp;<span class="op" id="3979943">!</span><span class="ident" id="3979944">ok</span>&nbsp;<span class="op" id="3979947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3979952">return</span>&nbsp;<span class="ident" id="3979959">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3979965">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3979969">if</span>&nbsp;<span class="builtinfunc" id="3979972">len</span><span class="op" id="3979975">(</span><span class="ident" id="3979976">pconns</span><span class="op" id="3979982">)</span>&nbsp;<span class="op" id="3979984">==</span>&nbsp;<span class="num" id="3979987">1</span>&nbsp;<span class="op" id="3979989">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3979994">pconn</span>&nbsp;<span class="op" id="3980000">=</span>&nbsp;<span class="ident" id="3980002">pconns</span><span class="op" id="3980008">[</span><span class="num" id="3980009">0</span><span class="op" id="3980010">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3980015">delete</span><span class="op" id="3980021">(</span><span class="ident" id="3980022">t</span><span class="op" id="3980023">.</span><span class="ident" id="3980024">idleConn</span><span class="op" id="3980032">,</span>&nbsp;<span class="ident" id="3980034">key</span><span class="op" id="3980037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3980041">}</span>&nbsp;<span class="keyword" id="3980043">else</span>&nbsp;<span class="op" id="3980048">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3980053">//&nbsp;2&nbsp;or&nbsp;more&nbsp;cached&nbsp;connections;&nbsp;pop&nbsp;last</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3980098">//&nbsp;TODO:&nbsp;queue?</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3980117">pconn</span>&nbsp;<span class="op" id="3980123">=</span>&nbsp;<span class="ident" id="3980125">pconns</span><span class="op" id="3980131">[</span><span class="builtinfunc" id="3980132">len</span><span class="op" id="3980135">(</span><span class="ident" id="3980136">pconns</span><span class="op" id="3980142">)</span><span class="op" id="3980143">-</span><span class="num" id="3980144">1</span><span class="op" id="3980145">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3980150">t</span><span class="op" id="3980151">.</span><span class="ident" id="3980152">idleConn</span><span class="op" id="3980160">[</span><span class="ident" id="3980161">key</span><span class="op" id="3980164">]</span>&nbsp;<span class="op" id="3980166">=</span>&nbsp;<span class="ident" id="3980168">pconns</span><span class="op" id="3980174">[</span><span class="op" id="3980175">:</span><span class="builtinfunc" id="3980176">len</span><span class="op" id="3980179">(</span><span class="ident" id="3980180">pconns</span><span class="op" id="3980186">)</span><span class="op" id="3980187">-</span><span class="num" id="3980188">1</span><span class="op" id="3980189">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3980193">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3980197">if</span>&nbsp;<span class="op" id="3980200">!</span><span class="ident" id="3980201">pconn</span><span class="op" id="3980206">.</span><span class="ident" id="3980207">isBroken</span><span class="op" id="3980215">(</span><span class="op" id="3980216">)</span>&nbsp;<span class="op" id="3980218">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3980223">return</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3980232">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3980235">}</span><br>
<span class="lineno"></span><span class="op" id="3980237">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3980240">func</span>&nbsp;<span class="op" id="3980245">(</span><span class="ident" id="3980246">t</span>&nbsp;<span class="op" id="3980248">*</span><span class="ident" id="3980249">Transport</span><span class="op" id="3980258">)</span>&nbsp;<span class="ident" id="3980260">setReqCanceler</span><span class="op" id="3980274">(</span><span class="ident" id="3980275">r</span>&nbsp;<span class="op" id="3980277">*</span><span class="ident" id="3980278">Request</span><span class="op" id="3980285">,</span>&nbsp;<span class="ident" id="3980287">fn</span>&nbsp;<span class="keyword" id="3980290">func</span><span class="op" id="3980294">(</span><span class="op" id="3980295">)</span><span class="op" id="3980296">)</span>&nbsp;<span class="op" id="3980298">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3980301">t</span><span class="op" id="3980302">.</span><span class="ident" id="3980303">reqMu</span><span class="op" id="3980308">.</span><span class="ident" id="3980309">Lock</span><span class="op" id="3980313">(</span><span class="op" id="3980314">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3980317">defer</span>&nbsp;<span class="ident" id="3980323">t</span><span class="op" id="3980324">.</span><span class="ident" id="3980325">reqMu</span><span class="op" id="3980330">.</span><span class="ident" id="3980331">Unlock</span><span class="op" id="3980337">(</span><span class="op" id="3980338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3980341">if</span>&nbsp;<span class="ident" id="3980344">t</span><span class="op" id="3980345">.</span><span class="ident" id="3980346">reqCanceler</span>&nbsp;<span class="op" id="3980358">==</span>&nbsp;<span class="ident" id="3980361">nil</span>&nbsp;<span class="op" id="3980365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3980369">t</span><span class="op" id="3980370">.</span><span class="ident" id="3980371">reqCanceler</span>&nbsp;<span class="op" id="3980383">=</span>&nbsp;<span class="builtinfunc" id="3980385">make</span><span class="op" id="3980389">(</span><span class="keyword" id="3980390">map</span><span class="op" id="3980393">[</span><span class="op" id="3980394">*</span><span class="ident" id="3980395">Request</span><span class="op" id="3980402">]</span><span class="keyword" id="3980403">func</span><span class="op" id="3980407">(</span><span class="op" id="3980408">)</span><span class="op" id="3980409">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3980412">}</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3980415">if</span>&nbsp;<span class="ident" id="3980418">fn</span>&nbsp;<span class="op" id="3980421">!=</span>&nbsp;<span class="ident" id="3980424">nil</span>&nbsp;<span class="op" id="3980428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3980432">t</span><span class="op" id="3980433">.</span><span class="ident" id="3980434">reqCanceler</span><span class="op" id="3980445">[</span><span class="ident" id="3980446">r</span><span class="op" id="3980447">]</span>&nbsp;<span class="op" id="3980449">=</span>&nbsp;<span class="ident" id="3980451">fn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3980455">}</span>&nbsp;<span class="keyword" id="3980457">else</span>&nbsp;<span class="op" id="3980462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3980466">delete</span><span class="op" id="3980472">(</span><span class="ident" id="3980473">t</span><span class="op" id="3980474">.</span><span class="ident" id="3980475">reqCanceler</span><span class="op" id="3980486">,</span>&nbsp;<span class="ident" id="3980488">r</span><span class="op" id="3980489">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3980492">}</span><br>
<span class="lineno">475</span><span class="op" id="3980494">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3980497">func</span>&nbsp;<span class="op" id="3980502">(</span><span class="ident" id="3980503">t</span>&nbsp;<span class="op" id="3980505">*</span><span class="ident" id="3980506">Transport</span><span class="op" id="3980515">)</span>&nbsp;<span class="ident" id="3980517">dial</span><span class="op" id="3980521">(</span><span class="ident" id="3980522">network</span><span class="op" id="3980529">,</span>&nbsp;<span class="ident" id="3980531">addr</span>&nbsp;<span class="builtintype" id="3980536">string</span><span class="op" id="3980542">)</span>&nbsp;<span class="op" id="3980544">(</span><span class="ident" id="3980545">c</span>&nbsp;<span class="ident" id="3980547">net</span><span class="op" id="3980550">.</span><span class="ident" id="3980551">Conn</span><span class="op" id="3980555">,</span>&nbsp;<span class="ident" id="3980557">err</span>&nbsp;<span class="builtintype" id="3980561">error</span><span class="op" id="3980566">)</span>&nbsp;<span class="op" id="3980568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3980571">if</span>&nbsp;<span class="ident" id="3980574">t</span><span class="op" id="3980575">.</span><span class="ident" id="3980576">Dial</span>&nbsp;<span class="op" id="3980581">!=</span>&nbsp;<span class="ident" id="3980584">nil</span>&nbsp;<span class="op" id="3980588">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3980592">return</span>&nbsp;<span class="ident" id="3980599">t</span><span class="op" id="3980600">.</span><span class="ident" id="3980601">Dial</span><span class="op" id="3980605">(</span><span class="ident" id="3980606">network</span><span class="op" id="3980613">,</span>&nbsp;<span class="ident" id="3980615">addr</span><span class="op" id="3980619">)</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3980622">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3980625">return</span>&nbsp;<span class="ident" id="3980632">net</span><span class="op" id="3980635">.</span><span class="ident" id="3980636">Dial</span><span class="op" id="3980640">(</span><span class="ident" id="3980641">network</span><span class="op" id="3980648">,</span>&nbsp;<span class="ident" id="3980650">addr</span><span class="op" id="3980654">)</span><br>
<span class="lineno"></span><span class="op" id="3980656">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3980659">//&nbsp;Testing&nbsp;hooks:</span><br>
<span class="lineno">485</span><span class="keyword" id="3980677">var</span>&nbsp;<span class="ident" id="3980681">prePendingDial</span><span class="op" id="3980695">,</span>&nbsp;<span class="ident" id="3980697">postPendingDial</span>&nbsp;<span class="keyword" id="3980713">func</span><span class="op" id="3980717">(</span><span class="op" id="3980718">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3980721">//&nbsp;getConn&nbsp;dials&nbsp;and&nbsp;creates&nbsp;a&nbsp;new&nbsp;persistConn&nbsp;to&nbsp;the&nbsp;target&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="3980785">//&nbsp;specified&nbsp;in&nbsp;the&nbsp;connectMethod.&nbsp;&nbsp;This&nbsp;includes&nbsp;doing&nbsp;a&nbsp;proxy&nbsp;CONNECT</span><br>
<span class="lineno"></span><span class="comment" id="3980857">//&nbsp;and/or&nbsp;setting&nbsp;up&nbsp;TLS.&nbsp;&nbsp;If&nbsp;this&nbsp;doesn&#39;t&nbsp;return&nbsp;an&nbsp;error,&nbsp;the&nbsp;persistConn</span><br>
<span class="lineno">490</span><span class="comment" id="3980933">//&nbsp;is&nbsp;ready&nbsp;to&nbsp;write&nbsp;requests&nbsp;to.</span><br>
<span class="lineno"></span><span class="keyword" id="3980967">func</span>&nbsp;<span class="op" id="3980972">(</span><span class="ident" id="3980973">t</span>&nbsp;<span class="op" id="3980975">*</span><span class="ident" id="3980976">Transport</span><span class="op" id="3980985">)</span>&nbsp;<span class="ident" id="3980987">getConn</span><span class="op" id="3980994">(</span><span class="ident" id="3980995">req</span>&nbsp;<span class="op" id="3980999">*</span><span class="ident" id="3981000">Request</span><span class="op" id="3981007">,</span>&nbsp;<span class="ident" id="3981009">cm</span>&nbsp;<span class="ident" id="3981012">connectMethod</span><span class="op" id="3981025">)</span>&nbsp;<span class="op" id="3981027">(</span><span class="op" id="3981028">*</span><span class="ident" id="3981029">persistConn</span><span class="op" id="3981040">,</span>&nbsp;<span class="builtintype" id="3981042">error</span><span class="op" id="3981047">)</span>&nbsp;<span class="op" id="3981049">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3981052">if</span>&nbsp;<span class="ident" id="3981055">pc</span>&nbsp;<span class="op" id="3981058">:=</span>&nbsp;<span class="ident" id="3981061">t</span><span class="op" id="3981062">.</span><span class="ident" id="3981063">getIdleConn</span><span class="op" id="3981074">(</span><span class="ident" id="3981075">cm</span><span class="op" id="3981077">)</span><span class="op" id="3981078">;</span>&nbsp;<span class="ident" id="3981080">pc</span>&nbsp;<span class="op" id="3981083">!=</span>&nbsp;<span class="ident" id="3981086">nil</span>&nbsp;<span class="op" id="3981090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3981094">return</span>&nbsp;<span class="ident" id="3981101">pc</span><span class="op" id="3981103">,</span>&nbsp;<span class="ident" id="3981105">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3981110">}</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3981114">type</span>&nbsp;<span class="ident" id="3981119">dialRes</span>&nbsp;<span class="keyword" id="3981127">struct</span>&nbsp;<span class="op" id="3981134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3981138">pc</span>&nbsp;&nbsp;<span class="op" id="3981142">*</span><span class="ident" id="3981143">persistConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3981157">err</span>&nbsp;<span class="builtintype" id="3981161">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3981168">}</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3981171">dialc</span>&nbsp;<span class="op" id="3981177">:=</span>&nbsp;<span class="builtinfunc" id="3981180">make</span><span class="op" id="3981184">(</span><span class="keyword" id="3981185">chan</span>&nbsp;<span class="ident" id="3981190">dialRes</span><span class="op" id="3981197">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3981201">handlePendingDial</span>&nbsp;<span class="op" id="3981219">:=</span>&nbsp;<span class="keyword" id="3981222">func</span><span class="op" id="3981226">(</span><span class="op" id="3981227">)</span>&nbsp;<span class="op" id="3981229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3981233">if</span>&nbsp;<span class="ident" id="3981236">prePendingDial</span>&nbsp;<span class="op" id="3981251">!=</span>&nbsp;<span class="ident" id="3981254">nil</span>&nbsp;<span class="op" id="3981258">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3981263">prePendingDial</span><span class="op" id="3981277">(</span><span class="op" id="3981278">)</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3981282">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3981286">go</span>&nbsp;<span class="keyword" id="3981289">func</span><span class="op" id="3981293">(</span><span class="op" id="3981294">)</span>&nbsp;<span class="op" id="3981296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3981301">if</span>&nbsp;<span class="ident" id="3981304">v</span>&nbsp;<span class="op" id="3981306">:=</span>&nbsp;<span class="op" id="3981309">&lt;-</span><span class="ident" id="3981311">dialc</span><span class="op" id="3981316">;</span>&nbsp;<span class="ident" id="3981318">v</span><span class="op" id="3981319">.</span><span class="ident" id="3981320">err</span>&nbsp;<span class="op" id="3981324">==</span>&nbsp;<span class="ident" id="3981327">nil</span>&nbsp;<span class="op" id="3981331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3981337">t</span><span class="op" id="3981338">.</span><span class="ident" id="3981339">putIdleConn</span><span class="op" id="3981350">(</span><span class="ident" id="3981351">v</span><span class="op" id="3981352">.</span><span class="ident" id="3981353">pc</span><span class="op" id="3981355">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3981360">}</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3981365">if</span>&nbsp;<span class="ident" id="3981368">postPendingDial</span>&nbsp;<span class="op" id="3981384">!=</span>&nbsp;<span class="ident" id="3981387">nil</span>&nbsp;<span class="op" id="3981391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3981397">postPendingDial</span><span class="op" id="3981412">(</span><span class="op" id="3981413">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3981418">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3981422">}</span><span class="op" id="3981423">(</span><span class="op" id="3981424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3981427">}</span><br>
<span class="lineno">515</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3981431">cancelc</span>&nbsp;<span class="op" id="3981439">:=</span>&nbsp;<span class="builtinfunc" id="3981442">make</span><span class="op" id="3981446">(</span><span class="keyword" id="3981447">chan</span>&nbsp;<span class="keyword" id="3981452">struct</span><span class="op" id="3981458">{</span><span class="op" id="3981459">}</span><span class="op" id="3981460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3981463">t</span><span class="op" id="3981464">.</span><span class="ident" id="3981465">setReqCanceler</span><span class="op" id="3981479">(</span><span class="ident" id="3981480">req</span><span class="op" id="3981483">,</span>&nbsp;<span class="keyword" id="3981485">func</span><span class="op" id="3981489">(</span><span class="op" id="3981490">)</span>&nbsp;<span class="op" id="3981492">{</span>&nbsp;<span class="builtinfunc" id="3981494">close</span><span class="op" id="3981499">(</span><span class="ident" id="3981500">cancelc</span><span class="op" id="3981507">)</span>&nbsp;<span class="op" id="3981509">}</span><span class="op" id="3981510">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3981514">go</span>&nbsp;<span class="keyword" id="3981517">func</span><span class="op" id="3981521">(</span><span class="op" id="3981522">)</span>&nbsp;<span class="op" id="3981524">{</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3981528">pc</span><span class="op" id="3981530">,</span>&nbsp;<span class="ident" id="3981532">err</span>&nbsp;<span class="op" id="3981536">:=</span>&nbsp;<span class="ident" id="3981539">t</span><span class="op" id="3981540">.</span><span class="ident" id="3981541">dialConn</span><span class="op" id="3981549">(</span><span class="ident" id="3981550">cm</span><span class="op" id="3981552">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3981556">dialc</span>&nbsp;<span class="op" id="3981562">&lt;-</span>&nbsp;<span class="ident" id="3981565">dialRes</span><span class="op" id="3981572">{</span><span class="ident" id="3981573">pc</span><span class="op" id="3981575">,</span>&nbsp;<span class="ident" id="3981577">err</span><span class="op" id="3981580">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3981583">}</span><span class="op" id="3981584">(</span><span class="op" id="3981585">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3981589">idleConnCh</span>&nbsp;<span class="op" id="3981600">:=</span>&nbsp;<span class="ident" id="3981603">t</span><span class="op" id="3981604">.</span><span class="ident" id="3981605">getIdleConnCh</span><span class="op" id="3981618">(</span><span class="ident" id="3981619">cm</span><span class="op" id="3981621">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3981624">select</span>&nbsp;<span class="op" id="3981631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3981634">case</span>&nbsp;<span class="ident" id="3981639">v</span>&nbsp;<span class="op" id="3981641">:=</span>&nbsp;<span class="op" id="3981644">&lt;-</span><span class="ident" id="3981646">dialc</span><span class="op" id="3981651">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3981655">//&nbsp;Our&nbsp;dial&nbsp;finished.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3981679">return</span>&nbsp;<span class="ident" id="3981686">v</span><span class="op" id="3981687">.</span><span class="ident" id="3981688">pc</span><span class="op" id="3981690">,</span>&nbsp;<span class="ident" id="3981692">v</span><span class="op" id="3981693">.</span><span class="ident" id="3981694">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3981699">case</span>&nbsp;<span class="ident" id="3981704">pc</span>&nbsp;<span class="op" id="3981707">:=</span>&nbsp;<span class="op" id="3981710">&lt;-</span><span class="ident" id="3981712">idleConnCh</span><span class="op" id="3981722">:</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3981726">//&nbsp;Another&nbsp;request&nbsp;finished&nbsp;first&nbsp;and&nbsp;its&nbsp;net.Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3981779">//&nbsp;became&nbsp;available&nbsp;before&nbsp;our&nbsp;dial.&nbsp;Or&nbsp;somebody</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3981830">//&nbsp;else&#39;s&nbsp;dial&nbsp;that&nbsp;they&nbsp;didn&#39;t&nbsp;use.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3981869">//&nbsp;But&nbsp;our&nbsp;dial&nbsp;is&nbsp;still&nbsp;going,&nbsp;so&nbsp;give&nbsp;it&nbsp;away</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3981919">//&nbsp;when&nbsp;it&nbsp;finishes:</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3981942">handlePendingDial</span><span class="op" id="3981959">(</span><span class="op" id="3981960">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3981964">return</span>&nbsp;<span class="ident" id="3981971">pc</span><span class="op" id="3981973">,</span>&nbsp;<span class="ident" id="3981975">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3981980">case</span>&nbsp;<span class="op" id="3981985">&lt;-</span><span class="ident" id="3981987">cancelc</span><span class="op" id="3981994">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3981998">handlePendingDial</span><span class="op" id="3982015">(</span><span class="op" id="3982016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3982020">return</span>&nbsp;<span class="ident" id="3982027">nil</span><span class="op" id="3982030">,</span>&nbsp;<span class="ident" id="3982032">errors</span><span class="op" id="3982038">.</span><span class="ident" id="3982039">New</span><span class="op" id="3982042">(</span><span class="string" id="3982043">&#34;net/http:&nbsp;request&nbsp;canceled&nbsp;while&nbsp;waiting&nbsp;for&nbsp;connection&#34;</span><span class="op" id="3982100">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3982103">}</span><br>
<span class="lineno"></span><span class="op" id="3982105">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3982108">func</span>&nbsp;<span class="op" id="3982113">(</span><span class="ident" id="3982114">t</span>&nbsp;<span class="op" id="3982116">*</span><span class="ident" id="3982117">Transport</span><span class="op" id="3982126">)</span>&nbsp;<span class="ident" id="3982128">dialConn</span><span class="op" id="3982136">(</span><span class="ident" id="3982137">cm</span>&nbsp;<span class="ident" id="3982140">connectMethod</span><span class="op" id="3982153">)</span>&nbsp;<span class="op" id="3982155">(</span><span class="op" id="3982156">*</span><span class="ident" id="3982157">persistConn</span><span class="op" id="3982168">,</span>&nbsp;<span class="builtintype" id="3982170">error</span><span class="op" id="3982175">)</span>&nbsp;<span class="op" id="3982177">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3982180">pconn</span>&nbsp;<span class="op" id="3982186">:=</span>&nbsp;<span class="op" id="3982189">&amp;</span><span class="ident" id="3982190">persistConn</span><span class="op" id="3982201">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3982205">t</span><span class="op" id="3982206">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3982217">t</span><span class="op" id="3982218">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3982222">cacheKey</span><span class="op" id="3982230">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3982234">cm</span><span class="op" id="3982236">.</span><span class="ident" id="3982237">key</span><span class="op" id="3982240">(</span><span class="op" id="3982241">)</span><span class="op" id="3982242">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3982246">reqch</span><span class="op" id="3982251">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3982258">make</span><span class="op" id="3982262">(</span><span class="keyword" id="3982263">chan</span>&nbsp;<span class="ident" id="3982268">requestAndChan</span><span class="op" id="3982282">,</span>&nbsp;<span class="num" id="3982284">1</span><span class="op" id="3982285">)</span><span class="op" id="3982286">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3982290">writech</span><span class="op" id="3982297">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3982302">make</span><span class="op" id="3982306">(</span><span class="keyword" id="3982307">chan</span>&nbsp;<span class="ident" id="3982312">writeRequest</span><span class="op" id="3982324">,</span>&nbsp;<span class="num" id="3982326">1</span><span class="op" id="3982327">)</span><span class="op" id="3982328">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3982332">closech</span><span class="op" id="3982339">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3982344">make</span><span class="op" id="3982348">(</span><span class="keyword" id="3982349">chan</span>&nbsp;<span class="keyword" id="3982354">struct</span><span class="op" id="3982360">{</span><span class="op" id="3982361">}</span><span class="op" id="3982362">)</span><span class="op" id="3982363">,</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3982367">writeErrCh</span><span class="op" id="3982377">:</span>&nbsp;<span class="builtinfunc" id="3982379">make</span><span class="op" id="3982383">(</span><span class="keyword" id="3982384">chan</span>&nbsp;<span class="builtintype" id="3982389">error</span><span class="op" id="3982394">,</span>&nbsp;<span class="num" id="3982396">1</span><span class="op" id="3982397">)</span><span class="op" id="3982398">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3982401">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3982404">tlsDial</span>&nbsp;<span class="op" id="3982412">:=</span>&nbsp;<span class="ident" id="3982415">t</span><span class="op" id="3982416">.</span><span class="ident" id="3982417">DialTLS</span>&nbsp;<span class="op" id="3982425">!=</span>&nbsp;<span class="ident" id="3982428">nil</span>&nbsp;<span class="op" id="3982432">&amp;&amp;</span>&nbsp;<span class="ident" id="3982435">cm</span><span class="op" id="3982437">.</span><span class="ident" id="3982438">targetScheme</span>&nbsp;<span class="op" id="3982451">==</span>&nbsp;<span class="string" id="3982454">&#34;https&#34;</span>&nbsp;<span class="op" id="3982462">&amp;&amp;</span>&nbsp;<span class="ident" id="3982465">cm</span><span class="op" id="3982467">.</span><span class="ident" id="3982468">proxyURL</span>&nbsp;<span class="op" id="3982477">==</span>&nbsp;<span class="ident" id="3982480">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3982485">if</span>&nbsp;<span class="ident" id="3982488">tlsDial</span>&nbsp;<span class="op" id="3982496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3982500">var</span>&nbsp;<span class="ident" id="3982504">err</span>&nbsp;<span class="builtintype" id="3982508">error</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3982516">pconn</span><span class="op" id="3982521">.</span><span class="ident" id="3982522">conn</span><span class="op" id="3982526">,</span>&nbsp;<span class="ident" id="3982528">err</span>&nbsp;<span class="op" id="3982532">=</span>&nbsp;<span class="ident" id="3982534">t</span><span class="op" id="3982535">.</span><span class="ident" id="3982536">DialTLS</span><span class="op" id="3982543">(</span><span class="string" id="3982544">&#34;tcp&#34;</span><span class="op" id="3982549">,</span>&nbsp;<span class="ident" id="3982551">cm</span><span class="op" id="3982553">.</span><span class="ident" id="3982554">addr</span><span class="op" id="3982558">(</span><span class="op" id="3982559">)</span><span class="op" id="3982560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3982564">if</span>&nbsp;<span class="ident" id="3982567">err</span>&nbsp;<span class="op" id="3982571">!=</span>&nbsp;<span class="ident" id="3982574">nil</span>&nbsp;<span class="op" id="3982578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3982583">return</span>&nbsp;<span class="ident" id="3982590">nil</span><span class="op" id="3982593">,</span>&nbsp;<span class="ident" id="3982595">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3982601">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3982605">if</span>&nbsp;<span class="ident" id="3982608">tc</span><span class="op" id="3982610">,</span>&nbsp;<span class="ident" id="3982612">ok</span>&nbsp;<span class="op" id="3982615">:=</span>&nbsp;<span class="ident" id="3982618">pconn</span><span class="op" id="3982623">.</span><span class="ident" id="3982624">conn</span><span class="op" id="3982628">.</span><span class="op" id="3982629">(</span><span class="op" id="3982630">*</span><span class="ident" id="3982631">tls</span><span class="op" id="3982634">.</span><span class="ident" id="3982635">Conn</span><span class="op" id="3982639">)</span><span class="op" id="3982640">;</span>&nbsp;<span class="ident" id="3982642">ok</span>&nbsp;<span class="op" id="3982645">{</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3982650">cs</span>&nbsp;<span class="op" id="3982653">:=</span>&nbsp;<span class="ident" id="3982656">tc</span><span class="op" id="3982658">.</span><span class="ident" id="3982659">ConnectionState</span><span class="op" id="3982674">(</span><span class="op" id="3982675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3982680">pconn</span><span class="op" id="3982685">.</span><span class="ident" id="3982686">tlsState</span>&nbsp;<span class="op" id="3982695">=</span>&nbsp;<span class="op" id="3982697">&amp;</span><span class="ident" id="3982698">cs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3982703">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3982706">}</span>&nbsp;<span class="keyword" id="3982708">else</span>&nbsp;<span class="op" id="3982713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3982717">conn</span><span class="op" id="3982721">,</span>&nbsp;<span class="ident" id="3982723">err</span>&nbsp;<span class="op" id="3982727">:=</span>&nbsp;<span class="ident" id="3982730">t</span><span class="op" id="3982731">.</span><span class="ident" id="3982732">dial</span><span class="op" id="3982736">(</span><span class="string" id="3982737">&#34;tcp&#34;</span><span class="op" id="3982742">,</span>&nbsp;<span class="ident" id="3982744">cm</span><span class="op" id="3982746">.</span><span class="ident" id="3982747">addr</span><span class="op" id="3982751">(</span><span class="op" id="3982752">)</span><span class="op" id="3982753">)</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3982757">if</span>&nbsp;<span class="ident" id="3982760">err</span>&nbsp;<span class="op" id="3982764">!=</span>&nbsp;<span class="ident" id="3982767">nil</span>&nbsp;<span class="op" id="3982771">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3982776">if</span>&nbsp;<span class="ident" id="3982779">cm</span><span class="op" id="3982781">.</span><span class="ident" id="3982782">proxyURL</span>&nbsp;<span class="op" id="3982791">!=</span>&nbsp;<span class="ident" id="3982794">nil</span>&nbsp;<span class="op" id="3982798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3982804">err</span>&nbsp;<span class="op" id="3982808">=</span>&nbsp;<span class="ident" id="3982810">fmt</span><span class="op" id="3982813">.</span><span class="ident" id="3982814">Errorf</span><span class="op" id="3982820">(</span><span class="string" id="3982821">&#34;http:&nbsp;error&nbsp;connecting&nbsp;to&nbsp;proxy&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="3982861">,</span>&nbsp;<span class="ident" id="3982863">cm</span><span class="op" id="3982865">.</span><span class="ident" id="3982866">proxyURL</span><span class="op" id="3982874">,</span>&nbsp;<span class="ident" id="3982876">err</span><span class="op" id="3982879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3982884">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3982889">return</span>&nbsp;<span class="ident" id="3982896">nil</span><span class="op" id="3982899">,</span>&nbsp;<span class="ident" id="3982901">err</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3982907">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3982911">pconn</span><span class="op" id="3982916">.</span><span class="ident" id="3982917">conn</span>&nbsp;<span class="op" id="3982922">=</span>&nbsp;<span class="ident" id="3982924">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3982930">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3982934">//&nbsp;Proxy&nbsp;setup.</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3982951">switch</span>&nbsp;<span class="op" id="3982958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3982961">case</span>&nbsp;<span class="ident" id="3982966">cm</span><span class="op" id="3982968">.</span><span class="ident" id="3982969">proxyURL</span>&nbsp;<span class="op" id="3982978">==</span>&nbsp;<span class="ident" id="3982981">nil</span><span class="op" id="3982984">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3982988">//&nbsp;Do&nbsp;nothing.&nbsp;Not&nbsp;using&nbsp;a&nbsp;proxy.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3983023">case</span>&nbsp;<span class="ident" id="3983028">cm</span><span class="op" id="3983030">.</span><span class="ident" id="3983031">targetScheme</span>&nbsp;<span class="op" id="3983044">==</span>&nbsp;<span class="string" id="3983047">&#34;http&#34;</span><span class="op" id="3983053">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3983057">pconn</span><span class="op" id="3983062">.</span><span class="ident" id="3983063">isProxy</span>&nbsp;<span class="op" id="3983071">=</span>&nbsp;<span class="builtintype" id="3983073">true</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3983080">if</span>&nbsp;<span class="ident" id="3983083">pa</span>&nbsp;<span class="op" id="3983086">:=</span>&nbsp;<span class="ident" id="3983089">cm</span><span class="op" id="3983091">.</span><span class="ident" id="3983092">proxyAuth</span><span class="op" id="3983101">(</span><span class="op" id="3983102">)</span><span class="op" id="3983103">;</span>&nbsp;<span class="ident" id="3983105">pa</span>&nbsp;<span class="op" id="3983108">!=</span>&nbsp;<span class="string" id="3983111">&#34;&#34;</span>&nbsp;<span class="op" id="3983114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3983119">pconn</span><span class="op" id="3983124">.</span><span class="ident" id="3983125">mutateHeaderFunc</span>&nbsp;<span class="op" id="3983142">=</span>&nbsp;<span class="keyword" id="3983144">func</span><span class="op" id="3983148">(</span><span class="ident" id="3983149">h</span>&nbsp;<span class="ident" id="3983151">Header</span><span class="op" id="3983157">)</span>&nbsp;<span class="op" id="3983159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3983165">h</span><span class="op" id="3983166">.</span><span class="ident" id="3983167">Set</span><span class="op" id="3983170">(</span><span class="string" id="3983171">&#34;Proxy-Authorization&#34;</span><span class="op" id="3983192">,</span>&nbsp;<span class="ident" id="3983194">pa</span><span class="op" id="3983196">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3983201">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3983205">}</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3983208">case</span>&nbsp;<span class="ident" id="3983213">cm</span><span class="op" id="3983215">.</span><span class="ident" id="3983216">targetScheme</span>&nbsp;<span class="op" id="3983229">==</span>&nbsp;<span class="string" id="3983232">&#34;https&#34;</span><span class="op" id="3983239">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3983243">conn</span>&nbsp;<span class="op" id="3983248">:=</span>&nbsp;<span class="ident" id="3983251">pconn</span><span class="op" id="3983256">.</span><span class="ident" id="3983257">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3983264">connectReq</span>&nbsp;<span class="op" id="3983275">:=</span>&nbsp;<span class="op" id="3983278">&amp;</span><span class="ident" id="3983279">Request</span><span class="op" id="3983286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3983291">Method</span><span class="op" id="3983297">:</span>&nbsp;<span class="string" id="3983299">&#34;CONNECT&#34;</span><span class="op" id="3983308">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3983313">URL</span><span class="op" id="3983316">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3983321">&amp;</span><span class="ident" id="3983322">url</span><span class="op" id="3983325">.</span><span class="ident" id="3983326">URL</span><span class="op" id="3983329">{</span><span class="ident" id="3983330">Opaque</span><span class="op" id="3983336">:</span>&nbsp;<span class="ident" id="3983338">cm</span><span class="op" id="3983340">.</span><span class="ident" id="3983341">targetAddr</span><span class="op" id="3983351">}</span><span class="op" id="3983352">,</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3983357">Host</span><span class="op" id="3983361">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3983365">cm</span><span class="op" id="3983367">.</span><span class="ident" id="3983368">targetAddr</span><span class="op" id="3983378">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3983383">Header</span><span class="op" id="3983389">:</span>&nbsp;<span class="builtinfunc" id="3983391">make</span><span class="op" id="3983395">(</span><span class="ident" id="3983396">Header</span><span class="op" id="3983402">)</span><span class="op" id="3983403">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3983407">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3983411">if</span>&nbsp;<span class="ident" id="3983414">pa</span>&nbsp;<span class="op" id="3983417">:=</span>&nbsp;<span class="ident" id="3983420">cm</span><span class="op" id="3983422">.</span><span class="ident" id="3983423">proxyAuth</span><span class="op" id="3983432">(</span><span class="op" id="3983433">)</span><span class="op" id="3983434">;</span>&nbsp;<span class="ident" id="3983436">pa</span>&nbsp;<span class="op" id="3983439">!=</span>&nbsp;<span class="string" id="3983442">&#34;&#34;</span>&nbsp;<span class="op" id="3983445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3983450">connectReq</span><span class="op" id="3983460">.</span><span class="ident" id="3983461">Header</span><span class="op" id="3983467">.</span><span class="ident" id="3983468">Set</span><span class="op" id="3983471">(</span><span class="string" id="3983472">&#34;Proxy-Authorization&#34;</span><span class="op" id="3983493">,</span>&nbsp;<span class="ident" id="3983495">pa</span><span class="op" id="3983497">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3983501">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3983505">connectReq</span><span class="op" id="3983515">.</span><span class="ident" id="3983516">Write</span><span class="op" id="3983521">(</span><span class="ident" id="3983522">conn</span><span class="op" id="3983526">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3983531">//&nbsp;Read&nbsp;response.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3983551">//&nbsp;Okay&nbsp;to&nbsp;use&nbsp;and&nbsp;discard&nbsp;buffered&nbsp;reader&nbsp;here,&nbsp;because</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3983610">//&nbsp;TLS&nbsp;server&nbsp;will&nbsp;not&nbsp;speak&nbsp;until&nbsp;spoken&nbsp;to.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3983658">br</span>&nbsp;<span class="op" id="3983661">:=</span>&nbsp;<span class="ident" id="3983664">bufio</span><span class="op" id="3983669">.</span><span class="ident" id="3983670">NewReader</span><span class="op" id="3983679">(</span><span class="ident" id="3983680">conn</span><span class="op" id="3983684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3983688">resp</span><span class="op" id="3983692">,</span>&nbsp;<span class="ident" id="3983694">err</span>&nbsp;<span class="op" id="3983698">:=</span>&nbsp;<span class="ident" id="3983701">ReadResponse</span><span class="op" id="3983713">(</span><span class="ident" id="3983714">br</span><span class="op" id="3983716">,</span>&nbsp;<span class="ident" id="3983718">connectReq</span><span class="op" id="3983728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3983732">if</span>&nbsp;<span class="ident" id="3983735">err</span>&nbsp;<span class="op" id="3983739">!=</span>&nbsp;<span class="ident" id="3983742">nil</span>&nbsp;<span class="op" id="3983746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3983751">conn</span><span class="op" id="3983755">.</span><span class="ident" id="3983756">Close</span><span class="op" id="3983761">(</span><span class="op" id="3983762">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3983767">return</span>&nbsp;<span class="ident" id="3983774">nil</span><span class="op" id="3983777">,</span>&nbsp;<span class="ident" id="3983779">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3983785">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3983789">if</span>&nbsp;<span class="ident" id="3983792">resp</span><span class="op" id="3983796">.</span><span class="ident" id="3983797">StatusCode</span>&nbsp;<span class="op" id="3983808">!=</span>&nbsp;<span class="num" id="3983811">200</span>&nbsp;<span class="op" id="3983815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3983820">f</span>&nbsp;<span class="op" id="3983822">:=</span>&nbsp;<span class="ident" id="3983825">strings</span><span class="op" id="3983832">.</span><span class="ident" id="3983833">SplitN</span><span class="op" id="3983839">(</span><span class="ident" id="3983840">resp</span><span class="op" id="3983844">.</span><span class="ident" id="3983845">Status</span><span class="op" id="3983851">,</span>&nbsp;<span class="string" id="3983853">&#34;&nbsp;&#34;</span><span class="op" id="3983856">,</span>&nbsp;<span class="num" id="3983858">2</span><span class="op" id="3983859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3983864">conn</span><span class="op" id="3983868">.</span><span class="ident" id="3983869">Close</span><span class="op" id="3983874">(</span><span class="op" id="3983875">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3983880">return</span>&nbsp;<span class="ident" id="3983887">nil</span><span class="op" id="3983890">,</span>&nbsp;<span class="ident" id="3983892">errors</span><span class="op" id="3983898">.</span><span class="ident" id="3983899">New</span><span class="op" id="3983902">(</span><span class="ident" id="3983903">f</span><span class="op" id="3983904">[</span><span class="num" id="3983905">1</span><span class="op" id="3983906">]</span><span class="op" id="3983907">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3983911">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3983914">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3983918">if</span>&nbsp;<span class="ident" id="3983921">cm</span><span class="op" id="3983923">.</span><span class="ident" id="3983924">targetScheme</span>&nbsp;<span class="op" id="3983937">==</span>&nbsp;<span class="string" id="3983940">&#34;https&#34;</span>&nbsp;<span class="op" id="3983948">&amp;&amp;</span>&nbsp;<span class="op" id="3983951">!</span><span class="ident" id="3983952">tlsDial</span>&nbsp;<span class="op" id="3983960">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3983964">//&nbsp;Initiate&nbsp;TLS&nbsp;and&nbsp;check&nbsp;remote&nbsp;host&nbsp;name&nbsp;against&nbsp;certificate.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3984030">cfg</span>&nbsp;<span class="op" id="3984034">:=</span>&nbsp;<span class="ident" id="3984037">t</span><span class="op" id="3984038">.</span><span class="ident" id="3984039">TLSClientConfig</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3984057">if</span>&nbsp;<span class="ident" id="3984060">cfg</span>&nbsp;<span class="op" id="3984064">==</span>&nbsp;<span class="ident" id="3984067">nil</span>&nbsp;<span class="op" id="3984071">||</span>&nbsp;<span class="ident" id="3984074">cfg</span><span class="op" id="3984077">.</span><span class="ident" id="3984078">ServerName</span>&nbsp;<span class="op" id="3984089">==</span>&nbsp;<span class="string" id="3984092">&#34;&#34;</span>&nbsp;<span class="op" id="3984095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3984100">host</span>&nbsp;<span class="op" id="3984105">:=</span>&nbsp;<span class="ident" id="3984108">cm</span><span class="op" id="3984110">.</span><span class="ident" id="3984111">tlsHost</span><span class="op" id="3984118">(</span><span class="op" id="3984119">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3984124">if</span>&nbsp;<span class="ident" id="3984127">cfg</span>&nbsp;<span class="op" id="3984131">==</span>&nbsp;<span class="ident" id="3984134">nil</span>&nbsp;<span class="op" id="3984138">{</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3984144">cfg</span>&nbsp;<span class="op" id="3984148">=</span>&nbsp;<span class="op" id="3984150">&amp;</span><span class="ident" id="3984151">tls</span><span class="op" id="3984154">.</span><span class="ident" id="3984155">Config</span><span class="op" id="3984161">{</span><span class="ident" id="3984162">ServerName</span><span class="op" id="3984172">:</span>&nbsp;<span class="ident" id="3984174">host</span><span class="op" id="3984178">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3984183">}</span>&nbsp;<span class="keyword" id="3984185">else</span>&nbsp;<span class="op" id="3984190">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3984196">clone</span>&nbsp;<span class="op" id="3984202">:=</span>&nbsp;<span class="op" id="3984205">*</span><span class="ident" id="3984206">cfg</span>&nbsp;<span class="comment" id="3984210">//&nbsp;shallow&nbsp;clone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3984231">clone</span><span class="op" id="3984236">.</span><span class="ident" id="3984237">ServerName</span>&nbsp;<span class="op" id="3984248">=</span>&nbsp;<span class="ident" id="3984250">host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3984259">cfg</span>&nbsp;<span class="op" id="3984263">=</span>&nbsp;<span class="op" id="3984265">&amp;</span><span class="ident" id="3984266">clone</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3984275">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3984279">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3984283">plainConn</span>&nbsp;<span class="op" id="3984293">:=</span>&nbsp;<span class="ident" id="3984296">pconn</span><span class="op" id="3984301">.</span><span class="ident" id="3984302">conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3984309">tlsConn</span>&nbsp;<span class="op" id="3984317">:=</span>&nbsp;<span class="ident" id="3984320">tls</span><span class="op" id="3984323">.</span><span class="ident" id="3984324">Client</span><span class="op" id="3984330">(</span><span class="ident" id="3984331">plainConn</span><span class="op" id="3984340">,</span>&nbsp;<span class="ident" id="3984342">cfg</span><span class="op" id="3984345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3984349">errc</span>&nbsp;<span class="op" id="3984354">:=</span>&nbsp;<span class="builtinfunc" id="3984357">make</span><span class="op" id="3984361">(</span><span class="keyword" id="3984362">chan</span>&nbsp;<span class="builtintype" id="3984367">error</span><span class="op" id="3984372">,</span>&nbsp;<span class="num" id="3984374">2</span><span class="op" id="3984375">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3984379">var</span>&nbsp;<span class="ident" id="3984383">timer</span>&nbsp;<span class="op" id="3984389">*</span><span class="ident" id="3984390">time</span><span class="op" id="3984394">.</span><span class="ident" id="3984395">Timer</span>&nbsp;<span class="comment" id="3984401">//&nbsp;for&nbsp;canceling&nbsp;TLS&nbsp;handshake</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3984434">if</span>&nbsp;<span class="ident" id="3984437">d</span>&nbsp;<span class="op" id="3984439">:=</span>&nbsp;<span class="ident" id="3984442">t</span><span class="op" id="3984443">.</span><span class="ident" id="3984444">TLSHandshakeTimeout</span><span class="op" id="3984463">;</span>&nbsp;<span class="ident" id="3984465">d</span>&nbsp;<span class="op" id="3984467">!=</span>&nbsp;<span class="num" id="3984470">0</span>&nbsp;<span class="op" id="3984472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3984477">timer</span>&nbsp;<span class="op" id="3984483">=</span>&nbsp;<span class="ident" id="3984485">time</span><span class="op" id="3984489">.</span><span class="ident" id="3984490">AfterFunc</span><span class="op" id="3984499">(</span><span class="ident" id="3984500">d</span><span class="op" id="3984501">,</span>&nbsp;<span class="keyword" id="3984503">func</span><span class="op" id="3984507">(</span><span class="op" id="3984508">)</span>&nbsp;<span class="op" id="3984510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3984516">errc</span>&nbsp;<span class="op" id="3984521">&lt;-</span>&nbsp;<span class="ident" id="3984524">tlsHandshakeTimeoutError</span><span class="op" id="3984548">{</span><span class="op" id="3984549">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3984554">}</span><span class="op" id="3984555">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3984559">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3984563">go</span>&nbsp;<span class="keyword" id="3984566">func</span><span class="op" id="3984570">(</span><span class="op" id="3984571">)</span>&nbsp;<span class="op" id="3984573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3984578">err</span>&nbsp;<span class="op" id="3984582">:=</span>&nbsp;<span class="ident" id="3984585">tlsConn</span><span class="op" id="3984592">.</span><span class="ident" id="3984593">Handshake</span><span class="op" id="3984602">(</span><span class="op" id="3984603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3984608">if</span>&nbsp;<span class="ident" id="3984611">timer</span>&nbsp;<span class="op" id="3984617">!=</span>&nbsp;<span class="ident" id="3984620">nil</span>&nbsp;<span class="op" id="3984624">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3984630">timer</span><span class="op" id="3984635">.</span><span class="ident" id="3984636">Stop</span><span class="op" id="3984640">(</span><span class="op" id="3984641">)</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3984646">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3984651">errc</span>&nbsp;<span class="op" id="3984656">&lt;-</span>&nbsp;<span class="ident" id="3984659">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3984665">}</span><span class="op" id="3984666">(</span><span class="op" id="3984667">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3984671">if</span>&nbsp;<span class="ident" id="3984674">err</span>&nbsp;<span class="op" id="3984678">:=</span>&nbsp;<span class="op" id="3984681">&lt;-</span><span class="ident" id="3984683">errc</span><span class="op" id="3984687">;</span>&nbsp;<span class="ident" id="3984689">err</span>&nbsp;<span class="op" id="3984693">!=</span>&nbsp;<span class="ident" id="3984696">nil</span>&nbsp;<span class="op" id="3984700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3984705">plainConn</span><span class="op" id="3984714">.</span><span class="ident" id="3984715">Close</span><span class="op" id="3984720">(</span><span class="op" id="3984721">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3984726">return</span>&nbsp;<span class="ident" id="3984733">nil</span><span class="op" id="3984736">,</span>&nbsp;<span class="ident" id="3984738">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3984744">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3984748">if</span>&nbsp;<span class="op" id="3984751">!</span><span class="ident" id="3984752">cfg</span><span class="op" id="3984755">.</span><span class="ident" id="3984756">InsecureSkipVerify</span>&nbsp;<span class="op" id="3984775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3984780">if</span>&nbsp;<span class="ident" id="3984783">err</span>&nbsp;<span class="op" id="3984787">:=</span>&nbsp;<span class="ident" id="3984790">tlsConn</span><span class="op" id="3984797">.</span><span class="ident" id="3984798">VerifyHostname</span><span class="op" id="3984812">(</span><span class="ident" id="3984813">cfg</span><span class="op" id="3984816">.</span><span class="ident" id="3984817">ServerName</span><span class="op" id="3984827">)</span><span class="op" id="3984828">;</span>&nbsp;<span class="ident" id="3984830">err</span>&nbsp;<span class="op" id="3984834">!=</span>&nbsp;<span class="ident" id="3984837">nil</span>&nbsp;<span class="op" id="3984841">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3984847">plainConn</span><span class="op" id="3984856">.</span><span class="ident" id="3984857">Close</span><span class="op" id="3984862">(</span><span class="op" id="3984863">)</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3984869">return</span>&nbsp;<span class="ident" id="3984876">nil</span><span class="op" id="3984879">,</span>&nbsp;<span class="ident" id="3984881">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3984888">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3984892">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3984896">cs</span>&nbsp;<span class="op" id="3984899">:=</span>&nbsp;<span class="ident" id="3984902">tlsConn</span><span class="op" id="3984909">.</span><span class="ident" id="3984910">ConnectionState</span><span class="op" id="3984925">(</span><span class="op" id="3984926">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3984930">pconn</span><span class="op" id="3984935">.</span><span class="ident" id="3984936">tlsState</span>&nbsp;<span class="op" id="3984945">=</span>&nbsp;<span class="op" id="3984947">&amp;</span><span class="ident" id="3984948">cs</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3984953">pconn</span><span class="op" id="3984958">.</span><span class="ident" id="3984959">conn</span>&nbsp;<span class="op" id="3984964">=</span>&nbsp;<span class="ident" id="3984966">tlsConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3984975">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3984979">pconn</span><span class="op" id="3984984">.</span><span class="ident" id="3984985">br</span>&nbsp;<span class="op" id="3984988">=</span>&nbsp;<span class="ident" id="3984990">bufio</span><span class="op" id="3984995">.</span><span class="ident" id="3984996">NewReader</span><span class="op" id="3985005">(</span><span class="ident" id="3985006">noteEOFReader</span><span class="op" id="3985019">{</span><span class="ident" id="3985020">pconn</span><span class="op" id="3985025">.</span><span class="ident" id="3985026">conn</span><span class="op" id="3985030">,</span>&nbsp;<span class="op" id="3985032">&amp;</span><span class="ident" id="3985033">pconn</span><span class="op" id="3985038">.</span><span class="ident" id="3985039">sawEOF</span><span class="op" id="3985045">}</span><span class="op" id="3985046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3985049">pconn</span><span class="op" id="3985054">.</span><span class="ident" id="3985055">bw</span>&nbsp;<span class="op" id="3985058">=</span>&nbsp;<span class="ident" id="3985060">bufio</span><span class="op" id="3985065">.</span><span class="ident" id="3985066">NewWriter</span><span class="op" id="3985075">(</span><span class="ident" id="3985076">pconn</span><span class="op" id="3985081">.</span><span class="ident" id="3985082">conn</span><span class="op" id="3985086">)</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3985089">go</span>&nbsp;<span class="ident" id="3985092">pconn</span><span class="op" id="3985097">.</span><span class="ident" id="3985098">readLoop</span><span class="op" id="3985106">(</span><span class="op" id="3985107">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3985110">go</span>&nbsp;<span class="ident" id="3985113">pconn</span><span class="op" id="3985118">.</span><span class="ident" id="3985119">writeLoop</span><span class="op" id="3985128">(</span><span class="op" id="3985129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3985132">return</span>&nbsp;<span class="ident" id="3985139">pconn</span><span class="op" id="3985144">,</span>&nbsp;<span class="ident" id="3985146">nil</span><br>
<span class="lineno"></span><span class="op" id="3985150">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">665</span><span class="comment" id="3985153">//&nbsp;useProxy&nbsp;returns&nbsp;true&nbsp;if&nbsp;requests&nbsp;to&nbsp;addr&nbsp;should&nbsp;use&nbsp;a&nbsp;proxy,</span><br>
<span class="lineno"></span><span class="comment" id="3985218">//&nbsp;according&nbsp;to&nbsp;the&nbsp;NO_PROXY&nbsp;or&nbsp;no_proxy&nbsp;environment&nbsp;variable.</span><br>
<span class="lineno"></span><span class="comment" id="3985281">//&nbsp;addr&nbsp;is&nbsp;always&nbsp;a&nbsp;canonicalAddr&nbsp;with&nbsp;a&nbsp;host&nbsp;and&nbsp;port.</span><br>
<span class="lineno"></span><span class="keyword" id="3985337">func</span>&nbsp;<span class="ident" id="3985342">useProxy</span><span class="op" id="3985350">(</span><span class="ident" id="3985351">addr</span>&nbsp;<span class="builtintype" id="3985356">string</span><span class="op" id="3985362">)</span>&nbsp;<span class="builtintype" id="3985364">bool</span>&nbsp;<span class="op" id="3985369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3985372">if</span>&nbsp;<span class="builtinfunc" id="3985375">len</span><span class="op" id="3985378">(</span><span class="ident" id="3985379">addr</span><span class="op" id="3985383">)</span>&nbsp;<span class="op" id="3985385">==</span>&nbsp;<span class="num" id="3985388">0</span>&nbsp;<span class="op" id="3985390">{</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3985394">return</span>&nbsp;<span class="builtintype" id="3985401">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3985407">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3985410">host</span><span class="op" id="3985414">,</span>&nbsp;<span class="ident" id="3985416">_</span><span class="op" id="3985417">,</span>&nbsp;<span class="ident" id="3985419">err</span>&nbsp;<span class="op" id="3985423">:=</span>&nbsp;<span class="ident" id="3985426">net</span><span class="op" id="3985429">.</span><span class="ident" id="3985430">SplitHostPort</span><span class="op" id="3985443">(</span><span class="ident" id="3985444">addr</span><span class="op" id="3985448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3985451">if</span>&nbsp;<span class="ident" id="3985454">err</span>&nbsp;<span class="op" id="3985458">!=</span>&nbsp;<span class="ident" id="3985461">nil</span>&nbsp;<span class="op" id="3985465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3985469">return</span>&nbsp;<span class="builtintype" id="3985476">false</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3985483">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3985486">if</span>&nbsp;<span class="ident" id="3985489">host</span>&nbsp;<span class="op" id="3985494">==</span>&nbsp;<span class="string" id="3985497">&#34;localhost&#34;</span>&nbsp;<span class="op" id="3985509">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3985513">return</span>&nbsp;<span class="builtintype" id="3985520">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3985527">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3985530">if</span>&nbsp;<span class="ident" id="3985533">ip</span>&nbsp;<span class="op" id="3985536">:=</span>&nbsp;<span class="ident" id="3985539">net</span><span class="op" id="3985542">.</span><span class="ident" id="3985543">ParseIP</span><span class="op" id="3985550">(</span><span class="ident" id="3985551">host</span><span class="op" id="3985555">)</span><span class="op" id="3985556">;</span>&nbsp;<span class="ident" id="3985558">ip</span>&nbsp;<span class="op" id="3985561">!=</span>&nbsp;<span class="ident" id="3985564">nil</span>&nbsp;<span class="op" id="3985568">{</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3985572">if</span>&nbsp;<span class="ident" id="3985575">ip</span><span class="op" id="3985577">.</span><span class="ident" id="3985578">IsLoopback</span><span class="op" id="3985588">(</span><span class="op" id="3985589">)</span>&nbsp;<span class="op" id="3985591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3985596">return</span>&nbsp;<span class="builtintype" id="3985603">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3985611">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3985614">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3985618">no_proxy</span>&nbsp;<span class="op" id="3985627">:=</span>&nbsp;<span class="ident" id="3985630">noProxyEnv</span><span class="op" id="3985640">.</span><span class="ident" id="3985641">Get</span><span class="op" id="3985644">(</span><span class="op" id="3985645">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3985648">if</span>&nbsp;<span class="ident" id="3985651">no_proxy</span>&nbsp;<span class="op" id="3985660">==</span>&nbsp;<span class="string" id="3985663">&#34;*&#34;</span>&nbsp;<span class="op" id="3985667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3985671">return</span>&nbsp;<span class="builtintype" id="3985678">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3985685">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3985689">addr</span>&nbsp;<span class="op" id="3985694">=</span>&nbsp;<span class="ident" id="3985696">strings</span><span class="op" id="3985703">.</span><span class="ident" id="3985704">ToLower</span><span class="op" id="3985711">(</span><span class="ident" id="3985712">strings</span><span class="op" id="3985719">.</span><span class="ident" id="3985720">TrimSpace</span><span class="op" id="3985729">(</span><span class="ident" id="3985730">addr</span><span class="op" id="3985734">)</span><span class="op" id="3985735">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3985738">if</span>&nbsp;<span class="ident" id="3985741">hasPort</span><span class="op" id="3985748">(</span><span class="ident" id="3985749">addr</span><span class="op" id="3985753">)</span>&nbsp;<span class="op" id="3985755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3985759">addr</span>&nbsp;<span class="op" id="3985764">=</span>&nbsp;<span class="ident" id="3985766">addr</span><span class="op" id="3985770">[</span><span class="op" id="3985771">:</span><span class="ident" id="3985772">strings</span><span class="op" id="3985779">.</span><span class="ident" id="3985780">LastIndex</span><span class="op" id="3985789">(</span><span class="ident" id="3985790">addr</span><span class="op" id="3985794">,</span>&nbsp;<span class="string" id="3985796">&#34;:&#34;</span><span class="op" id="3985799">)</span><span class="op" id="3985800">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3985803">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3985807">for</span>&nbsp;<span class="ident" id="3985811">_</span><span class="op" id="3985812">,</span>&nbsp;<span class="ident" id="3985814">p</span>&nbsp;<span class="op" id="3985816">:=</span>&nbsp;<span class="keyword" id="3985819">range</span>&nbsp;<span class="ident" id="3985825">strings</span><span class="op" id="3985832">.</span><span class="ident" id="3985833">Split</span><span class="op" id="3985838">(</span><span class="ident" id="3985839">no_proxy</span><span class="op" id="3985847">,</span>&nbsp;<span class="string" id="3985849">&#34;,&#34;</span><span class="op" id="3985852">)</span>&nbsp;<span class="op" id="3985854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3985858">p</span>&nbsp;<span class="op" id="3985860">=</span>&nbsp;<span class="ident" id="3985862">strings</span><span class="op" id="3985869">.</span><span class="ident" id="3985870">ToLower</span><span class="op" id="3985877">(</span><span class="ident" id="3985878">strings</span><span class="op" id="3985885">.</span><span class="ident" id="3985886">TrimSpace</span><span class="op" id="3985895">(</span><span class="ident" id="3985896">p</span><span class="op" id="3985897">)</span><span class="op" id="3985898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3985902">if</span>&nbsp;<span class="builtinfunc" id="3985905">len</span><span class="op" id="3985908">(</span><span class="ident" id="3985909">p</span><span class="op" id="3985910">)</span>&nbsp;<span class="op" id="3985912">==</span>&nbsp;<span class="num" id="3985915">0</span>&nbsp;<span class="op" id="3985917">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3985922">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3985933">}</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3985937">if</span>&nbsp;<span class="ident" id="3985940">hasPort</span><span class="op" id="3985947">(</span><span class="ident" id="3985948">p</span><span class="op" id="3985949">)</span>&nbsp;<span class="op" id="3985951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3985956">p</span>&nbsp;<span class="op" id="3985958">=</span>&nbsp;<span class="ident" id="3985960">p</span><span class="op" id="3985961">[</span><span class="op" id="3985962">:</span><span class="ident" id="3985963">strings</span><span class="op" id="3985970">.</span><span class="ident" id="3985971">LastIndex</span><span class="op" id="3985980">(</span><span class="ident" id="3985981">p</span><span class="op" id="3985982">,</span>&nbsp;<span class="string" id="3985984">&#34;:&#34;</span><span class="op" id="3985987">)</span><span class="op" id="3985988">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3985992">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3985996">if</span>&nbsp;<span class="ident" id="3985999">addr</span>&nbsp;<span class="op" id="3986004">==</span>&nbsp;<span class="ident" id="3986007">p</span>&nbsp;<span class="op" id="3986009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3986014">return</span>&nbsp;<span class="builtintype" id="3986021">false</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3986029">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3986033">if</span>&nbsp;<span class="ident" id="3986036">p</span><span class="op" id="3986037">[</span><span class="num" id="3986038">0</span><span class="op" id="3986039">]</span>&nbsp;<span class="op" id="3986041">==</span>&nbsp;<span class="string" id="3986044">&#39;.&#39;</span>&nbsp;<span class="op" id="3986048">&amp;&amp;</span>&nbsp;<span class="op" id="3986051">(</span><span class="ident" id="3986052">strings</span><span class="op" id="3986059">.</span><span class="ident" id="3986060">HasSuffix</span><span class="op" id="3986069">(</span><span class="ident" id="3986070">addr</span><span class="op" id="3986074">,</span>&nbsp;<span class="ident" id="3986076">p</span><span class="op" id="3986077">)</span>&nbsp;<span class="op" id="3986079">||</span>&nbsp;<span class="ident" id="3986082">addr</span>&nbsp;<span class="op" id="3986087">==</span>&nbsp;<span class="ident" id="3986090">p</span><span class="op" id="3986091">[</span><span class="num" id="3986092">1</span><span class="op" id="3986093">:</span><span class="op" id="3986094">]</span><span class="op" id="3986095">)</span>&nbsp;<span class="op" id="3986097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3986102">//&nbsp;no_proxy&nbsp;&#34;.foo.com&#34;&nbsp;matches&nbsp;&#34;bar.foo.com&#34;&nbsp;or&nbsp;&#34;foo.com&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3986163">return</span>&nbsp;<span class="builtintype" id="3986170">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3986178">}</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3986182">if</span>&nbsp;<span class="ident" id="3986185">p</span><span class="op" id="3986186">[</span><span class="num" id="3986187">0</span><span class="op" id="3986188">]</span>&nbsp;<span class="op" id="3986190">!=</span>&nbsp;<span class="string" id="3986193">&#39;.&#39;</span>&nbsp;<span class="op" id="3986197">&amp;&amp;</span>&nbsp;<span class="ident" id="3986200">strings</span><span class="op" id="3986207">.</span><span class="ident" id="3986208">HasSuffix</span><span class="op" id="3986217">(</span><span class="ident" id="3986218">addr</span><span class="op" id="3986222">,</span>&nbsp;<span class="ident" id="3986224">p</span><span class="op" id="3986225">)</span>&nbsp;<span class="op" id="3986227">&amp;&amp;</span>&nbsp;<span class="ident" id="3986230">addr</span><span class="op" id="3986234">[</span><span class="builtinfunc" id="3986235">len</span><span class="op" id="3986238">(</span><span class="ident" id="3986239">addr</span><span class="op" id="3986243">)</span><span class="op" id="3986244">-</span><span class="builtinfunc" id="3986245">len</span><span class="op" id="3986248">(</span><span class="ident" id="3986249">p</span><span class="op" id="3986250">)</span><span class="op" id="3986251">-</span><span class="num" id="3986252">1</span><span class="op" id="3986253">]</span>&nbsp;<span class="op" id="3986255">==</span>&nbsp;<span class="string" id="3986258">&#39;.&#39;</span>&nbsp;<span class="op" id="3986262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3986267">//&nbsp;no_proxy&nbsp;&#34;foo.com&#34;&nbsp;matches&nbsp;&#34;bar.foo.com&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3986314">return</span>&nbsp;<span class="builtintype" id="3986321">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3986329">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3986332">}</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3986335">return</span>&nbsp;<span class="builtintype" id="3986342">true</span><br>
<span class="lineno"></span><span class="op" id="3986347">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3986350">//&nbsp;connectMethod&nbsp;is&nbsp;the&nbsp;map&nbsp;key&nbsp;(in&nbsp;its&nbsp;String&nbsp;form)&nbsp;for&nbsp;keeping&nbsp;persistent</span><br>
<span class="lineno"></span><span class="comment" id="3986426">//&nbsp;TCP&nbsp;connections&nbsp;alive&nbsp;for&nbsp;subsequent&nbsp;HTTP&nbsp;requests.</span><br>
<span class="lineno">720</span><span class="comment" id="3986481">//</span><br>
<span class="lineno"></span><span class="comment" id="3986484">//&nbsp;A&nbsp;connect&nbsp;method&nbsp;may&nbsp;be&nbsp;of&nbsp;the&nbsp;following&nbsp;types:</span><br>
<span class="lineno"></span><span class="comment" id="3986535">//</span><br>
<span class="lineno"></span><span class="comment" id="3986538">//&nbsp;Cache&nbsp;key&nbsp;form&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Description</span><br>
<span class="lineno"></span><span class="comment" id="3986583">//&nbsp;-----------------&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-------------------------</span><br>
<span class="lineno">725</span><span class="comment" id="3986642">//&nbsp;|http|foo.com&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http&nbsp;directly&nbsp;to&nbsp;server,&nbsp;no&nbsp;proxy</span><br>
<span class="lineno"></span><span class="comment" id="3986709">//&nbsp;|https|foo.com&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;https&nbsp;directly&nbsp;to&nbsp;server,&nbsp;no&nbsp;proxy</span><br>
<span class="lineno"></span><span class="comment" id="3986777">//&nbsp;http://proxy.com|https|foo.com&nbsp;&nbsp;http&nbsp;to&nbsp;proxy,&nbsp;then&nbsp;CONNECT&nbsp;to&nbsp;foo.com</span><br>
<span class="lineno"></span><span class="comment" id="3986851">//&nbsp;http://proxy.com|http&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http&nbsp;to&nbsp;proxy,&nbsp;http&nbsp;to&nbsp;anywhere&nbsp;after&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3986929">//</span><br>
<span class="lineno">730</span><span class="comment" id="3986932">//&nbsp;Note:&nbsp;no&nbsp;support&nbsp;to&nbsp;https&nbsp;to&nbsp;the&nbsp;proxy&nbsp;yet.</span><br>
<span class="lineno"></span><span class="comment" id="3986979">//</span><br>
<span class="lineno"></span><span class="keyword" id="3986982">type</span>&nbsp;<span class="ident" id="3986987">connectMethod</span>&nbsp;<span class="keyword" id="3987001">struct</span>&nbsp;<span class="op" id="3987008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3987011">proxyURL</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3987024">*</span><span class="ident" id="3987025">url</span><span class="op" id="3987028">.</span><span class="ident" id="3987029">URL</span>&nbsp;<span class="comment" id="3987033">//&nbsp;nil&nbsp;for&nbsp;no&nbsp;proxy,&nbsp;else&nbsp;full&nbsp;proxy&nbsp;URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3987075">targetScheme</span>&nbsp;<span class="builtintype" id="3987088">string</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3987097">//&nbsp;&#34;http&#34;&nbsp;or&nbsp;&#34;https&#34;</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3987119">targetAddr</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3987132">string</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3987141">//&nbsp;Not&nbsp;used&nbsp;if&nbsp;proxy&nbsp;+&nbsp;http&nbsp;targetScheme&nbsp;(4th&nbsp;example&nbsp;in&nbsp;table)</span><br>
<span class="lineno"></span><span class="op" id="3987205">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3987208">func</span>&nbsp;<span class="op" id="3987213">(</span><span class="ident" id="3987214">cm</span>&nbsp;<span class="op" id="3987217">*</span><span class="ident" id="3987218">connectMethod</span><span class="op" id="3987231">)</span>&nbsp;<span class="ident" id="3987233">key</span><span class="op" id="3987236">(</span><span class="op" id="3987237">)</span>&nbsp;<span class="ident" id="3987239">connectMethodKey</span>&nbsp;<span class="op" id="3987256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3987259">proxyStr</span>&nbsp;<span class="op" id="3987268">:=</span>&nbsp;<span class="string" id="3987271">&#34;&#34;</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3987275">targetAddr</span>&nbsp;<span class="op" id="3987286">:=</span>&nbsp;<span class="ident" id="3987289">cm</span><span class="op" id="3987291">.</span><span class="ident" id="3987292">targetAddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3987304">if</span>&nbsp;<span class="ident" id="3987307">cm</span><span class="op" id="3987309">.</span><span class="ident" id="3987310">proxyURL</span>&nbsp;<span class="op" id="3987319">!=</span>&nbsp;<span class="ident" id="3987322">nil</span>&nbsp;<span class="op" id="3987326">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3987330">proxyStr</span>&nbsp;<span class="op" id="3987339">=</span>&nbsp;<span class="ident" id="3987341">cm</span><span class="op" id="3987343">.</span><span class="ident" id="3987344">proxyURL</span><span class="op" id="3987352">.</span><span class="ident" id="3987353">String</span><span class="op" id="3987359">(</span><span class="op" id="3987360">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3987364">if</span>&nbsp;<span class="ident" id="3987367">cm</span><span class="op" id="3987369">.</span><span class="ident" id="3987370">targetScheme</span>&nbsp;<span class="op" id="3987383">==</span>&nbsp;<span class="string" id="3987386">&#34;http&#34;</span>&nbsp;<span class="op" id="3987393">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3987398">targetAddr</span>&nbsp;<span class="op" id="3987409">=</span>&nbsp;<span class="string" id="3987411">&#34;&#34;</span><br>
<span class="lineno">745</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3987416">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3987419">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3987422">return</span>&nbsp;<span class="ident" id="3987429">connectMethodKey</span><span class="op" id="3987445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3987449">proxy</span><span class="op" id="3987454">:</span>&nbsp;&nbsp;<span class="ident" id="3987457">proxyStr</span><span class="op" id="3987465">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3987469">scheme</span><span class="op" id="3987475">:</span>&nbsp;<span class="ident" id="3987477">cm</span><span class="op" id="3987479">.</span><span class="ident" id="3987480">targetScheme</span><span class="op" id="3987492">,</span><br>
<span class="lineno">750</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3987496">addr</span><span class="op" id="3987500">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3987504">targetAddr</span><span class="op" id="3987514">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3987517">}</span><br>
<span class="lineno"></span><span class="op" id="3987519">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3987522">//&nbsp;addr&nbsp;returns&nbsp;the&nbsp;first&nbsp;hop&nbsp;&#34;host:port&#34;&nbsp;to&nbsp;which&nbsp;we&nbsp;need&nbsp;to&nbsp;TCP&nbsp;connect.</span><br>
<span class="lineno">755</span><span class="keyword" id="3987597">func</span>&nbsp;<span class="op" id="3987602">(</span><span class="ident" id="3987603">cm</span>&nbsp;<span class="op" id="3987606">*</span><span class="ident" id="3987607">connectMethod</span><span class="op" id="3987620">)</span>&nbsp;<span class="ident" id="3987622">addr</span><span class="op" id="3987626">(</span><span class="op" id="3987627">)</span>&nbsp;<span class="builtintype" id="3987629">string</span>&nbsp;<span class="op" id="3987636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3987639">if</span>&nbsp;<span class="ident" id="3987642">cm</span><span class="op" id="3987644">.</span><span class="ident" id="3987645">proxyURL</span>&nbsp;<span class="op" id="3987654">!=</span>&nbsp;<span class="ident" id="3987657">nil</span>&nbsp;<span class="op" id="3987661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3987665">return</span>&nbsp;<span class="ident" id="3987672">canonicalAddr</span><span class="op" id="3987685">(</span><span class="ident" id="3987686">cm</span><span class="op" id="3987688">.</span><span class="ident" id="3987689">proxyURL</span><span class="op" id="3987697">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3987700">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3987703">return</span>&nbsp;<span class="ident" id="3987710">cm</span><span class="op" id="3987712">.</span><span class="ident" id="3987713">targetAddr</span><br>
<span class="lineno">760</span><span class="op" id="3987724">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3987727">//&nbsp;tlsHost&nbsp;returns&nbsp;the&nbsp;host&nbsp;name&nbsp;to&nbsp;match&nbsp;against&nbsp;the&nbsp;peer&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="3987788">//&nbsp;TLS&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="keyword" id="3987808">func</span>&nbsp;<span class="op" id="3987813">(</span><span class="ident" id="3987814">cm</span>&nbsp;<span class="op" id="3987817">*</span><span class="ident" id="3987818">connectMethod</span><span class="op" id="3987831">)</span>&nbsp;<span class="ident" id="3987833">tlsHost</span><span class="op" id="3987840">(</span><span class="op" id="3987841">)</span>&nbsp;<span class="builtintype" id="3987843">string</span>&nbsp;<span class="op" id="3987850">{</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3987853">h</span>&nbsp;<span class="op" id="3987855">:=</span>&nbsp;<span class="ident" id="3987858">cm</span><span class="op" id="3987860">.</span><span class="ident" id="3987861">targetAddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3987873">if</span>&nbsp;<span class="ident" id="3987876">hasPort</span><span class="op" id="3987883">(</span><span class="ident" id="3987884">h</span><span class="op" id="3987885">)</span>&nbsp;<span class="op" id="3987887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3987891">h</span>&nbsp;<span class="op" id="3987893">=</span>&nbsp;<span class="ident" id="3987895">h</span><span class="op" id="3987896">[</span><span class="op" id="3987897">:</span><span class="ident" id="3987898">strings</span><span class="op" id="3987905">.</span><span class="ident" id="3987906">LastIndex</span><span class="op" id="3987915">(</span><span class="ident" id="3987916">h</span><span class="op" id="3987917">,</span>&nbsp;<span class="string" id="3987919">&#34;:&#34;</span><span class="op" id="3987922">)</span><span class="op" id="3987923">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3987926">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3987929">return</span>&nbsp;<span class="ident" id="3987936">h</span><br>
<span class="lineno">770</span><span class="op" id="3987938">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3987941">//&nbsp;connectMethodKey&nbsp;is&nbsp;the&nbsp;map&nbsp;key&nbsp;version&nbsp;of&nbsp;connectMethod,&nbsp;with&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3988009">//&nbsp;stringified&nbsp;proxy&nbsp;URL&nbsp;(or&nbsp;the&nbsp;empty&nbsp;string)&nbsp;instead&nbsp;of&nbsp;a&nbsp;pointer&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3988080">//&nbsp;a&nbsp;URL.</span><br>
<span class="lineno">775</span><span class="keyword" id="3988090">type</span>&nbsp;<span class="ident" id="3988095">connectMethodKey</span>&nbsp;<span class="keyword" id="3988112">struct</span>&nbsp;<span class="op" id="3988119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3988122">proxy</span><span class="op" id="3988127">,</span>&nbsp;<span class="ident" id="3988129">scheme</span><span class="op" id="3988135">,</span>&nbsp;<span class="ident" id="3988137">addr</span>&nbsp;<span class="builtintype" id="3988142">string</span><br>
<span class="lineno"></span><span class="op" id="3988149">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3988152">func</span>&nbsp;<span class="op" id="3988157">(</span><span class="ident" id="3988158">k</span>&nbsp;<span class="ident" id="3988160">connectMethodKey</span><span class="op" id="3988176">)</span>&nbsp;<span class="ident" id="3988178">String</span><span class="op" id="3988184">(</span><span class="op" id="3988185">)</span>&nbsp;<span class="builtintype" id="3988187">string</span>&nbsp;<span class="op" id="3988194">{</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3988197">//&nbsp;Only&nbsp;used&nbsp;by&nbsp;tests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3988221">return</span>&nbsp;<span class="ident" id="3988228">fmt</span><span class="op" id="3988231">.</span><span class="ident" id="3988232">Sprintf</span><span class="op" id="3988239">(</span><span class="string" id="3988240">&#34;%s|%s|%s&#34;</span><span class="op" id="3988250">,</span>&nbsp;<span class="ident" id="3988252">k</span><span class="op" id="3988253">.</span><span class="ident" id="3988254">proxy</span><span class="op" id="3988259">,</span>&nbsp;<span class="ident" id="3988261">k</span><span class="op" id="3988262">.</span><span class="ident" id="3988263">scheme</span><span class="op" id="3988269">,</span>&nbsp;<span class="ident" id="3988271">k</span><span class="op" id="3988272">.</span><span class="ident" id="3988273">addr</span><span class="op" id="3988277">)</span><br>
<span class="lineno"></span><span class="op" id="3988279">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3988282">//&nbsp;persistConn&nbsp;wraps&nbsp;a&nbsp;connection,&nbsp;usually&nbsp;a&nbsp;persistent&nbsp;one</span><br>
<span class="lineno">785</span><span class="comment" id="3988342">//&nbsp;(but&nbsp;may&nbsp;be&nbsp;used&nbsp;for&nbsp;non-keep-alive&nbsp;requests&nbsp;as&nbsp;well)</span><br>
<span class="lineno"></span><span class="keyword" id="3988399">type</span>&nbsp;<span class="ident" id="3988404">persistConn</span>&nbsp;<span class="keyword" id="3988416">struct</span>&nbsp;<span class="op" id="3988423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3988426">t</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3988435">*</span><span class="ident" id="3988436">Transport</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3988447">cacheKey</span>&nbsp;<span class="ident" id="3988456">connectMethodKey</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3988474">conn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3988483">net</span><span class="op" id="3988486">.</span><span class="ident" id="3988487">Conn</span><br>
<span class="lineno">790</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3988493">tlsState</span>&nbsp;<span class="op" id="3988502">*</span><span class="ident" id="3988503">tls</span><span class="op" id="3988506">.</span><span class="ident" id="3988507">ConnectionState</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3988524">br</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3988533">*</span><span class="ident" id="3988534">bufio</span><span class="op" id="3988539">.</span><span class="ident" id="3988540">Reader</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3988553">//&nbsp;from&nbsp;conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3988567">sawEOF</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3988576">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3988596">//&nbsp;whether&nbsp;we&#39;ve&nbsp;seen&nbsp;EOF&nbsp;from&nbsp;conn;&nbsp;owned&nbsp;by&nbsp;readLoop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3988652">bw</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3988661">*</span><span class="ident" id="3988662">bufio</span><span class="op" id="3988667">.</span><span class="ident" id="3988668">Writer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3988681">//&nbsp;to&nbsp;conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3988693">reqch</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3988702">chan</span>&nbsp;<span class="ident" id="3988707">requestAndChan</span>&nbsp;<span class="comment" id="3988722">//&nbsp;written&nbsp;by&nbsp;roundTrip;&nbsp;read&nbsp;by&nbsp;readLoop</span><br>
<span class="lineno">795</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3988765">writech</span>&nbsp;&nbsp;<span class="keyword" id="3988774">chan</span>&nbsp;<span class="ident" id="3988779">writeRequest</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3988794">//&nbsp;written&nbsp;by&nbsp;roundTrip;&nbsp;read&nbsp;by&nbsp;writeLoop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3988838">closech</span>&nbsp;&nbsp;<span class="keyword" id="3988847">chan</span>&nbsp;<span class="keyword" id="3988852">struct</span><span class="op" id="3988858">{</span><span class="op" id="3988859">}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3988867">//&nbsp;closed&nbsp;when&nbsp;conn&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3988895">isProxy</span>&nbsp;&nbsp;<span class="builtintype" id="3988904">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3988910">//&nbsp;writeErrCh&nbsp;passes&nbsp;the&nbsp;request&nbsp;write&nbsp;error&nbsp;(usually&nbsp;nil)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3988970">//&nbsp;from&nbsp;the&nbsp;writeLoop&nbsp;goroutine&nbsp;to&nbsp;the&nbsp;readLoop&nbsp;which&nbsp;passes</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3989032">//&nbsp;it&nbsp;off&nbsp;to&nbsp;the&nbsp;res.Body&nbsp;reader,&nbsp;which&nbsp;then&nbsp;uses&nbsp;it&nbsp;to&nbsp;decide</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3989096">//&nbsp;whether&nbsp;or&nbsp;not&nbsp;a&nbsp;connection&nbsp;can&nbsp;be&nbsp;reused.&nbsp;Issue&nbsp;7569.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3989155">writeErrCh</span>&nbsp;<span class="keyword" id="3989166">chan</span>&nbsp;<span class="builtintype" id="3989171">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3989179">lk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3989200">sync</span><span class="op" id="3989204">.</span><span class="ident" id="3989205">Mutex</span>&nbsp;<span class="comment" id="3989211">//&nbsp;guards&nbsp;following&nbsp;fields</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3989239">numExpectedResponses</span>&nbsp;<span class="builtintype" id="3989260">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3989265">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3989286">bool</span>&nbsp;<span class="comment" id="3989291">//&nbsp;whether&nbsp;conn&nbsp;has&nbsp;been&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3989324">broken</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3989345">bool</span>&nbsp;<span class="comment" id="3989350">//&nbsp;an&nbsp;error&nbsp;has&nbsp;happened&nbsp;on&nbsp;this&nbsp;connection;&nbsp;marked&nbsp;broken&nbsp;so&nbsp;it&#39;s&nbsp;not&nbsp;reused.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3989430">//&nbsp;mutateHeaderFunc&nbsp;is&nbsp;an&nbsp;optional&nbsp;func&nbsp;to&nbsp;modify&nbsp;extra</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3989487">//&nbsp;headers&nbsp;on&nbsp;each&nbsp;outbound&nbsp;request&nbsp;before&nbsp;it&#39;s&nbsp;written.&nbsp;(the</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3989550">//&nbsp;original&nbsp;Request&nbsp;given&nbsp;to&nbsp;RoundTrip&nbsp;is&nbsp;not&nbsp;modified)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3989607">mutateHeaderFunc</span>&nbsp;<span class="keyword" id="3989624">func</span><span class="op" id="3989628">(</span><span class="ident" id="3989629">Header</span><span class="op" id="3989635">)</span><br>
<span class="lineno"></span><span class="op" id="3989637">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3989640">//&nbsp;isBroken&nbsp;reports&nbsp;whether&nbsp;this&nbsp;connection&nbsp;is&nbsp;in&nbsp;a&nbsp;known&nbsp;broken&nbsp;state.</span><br>
<span class="lineno">815</span><span class="keyword" id="3989712">func</span>&nbsp;<span class="op" id="3989717">(</span><span class="ident" id="3989718">pc</span>&nbsp;<span class="op" id="3989721">*</span><span class="ident" id="3989722">persistConn</span><span class="op" id="3989733">)</span>&nbsp;<span class="ident" id="3989735">isBroken</span><span class="op" id="3989743">(</span><span class="op" id="3989744">)</span>&nbsp;<span class="builtintype" id="3989746">bool</span>&nbsp;<span class="op" id="3989751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3989754">pc</span><span class="op" id="3989756">.</span><span class="ident" id="3989757">lk</span><span class="op" id="3989759">.</span><span class="ident" id="3989760">Lock</span><span class="op" id="3989764">(</span><span class="op" id="3989765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3989768">b</span>&nbsp;<span class="op" id="3989770">:=</span>&nbsp;<span class="ident" id="3989773">pc</span><span class="op" id="3989775">.</span><span class="ident" id="3989776">broken</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3989784">pc</span><span class="op" id="3989786">.</span><span class="ident" id="3989787">lk</span><span class="op" id="3989789">.</span><span class="ident" id="3989790">Unlock</span><span class="op" id="3989796">(</span><span class="op" id="3989797">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3989800">return</span>&nbsp;<span class="ident" id="3989807">b</span><br>
<span class="lineno">820</span><span class="op" id="3989809">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3989812">func</span>&nbsp;<span class="op" id="3989817">(</span><span class="ident" id="3989818">pc</span>&nbsp;<span class="op" id="3989821">*</span><span class="ident" id="3989822">persistConn</span><span class="op" id="3989833">)</span>&nbsp;<span class="ident" id="3989835">cancelRequest</span><span class="op" id="3989848">(</span><span class="op" id="3989849">)</span>&nbsp;<span class="op" id="3989851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3989854">pc</span><span class="op" id="3989856">.</span><span class="ident" id="3989857">conn</span><span class="op" id="3989861">.</span><span class="ident" id="3989862">Close</span><span class="op" id="3989867">(</span><span class="op" id="3989868">)</span><br>
<span class="lineno"></span><span class="op" id="3989870">}</span><br>
<span class="lineno">825</span><br>
<span class="lineno"></span><span class="keyword" id="3989873">var</span>&nbsp;<span class="ident" id="3989877">remoteSideClosedFunc</span>&nbsp;<span class="keyword" id="3989898">func</span><span class="op" id="3989902">(</span><span class="builtintype" id="3989903">error</span><span class="op" id="3989908">)</span>&nbsp;<span class="builtintype" id="3989910">bool</span>&nbsp;<span class="comment" id="3989915">//&nbsp;or&nbsp;nil&nbsp;to&nbsp;use&nbsp;default</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3989941">func</span>&nbsp;<span class="ident" id="3989946">remoteSideClosed</span><span class="op" id="3989962">(</span><span class="ident" id="3989963">err</span>&nbsp;<span class="builtintype" id="3989967">error</span><span class="op" id="3989972">)</span>&nbsp;<span class="builtintype" id="3989974">bool</span>&nbsp;<span class="op" id="3989979">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3989982">if</span>&nbsp;<span class="ident" id="3989985">err</span>&nbsp;<span class="op" id="3989989">==</span>&nbsp;<span class="ident" id="3989992">io</span><span class="op" id="3989994">.</span><span class="ident" id="3989995">EOF</span>&nbsp;<span class="op" id="3989999">{</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3990003">return</span>&nbsp;<span class="builtintype" id="3990010">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3990016">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3990019">if</span>&nbsp;<span class="ident" id="3990022">remoteSideClosedFunc</span>&nbsp;<span class="op" id="3990043">!=</span>&nbsp;<span class="ident" id="3990046">nil</span>&nbsp;<span class="op" id="3990050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3990054">return</span>&nbsp;<span class="ident" id="3990061">remoteSideClosedFunc</span><span class="op" id="3990081">(</span><span class="ident" id="3990082">err</span><span class="op" id="3990085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3990088">}</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3990091">return</span>&nbsp;<span class="builtintype" id="3990098">false</span><br>
<span class="lineno"></span><span class="op" id="3990104">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3990107">func</span>&nbsp;<span class="op" id="3990112">(</span><span class="ident" id="3990113">pc</span>&nbsp;<span class="op" id="3990116">*</span><span class="ident" id="3990117">persistConn</span><span class="op" id="3990128">)</span>&nbsp;<span class="ident" id="3990130">readLoop</span><span class="op" id="3990138">(</span><span class="op" id="3990139">)</span>&nbsp;<span class="op" id="3990141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3990144">alive</span>&nbsp;<span class="op" id="3990150">:=</span>&nbsp;<span class="builtintype" id="3990153">true</span><br>
<span class="lineno">840</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3990160">for</span>&nbsp;<span class="ident" id="3990164">alive</span>&nbsp;<span class="op" id="3990170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3990174">pb</span><span class="op" id="3990176">,</span>&nbsp;<span class="ident" id="3990178">err</span>&nbsp;<span class="op" id="3990182">:=</span>&nbsp;<span class="ident" id="3990185">pc</span><span class="op" id="3990187">.</span><span class="ident" id="3990188">br</span><span class="op" id="3990190">.</span><span class="ident" id="3990191">Peek</span><span class="op" id="3990195">(</span><span class="num" id="3990196">1</span><span class="op" id="3990197">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3990202">pc</span><span class="op" id="3990204">.</span><span class="ident" id="3990205">lk</span><span class="op" id="3990207">.</span><span class="ident" id="3990208">Lock</span><span class="op" id="3990212">(</span><span class="op" id="3990213">)</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3990217">if</span>&nbsp;<span class="ident" id="3990220">pc</span><span class="op" id="3990222">.</span><span class="ident" id="3990223">numExpectedResponses</span>&nbsp;<span class="op" id="3990244">==</span>&nbsp;<span class="num" id="3990247">0</span>&nbsp;<span class="op" id="3990249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3990254">if</span>&nbsp;<span class="op" id="3990257">!</span><span class="ident" id="3990258">pc</span><span class="op" id="3990260">.</span><span class="ident" id="3990261">closed</span>&nbsp;<span class="op" id="3990268">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3990274">pc</span><span class="op" id="3990276">.</span><span class="ident" id="3990277">closeLocked</span><span class="op" id="3990288">(</span><span class="op" id="3990289">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3990295">if</span>&nbsp;<span class="builtinfunc" id="3990298">len</span><span class="op" id="3990301">(</span><span class="ident" id="3990302">pb</span><span class="op" id="3990304">)</span>&nbsp;<span class="op" id="3990306">&gt;</span>&nbsp;<span class="num" id="3990308">0</span>&nbsp;<span class="op" id="3990310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3990317">log</span><span class="op" id="3990320">.</span><span class="ident" id="3990321">Printf</span><span class="op" id="3990327">(</span><span class="string" id="3990328">&#34;Unsolicited&nbsp;response&nbsp;received&nbsp;on&nbsp;idle&nbsp;HTTP&nbsp;channel&nbsp;starting&nbsp;with&nbsp;%q;&nbsp;err=%v&#34;</span><span class="op" id="3990405">,</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="3990413">string</span><span class="op" id="3990419">(</span><span class="ident" id="3990420">pb</span><span class="op" id="3990422">)</span><span class="op" id="3990423">,</span>&nbsp;<span class="ident" id="3990425">err</span><span class="op" id="3990428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3990434">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3990439">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3990444">pc</span><span class="op" id="3990446">.</span><span class="ident" id="3990447">lk</span><span class="op" id="3990449">.</span><span class="ident" id="3990450">Unlock</span><span class="op" id="3990456">(</span><span class="op" id="3990457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3990462">return</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3990471">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3990475">pc</span><span class="op" id="3990477">.</span><span class="ident" id="3990478">lk</span><span class="op" id="3990480">.</span><span class="ident" id="3990481">Unlock</span><span class="op" id="3990487">(</span><span class="op" id="3990488">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3990493">rc</span>&nbsp;<span class="op" id="3990496">:=</span>&nbsp;<span class="op" id="3990499">&lt;-</span><span class="ident" id="3990501">pc</span><span class="op" id="3990503">.</span><span class="ident" id="3990504">reqch</span><br>
<span class="lineno"></span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3990513">var</span>&nbsp;<span class="ident" id="3990517">resp</span>&nbsp;<span class="op" id="3990522">*</span><span class="ident" id="3990523">Response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3990534">if</span>&nbsp;<span class="ident" id="3990537">err</span>&nbsp;<span class="op" id="3990541">==</span>&nbsp;<span class="ident" id="3990544">nil</span>&nbsp;<span class="op" id="3990548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3990553">resp</span><span class="op" id="3990557">,</span>&nbsp;<span class="ident" id="3990559">err</span>&nbsp;<span class="op" id="3990563">=</span>&nbsp;<span class="ident" id="3990565">ReadResponse</span><span class="op" id="3990577">(</span><span class="ident" id="3990578">pc</span><span class="op" id="3990580">.</span><span class="ident" id="3990581">br</span><span class="op" id="3990583">,</span>&nbsp;<span class="ident" id="3990585">rc</span><span class="op" id="3990587">.</span><span class="ident" id="3990588">req</span><span class="op" id="3990591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3990596">if</span>&nbsp;<span class="ident" id="3990599">err</span>&nbsp;<span class="op" id="3990603">==</span>&nbsp;<span class="ident" id="3990606">nil</span>&nbsp;<span class="op" id="3990610">&amp;&amp;</span>&nbsp;<span class="ident" id="3990613">resp</span><span class="op" id="3990617">.</span><span class="ident" id="3990618">StatusCode</span>&nbsp;<span class="op" id="3990629">==</span>&nbsp;<span class="num" id="3990632">100</span>&nbsp;<span class="op" id="3990636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3990642">//&nbsp;Skip&nbsp;any&nbsp;100-continue&nbsp;for&nbsp;now.</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3990680">//&nbsp;TODO(bradfitz):&nbsp;if&nbsp;rc.req&nbsp;had&nbsp;&#34;Expect:&nbsp;100-continue&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3990741">//&nbsp;actually&nbsp;block&nbsp;the&nbsp;request&nbsp;body&nbsp;write&nbsp;and&nbsp;signal&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3990801">//&nbsp;writeLoop&nbsp;now&nbsp;to&nbsp;begin&nbsp;sending&nbsp;it.&nbsp;(Issue&nbsp;2184)&nbsp;For&nbsp;now&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3990867">//&nbsp;eat&nbsp;it,&nbsp;since&nbsp;we&#39;re&nbsp;never&nbsp;expecting&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3990915">resp</span><span class="op" id="3990919">,</span>&nbsp;<span class="ident" id="3990921">err</span>&nbsp;<span class="op" id="3990925">=</span>&nbsp;<span class="ident" id="3990927">ReadResponse</span><span class="op" id="3990939">(</span><span class="ident" id="3990940">pc</span><span class="op" id="3990942">.</span><span class="ident" id="3990943">br</span><span class="op" id="3990945">,</span>&nbsp;<span class="ident" id="3990947">rc</span><span class="op" id="3990949">.</span><span class="ident" id="3990950">req</span><span class="op" id="3990953">)</span><br>
<span class="lineno">870</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3990958">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3990962">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3990967">if</span>&nbsp;<span class="ident" id="3990970">resp</span>&nbsp;<span class="op" id="3990975">!=</span>&nbsp;<span class="ident" id="3990978">nil</span>&nbsp;<span class="op" id="3990982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3990987">resp</span><span class="op" id="3990991">.</span><span class="ident" id="3990992">TLS</span>&nbsp;<span class="op" id="3990996">=</span>&nbsp;<span class="ident" id="3990998">pc</span><span class="op" id="3991000">.</span><span class="ident" id="3991001">tlsState</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3991012">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3991017">hasBody</span>&nbsp;<span class="op" id="3991025">:=</span>&nbsp;<span class="ident" id="3991028">resp</span>&nbsp;<span class="op" id="3991033">!=</span>&nbsp;<span class="ident" id="3991036">nil</span>&nbsp;<span class="op" id="3991040">&amp;&amp;</span>&nbsp;<span class="ident" id="3991043">rc</span><span class="op" id="3991045">.</span><span class="ident" id="3991046">req</span><span class="op" id="3991049">.</span><span class="ident" id="3991050">Method</span>&nbsp;<span class="op" id="3991057">!=</span>&nbsp;<span class="string" id="3991060">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="3991067">&amp;&amp;</span>&nbsp;<span class="ident" id="3991070">resp</span><span class="op" id="3991074">.</span><span class="ident" id="3991075">ContentLength</span>&nbsp;<span class="op" id="3991089">!=</span>&nbsp;<span class="num" id="3991092">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3991097">if</span>&nbsp;<span class="ident" id="3991100">err</span>&nbsp;<span class="op" id="3991104">!=</span>&nbsp;<span class="ident" id="3991107">nil</span>&nbsp;<span class="op" id="3991111">{</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3991116">pc</span><span class="op" id="3991118">.</span><span class="builtinfunc" id="3991119">close</span><span class="op" id="3991124">(</span><span class="op" id="3991125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3991129">}</span>&nbsp;<span class="keyword" id="3991131">else</span>&nbsp;<span class="op" id="3991136">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3991141">if</span>&nbsp;<span class="ident" id="3991144">rc</span><span class="op" id="3991146">.</span><span class="ident" id="3991147">addedGzip</span>&nbsp;<span class="op" id="3991157">&amp;&amp;</span>&nbsp;<span class="ident" id="3991160">hasBody</span>&nbsp;<span class="op" id="3991168">&amp;&amp;</span>&nbsp;<span class="ident" id="3991171">resp</span><span class="op" id="3991175">.</span><span class="ident" id="3991176">Header</span><span class="op" id="3991182">.</span><span class="ident" id="3991183">Get</span><span class="op" id="3991186">(</span><span class="string" id="3991187">&#34;Content-Encoding&#34;</span><span class="op" id="3991205">)</span>&nbsp;<span class="op" id="3991207">==</span>&nbsp;<span class="string" id="3991210">&#34;gzip&#34;</span>&nbsp;<span class="op" id="3991217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3991223">resp</span><span class="op" id="3991227">.</span><span class="ident" id="3991228">Header</span><span class="op" id="3991234">.</span><span class="ident" id="3991235">Del</span><span class="op" id="3991238">(</span><span class="string" id="3991239">&#34;Content-Encoding&#34;</span><span class="op" id="3991257">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3991263">resp</span><span class="op" id="3991267">.</span><span class="ident" id="3991268">Header</span><span class="op" id="3991274">.</span><span class="ident" id="3991275">Del</span><span class="op" id="3991278">(</span><span class="string" id="3991279">&#34;Content-Length&#34;</span><span class="op" id="3991295">)</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3991301">resp</span><span class="op" id="3991305">.</span><span class="ident" id="3991306">ContentLength</span>&nbsp;<span class="op" id="3991320">=</span>&nbsp;<span class="op" id="3991322">-</span><span class="num" id="3991323">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3991329">resp</span><span class="op" id="3991333">.</span><span class="ident" id="3991334">Body</span>&nbsp;<span class="op" id="3991339">=</span>&nbsp;<span class="op" id="3991341">&amp;</span><span class="ident" id="3991342">gzipReader</span><span class="op" id="3991352">{</span><span class="ident" id="3991353">body</span><span class="op" id="3991357">:</span>&nbsp;<span class="ident" id="3991359">resp</span><span class="op" id="3991363">.</span><span class="ident" id="3991364">Body</span><span class="op" id="3991368">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3991373">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3991378">resp</span><span class="op" id="3991382">.</span><span class="ident" id="3991383">Body</span>&nbsp;<span class="op" id="3991388">=</span>&nbsp;<span class="op" id="3991390">&amp;</span><span class="ident" id="3991391">bodyEOFSignal</span><span class="op" id="3991404">{</span><span class="ident" id="3991405">body</span><span class="op" id="3991409">:</span>&nbsp;<span class="ident" id="3991411">resp</span><span class="op" id="3991415">.</span><span class="ident" id="3991416">Body</span><span class="op" id="3991420">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3991424">}</span><br>
<span class="lineno">890</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3991429">if</span>&nbsp;<span class="ident" id="3991432">err</span>&nbsp;<span class="op" id="3991436">!=</span>&nbsp;<span class="ident" id="3991439">nil</span>&nbsp;<span class="op" id="3991443">||</span>&nbsp;<span class="ident" id="3991446">resp</span><span class="op" id="3991450">.</span><span class="ident" id="3991451">Close</span>&nbsp;<span class="op" id="3991457">||</span>&nbsp;<span class="ident" id="3991460">rc</span><span class="op" id="3991462">.</span><span class="ident" id="3991463">req</span><span class="op" id="3991466">.</span><span class="ident" id="3991467">Close</span>&nbsp;<span class="op" id="3991473">||</span>&nbsp;<span class="ident" id="3991476">resp</span><span class="op" id="3991480">.</span><span class="ident" id="3991481">StatusCode</span>&nbsp;<span class="op" id="3991492">&lt;=</span>&nbsp;<span class="num" id="3991495">199</span>&nbsp;<span class="op" id="3991499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3991504">//&nbsp;Don&#39;t&nbsp;do&nbsp;keep-alive&nbsp;on&nbsp;error&nbsp;if&nbsp;either&nbsp;party&nbsp;requested&nbsp;a&nbsp;close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3991573">//&nbsp;or&nbsp;we&nbsp;get&nbsp;an&nbsp;unexpected&nbsp;informational&nbsp;(1xx)&nbsp;response.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3991633">//&nbsp;StatusCode&nbsp;100&nbsp;is&nbsp;already&nbsp;handled&nbsp;above.</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3991680">alive</span>&nbsp;<span class="op" id="3991686">=</span>&nbsp;<span class="builtintype" id="3991688">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3991696">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3991701">var</span>&nbsp;<span class="ident" id="3991705">waitForBodyRead</span>&nbsp;<span class="keyword" id="3991721">chan</span>&nbsp;<span class="builtintype" id="3991726">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3991733">if</span>&nbsp;<span class="ident" id="3991736">hasBody</span>&nbsp;<span class="op" id="3991744">{</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3991749">waitForBodyRead</span>&nbsp;<span class="op" id="3991765">=</span>&nbsp;<span class="builtinfunc" id="3991767">make</span><span class="op" id="3991771">(</span><span class="keyword" id="3991772">chan</span>&nbsp;<span class="builtintype" id="3991777">bool</span><span class="op" id="3991781">,</span>&nbsp;<span class="num" id="3991783">2</span><span class="op" id="3991784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3991789">resp</span><span class="op" id="3991793">.</span><span class="ident" id="3991794">Body</span><span class="op" id="3991798">.</span><span class="op" id="3991799">(</span><span class="op" id="3991800">*</span><span class="ident" id="3991801">bodyEOFSignal</span><span class="op" id="3991814">)</span><span class="op" id="3991815">.</span><span class="ident" id="3991816">earlyCloseFn</span>&nbsp;<span class="op" id="3991829">=</span>&nbsp;<span class="keyword" id="3991831">func</span><span class="op" id="3991835">(</span><span class="op" id="3991836">)</span>&nbsp;<span class="builtintype" id="3991838">error</span>&nbsp;<span class="op" id="3991844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3991850">//&nbsp;Sending&nbsp;false&nbsp;here&nbsp;sets&nbsp;alive&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3991890">//&nbsp;false&nbsp;and&nbsp;closes&nbsp;the&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3991929">//&nbsp;below.</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3991943">waitForBodyRead</span>&nbsp;<span class="op" id="3991959">&lt;-</span>&nbsp;<span class="builtintype" id="3991962">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3991972">return</span>&nbsp;<span class="ident" id="3991979">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3991986">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3991991">resp</span><span class="op" id="3991995">.</span><span class="ident" id="3991996">Body</span><span class="op" id="3992000">.</span><span class="op" id="3992001">(</span><span class="op" id="3992002">*</span><span class="ident" id="3992003">bodyEOFSignal</span><span class="op" id="3992016">)</span><span class="op" id="3992017">.</span><span class="ident" id="3992018">fn</span>&nbsp;<span class="op" id="3992021">=</span>&nbsp;<span class="keyword" id="3992023">func</span><span class="op" id="3992027">(</span><span class="ident" id="3992028">err</span>&nbsp;<span class="builtintype" id="3992032">error</span><span class="op" id="3992037">)</span>&nbsp;<span class="op" id="3992039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3992045">waitForBodyRead</span>&nbsp;<span class="op" id="3992061">&lt;-</span>&nbsp;<span class="ident" id="3992064">alive</span>&nbsp;<span class="op" id="3992070">&amp;&amp;</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3992078">err</span>&nbsp;<span class="op" id="3992082">==</span>&nbsp;<span class="ident" id="3992085">nil</span>&nbsp;<span class="op" id="3992089">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3992097">!</span><span class="ident" id="3992098">pc</span><span class="op" id="3992100">.</span><span class="ident" id="3992101">sawEOF</span>&nbsp;<span class="op" id="3992108">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3992116">pc</span><span class="op" id="3992118">.</span><span class="ident" id="3992119">wroteRequest</span><span class="op" id="3992131">(</span><span class="op" id="3992132">)</span>&nbsp;<span class="op" id="3992134">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3992142">pc</span><span class="op" id="3992144">.</span><span class="ident" id="3992145">t</span><span class="op" id="3992146">.</span><span class="ident" id="3992147">putIdleConn</span><span class="op" id="3992158">(</span><span class="ident" id="3992159">pc</span><span class="op" id="3992161">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3992166">}</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3992170">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3992175">if</span>&nbsp;<span class="ident" id="3992178">alive</span>&nbsp;<span class="op" id="3992184">&amp;&amp;</span>&nbsp;<span class="op" id="3992187">!</span><span class="ident" id="3992188">hasBody</span>&nbsp;<span class="op" id="3992196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3992201">alive</span>&nbsp;<span class="op" id="3992207">=</span>&nbsp;<span class="op" id="3992209">!</span><span class="ident" id="3992210">pc</span><span class="op" id="3992212">.</span><span class="ident" id="3992213">sawEOF</span>&nbsp;<span class="op" id="3992220">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3992227">pc</span><span class="op" id="3992229">.</span><span class="ident" id="3992230">wroteRequest</span><span class="op" id="3992242">(</span><span class="op" id="3992243">)</span>&nbsp;<span class="op" id="3992245">&amp;&amp;</span><br>
<span class="lineno">920</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3992252">pc</span><span class="op" id="3992254">.</span><span class="ident" id="3992255">t</span><span class="op" id="3992256">.</span><span class="ident" id="3992257">putIdleConn</span><span class="op" id="3992268">(</span><span class="ident" id="3992269">pc</span><span class="op" id="3992271">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3992275">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3992280">rc</span><span class="op" id="3992282">.</span><span class="ident" id="3992283">ch</span>&nbsp;<span class="op" id="3992286">&lt;-</span>&nbsp;<span class="ident" id="3992289">responseAndError</span><span class="op" id="3992305">{</span><span class="ident" id="3992306">resp</span><span class="op" id="3992310">,</span>&nbsp;<span class="ident" id="3992312">err</span><span class="op" id="3992315">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3992320">//&nbsp;Wait&nbsp;for&nbsp;the&nbsp;just-returned&nbsp;response&nbsp;body&nbsp;to&nbsp;be&nbsp;fully&nbsp;consumed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3992387">//&nbsp;before&nbsp;we&nbsp;race&nbsp;and&nbsp;peek&nbsp;on&nbsp;the&nbsp;underlying&nbsp;bufio&nbsp;reader.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3992448">if</span>&nbsp;<span class="ident" id="3992451">waitForBodyRead</span>&nbsp;<span class="op" id="3992467">!=</span>&nbsp;<span class="ident" id="3992470">nil</span>&nbsp;<span class="op" id="3992474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3992479">select</span>&nbsp;<span class="op" id="3992486">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3992491">case</span>&nbsp;<span class="ident" id="3992496">alive</span>&nbsp;<span class="op" id="3992502">=</span>&nbsp;<span class="op" id="3992504">&lt;-</span><span class="ident" id="3992506">waitForBodyRead</span><span class="op" id="3992521">:</span><br>
<span class="lineno">930</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3992526">case</span>&nbsp;<span class="op" id="3992531">&lt;-</span><span class="ident" id="3992533">pc</span><span class="op" id="3992535">.</span><span class="ident" id="3992536">closech</span><span class="op" id="3992543">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3992549">alive</span>&nbsp;<span class="op" id="3992555">=</span>&nbsp;<span class="builtintype" id="3992557">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3992566">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3992570">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">935</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3992575">pc</span><span class="op" id="3992577">.</span><span class="ident" id="3992578">t</span><span class="op" id="3992579">.</span><span class="ident" id="3992580">setReqCanceler</span><span class="op" id="3992594">(</span><span class="ident" id="3992595">rc</span><span class="op" id="3992597">.</span><span class="ident" id="3992598">req</span><span class="op" id="3992601">,</span>&nbsp;<span class="ident" id="3992603">nil</span><span class="op" id="3992606">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3992611">if</span>&nbsp;<span class="op" id="3992614">!</span><span class="ident" id="3992615">alive</span>&nbsp;<span class="op" id="3992621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3992626">pc</span><span class="op" id="3992628">.</span><span class="builtinfunc" id="3992629">close</span><span class="op" id="3992634">(</span><span class="op" id="3992635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3992639">}</span><br>
<span class="lineno">940</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3992642">}</span><br>
<span class="lineno"></span><span class="op" id="3992644">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3992647">func</span>&nbsp;<span class="op" id="3992652">(</span><span class="ident" id="3992653">pc</span>&nbsp;<span class="op" id="3992656">*</span><span class="ident" id="3992657">persistConn</span><span class="op" id="3992668">)</span>&nbsp;<span class="ident" id="3992670">writeLoop</span><span class="op" id="3992679">(</span><span class="op" id="3992680">)</span>&nbsp;<span class="op" id="3992682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3992685">for</span>&nbsp;<span class="op" id="3992689">{</span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3992693">select</span>&nbsp;<span class="op" id="3992700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3992704">case</span>&nbsp;<span class="ident" id="3992709">wr</span>&nbsp;<span class="op" id="3992712">:=</span>&nbsp;<span class="op" id="3992715">&lt;-</span><span class="ident" id="3992717">pc</span><span class="op" id="3992719">.</span><span class="ident" id="3992720">writech</span><span class="op" id="3992727">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3992732">if</span>&nbsp;<span class="ident" id="3992735">pc</span><span class="op" id="3992737">.</span><span class="ident" id="3992738">isBroken</span><span class="op" id="3992746">(</span><span class="op" id="3992747">)</span>&nbsp;<span class="op" id="3992749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3992755">wr</span><span class="op" id="3992757">.</span><span class="ident" id="3992758">ch</span>&nbsp;<span class="op" id="3992761">&lt;-</span>&nbsp;<span class="ident" id="3992764">errors</span><span class="op" id="3992770">.</span><span class="ident" id="3992771">New</span><span class="op" id="3992774">(</span><span class="string" id="3992775">&#34;http:&nbsp;can&#39;t&nbsp;write&nbsp;HTTP&nbsp;request&nbsp;on&nbsp;broken&nbsp;connection&#34;</span><span class="op" id="3992828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3992834">continue</span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3992846">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3992851">err</span>&nbsp;<span class="op" id="3992855">:=</span>&nbsp;<span class="ident" id="3992858">wr</span><span class="op" id="3992860">.</span><span class="ident" id="3992861">req</span><span class="op" id="3992864">.</span><span class="ident" id="3992865">Request</span><span class="op" id="3992872">.</span><span class="ident" id="3992873">write</span><span class="op" id="3992878">(</span><span class="ident" id="3992879">pc</span><span class="op" id="3992881">.</span><span class="ident" id="3992882">bw</span><span class="op" id="3992884">,</span>&nbsp;<span class="ident" id="3992886">pc</span><span class="op" id="3992888">.</span><span class="ident" id="3992889">isProxy</span><span class="op" id="3992896">,</span>&nbsp;<span class="ident" id="3992898">wr</span><span class="op" id="3992900">.</span><span class="ident" id="3992901">req</span><span class="op" id="3992904">.</span><span class="ident" id="3992905">extra</span><span class="op" id="3992910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3992915">if</span>&nbsp;<span class="ident" id="3992918">err</span>&nbsp;<span class="op" id="3992922">==</span>&nbsp;<span class="ident" id="3992925">nil</span>&nbsp;<span class="op" id="3992929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3992935">err</span>&nbsp;<span class="op" id="3992939">=</span>&nbsp;<span class="ident" id="3992941">pc</span><span class="op" id="3992943">.</span><span class="ident" id="3992944">bw</span><span class="op" id="3992946">.</span><span class="ident" id="3992947">Flush</span><span class="op" id="3992952">(</span><span class="op" id="3992953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3992958">}</span><br>
<span class="lineno">955</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3992963">if</span>&nbsp;<span class="ident" id="3992966">err</span>&nbsp;<span class="op" id="3992970">!=</span>&nbsp;<span class="ident" id="3992973">nil</span>&nbsp;<span class="op" id="3992977">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3992983">pc</span><span class="op" id="3992985">.</span><span class="ident" id="3992986">markBroken</span><span class="op" id="3992996">(</span><span class="op" id="3992997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3993003">wr</span><span class="op" id="3993005">.</span><span class="ident" id="3993006">req</span><span class="op" id="3993009">.</span><span class="ident" id="3993010">Request</span><span class="op" id="3993017">.</span><span class="ident" id="3993018">closeBody</span><span class="op" id="3993027">(</span><span class="op" id="3993028">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3993033">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3993038">pc</span><span class="op" id="3993040">.</span><span class="ident" id="3993041">writeErrCh</span>&nbsp;<span class="op" id="3993052">&lt;-</span>&nbsp;<span class="ident" id="3993055">err</span>&nbsp;<span class="comment" id="3993059">//&nbsp;to&nbsp;the&nbsp;body&nbsp;reader,&nbsp;which&nbsp;might&nbsp;recycle&nbsp;us</span><br>
<span class="lineno">960</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3993108">wr</span><span class="op" id="3993110">.</span><span class="ident" id="3993111">ch</span>&nbsp;<span class="op" id="3993114">&lt;-</span>&nbsp;<span class="ident" id="3993117">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3993129">//&nbsp;to&nbsp;the&nbsp;roundTrip&nbsp;function</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3993160">case</span>&nbsp;<span class="op" id="3993165">&lt;-</span><span class="ident" id="3993167">pc</span><span class="op" id="3993169">.</span><span class="ident" id="3993170">closech</span><span class="op" id="3993177">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3993182">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3993191">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3993194">}</span><br>
<span class="lineno">965</span><span class="op" id="3993196">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3993199">//&nbsp;wroteRequest&nbsp;is&nbsp;a&nbsp;check&nbsp;before&nbsp;recycling&nbsp;a&nbsp;connection&nbsp;that&nbsp;the&nbsp;previous&nbsp;write</span><br>
<span class="lineno"></span><span class="comment" id="3993280">//&nbsp;(from&nbsp;writeLoop&nbsp;above)&nbsp;happened&nbsp;and&nbsp;was&nbsp;successful.</span><br>
<span class="lineno"></span><span class="keyword" id="3993335">func</span>&nbsp;<span class="op" id="3993340">(</span><span class="ident" id="3993341">pc</span>&nbsp;<span class="op" id="3993344">*</span><span class="ident" id="3993345">persistConn</span><span class="op" id="3993356">)</span>&nbsp;<span class="ident" id="3993358">wroteRequest</span><span class="op" id="3993370">(</span><span class="op" id="3993371">)</span>&nbsp;<span class="builtintype" id="3993373">bool</span>&nbsp;<span class="op" id="3993378">{</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3993381">select</span>&nbsp;<span class="op" id="3993388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3993391">case</span>&nbsp;<span class="ident" id="3993396">err</span>&nbsp;<span class="op" id="3993400">:=</span>&nbsp;<span class="op" id="3993403">&lt;-</span><span class="ident" id="3993405">pc</span><span class="op" id="3993407">.</span><span class="ident" id="3993408">writeErrCh</span><span class="op" id="3993418">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3993422">//&nbsp;Common&nbsp;case:&nbsp;the&nbsp;write&nbsp;happened&nbsp;well&nbsp;before&nbsp;the&nbsp;response,&nbsp;so</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3993488">//&nbsp;avoid&nbsp;creating&nbsp;a&nbsp;timer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3993517">return</span>&nbsp;<span class="ident" id="3993524">err</span>&nbsp;<span class="op" id="3993528">==</span>&nbsp;<span class="ident" id="3993531">nil</span><br>
<span class="lineno">975</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3993536">default</span><span class="op" id="3993543">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3993547">//&nbsp;Rare&nbsp;case:&nbsp;the&nbsp;request&nbsp;was&nbsp;written&nbsp;in&nbsp;writeLoop&nbsp;above&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3993610">//&nbsp;before&nbsp;it&nbsp;could&nbsp;send&nbsp;to&nbsp;pc.writeErrCh,&nbsp;the&nbsp;reader&nbsp;read&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3993673">//&nbsp;all,&nbsp;processed&nbsp;it,&nbsp;and&nbsp;called&nbsp;us&nbsp;here.&nbsp;In&nbsp;this&nbsp;case,&nbsp;give&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3993740">//&nbsp;write&nbsp;goroutine&nbsp;a&nbsp;bit&nbsp;of&nbsp;time&nbsp;to&nbsp;finish&nbsp;its&nbsp;send.</span><br>
<span class="lineno">980</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3993795">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3993800">//&nbsp;Less&nbsp;rare&nbsp;case:&nbsp;We&nbsp;also&nbsp;get&nbsp;here&nbsp;in&nbsp;the&nbsp;legitimate&nbsp;case&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3993864">//&nbsp;Issue&nbsp;7569,&nbsp;where&nbsp;the&nbsp;writer&nbsp;is&nbsp;still&nbsp;writing&nbsp;(or&nbsp;stalled),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3993929">//&nbsp;but&nbsp;the&nbsp;server&nbsp;has&nbsp;already&nbsp;replied.&nbsp;In&nbsp;this&nbsp;case,&nbsp;we&nbsp;don&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3993993">//&nbsp;want&nbsp;to&nbsp;wait&nbsp;too&nbsp;long,&nbsp;and&nbsp;we&nbsp;want&nbsp;to&nbsp;return&nbsp;false&nbsp;so&nbsp;this</span><br>
<span class="lineno">985</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3994057">//&nbsp;connection&nbsp;isn&#39;t&nbsp;re-used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3994088">select</span>&nbsp;<span class="op" id="3994095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3994099">case</span>&nbsp;<span class="ident" id="3994104">err</span>&nbsp;<span class="op" id="3994108">:=</span>&nbsp;<span class="op" id="3994111">&lt;-</span><span class="ident" id="3994113">pc</span><span class="op" id="3994115">.</span><span class="ident" id="3994116">writeErrCh</span><span class="op" id="3994126">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3994131">return</span>&nbsp;<span class="ident" id="3994138">err</span>&nbsp;<span class="op" id="3994142">==</span>&nbsp;<span class="ident" id="3994145">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3994151">case</span>&nbsp;<span class="op" id="3994156">&lt;-</span><span class="ident" id="3994158">time</span><span class="op" id="3994162">.</span><span class="ident" id="3994163">After</span><span class="op" id="3994168">(</span><span class="num" id="3994169">50</span>&nbsp;<span class="op" id="3994172">*</span>&nbsp;<span class="ident" id="3994174">time</span><span class="op" id="3994178">.</span><span class="ident" id="3994179">Millisecond</span><span class="op" id="3994190">)</span><span class="op" id="3994191">:</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3994196">return</span>&nbsp;<span class="builtintype" id="3994203">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3994211">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3994214">}</span><br>
<span class="lineno"></span><span class="op" id="3994216">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">995</span><span class="keyword" id="3994219">type</span>&nbsp;<span class="ident" id="3994224">responseAndError</span>&nbsp;<span class="keyword" id="3994241">struct</span>&nbsp;<span class="op" id="3994248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3994251">res</span>&nbsp;<span class="op" id="3994255">*</span><span class="ident" id="3994256">Response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3994266">err</span>&nbsp;<span class="builtintype" id="3994270">error</span><br>
<span class="lineno"></span><span class="op" id="3994276">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1000</span><span class="keyword" id="3994279">type</span>&nbsp;<span class="ident" id="3994284">requestAndChan</span>&nbsp;<span class="keyword" id="3994299">struct</span>&nbsp;<span class="op" id="3994306">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3994309">req</span>&nbsp;<span class="op" id="3994313">*</span><span class="ident" id="3994314">Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3994323">ch</span>&nbsp;&nbsp;<span class="keyword" id="3994327">chan</span>&nbsp;<span class="ident" id="3994332">responseAndError</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3994351">//&nbsp;did&nbsp;the&nbsp;Transport&nbsp;(as&nbsp;opposed&nbsp;to&nbsp;the&nbsp;client&nbsp;code)&nbsp;add&nbsp;an</span><br>
<span class="lineno">1005</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3994412">//&nbsp;Accept-Encoding&nbsp;gzip&nbsp;header?&nbsp;only&nbsp;if&nbsp;it&nbsp;we&nbsp;set&nbsp;it&nbsp;do</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3994469">//&nbsp;we&nbsp;transparently&nbsp;decode&nbsp;the&nbsp;gzip.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3994507">addedGzip</span>&nbsp;<span class="builtintype" id="3994517">bool</span><br>
<span class="lineno"></span><span class="op" id="3994522">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1010</span><span class="comment" id="3994525">//&nbsp;A&nbsp;writeRequest&nbsp;is&nbsp;sent&nbsp;by&nbsp;the&nbsp;readLoop&#39;s&nbsp;goroutine&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3994586">//&nbsp;writeLoop&#39;s&nbsp;goroutine&nbsp;to&nbsp;write&nbsp;a&nbsp;request&nbsp;while&nbsp;the&nbsp;read&nbsp;loop</span><br>
<span class="lineno"></span><span class="comment" id="3994650">//&nbsp;concurrently&nbsp;waits&nbsp;on&nbsp;both&nbsp;the&nbsp;write&nbsp;response&nbsp;and&nbsp;the&nbsp;server&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="3994716">//&nbsp;reply.</span><br>
<span class="lineno"></span><span class="keyword" id="3994726">type</span>&nbsp;<span class="ident" id="3994731">writeRequest</span>&nbsp;<span class="keyword" id="3994744">struct</span>&nbsp;<span class="op" id="3994751">{</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3994754">req</span>&nbsp;<span class="op" id="3994758">*</span><span class="ident" id="3994759">transportRequest</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3994777">ch</span>&nbsp;&nbsp;<span class="keyword" id="3994781">chan</span><span class="op" id="3994785">&lt;-</span>&nbsp;<span class="builtintype" id="3994788">error</span><br>
<span class="lineno"></span><span class="op" id="3994794">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3994797">type</span>&nbsp;<span class="ident" id="3994802">httpError</span>&nbsp;<span class="keyword" id="3994812">struct</span>&nbsp;<span class="op" id="3994819">{</span><br>
<span class="lineno">1020</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3994822">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3994830">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3994838">timeout</span>&nbsp;<span class="builtintype" id="3994846">bool</span><br>
<span class="lineno"></span><span class="op" id="3994851">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3994854">func</span>&nbsp;<span class="op" id="3994859">(</span><span class="ident" id="3994860">e</span>&nbsp;<span class="op" id="3994862">*</span><span class="ident" id="3994863">httpError</span><span class="op" id="3994872">)</span>&nbsp;<span class="ident" id="3994874">Error</span><span class="op" id="3994879">(</span><span class="op" id="3994880">)</span>&nbsp;<span class="builtintype" id="3994882">string</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3994891">{</span>&nbsp;<span class="keyword" id="3994893">return</span>&nbsp;<span class="ident" id="3994900">e</span><span class="op" id="3994901">.</span><span class="ident" id="3994902">err</span>&nbsp;<span class="op" id="3994906">}</span><br>
<span class="lineno">1025</span><span class="keyword" id="3994908">func</span>&nbsp;<span class="op" id="3994913">(</span><span class="ident" id="3994914">e</span>&nbsp;<span class="op" id="3994916">*</span><span class="ident" id="3994917">httpError</span><span class="op" id="3994926">)</span>&nbsp;<span class="ident" id="3994928">Timeout</span><span class="op" id="3994935">(</span><span class="op" id="3994936">)</span>&nbsp;<span class="builtintype" id="3994938">bool</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3994945">{</span>&nbsp;<span class="keyword" id="3994947">return</span>&nbsp;<span class="ident" id="3994954">e</span><span class="op" id="3994955">.</span><span class="ident" id="3994956">timeout</span>&nbsp;<span class="op" id="3994964">}</span><br>
<span class="lineno"></span><span class="keyword" id="3994966">func</span>&nbsp;<span class="op" id="3994971">(</span><span class="ident" id="3994972">e</span>&nbsp;<span class="op" id="3994974">*</span><span class="ident" id="3994975">httpError</span><span class="op" id="3994984">)</span>&nbsp;<span class="ident" id="3994986">Temporary</span><span class="op" id="3994995">(</span><span class="op" id="3994996">)</span>&nbsp;<span class="builtintype" id="3994998">bool</span>&nbsp;<span class="op" id="3995003">{</span>&nbsp;<span class="keyword" id="3995005">return</span>&nbsp;<span class="builtintype" id="3995012">true</span>&nbsp;<span class="op" id="3995017">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3995020">var</span>&nbsp;<span class="ident" id="3995024">errTimeout</span>&nbsp;<span class="builtintype" id="3995035">error</span>&nbsp;<span class="op" id="3995041">=</span>&nbsp;<span class="op" id="3995043">&amp;</span><span class="ident" id="3995044">httpError</span><span class="op" id="3995053">{</span><span class="ident" id="3995054">err</span><span class="op" id="3995057">:</span>&nbsp;<span class="string" id="3995059">&#34;net/http:&nbsp;timeout&nbsp;awaiting&nbsp;response&nbsp;headers&#34;</span><span class="op" id="3995104">,</span>&nbsp;<span class="ident" id="3995106">timeout</span><span class="op" id="3995113">:</span>&nbsp;<span class="builtintype" id="3995115">true</span><span class="op" id="3995119">}</span><br>
<span class="lineno"></span><span class="keyword" id="3995121">var</span>&nbsp;<span class="ident" id="3995125">errClosed</span>&nbsp;<span class="builtintype" id="3995135">error</span>&nbsp;<span class="op" id="3995141">=</span>&nbsp;<span class="op" id="3995143">&amp;</span><span class="ident" id="3995144">httpError</span><span class="op" id="3995153">{</span><span class="ident" id="3995154">err</span><span class="op" id="3995157">:</span>&nbsp;<span class="string" id="3995159">&#34;net/http:&nbsp;transport&nbsp;closed&nbsp;before&nbsp;response&nbsp;was&nbsp;received&#34;</span><span class="op" id="3995216">}</span><br>
<span class="lineno">1030</span><br>
<span class="lineno"></span><span class="keyword" id="3995219">func</span>&nbsp;<span class="op" id="3995224">(</span><span class="ident" id="3995225">pc</span>&nbsp;<span class="op" id="3995228">*</span><span class="ident" id="3995229">persistConn</span><span class="op" id="3995240">)</span>&nbsp;<span class="ident" id="3995242">roundTrip</span><span class="op" id="3995251">(</span><span class="ident" id="3995252">req</span>&nbsp;<span class="op" id="3995256">*</span><span class="ident" id="3995257">transportRequest</span><span class="op" id="3995273">)</span>&nbsp;<span class="op" id="3995275">(</span><span class="ident" id="3995276">resp</span>&nbsp;<span class="op" id="3995281">*</span><span class="ident" id="3995282">Response</span><span class="op" id="3995290">,</span>&nbsp;<span class="ident" id="3995292">err</span>&nbsp;<span class="builtintype" id="3995296">error</span><span class="op" id="3995301">)</span>&nbsp;<span class="op" id="3995303">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3995306">pc</span><span class="op" id="3995308">.</span><span class="ident" id="3995309">t</span><span class="op" id="3995310">.</span><span class="ident" id="3995311">setReqCanceler</span><span class="op" id="3995325">(</span><span class="ident" id="3995326">req</span><span class="op" id="3995329">.</span><span class="ident" id="3995330">Request</span><span class="op" id="3995337">,</span>&nbsp;<span class="ident" id="3995339">pc</span><span class="op" id="3995341">.</span><span class="ident" id="3995342">cancelRequest</span><span class="op" id="3995355">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3995358">pc</span><span class="op" id="3995360">.</span><span class="ident" id="3995361">lk</span><span class="op" id="3995363">.</span><span class="ident" id="3995364">Lock</span><span class="op" id="3995368">(</span><span class="op" id="3995369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3995372">pc</span><span class="op" id="3995374">.</span><span class="ident" id="3995375">numExpectedResponses</span><span class="op" id="3995395">++</span><br>
<span class="lineno">1035</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3995399">headerFn</span>&nbsp;<span class="op" id="3995408">:=</span>&nbsp;<span class="ident" id="3995411">pc</span><span class="op" id="3995413">.</span><span class="ident" id="3995414">mutateHeaderFunc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3995432">pc</span><span class="op" id="3995434">.</span><span class="ident" id="3995435">lk</span><span class="op" id="3995437">.</span><span class="ident" id="3995438">Unlock</span><span class="op" id="3995444">(</span><span class="op" id="3995445">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3995449">if</span>&nbsp;<span class="ident" id="3995452">headerFn</span>&nbsp;<span class="op" id="3995461">!=</span>&nbsp;<span class="ident" id="3995464">nil</span>&nbsp;<span class="op" id="3995468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3995472">headerFn</span><span class="op" id="3995480">(</span><span class="ident" id="3995481">req</span><span class="op" id="3995484">.</span><span class="ident" id="3995485">extraHeaders</span><span class="op" id="3995497">(</span><span class="op" id="3995498">)</span><span class="op" id="3995499">)</span><br>
<span class="lineno">1040</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3995502">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3995506">//&nbsp;Ask&nbsp;for&nbsp;a&nbsp;compressed&nbsp;version&nbsp;if&nbsp;the&nbsp;caller&nbsp;didn&#39;t&nbsp;set&nbsp;their</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3995570">//&nbsp;own&nbsp;value&nbsp;for&nbsp;Accept-Encoding.&nbsp;We&nbsp;only&nbsp;attempt&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3995624">//&nbsp;uncompress&nbsp;the&nbsp;gzip&nbsp;stream&nbsp;if&nbsp;we&nbsp;were&nbsp;the&nbsp;layer&nbsp;that</span><br>
<span class="lineno">1045</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3995681">//&nbsp;requested&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3995699">requestedGzip</span>&nbsp;<span class="op" id="3995713">:=</span>&nbsp;<span class="builtintype" id="3995716">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3995723">if</span>&nbsp;<span class="op" id="3995726">!</span><span class="ident" id="3995727">pc</span><span class="op" id="3995729">.</span><span class="ident" id="3995730">t</span><span class="op" id="3995731">.</span><span class="ident" id="3995732">DisableCompression</span>&nbsp;<span class="op" id="3995751">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3995756">req</span><span class="op" id="3995759">.</span><span class="ident" id="3995760">Header</span><span class="op" id="3995766">.</span><span class="ident" id="3995767">Get</span><span class="op" id="3995770">(</span><span class="string" id="3995771">&#34;Accept-Encoding&#34;</span><span class="op" id="3995788">)</span>&nbsp;<span class="op" id="3995790">==</span>&nbsp;<span class="string" id="3995793">&#34;&#34;</span>&nbsp;<span class="op" id="3995796">&amp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3995801">req</span><span class="op" id="3995804">.</span><span class="ident" id="3995805">Header</span><span class="op" id="3995811">.</span><span class="ident" id="3995812">Get</span><span class="op" id="3995815">(</span><span class="string" id="3995816">&#34;Range&#34;</span><span class="op" id="3995823">)</span>&nbsp;<span class="op" id="3995825">==</span>&nbsp;<span class="string" id="3995828">&#34;&#34;</span>&nbsp;<span class="op" id="3995831">&amp;&amp;</span><br>
<span class="lineno">1050</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3995836">req</span><span class="op" id="3995839">.</span><span class="ident" id="3995840">Method</span>&nbsp;<span class="op" id="3995847">!=</span>&nbsp;<span class="string" id="3995850">&#34;HEAD&#34;</span>&nbsp;<span class="op" id="3995857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3995861">//&nbsp;Request&nbsp;gzip&nbsp;only,&nbsp;not&nbsp;deflate.&nbsp;Deflate&nbsp;is&nbsp;ambiguous&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3995923">//&nbsp;not&nbsp;as&nbsp;universally&nbsp;supported&nbsp;anyway.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3995965">//&nbsp;See:&nbsp;http://www.gzip.org/zlib/zlib_faq.html#faq38</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3996020">//</span><br>
<span class="lineno">1055</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3996025">//&nbsp;Note&nbsp;that&nbsp;we&nbsp;don&#39;t&nbsp;request&nbsp;this&nbsp;for&nbsp;HEAD&nbsp;requests,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3996081">//&nbsp;due&nbsp;to&nbsp;a&nbsp;bug&nbsp;in&nbsp;nginx:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3996109">//&nbsp;&nbsp;&nbsp;http://trac.nginx.org/nginx/ticket/358</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3996155">//&nbsp;&nbsp;&nbsp;http://golang.org/issue/5522</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3996191">//</span><br>
<span class="lineno">1060</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3996196">//&nbsp;We&nbsp;don&#39;t&nbsp;request&nbsp;gzip&nbsp;if&nbsp;the&nbsp;request&nbsp;is&nbsp;for&nbsp;a&nbsp;range,&nbsp;since</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3996260">//&nbsp;auto-decoding&nbsp;a&nbsp;portion&nbsp;of&nbsp;a&nbsp;gzipped&nbsp;document&nbsp;will&nbsp;just&nbsp;fail</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3996326">//&nbsp;anyway.&nbsp;See&nbsp;http://golang.org/issue/8923</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3996372">requestedGzip</span>&nbsp;<span class="op" id="3996386">=</span>&nbsp;<span class="builtintype" id="3996388">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3996395">req</span><span class="op" id="3996398">.</span><span class="ident" id="3996399">extraHeaders</span><span class="op" id="3996411">(</span><span class="op" id="3996412">)</span><span class="op" id="3996413">.</span><span class="ident" id="3996414">Set</span><span class="op" id="3996417">(</span><span class="string" id="3996418">&#34;Accept-Encoding&#34;</span><span class="op" id="3996435">,</span>&nbsp;<span class="string" id="3996437">&#34;gzip&#34;</span><span class="op" id="3996443">)</span><br>
<span class="lineno">1065</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3996446">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3996450">//&nbsp;Write&nbsp;the&nbsp;request&nbsp;concurrently&nbsp;with&nbsp;waiting&nbsp;for&nbsp;a&nbsp;response,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3996514">//&nbsp;in&nbsp;case&nbsp;the&nbsp;server&nbsp;decides&nbsp;to&nbsp;reply&nbsp;before&nbsp;reading&nbsp;our&nbsp;full</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3996578">//&nbsp;request&nbsp;body.</span><br>
<span class="lineno">1070</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3996596">writeErrCh</span>&nbsp;<span class="op" id="3996607">:=</span>&nbsp;<span class="builtinfunc" id="3996610">make</span><span class="op" id="3996614">(</span><span class="keyword" id="3996615">chan</span>&nbsp;<span class="builtintype" id="3996620">error</span><span class="op" id="3996625">,</span>&nbsp;<span class="num" id="3996627">1</span><span class="op" id="3996628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3996631">pc</span><span class="op" id="3996633">.</span><span class="ident" id="3996634">writech</span>&nbsp;<span class="op" id="3996642">&lt;-</span>&nbsp;<span class="ident" id="3996645">writeRequest</span><span class="op" id="3996657">{</span><span class="ident" id="3996658">req</span><span class="op" id="3996661">,</span>&nbsp;<span class="ident" id="3996663">writeErrCh</span><span class="op" id="3996673">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3996677">resc</span>&nbsp;<span class="op" id="3996682">:=</span>&nbsp;<span class="builtinfunc" id="3996685">make</span><span class="op" id="3996689">(</span><span class="keyword" id="3996690">chan</span>&nbsp;<span class="ident" id="3996695">responseAndError</span><span class="op" id="3996711">,</span>&nbsp;<span class="num" id="3996713">1</span><span class="op" id="3996714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3996717">pc</span><span class="op" id="3996719">.</span><span class="ident" id="3996720">reqch</span>&nbsp;<span class="op" id="3996726">&lt;-</span>&nbsp;<span class="ident" id="3996729">requestAndChan</span><span class="op" id="3996743">{</span><span class="ident" id="3996744">req</span><span class="op" id="3996747">.</span><span class="ident" id="3996748">Request</span><span class="op" id="3996755">,</span>&nbsp;<span class="ident" id="3996757">resc</span><span class="op" id="3996761">,</span>&nbsp;<span class="ident" id="3996763">requestedGzip</span><span class="op" id="3996776">}</span><br>
<span class="lineno">1075</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3996780">var</span>&nbsp;<span class="ident" id="3996784">re</span>&nbsp;<span class="ident" id="3996787">responseAndError</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3996805">var</span>&nbsp;<span class="ident" id="3996809">pconnDeadCh</span>&nbsp;<span class="op" id="3996821">=</span>&nbsp;<span class="ident" id="3996823">pc</span><span class="op" id="3996825">.</span><span class="ident" id="3996826">closech</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3996835">var</span>&nbsp;<span class="ident" id="3996839">failTicker</span>&nbsp;<span class="op" id="3996850">&lt;-</span><span class="keyword" id="3996852">chan</span>&nbsp;<span class="ident" id="3996857">time</span><span class="op" id="3996861">.</span><span class="ident" id="3996862">Time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3996868">var</span>&nbsp;<span class="ident" id="3996872">respHeaderTimer</span>&nbsp;<span class="op" id="3996888">&lt;-</span><span class="keyword" id="3996890">chan</span>&nbsp;<span class="ident" id="3996895">time</span><span class="op" id="3996899">.</span><span class="ident" id="3996900">Time</span><br>
<span class="lineno">1080</span><span class="ident" id="3996905">WaitResponse</span><span class="op" id="3996917">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3996920">for</span>&nbsp;<span class="op" id="3996924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3996928">select</span>&nbsp;<span class="op" id="3996935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3996939">case</span>&nbsp;<span class="ident" id="3996944">err</span>&nbsp;<span class="op" id="3996948">:=</span>&nbsp;<span class="op" id="3996951">&lt;-</span><span class="ident" id="3996953">writeErrCh</span><span class="op" id="3996963">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3996968">if</span>&nbsp;<span class="ident" id="3996971">err</span>&nbsp;<span class="op" id="3996975">!=</span>&nbsp;<span class="ident" id="3996978">nil</span>&nbsp;<span class="op" id="3996982">{</span><br>
<span class="lineno">1085</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3996988">re</span>&nbsp;<span class="op" id="3996991">=</span>&nbsp;<span class="ident" id="3996993">responseAndError</span><span class="op" id="3997009">{</span><span class="ident" id="3997010">nil</span><span class="op" id="3997013">,</span>&nbsp;<span class="ident" id="3997015">err</span><span class="op" id="3997018">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3997024">pc</span><span class="op" id="3997026">.</span><span class="builtinfunc" id="3997027">close</span><span class="op" id="3997032">(</span><span class="op" id="3997033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3997039">break</span>&nbsp;<span class="ident" id="3997045">WaitResponse</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3997061">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3997066">if</span>&nbsp;<span class="ident" id="3997069">d</span>&nbsp;<span class="op" id="3997071">:=</span>&nbsp;<span class="ident" id="3997074">pc</span><span class="op" id="3997076">.</span><span class="ident" id="3997077">t</span><span class="op" id="3997078">.</span><span class="ident" id="3997079">ResponseHeaderTimeout</span><span class="op" id="3997100">;</span>&nbsp;<span class="ident" id="3997102">d</span>&nbsp;<span class="op" id="3997104">&gt;</span>&nbsp;<span class="num" id="3997106">0</span>&nbsp;<span class="op" id="3997108">{</span><br>
<span class="lineno">1090</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3997114">respHeaderTimer</span>&nbsp;<span class="op" id="3997130">=</span>&nbsp;<span class="ident" id="3997132">time</span><span class="op" id="3997136">.</span><span class="ident" id="3997137">After</span><span class="op" id="3997142">(</span><span class="ident" id="3997143">d</span><span class="op" id="3997144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3997149">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3997153">case</span>&nbsp;<span class="op" id="3997158">&lt;-</span><span class="ident" id="3997160">pconnDeadCh</span><span class="op" id="3997171">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3997176">//&nbsp;The&nbsp;persist&nbsp;connection&nbsp;is&nbsp;dead.&nbsp;This&nbsp;shouldn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3997229">//&nbsp;usually&nbsp;happen&nbsp;(only&nbsp;with&nbsp;Connection:&nbsp;close&nbsp;responses</span><br>
<span class="lineno">1095</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3997289">//&nbsp;with&nbsp;no&nbsp;response&nbsp;bodies),&nbsp;but&nbsp;if&nbsp;it&nbsp;does&nbsp;happen&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3997346">//&nbsp;means&nbsp;either&nbsp;a)&nbsp;the&nbsp;remote&nbsp;server&nbsp;hung&nbsp;up&nbsp;on&nbsp;us</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3997400">//&nbsp;prematurely,&nbsp;or&nbsp;b)&nbsp;the&nbsp;readLoop&nbsp;sent&nbsp;us&nbsp;a&nbsp;response&nbsp;&amp;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3997459">//&nbsp;closed&nbsp;its&nbsp;closech&nbsp;at&nbsp;roughly&nbsp;the&nbsp;same&nbsp;time,&nbsp;and&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3997517">//&nbsp;selected&nbsp;this&nbsp;case&nbsp;first,&nbsp;in&nbsp;which&nbsp;case&nbsp;a&nbsp;response</span><br>
<span class="lineno">1100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3997574">//&nbsp;might&nbsp;still&nbsp;be&nbsp;coming&nbsp;soon.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3997608">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3997614">//&nbsp;We&nbsp;can&#39;t&nbsp;avoid&nbsp;the&nbsp;select&nbsp;race&nbsp;in&nbsp;b)&nbsp;by&nbsp;using&nbsp;a&nbsp;unbuffered</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3997679">//&nbsp;resc&nbsp;channel&nbsp;instead,&nbsp;because&nbsp;then&nbsp;goroutines&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3997735">//&nbsp;leak&nbsp;if&nbsp;we&nbsp;exit&nbsp;due&nbsp;to&nbsp;other&nbsp;errors.</span><br>
<span class="lineno">1105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3997778">pconnDeadCh</span>&nbsp;<span class="op" id="3997790">=</span>&nbsp;<span class="ident" id="3997792">nil</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3997826">//&nbsp;avoid&nbsp;spinning</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3997847">failTicker</span>&nbsp;<span class="op" id="3997858">=</span>&nbsp;<span class="ident" id="3997860">time</span><span class="op" id="3997864">.</span><span class="ident" id="3997865">After</span><span class="op" id="3997870">(</span><span class="num" id="3997871">100</span>&nbsp;<span class="op" id="3997875">*</span>&nbsp;<span class="ident" id="3997877">time</span><span class="op" id="3997881">.</span><span class="ident" id="3997882">Millisecond</span><span class="op" id="3997893">)</span>&nbsp;<span class="comment" id="3997895">//&nbsp;arbitrary&nbsp;time&nbsp;to&nbsp;wait&nbsp;for&nbsp;resc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3997932">case</span>&nbsp;<span class="op" id="3997937">&lt;-</span><span class="ident" id="3997939">failTicker</span><span class="op" id="3997949">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3997954">re</span>&nbsp;<span class="op" id="3997957">=</span>&nbsp;<span class="ident" id="3997959">responseAndError</span><span class="op" id="3997975">{</span><span class="ident" id="3997976">err</span><span class="op" id="3997979">:</span>&nbsp;<span class="ident" id="3997981">errClosed</span><span class="op" id="3997990">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3997995">break</span>&nbsp;<span class="ident" id="3998001">WaitResponse</span><br>
<span class="lineno">1110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3998016">case</span>&nbsp;<span class="op" id="3998021">&lt;-</span><span class="ident" id="3998023">respHeaderTimer</span><span class="op" id="3998038">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3998043">pc</span><span class="op" id="3998045">.</span><span class="builtinfunc" id="3998046">close</span><span class="op" id="3998051">(</span><span class="op" id="3998052">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3998057">re</span>&nbsp;<span class="op" id="3998060">=</span>&nbsp;<span class="ident" id="3998062">responseAndError</span><span class="op" id="3998078">{</span><span class="ident" id="3998079">err</span><span class="op" id="3998082">:</span>&nbsp;<span class="ident" id="3998084">errTimeout</span><span class="op" id="3998094">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3998099">break</span>&nbsp;<span class="ident" id="3998105">WaitResponse</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3998120">case</span>&nbsp;<span class="ident" id="3998125">re</span>&nbsp;<span class="op" id="3998128">=</span>&nbsp;<span class="op" id="3998130">&lt;-</span><span class="ident" id="3998132">resc</span><span class="op" id="3998136">:</span><br>
<span class="lineno">1115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3998141">break</span>&nbsp;<span class="ident" id="3998147">WaitResponse</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3998162">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3998165">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3998169">pc</span><span class="op" id="3998171">.</span><span class="ident" id="3998172">lk</span><span class="op" id="3998174">.</span><span class="ident" id="3998175">Lock</span><span class="op" id="3998179">(</span><span class="op" id="3998180">)</span><br>
<span class="lineno">1120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3998183">pc</span><span class="op" id="3998185">.</span><span class="ident" id="3998186">numExpectedResponses</span><span class="op" id="3998206">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3998210">pc</span><span class="op" id="3998212">.</span><span class="ident" id="3998213">lk</span><span class="op" id="3998215">.</span><span class="ident" id="3998216">Unlock</span><span class="op" id="3998222">(</span><span class="op" id="3998223">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3998227">if</span>&nbsp;<span class="ident" id="3998230">re</span><span class="op" id="3998232">.</span><span class="ident" id="3998233">err</span>&nbsp;<span class="op" id="3998237">!=</span>&nbsp;<span class="ident" id="3998240">nil</span>&nbsp;<span class="op" id="3998244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3998248">pc</span><span class="op" id="3998250">.</span><span class="ident" id="3998251">t</span><span class="op" id="3998252">.</span><span class="ident" id="3998253">setReqCanceler</span><span class="op" id="3998267">(</span><span class="ident" id="3998268">req</span><span class="op" id="3998271">.</span><span class="ident" id="3998272">Request</span><span class="op" id="3998279">,</span>&nbsp;<span class="ident" id="3998281">nil</span><span class="op" id="3998284">)</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3998287">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3998290">return</span>&nbsp;<span class="ident" id="3998297">re</span><span class="op" id="3998299">.</span><span class="ident" id="3998300">res</span><span class="op" id="3998303">,</span>&nbsp;<span class="ident" id="3998305">re</span><span class="op" id="3998307">.</span><span class="ident" id="3998308">err</span><br>
<span class="lineno"></span><span class="op" id="3998312">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3998315">//&nbsp;markBroken&nbsp;marks&nbsp;a&nbsp;connection&nbsp;as&nbsp;broken&nbsp;(so&nbsp;it&#39;s&nbsp;not&nbsp;reused).</span><br>
<span class="lineno">1130</span><span class="comment" id="3998380">//&nbsp;It&nbsp;differs&nbsp;from&nbsp;close&nbsp;in&nbsp;that&nbsp;it&nbsp;doesn&#39;t&nbsp;close&nbsp;the&nbsp;underlying</span><br>
<span class="lineno"></span><span class="comment" id="3998445">//&nbsp;connection&nbsp;for&nbsp;use&nbsp;when&nbsp;it&#39;s&nbsp;still&nbsp;being&nbsp;read.</span><br>
<span class="lineno"></span><span class="keyword" id="3998495">func</span>&nbsp;<span class="op" id="3998500">(</span><span class="ident" id="3998501">pc</span>&nbsp;<span class="op" id="3998504">*</span><span class="ident" id="3998505">persistConn</span><span class="op" id="3998516">)</span>&nbsp;<span class="ident" id="3998518">markBroken</span><span class="op" id="3998528">(</span><span class="op" id="3998529">)</span>&nbsp;<span class="op" id="3998531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3998534">pc</span><span class="op" id="3998536">.</span><span class="ident" id="3998537">lk</span><span class="op" id="3998539">.</span><span class="ident" id="3998540">Lock</span><span class="op" id="3998544">(</span><span class="op" id="3998545">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3998548">defer</span>&nbsp;<span class="ident" id="3998554">pc</span><span class="op" id="3998556">.</span><span class="ident" id="3998557">lk</span><span class="op" id="3998559">.</span><span class="ident" id="3998560">Unlock</span><span class="op" id="3998566">(</span><span class="op" id="3998567">)</span><br>
<span class="lineno">1135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3998570">pc</span><span class="op" id="3998572">.</span><span class="ident" id="3998573">broken</span>&nbsp;<span class="op" id="3998580">=</span>&nbsp;<span class="builtintype" id="3998582">true</span><br>
<span class="lineno"></span><span class="op" id="3998587">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3998590">func</span>&nbsp;<span class="op" id="3998595">(</span><span class="ident" id="3998596">pc</span>&nbsp;<span class="op" id="3998599">*</span><span class="ident" id="3998600">persistConn</span><span class="op" id="3998611">)</span>&nbsp;<span class="builtinfunc" id="3998613">close</span><span class="op" id="3998618">(</span><span class="op" id="3998619">)</span>&nbsp;<span class="op" id="3998621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3998624">pc</span><span class="op" id="3998626">.</span><span class="ident" id="3998627">lk</span><span class="op" id="3998629">.</span><span class="ident" id="3998630">Lock</span><span class="op" id="3998634">(</span><span class="op" id="3998635">)</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3998638">defer</span>&nbsp;<span class="ident" id="3998644">pc</span><span class="op" id="3998646">.</span><span class="ident" id="3998647">lk</span><span class="op" id="3998649">.</span><span class="ident" id="3998650">Unlock</span><span class="op" id="3998656">(</span><span class="op" id="3998657">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3998660">pc</span><span class="op" id="3998662">.</span><span class="ident" id="3998663">closeLocked</span><span class="op" id="3998674">(</span><span class="op" id="3998675">)</span><br>
<span class="lineno"></span><span class="op" id="3998677">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3998680">func</span>&nbsp;<span class="op" id="3998685">(</span><span class="ident" id="3998686">pc</span>&nbsp;<span class="op" id="3998689">*</span><span class="ident" id="3998690">persistConn</span><span class="op" id="3998701">)</span>&nbsp;<span class="ident" id="3998703">closeLocked</span><span class="op" id="3998714">(</span><span class="op" id="3998715">)</span>&nbsp;<span class="op" id="3998717">{</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3998720">pc</span><span class="op" id="3998722">.</span><span class="ident" id="3998723">broken</span>&nbsp;<span class="op" id="3998730">=</span>&nbsp;<span class="builtintype" id="3998732">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3998738">if</span>&nbsp;<span class="op" id="3998741">!</span><span class="ident" id="3998742">pc</span><span class="op" id="3998744">.</span><span class="ident" id="3998745">closed</span>&nbsp;<span class="op" id="3998752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3998756">pc</span><span class="op" id="3998758">.</span><span class="ident" id="3998759">conn</span><span class="op" id="3998763">.</span><span class="ident" id="3998764">Close</span><span class="op" id="3998769">(</span><span class="op" id="3998770">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3998774">pc</span><span class="op" id="3998776">.</span><span class="ident" id="3998777">closed</span>&nbsp;<span class="op" id="3998784">=</span>&nbsp;<span class="builtintype" id="3998786">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3998793">close</span><span class="op" id="3998798">(</span><span class="ident" id="3998799">pc</span><span class="op" id="3998801">.</span><span class="ident" id="3998802">closech</span><span class="op" id="3998809">)</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3998812">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3998815">pc</span><span class="op" id="3998817">.</span><span class="ident" id="3998818">mutateHeaderFunc</span>&nbsp;<span class="op" id="3998835">=</span>&nbsp;<span class="ident" id="3998837">nil</span><br>
<span class="lineno"></span><span class="op" id="3998841">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3998844">var</span>&nbsp;<span class="ident" id="3998848">portMap</span>&nbsp;<span class="op" id="3998856">=</span>&nbsp;<span class="keyword" id="3998858">map</span><span class="op" id="3998861">[</span><span class="builtintype" id="3998862">string</span><span class="op" id="3998868">]</span><span class="builtintype" id="3998869">string</span><span class="op" id="3998875">{</span><br>
<span class="lineno">1155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3998878">&#34;http&#34;</span><span class="op" id="3998884">:</span>&nbsp;&nbsp;<span class="string" id="3998887">&#34;80&#34;</span><span class="op" id="3998891">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3998894">&#34;https&#34;</span><span class="op" id="3998901">:</span>&nbsp;<span class="string" id="3998903">&#34;443&#34;</span><span class="op" id="3998908">,</span><br>
<span class="lineno"></span><span class="op" id="3998910">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3998913">//&nbsp;canonicalAddr&nbsp;returns&nbsp;url.Host&nbsp;but&nbsp;always&nbsp;with&nbsp;a&nbsp;&#34;:port&#34;&nbsp;suffix</span><br>
<span class="lineno">1160</span><span class="keyword" id="3998980">func</span>&nbsp;<span class="ident" id="3998985">canonicalAddr</span><span class="op" id="3998998">(</span><span class="ident" id="3998999">url</span>&nbsp;<span class="op" id="3999003">*</span><span class="ident" id="3999004">url</span><span class="op" id="3999007">.</span><span class="ident" id="3999008">URL</span><span class="op" id="3999011">)</span>&nbsp;<span class="builtintype" id="3999013">string</span>&nbsp;<span class="op" id="3999020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3999023">addr</span>&nbsp;<span class="op" id="3999028">:=</span>&nbsp;<span class="ident" id="3999031">url</span><span class="op" id="3999034">.</span><span class="ident" id="3999035">Host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3999041">if</span>&nbsp;<span class="op" id="3999044">!</span><span class="ident" id="3999045">hasPort</span><span class="op" id="3999052">(</span><span class="ident" id="3999053">addr</span><span class="op" id="3999057">)</span>&nbsp;<span class="op" id="3999059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3999063">return</span>&nbsp;<span class="ident" id="3999070">addr</span>&nbsp;<span class="op" id="3999075">+</span>&nbsp;<span class="string" id="3999077">&#34;:&#34;</span>&nbsp;<span class="op" id="3999081">+</span>&nbsp;<span class="ident" id="3999083">portMap</span><span class="op" id="3999090">[</span><span class="ident" id="3999091">url</span><span class="op" id="3999094">.</span><span class="ident" id="3999095">Scheme</span><span class="op" id="3999101">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3999104">}</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3999107">return</span>&nbsp;<span class="ident" id="3999114">addr</span><br>
<span class="lineno"></span><span class="op" id="3999119">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3999122">//&nbsp;bodyEOFSignal&nbsp;wraps&nbsp;a&nbsp;ReadCloser&nbsp;but&nbsp;runs&nbsp;fn&nbsp;(if&nbsp;non-nil)&nbsp;at&nbsp;most</span><br>
<span class="lineno"></span><span class="comment" id="3999191">//&nbsp;once,&nbsp;right&nbsp;before&nbsp;its&nbsp;final&nbsp;(error-producing)&nbsp;Read&nbsp;or&nbsp;Close&nbsp;call</span><br>
<span class="lineno">1170</span><span class="comment" id="3999260">//&nbsp;returns.&nbsp;If&nbsp;earlyCloseFn&nbsp;is&nbsp;non-nil&nbsp;and&nbsp;Close&nbsp;is&nbsp;called&nbsp;before</span><br>
<span class="lineno"></span><span class="comment" id="3999326">//&nbsp;io.EOF&nbsp;is&nbsp;seen,&nbsp;earlyCloseFn&nbsp;is&nbsp;called&nbsp;instead&nbsp;of&nbsp;fn,&nbsp;and&nbsp;its</span><br>
<span class="lineno"></span><span class="comment" id="3999391">//&nbsp;return&nbsp;value&nbsp;is&nbsp;the&nbsp;return&nbsp;value&nbsp;from&nbsp;Close.</span><br>
<span class="lineno"></span><span class="keyword" id="3999439">type</span>&nbsp;<span class="ident" id="3999444">bodyEOFSignal</span>&nbsp;<span class="keyword" id="3999458">struct</span>&nbsp;<span class="op" id="3999465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3999468">body</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3999481">io</span><span class="op" id="3999483">.</span><span class="ident" id="3999484">ReadCloser</span><br>
<span class="lineno">1175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3999496">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3999509">sync</span><span class="op" id="3999513">.</span><span class="ident" id="3999514">Mutex</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="3999522">//&nbsp;guards&nbsp;following&nbsp;4&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3999552">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3999565">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3999578">//&nbsp;whether&nbsp;Close&nbsp;has&nbsp;been&nbsp;called</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3999612">rerr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3999625">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3999638">//&nbsp;sticky&nbsp;Read&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3999660">fn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3999673">func</span><span class="op" id="3999677">(</span><span class="builtintype" id="3999678">error</span><span class="op" id="3999683">)</span>&nbsp;&nbsp;<span class="comment" id="3999686">//&nbsp;error&nbsp;will&nbsp;be&nbsp;nil&nbsp;on&nbsp;Read&nbsp;io.EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3999723">earlyCloseFn</span>&nbsp;<span class="keyword" id="3999736">func</span><span class="op" id="3999740">(</span><span class="op" id="3999741">)</span>&nbsp;<span class="builtintype" id="3999743">error</span>&nbsp;<span class="comment" id="3999749">//&nbsp;optional&nbsp;alt&nbsp;Close&nbsp;func&nbsp;used&nbsp;if&nbsp;io.EOF&nbsp;not&nbsp;seen</span><br>
<span class="lineno">1180</span><span class="op" id="3999800">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3999803">func</span>&nbsp;<span class="op" id="3999808">(</span><span class="ident" id="3999809">es</span>&nbsp;<span class="op" id="3999812">*</span><span class="ident" id="3999813">bodyEOFSignal</span><span class="op" id="3999826">)</span>&nbsp;<span class="ident" id="3999828">Read</span><span class="op" id="3999832">(</span><span class="ident" id="3999833">p</span>&nbsp;<span class="op" id="3999835">[</span><span class="op" id="3999836">]</span><span class="builtintype" id="3999837">byte</span><span class="op" id="3999841">)</span>&nbsp;<span class="op" id="3999843">(</span><span class="ident" id="3999844">n</span>&nbsp;<span class="builtintype" id="3999846">int</span><span class="op" id="3999849">,</span>&nbsp;<span class="ident" id="3999851">err</span>&nbsp;<span class="builtintype" id="3999855">error</span><span class="op" id="3999860">)</span>&nbsp;<span class="op" id="3999862">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3999865">es</span><span class="op" id="3999867">.</span><span class="ident" id="3999868">mu</span><span class="op" id="3999870">.</span><span class="ident" id="3999871">Lock</span><span class="op" id="3999875">(</span><span class="op" id="3999876">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3999879">closed</span><span class="op" id="3999885">,</span>&nbsp;<span class="ident" id="3999887">rerr</span>&nbsp;<span class="op" id="3999892">:=</span>&nbsp;<span class="ident" id="3999895">es</span><span class="op" id="3999897">.</span><span class="ident" id="3999898">closed</span><span class="op" id="3999904">,</span>&nbsp;<span class="ident" id="3999906">es</span><span class="op" id="3999908">.</span><span class="ident" id="3999909">rerr</span><br>
<span class="lineno">1185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3999915">es</span><span class="op" id="3999917">.</span><span class="ident" id="3999918">mu</span><span class="op" id="3999920">.</span><span class="ident" id="3999921">Unlock</span><span class="op" id="3999927">(</span><span class="op" id="3999928">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3999931">if</span>&nbsp;<span class="ident" id="3999934">closed</span>&nbsp;<span class="op" id="3999941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3999945">return</span>&nbsp;<span class="num" id="3999952">0</span><span class="op" id="3999953">,</span>&nbsp;<span class="ident" id="3999955">errors</span><span class="op" id="3999961">.</span><span class="ident" id="3999962">New</span><span class="op" id="3999965">(</span><span class="string" id="3999966">&#34;http:&nbsp;read&nbsp;on&nbsp;closed&nbsp;response&nbsp;body&#34;</span><span class="op" id="4000002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4000005">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4000008">if</span>&nbsp;<span class="ident" id="4000011">rerr</span>&nbsp;<span class="op" id="4000016">!=</span>&nbsp;<span class="ident" id="4000019">nil</span>&nbsp;<span class="op" id="4000023">{</span><br>
<span class="lineno">1190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4000027">return</span>&nbsp;<span class="num" id="4000034">0</span><span class="op" id="4000035">,</span>&nbsp;<span class="ident" id="4000037">rerr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4000043">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4000047">n</span><span class="op" id="4000048">,</span>&nbsp;<span class="ident" id="4000050">err</span>&nbsp;<span class="op" id="4000054">=</span>&nbsp;<span class="ident" id="4000056">es</span><span class="op" id="4000058">.</span><span class="ident" id="4000059">body</span><span class="op" id="4000063">.</span><span class="ident" id="4000064">Read</span><span class="op" id="4000068">(</span><span class="ident" id="4000069">p</span><span class="op" id="4000070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4000073">if</span>&nbsp;<span class="ident" id="4000076">err</span>&nbsp;<span class="op" id="4000080">!=</span>&nbsp;<span class="ident" id="4000083">nil</span>&nbsp;<span class="op" id="4000087">{</span><br>
<span class="lineno">1195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4000091">es</span><span class="op" id="4000093">.</span><span class="ident" id="4000094">mu</span><span class="op" id="4000096">.</span><span class="ident" id="4000097">Lock</span><span class="op" id="4000101">(</span><span class="op" id="4000102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4000106">defer</span>&nbsp;<span class="ident" id="4000112">es</span><span class="op" id="4000114">.</span><span class="ident" id="4000115">mu</span><span class="op" id="4000117">.</span><span class="ident" id="4000118">Unlock</span><span class="op" id="4000124">(</span><span class="op" id="4000125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4000129">if</span>&nbsp;<span class="ident" id="4000132">es</span><span class="op" id="4000134">.</span><span class="ident" id="4000135">rerr</span>&nbsp;<span class="op" id="4000140">==</span>&nbsp;<span class="ident" id="4000143">nil</span>&nbsp;<span class="op" id="4000147">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4000152">es</span><span class="op" id="4000154">.</span><span class="ident" id="4000155">rerr</span>&nbsp;<span class="op" id="4000160">=</span>&nbsp;<span class="ident" id="4000162">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4000168">}</span><br>
<span class="lineno">1200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4000172">es</span><span class="op" id="4000174">.</span><span class="ident" id="4000175">condfn</span><span class="op" id="4000181">(</span><span class="ident" id="4000182">err</span><span class="op" id="4000185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4000188">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4000191">return</span><br>
<span class="lineno"></span><span class="op" id="4000198">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1205</span><span class="keyword" id="4000201">func</span>&nbsp;<span class="op" id="4000206">(</span><span class="ident" id="4000207">es</span>&nbsp;<span class="op" id="4000210">*</span><span class="ident" id="4000211">bodyEOFSignal</span><span class="op" id="4000224">)</span>&nbsp;<span class="ident" id="4000226">Close</span><span class="op" id="4000231">(</span><span class="op" id="4000232">)</span>&nbsp;<span class="builtintype" id="4000234">error</span>&nbsp;<span class="op" id="4000240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4000243">es</span><span class="op" id="4000245">.</span><span class="ident" id="4000246">mu</span><span class="op" id="4000248">.</span><span class="ident" id="4000249">Lock</span><span class="op" id="4000253">(</span><span class="op" id="4000254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4000257">defer</span>&nbsp;<span class="ident" id="4000263">es</span><span class="op" id="4000265">.</span><span class="ident" id="4000266">mu</span><span class="op" id="4000268">.</span><span class="ident" id="4000269">Unlock</span><span class="op" id="4000275">(</span><span class="op" id="4000276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4000279">if</span>&nbsp;<span class="ident" id="4000282">es</span><span class="op" id="4000284">.</span><span class="ident" id="4000285">closed</span>&nbsp;<span class="op" id="4000292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4000296">return</span>&nbsp;<span class="ident" id="4000303">nil</span><br>
<span class="lineno">1210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4000308">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4000311">es</span><span class="op" id="4000313">.</span><span class="ident" id="4000314">closed</span>&nbsp;<span class="op" id="4000321">=</span>&nbsp;<span class="builtintype" id="4000323">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4000329">if</span>&nbsp;<span class="ident" id="4000332">es</span><span class="op" id="4000334">.</span><span class="ident" id="4000335">earlyCloseFn</span>&nbsp;<span class="op" id="4000348">!=</span>&nbsp;<span class="ident" id="4000351">nil</span>&nbsp;<span class="op" id="4000355">&amp;&amp;</span>&nbsp;<span class="ident" id="4000358">es</span><span class="op" id="4000360">.</span><span class="ident" id="4000361">rerr</span>&nbsp;<span class="op" id="4000366">!=</span>&nbsp;<span class="ident" id="4000369">io</span><span class="op" id="4000371">.</span><span class="ident" id="4000372">EOF</span>&nbsp;<span class="op" id="4000376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4000380">return</span>&nbsp;<span class="ident" id="4000387">es</span><span class="op" id="4000389">.</span><span class="ident" id="4000390">earlyCloseFn</span><span class="op" id="4000402">(</span><span class="op" id="4000403">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4000406">}</span><br>
<span class="lineno">1215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4000409">err</span>&nbsp;<span class="op" id="4000413">:=</span>&nbsp;<span class="ident" id="4000416">es</span><span class="op" id="4000418">.</span><span class="ident" id="4000419">body</span><span class="op" id="4000423">.</span><span class="ident" id="4000424">Close</span><span class="op" id="4000429">(</span><span class="op" id="4000430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4000433">es</span><span class="op" id="4000435">.</span><span class="ident" id="4000436">condfn</span><span class="op" id="4000442">(</span><span class="ident" id="4000443">err</span><span class="op" id="4000446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4000449">return</span>&nbsp;<span class="ident" id="4000456">err</span><br>
<span class="lineno"></span><span class="op" id="4000460">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1220</span><span class="comment" id="4000463">//&nbsp;caller&nbsp;must&nbsp;hold&nbsp;es.mu.</span><br>
<span class="lineno"></span><span class="keyword" id="4000490">func</span>&nbsp;<span class="op" id="4000495">(</span><span class="ident" id="4000496">es</span>&nbsp;<span class="op" id="4000499">*</span><span class="ident" id="4000500">bodyEOFSignal</span><span class="op" id="4000513">)</span>&nbsp;<span class="ident" id="4000515">condfn</span><span class="op" id="4000521">(</span><span class="ident" id="4000522">err</span>&nbsp;<span class="builtintype" id="4000526">error</span><span class="op" id="4000531">)</span>&nbsp;<span class="op" id="4000533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4000536">if</span>&nbsp;<span class="ident" id="4000539">es</span><span class="op" id="4000541">.</span><span class="ident" id="4000542">fn</span>&nbsp;<span class="op" id="4000545">==</span>&nbsp;<span class="ident" id="4000548">nil</span>&nbsp;<span class="op" id="4000552">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4000556">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4000564">}</span><br>
<span class="lineno">1225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4000567">if</span>&nbsp;<span class="ident" id="4000570">err</span>&nbsp;<span class="op" id="4000574">==</span>&nbsp;<span class="ident" id="4000577">io</span><span class="op" id="4000579">.</span><span class="ident" id="4000580">EOF</span>&nbsp;<span class="op" id="4000584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4000588">err</span>&nbsp;<span class="op" id="4000592">=</span>&nbsp;<span class="ident" id="4000594">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4000599">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4000602">es</span><span class="op" id="4000604">.</span><span class="ident" id="4000605">fn</span><span class="op" id="4000607">(</span><span class="ident" id="4000608">err</span><span class="op" id="4000611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4000614">es</span><span class="op" id="4000616">.</span><span class="ident" id="4000617">fn</span>&nbsp;<span class="op" id="4000620">=</span>&nbsp;<span class="ident" id="4000622">nil</span><br>
<span class="lineno">1230</span><span class="op" id="4000626">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4000629">//&nbsp;gzipReader&nbsp;wraps&nbsp;a&nbsp;response&nbsp;body&nbsp;so&nbsp;it&nbsp;can&nbsp;lazily</span><br>
<span class="lineno"></span><span class="comment" id="4000682">//&nbsp;call&nbsp;gzip.NewReader&nbsp;on&nbsp;the&nbsp;first&nbsp;call&nbsp;to&nbsp;Read</span><br>
<span class="lineno"></span><span class="keyword" id="4000731">type</span>&nbsp;<span class="ident" id="4000736">gzipReader</span>&nbsp;<span class="keyword" id="4000747">struct</span>&nbsp;<span class="op" id="4000754">{</span><br>
<span class="lineno">1235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4000757">body</span>&nbsp;<span class="ident" id="4000762">io</span><span class="op" id="4000764">.</span><span class="ident" id="4000765">ReadCloser</span>&nbsp;<span class="comment" id="4000776">//&nbsp;underlying&nbsp;Response.Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4000805">zr</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4000810">io</span><span class="op" id="4000812">.</span><span class="ident" id="4000813">Reader</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4000824">//&nbsp;lazily-initialized&nbsp;gzip&nbsp;reader</span><br>
<span class="lineno"></span><span class="op" id="4000858">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4000861">func</span>&nbsp;<span class="op" id="4000866">(</span><span class="ident" id="4000867">gz</span>&nbsp;<span class="op" id="4000870">*</span><span class="ident" id="4000871">gzipReader</span><span class="op" id="4000881">)</span>&nbsp;<span class="ident" id="4000883">Read</span><span class="op" id="4000887">(</span><span class="ident" id="4000888">p</span>&nbsp;<span class="op" id="4000890">[</span><span class="op" id="4000891">]</span><span class="builtintype" id="4000892">byte</span><span class="op" id="4000896">)</span>&nbsp;<span class="op" id="4000898">(</span><span class="ident" id="4000899">n</span>&nbsp;<span class="builtintype" id="4000901">int</span><span class="op" id="4000904">,</span>&nbsp;<span class="ident" id="4000906">err</span>&nbsp;<span class="builtintype" id="4000910">error</span><span class="op" id="4000915">)</span>&nbsp;<span class="op" id="4000917">{</span><br>
<span class="lineno">1240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4000920">if</span>&nbsp;<span class="ident" id="4000923">gz</span><span class="op" id="4000925">.</span><span class="ident" id="4000926">zr</span>&nbsp;<span class="op" id="4000929">==</span>&nbsp;<span class="ident" id="4000932">nil</span>&nbsp;<span class="op" id="4000936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4000940">gz</span><span class="op" id="4000942">.</span><span class="ident" id="4000943">zr</span><span class="op" id="4000945">,</span>&nbsp;<span class="ident" id="4000947">err</span>&nbsp;<span class="op" id="4000951">=</span>&nbsp;<span class="ident" id="4000953">gzip</span><span class="op" id="4000957">.</span><span class="ident" id="4000958">NewReader</span><span class="op" id="4000967">(</span><span class="ident" id="4000968">gz</span><span class="op" id="4000970">.</span><span class="ident" id="4000971">body</span><span class="op" id="4000975">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4000979">if</span>&nbsp;<span class="ident" id="4000982">err</span>&nbsp;<span class="op" id="4000986">!=</span>&nbsp;<span class="ident" id="4000989">nil</span>&nbsp;<span class="op" id="4000993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4000998">return</span>&nbsp;<span class="num" id="4001005">0</span><span class="op" id="4001006">,</span>&nbsp;<span class="ident" id="4001008">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4001014">}</span><br>
<span class="lineno">1245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4001017">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4001020">return</span>&nbsp;<span class="ident" id="4001027">gz</span><span class="op" id="4001029">.</span><span class="ident" id="4001030">zr</span><span class="op" id="4001032">.</span><span class="ident" id="4001033">Read</span><span class="op" id="4001037">(</span><span class="ident" id="4001038">p</span><span class="op" id="4001039">)</span><br>
<span class="lineno"></span><span class="op" id="4001041">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4001044">func</span>&nbsp;<span class="op" id="4001049">(</span><span class="ident" id="4001050">gz</span>&nbsp;<span class="op" id="4001053">*</span><span class="ident" id="4001054">gzipReader</span><span class="op" id="4001064">)</span>&nbsp;<span class="ident" id="4001066">Close</span><span class="op" id="4001071">(</span><span class="op" id="4001072">)</span>&nbsp;<span class="builtintype" id="4001074">error</span>&nbsp;<span class="op" id="4001080">{</span><br>
<span class="lineno">1250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4001083">return</span>&nbsp;<span class="ident" id="4001090">gz</span><span class="op" id="4001092">.</span><span class="ident" id="4001093">body</span><span class="op" id="4001097">.</span><span class="ident" id="4001098">Close</span><span class="op" id="4001103">(</span><span class="op" id="4001104">)</span><br>
<span class="lineno"></span><span class="op" id="4001106">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4001109">type</span>&nbsp;<span class="ident" id="4001114">readerAndCloser</span>&nbsp;<span class="keyword" id="4001130">struct</span>&nbsp;<span class="op" id="4001137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4001140">io</span><span class="op" id="4001142">.</span><span class="ident" id="4001143">Reader</span><br>
<span class="lineno">1255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4001151">io</span><span class="op" id="4001153">.</span><span class="ident" id="4001154">Closer</span><br>
<span class="lineno"></span><span class="op" id="4001161">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4001164">type</span>&nbsp;<span class="ident" id="4001169">tlsHandshakeTimeoutError</span>&nbsp;<span class="keyword" id="4001194">struct</span><span class="op" id="4001200">{</span><span class="op" id="4001201">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1260</span><span class="keyword" id="4001204">func</span>&nbsp;<span class="op" id="4001209">(</span><span class="ident" id="4001210">tlsHandshakeTimeoutError</span><span class="op" id="4001234">)</span>&nbsp;<span class="ident" id="4001236">Timeout</span><span class="op" id="4001243">(</span><span class="op" id="4001244">)</span>&nbsp;<span class="builtintype" id="4001246">bool</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4001253">{</span>&nbsp;<span class="keyword" id="4001255">return</span>&nbsp;<span class="builtintype" id="4001262">true</span>&nbsp;<span class="op" id="4001267">}</span><br>
<span class="lineno"></span><span class="keyword" id="4001269">func</span>&nbsp;<span class="op" id="4001274">(</span><span class="ident" id="4001275">tlsHandshakeTimeoutError</span><span class="op" id="4001299">)</span>&nbsp;<span class="ident" id="4001301">Temporary</span><span class="op" id="4001310">(</span><span class="op" id="4001311">)</span>&nbsp;<span class="builtintype" id="4001313">bool</span>&nbsp;<span class="op" id="4001318">{</span>&nbsp;<span class="keyword" id="4001320">return</span>&nbsp;<span class="builtintype" id="4001327">true</span>&nbsp;<span class="op" id="4001332">}</span><br>
<span class="lineno"></span><span class="keyword" id="4001334">func</span>&nbsp;<span class="op" id="4001339">(</span><span class="ident" id="4001340">tlsHandshakeTimeoutError</span><span class="op" id="4001364">)</span>&nbsp;<span class="ident" id="4001366">Error</span><span class="op" id="4001371">(</span><span class="op" id="4001372">)</span>&nbsp;<span class="builtintype" id="4001374">string</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4001383">{</span>&nbsp;<span class="keyword" id="4001385">return</span>&nbsp;<span class="string" id="4001392">&#34;net/http:&nbsp;TLS&nbsp;handshake&nbsp;timeout&#34;</span>&nbsp;<span class="op" id="4001426">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4001429">type</span>&nbsp;<span class="ident" id="4001434">noteEOFReader</span>&nbsp;<span class="keyword" id="4001448">struct</span>&nbsp;<span class="op" id="4001455">{</span><br>
<span class="lineno">1265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4001458">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4001465">io</span><span class="op" id="4001467">.</span><span class="ident" id="4001468">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4001476">sawEOF</span>&nbsp;<span class="op" id="4001483">*</span><span class="builtintype" id="4001484">bool</span><br>
<span class="lineno"></span><span class="op" id="4001489">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4001492">func</span>&nbsp;<span class="op" id="4001497">(</span><span class="ident" id="4001498">nr</span>&nbsp;<span class="ident" id="4001501">noteEOFReader</span><span class="op" id="4001514">)</span>&nbsp;<span class="ident" id="4001516">Read</span><span class="op" id="4001520">(</span><span class="ident" id="4001521">p</span>&nbsp;<span class="op" id="4001523">[</span><span class="op" id="4001524">]</span><span class="builtintype" id="4001525">byte</span><span class="op" id="4001529">)</span>&nbsp;<span class="op" id="4001531">(</span><span class="ident" id="4001532">n</span>&nbsp;<span class="builtintype" id="4001534">int</span><span class="op" id="4001537">,</span>&nbsp;<span class="ident" id="4001539">err</span>&nbsp;<span class="builtintype" id="4001543">error</span><span class="op" id="4001548">)</span>&nbsp;<span class="op" id="4001550">{</span><br>
<span class="lineno">1270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4001553">n</span><span class="op" id="4001554">,</span>&nbsp;<span class="ident" id="4001556">err</span>&nbsp;<span class="op" id="4001560">=</span>&nbsp;<span class="ident" id="4001562">nr</span><span class="op" id="4001564">.</span><span class="ident" id="4001565">r</span><span class="op" id="4001566">.</span><span class="ident" id="4001567">Read</span><span class="op" id="4001571">(</span><span class="ident" id="4001572">p</span><span class="op" id="4001573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4001576">if</span>&nbsp;<span class="ident" id="4001579">err</span>&nbsp;<span class="op" id="4001583">==</span>&nbsp;<span class="ident" id="4001586">io</span><span class="op" id="4001588">.</span><span class="ident" id="4001589">EOF</span>&nbsp;<span class="op" id="4001593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4001597">*</span><span class="ident" id="4001598">nr</span><span class="op" id="4001600">.</span><span class="ident" id="4001601">sawEOF</span>&nbsp;<span class="op" id="4001608">=</span>&nbsp;<span class="builtintype" id="4001610">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4001616">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4001619">return</span><br>
<span class="lineno">1275</span><span class="op" id="4001626">}</span>
</div>
</body>
</html>
