<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="1638655">//&nbsp;Copyright&nbsp;2014&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1638710">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1638764">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1638815">package</span>&nbsp;<span class="ident" id="1638823">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1638832">import</span>&nbsp;<span class="string" id="1638839">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1638849">var</span>&nbsp;<span class="ident" id="1638853">indexError</span>&nbsp;<span class="op" id="1638864">=</span>&nbsp;<span class="builtintype" id="1638866">error</span><span class="op" id="1638871">(</span><span class="ident" id="1638872">errorString</span><span class="op" id="1638883">(</span><span class="string" id="1638884">&#34;index&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="1638904">)</span><span class="op" id="1638905">)</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="1638908">func</span>&nbsp;<span class="ident" id="1638913">panicindex</span><span class="op" id="1638923">(</span><span class="op" id="1638924">)</span>&nbsp;<span class="op" id="1638926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1638929">panic</span><span class="op" id="1638934">(</span><span class="ident" id="1638935">indexError</span><span class="op" id="1638945">)</span><br>
<span class="lineno"></span><span class="op" id="1638947">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="1638950">var</span>&nbsp;<span class="ident" id="1638954">sliceError</span>&nbsp;<span class="op" id="1638965">=</span>&nbsp;<span class="builtintype" id="1638967">error</span><span class="op" id="1638972">(</span><span class="ident" id="1638973">errorString</span><span class="op" id="1638984">(</span><span class="string" id="1638985">&#34;slice&nbsp;bounds&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="1639012">)</span><span class="op" id="1639013">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1639016">func</span>&nbsp;<span class="ident" id="1639021">panicslice</span><span class="op" id="1639031">(</span><span class="op" id="1639032">)</span>&nbsp;<span class="op" id="1639034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1639037">panic</span><span class="op" id="1639042">(</span><span class="ident" id="1639043">sliceError</span><span class="op" id="1639053">)</span><br>
<span class="lineno"></span><span class="op" id="1639055">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="1639058">var</span>&nbsp;<span class="ident" id="1639062">divideError</span>&nbsp;<span class="op" id="1639074">=</span>&nbsp;<span class="builtintype" id="1639076">error</span><span class="op" id="1639081">(</span><span class="ident" id="1639082">errorString</span><span class="op" id="1639093">(</span><span class="string" id="1639094">&#34;integer&nbsp;divide&nbsp;by&nbsp;zero&#34;</span><span class="op" id="1639118">)</span><span class="op" id="1639119">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1639122">func</span>&nbsp;<span class="ident" id="1639127">panicdivide</span><span class="op" id="1639138">(</span><span class="op" id="1639139">)</span>&nbsp;<span class="op" id="1639141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1639144">panic</span><span class="op" id="1639149">(</span><span class="ident" id="1639150">divideError</span><span class="op" id="1639161">)</span><br>
<span class="lineno">25</span><span class="op" id="1639163">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1639166">var</span>&nbsp;<span class="ident" id="1639170">overflowError</span>&nbsp;<span class="op" id="1639184">=</span>&nbsp;<span class="builtintype" id="1639186">error</span><span class="op" id="1639191">(</span><span class="ident" id="1639192">errorString</span><span class="op" id="1639203">(</span><span class="string" id="1639204">&#34;integer&nbsp;overflow&#34;</span><span class="op" id="1639222">)</span><span class="op" id="1639223">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1639226">func</span>&nbsp;<span class="ident" id="1639231">panicoverflow</span><span class="op" id="1639244">(</span><span class="op" id="1639245">)</span>&nbsp;<span class="op" id="1639247">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1639250">panic</span><span class="op" id="1639255">(</span><span class="ident" id="1639256">overflowError</span><span class="op" id="1639269">)</span><br>
<span class="lineno"></span><span class="op" id="1639271">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1639274">var</span>&nbsp;<span class="ident" id="1639278">floatError</span>&nbsp;<span class="op" id="1639289">=</span>&nbsp;<span class="builtintype" id="1639291">error</span><span class="op" id="1639296">(</span><span class="ident" id="1639297">errorString</span><span class="op" id="1639308">(</span><span class="string" id="1639309">&#34;floating&nbsp;point&nbsp;error&#34;</span><span class="op" id="1639331">)</span><span class="op" id="1639332">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="keyword" id="1639335">func</span>&nbsp;<span class="ident" id="1639340">panicfloat</span><span class="op" id="1639350">(</span><span class="op" id="1639351">)</span>&nbsp;<span class="op" id="1639353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1639356">panic</span><span class="op" id="1639361">(</span><span class="ident" id="1639362">floatError</span><span class="op" id="1639372">)</span><br>
<span class="lineno"></span><span class="op" id="1639374">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1639377">var</span>&nbsp;<span class="ident" id="1639381">memoryError</span>&nbsp;<span class="op" id="1639393">=</span>&nbsp;<span class="builtintype" id="1639395">error</span><span class="op" id="1639400">(</span><span class="ident" id="1639401">errorString</span><span class="op" id="1639412">(</span><span class="string" id="1639413">&#34;invalid&nbsp;memory&nbsp;address&nbsp;or&nbsp;nil&nbsp;pointer&nbsp;dereference&#34;</span><span class="op" id="1639464">)</span><span class="op" id="1639465">)</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="keyword" id="1639468">func</span>&nbsp;<span class="ident" id="1639473">panicmem</span><span class="op" id="1639481">(</span><span class="op" id="1639482">)</span>&nbsp;<span class="op" id="1639484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1639487">panic</span><span class="op" id="1639492">(</span><span class="ident" id="1639493">memoryError</span><span class="op" id="1639504">)</span><br>
<span class="lineno"></span><span class="op" id="1639506">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="keyword" id="1639509">func</span>&nbsp;<span class="ident" id="1639514">throwreturn</span><span class="op" id="1639525">(</span><span class="op" id="1639526">)</span>&nbsp;<span class="op" id="1639528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1639531">gothrow</span><span class="op" id="1639538">(</span><span class="string" id="1639539">&#34;no&nbsp;return&nbsp;at&nbsp;end&nbsp;of&nbsp;a&nbsp;typed&nbsp;function&nbsp;-&nbsp;compiler&nbsp;is&nbsp;broken&#34;</span><span class="op" id="1639598">)</span><br>
<span class="lineno"></span><span class="op" id="1639600">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1639603">func</span>&nbsp;<span class="ident" id="1639608">throwinit</span><span class="op" id="1639617">(</span><span class="op" id="1639618">)</span>&nbsp;<span class="op" id="1639620">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1639623">gothrow</span><span class="op" id="1639630">(</span><span class="string" id="1639631">&#34;recursive&nbsp;call&nbsp;during&nbsp;initialization&nbsp;-&nbsp;linker&nbsp;skew&#34;</span><span class="op" id="1639683">)</span><br>
<span class="lineno"></span><span class="op" id="1639685">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1639688">//&nbsp;Create&nbsp;a&nbsp;new&nbsp;deferred&nbsp;function&nbsp;fn&nbsp;with&nbsp;siz&nbsp;bytes&nbsp;of&nbsp;arguments.</span><br>
<span class="lineno"></span><span class="comment" id="1639754">//&nbsp;The&nbsp;compiler&nbsp;turns&nbsp;a&nbsp;defer&nbsp;statement&nbsp;into&nbsp;a&nbsp;call&nbsp;to&nbsp;this.</span><br>
<span class="lineno">55</span><span class="comment" id="1639815">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1639828">func</span>&nbsp;<span class="ident" id="1639833">deferproc</span><span class="op" id="1639842">(</span><span class="ident" id="1639843">siz</span>&nbsp;<span class="builtintype" id="1639847">int32</span><span class="op" id="1639852">,</span>&nbsp;<span class="ident" id="1639854">fn</span>&nbsp;<span class="op" id="1639857">*</span><span class="ident" id="1639858">funcval</span><span class="op" id="1639865">)</span>&nbsp;<span class="op" id="1639867">{</span>&nbsp;<span class="comment" id="1639869">//&nbsp;arguments&nbsp;of&nbsp;fn&nbsp;follow&nbsp;fn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1639899">//&nbsp;the&nbsp;arguments&nbsp;of&nbsp;fn&nbsp;are&nbsp;in&nbsp;a&nbsp;perilous&nbsp;state.&nbsp;&nbsp;The&nbsp;stack&nbsp;map</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1639963">//&nbsp;for&nbsp;deferproc&nbsp;does&nbsp;not&nbsp;describe&nbsp;them.&nbsp;&nbsp;So&nbsp;we&nbsp;can&#39;t&nbsp;let&nbsp;garbage</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1640030">//&nbsp;collection&nbsp;or&nbsp;stack&nbsp;copying&nbsp;trigger&nbsp;until&nbsp;we&#39;ve&nbsp;copied&nbsp;them&nbsp;out</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1640098">//&nbsp;to&nbsp;somewhere&nbsp;safe.&nbsp;&nbsp;deferproc_m&nbsp;does&nbsp;that.&nbsp;&nbsp;Until&nbsp;deferproc_m,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1640165">//&nbsp;we&nbsp;can&nbsp;only&nbsp;call&nbsp;nosplit&nbsp;routines.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1640204">argp</span>&nbsp;<span class="op" id="1640209">:=</span>&nbsp;<span class="builtintype" id="1640212">uintptr</span><span class="op" id="1640219">(</span><span class="ident" id="1640220">unsafe</span><span class="op" id="1640226">.</span><span class="ident" id="1640227">Pointer</span><span class="op" id="1640234">(</span><span class="op" id="1640235">&amp;</span><span class="ident" id="1640236">fn</span><span class="op" id="1640238">)</span><span class="op" id="1640239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1640242">argp</span>&nbsp;<span class="op" id="1640247">+=</span>&nbsp;<span class="ident" id="1640250">unsafe</span><span class="op" id="1640256">.</span><span class="ident" id="1640257">Sizeof</span><span class="op" id="1640263">(</span><span class="ident" id="1640264">fn</span><span class="op" id="1640266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1640269">if</span>&nbsp;<span class="ident" id="1640272">GOARCH</span>&nbsp;<span class="op" id="1640279">==</span>&nbsp;<span class="string" id="1640282">&#34;arm&#34;</span>&nbsp;<span class="op" id="1640288">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1640292">argp</span>&nbsp;<span class="op" id="1640297">+=</span>&nbsp;<span class="ident" id="1640300">ptrSize</span>&nbsp;<span class="comment" id="1640308">//&nbsp;skip&nbsp;caller&#39;s&nbsp;saved&nbsp;link&nbsp;register</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1640346">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1640349">mp</span>&nbsp;<span class="op" id="1640352">:=</span>&nbsp;<span class="ident" id="1640355">acquirem</span><span class="op" id="1640363">(</span><span class="op" id="1640364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1640367">mp</span><span class="op" id="1640369">.</span><span class="ident" id="1640370">scalararg</span><span class="op" id="1640379">[</span><span class="num" id="1640380">0</span><span class="op" id="1640381">]</span>&nbsp;<span class="op" id="1640383">=</span>&nbsp;<span class="builtintype" id="1640385">uintptr</span><span class="op" id="1640392">(</span><span class="ident" id="1640393">siz</span><span class="op" id="1640396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1640399">mp</span><span class="op" id="1640401">.</span><span class="ident" id="1640402">ptrarg</span><span class="op" id="1640408">[</span><span class="num" id="1640409">0</span><span class="op" id="1640410">]</span>&nbsp;<span class="op" id="1640412">=</span>&nbsp;<span class="ident" id="1640414">unsafe</span><span class="op" id="1640420">.</span><span class="ident" id="1640421">Pointer</span><span class="op" id="1640428">(</span><span class="ident" id="1640429">fn</span><span class="op" id="1640431">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1640434">mp</span><span class="op" id="1640436">.</span><span class="ident" id="1640437">scalararg</span><span class="op" id="1640446">[</span><span class="num" id="1640447">1</span><span class="op" id="1640448">]</span>&nbsp;<span class="op" id="1640450">=</span>&nbsp;<span class="ident" id="1640452">argp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1640458">mp</span><span class="op" id="1640460">.</span><span class="ident" id="1640461">scalararg</span><span class="op" id="1640470">[</span><span class="num" id="1640471">2</span><span class="op" id="1640472">]</span>&nbsp;<span class="op" id="1640474">=</span>&nbsp;<span class="ident" id="1640476">getcallerpc</span><span class="op" id="1640487">(</span><span class="ident" id="1640488">unsafe</span><span class="op" id="1640494">.</span><span class="ident" id="1640495">Pointer</span><span class="op" id="1640502">(</span><span class="op" id="1640503">&amp;</span><span class="ident" id="1640504">siz</span><span class="op" id="1640507">)</span><span class="op" id="1640508">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1640512">if</span>&nbsp;<span class="ident" id="1640515">mp</span><span class="op" id="1640517">.</span><span class="ident" id="1640518">curg</span>&nbsp;<span class="op" id="1640523">!=</span>&nbsp;<span class="ident" id="1640526">getg</span><span class="op" id="1640530">(</span><span class="op" id="1640531">)</span>&nbsp;<span class="op" id="1640533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1640537">//&nbsp;go&nbsp;code&nbsp;on&nbsp;the&nbsp;m&nbsp;stack&nbsp;can&#39;t&nbsp;defer</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1640577">gothrow</span><span class="op" id="1640584">(</span><span class="string" id="1640585">&#34;defer&nbsp;on&nbsp;m&#34;</span><span class="op" id="1640597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1640600">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1640604">onM</span><span class="op" id="1640607">(</span><span class="ident" id="1640608">deferproc_m</span><span class="op" id="1640619">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1640623">releasem</span><span class="op" id="1640631">(</span><span class="ident" id="1640632">mp</span><span class="op" id="1640634">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1640638">//&nbsp;deferproc&nbsp;returns&nbsp;0&nbsp;normally.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1640672">//&nbsp;a&nbsp;deferred&nbsp;func&nbsp;that&nbsp;stops&nbsp;a&nbsp;panic</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1640711">//&nbsp;makes&nbsp;the&nbsp;deferproc&nbsp;return&nbsp;1.</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1640745">//&nbsp;the&nbsp;code&nbsp;the&nbsp;compiler&nbsp;generates&nbsp;always</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1640788">//&nbsp;checks&nbsp;the&nbsp;return&nbsp;value&nbsp;and&nbsp;jumps&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1640833">//&nbsp;end&nbsp;of&nbsp;the&nbsp;function&nbsp;if&nbsp;deferproc&nbsp;returns&nbsp;!=&nbsp;0.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1640884">return0</span><span class="op" id="1640891">(</span><span class="op" id="1640892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1640895">//&nbsp;No&nbsp;code&nbsp;can&nbsp;go&nbsp;here&nbsp;-&nbsp;the&nbsp;C&nbsp;return&nbsp;register&nbsp;has</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1640947">//&nbsp;been&nbsp;set&nbsp;and&nbsp;must&nbsp;not&nbsp;be&nbsp;clobbered.</span><br>
<span class="lineno"></span><span class="op" id="1640986">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1640989">//&nbsp;Small&nbsp;malloc&nbsp;size&nbsp;classes&nbsp;&gt;=&nbsp;16&nbsp;are&nbsp;the&nbsp;multiples&nbsp;of&nbsp;16:&nbsp;16,&nbsp;32,&nbsp;48,&nbsp;64,&nbsp;80,&nbsp;96,&nbsp;112,&nbsp;128,&nbsp;144,&nbsp;...</span><br>
<span class="lineno"></span><span class="comment" id="1641092">//&nbsp;Each&nbsp;P&nbsp;holds&nbsp;a&nbsp;pool&nbsp;for&nbsp;defers&nbsp;with&nbsp;small&nbsp;arg&nbsp;sizes.</span><br>
<span class="lineno">95</span><span class="comment" id="1641148">//&nbsp;Assign&nbsp;defer&nbsp;allocations&nbsp;to&nbsp;pools&nbsp;by&nbsp;rounding&nbsp;to&nbsp;16,&nbsp;to&nbsp;match&nbsp;malloc&nbsp;size&nbsp;classes.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1641235">const</span>&nbsp;<span class="op" id="1641241">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1641244">deferHeaderSize</span>&nbsp;<span class="op" id="1641260">=</span>&nbsp;<span class="ident" id="1641262">unsafe</span><span class="op" id="1641268">.</span><span class="ident" id="1641269">Sizeof</span><span class="op" id="1641275">(</span><span class="ident" id="1641276">_defer</span><span class="op" id="1641282">{</span><span class="op" id="1641283">}</span><span class="op" id="1641284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1641287">minDeferAlloc</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1641303">=</span>&nbsp;<span class="op" id="1641305">(</span><span class="ident" id="1641306">deferHeaderSize</span>&nbsp;<span class="op" id="1641322">+</span>&nbsp;<span class="num" id="1641324">15</span><span class="op" id="1641326">)</span>&nbsp;<span class="op" id="1641328">&amp;^</span>&nbsp;<span class="num" id="1641331">15</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1641335">minDeferArgs</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="1641351">=</span>&nbsp;<span class="ident" id="1641353">minDeferAlloc</span>&nbsp;<span class="op" id="1641367">-</span>&nbsp;<span class="ident" id="1641369">deferHeaderSize</span><br>
<span class="lineno"></span><span class="op" id="1641385">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1641388">//&nbsp;defer&nbsp;size&nbsp;class&nbsp;for&nbsp;arg&nbsp;size&nbsp;sz</span><br>
<span class="lineno"></span><span class="comment" id="1641424">//go:nosplit</span><br>
<span class="lineno">105</span><span class="keyword" id="1641437">func</span>&nbsp;<span class="ident" id="1641442">deferclass</span><span class="op" id="1641452">(</span><span class="ident" id="1641453">siz</span>&nbsp;<span class="builtintype" id="1641457">uintptr</span><span class="op" id="1641464">)</span>&nbsp;<span class="builtintype" id="1641466">uintptr</span>&nbsp;<span class="op" id="1641474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1641477">if</span>&nbsp;<span class="ident" id="1641480">siz</span>&nbsp;<span class="op" id="1641484">&lt;=</span>&nbsp;<span class="ident" id="1641487">minDeferArgs</span>&nbsp;<span class="op" id="1641500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1641504">return</span>&nbsp;<span class="num" id="1641511">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1641514">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1641517">return</span>&nbsp;<span class="op" id="1641524">(</span><span class="ident" id="1641525">siz</span>&nbsp;<span class="op" id="1641529">-</span>&nbsp;<span class="ident" id="1641531">minDeferArgs</span>&nbsp;<span class="op" id="1641544">+</span>&nbsp;<span class="num" id="1641546">15</span><span class="op" id="1641548">)</span>&nbsp;<span class="op" id="1641550">/</span>&nbsp;<span class="num" id="1641552">16</span><br>
<span class="lineno">110</span><span class="op" id="1641555">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1641558">//&nbsp;total&nbsp;size&nbsp;of&nbsp;memory&nbsp;block&nbsp;for&nbsp;defer&nbsp;with&nbsp;arg&nbsp;size&nbsp;sz</span><br>
<span class="lineno"></span><span class="keyword" id="1641615">func</span>&nbsp;<span class="ident" id="1641620">totaldefersize</span><span class="op" id="1641634">(</span><span class="ident" id="1641635">siz</span>&nbsp;<span class="builtintype" id="1641639">uintptr</span><span class="op" id="1641646">)</span>&nbsp;<span class="builtintype" id="1641648">uintptr</span>&nbsp;<span class="op" id="1641656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1641659">if</span>&nbsp;<span class="ident" id="1641662">siz</span>&nbsp;<span class="op" id="1641666">&lt;=</span>&nbsp;<span class="ident" id="1641669">minDeferArgs</span>&nbsp;<span class="op" id="1641682">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1641686">return</span>&nbsp;<span class="ident" id="1641693">minDeferAlloc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1641708">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1641711">return</span>&nbsp;<span class="ident" id="1641718">deferHeaderSize</span>&nbsp;<span class="op" id="1641734">+</span>&nbsp;<span class="ident" id="1641736">siz</span><br>
<span class="lineno"></span><span class="op" id="1641740">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="comment" id="1641743">//&nbsp;Ensure&nbsp;that&nbsp;defer&nbsp;arg&nbsp;sizes&nbsp;that&nbsp;map&nbsp;to&nbsp;the&nbsp;same&nbsp;defer&nbsp;size&nbsp;class</span><br>
<span class="lineno"></span><span class="comment" id="1641812">//&nbsp;also&nbsp;map&nbsp;to&nbsp;the&nbsp;same&nbsp;malloc&nbsp;size&nbsp;class.</span><br>
<span class="lineno"></span><span class="keyword" id="1641855">func</span>&nbsp;<span class="ident" id="1641860">testdefersizes</span><span class="op" id="1641874">(</span><span class="op" id="1641875">)</span>&nbsp;<span class="op" id="1641877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1641880">var</span>&nbsp;<span class="ident" id="1641884">m</span>&nbsp;<span class="op" id="1641886">[</span><span class="builtinfunc" id="1641887">len</span><span class="op" id="1641890">(</span><span class="ident" id="1641891">p</span><span class="op" id="1641892">{</span><span class="op" id="1641893">}</span><span class="op" id="1641894">.</span><span class="ident" id="1641895">deferpool</span><span class="op" id="1641904">)</span><span class="op" id="1641905">]</span><span class="builtintype" id="1641906">int32</span><br>
<span class="lineno"></span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1641914">for</span>&nbsp;<span class="ident" id="1641918">i</span>&nbsp;<span class="op" id="1641920">:=</span>&nbsp;<span class="keyword" id="1641923">range</span>&nbsp;<span class="ident" id="1641929">m</span>&nbsp;<span class="op" id="1641931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1641935">m</span><span class="op" id="1641936">[</span><span class="ident" id="1641937">i</span><span class="op" id="1641938">]</span>&nbsp;<span class="op" id="1641940">=</span>&nbsp;<span class="op" id="1641942">-</span><span class="num" id="1641943">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1641946">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1641949">for</span>&nbsp;<span class="ident" id="1641953">i</span>&nbsp;<span class="op" id="1641955">:=</span>&nbsp;<span class="builtintype" id="1641958">uintptr</span><span class="op" id="1641965">(</span><span class="num" id="1641966">0</span><span class="op" id="1641967">)</span><span class="op" id="1641968">;</span>&nbsp;<span class="op" id="1641970">;</span>&nbsp;<span class="ident" id="1641972">i</span><span class="op" id="1641973">++</span>&nbsp;<span class="op" id="1641976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1641980">defersc</span>&nbsp;<span class="op" id="1641988">:=</span>&nbsp;<span class="ident" id="1641991">deferclass</span><span class="op" id="1642001">(</span><span class="ident" id="1642002">i</span><span class="op" id="1642003">)</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1642007">if</span>&nbsp;<span class="ident" id="1642010">defersc</span>&nbsp;<span class="op" id="1642018">&gt;=</span>&nbsp;<span class="builtintype" id="1642021">uintptr</span><span class="op" id="1642028">(</span><span class="builtinfunc" id="1642029">len</span><span class="op" id="1642032">(</span><span class="ident" id="1642033">m</span><span class="op" id="1642034">)</span><span class="op" id="1642035">)</span>&nbsp;<span class="op" id="1642037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1642042">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1642050">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1642054">siz</span>&nbsp;<span class="op" id="1642058">:=</span>&nbsp;<span class="ident" id="1642061">goroundupsize</span><span class="op" id="1642074">(</span><span class="ident" id="1642075">totaldefersize</span><span class="op" id="1642089">(</span><span class="ident" id="1642090">i</span><span class="op" id="1642091">)</span><span class="op" id="1642092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1642096">if</span>&nbsp;<span class="ident" id="1642099">m</span><span class="op" id="1642100">[</span><span class="ident" id="1642101">defersc</span><span class="op" id="1642108">]</span>&nbsp;<span class="op" id="1642110">&lt;</span>&nbsp;<span class="num" id="1642112">0</span>&nbsp;<span class="op" id="1642114">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1642119">m</span><span class="op" id="1642120">[</span><span class="ident" id="1642121">defersc</span><span class="op" id="1642128">]</span>&nbsp;<span class="op" id="1642130">=</span>&nbsp;<span class="builtintype" id="1642132">int32</span><span class="op" id="1642137">(</span><span class="ident" id="1642138">siz</span><span class="op" id="1642141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1642146">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1642157">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1642161">if</span>&nbsp;<span class="ident" id="1642164">m</span><span class="op" id="1642165">[</span><span class="ident" id="1642166">defersc</span><span class="op" id="1642173">]</span>&nbsp;<span class="op" id="1642175">!=</span>&nbsp;<span class="builtintype" id="1642178">int32</span><span class="op" id="1642183">(</span><span class="ident" id="1642184">siz</span><span class="op" id="1642187">)</span>&nbsp;<span class="op" id="1642189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1642194">print</span><span class="op" id="1642199">(</span><span class="string" id="1642200">&#34;bad&nbsp;defer&nbsp;size&nbsp;class:&nbsp;i=&#34;</span><span class="op" id="1642226">,</span>&nbsp;<span class="ident" id="1642228">i</span><span class="op" id="1642229">,</span>&nbsp;<span class="string" id="1642231">&#34;&nbsp;siz=&#34;</span><span class="op" id="1642238">,</span>&nbsp;<span class="ident" id="1642240">siz</span><span class="op" id="1642243">,</span>&nbsp;<span class="string" id="1642245">&#34;&nbsp;defersc=&#34;</span><span class="op" id="1642256">,</span>&nbsp;<span class="ident" id="1642258">defersc</span><span class="op" id="1642265">,</span>&nbsp;<span class="string" id="1642267">&#34;\n&#34;</span><span class="op" id="1642271">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1642276">gothrow</span><span class="op" id="1642283">(</span><span class="string" id="1642284">&#34;bad&nbsp;defer&nbsp;size&nbsp;class&#34;</span><span class="op" id="1642306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1642310">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1642313">}</span><br>
<span class="lineno"></span><span class="op" id="1642315">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="comment" id="1642318">//&nbsp;The&nbsp;arguments&nbsp;associated&nbsp;with&nbsp;a&nbsp;deferred&nbsp;call&nbsp;are&nbsp;stored</span><br>
<span class="lineno"></span><span class="comment" id="1642378">//&nbsp;immediately&nbsp;after&nbsp;the&nbsp;_defer&nbsp;header&nbsp;in&nbsp;memory.</span><br>
<span class="lineno"></span><span class="comment" id="1642428">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1642441">func</span>&nbsp;<span class="ident" id="1642446">deferArgs</span><span class="op" id="1642455">(</span><span class="ident" id="1642456">d</span>&nbsp;<span class="op" id="1642458">*</span><span class="ident" id="1642459">_defer</span><span class="op" id="1642465">)</span>&nbsp;<span class="ident" id="1642467">unsafe</span><span class="op" id="1642473">.</span><span class="ident" id="1642474">Pointer</span>&nbsp;<span class="op" id="1642482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1642485">return</span>&nbsp;<span class="ident" id="1642492">add</span><span class="op" id="1642495">(</span><span class="ident" id="1642496">unsafe</span><span class="op" id="1642502">.</span><span class="ident" id="1642503">Pointer</span><span class="op" id="1642510">(</span><span class="ident" id="1642511">d</span><span class="op" id="1642512">)</span><span class="op" id="1642513">,</span>&nbsp;<span class="ident" id="1642515">unsafe</span><span class="op" id="1642521">.</span><span class="ident" id="1642522">Sizeof</span><span class="op" id="1642528">(</span><span class="op" id="1642529">*</span><span class="ident" id="1642530">d</span><span class="op" id="1642531">)</span><span class="op" id="1642532">)</span><br>
<span class="lineno">150</span><span class="op" id="1642534">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1642537">var</span>&nbsp;<span class="ident" id="1642541">deferType</span>&nbsp;<span class="op" id="1642551">*</span><span class="ident" id="1642552">_type</span>&nbsp;<span class="comment" id="1642558">//&nbsp;type&nbsp;of&nbsp;_defer&nbsp;struct</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1642584">func</span>&nbsp;<span class="ident" id="1642589">init</span><span class="op" id="1642593">(</span><span class="op" id="1642594">)</span>&nbsp;<span class="op" id="1642596">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1642599">var</span>&nbsp;<span class="ident" id="1642603">x</span>&nbsp;<span class="keyword" id="1642605">interface</span><span class="op" id="1642614">{</span><span class="op" id="1642615">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1642618">x</span>&nbsp;<span class="op" id="1642620">=</span>&nbsp;<span class="op" id="1642622">(</span><span class="op" id="1642623">*</span><span class="ident" id="1642624">_defer</span><span class="op" id="1642630">)</span><span class="op" id="1642631">(</span><span class="ident" id="1642632">nil</span><span class="op" id="1642635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1642638">deferType</span>&nbsp;<span class="op" id="1642648">=</span>&nbsp;<span class="op" id="1642650">(</span><span class="op" id="1642651">*</span><span class="op" id="1642652">(</span><span class="op" id="1642653">*</span><span class="op" id="1642654">*</span><span class="ident" id="1642655">ptrtype</span><span class="op" id="1642662">)</span><span class="op" id="1642663">(</span><span class="ident" id="1642664">unsafe</span><span class="op" id="1642670">.</span><span class="ident" id="1642671">Pointer</span><span class="op" id="1642678">(</span><span class="op" id="1642679">&amp;</span><span class="ident" id="1642680">x</span><span class="op" id="1642681">)</span><span class="op" id="1642682">)</span><span class="op" id="1642683">)</span><span class="op" id="1642684">.</span><span class="ident" id="1642685">elem</span><br>
<span class="lineno"></span><span class="op" id="1642690">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="comment" id="1642693">//&nbsp;Allocate&nbsp;a&nbsp;Defer,&nbsp;usually&nbsp;using&nbsp;per-P&nbsp;pool.</span><br>
<span class="lineno"></span><span class="comment" id="1642740">//&nbsp;Each&nbsp;defer&nbsp;must&nbsp;be&nbsp;released&nbsp;with&nbsp;freedefer.</span><br>
<span class="lineno"></span><span class="comment" id="1642787">//&nbsp;Note:&nbsp;runs&nbsp;on&nbsp;M&nbsp;stack</span><br>
<span class="lineno"></span><span class="keyword" id="1642812">func</span>&nbsp;<span class="ident" id="1642817">newdefer</span><span class="op" id="1642825">(</span><span class="ident" id="1642826">siz</span>&nbsp;<span class="builtintype" id="1642830">int32</span><span class="op" id="1642835">)</span>&nbsp;<span class="op" id="1642837">*</span><span class="ident" id="1642838">_defer</span>&nbsp;<span class="op" id="1642845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1642848">var</span>&nbsp;<span class="ident" id="1642852">d</span>&nbsp;<span class="op" id="1642854">*</span><span class="ident" id="1642855">_defer</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1642863">sc</span>&nbsp;<span class="op" id="1642866">:=</span>&nbsp;<span class="ident" id="1642869">deferclass</span><span class="op" id="1642879">(</span><span class="builtintype" id="1642880">uintptr</span><span class="op" id="1642887">(</span><span class="ident" id="1642888">siz</span><span class="op" id="1642891">)</span><span class="op" id="1642892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1642895">mp</span>&nbsp;<span class="op" id="1642898">:=</span>&nbsp;<span class="ident" id="1642901">acquirem</span><span class="op" id="1642909">(</span><span class="op" id="1642910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1642913">if</span>&nbsp;<span class="ident" id="1642916">sc</span>&nbsp;<span class="op" id="1642919">&lt;</span>&nbsp;<span class="builtintype" id="1642921">uintptr</span><span class="op" id="1642928">(</span><span class="builtinfunc" id="1642929">len</span><span class="op" id="1642932">(</span><span class="ident" id="1642933">p</span><span class="op" id="1642934">{</span><span class="op" id="1642935">}</span><span class="op" id="1642936">.</span><span class="ident" id="1642937">deferpool</span><span class="op" id="1642946">)</span><span class="op" id="1642947">)</span>&nbsp;<span class="op" id="1642949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1642953">pp</span>&nbsp;<span class="op" id="1642956">:=</span>&nbsp;<span class="ident" id="1642959">mp</span><span class="op" id="1642961">.</span><span class="ident" id="1642962">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1642966">d</span>&nbsp;<span class="op" id="1642968">=</span>&nbsp;<span class="ident" id="1642970">pp</span><span class="op" id="1642972">.</span><span class="ident" id="1642973">deferpool</span><span class="op" id="1642982">[</span><span class="ident" id="1642983">sc</span><span class="op" id="1642985">]</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1642989">if</span>&nbsp;<span class="ident" id="1642992">d</span>&nbsp;<span class="op" id="1642994">!=</span>&nbsp;<span class="ident" id="1642997">nil</span>&nbsp;<span class="op" id="1643001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1643006">pp</span><span class="op" id="1643008">.</span><span class="ident" id="1643009">deferpool</span><span class="op" id="1643018">[</span><span class="ident" id="1643019">sc</span><span class="op" id="1643021">]</span>&nbsp;<span class="op" id="1643023">=</span>&nbsp;<span class="ident" id="1643025">d</span><span class="op" id="1643026">.</span><span class="ident" id="1643027">link</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1643034">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1643037">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1643040">if</span>&nbsp;<span class="ident" id="1643043">d</span>&nbsp;<span class="op" id="1643045">==</span>&nbsp;<span class="ident" id="1643048">nil</span>&nbsp;<span class="op" id="1643052">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1643056">//&nbsp;Allocate&nbsp;new&nbsp;defer+args.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1643086">total</span>&nbsp;<span class="op" id="1643092">:=</span>&nbsp;<span class="ident" id="1643095">goroundupsize</span><span class="op" id="1643108">(</span><span class="ident" id="1643109">totaldefersize</span><span class="op" id="1643123">(</span><span class="builtintype" id="1643124">uintptr</span><span class="op" id="1643131">(</span><span class="ident" id="1643132">siz</span><span class="op" id="1643135">)</span><span class="op" id="1643136">)</span><span class="op" id="1643137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1643141">d</span>&nbsp;<span class="op" id="1643143">=</span>&nbsp;<span class="op" id="1643145">(</span><span class="op" id="1643146">*</span><span class="ident" id="1643147">_defer</span><span class="op" id="1643153">)</span><span class="op" id="1643154">(</span><span class="ident" id="1643155">mallocgc</span><span class="op" id="1643163">(</span><span class="ident" id="1643164">total</span><span class="op" id="1643169">,</span>&nbsp;<span class="ident" id="1643171">deferType</span><span class="op" id="1643180">,</span>&nbsp;<span class="num" id="1643182">0</span><span class="op" id="1643183">)</span><span class="op" id="1643184">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1643187">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1643190">d</span><span class="op" id="1643191">.</span><span class="ident" id="1643192">siz</span>&nbsp;<span class="op" id="1643196">=</span>&nbsp;<span class="ident" id="1643198">siz</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1643203">gp</span>&nbsp;<span class="op" id="1643206">:=</span>&nbsp;<span class="ident" id="1643209">mp</span><span class="op" id="1643211">.</span><span class="ident" id="1643212">curg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1643218">d</span><span class="op" id="1643219">.</span><span class="ident" id="1643220">link</span>&nbsp;<span class="op" id="1643225">=</span>&nbsp;<span class="ident" id="1643227">gp</span><span class="op" id="1643229">.</span><span class="ident" id="1643230">_defer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1643238">gp</span><span class="op" id="1643240">.</span><span class="ident" id="1643241">_defer</span>&nbsp;<span class="op" id="1643248">=</span>&nbsp;<span class="ident" id="1643250">d</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1643253">releasem</span><span class="op" id="1643261">(</span><span class="ident" id="1643262">mp</span><span class="op" id="1643264">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1643267">return</span>&nbsp;<span class="ident" id="1643274">d</span><br>
<span class="lineno">185</span><span class="op" id="1643276">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1643279">//&nbsp;Free&nbsp;the&nbsp;given&nbsp;defer.</span><br>
<span class="lineno"></span><span class="comment" id="1643304">//&nbsp;The&nbsp;defer&nbsp;cannot&nbsp;be&nbsp;used&nbsp;after&nbsp;this&nbsp;call.</span><br>
<span class="lineno"></span><span class="comment" id="1643349">//go:nosplit</span><br>
<span class="lineno">190</span><span class="keyword" id="1643362">func</span>&nbsp;<span class="ident" id="1643367">freedefer</span><span class="op" id="1643376">(</span><span class="ident" id="1643377">d</span>&nbsp;<span class="op" id="1643379">*</span><span class="ident" id="1643380">_defer</span><span class="op" id="1643386">)</span>&nbsp;<span class="op" id="1643388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1643391">if</span>&nbsp;<span class="ident" id="1643394">d</span><span class="op" id="1643395">.</span><span class="ident" id="1643396">_panic</span>&nbsp;<span class="op" id="1643403">!=</span>&nbsp;<span class="ident" id="1643406">nil</span>&nbsp;<span class="op" id="1643410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1643414">freedeferpanic</span><span class="op" id="1643428">(</span><span class="op" id="1643429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1643432">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1643435">if</span>&nbsp;<span class="ident" id="1643438">d</span><span class="op" id="1643439">.</span><span class="ident" id="1643440">fn</span>&nbsp;<span class="op" id="1643443">!=</span>&nbsp;<span class="ident" id="1643446">nil</span>&nbsp;<span class="op" id="1643450">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1643454">freedeferfn</span><span class="op" id="1643465">(</span><span class="op" id="1643466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1643469">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1643472">sc</span>&nbsp;<span class="op" id="1643475">:=</span>&nbsp;<span class="ident" id="1643478">deferclass</span><span class="op" id="1643488">(</span><span class="builtintype" id="1643489">uintptr</span><span class="op" id="1643496">(</span><span class="ident" id="1643497">d</span><span class="op" id="1643498">.</span><span class="ident" id="1643499">siz</span><span class="op" id="1643502">)</span><span class="op" id="1643503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1643506">if</span>&nbsp;<span class="ident" id="1643509">sc</span>&nbsp;<span class="op" id="1643512">&lt;</span>&nbsp;<span class="builtintype" id="1643514">uintptr</span><span class="op" id="1643521">(</span><span class="builtinfunc" id="1643522">len</span><span class="op" id="1643525">(</span><span class="ident" id="1643526">p</span><span class="op" id="1643527">{</span><span class="op" id="1643528">}</span><span class="op" id="1643529">.</span><span class="ident" id="1643530">deferpool</span><span class="op" id="1643539">)</span><span class="op" id="1643540">)</span>&nbsp;<span class="op" id="1643542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1643546">mp</span>&nbsp;<span class="op" id="1643549">:=</span>&nbsp;<span class="ident" id="1643552">acquirem</span><span class="op" id="1643560">(</span><span class="op" id="1643561">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1643565">pp</span>&nbsp;<span class="op" id="1643568">:=</span>&nbsp;<span class="ident" id="1643571">mp</span><span class="op" id="1643573">.</span><span class="ident" id="1643574">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1643578">*</span><span class="ident" id="1643579">d</span>&nbsp;<span class="op" id="1643581">=</span>&nbsp;<span class="ident" id="1643583">_defer</span><span class="op" id="1643589">{</span><span class="op" id="1643590">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1643594">d</span><span class="op" id="1643595">.</span><span class="ident" id="1643596">link</span>&nbsp;<span class="op" id="1643601">=</span>&nbsp;<span class="ident" id="1643603">pp</span><span class="op" id="1643605">.</span><span class="ident" id="1643606">deferpool</span><span class="op" id="1643615">[</span><span class="ident" id="1643616">sc</span><span class="op" id="1643618">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1643622">pp</span><span class="op" id="1643624">.</span><span class="ident" id="1643625">deferpool</span><span class="op" id="1643634">[</span><span class="ident" id="1643635">sc</span><span class="op" id="1643637">]</span>&nbsp;<span class="op" id="1643639">=</span>&nbsp;<span class="ident" id="1643641">d</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1643645">releasem</span><span class="op" id="1643653">(</span><span class="ident" id="1643654">mp</span><span class="op" id="1643656">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1643659">}</span><br>
<span class="lineno"></span><span class="op" id="1643661">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1643664">//&nbsp;Separate&nbsp;function&nbsp;so&nbsp;that&nbsp;it&nbsp;can&nbsp;split&nbsp;stack.</span><br>
<span class="lineno"></span><span class="comment" id="1643713">//&nbsp;Windows&nbsp;otherwise&nbsp;runs&nbsp;out&nbsp;of&nbsp;stack&nbsp;space.</span><br>
<span class="lineno">210</span><span class="keyword" id="1643759">func</span>&nbsp;<span class="ident" id="1643764">freedeferpanic</span><span class="op" id="1643778">(</span><span class="op" id="1643779">)</span>&nbsp;<span class="op" id="1643781">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1643784">//&nbsp;_panic&nbsp;must&nbsp;be&nbsp;cleared&nbsp;before&nbsp;d&nbsp;is&nbsp;unlinked&nbsp;from&nbsp;gp.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1643841">gothrow</span><span class="op" id="1643848">(</span><span class="string" id="1643849">&#34;freedefer&nbsp;with&nbsp;d._panic&nbsp;!=&nbsp;nil&#34;</span><span class="op" id="1643881">)</span><br>
<span class="lineno"></span><span class="op" id="1643883">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span><span class="keyword" id="1643886">func</span>&nbsp;<span class="ident" id="1643891">freedeferfn</span><span class="op" id="1643902">(</span><span class="op" id="1643903">)</span>&nbsp;<span class="op" id="1643905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1643908">//&nbsp;fn&nbsp;must&nbsp;be&nbsp;cleared&nbsp;before&nbsp;d&nbsp;is&nbsp;unlinked&nbsp;from&nbsp;gp.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1643961">gothrow</span><span class="op" id="1643968">(</span><span class="string" id="1643969">&#34;freedefer&nbsp;with&nbsp;d.fn&nbsp;!=&nbsp;nil&#34;</span><span class="op" id="1643997">)</span><br>
<span class="lineno"></span><span class="op" id="1643999">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">220</span><span class="comment" id="1644002">//&nbsp;Run&nbsp;a&nbsp;deferred&nbsp;function&nbsp;if&nbsp;there&nbsp;is&nbsp;one.</span><br>
<span class="lineno"></span><span class="comment" id="1644046">//&nbsp;The&nbsp;compiler&nbsp;inserts&nbsp;a&nbsp;call&nbsp;to&nbsp;this&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;any</span><br>
<span class="lineno"></span><span class="comment" id="1644103">//&nbsp;function&nbsp;which&nbsp;calls&nbsp;defer.</span><br>
<span class="lineno"></span><span class="comment" id="1644134">//&nbsp;If&nbsp;there&nbsp;is&nbsp;a&nbsp;deferred&nbsp;function,&nbsp;this&nbsp;will&nbsp;call&nbsp;runtimejmpdefer,</span><br>
<span class="lineno"></span><span class="comment" id="1644204">//&nbsp;which&nbsp;will&nbsp;jump&nbsp;to&nbsp;the&nbsp;deferred&nbsp;function&nbsp;such&nbsp;that&nbsp;it&nbsp;appears</span><br>
<span class="lineno">225</span><span class="comment" id="1644269">//&nbsp;to&nbsp;have&nbsp;been&nbsp;called&nbsp;by&nbsp;the&nbsp;caller&nbsp;of&nbsp;deferreturn&nbsp;at&nbsp;the&nbsp;point</span><br>
<span class="lineno"></span><span class="comment" id="1644334">//&nbsp;just&nbsp;before&nbsp;deferreturn&nbsp;was&nbsp;called.&nbsp;&nbsp;The&nbsp;effect&nbsp;is&nbsp;that&nbsp;deferreturn</span><br>
<span class="lineno"></span><span class="comment" id="1644405">//&nbsp;is&nbsp;called&nbsp;again&nbsp;and&nbsp;again&nbsp;until&nbsp;there&nbsp;are&nbsp;no&nbsp;more&nbsp;deferred&nbsp;functions.</span><br>
<span class="lineno"></span><span class="comment" id="1644478">//&nbsp;Cannot&nbsp;split&nbsp;the&nbsp;stack&nbsp;because&nbsp;we&nbsp;reuse&nbsp;the&nbsp;caller&#39;s&nbsp;frame&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="1644543">//&nbsp;call&nbsp;the&nbsp;deferred&nbsp;function.</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span><span class="comment" id="1644575">//&nbsp;The&nbsp;single&nbsp;argument&nbsp;isn&#39;t&nbsp;actually&nbsp;used&nbsp;-&nbsp;it&nbsp;just&nbsp;has&nbsp;its&nbsp;address</span><br>
<span class="lineno"></span><span class="comment" id="1644644">//&nbsp;taken&nbsp;so&nbsp;it&nbsp;can&nbsp;be&nbsp;matched&nbsp;against&nbsp;pending&nbsp;defers.</span><br>
<span class="lineno"></span><span class="comment" id="1644698">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1644711">func</span>&nbsp;<span class="ident" id="1644716">deferreturn</span><span class="op" id="1644727">(</span><span class="ident" id="1644728">arg0</span>&nbsp;<span class="builtintype" id="1644733">uintptr</span><span class="op" id="1644740">)</span>&nbsp;<span class="op" id="1644742">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1644745">gp</span>&nbsp;<span class="op" id="1644748">:=</span>&nbsp;<span class="ident" id="1644751">getg</span><span class="op" id="1644755">(</span><span class="op" id="1644756">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1644759">d</span>&nbsp;<span class="op" id="1644761">:=</span>&nbsp;<span class="ident" id="1644764">gp</span><span class="op" id="1644766">.</span><span class="ident" id="1644767">_defer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1644775">if</span>&nbsp;<span class="ident" id="1644778">d</span>&nbsp;<span class="op" id="1644780">==</span>&nbsp;<span class="ident" id="1644783">nil</span>&nbsp;<span class="op" id="1644787">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1644791">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1644799">}</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1644802">argp</span>&nbsp;<span class="op" id="1644807">:=</span>&nbsp;<span class="builtintype" id="1644810">uintptr</span><span class="op" id="1644817">(</span><span class="ident" id="1644818">unsafe</span><span class="op" id="1644824">.</span><span class="ident" id="1644825">Pointer</span><span class="op" id="1644832">(</span><span class="op" id="1644833">&amp;</span><span class="ident" id="1644834">arg0</span><span class="op" id="1644838">)</span><span class="op" id="1644839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1644842">if</span>&nbsp;<span class="ident" id="1644845">d</span><span class="op" id="1644846">.</span><span class="ident" id="1644847">argp</span>&nbsp;<span class="op" id="1644852">!=</span>&nbsp;<span class="ident" id="1644855">argp</span>&nbsp;<span class="op" id="1644860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1644864">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1644872">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1644876">//&nbsp;Moving&nbsp;arguments&nbsp;around.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1644905">//&nbsp;Do&nbsp;not&nbsp;allow&nbsp;preemption&nbsp;here,&nbsp;because&nbsp;the&nbsp;garbage&nbsp;collector</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1644969">//&nbsp;won&#39;t&nbsp;know&nbsp;the&nbsp;form&nbsp;of&nbsp;the&nbsp;arguments&nbsp;until&nbsp;the&nbsp;jmpdefer&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1645033">//&nbsp;flip&nbsp;the&nbsp;PC&nbsp;over&nbsp;to&nbsp;fn.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1645061">mp</span>&nbsp;<span class="op" id="1645064">:=</span>&nbsp;<span class="ident" id="1645067">acquirem</span><span class="op" id="1645075">(</span><span class="op" id="1645076">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1645079">memmove</span><span class="op" id="1645086">(</span><span class="ident" id="1645087">unsafe</span><span class="op" id="1645093">.</span><span class="ident" id="1645094">Pointer</span><span class="op" id="1645101">(</span><span class="ident" id="1645102">argp</span><span class="op" id="1645106">)</span><span class="op" id="1645107">,</span>&nbsp;<span class="ident" id="1645109">deferArgs</span><span class="op" id="1645118">(</span><span class="ident" id="1645119">d</span><span class="op" id="1645120">)</span><span class="op" id="1645121">,</span>&nbsp;<span class="builtintype" id="1645123">uintptr</span><span class="op" id="1645130">(</span><span class="ident" id="1645131">d</span><span class="op" id="1645132">.</span><span class="ident" id="1645133">siz</span><span class="op" id="1645136">)</span><span class="op" id="1645137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1645140">fn</span>&nbsp;<span class="op" id="1645143">:=</span>&nbsp;<span class="ident" id="1645146">d</span><span class="op" id="1645147">.</span><span class="ident" id="1645148">fn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1645152">d</span><span class="op" id="1645153">.</span><span class="ident" id="1645154">fn</span>&nbsp;<span class="op" id="1645157">=</span>&nbsp;<span class="ident" id="1645159">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1645164">gp</span><span class="op" id="1645166">.</span><span class="ident" id="1645167">_defer</span>&nbsp;<span class="op" id="1645174">=</span>&nbsp;<span class="ident" id="1645176">d</span><span class="op" id="1645177">.</span><span class="ident" id="1645178">link</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1645184">freedefer</span><span class="op" id="1645193">(</span><span class="ident" id="1645194">d</span><span class="op" id="1645195">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1645198">releasem</span><span class="op" id="1645206">(</span><span class="ident" id="1645207">mp</span><span class="op" id="1645209">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1645212">jmpdefer</span><span class="op" id="1645220">(</span><span class="ident" id="1645221">fn</span><span class="op" id="1645223">,</span>&nbsp;<span class="ident" id="1645225">argp</span><span class="op" id="1645229">)</span><br>
<span class="lineno"></span><span class="op" id="1645231">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1645234">//&nbsp;Goexit&nbsp;terminates&nbsp;the&nbsp;goroutine&nbsp;that&nbsp;calls&nbsp;it.&nbsp;&nbsp;No&nbsp;other&nbsp;goroutine&nbsp;is&nbsp;affected.</span><br>
<span class="lineno">260</span><span class="comment" id="1645317">//&nbsp;Goexit&nbsp;runs&nbsp;all&nbsp;deferred&nbsp;calls&nbsp;before&nbsp;terminating&nbsp;the&nbsp;goroutine.&nbsp;&nbsp;Because&nbsp;Goexit</span><br>
<span class="lineno"></span><span class="comment" id="1645401">//&nbsp;is&nbsp;not&nbsp;panic,&nbsp;however,&nbsp;any&nbsp;recover&nbsp;calls&nbsp;in&nbsp;those&nbsp;deferred&nbsp;functions&nbsp;will&nbsp;return&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="1645490">//</span><br>
<span class="lineno"></span><span class="comment" id="1645493">//&nbsp;Calling&nbsp;Goexit&nbsp;from&nbsp;the&nbsp;main&nbsp;goroutine&nbsp;terminates&nbsp;that&nbsp;goroutine</span><br>
<span class="lineno"></span><span class="comment" id="1645561">//&nbsp;without&nbsp;func&nbsp;main&nbsp;returning.&nbsp;Since&nbsp;func&nbsp;main&nbsp;has&nbsp;not&nbsp;returned,</span><br>
<span class="lineno">265</span><span class="comment" id="1645627">//&nbsp;the&nbsp;program&nbsp;continues&nbsp;execution&nbsp;of&nbsp;other&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="comment" id="1645683">//&nbsp;If&nbsp;all&nbsp;other&nbsp;goroutines&nbsp;exit,&nbsp;the&nbsp;program&nbsp;crashes.</span><br>
<span class="lineno"></span><span class="keyword" id="1645737">func</span>&nbsp;<span class="ident" id="1645742">Goexit</span><span class="op" id="1645748">(</span><span class="op" id="1645749">)</span>&nbsp;<span class="op" id="1645751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1645754">//&nbsp;Run&nbsp;all&nbsp;deferred&nbsp;functions&nbsp;for&nbsp;the&nbsp;current&nbsp;goroutine.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1645812">//&nbsp;This&nbsp;code&nbsp;is&nbsp;similar&nbsp;to&nbsp;gopanic,&nbsp;see&nbsp;that&nbsp;implementation</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1645873">//&nbsp;for&nbsp;detailed&nbsp;comments.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1645900">gp</span>&nbsp;<span class="op" id="1645903">:=</span>&nbsp;<span class="ident" id="1645906">getg</span><span class="op" id="1645910">(</span><span class="op" id="1645911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1645914">for</span>&nbsp;<span class="op" id="1645918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1645922">d</span>&nbsp;<span class="op" id="1645924">:=</span>&nbsp;<span class="ident" id="1645927">gp</span><span class="op" id="1645929">.</span><span class="ident" id="1645930">_defer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1645939">if</span>&nbsp;<span class="ident" id="1645942">d</span>&nbsp;<span class="op" id="1645944">==</span>&nbsp;<span class="ident" id="1645947">nil</span>&nbsp;<span class="op" id="1645951">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1645956">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1645964">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1645968">if</span>&nbsp;<span class="ident" id="1645971">d</span><span class="op" id="1645972">.</span><span class="ident" id="1645973">started</span>&nbsp;<span class="op" id="1645981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1645986">if</span>&nbsp;<span class="ident" id="1645989">d</span><span class="op" id="1645990">.</span><span class="ident" id="1645991">_panic</span>&nbsp;<span class="op" id="1645998">!=</span>&nbsp;<span class="ident" id="1646001">nil</span>&nbsp;<span class="op" id="1646005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1646011">d</span><span class="op" id="1646012">.</span><span class="ident" id="1646013">_panic</span><span class="op" id="1646019">.</span><span class="ident" id="1646020">aborted</span>&nbsp;<span class="op" id="1646028">=</span>&nbsp;<span class="ident" id="1646030">true</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1646039">d</span><span class="op" id="1646040">.</span><span class="ident" id="1646041">_panic</span>&nbsp;<span class="op" id="1646048">=</span>&nbsp;<span class="ident" id="1646050">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1646057">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1646062">d</span><span class="op" id="1646063">.</span><span class="ident" id="1646064">fn</span>&nbsp;<span class="op" id="1646067">=</span>&nbsp;<span class="ident" id="1646069">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1646076">gp</span><span class="op" id="1646078">.</span><span class="ident" id="1646079">_defer</span>&nbsp;<span class="op" id="1646086">=</span>&nbsp;<span class="ident" id="1646088">d</span><span class="op" id="1646089">.</span><span class="ident" id="1646090">link</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1646098">freedefer</span><span class="op" id="1646107">(</span><span class="ident" id="1646108">d</span><span class="op" id="1646109">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1646114">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1646125">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1646129">d</span><span class="op" id="1646130">.</span><span class="ident" id="1646131">started</span>&nbsp;<span class="op" id="1646139">=</span>&nbsp;<span class="ident" id="1646141">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1646148">reflectcall</span><span class="op" id="1646159">(</span><span class="ident" id="1646160">unsafe</span><span class="op" id="1646166">.</span><span class="ident" id="1646167">Pointer</span><span class="op" id="1646174">(</span><span class="ident" id="1646175">d</span><span class="op" id="1646176">.</span><span class="ident" id="1646177">fn</span><span class="op" id="1646179">)</span><span class="op" id="1646180">,</span>&nbsp;<span class="ident" id="1646182">deferArgs</span><span class="op" id="1646191">(</span><span class="ident" id="1646192">d</span><span class="op" id="1646193">)</span><span class="op" id="1646194">,</span>&nbsp;<span class="builtintype" id="1646196">uint32</span><span class="op" id="1646202">(</span><span class="ident" id="1646203">d</span><span class="op" id="1646204">.</span><span class="ident" id="1646205">siz</span><span class="op" id="1646208">)</span><span class="op" id="1646209">,</span>&nbsp;<span class="builtintype" id="1646211">uint32</span><span class="op" id="1646217">(</span><span class="ident" id="1646218">d</span><span class="op" id="1646219">.</span><span class="ident" id="1646220">siz</span><span class="op" id="1646223">)</span><span class="op" id="1646224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1646228">if</span>&nbsp;<span class="ident" id="1646231">gp</span><span class="op" id="1646233">.</span><span class="ident" id="1646234">_defer</span>&nbsp;<span class="op" id="1646241">!=</span>&nbsp;<span class="ident" id="1646244">d</span>&nbsp;<span class="op" id="1646246">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1646251">gothrow</span><span class="op" id="1646258">(</span><span class="string" id="1646259">&#34;bad&nbsp;defer&nbsp;entry&nbsp;in&nbsp;Goexit&#34;</span><span class="op" id="1646286">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1646290">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1646294">d</span><span class="op" id="1646295">.</span><span class="ident" id="1646296">_panic</span>&nbsp;<span class="op" id="1646303">=</span>&nbsp;<span class="ident" id="1646305">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1646311">d</span><span class="op" id="1646312">.</span><span class="ident" id="1646313">fn</span>&nbsp;<span class="op" id="1646316">=</span>&nbsp;<span class="ident" id="1646318">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1646324">gp</span><span class="op" id="1646326">.</span><span class="ident" id="1646327">_defer</span>&nbsp;<span class="op" id="1646334">=</span>&nbsp;<span class="ident" id="1646336">d</span><span class="op" id="1646337">.</span><span class="ident" id="1646338">link</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1646345">freedefer</span><span class="op" id="1646354">(</span><span class="ident" id="1646355">d</span><span class="op" id="1646356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1646360">//&nbsp;Note:&nbsp;we&nbsp;ignore&nbsp;recovers&nbsp;here&nbsp;because&nbsp;Goexit&nbsp;isn&#39;t&nbsp;a&nbsp;panic</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1646423">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1646426">goexit</span><span class="op" id="1646432">(</span><span class="op" id="1646433">)</span><br>
<span class="lineno"></span><span class="op" id="1646435">}</span><br>
<span class="lineno">300</span><br>
<span class="lineno"></span><span class="keyword" id="1646438">func</span>&nbsp;<span class="ident" id="1646443">canpanic</span><span class="op" id="1646451">(</span><span class="op" id="1646452">*</span><span class="ident" id="1646453">g</span><span class="op" id="1646454">)</span>&nbsp;<span class="builtintype" id="1646456">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1646462">//&nbsp;Print&nbsp;all&nbsp;currently&nbsp;active&nbsp;panics.&nbsp;&nbsp;Used&nbsp;when&nbsp;crashing.</span><br>
<span class="lineno"></span><span class="keyword" id="1646521">func</span>&nbsp;<span class="ident" id="1646526">printpanics</span><span class="op" id="1646537">(</span><span class="ident" id="1646538">p</span>&nbsp;<span class="op" id="1646540">*</span><span class="ident" id="1646541">_panic</span><span class="op" id="1646547">)</span>&nbsp;<span class="op" id="1646549">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1646552">if</span>&nbsp;<span class="ident" id="1646555">p</span><span class="op" id="1646556">.</span><span class="ident" id="1646557">link</span>&nbsp;<span class="op" id="1646562">!=</span>&nbsp;<span class="ident" id="1646565">nil</span>&nbsp;<span class="op" id="1646569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1646573">printpanics</span><span class="op" id="1646584">(</span><span class="ident" id="1646585">p</span><span class="op" id="1646586">.</span><span class="ident" id="1646587">link</span><span class="op" id="1646591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1646595">print</span><span class="op" id="1646600">(</span><span class="string" id="1646601">&#34;\t&#34;</span><span class="op" id="1646605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1646608">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1646611">print</span><span class="op" id="1646616">(</span><span class="string" id="1646617">&#34;panic:&nbsp;&#34;</span><span class="op" id="1646626">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1646629">printany</span><span class="op" id="1646637">(</span><span class="ident" id="1646638">p</span><span class="op" id="1646639">.</span><span class="ident" id="1646640">arg</span><span class="op" id="1646643">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1646646">if</span>&nbsp;<span class="ident" id="1646649">p</span><span class="op" id="1646650">.</span><span class="ident" id="1646651">recovered</span>&nbsp;<span class="op" id="1646661">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1646665">print</span><span class="op" id="1646670">(</span><span class="string" id="1646671">&#34;&nbsp;[recovered]&#34;</span><span class="op" id="1646685">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1646688">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1646691">print</span><span class="op" id="1646696">(</span><span class="string" id="1646697">&#34;\n&#34;</span><span class="op" id="1646701">)</span><br>
<span class="lineno">315</span><span class="op" id="1646703">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1646706">//&nbsp;The&nbsp;implementation&nbsp;of&nbsp;the&nbsp;predeclared&nbsp;function&nbsp;panic.</span><br>
<span class="lineno"></span><span class="keyword" id="1646763">func</span>&nbsp;<span class="ident" id="1646768">gopanic</span><span class="op" id="1646775">(</span><span class="ident" id="1646776">e</span>&nbsp;<span class="keyword" id="1646778">interface</span><span class="op" id="1646787">{</span><span class="op" id="1646788">}</span><span class="op" id="1646789">)</span>&nbsp;<span class="op" id="1646791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1646794">gp</span>&nbsp;<span class="op" id="1646797">:=</span>&nbsp;<span class="ident" id="1646800">getg</span><span class="op" id="1646804">(</span><span class="op" id="1646805">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1646808">if</span>&nbsp;<span class="ident" id="1646811">gp</span><span class="op" id="1646813">.</span><span class="ident" id="1646814">m</span><span class="op" id="1646815">.</span><span class="ident" id="1646816">curg</span>&nbsp;<span class="op" id="1646821">!=</span>&nbsp;<span class="ident" id="1646824">gp</span>&nbsp;<span class="op" id="1646827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1646831">gothrow</span><span class="op" id="1646838">(</span><span class="string" id="1646839">&#34;panic&nbsp;on&nbsp;m&nbsp;stack&#34;</span><span class="op" id="1646857">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1646860">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1646864">//&nbsp;m.softfloat&nbsp;is&nbsp;set&nbsp;during&nbsp;software&nbsp;floating&nbsp;point.</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1646919">//&nbsp;It&nbsp;increments&nbsp;m.locks&nbsp;to&nbsp;avoid&nbsp;preemption.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1646966">//&nbsp;We&nbsp;moved&nbsp;the&nbsp;memory&nbsp;loads&nbsp;out,&nbsp;so&nbsp;there&nbsp;shouldn&#39;t&nbsp;be</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1647023">//&nbsp;any&nbsp;reason&nbsp;for&nbsp;it&nbsp;to&nbsp;panic&nbsp;anymore.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1647063">if</span>&nbsp;<span class="ident" id="1647066">gp</span><span class="op" id="1647068">.</span><span class="ident" id="1647069">m</span><span class="op" id="1647070">.</span><span class="ident" id="1647071">softfloat</span>&nbsp;<span class="op" id="1647081">!=</span>&nbsp;<span class="num" id="1647084">0</span>&nbsp;<span class="op" id="1647086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1647090">gp</span><span class="op" id="1647092">.</span><span class="ident" id="1647093">m</span><span class="op" id="1647094">.</span><span class="ident" id="1647095">locks</span><span class="op" id="1647100">--</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1647105">gp</span><span class="op" id="1647107">.</span><span class="ident" id="1647108">m</span><span class="op" id="1647109">.</span><span class="ident" id="1647110">softfloat</span>&nbsp;<span class="op" id="1647120">=</span>&nbsp;<span class="num" id="1647122">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1647126">gothrow</span><span class="op" id="1647133">(</span><span class="string" id="1647134">&#34;panic&nbsp;during&nbsp;softfloat&#34;</span><span class="op" id="1647158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1647161">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1647164">if</span>&nbsp;<span class="ident" id="1647167">gp</span><span class="op" id="1647169">.</span><span class="ident" id="1647170">m</span><span class="op" id="1647171">.</span><span class="ident" id="1647172">mallocing</span>&nbsp;<span class="op" id="1647182">!=</span>&nbsp;<span class="num" id="1647185">0</span>&nbsp;<span class="op" id="1647187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1647191">print</span><span class="op" id="1647196">(</span><span class="string" id="1647197">&#34;panic:&nbsp;&#34;</span><span class="op" id="1647206">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1647210">printany</span><span class="op" id="1647218">(</span><span class="ident" id="1647219">e</span><span class="op" id="1647220">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1647224">print</span><span class="op" id="1647229">(</span><span class="string" id="1647230">&#34;\n&#34;</span><span class="op" id="1647234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1647238">gothrow</span><span class="op" id="1647245">(</span><span class="string" id="1647246">&#34;panic&nbsp;during&nbsp;malloc&#34;</span><span class="op" id="1647267">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1647270">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1647273">if</span>&nbsp;<span class="ident" id="1647276">gp</span><span class="op" id="1647278">.</span><span class="ident" id="1647279">m</span><span class="op" id="1647280">.</span><span class="ident" id="1647281">gcing</span>&nbsp;<span class="op" id="1647287">!=</span>&nbsp;<span class="num" id="1647290">0</span>&nbsp;<span class="op" id="1647292">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1647296">print</span><span class="op" id="1647301">(</span><span class="string" id="1647302">&#34;panic:&nbsp;&#34;</span><span class="op" id="1647311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1647315">printany</span><span class="op" id="1647323">(</span><span class="ident" id="1647324">e</span><span class="op" id="1647325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1647329">print</span><span class="op" id="1647334">(</span><span class="string" id="1647335">&#34;\n&#34;</span><span class="op" id="1647339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1647343">gothrow</span><span class="op" id="1647350">(</span><span class="string" id="1647351">&#34;panic&nbsp;during&nbsp;gc&#34;</span><span class="op" id="1647368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1647371">}</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1647374">if</span>&nbsp;<span class="ident" id="1647377">gp</span><span class="op" id="1647379">.</span><span class="ident" id="1647380">m</span><span class="op" id="1647381">.</span><span class="ident" id="1647382">locks</span>&nbsp;<span class="op" id="1647388">!=</span>&nbsp;<span class="num" id="1647391">0</span>&nbsp;<span class="op" id="1647393">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1647397">print</span><span class="op" id="1647402">(</span><span class="string" id="1647403">&#34;panic:&nbsp;&#34;</span><span class="op" id="1647412">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1647416">printany</span><span class="op" id="1647424">(</span><span class="ident" id="1647425">e</span><span class="op" id="1647426">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1647430">print</span><span class="op" id="1647435">(</span><span class="string" id="1647436">&#34;\n&#34;</span><span class="op" id="1647440">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1647444">gothrow</span><span class="op" id="1647451">(</span><span class="string" id="1647452">&#34;panic&nbsp;holding&nbsp;locks&#34;</span><span class="op" id="1647473">)</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1647476">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1647480">var</span>&nbsp;<span class="ident" id="1647484">p</span>&nbsp;<span class="ident" id="1647486">_panic</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1647494">p</span><span class="op" id="1647495">.</span><span class="ident" id="1647496">arg</span>&nbsp;<span class="op" id="1647500">=</span>&nbsp;<span class="ident" id="1647502">e</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1647505">p</span><span class="op" id="1647506">.</span><span class="ident" id="1647507">link</span>&nbsp;<span class="op" id="1647512">=</span>&nbsp;<span class="ident" id="1647514">gp</span><span class="op" id="1647516">.</span><span class="ident" id="1647517">_panic</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1647525">gp</span><span class="op" id="1647527">.</span><span class="ident" id="1647528">_panic</span>&nbsp;<span class="op" id="1647535">=</span>&nbsp;<span class="op" id="1647537">(</span><span class="op" id="1647538">*</span><span class="ident" id="1647539">_panic</span><span class="op" id="1647545">)</span><span class="op" id="1647546">(</span><span class="ident" id="1647547">noescape</span><span class="op" id="1647555">(</span><span class="ident" id="1647556">unsafe</span><span class="op" id="1647562">.</span><span class="ident" id="1647563">Pointer</span><span class="op" id="1647570">(</span><span class="op" id="1647571">&amp;</span><span class="ident" id="1647572">p</span><span class="op" id="1647573">)</span><span class="op" id="1647574">)</span><span class="op" id="1647575">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1647579">for</span>&nbsp;<span class="op" id="1647583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1647587">d</span>&nbsp;<span class="op" id="1647589">:=</span>&nbsp;<span class="ident" id="1647592">gp</span><span class="op" id="1647594">.</span><span class="ident" id="1647595">_defer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1647604">if</span>&nbsp;<span class="ident" id="1647607">d</span>&nbsp;<span class="op" id="1647609">==</span>&nbsp;<span class="ident" id="1647612">nil</span>&nbsp;<span class="op" id="1647616">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1647621">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1647629">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1647634">//&nbsp;If&nbsp;defer&nbsp;was&nbsp;started&nbsp;by&nbsp;earlier&nbsp;panic&nbsp;or&nbsp;Goexit&nbsp;(and,&nbsp;since&nbsp;we&#39;re&nbsp;back&nbsp;here,&nbsp;that&nbsp;triggered&nbsp;a&nbsp;new&nbsp;panic),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1647745">//&nbsp;take&nbsp;defer&nbsp;off&nbsp;list.&nbsp;The&nbsp;earlier&nbsp;panic&nbsp;or&nbsp;Goexit&nbsp;will&nbsp;not&nbsp;continue&nbsp;running.</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1647826">if</span>&nbsp;<span class="ident" id="1647829">d</span><span class="op" id="1647830">.</span><span class="ident" id="1647831">started</span>&nbsp;<span class="op" id="1647839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1647844">if</span>&nbsp;<span class="ident" id="1647847">d</span><span class="op" id="1647848">.</span><span class="ident" id="1647849">_panic</span>&nbsp;<span class="op" id="1647856">!=</span>&nbsp;<span class="ident" id="1647859">nil</span>&nbsp;<span class="op" id="1647863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1647869">d</span><span class="op" id="1647870">.</span><span class="ident" id="1647871">_panic</span><span class="op" id="1647877">.</span><span class="ident" id="1647878">aborted</span>&nbsp;<span class="op" id="1647886">=</span>&nbsp;<span class="ident" id="1647888">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1647896">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1647901">d</span><span class="op" id="1647902">.</span><span class="ident" id="1647903">_panic</span>&nbsp;<span class="op" id="1647910">=</span>&nbsp;<span class="ident" id="1647912">nil</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1647919">d</span><span class="op" id="1647920">.</span><span class="ident" id="1647921">fn</span>&nbsp;<span class="op" id="1647924">=</span>&nbsp;<span class="ident" id="1647926">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1647933">gp</span><span class="op" id="1647935">.</span><span class="ident" id="1647936">_defer</span>&nbsp;<span class="op" id="1647943">=</span>&nbsp;<span class="ident" id="1647945">d</span><span class="op" id="1647946">.</span><span class="ident" id="1647947">link</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1647955">freedefer</span><span class="op" id="1647964">(</span><span class="ident" id="1647965">d</span><span class="op" id="1647966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1647971">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1647982">}</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1647987">//&nbsp;Mark&nbsp;defer&nbsp;as&nbsp;started,&nbsp;but&nbsp;keep&nbsp;on&nbsp;list,&nbsp;so&nbsp;that&nbsp;traceback</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1648051">//&nbsp;can&nbsp;find&nbsp;and&nbsp;update&nbsp;the&nbsp;defer&#39;s&nbsp;argument&nbsp;frame&nbsp;if&nbsp;stack&nbsp;growth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1648119">//&nbsp;or&nbsp;a&nbsp;garbage&nbsp;collection&nbsp;hapens&nbsp;before&nbsp;reflectcall&nbsp;starts&nbsp;executing&nbsp;d.fn.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1648197">d</span><span class="op" id="1648198">.</span><span class="ident" id="1648199">started</span>&nbsp;<span class="op" id="1648207">=</span>&nbsp;<span class="ident" id="1648209">true</span><br>
<span class="lineno">380</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1648217">//&nbsp;Record&nbsp;the&nbsp;panic&nbsp;that&nbsp;is&nbsp;running&nbsp;the&nbsp;defer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1648266">//&nbsp;If&nbsp;there&nbsp;is&nbsp;a&nbsp;new&nbsp;panic&nbsp;during&nbsp;the&nbsp;deferred&nbsp;call,&nbsp;that&nbsp;panic</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1648332">//&nbsp;will&nbsp;find&nbsp;d&nbsp;in&nbsp;the&nbsp;list&nbsp;and&nbsp;will&nbsp;mark&nbsp;d._panic&nbsp;(this&nbsp;panic)&nbsp;aborted.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1648406">d</span><span class="op" id="1648407">.</span><span class="ident" id="1648408">_panic</span>&nbsp;<span class="op" id="1648415">=</span>&nbsp;<span class="op" id="1648417">(</span><span class="op" id="1648418">*</span><span class="ident" id="1648419">_panic</span><span class="op" id="1648425">)</span><span class="op" id="1648426">(</span><span class="ident" id="1648427">noescape</span><span class="op" id="1648435">(</span><span class="op" id="1648436">(</span><span class="ident" id="1648437">unsafe</span><span class="op" id="1648443">.</span><span class="ident" id="1648444">Pointer</span><span class="op" id="1648451">)</span><span class="op" id="1648452">(</span><span class="op" id="1648453">&amp;</span><span class="ident" id="1648454">p</span><span class="op" id="1648455">)</span><span class="op" id="1648456">)</span><span class="op" id="1648457">)</span><br>
<span class="lineno">385</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1648462">p</span><span class="op" id="1648463">.</span><span class="ident" id="1648464">argp</span>&nbsp;<span class="op" id="1648469">=</span>&nbsp;<span class="ident" id="1648471">unsafe</span><span class="op" id="1648477">.</span><span class="ident" id="1648478">Pointer</span><span class="op" id="1648485">(</span><span class="ident" id="1648486">getargp</span><span class="op" id="1648493">(</span><span class="num" id="1648494">0</span><span class="op" id="1648495">)</span><span class="op" id="1648496">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1648500">reflectcall</span><span class="op" id="1648511">(</span><span class="ident" id="1648512">unsafe</span><span class="op" id="1648518">.</span><span class="ident" id="1648519">Pointer</span><span class="op" id="1648526">(</span><span class="ident" id="1648527">d</span><span class="op" id="1648528">.</span><span class="ident" id="1648529">fn</span><span class="op" id="1648531">)</span><span class="op" id="1648532">,</span>&nbsp;<span class="ident" id="1648534">deferArgs</span><span class="op" id="1648543">(</span><span class="ident" id="1648544">d</span><span class="op" id="1648545">)</span><span class="op" id="1648546">,</span>&nbsp;<span class="builtintype" id="1648548">uint32</span><span class="op" id="1648554">(</span><span class="ident" id="1648555">d</span><span class="op" id="1648556">.</span><span class="ident" id="1648557">siz</span><span class="op" id="1648560">)</span><span class="op" id="1648561">,</span>&nbsp;<span class="builtintype" id="1648563">uint32</span><span class="op" id="1648569">(</span><span class="ident" id="1648570">d</span><span class="op" id="1648571">.</span><span class="ident" id="1648572">siz</span><span class="op" id="1648575">)</span><span class="op" id="1648576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1648580">p</span><span class="op" id="1648581">.</span><span class="ident" id="1648582">argp</span>&nbsp;<span class="op" id="1648587">=</span>&nbsp;<span class="ident" id="1648589">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1648596">//&nbsp;reflectcall&nbsp;did&nbsp;not&nbsp;panic.&nbsp;Remove&nbsp;d.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1648638">if</span>&nbsp;<span class="ident" id="1648641">gp</span><span class="op" id="1648643">.</span><span class="ident" id="1648644">_defer</span>&nbsp;<span class="op" id="1648651">!=</span>&nbsp;<span class="ident" id="1648654">d</span>&nbsp;<span class="op" id="1648656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1648661">gothrow</span><span class="op" id="1648668">(</span><span class="string" id="1648669">&#34;bad&nbsp;defer&nbsp;entry&nbsp;in&nbsp;panic&#34;</span><span class="op" id="1648695">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1648699">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1648703">d</span><span class="op" id="1648704">.</span><span class="ident" id="1648705">_panic</span>&nbsp;<span class="op" id="1648712">=</span>&nbsp;<span class="ident" id="1648714">nil</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1648720">d</span><span class="op" id="1648721">.</span><span class="ident" id="1648722">fn</span>&nbsp;<span class="op" id="1648725">=</span>&nbsp;<span class="ident" id="1648727">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1648733">gp</span><span class="op" id="1648735">.</span><span class="ident" id="1648736">_defer</span>&nbsp;<span class="op" id="1648743">=</span>&nbsp;<span class="ident" id="1648745">d</span><span class="op" id="1648746">.</span><span class="ident" id="1648747">link</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1648755">//&nbsp;trigger&nbsp;shrinkage&nbsp;to&nbsp;test&nbsp;stack&nbsp;copy.&nbsp;&nbsp;See&nbsp;stack_test.go:TestStackPanic</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1648832">//GC()</span><br>
<span class="lineno">400</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1648842">pc</span>&nbsp;<span class="op" id="1648845">:=</span>&nbsp;<span class="ident" id="1648848">d</span><span class="op" id="1648849">.</span><span class="ident" id="1648850">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1648855">argp</span>&nbsp;<span class="op" id="1648860">:=</span>&nbsp;<span class="ident" id="1648863">unsafe</span><span class="op" id="1648869">.</span><span class="ident" id="1648870">Pointer</span><span class="op" id="1648877">(</span><span class="ident" id="1648878">d</span><span class="op" id="1648879">.</span><span class="ident" id="1648880">argp</span><span class="op" id="1648884">)</span>&nbsp;<span class="comment" id="1648886">//&nbsp;must&nbsp;be&nbsp;pointer&nbsp;so&nbsp;it&nbsp;gets&nbsp;adjusted&nbsp;during&nbsp;stack&nbsp;copy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1648945">freedefer</span><span class="op" id="1648954">(</span><span class="ident" id="1648955">d</span><span class="op" id="1648956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1648960">if</span>&nbsp;<span class="ident" id="1648963">p</span><span class="op" id="1648964">.</span><span class="ident" id="1648965">recovered</span>&nbsp;<span class="op" id="1648975">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1648980">gp</span><span class="op" id="1648982">.</span><span class="ident" id="1648983">_panic</span>&nbsp;<span class="op" id="1648990">=</span>&nbsp;<span class="ident" id="1648992">p</span><span class="op" id="1648993">.</span><span class="ident" id="1648994">link</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1649002">//&nbsp;Aborted&nbsp;panics&nbsp;are&nbsp;marked&nbsp;but&nbsp;remain&nbsp;on&nbsp;the&nbsp;g.panic&nbsp;list.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1649066">//&nbsp;Remove&nbsp;them&nbsp;from&nbsp;the&nbsp;list.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1649099">for</span>&nbsp;<span class="ident" id="1649103">gp</span><span class="op" id="1649105">.</span><span class="ident" id="1649106">_panic</span>&nbsp;<span class="op" id="1649113">!=</span>&nbsp;<span class="ident" id="1649116">nil</span>&nbsp;<span class="op" id="1649120">&amp;&amp;</span>&nbsp;<span class="ident" id="1649123">gp</span><span class="op" id="1649125">.</span><span class="ident" id="1649126">_panic</span><span class="op" id="1649132">.</span><span class="ident" id="1649133">aborted</span>&nbsp;<span class="op" id="1649141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1649147">gp</span><span class="op" id="1649149">.</span><span class="ident" id="1649150">_panic</span>&nbsp;<span class="op" id="1649157">=</span>&nbsp;<span class="ident" id="1649159">gp</span><span class="op" id="1649161">.</span><span class="ident" id="1649162">_panic</span><span class="op" id="1649168">.</span><span class="ident" id="1649169">link</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1649177">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1649182">if</span>&nbsp;<span class="ident" id="1649185">gp</span><span class="op" id="1649187">.</span><span class="ident" id="1649188">_panic</span>&nbsp;<span class="op" id="1649195">==</span>&nbsp;<span class="ident" id="1649198">nil</span>&nbsp;<span class="op" id="1649202">{</span>&nbsp;<span class="comment" id="1649204">//&nbsp;must&nbsp;be&nbsp;done&nbsp;with&nbsp;signal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1649236">gp</span><span class="op" id="1649238">.</span><span class="ident" id="1649239">sig</span>&nbsp;<span class="op" id="1649243">=</span>&nbsp;<span class="num" id="1649245">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1649250">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1649255">//&nbsp;Pass&nbsp;information&nbsp;about&nbsp;recovering&nbsp;frame&nbsp;to&nbsp;recovery.</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1649314">gp</span><span class="op" id="1649316">.</span><span class="ident" id="1649317">sigcode0</span>&nbsp;<span class="op" id="1649326">=</span>&nbsp;<span class="builtintype" id="1649328">uintptr</span><span class="op" id="1649335">(</span><span class="ident" id="1649336">argp</span><span class="op" id="1649340">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1649345">gp</span><span class="op" id="1649347">.</span><span class="ident" id="1649348">sigcode1</span>&nbsp;<span class="op" id="1649357">=</span>&nbsp;<span class="ident" id="1649359">pc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1649365">mcall</span><span class="op" id="1649370">(</span><span class="ident" id="1649371">recovery_m</span><span class="op" id="1649381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1649386">gothrow</span><span class="op" id="1649393">(</span><span class="string" id="1649394">&#34;recovery&nbsp;failed&#34;</span><span class="op" id="1649411">)</span>&nbsp;<span class="comment" id="1649413">//&nbsp;mcall&nbsp;should&nbsp;not&nbsp;return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1649442">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1649445">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1649449">//&nbsp;ran&nbsp;out&nbsp;of&nbsp;deferred&nbsp;calls&nbsp;-&nbsp;old-school&nbsp;panic&nbsp;now</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1649502">startpanic</span><span class="op" id="1649512">(</span><span class="op" id="1649513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1649516">printpanics</span><span class="op" id="1649527">(</span><span class="ident" id="1649528">gp</span><span class="op" id="1649530">.</span><span class="ident" id="1649531">_panic</span><span class="op" id="1649537">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1649540">dopanic</span><span class="op" id="1649547">(</span><span class="num" id="1649548">0</span><span class="op" id="1649549">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1649557">//&nbsp;should&nbsp;not&nbsp;return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1649579">*</span><span class="op" id="1649580">(</span><span class="op" id="1649581">*</span><span class="builtintype" id="1649582">int</span><span class="op" id="1649585">)</span><span class="op" id="1649586">(</span><span class="ident" id="1649587">nil</span><span class="op" id="1649590">)</span>&nbsp;<span class="op" id="1649592">=</span>&nbsp;<span class="num" id="1649594">0</span>&nbsp;<span class="comment" id="1649596">//&nbsp;not&nbsp;reached</span><br>
<span class="lineno"></span><span class="op" id="1649611">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1649614">//&nbsp;getargp&nbsp;returns&nbsp;the&nbsp;location&nbsp;where&nbsp;the&nbsp;caller</span><br>
<span class="lineno">430</span><span class="comment" id="1649663">//&nbsp;writes&nbsp;outgoing&nbsp;function&nbsp;call&nbsp;arguments.</span><br>
<span class="lineno"></span><span class="comment" id="1649707">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1649720">func</span>&nbsp;<span class="ident" id="1649725">getargp</span><span class="op" id="1649732">(</span><span class="ident" id="1649733">x</span>&nbsp;<span class="builtintype" id="1649735">int</span><span class="op" id="1649738">)</span>&nbsp;<span class="builtintype" id="1649740">uintptr</span>&nbsp;<span class="op" id="1649748">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1649751">//&nbsp;x&nbsp;is&nbsp;an&nbsp;argument&nbsp;mainly&nbsp;so&nbsp;that&nbsp;we&nbsp;can&nbsp;return&nbsp;its&nbsp;address.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1649814">//&nbsp;However,&nbsp;we&nbsp;need&nbsp;to&nbsp;make&nbsp;the&nbsp;function&nbsp;complex&nbsp;enough</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1649871">//&nbsp;that&nbsp;it&nbsp;won&#39;t&nbsp;be&nbsp;inlined.&nbsp;We&nbsp;always&nbsp;pass&nbsp;x&nbsp;=&nbsp;0,&nbsp;so&nbsp;this&nbsp;code</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1649936">//&nbsp;does&nbsp;nothing&nbsp;other&nbsp;than&nbsp;keep&nbsp;the&nbsp;compiler&nbsp;from&nbsp;thinking</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1649996">//&nbsp;the&nbsp;function&nbsp;is&nbsp;simple&nbsp;enough&nbsp;to&nbsp;inline.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1650041">if</span>&nbsp;<span class="ident" id="1650044">x</span>&nbsp;<span class="op" id="1650046">&gt;</span>&nbsp;<span class="num" id="1650048">0</span>&nbsp;<span class="op" id="1650050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1650054">return</span>&nbsp;<span class="ident" id="1650061">getcallersp</span><span class="op" id="1650072">(</span><span class="ident" id="1650073">unsafe</span><span class="op" id="1650079">.</span><span class="ident" id="1650080">Pointer</span><span class="op" id="1650087">(</span><span class="op" id="1650088">&amp;</span><span class="ident" id="1650089">x</span><span class="op" id="1650090">)</span><span class="op" id="1650091">)</span>&nbsp;<span class="op" id="1650093">*</span>&nbsp;<span class="num" id="1650095">0</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1650098">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1650101">return</span>&nbsp;<span class="builtintype" id="1650108">uintptr</span><span class="op" id="1650115">(</span><span class="ident" id="1650116">noescape</span><span class="op" id="1650124">(</span><span class="ident" id="1650125">unsafe</span><span class="op" id="1650131">.</span><span class="ident" id="1650132">Pointer</span><span class="op" id="1650139">(</span><span class="op" id="1650140">&amp;</span><span class="ident" id="1650141">x</span><span class="op" id="1650142">)</span><span class="op" id="1650143">)</span><span class="op" id="1650144">)</span><br>
<span class="lineno"></span><span class="op" id="1650146">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1650149">//&nbsp;The&nbsp;implementation&nbsp;of&nbsp;the&nbsp;predeclared&nbsp;function&nbsp;recover.</span><br>
<span class="lineno">445</span><span class="comment" id="1650208">//&nbsp;Cannot&nbsp;split&nbsp;the&nbsp;stack&nbsp;because&nbsp;it&nbsp;needs&nbsp;to&nbsp;reliably</span><br>
<span class="lineno"></span><span class="comment" id="1650263">//&nbsp;find&nbsp;the&nbsp;stack&nbsp;segment&nbsp;of&nbsp;its&nbsp;caller.</span><br>
<span class="lineno"></span><span class="comment" id="1650304">//</span><br>
<span class="lineno"></span><span class="comment" id="1650307">//&nbsp;TODO(rsc):&nbsp;Once&nbsp;we&nbsp;commit&nbsp;to&nbsp;CopyStackAlways,</span><br>
<span class="lineno"></span><span class="comment" id="1650356">//&nbsp;this&nbsp;doesn&#39;t&nbsp;need&nbsp;to&nbsp;be&nbsp;nosplit.</span><br>
<span class="lineno">450</span><span class="comment" id="1650392">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1650405">func</span>&nbsp;<span class="ident" id="1650410">gorecover</span><span class="op" id="1650419">(</span><span class="ident" id="1650420">argp</span>&nbsp;<span class="builtintype" id="1650425">uintptr</span><span class="op" id="1650432">)</span>&nbsp;<span class="keyword" id="1650434">interface</span><span class="op" id="1650443">{</span><span class="op" id="1650444">}</span>&nbsp;<span class="op" id="1650446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1650449">//&nbsp;Must&nbsp;be&nbsp;in&nbsp;a&nbsp;function&nbsp;running&nbsp;as&nbsp;part&nbsp;of&nbsp;a&nbsp;deferred&nbsp;call&nbsp;during&nbsp;the&nbsp;panic.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1650528">//&nbsp;Must&nbsp;be&nbsp;called&nbsp;from&nbsp;the&nbsp;topmost&nbsp;function&nbsp;of&nbsp;the&nbsp;call</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1650585">//&nbsp;(the&nbsp;function&nbsp;used&nbsp;in&nbsp;the&nbsp;defer&nbsp;statement).</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1650633">//&nbsp;p.argp&nbsp;is&nbsp;the&nbsp;argument&nbsp;pointer&nbsp;of&nbsp;that&nbsp;topmost&nbsp;deferred&nbsp;function&nbsp;call.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1650708">//&nbsp;Compare&nbsp;against&nbsp;argp&nbsp;reported&nbsp;by&nbsp;caller.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1650753">//&nbsp;If&nbsp;they&nbsp;match,&nbsp;the&nbsp;caller&nbsp;is&nbsp;the&nbsp;one&nbsp;who&nbsp;can&nbsp;recover.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1650811">gp</span>&nbsp;<span class="op" id="1650814">:=</span>&nbsp;<span class="ident" id="1650817">getg</span><span class="op" id="1650821">(</span><span class="op" id="1650822">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1650825">p</span>&nbsp;<span class="op" id="1650827">:=</span>&nbsp;<span class="ident" id="1650830">gp</span><span class="op" id="1650832">.</span><span class="ident" id="1650833">_panic</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1650841">if</span>&nbsp;<span class="ident" id="1650844">p</span>&nbsp;<span class="op" id="1650846">!=</span>&nbsp;<span class="ident" id="1650849">nil</span>&nbsp;<span class="op" id="1650853">&amp;&amp;</span>&nbsp;<span class="op" id="1650856">!</span><span class="ident" id="1650857">p</span><span class="op" id="1650858">.</span><span class="ident" id="1650859">recovered</span>&nbsp;<span class="op" id="1650869">&amp;&amp;</span>&nbsp;<span class="ident" id="1650872">argp</span>&nbsp;<span class="op" id="1650877">==</span>&nbsp;<span class="builtintype" id="1650880">uintptr</span><span class="op" id="1650887">(</span><span class="ident" id="1650888">p</span><span class="op" id="1650889">.</span><span class="ident" id="1650890">argp</span><span class="op" id="1650894">)</span>&nbsp;<span class="op" id="1650896">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1650900">p</span><span class="op" id="1650901">.</span><span class="ident" id="1650902">recovered</span>&nbsp;<span class="op" id="1650912">=</span>&nbsp;<span class="ident" id="1650914">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1650921">return</span>&nbsp;<span class="ident" id="1650928">p</span><span class="op" id="1650929">.</span><span class="ident" id="1650930">arg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1650935">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1650938">return</span>&nbsp;<span class="ident" id="1650945">nil</span><br>
<span class="lineno">465</span><span class="op" id="1650949">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1650952">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1650965">func</span>&nbsp;<span class="ident" id="1650970">startpanic</span><span class="op" id="1650980">(</span><span class="op" id="1650981">)</span>&nbsp;<span class="op" id="1650983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1650986">onM_signalok</span><span class="op" id="1650998">(</span><span class="ident" id="1650999">startpanic_m</span><span class="op" id="1651011">)</span><br>
<span class="lineno">470</span><span class="op" id="1651013">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1651016">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1651029">func</span>&nbsp;<span class="ident" id="1651034">dopanic</span><span class="op" id="1651041">(</span><span class="ident" id="1651042">unused</span>&nbsp;<span class="builtintype" id="1651049">int</span><span class="op" id="1651052">)</span>&nbsp;<span class="op" id="1651054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1651057">gp</span>&nbsp;<span class="op" id="1651060">:=</span>&nbsp;<span class="ident" id="1651063">getg</span><span class="op" id="1651067">(</span><span class="op" id="1651068">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1651071">mp</span>&nbsp;<span class="op" id="1651074">:=</span>&nbsp;<span class="ident" id="1651077">acquirem</span><span class="op" id="1651085">(</span><span class="op" id="1651086">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1651089">mp</span><span class="op" id="1651091">.</span><span class="ident" id="1651092">ptrarg</span><span class="op" id="1651098">[</span><span class="num" id="1651099">0</span><span class="op" id="1651100">]</span>&nbsp;<span class="op" id="1651102">=</span>&nbsp;<span class="ident" id="1651104">unsafe</span><span class="op" id="1651110">.</span><span class="ident" id="1651111">Pointer</span><span class="op" id="1651118">(</span><span class="ident" id="1651119">gp</span><span class="op" id="1651121">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1651124">mp</span><span class="op" id="1651126">.</span><span class="ident" id="1651127">scalararg</span><span class="op" id="1651136">[</span><span class="num" id="1651137">0</span><span class="op" id="1651138">]</span>&nbsp;<span class="op" id="1651140">=</span>&nbsp;<span class="ident" id="1651142">getcallerpc</span><span class="op" id="1651153">(</span><span class="op" id="1651154">(</span><span class="ident" id="1651155">unsafe</span><span class="op" id="1651161">.</span><span class="ident" id="1651162">Pointer</span><span class="op" id="1651169">)</span><span class="op" id="1651170">(</span><span class="op" id="1651171">&amp;</span><span class="ident" id="1651172">unused</span><span class="op" id="1651178">)</span><span class="op" id="1651179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1651182">mp</span><span class="op" id="1651184">.</span><span class="ident" id="1651185">scalararg</span><span class="op" id="1651194">[</span><span class="num" id="1651195">1</span><span class="op" id="1651196">]</span>&nbsp;<span class="op" id="1651198">=</span>&nbsp;<span class="ident" id="1651200">getcallersp</span><span class="op" id="1651211">(</span><span class="op" id="1651212">(</span><span class="ident" id="1651213">unsafe</span><span class="op" id="1651219">.</span><span class="ident" id="1651220">Pointer</span><span class="op" id="1651227">)</span><span class="op" id="1651228">(</span><span class="op" id="1651229">&amp;</span><span class="ident" id="1651230">unused</span><span class="op" id="1651236">)</span><span class="op" id="1651237">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1651240">onM_signalok</span><span class="op" id="1651252">(</span><span class="ident" id="1651253">dopanic_m</span><span class="op" id="1651262">)</span>&nbsp;<span class="comment" id="1651264">//&nbsp;should&nbsp;never&nbsp;return</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1651288">*</span><span class="op" id="1651289">(</span><span class="op" id="1651290">*</span><span class="builtintype" id="1651291">int</span><span class="op" id="1651294">)</span><span class="op" id="1651295">(</span><span class="ident" id="1651296">nil</span><span class="op" id="1651299">)</span>&nbsp;<span class="op" id="1651301">=</span>&nbsp;<span class="num" id="1651303">0</span><br>
<span class="lineno"></span><span class="op" id="1651305">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1651308">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1651321">func</span>&nbsp;<span class="ident" id="1651326">throw</span><span class="op" id="1651331">(</span><span class="ident" id="1651332">s</span>&nbsp;<span class="op" id="1651334">*</span><span class="builtintype" id="1651335">byte</span><span class="op" id="1651339">)</span>&nbsp;<span class="op" id="1651341">{</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1651344">gp</span>&nbsp;<span class="op" id="1651347">:=</span>&nbsp;<span class="ident" id="1651350">getg</span><span class="op" id="1651354">(</span><span class="op" id="1651355">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1651358">if</span>&nbsp;<span class="ident" id="1651361">gp</span><span class="op" id="1651363">.</span><span class="ident" id="1651364">m</span><span class="op" id="1651365">.</span><span class="ident" id="1651366">throwing</span>&nbsp;<span class="op" id="1651375">==</span>&nbsp;<span class="num" id="1651378">0</span>&nbsp;<span class="op" id="1651380">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1651384">gp</span><span class="op" id="1651386">.</span><span class="ident" id="1651387">m</span><span class="op" id="1651388">.</span><span class="ident" id="1651389">throwing</span>&nbsp;<span class="op" id="1651398">=</span>&nbsp;<span class="num" id="1651400">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1651403">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1651406">startpanic</span><span class="op" id="1651416">(</span><span class="op" id="1651417">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1651420">print</span><span class="op" id="1651425">(</span><span class="string" id="1651426">&#34;fatal&nbsp;error:&nbsp;&#34;</span><span class="op" id="1651441">,</span>&nbsp;<span class="ident" id="1651443">gostringnocopy</span><span class="op" id="1651457">(</span><span class="ident" id="1651458">s</span><span class="op" id="1651459">)</span><span class="op" id="1651460">,</span>&nbsp;<span class="string" id="1651462">&#34;\n&#34;</span><span class="op" id="1651466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1651469">dopanic</span><span class="op" id="1651476">(</span><span class="num" id="1651477">0</span><span class="op" id="1651478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1651481">*</span><span class="op" id="1651482">(</span><span class="op" id="1651483">*</span><span class="builtintype" id="1651484">int</span><span class="op" id="1651487">)</span><span class="op" id="1651488">(</span><span class="ident" id="1651489">nil</span><span class="op" id="1651492">)</span>&nbsp;<span class="op" id="1651494">=</span>&nbsp;<span class="num" id="1651496">0</span>&nbsp;<span class="comment" id="1651498">//&nbsp;not&nbsp;reached</span><br>
<span class="lineno"></span><span class="op" id="1651513">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">495</span><span class="comment" id="1651516">//go:nosplit</span><br>
<span class="lineno"></span><span class="keyword" id="1651529">func</span>&nbsp;<span class="ident" id="1651534">gothrow</span><span class="op" id="1651541">(</span><span class="ident" id="1651542">s</span>&nbsp;<span class="builtintype" id="1651544">string</span><span class="op" id="1651550">)</span>&nbsp;<span class="op" id="1651552">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1651555">gp</span>&nbsp;<span class="op" id="1651558">:=</span>&nbsp;<span class="ident" id="1651561">getg</span><span class="op" id="1651565">(</span><span class="op" id="1651566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1651569">if</span>&nbsp;<span class="ident" id="1651572">gp</span><span class="op" id="1651574">.</span><span class="ident" id="1651575">m</span><span class="op" id="1651576">.</span><span class="ident" id="1651577">throwing</span>&nbsp;<span class="op" id="1651586">==</span>&nbsp;<span class="num" id="1651589">0</span>&nbsp;<span class="op" id="1651591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1651595">gp</span><span class="op" id="1651597">.</span><span class="ident" id="1651598">m</span><span class="op" id="1651599">.</span><span class="ident" id="1651600">throwing</span>&nbsp;<span class="op" id="1651609">=</span>&nbsp;<span class="num" id="1651611">1</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1651614">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1651617">startpanic</span><span class="op" id="1651627">(</span><span class="op" id="1651628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1651631">print</span><span class="op" id="1651636">(</span><span class="string" id="1651637">&#34;fatal&nbsp;error:&nbsp;&#34;</span><span class="op" id="1651652">,</span>&nbsp;<span class="ident" id="1651654">s</span><span class="op" id="1651655">,</span>&nbsp;<span class="string" id="1651657">&#34;\n&#34;</span><span class="op" id="1651661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1651664">dopanic</span><span class="op" id="1651671">(</span><span class="num" id="1651672">0</span><span class="op" id="1651673">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1651676">*</span><span class="op" id="1651677">(</span><span class="op" id="1651678">*</span><span class="builtintype" id="1651679">int</span><span class="op" id="1651682">)</span><span class="op" id="1651683">(</span><span class="ident" id="1651684">nil</span><span class="op" id="1651687">)</span>&nbsp;<span class="op" id="1651689">=</span>&nbsp;<span class="num" id="1651691">0</span>&nbsp;<span class="comment" id="1651693">//&nbsp;not&nbsp;reached</span><br>
<span class="lineno">505</span><span class="op" id="1651708">}</span>
</div>
</body>
</html>
