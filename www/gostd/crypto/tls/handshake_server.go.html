<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/tls</h2>
<ul>
<li><a href="/gostd/crypto/tls/alert.go.html">alert.go</a></li>
<li><a href="/gostd/crypto/tls/cipher_suites.go.html">cipher_suites.go</a></li>
<li><a href="/gostd/crypto/tls/common.go.html">common.go</a></li>
<li><a href="/gostd/crypto/tls/conn.go.html">conn.go</a></li>
<li><a href="/gostd/crypto/tls/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/crypto/tls/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client.go.html">handshake_client.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client_test.go.html">handshake_client_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages.go.html">handshake_messages.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages_test.go.html">handshake_messages_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server.go.html" class="current">handshake_server.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server_test.go.html">handshake_server_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_test.go.html">handshake_test.go</a></li>
<li><a href="/gostd/crypto/tls/key_agreement.go.html">key_agreement.go</a></li>
<li><a href="/gostd/crypto/tls/prf.go.html">prf.go</a></li>
<li><a href="/gostd/crypto/tls/prf_test.go.html">prf_test.go</a></li>
<li><a href="/gostd/crypto/tls/ticket.go.html">ticket.go</a></li>
<li><a href="/gostd/crypto/tls/tls.go.html">tls.go</a></li>
<li><a href="/gostd/crypto/tls/tls_test.go.html">tls_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4421318">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4421373">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4421427">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4421478">package</span>&nbsp;<span class="ident" id="4421486">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4421491">import</span>&nbsp;<span class="op" id="4421498">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4421501">&#34;crypto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4421511">&#34;crypto/ecdsa&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4421527">&#34;crypto/rsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4421541">&#34;crypto/subtle&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4421558">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4421573">&#34;encoding/asn1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4421590">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4421600">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4421607">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="4421612">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4421615">//&nbsp;serverHandshakeState&nbsp;contains&nbsp;details&nbsp;of&nbsp;a&nbsp;server&nbsp;handshake&nbsp;in&nbsp;progress.</span><br>
<span class="lineno">20</span><span class="comment" id="4421691">//&nbsp;It&#39;s&nbsp;discarded&nbsp;once&nbsp;the&nbsp;handshake&nbsp;has&nbsp;completed.</span><br>
<span class="lineno"></span><span class="keyword" id="4421743">type</span>&nbsp;<span class="ident" id="4421748">serverHandshakeState</span>&nbsp;<span class="keyword" id="4421769">struct</span>&nbsp;<span class="op" id="4421776">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4421779">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4421795">*</span><span class="ident" id="4421796">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4421802">clientHello</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4421818">*</span><span class="ident" id="4421819">clientHelloMsg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4421835">hello</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4421851">*</span><span class="ident" id="4421852">serverHelloMsg</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4421868">suite</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4421884">*</span><span class="ident" id="4421885">cipherSuite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4421898">ellipticOk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4421914">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4421920">ecdsaOk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4421936">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4421942">sessionState</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4421958">*</span><span class="ident" id="4421959">sessionState</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4421973">finishedHash</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4421989">finishedHash</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4422003">masterSecret</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4422019">[</span><span class="op" id="4422020">]</span><span class="builtintype" id="4422021">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4422027">certsFromClient</span>&nbsp;<span class="op" id="4422043">[</span><span class="op" id="4422044">]</span><span class="op" id="4422045">[</span><span class="op" id="4422046">]</span><span class="builtintype" id="4422047">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4422053">cert</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4422069">*</span><span class="ident" id="4422070">Certificate</span><br>
<span class="lineno"></span><span class="op" id="4422082">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="comment" id="4422085">//&nbsp;serverHandshake&nbsp;performs&nbsp;a&nbsp;TLS&nbsp;handshake&nbsp;as&nbsp;a&nbsp;server.</span><br>
<span class="lineno"></span><span class="keyword" id="4422142">func</span>&nbsp;<span class="op" id="4422147">(</span><span class="ident" id="4422148">c</span>&nbsp;<span class="op" id="4422150">*</span><span class="ident" id="4422151">Conn</span><span class="op" id="4422155">)</span>&nbsp;<span class="ident" id="4422157">serverHandshake</span><span class="op" id="4422172">(</span><span class="op" id="4422173">)</span>&nbsp;<span class="builtintype" id="4422175">error</span>&nbsp;<span class="op" id="4422181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4422184">config</span>&nbsp;<span class="op" id="4422191">:=</span>&nbsp;<span class="ident" id="4422194">c</span><span class="op" id="4422195">.</span><span class="ident" id="4422196">config</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4422205">//&nbsp;If&nbsp;this&nbsp;is&nbsp;the&nbsp;first&nbsp;server&nbsp;handshake,&nbsp;we&nbsp;generate&nbsp;a&nbsp;random&nbsp;key&nbsp;to</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4422276">//&nbsp;encrypt&nbsp;the&nbsp;tickets&nbsp;with.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4422306">config</span><span class="op" id="4422312">.</span><span class="ident" id="4422313">serverInitOnce</span><span class="op" id="4422327">.</span><span class="ident" id="4422328">Do</span><span class="op" id="4422330">(</span><span class="ident" id="4422331">config</span><span class="op" id="4422337">.</span><span class="ident" id="4422338">serverInit</span><span class="op" id="4422348">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4422352">hs</span>&nbsp;<span class="op" id="4422355">:=</span>&nbsp;<span class="ident" id="4422358">serverHandshakeState</span><span class="op" id="4422378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4422382">c</span><span class="op" id="4422383">:</span>&nbsp;<span class="ident" id="4422385">c</span><span class="op" id="4422386">,</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4422389">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4422392">isResume</span><span class="op" id="4422400">,</span>&nbsp;<span class="ident" id="4422402">err</span>&nbsp;<span class="op" id="4422406">:=</span>&nbsp;<span class="ident" id="4422409">hs</span><span class="op" id="4422411">.</span><span class="ident" id="4422412">readClientHello</span><span class="op" id="4422427">(</span><span class="op" id="4422428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4422431">if</span>&nbsp;<span class="ident" id="4422434">err</span>&nbsp;<span class="op" id="4422438">!=</span>&nbsp;<span class="builtintype" id="4422441">nil</span>&nbsp;<span class="op" id="4422445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4422449">return</span>&nbsp;<span class="ident" id="4422456">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4422461">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4422465">//&nbsp;For&nbsp;an&nbsp;overview&nbsp;of&nbsp;TLS&nbsp;handshaking,&nbsp;see&nbsp;https://tools.ietf.org/html/rfc5246#section-7.3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4422557">if</span>&nbsp;<span class="ident" id="4422560">isResume</span>&nbsp;<span class="op" id="4422569">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4422573">//&nbsp;The&nbsp;client&nbsp;has&nbsp;included&nbsp;a&nbsp;session&nbsp;ticket&nbsp;and&nbsp;so&nbsp;we&nbsp;do&nbsp;an&nbsp;abbreviated&nbsp;handshake.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4422658">if</span>&nbsp;<span class="ident" id="4422661">err</span>&nbsp;<span class="op" id="4422665">:=</span>&nbsp;<span class="ident" id="4422668">hs</span><span class="op" id="4422670">.</span><span class="ident" id="4422671">doResumeHandshake</span><span class="op" id="4422688">(</span><span class="op" id="4422689">)</span><span class="op" id="4422690">;</span>&nbsp;<span class="ident" id="4422692">err</span>&nbsp;<span class="op" id="4422696">!=</span>&nbsp;<span class="builtintype" id="4422699">nil</span>&nbsp;<span class="op" id="4422703">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4422708">return</span>&nbsp;<span class="ident" id="4422715">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4422721">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4422725">if</span>&nbsp;<span class="ident" id="4422728">err</span>&nbsp;<span class="op" id="4422732">:=</span>&nbsp;<span class="ident" id="4422735">hs</span><span class="op" id="4422737">.</span><span class="ident" id="4422738">establishKeys</span><span class="op" id="4422751">(</span><span class="op" id="4422752">)</span><span class="op" id="4422753">;</span>&nbsp;<span class="ident" id="4422755">err</span>&nbsp;<span class="op" id="4422759">!=</span>&nbsp;<span class="builtintype" id="4422762">nil</span>&nbsp;<span class="op" id="4422766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4422771">return</span>&nbsp;<span class="ident" id="4422778">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4422784">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4422788">if</span>&nbsp;<span class="ident" id="4422791">err</span>&nbsp;<span class="op" id="4422795">:=</span>&nbsp;<span class="ident" id="4422798">hs</span><span class="op" id="4422800">.</span><span class="ident" id="4422801">sendFinished</span><span class="op" id="4422813">(</span><span class="ident" id="4422814">c</span><span class="op" id="4422815">.</span><span class="ident" id="4422816">firstFinished</span><span class="op" id="4422829">[</span><span class="op" id="4422830">:</span><span class="op" id="4422831">]</span><span class="op" id="4422832">)</span><span class="op" id="4422833">;</span>&nbsp;<span class="ident" id="4422835">err</span>&nbsp;<span class="op" id="4422839">!=</span>&nbsp;<span class="builtintype" id="4422842">nil</span>&nbsp;<span class="op" id="4422846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4422851">return</span>&nbsp;<span class="ident" id="4422858">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4422864">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4422868">if</span>&nbsp;<span class="ident" id="4422871">err</span>&nbsp;<span class="op" id="4422875">:=</span>&nbsp;<span class="ident" id="4422878">hs</span><span class="op" id="4422880">.</span><span class="ident" id="4422881">readFinished</span><span class="op" id="4422893">(</span><span class="builtintype" id="4422894">nil</span><span class="op" id="4422897">)</span><span class="op" id="4422898">;</span>&nbsp;<span class="ident" id="4422900">err</span>&nbsp;<span class="op" id="4422904">!=</span>&nbsp;<span class="builtintype" id="4422907">nil</span>&nbsp;<span class="op" id="4422911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4422916">return</span>&nbsp;<span class="ident" id="4422923">err</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4422929">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4422933">c</span><span class="op" id="4422934">.</span><span class="ident" id="4422935">didResume</span>&nbsp;<span class="op" id="4422945">=</span>&nbsp;<span class="builtintype" id="4422947">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4422953">}</span>&nbsp;<span class="keyword" id="4422955">else</span>&nbsp;<span class="op" id="4422960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4422964">//&nbsp;The&nbsp;client&nbsp;didn&#39;t&nbsp;include&nbsp;a&nbsp;session&nbsp;ticket,&nbsp;or&nbsp;it&nbsp;wasn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4423026">//&nbsp;valid&nbsp;so&nbsp;we&nbsp;do&nbsp;a&nbsp;full&nbsp;handshake.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4423064">if</span>&nbsp;<span class="ident" id="4423067">err</span>&nbsp;<span class="op" id="4423071">:=</span>&nbsp;<span class="ident" id="4423074">hs</span><span class="op" id="4423076">.</span><span class="ident" id="4423077">doFullHandshake</span><span class="op" id="4423092">(</span><span class="op" id="4423093">)</span><span class="op" id="4423094">;</span>&nbsp;<span class="ident" id="4423096">err</span>&nbsp;<span class="op" id="4423100">!=</span>&nbsp;<span class="builtintype" id="4423103">nil</span>&nbsp;<span class="op" id="4423107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4423112">return</span>&nbsp;<span class="ident" id="4423119">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4423125">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4423129">if</span>&nbsp;<span class="ident" id="4423132">err</span>&nbsp;<span class="op" id="4423136">:=</span>&nbsp;<span class="ident" id="4423139">hs</span><span class="op" id="4423141">.</span><span class="ident" id="4423142">establishKeys</span><span class="op" id="4423155">(</span><span class="op" id="4423156">)</span><span class="op" id="4423157">;</span>&nbsp;<span class="ident" id="4423159">err</span>&nbsp;<span class="op" id="4423163">!=</span>&nbsp;<span class="builtintype" id="4423166">nil</span>&nbsp;<span class="op" id="4423170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4423175">return</span>&nbsp;<span class="ident" id="4423182">err</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4423188">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4423192">if</span>&nbsp;<span class="ident" id="4423195">err</span>&nbsp;<span class="op" id="4423199">:=</span>&nbsp;<span class="ident" id="4423202">hs</span><span class="op" id="4423204">.</span><span class="ident" id="4423205">readFinished</span><span class="op" id="4423217">(</span><span class="ident" id="4423218">c</span><span class="op" id="4423219">.</span><span class="ident" id="4423220">firstFinished</span><span class="op" id="4423233">[</span><span class="op" id="4423234">:</span><span class="op" id="4423235">]</span><span class="op" id="4423236">)</span><span class="op" id="4423237">;</span>&nbsp;<span class="ident" id="4423239">err</span>&nbsp;<span class="op" id="4423243">!=</span>&nbsp;<span class="builtintype" id="4423246">nil</span>&nbsp;<span class="op" id="4423250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4423255">return</span>&nbsp;<span class="ident" id="4423262">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4423268">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4423272">if</span>&nbsp;<span class="ident" id="4423275">err</span>&nbsp;<span class="op" id="4423279">:=</span>&nbsp;<span class="ident" id="4423282">hs</span><span class="op" id="4423284">.</span><span class="ident" id="4423285">sendSessionTicket</span><span class="op" id="4423302">(</span><span class="op" id="4423303">)</span><span class="op" id="4423304">;</span>&nbsp;<span class="ident" id="4423306">err</span>&nbsp;<span class="op" id="4423310">!=</span>&nbsp;<span class="builtintype" id="4423313">nil</span>&nbsp;<span class="op" id="4423317">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4423322">return</span>&nbsp;<span class="ident" id="4423329">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4423335">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4423339">if</span>&nbsp;<span class="ident" id="4423342">err</span>&nbsp;<span class="op" id="4423346">:=</span>&nbsp;<span class="ident" id="4423349">hs</span><span class="op" id="4423351">.</span><span class="ident" id="4423352">sendFinished</span><span class="op" id="4423364">(</span><span class="builtintype" id="4423365">nil</span><span class="op" id="4423368">)</span><span class="op" id="4423369">;</span>&nbsp;<span class="ident" id="4423371">err</span>&nbsp;<span class="op" id="4423375">!=</span>&nbsp;<span class="builtintype" id="4423378">nil</span>&nbsp;<span class="op" id="4423382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4423387">return</span>&nbsp;<span class="ident" id="4423394">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4423400">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4423403">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4423406">c</span><span class="op" id="4423407">.</span><span class="ident" id="4423408">handshakeComplete</span>&nbsp;<span class="op" id="4423426">=</span>&nbsp;<span class="builtintype" id="4423428">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4423435">return</span>&nbsp;<span class="builtintype" id="4423442">nil</span><br>
<span class="lineno"></span><span class="op" id="4423446">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="comment" id="4423449">//&nbsp;readClientHello&nbsp;reads&nbsp;a&nbsp;ClientHello&nbsp;message&nbsp;from&nbsp;the&nbsp;client&nbsp;and&nbsp;decides</span><br>
<span class="lineno"></span><span class="comment" id="4423524">//&nbsp;whether&nbsp;we&nbsp;will&nbsp;perform&nbsp;session&nbsp;resumption.</span><br>
<span class="lineno"></span><span class="keyword" id="4423571">func</span>&nbsp;<span class="op" id="4423576">(</span><span class="ident" id="4423577">hs</span>&nbsp;<span class="op" id="4423580">*</span><span class="ident" id="4423581">serverHandshakeState</span><span class="op" id="4423601">)</span>&nbsp;<span class="ident" id="4423603">readClientHello</span><span class="op" id="4423618">(</span><span class="op" id="4423619">)</span>&nbsp;<span class="op" id="4423621">(</span><span class="ident" id="4423622">isResume</span>&nbsp;<span class="builtintype" id="4423631">bool</span><span class="op" id="4423635">,</span>&nbsp;<span class="ident" id="4423637">err</span>&nbsp;<span class="builtintype" id="4423641">error</span><span class="op" id="4423646">)</span>&nbsp;<span class="op" id="4423648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4423651">config</span>&nbsp;<span class="op" id="4423658">:=</span>&nbsp;<span class="ident" id="4423661">hs</span><span class="op" id="4423663">.</span><span class="ident" id="4423664">c</span><span class="op" id="4423665">.</span><span class="ident" id="4423666">config</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4423674">c</span>&nbsp;<span class="op" id="4423676">:=</span>&nbsp;<span class="ident" id="4423679">hs</span><span class="op" id="4423681">.</span><span class="ident" id="4423682">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4423686">msg</span><span class="op" id="4423689">,</span>&nbsp;<span class="ident" id="4423691">err</span>&nbsp;<span class="op" id="4423695">:=</span>&nbsp;<span class="ident" id="4423698">c</span><span class="op" id="4423699">.</span><span class="ident" id="4423700">readHandshake</span><span class="op" id="4423713">(</span><span class="op" id="4423714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4423717">if</span>&nbsp;<span class="ident" id="4423720">err</span>&nbsp;<span class="op" id="4423724">!=</span>&nbsp;<span class="builtintype" id="4423727">nil</span>&nbsp;<span class="op" id="4423731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4423735">return</span>&nbsp;<span class="builtintype" id="4423742">false</span><span class="op" id="4423747">,</span>&nbsp;<span class="ident" id="4423749">err</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4423754">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4423757">var</span>&nbsp;<span class="ident" id="4423761">ok</span>&nbsp;<span class="builtintype" id="4423764">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4423770">hs</span><span class="op" id="4423772">.</span><span class="ident" id="4423773">clientHello</span><span class="op" id="4423784">,</span>&nbsp;<span class="ident" id="4423786">ok</span>&nbsp;<span class="op" id="4423789">=</span>&nbsp;<span class="ident" id="4423791">msg</span><span class="op" id="4423794">.</span><span class="op" id="4423795">(</span><span class="op" id="4423796">*</span><span class="ident" id="4423797">clientHelloMsg</span><span class="op" id="4423811">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4423814">if</span>&nbsp;<span class="op" id="4423817">!</span><span class="ident" id="4423818">ok</span>&nbsp;<span class="op" id="4423821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4423825">c</span><span class="op" id="4423826">.</span><span class="ident" id="4423827">sendAlert</span><span class="op" id="4423836">(</span><span class="ident" id="4423837">alertUnexpectedMessage</span><span class="op" id="4423859">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4423863">return</span>&nbsp;<span class="builtintype" id="4423870">false</span><span class="op" id="4423875">,</span>&nbsp;<span class="ident" id="4423877">unexpectedMessageError</span><span class="op" id="4423899">(</span><span class="ident" id="4423900">hs</span><span class="op" id="4423902">.</span><span class="ident" id="4423903">clientHello</span><span class="op" id="4423914">,</span>&nbsp;<span class="ident" id="4423916">msg</span><span class="op" id="4423919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4423922">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4423925">c</span><span class="op" id="4423926">.</span><span class="ident" id="4423927">vers</span><span class="op" id="4423931">,</span>&nbsp;<span class="ident" id="4423933">ok</span>&nbsp;<span class="op" id="4423936">=</span>&nbsp;<span class="ident" id="4423938">config</span><span class="op" id="4423944">.</span><span class="ident" id="4423945">mutualVersion</span><span class="op" id="4423958">(</span><span class="ident" id="4423959">hs</span><span class="op" id="4423961">.</span><span class="ident" id="4423962">clientHello</span><span class="op" id="4423973">.</span><span class="ident" id="4423974">vers</span><span class="op" id="4423978">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4423981">if</span>&nbsp;<span class="op" id="4423984">!</span><span class="ident" id="4423985">ok</span>&nbsp;<span class="op" id="4423988">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4423992">c</span><span class="op" id="4423993">.</span><span class="ident" id="4423994">sendAlert</span><span class="op" id="4424003">(</span><span class="ident" id="4424004">alertProtocolVersion</span><span class="op" id="4424024">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4424028">return</span>&nbsp;<span class="builtintype" id="4424035">false</span><span class="op" id="4424040">,</span>&nbsp;<span class="ident" id="4424042">fmt</span><span class="op" id="4424045">.</span><span class="ident" id="4424046">Errorf</span><span class="op" id="4424052">(</span><span class="string" id="4424053">&#34;tls:&nbsp;client&nbsp;offered&nbsp;an&nbsp;unsupported,&nbsp;maximum&nbsp;protocol&nbsp;version&nbsp;of&nbsp;%x&#34;</span><span class="op" id="4424121">,</span>&nbsp;<span class="ident" id="4424123">hs</span><span class="op" id="4424125">.</span><span class="ident" id="4424126">clientHello</span><span class="op" id="4424137">.</span><span class="ident" id="4424138">vers</span><span class="op" id="4424142">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4424145">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4424148">c</span><span class="op" id="4424149">.</span><span class="ident" id="4424150">haveVers</span>&nbsp;<span class="op" id="4424159">=</span>&nbsp;<span class="builtintype" id="4424161">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4424168">hs</span><span class="op" id="4424170">.</span><span class="ident" id="4424171">finishedHash</span>&nbsp;<span class="op" id="4424184">=</span>&nbsp;<span class="ident" id="4424186">newFinishedHash</span><span class="op" id="4424201">(</span><span class="ident" id="4424202">c</span><span class="op" id="4424203">.</span><span class="ident" id="4424204">vers</span><span class="op" id="4424208">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4424211">hs</span><span class="op" id="4424213">.</span><span class="ident" id="4424214">finishedHash</span><span class="op" id="4424226">.</span><span class="ident" id="4424227">Write</span><span class="op" id="4424232">(</span><span class="ident" id="4424233">hs</span><span class="op" id="4424235">.</span><span class="ident" id="4424236">clientHello</span><span class="op" id="4424247">.</span><span class="ident" id="4424248">marshal</span><span class="op" id="4424255">(</span><span class="op" id="4424256">)</span><span class="op" id="4424257">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4424261">hs</span><span class="op" id="4424263">.</span><span class="ident" id="4424264">hello</span>&nbsp;<span class="op" id="4424270">=</span>&nbsp;<span class="builtinfunc" id="4424272">new</span><span class="op" id="4424275">(</span><span class="ident" id="4424276">serverHelloMsg</span><span class="op" id="4424290">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4424294">supportedCurve</span>&nbsp;<span class="op" id="4424309">:=</span>&nbsp;<span class="builtintype" id="4424312">false</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4424319">preferredCurves</span>&nbsp;<span class="op" id="4424335">:=</span>&nbsp;<span class="ident" id="4424338">config</span><span class="op" id="4424344">.</span><span class="ident" id="4424345">curvePreferences</span><span class="op" id="4424361">(</span><span class="op" id="4424362">)</span><br>
<span class="lineno"></span><span class="ident" id="4424364">Curves</span><span class="op" id="4424370">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4424373">for</span>&nbsp;<span class="ident" id="4424377">_</span><span class="op" id="4424378">,</span>&nbsp;<span class="ident" id="4424380">curve</span>&nbsp;<span class="op" id="4424386">:=</span>&nbsp;<span class="keyword" id="4424389">range</span>&nbsp;<span class="ident" id="4424395">hs</span><span class="op" id="4424397">.</span><span class="ident" id="4424398">clientHello</span><span class="op" id="4424409">.</span><span class="ident" id="4424410">supportedCurves</span>&nbsp;<span class="op" id="4424426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4424430">for</span>&nbsp;<span class="ident" id="4424434">_</span><span class="op" id="4424435">,</span>&nbsp;<span class="ident" id="4424437">supported</span>&nbsp;<span class="op" id="4424447">:=</span>&nbsp;<span class="keyword" id="4424450">range</span>&nbsp;<span class="ident" id="4424456">preferredCurves</span>&nbsp;<span class="op" id="4424472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4424477">if</span>&nbsp;<span class="ident" id="4424480">supported</span>&nbsp;<span class="op" id="4424490">==</span>&nbsp;<span class="ident" id="4424493">curve</span>&nbsp;<span class="op" id="4424499">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4424505">supportedCurve</span>&nbsp;<span class="op" id="4424520">=</span>&nbsp;<span class="builtintype" id="4424522">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4424531">break</span>&nbsp;<span class="ident" id="4424537">Curves</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4424547">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4424551">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4424554">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4424558">supportedPointFormat</span>&nbsp;<span class="op" id="4424579">:=</span>&nbsp;<span class="builtintype" id="4424582">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4424589">for</span>&nbsp;<span class="ident" id="4424593">_</span><span class="op" id="4424594">,</span>&nbsp;<span class="ident" id="4424596">pointFormat</span>&nbsp;<span class="op" id="4424608">:=</span>&nbsp;<span class="keyword" id="4424611">range</span>&nbsp;<span class="ident" id="4424617">hs</span><span class="op" id="4424619">.</span><span class="ident" id="4424620">clientHello</span><span class="op" id="4424631">.</span><span class="ident" id="4424632">supportedPoints</span>&nbsp;<span class="op" id="4424648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4424652">if</span>&nbsp;<span class="ident" id="4424655">pointFormat</span>&nbsp;<span class="op" id="4424667">==</span>&nbsp;<span class="ident" id="4424670">pointFormatUncompressed</span>&nbsp;<span class="op" id="4424694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4424699">supportedPointFormat</span>&nbsp;<span class="op" id="4424720">=</span>&nbsp;<span class="builtintype" id="4424722">true</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4424730">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4424738">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4424741">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4424744">hs</span><span class="op" id="4424746">.</span><span class="ident" id="4424747">ellipticOk</span>&nbsp;<span class="op" id="4424758">=</span>&nbsp;<span class="ident" id="4424760">supportedCurve</span>&nbsp;<span class="op" id="4424775">&amp;&amp;</span>&nbsp;<span class="ident" id="4424778">supportedPointFormat</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4424801">foundCompression</span>&nbsp;<span class="op" id="4424818">:=</span>&nbsp;<span class="builtintype" id="4424821">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4424828">//&nbsp;We&nbsp;only&nbsp;support&nbsp;null&nbsp;compression,&nbsp;so&nbsp;check&nbsp;that&nbsp;the&nbsp;client&nbsp;offered&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4424903">for</span>&nbsp;<span class="ident" id="4424907">_</span><span class="op" id="4424908">,</span>&nbsp;<span class="ident" id="4424910">compression</span>&nbsp;<span class="op" id="4424922">:=</span>&nbsp;<span class="keyword" id="4424925">range</span>&nbsp;<span class="ident" id="4424931">hs</span><span class="op" id="4424933">.</span><span class="ident" id="4424934">clientHello</span><span class="op" id="4424945">.</span><span class="ident" id="4424946">compressionMethods</span>&nbsp;<span class="op" id="4424965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4424969">if</span>&nbsp;<span class="ident" id="4424972">compression</span>&nbsp;<span class="op" id="4424984">==</span>&nbsp;<span class="ident" id="4424987">compressionNone</span>&nbsp;<span class="op" id="4425003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4425008">foundCompression</span>&nbsp;<span class="op" id="4425025">=</span>&nbsp;<span class="builtintype" id="4425027">true</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4425035">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4425043">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4425046">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4425050">if</span>&nbsp;<span class="op" id="4425053">!</span><span class="ident" id="4425054">foundCompression</span>&nbsp;<span class="op" id="4425071">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4425075">c</span><span class="op" id="4425076">.</span><span class="ident" id="4425077">sendAlert</span><span class="op" id="4425086">(</span><span class="ident" id="4425087">alertHandshakeFailure</span><span class="op" id="4425108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4425112">return</span>&nbsp;<span class="builtintype" id="4425119">false</span><span class="op" id="4425124">,</span>&nbsp;<span class="ident" id="4425126">errors</span><span class="op" id="4425132">.</span><span class="ident" id="4425133">New</span><span class="op" id="4425136">(</span><span class="string" id="4425137">&#34;tls:&nbsp;client&nbsp;does&nbsp;not&nbsp;support&nbsp;uncompressed&nbsp;connections&#34;</span><span class="op" id="4425192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4425195">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4425199">hs</span><span class="op" id="4425201">.</span><span class="ident" id="4425202">hello</span><span class="op" id="4425207">.</span><span class="ident" id="4425208">vers</span>&nbsp;<span class="op" id="4425213">=</span>&nbsp;<span class="ident" id="4425215">c</span><span class="op" id="4425216">.</span><span class="ident" id="4425217">vers</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4425223">hs</span><span class="op" id="4425225">.</span><span class="ident" id="4425226">hello</span><span class="op" id="4425231">.</span><span class="ident" id="4425232">random</span>&nbsp;<span class="op" id="4425239">=</span>&nbsp;<span class="builtinfunc" id="4425241">make</span><span class="op" id="4425245">(</span><span class="op" id="4425246">[</span><span class="op" id="4425247">]</span><span class="builtintype" id="4425248">byte</span><span class="op" id="4425252">,</span>&nbsp;<span class="num" id="4425254">32</span><span class="op" id="4425256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4425259">_</span><span class="op" id="4425260">,</span>&nbsp;<span class="ident" id="4425262">err</span>&nbsp;<span class="op" id="4425266">=</span>&nbsp;<span class="ident" id="4425268">io</span><span class="op" id="4425270">.</span><span class="ident" id="4425271">ReadFull</span><span class="op" id="4425279">(</span><span class="ident" id="4425280">config</span><span class="op" id="4425286">.</span><span class="ident" id="4425287">rand</span><span class="op" id="4425291">(</span><span class="op" id="4425292">)</span><span class="op" id="4425293">,</span>&nbsp;<span class="ident" id="4425295">hs</span><span class="op" id="4425297">.</span><span class="ident" id="4425298">hello</span><span class="op" id="4425303">.</span><span class="ident" id="4425304">random</span><span class="op" id="4425310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4425313">if</span>&nbsp;<span class="ident" id="4425316">err</span>&nbsp;<span class="op" id="4425320">!=</span>&nbsp;<span class="builtintype" id="4425323">nil</span>&nbsp;<span class="op" id="4425327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4425331">c</span><span class="op" id="4425332">.</span><span class="ident" id="4425333">sendAlert</span><span class="op" id="4425342">(</span><span class="ident" id="4425343">alertInternalError</span><span class="op" id="4425361">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4425365">return</span>&nbsp;<span class="builtintype" id="4425372">false</span><span class="op" id="4425377">,</span>&nbsp;<span class="ident" id="4425379">err</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4425384">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4425387">hs</span><span class="op" id="4425389">.</span><span class="ident" id="4425390">hello</span><span class="op" id="4425395">.</span><span class="ident" id="4425396">secureRenegotiation</span>&nbsp;<span class="op" id="4425416">=</span>&nbsp;<span class="ident" id="4425418">hs</span><span class="op" id="4425420">.</span><span class="ident" id="4425421">clientHello</span><span class="op" id="4425432">.</span><span class="ident" id="4425433">secureRenegotiation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4425454">hs</span><span class="op" id="4425456">.</span><span class="ident" id="4425457">hello</span><span class="op" id="4425462">.</span><span class="ident" id="4425463">compressionMethod</span>&nbsp;<span class="op" id="4425481">=</span>&nbsp;<span class="ident" id="4425483">compressionNone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4425500">if</span>&nbsp;<span class="builtinfunc" id="4425503">len</span><span class="op" id="4425506">(</span><span class="ident" id="4425507">hs</span><span class="op" id="4425509">.</span><span class="ident" id="4425510">clientHello</span><span class="op" id="4425521">.</span><span class="ident" id="4425522">serverName</span><span class="op" id="4425532">)</span>&nbsp;<span class="op" id="4425534">&gt;</span>&nbsp;<span class="num" id="4425536">0</span>&nbsp;<span class="op" id="4425538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4425542">c</span><span class="op" id="4425543">.</span><span class="ident" id="4425544">serverName</span>&nbsp;<span class="op" id="4425555">=</span>&nbsp;<span class="ident" id="4425557">hs</span><span class="op" id="4425559">.</span><span class="ident" id="4425560">clientHello</span><span class="op" id="4425571">.</span><span class="ident" id="4425572">serverName</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4425584">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4425588">if</span>&nbsp;<span class="builtinfunc" id="4425591">len</span><span class="op" id="4425594">(</span><span class="ident" id="4425595">hs</span><span class="op" id="4425597">.</span><span class="ident" id="4425598">clientHello</span><span class="op" id="4425609">.</span><span class="ident" id="4425610">alpnProtocols</span><span class="op" id="4425623">)</span>&nbsp;<span class="op" id="4425625">&gt;</span>&nbsp;<span class="num" id="4425627">0</span>&nbsp;<span class="op" id="4425629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4425633">if</span>&nbsp;<span class="ident" id="4425636">selectedProto</span><span class="op" id="4425649">,</span>&nbsp;<span class="ident" id="4425651">fallback</span>&nbsp;<span class="op" id="4425660">:=</span>&nbsp;<span class="ident" id="4425663">mutualProtocol</span><span class="op" id="4425677">(</span><span class="ident" id="4425678">hs</span><span class="op" id="4425680">.</span><span class="ident" id="4425681">clientHello</span><span class="op" id="4425692">.</span><span class="ident" id="4425693">alpnProtocols</span><span class="op" id="4425706">,</span>&nbsp;<span class="ident" id="4425708">c</span><span class="op" id="4425709">.</span><span class="ident" id="4425710">config</span><span class="op" id="4425716">.</span><span class="ident" id="4425717">NextProtos</span><span class="op" id="4425727">)</span><span class="op" id="4425728">;</span>&nbsp;<span class="op" id="4425730">!</span><span class="ident" id="4425731">fallback</span>&nbsp;<span class="op" id="4425740">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4425745">hs</span><span class="op" id="4425747">.</span><span class="ident" id="4425748">hello</span><span class="op" id="4425753">.</span><span class="ident" id="4425754">alpnProtocol</span>&nbsp;<span class="op" id="4425767">=</span>&nbsp;<span class="ident" id="4425769">selectedProto</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4425786">c</span><span class="op" id="4425787">.</span><span class="ident" id="4425788">clientProtocol</span>&nbsp;<span class="op" id="4425803">=</span>&nbsp;<span class="ident" id="4425805">selectedProto</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4425821">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4425824">}</span>&nbsp;<span class="keyword" id="4425826">else</span>&nbsp;<span class="op" id="4425831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4425835">//&nbsp;Although&nbsp;sending&nbsp;an&nbsp;empty&nbsp;NPN&nbsp;extension&nbsp;is&nbsp;reasonable,&nbsp;Firefox&nbsp;has</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4425907">//&nbsp;had&nbsp;a&nbsp;bug&nbsp;around&nbsp;this.&nbsp;Best&nbsp;to&nbsp;send&nbsp;nothing&nbsp;at&nbsp;all&nbsp;if</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4425966">//&nbsp;config.NextProtos&nbsp;is&nbsp;empty.&nbsp;See</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4426003">//&nbsp;https://code.google.com/p/go/issues/detail?id=5445.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4426060">if</span>&nbsp;<span class="ident" id="4426063">hs</span><span class="op" id="4426065">.</span><span class="ident" id="4426066">clientHello</span><span class="op" id="4426077">.</span><span class="ident" id="4426078">nextProtoNeg</span>&nbsp;<span class="op" id="4426091">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="4426094">len</span><span class="op" id="4426097">(</span><span class="ident" id="4426098">config</span><span class="op" id="4426104">.</span><span class="ident" id="4426105">NextProtos</span><span class="op" id="4426115">)</span>&nbsp;<span class="op" id="4426117">&gt;</span>&nbsp;<span class="num" id="4426119">0</span>&nbsp;<span class="op" id="4426121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4426126">hs</span><span class="op" id="4426128">.</span><span class="ident" id="4426129">hello</span><span class="op" id="4426134">.</span><span class="ident" id="4426135">nextProtoNeg</span>&nbsp;<span class="op" id="4426148">=</span>&nbsp;<span class="builtintype" id="4426150">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4426158">hs</span><span class="op" id="4426160">.</span><span class="ident" id="4426161">hello</span><span class="op" id="4426166">.</span><span class="ident" id="4426167">nextProtos</span>&nbsp;<span class="op" id="4426178">=</span>&nbsp;<span class="ident" id="4426180">config</span><span class="op" id="4426186">.</span><span class="ident" id="4426187">NextProtos</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4426200">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4426203">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4426207">if</span>&nbsp;<span class="builtinfunc" id="4426210">len</span><span class="op" id="4426213">(</span><span class="ident" id="4426214">config</span><span class="op" id="4426220">.</span><span class="ident" id="4426221">Certificates</span><span class="op" id="4426233">)</span>&nbsp;<span class="op" id="4426235">==</span>&nbsp;<span class="num" id="4426238">0</span>&nbsp;<span class="op" id="4426240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4426244">c</span><span class="op" id="4426245">.</span><span class="ident" id="4426246">sendAlert</span><span class="op" id="4426255">(</span><span class="ident" id="4426256">alertInternalError</span><span class="op" id="4426274">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4426278">return</span>&nbsp;<span class="builtintype" id="4426285">false</span><span class="op" id="4426290">,</span>&nbsp;<span class="ident" id="4426292">errors</span><span class="op" id="4426298">.</span><span class="ident" id="4426299">New</span><span class="op" id="4426302">(</span><span class="string" id="4426303">&#34;tls:&nbsp;no&nbsp;certificates&nbsp;configured&#34;</span><span class="op" id="4426336">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4426339">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4426342">hs</span><span class="op" id="4426344">.</span><span class="ident" id="4426345">cert</span>&nbsp;<span class="op" id="4426350">=</span>&nbsp;<span class="op" id="4426352">&amp;</span><span class="ident" id="4426353">config</span><span class="op" id="4426359">.</span><span class="ident" id="4426360">Certificates</span><span class="op" id="4426372">[</span><span class="num" id="4426373">0</span><span class="op" id="4426374">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4426377">if</span>&nbsp;<span class="builtinfunc" id="4426380">len</span><span class="op" id="4426383">(</span><span class="ident" id="4426384">hs</span><span class="op" id="4426386">.</span><span class="ident" id="4426387">clientHello</span><span class="op" id="4426398">.</span><span class="ident" id="4426399">serverName</span><span class="op" id="4426409">)</span>&nbsp;<span class="op" id="4426411">&gt;</span>&nbsp;<span class="num" id="4426413">0</span>&nbsp;<span class="op" id="4426415">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4426419">chi</span>&nbsp;<span class="op" id="4426423">:=</span>&nbsp;<span class="op" id="4426426">&amp;</span><span class="ident" id="4426427">ClientHelloInfo</span><span class="op" id="4426442">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4426447">CipherSuites</span><span class="op" id="4426459">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4426464">hs</span><span class="op" id="4426466">.</span><span class="ident" id="4426467">clientHello</span><span class="op" id="4426478">.</span><span class="ident" id="4426479">cipherSuites</span><span class="op" id="4426491">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4426496">ServerName</span><span class="op" id="4426506">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4426513">hs</span><span class="op" id="4426515">.</span><span class="ident" id="4426516">clientHello</span><span class="op" id="4426527">.</span><span class="ident" id="4426528">serverName</span><span class="op" id="4426538">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4426543">SupportedCurves</span><span class="op" id="4426558">:</span>&nbsp;<span class="ident" id="4426560">hs</span><span class="op" id="4426562">.</span><span class="ident" id="4426563">clientHello</span><span class="op" id="4426574">.</span><span class="ident" id="4426575">supportedCurves</span><span class="op" id="4426590">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4426595">SupportedPoints</span><span class="op" id="4426610">:</span>&nbsp;<span class="ident" id="4426612">hs</span><span class="op" id="4426614">.</span><span class="ident" id="4426615">clientHello</span><span class="op" id="4426626">.</span><span class="ident" id="4426627">supportedPoints</span><span class="op" id="4426642">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4426646">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4426650">if</span>&nbsp;<span class="ident" id="4426653">hs</span><span class="op" id="4426655">.</span><span class="ident" id="4426656">cert</span><span class="op" id="4426660">,</span>&nbsp;<span class="ident" id="4426662">err</span>&nbsp;<span class="op" id="4426666">=</span>&nbsp;<span class="ident" id="4426668">config</span><span class="op" id="4426674">.</span><span class="ident" id="4426675">getCertificate</span><span class="op" id="4426689">(</span><span class="ident" id="4426690">chi</span><span class="op" id="4426693">)</span><span class="op" id="4426694">;</span>&nbsp;<span class="ident" id="4426696">err</span>&nbsp;<span class="op" id="4426700">!=</span>&nbsp;<span class="builtintype" id="4426703">nil</span>&nbsp;<span class="op" id="4426707">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4426712">c</span><span class="op" id="4426713">.</span><span class="ident" id="4426714">sendAlert</span><span class="op" id="4426723">(</span><span class="ident" id="4426724">alertInternalError</span><span class="op" id="4426742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4426747">return</span>&nbsp;<span class="builtintype" id="4426754">false</span><span class="op" id="4426759">,</span>&nbsp;<span class="ident" id="4426761">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4426767">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4426770">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4426774">_</span><span class="op" id="4426775">,</span>&nbsp;<span class="ident" id="4426777">hs</span><span class="op" id="4426779">.</span><span class="ident" id="4426780">ecdsaOk</span>&nbsp;<span class="op" id="4426788">=</span>&nbsp;<span class="ident" id="4426790">hs</span><span class="op" id="4426792">.</span><span class="ident" id="4426793">cert</span><span class="op" id="4426797">.</span><span class="ident" id="4426798">PrivateKey</span><span class="op" id="4426808">.</span><span class="op" id="4426809">(</span><span class="op" id="4426810">*</span><span class="ident" id="4426811">ecdsa</span><span class="op" id="4426816">.</span><span class="ident" id="4426817">PrivateKey</span><span class="op" id="4426827">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4426831">if</span>&nbsp;<span class="ident" id="4426834">hs</span><span class="op" id="4426836">.</span><span class="ident" id="4426837">checkForResumption</span><span class="op" id="4426855">(</span><span class="op" id="4426856">)</span>&nbsp;<span class="op" id="4426858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4426862">return</span>&nbsp;<span class="builtintype" id="4426869">true</span><span class="op" id="4426873">,</span>&nbsp;<span class="builtintype" id="4426875">nil</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4426880">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4426884">var</span>&nbsp;<span class="ident" id="4426888">preferenceList</span><span class="op" id="4426902">,</span>&nbsp;<span class="ident" id="4426904">supportedList</span>&nbsp;<span class="op" id="4426918">[</span><span class="op" id="4426919">]</span><span class="builtintype" id="4426920">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4426928">if</span>&nbsp;<span class="ident" id="4426931">c</span><span class="op" id="4426932">.</span><span class="ident" id="4426933">config</span><span class="op" id="4426939">.</span><span class="ident" id="4426940">PreferServerCipherSuites</span>&nbsp;<span class="op" id="4426965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4426969">preferenceList</span>&nbsp;<span class="op" id="4426984">=</span>&nbsp;<span class="ident" id="4426986">c</span><span class="op" id="4426987">.</span><span class="ident" id="4426988">config</span><span class="op" id="4426994">.</span><span class="ident" id="4426995">cipherSuites</span><span class="op" id="4427007">(</span><span class="op" id="4427008">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4427012">supportedList</span>&nbsp;<span class="op" id="4427026">=</span>&nbsp;<span class="ident" id="4427028">hs</span><span class="op" id="4427030">.</span><span class="ident" id="4427031">clientHello</span><span class="op" id="4427042">.</span><span class="ident" id="4427043">cipherSuites</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4427057">}</span>&nbsp;<span class="keyword" id="4427059">else</span>&nbsp;<span class="op" id="4427064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4427068">preferenceList</span>&nbsp;<span class="op" id="4427083">=</span>&nbsp;<span class="ident" id="4427085">hs</span><span class="op" id="4427087">.</span><span class="ident" id="4427088">clientHello</span><span class="op" id="4427099">.</span><span class="ident" id="4427100">cipherSuites</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4427115">supportedList</span>&nbsp;<span class="op" id="4427129">=</span>&nbsp;<span class="ident" id="4427131">c</span><span class="op" id="4427132">.</span><span class="ident" id="4427133">config</span><span class="op" id="4427139">.</span><span class="ident" id="4427140">cipherSuites</span><span class="op" id="4427152">(</span><span class="op" id="4427153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4427156">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4427160">for</span>&nbsp;<span class="ident" id="4427164">_</span><span class="op" id="4427165">,</span>&nbsp;<span class="ident" id="4427167">id</span>&nbsp;<span class="op" id="4427170">:=</span>&nbsp;<span class="keyword" id="4427173">range</span>&nbsp;<span class="ident" id="4427179">preferenceList</span>&nbsp;<span class="op" id="4427194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4427198">if</span>&nbsp;<span class="ident" id="4427201">hs</span><span class="op" id="4427203">.</span><span class="ident" id="4427204">suite</span>&nbsp;<span class="op" id="4427210">=</span>&nbsp;<span class="ident" id="4427212">c</span><span class="op" id="4427213">.</span><span class="ident" id="4427214">tryCipherSuite</span><span class="op" id="4427228">(</span><span class="ident" id="4427229">id</span><span class="op" id="4427231">,</span>&nbsp;<span class="ident" id="4427233">supportedList</span><span class="op" id="4427246">,</span>&nbsp;<span class="ident" id="4427248">c</span><span class="op" id="4427249">.</span><span class="ident" id="4427250">vers</span><span class="op" id="4427254">,</span>&nbsp;<span class="ident" id="4427256">hs</span><span class="op" id="4427258">.</span><span class="ident" id="4427259">ellipticOk</span><span class="op" id="4427269">,</span>&nbsp;<span class="ident" id="4427271">hs</span><span class="op" id="4427273">.</span><span class="ident" id="4427274">ecdsaOk</span><span class="op" id="4427281">)</span><span class="op" id="4427282">;</span>&nbsp;<span class="ident" id="4427284">hs</span><span class="op" id="4427286">.</span><span class="ident" id="4427287">suite</span>&nbsp;<span class="op" id="4427293">!=</span>&nbsp;<span class="builtintype" id="4427296">nil</span>&nbsp;<span class="op" id="4427300">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4427305">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4427313">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4427316">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4427320">if</span>&nbsp;<span class="ident" id="4427323">hs</span><span class="op" id="4427325">.</span><span class="ident" id="4427326">suite</span>&nbsp;<span class="op" id="4427332">==</span>&nbsp;<span class="builtintype" id="4427335">nil</span>&nbsp;<span class="op" id="4427339">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4427343">c</span><span class="op" id="4427344">.</span><span class="ident" id="4427345">sendAlert</span><span class="op" id="4427354">(</span><span class="ident" id="4427355">alertHandshakeFailure</span><span class="op" id="4427376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4427380">return</span>&nbsp;<span class="builtintype" id="4427387">false</span><span class="op" id="4427392">,</span>&nbsp;<span class="ident" id="4427394">errors</span><span class="op" id="4427400">.</span><span class="ident" id="4427401">New</span><span class="op" id="4427404">(</span><span class="string" id="4427405">&#34;tls:&nbsp;no&nbsp;cipher&nbsp;suite&nbsp;supported&nbsp;by&nbsp;both&nbsp;client&nbsp;and&nbsp;server&#34;</span><span class="op" id="4427463">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4427466">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4427470">//&nbsp;See&nbsp;https://tools.ietf.org/html/draft-ietf-tls-downgrade-scsv-00.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4427540">for</span>&nbsp;<span class="ident" id="4427544">_</span><span class="op" id="4427545">,</span>&nbsp;<span class="ident" id="4427547">id</span>&nbsp;<span class="op" id="4427550">:=</span>&nbsp;<span class="keyword" id="4427553">range</span>&nbsp;<span class="ident" id="4427559">hs</span><span class="op" id="4427561">.</span><span class="ident" id="4427562">clientHello</span><span class="op" id="4427573">.</span><span class="ident" id="4427574">cipherSuites</span>&nbsp;<span class="op" id="4427587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4427591">if</span>&nbsp;<span class="ident" id="4427594">id</span>&nbsp;<span class="op" id="4427597">==</span>&nbsp;<span class="ident" id="4427600">TLS_FALLBACK_SCSV</span>&nbsp;<span class="op" id="4427618">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4427623">//&nbsp;The&nbsp;client&nbsp;is&nbsp;doing&nbsp;a&nbsp;fallback&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4427672">if</span>&nbsp;<span class="ident" id="4427675">hs</span><span class="op" id="4427677">.</span><span class="ident" id="4427678">clientHello</span><span class="op" id="4427689">.</span><span class="ident" id="4427690">vers</span>&nbsp;<span class="op" id="4427695">&lt;</span>&nbsp;<span class="ident" id="4427697">c</span><span class="op" id="4427698">.</span><span class="ident" id="4427699">config</span><span class="op" id="4427705">.</span><span class="ident" id="4427706">MaxVersion</span>&nbsp;<span class="op" id="4427717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4427723">c</span><span class="op" id="4427724">.</span><span class="ident" id="4427725">sendAlert</span><span class="op" id="4427734">(</span><span class="ident" id="4427735">alertInappropriateFallback</span><span class="op" id="4427761">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4427767">return</span>&nbsp;<span class="builtintype" id="4427774">false</span><span class="op" id="4427779">,</span>&nbsp;<span class="ident" id="4427781">errors</span><span class="op" id="4427787">.</span><span class="ident" id="4427788">New</span><span class="op" id="4427791">(</span><span class="string" id="4427792">&#34;tls:&nbsp;client&nbsp;using&nbsp;inppropriate&nbsp;protocol&nbsp;fallback&#34;</span><span class="op" id="4427842">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4427847">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4427852">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4427860">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4427863">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4427867">return</span>&nbsp;<span class="builtintype" id="4427874">false</span><span class="op" id="4427879">,</span>&nbsp;<span class="builtintype" id="4427881">nil</span><br>
<span class="lineno">240</span><span class="op" id="4427885">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4427888">//&nbsp;checkForResumption&nbsp;returns&nbsp;true&nbsp;if&nbsp;we&nbsp;should&nbsp;perform&nbsp;resumption&nbsp;on&nbsp;this&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="4427975">func</span>&nbsp;<span class="op" id="4427980">(</span><span class="ident" id="4427981">hs</span>&nbsp;<span class="op" id="4427984">*</span><span class="ident" id="4427985">serverHandshakeState</span><span class="op" id="4428005">)</span>&nbsp;<span class="ident" id="4428007">checkForResumption</span><span class="op" id="4428025">(</span><span class="op" id="4428026">)</span>&nbsp;<span class="builtintype" id="4428028">bool</span>&nbsp;<span class="op" id="4428033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4428036">c</span>&nbsp;<span class="op" id="4428038">:=</span>&nbsp;<span class="ident" id="4428041">hs</span><span class="op" id="4428043">.</span><span class="ident" id="4428044">c</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4428048">if</span>&nbsp;<span class="ident" id="4428051">c</span><span class="op" id="4428052">.</span><span class="ident" id="4428053">config</span><span class="op" id="4428059">.</span><span class="ident" id="4428060">SessionTicketsDisabled</span>&nbsp;<span class="op" id="4428083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4428087">return</span>&nbsp;<span class="builtintype" id="4428094">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4428101">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4428105">var</span>&nbsp;<span class="ident" id="4428109">ok</span>&nbsp;<span class="builtintype" id="4428112">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4428118">if</span>&nbsp;<span class="ident" id="4428121">hs</span><span class="op" id="4428123">.</span><span class="ident" id="4428124">sessionState</span><span class="op" id="4428136">,</span>&nbsp;<span class="ident" id="4428138">ok</span>&nbsp;<span class="op" id="4428141">=</span>&nbsp;<span class="ident" id="4428143">c</span><span class="op" id="4428144">.</span><span class="ident" id="4428145">decryptTicket</span><span class="op" id="4428158">(</span><span class="ident" id="4428159">hs</span><span class="op" id="4428161">.</span><span class="ident" id="4428162">clientHello</span><span class="op" id="4428173">.</span><span class="ident" id="4428174">sessionTicket</span><span class="op" id="4428187">)</span><span class="op" id="4428188">;</span>&nbsp;<span class="op" id="4428190">!</span><span class="ident" id="4428191">ok</span>&nbsp;<span class="op" id="4428194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4428198">return</span>&nbsp;<span class="builtintype" id="4428205">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4428212">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4428216">if</span>&nbsp;<span class="ident" id="4428219">hs</span><span class="op" id="4428221">.</span><span class="ident" id="4428222">sessionState</span><span class="op" id="4428234">.</span><span class="ident" id="4428235">vers</span>&nbsp;<span class="op" id="4428240">&gt;</span>&nbsp;<span class="ident" id="4428242">hs</span><span class="op" id="4428244">.</span><span class="ident" id="4428245">clientHello</span><span class="op" id="4428256">.</span><span class="ident" id="4428257">vers</span>&nbsp;<span class="op" id="4428262">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4428266">return</span>&nbsp;<span class="builtintype" id="4428273">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4428280">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4428283">if</span>&nbsp;<span class="ident" id="4428286">vers</span><span class="op" id="4428290">,</span>&nbsp;<span class="ident" id="4428292">ok</span>&nbsp;<span class="op" id="4428295">:=</span>&nbsp;<span class="ident" id="4428298">c</span><span class="op" id="4428299">.</span><span class="ident" id="4428300">config</span><span class="op" id="4428306">.</span><span class="ident" id="4428307">mutualVersion</span><span class="op" id="4428320">(</span><span class="ident" id="4428321">hs</span><span class="op" id="4428323">.</span><span class="ident" id="4428324">sessionState</span><span class="op" id="4428336">.</span><span class="ident" id="4428337">vers</span><span class="op" id="4428341">)</span><span class="op" id="4428342">;</span>&nbsp;<span class="op" id="4428344">!</span><span class="ident" id="4428345">ok</span>&nbsp;<span class="op" id="4428348">||</span>&nbsp;<span class="ident" id="4428351">vers</span>&nbsp;<span class="op" id="4428356">!=</span>&nbsp;<span class="ident" id="4428359">hs</span><span class="op" id="4428361">.</span><span class="ident" id="4428362">sessionState</span><span class="op" id="4428374">.</span><span class="ident" id="4428375">vers</span>&nbsp;<span class="op" id="4428380">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4428384">return</span>&nbsp;<span class="builtintype" id="4428391">false</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4428398">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4428402">cipherSuiteOk</span>&nbsp;<span class="op" id="4428416">:=</span>&nbsp;<span class="builtintype" id="4428419">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4428426">//&nbsp;Check&nbsp;that&nbsp;the&nbsp;client&nbsp;is&nbsp;still&nbsp;offering&nbsp;the&nbsp;ciphersuite&nbsp;in&nbsp;the&nbsp;session.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4428502">for</span>&nbsp;<span class="ident" id="4428506">_</span><span class="op" id="4428507">,</span>&nbsp;<span class="ident" id="4428509">id</span>&nbsp;<span class="op" id="4428512">:=</span>&nbsp;<span class="keyword" id="4428515">range</span>&nbsp;<span class="ident" id="4428521">hs</span><span class="op" id="4428523">.</span><span class="ident" id="4428524">clientHello</span><span class="op" id="4428535">.</span><span class="ident" id="4428536">cipherSuites</span>&nbsp;<span class="op" id="4428549">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4428553">if</span>&nbsp;<span class="ident" id="4428556">id</span>&nbsp;<span class="op" id="4428559">==</span>&nbsp;<span class="ident" id="4428562">hs</span><span class="op" id="4428564">.</span><span class="ident" id="4428565">sessionState</span><span class="op" id="4428577">.</span><span class="ident" id="4428578">cipherSuite</span>&nbsp;<span class="op" id="4428590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4428595">cipherSuiteOk</span>&nbsp;<span class="op" id="4428609">=</span>&nbsp;<span class="builtintype" id="4428611">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4428619">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4428627">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4428630">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4428633">if</span>&nbsp;<span class="op" id="4428636">!</span><span class="ident" id="4428637">cipherSuiteOk</span>&nbsp;<span class="op" id="4428651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4428655">return</span>&nbsp;<span class="builtintype" id="4428662">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4428669">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4428673">//&nbsp;Check&nbsp;that&nbsp;we&nbsp;also&nbsp;support&nbsp;the&nbsp;ciphersuite&nbsp;from&nbsp;the&nbsp;session.</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4428738">hs</span><span class="op" id="4428740">.</span><span class="ident" id="4428741">suite</span>&nbsp;<span class="op" id="4428747">=</span>&nbsp;<span class="ident" id="4428749">c</span><span class="op" id="4428750">.</span><span class="ident" id="4428751">tryCipherSuite</span><span class="op" id="4428765">(</span><span class="ident" id="4428766">hs</span><span class="op" id="4428768">.</span><span class="ident" id="4428769">sessionState</span><span class="op" id="4428781">.</span><span class="ident" id="4428782">cipherSuite</span><span class="op" id="4428793">,</span>&nbsp;<span class="ident" id="4428795">c</span><span class="op" id="4428796">.</span><span class="ident" id="4428797">config</span><span class="op" id="4428803">.</span><span class="ident" id="4428804">cipherSuites</span><span class="op" id="4428816">(</span><span class="op" id="4428817">)</span><span class="op" id="4428818">,</span>&nbsp;<span class="ident" id="4428820">hs</span><span class="op" id="4428822">.</span><span class="ident" id="4428823">sessionState</span><span class="op" id="4428835">.</span><span class="ident" id="4428836">vers</span><span class="op" id="4428840">,</span>&nbsp;<span class="ident" id="4428842">hs</span><span class="op" id="4428844">.</span><span class="ident" id="4428845">ellipticOk</span><span class="op" id="4428855">,</span>&nbsp;<span class="ident" id="4428857">hs</span><span class="op" id="4428859">.</span><span class="ident" id="4428860">ecdsaOk</span><span class="op" id="4428867">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4428870">if</span>&nbsp;<span class="ident" id="4428873">hs</span><span class="op" id="4428875">.</span><span class="ident" id="4428876">suite</span>&nbsp;<span class="op" id="4428882">==</span>&nbsp;<span class="builtintype" id="4428885">nil</span>&nbsp;<span class="op" id="4428889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4428893">return</span>&nbsp;<span class="builtintype" id="4428900">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4428907">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4428911">sessionHasClientCerts</span>&nbsp;<span class="op" id="4428933">:=</span>&nbsp;<span class="builtinfunc" id="4428936">len</span><span class="op" id="4428939">(</span><span class="ident" id="4428940">hs</span><span class="op" id="4428942">.</span><span class="ident" id="4428943">sessionState</span><span class="op" id="4428955">.</span><span class="ident" id="4428956">certificates</span><span class="op" id="4428968">)</span>&nbsp;<span class="op" id="4428970">!=</span>&nbsp;<span class="num" id="4428973">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4428976">needClientCerts</span>&nbsp;<span class="op" id="4428992">:=</span>&nbsp;<span class="ident" id="4428995">c</span><span class="op" id="4428996">.</span><span class="ident" id="4428997">config</span><span class="op" id="4429003">.</span><span class="ident" id="4429004">ClientAuth</span>&nbsp;<span class="op" id="4429015">==</span>&nbsp;<span class="ident" id="4429018">RequireAnyClientCert</span>&nbsp;<span class="op" id="4429039">||</span>&nbsp;<span class="ident" id="4429042">c</span><span class="op" id="4429043">.</span><span class="ident" id="4429044">config</span><span class="op" id="4429050">.</span><span class="ident" id="4429051">ClientAuth</span>&nbsp;<span class="op" id="4429062">==</span>&nbsp;<span class="ident" id="4429065">RequireAndVerifyClientCert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4429093">if</span>&nbsp;<span class="ident" id="4429096">needClientCerts</span>&nbsp;<span class="op" id="4429112">&amp;&amp;</span>&nbsp;<span class="op" id="4429115">!</span><span class="ident" id="4429116">sessionHasClientCerts</span>&nbsp;<span class="op" id="4429138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4429142">return</span>&nbsp;<span class="builtintype" id="4429149">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4429156">}</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4429159">if</span>&nbsp;<span class="ident" id="4429162">sessionHasClientCerts</span>&nbsp;<span class="op" id="4429184">&amp;&amp;</span>&nbsp;<span class="ident" id="4429187">c</span><span class="op" id="4429188">.</span><span class="ident" id="4429189">config</span><span class="op" id="4429195">.</span><span class="ident" id="4429196">ClientAuth</span>&nbsp;<span class="op" id="4429207">==</span>&nbsp;<span class="ident" id="4429210">NoClientCert</span>&nbsp;<span class="op" id="4429223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4429227">return</span>&nbsp;<span class="builtintype" id="4429234">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4429241">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4429245">return</span>&nbsp;<span class="builtintype" id="4429252">true</span><br>
<span class="lineno">290</span><span class="op" id="4429257">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4429260">func</span>&nbsp;<span class="op" id="4429265">(</span><span class="ident" id="4429266">hs</span>&nbsp;<span class="op" id="4429269">*</span><span class="ident" id="4429270">serverHandshakeState</span><span class="op" id="4429290">)</span>&nbsp;<span class="ident" id="4429292">doResumeHandshake</span><span class="op" id="4429309">(</span><span class="op" id="4429310">)</span>&nbsp;<span class="builtintype" id="4429312">error</span>&nbsp;<span class="op" id="4429318">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4429321">c</span>&nbsp;<span class="op" id="4429323">:=</span>&nbsp;<span class="ident" id="4429326">hs</span><span class="op" id="4429328">.</span><span class="ident" id="4429329">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4429333">hs</span><span class="op" id="4429335">.</span><span class="ident" id="4429336">hello</span><span class="op" id="4429341">.</span><span class="ident" id="4429342">cipherSuite</span>&nbsp;<span class="op" id="4429354">=</span>&nbsp;<span class="ident" id="4429356">hs</span><span class="op" id="4429358">.</span><span class="ident" id="4429359">suite</span><span class="op" id="4429364">.</span><span class="ident" id="4429365">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4429369">//&nbsp;We&nbsp;echo&nbsp;the&nbsp;client&#39;s&nbsp;session&nbsp;ID&nbsp;in&nbsp;the&nbsp;ServerHello&nbsp;to&nbsp;let&nbsp;it&nbsp;know</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4429439">//&nbsp;that&nbsp;we&#39;re&nbsp;doing&nbsp;a&nbsp;resumption.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4429474">hs</span><span class="op" id="4429476">.</span><span class="ident" id="4429477">hello</span><span class="op" id="4429482">.</span><span class="ident" id="4429483">sessionId</span>&nbsp;<span class="op" id="4429493">=</span>&nbsp;<span class="ident" id="4429495">hs</span><span class="op" id="4429497">.</span><span class="ident" id="4429498">clientHello</span><span class="op" id="4429509">.</span><span class="ident" id="4429510">sessionId</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4429521">hs</span><span class="op" id="4429523">.</span><span class="ident" id="4429524">finishedHash</span><span class="op" id="4429536">.</span><span class="ident" id="4429537">Write</span><span class="op" id="4429542">(</span><span class="ident" id="4429543">hs</span><span class="op" id="4429545">.</span><span class="ident" id="4429546">hello</span><span class="op" id="4429551">.</span><span class="ident" id="4429552">marshal</span><span class="op" id="4429559">(</span><span class="op" id="4429560">)</span><span class="op" id="4429561">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4429564">c</span><span class="op" id="4429565">.</span><span class="ident" id="4429566">writeRecord</span><span class="op" id="4429577">(</span><span class="ident" id="4429578">recordTypeHandshake</span><span class="op" id="4429597">,</span>&nbsp;<span class="ident" id="4429599">hs</span><span class="op" id="4429601">.</span><span class="ident" id="4429602">hello</span><span class="op" id="4429607">.</span><span class="ident" id="4429608">marshal</span><span class="op" id="4429615">(</span><span class="op" id="4429616">)</span><span class="op" id="4429617">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4429621">if</span>&nbsp;<span class="builtinfunc" id="4429624">len</span><span class="op" id="4429627">(</span><span class="ident" id="4429628">hs</span><span class="op" id="4429630">.</span><span class="ident" id="4429631">sessionState</span><span class="op" id="4429643">.</span><span class="ident" id="4429644">certificates</span><span class="op" id="4429656">)</span>&nbsp;<span class="op" id="4429658">&gt;</span>&nbsp;<span class="num" id="4429660">0</span>&nbsp;<span class="op" id="4429662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4429666">if</span>&nbsp;<span class="ident" id="4429669">_</span><span class="op" id="4429670">,</span>&nbsp;<span class="ident" id="4429672">err</span>&nbsp;<span class="op" id="4429676">:=</span>&nbsp;<span class="ident" id="4429679">hs</span><span class="op" id="4429681">.</span><span class="ident" id="4429682">processCertsFromClient</span><span class="op" id="4429704">(</span><span class="ident" id="4429705">hs</span><span class="op" id="4429707">.</span><span class="ident" id="4429708">sessionState</span><span class="op" id="4429720">.</span><span class="ident" id="4429721">certificates</span><span class="op" id="4429733">)</span><span class="op" id="4429734">;</span>&nbsp;<span class="ident" id="4429736">err</span>&nbsp;<span class="op" id="4429740">!=</span>&nbsp;<span class="builtintype" id="4429743">nil</span>&nbsp;<span class="op" id="4429747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4429752">return</span>&nbsp;<span class="ident" id="4429759">err</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4429765">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4429768">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4429772">hs</span><span class="op" id="4429774">.</span><span class="ident" id="4429775">masterSecret</span>&nbsp;<span class="op" id="4429788">=</span>&nbsp;<span class="ident" id="4429790">hs</span><span class="op" id="4429792">.</span><span class="ident" id="4429793">sessionState</span><span class="op" id="4429805">.</span><span class="ident" id="4429806">masterSecret</span><br>
<span class="lineno"></span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4429821">return</span>&nbsp;<span class="builtintype" id="4429828">nil</span><br>
<span class="lineno"></span><span class="op" id="4429832">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4429835">func</span>&nbsp;<span class="op" id="4429840">(</span><span class="ident" id="4429841">hs</span>&nbsp;<span class="op" id="4429844">*</span><span class="ident" id="4429845">serverHandshakeState</span><span class="op" id="4429865">)</span>&nbsp;<span class="ident" id="4429867">doFullHandshake</span><span class="op" id="4429882">(</span><span class="op" id="4429883">)</span>&nbsp;<span class="builtintype" id="4429885">error</span>&nbsp;<span class="op" id="4429891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4429894">config</span>&nbsp;<span class="op" id="4429901">:=</span>&nbsp;<span class="ident" id="4429904">hs</span><span class="op" id="4429906">.</span><span class="ident" id="4429907">c</span><span class="op" id="4429908">.</span><span class="ident" id="4429909">config</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4429917">c</span>&nbsp;<span class="op" id="4429919">:=</span>&nbsp;<span class="ident" id="4429922">hs</span><span class="op" id="4429924">.</span><span class="ident" id="4429925">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4429929">if</span>&nbsp;<span class="ident" id="4429932">hs</span><span class="op" id="4429934">.</span><span class="ident" id="4429935">clientHello</span><span class="op" id="4429946">.</span><span class="ident" id="4429947">ocspStapling</span>&nbsp;<span class="op" id="4429960">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="4429963">len</span><span class="op" id="4429966">(</span><span class="ident" id="4429967">hs</span><span class="op" id="4429969">.</span><span class="ident" id="4429970">cert</span><span class="op" id="4429974">.</span><span class="ident" id="4429975">OCSPStaple</span><span class="op" id="4429985">)</span>&nbsp;<span class="op" id="4429987">&gt;</span>&nbsp;<span class="num" id="4429989">0</span>&nbsp;<span class="op" id="4429991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4429995">hs</span><span class="op" id="4429997">.</span><span class="ident" id="4429998">hello</span><span class="op" id="4430003">.</span><span class="ident" id="4430004">ocspStapling</span>&nbsp;<span class="op" id="4430017">=</span>&nbsp;<span class="builtintype" id="4430019">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4430025">}</span><br>
<span class="lineno">320</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4430029">hs</span><span class="op" id="4430031">.</span><span class="ident" id="4430032">hello</span><span class="op" id="4430037">.</span><span class="ident" id="4430038">ticketSupported</span>&nbsp;<span class="op" id="4430054">=</span>&nbsp;<span class="ident" id="4430056">hs</span><span class="op" id="4430058">.</span><span class="ident" id="4430059">clientHello</span><span class="op" id="4430070">.</span><span class="ident" id="4430071">ticketSupported</span>&nbsp;<span class="op" id="4430087">&amp;&amp;</span>&nbsp;<span class="op" id="4430090">!</span><span class="ident" id="4430091">config</span><span class="op" id="4430097">.</span><span class="ident" id="4430098">SessionTicketsDisabled</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4430122">hs</span><span class="op" id="4430124">.</span><span class="ident" id="4430125">hello</span><span class="op" id="4430130">.</span><span class="ident" id="4430131">cipherSuite</span>&nbsp;<span class="op" id="4430143">=</span>&nbsp;<span class="ident" id="4430145">hs</span><span class="op" id="4430147">.</span><span class="ident" id="4430148">suite</span><span class="op" id="4430153">.</span><span class="ident" id="4430154">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4430158">hs</span><span class="op" id="4430160">.</span><span class="ident" id="4430161">finishedHash</span><span class="op" id="4430173">.</span><span class="ident" id="4430174">Write</span><span class="op" id="4430179">(</span><span class="ident" id="4430180">hs</span><span class="op" id="4430182">.</span><span class="ident" id="4430183">hello</span><span class="op" id="4430188">.</span><span class="ident" id="4430189">marshal</span><span class="op" id="4430196">(</span><span class="op" id="4430197">)</span><span class="op" id="4430198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4430201">c</span><span class="op" id="4430202">.</span><span class="ident" id="4430203">writeRecord</span><span class="op" id="4430214">(</span><span class="ident" id="4430215">recordTypeHandshake</span><span class="op" id="4430234">,</span>&nbsp;<span class="ident" id="4430236">hs</span><span class="op" id="4430238">.</span><span class="ident" id="4430239">hello</span><span class="op" id="4430244">.</span><span class="ident" id="4430245">marshal</span><span class="op" id="4430252">(</span><span class="op" id="4430253">)</span><span class="op" id="4430254">)</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4430258">certMsg</span>&nbsp;<span class="op" id="4430266">:=</span>&nbsp;<span class="builtinfunc" id="4430269">new</span><span class="op" id="4430272">(</span><span class="ident" id="4430273">certificateMsg</span><span class="op" id="4430287">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4430290">certMsg</span><span class="op" id="4430297">.</span><span class="ident" id="4430298">certificates</span>&nbsp;<span class="op" id="4430311">=</span>&nbsp;<span class="ident" id="4430313">hs</span><span class="op" id="4430315">.</span><span class="ident" id="4430316">cert</span><span class="op" id="4430320">.</span><span class="ident" id="4430321">Certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4430334">hs</span><span class="op" id="4430336">.</span><span class="ident" id="4430337">finishedHash</span><span class="op" id="4430349">.</span><span class="ident" id="4430350">Write</span><span class="op" id="4430355">(</span><span class="ident" id="4430356">certMsg</span><span class="op" id="4430363">.</span><span class="ident" id="4430364">marshal</span><span class="op" id="4430371">(</span><span class="op" id="4430372">)</span><span class="op" id="4430373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4430376">c</span><span class="op" id="4430377">.</span><span class="ident" id="4430378">writeRecord</span><span class="op" id="4430389">(</span><span class="ident" id="4430390">recordTypeHandshake</span><span class="op" id="4430409">,</span>&nbsp;<span class="ident" id="4430411">certMsg</span><span class="op" id="4430418">.</span><span class="ident" id="4430419">marshal</span><span class="op" id="4430426">(</span><span class="op" id="4430427">)</span><span class="op" id="4430428">)</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4430432">if</span>&nbsp;<span class="ident" id="4430435">hs</span><span class="op" id="4430437">.</span><span class="ident" id="4430438">hello</span><span class="op" id="4430443">.</span><span class="ident" id="4430444">ocspStapling</span>&nbsp;<span class="op" id="4430457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4430461">certStatus</span>&nbsp;<span class="op" id="4430472">:=</span>&nbsp;<span class="builtinfunc" id="4430475">new</span><span class="op" id="4430478">(</span><span class="ident" id="4430479">certificateStatusMsg</span><span class="op" id="4430499">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4430503">certStatus</span><span class="op" id="4430513">.</span><span class="ident" id="4430514">statusType</span>&nbsp;<span class="op" id="4430525">=</span>&nbsp;<span class="ident" id="4430527">statusTypeOCSP</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4430544">certStatus</span><span class="op" id="4430554">.</span><span class="ident" id="4430555">response</span>&nbsp;<span class="op" id="4430564">=</span>&nbsp;<span class="ident" id="4430566">hs</span><span class="op" id="4430568">.</span><span class="ident" id="4430569">cert</span><span class="op" id="4430573">.</span><span class="ident" id="4430574">OCSPStaple</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4430587">hs</span><span class="op" id="4430589">.</span><span class="ident" id="4430590">finishedHash</span><span class="op" id="4430602">.</span><span class="ident" id="4430603">Write</span><span class="op" id="4430608">(</span><span class="ident" id="4430609">certStatus</span><span class="op" id="4430619">.</span><span class="ident" id="4430620">marshal</span><span class="op" id="4430627">(</span><span class="op" id="4430628">)</span><span class="op" id="4430629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4430633">c</span><span class="op" id="4430634">.</span><span class="ident" id="4430635">writeRecord</span><span class="op" id="4430646">(</span><span class="ident" id="4430647">recordTypeHandshake</span><span class="op" id="4430666">,</span>&nbsp;<span class="ident" id="4430668">certStatus</span><span class="op" id="4430678">.</span><span class="ident" id="4430679">marshal</span><span class="op" id="4430686">(</span><span class="op" id="4430687">)</span><span class="op" id="4430688">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4430691">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4430695">keyAgreement</span>&nbsp;<span class="op" id="4430708">:=</span>&nbsp;<span class="ident" id="4430711">hs</span><span class="op" id="4430713">.</span><span class="ident" id="4430714">suite</span><span class="op" id="4430719">.</span><span class="ident" id="4430720">ka</span><span class="op" id="4430722">(</span><span class="ident" id="4430723">c</span><span class="op" id="4430724">.</span><span class="ident" id="4430725">vers</span><span class="op" id="4430729">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4430732">skx</span><span class="op" id="4430735">,</span>&nbsp;<span class="ident" id="4430737">err</span>&nbsp;<span class="op" id="4430741">:=</span>&nbsp;<span class="ident" id="4430744">keyAgreement</span><span class="op" id="4430756">.</span><span class="ident" id="4430757">generateServerKeyExchange</span><span class="op" id="4430782">(</span><span class="ident" id="4430783">config</span><span class="op" id="4430789">,</span>&nbsp;<span class="ident" id="4430791">hs</span><span class="op" id="4430793">.</span><span class="ident" id="4430794">cert</span><span class="op" id="4430798">,</span>&nbsp;<span class="ident" id="4430800">hs</span><span class="op" id="4430802">.</span><span class="ident" id="4430803">clientHello</span><span class="op" id="4430814">,</span>&nbsp;<span class="ident" id="4430816">hs</span><span class="op" id="4430818">.</span><span class="ident" id="4430819">hello</span><span class="op" id="4430824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4430827">if</span>&nbsp;<span class="ident" id="4430830">err</span>&nbsp;<span class="op" id="4430834">!=</span>&nbsp;<span class="builtintype" id="4430837">nil</span>&nbsp;<span class="op" id="4430841">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4430845">c</span><span class="op" id="4430846">.</span><span class="ident" id="4430847">sendAlert</span><span class="op" id="4430856">(</span><span class="ident" id="4430857">alertHandshakeFailure</span><span class="op" id="4430878">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4430882">return</span>&nbsp;<span class="ident" id="4430889">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4430894">}</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4430897">if</span>&nbsp;<span class="ident" id="4430900">skx</span>&nbsp;<span class="op" id="4430904">!=</span>&nbsp;<span class="builtintype" id="4430907">nil</span>&nbsp;<span class="op" id="4430911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4430915">hs</span><span class="op" id="4430917">.</span><span class="ident" id="4430918">finishedHash</span><span class="op" id="4430930">.</span><span class="ident" id="4430931">Write</span><span class="op" id="4430936">(</span><span class="ident" id="4430937">skx</span><span class="op" id="4430940">.</span><span class="ident" id="4430941">marshal</span><span class="op" id="4430948">(</span><span class="op" id="4430949">)</span><span class="op" id="4430950">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4430954">c</span><span class="op" id="4430955">.</span><span class="ident" id="4430956">writeRecord</span><span class="op" id="4430967">(</span><span class="ident" id="4430968">recordTypeHandshake</span><span class="op" id="4430987">,</span>&nbsp;<span class="ident" id="4430989">skx</span><span class="op" id="4430992">.</span><span class="ident" id="4430993">marshal</span><span class="op" id="4431000">(</span><span class="op" id="4431001">)</span><span class="op" id="4431002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4431005">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4431009">if</span>&nbsp;<span class="ident" id="4431012">config</span><span class="op" id="4431018">.</span><span class="ident" id="4431019">ClientAuth</span>&nbsp;<span class="op" id="4431030">&gt;=</span>&nbsp;<span class="ident" id="4431033">RequestClientCert</span>&nbsp;<span class="op" id="4431051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4431055">//&nbsp;Request&nbsp;a&nbsp;client&nbsp;certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4431089">certReq</span>&nbsp;<span class="op" id="4431097">:=</span>&nbsp;<span class="builtinfunc" id="4431100">new</span><span class="op" id="4431103">(</span><span class="ident" id="4431104">certificateRequestMsg</span><span class="op" id="4431125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4431129">certReq</span><span class="op" id="4431136">.</span><span class="ident" id="4431137">certificateTypes</span>&nbsp;<span class="op" id="4431154">=</span>&nbsp;<span class="op" id="4431156">[</span><span class="op" id="4431157">]</span><span class="builtintype" id="4431158">byte</span><span class="op" id="4431162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4431167">byte</span><span class="op" id="4431171">(</span><span class="ident" id="4431172">certTypeRSASign</span><span class="op" id="4431187">)</span><span class="op" id="4431188">,</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4431193">byte</span><span class="op" id="4431197">(</span><span class="ident" id="4431198">certTypeECDSASign</span><span class="op" id="4431215">)</span><span class="op" id="4431216">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4431220">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4431224">if</span>&nbsp;<span class="ident" id="4431227">c</span><span class="op" id="4431228">.</span><span class="ident" id="4431229">vers</span>&nbsp;<span class="op" id="4431234">&gt;=</span>&nbsp;<span class="ident" id="4431237">VersionTLS12</span>&nbsp;<span class="op" id="4431250">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4431255">certReq</span><span class="op" id="4431262">.</span><span class="ident" id="4431263">hasSignatureAndHash</span>&nbsp;<span class="op" id="4431283">=</span>&nbsp;<span class="builtintype" id="4431285">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4431293">certReq</span><span class="op" id="4431300">.</span><span class="ident" id="4431301">signatureAndHashes</span>&nbsp;<span class="op" id="4431320">=</span>&nbsp;<span class="ident" id="4431322">supportedClientCertSignatureAlgorithms</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4431363">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4431368">//&nbsp;An&nbsp;empty&nbsp;list&nbsp;of&nbsp;certificateAuthorities&nbsp;signals&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4431424">//&nbsp;the&nbsp;client&nbsp;that&nbsp;it&nbsp;may&nbsp;send&nbsp;any&nbsp;certificate&nbsp;in&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4431485">//&nbsp;to&nbsp;our&nbsp;request.&nbsp;When&nbsp;we&nbsp;know&nbsp;the&nbsp;CAs&nbsp;we&nbsp;trust,&nbsp;then</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4431542">//&nbsp;we&nbsp;can&nbsp;send&nbsp;them&nbsp;down,&nbsp;so&nbsp;that&nbsp;the&nbsp;client&nbsp;can&nbsp;choose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4431600">//&nbsp;an&nbsp;appropriate&nbsp;certificate&nbsp;to&nbsp;give&nbsp;to&nbsp;us.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4431647">if</span>&nbsp;<span class="ident" id="4431650">config</span><span class="op" id="4431656">.</span><span class="ident" id="4431657">ClientCAs</span>&nbsp;<span class="op" id="4431667">!=</span>&nbsp;<span class="builtintype" id="4431670">nil</span>&nbsp;<span class="op" id="4431674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4431679">certReq</span><span class="op" id="4431686">.</span><span class="ident" id="4431687">certificateAuthorities</span>&nbsp;<span class="op" id="4431710">=</span>&nbsp;<span class="ident" id="4431712">config</span><span class="op" id="4431718">.</span><span class="ident" id="4431719">ClientCAs</span><span class="op" id="4431728">.</span><span class="ident" id="4431729">Subjects</span><span class="op" id="4431737">(</span><span class="op" id="4431738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4431742">}</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4431746">hs</span><span class="op" id="4431748">.</span><span class="ident" id="4431749">finishedHash</span><span class="op" id="4431761">.</span><span class="ident" id="4431762">Write</span><span class="op" id="4431767">(</span><span class="ident" id="4431768">certReq</span><span class="op" id="4431775">.</span><span class="ident" id="4431776">marshal</span><span class="op" id="4431783">(</span><span class="op" id="4431784">)</span><span class="op" id="4431785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4431789">c</span><span class="op" id="4431790">.</span><span class="ident" id="4431791">writeRecord</span><span class="op" id="4431802">(</span><span class="ident" id="4431803">recordTypeHandshake</span><span class="op" id="4431822">,</span>&nbsp;<span class="ident" id="4431824">certReq</span><span class="op" id="4431831">.</span><span class="ident" id="4431832">marshal</span><span class="op" id="4431839">(</span><span class="op" id="4431840">)</span><span class="op" id="4431841">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4431844">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4431848">helloDone</span>&nbsp;<span class="op" id="4431858">:=</span>&nbsp;<span class="builtinfunc" id="4431861">new</span><span class="op" id="4431864">(</span><span class="ident" id="4431865">serverHelloDoneMsg</span><span class="op" id="4431883">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4431886">hs</span><span class="op" id="4431888">.</span><span class="ident" id="4431889">finishedHash</span><span class="op" id="4431901">.</span><span class="ident" id="4431902">Write</span><span class="op" id="4431907">(</span><span class="ident" id="4431908">helloDone</span><span class="op" id="4431917">.</span><span class="ident" id="4431918">marshal</span><span class="op" id="4431925">(</span><span class="op" id="4431926">)</span><span class="op" id="4431927">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4431930">c</span><span class="op" id="4431931">.</span><span class="ident" id="4431932">writeRecord</span><span class="op" id="4431943">(</span><span class="ident" id="4431944">recordTypeHandshake</span><span class="op" id="4431963">,</span>&nbsp;<span class="ident" id="4431965">helloDone</span><span class="op" id="4431974">.</span><span class="ident" id="4431975">marshal</span><span class="op" id="4431982">(</span><span class="op" id="4431983">)</span><span class="op" id="4431984">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4431988">var</span>&nbsp;<span class="ident" id="4431992">pub</span>&nbsp;<span class="ident" id="4431996">crypto</span><span class="op" id="4432002">.</span><span class="ident" id="4432003">PublicKey</span>&nbsp;<span class="comment" id="4432013">//&nbsp;public&nbsp;key&nbsp;for&nbsp;client&nbsp;auth,&nbsp;if&nbsp;any</span><br>
<span class="lineno"></span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4432053">msg</span><span class="op" id="4432056">,</span>&nbsp;<span class="ident" id="4432058">err</span>&nbsp;<span class="op" id="4432062">:=</span>&nbsp;<span class="ident" id="4432065">c</span><span class="op" id="4432066">.</span><span class="ident" id="4432067">readHandshake</span><span class="op" id="4432080">(</span><span class="op" id="4432081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4432084">if</span>&nbsp;<span class="ident" id="4432087">err</span>&nbsp;<span class="op" id="4432091">!=</span>&nbsp;<span class="builtintype" id="4432094">nil</span>&nbsp;<span class="op" id="4432098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4432102">return</span>&nbsp;<span class="ident" id="4432109">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4432114">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4432118">var</span>&nbsp;<span class="ident" id="4432122">ok</span>&nbsp;<span class="builtintype" id="4432125">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4432131">//&nbsp;If&nbsp;we&nbsp;requested&nbsp;a&nbsp;client&nbsp;certificate,&nbsp;then&nbsp;the&nbsp;client&nbsp;must&nbsp;send&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4432201">//&nbsp;certificate&nbsp;message,&nbsp;even&nbsp;if&nbsp;it&#39;s&nbsp;empty.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4432246">if</span>&nbsp;<span class="ident" id="4432249">config</span><span class="op" id="4432255">.</span><span class="ident" id="4432256">ClientAuth</span>&nbsp;<span class="op" id="4432267">&gt;=</span>&nbsp;<span class="ident" id="4432270">RequestClientCert</span>&nbsp;<span class="op" id="4432288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4432292">if</span>&nbsp;<span class="ident" id="4432295">certMsg</span><span class="op" id="4432302">,</span>&nbsp;<span class="ident" id="4432304">ok</span>&nbsp;<span class="op" id="4432307">=</span>&nbsp;<span class="ident" id="4432309">msg</span><span class="op" id="4432312">.</span><span class="op" id="4432313">(</span><span class="op" id="4432314">*</span><span class="ident" id="4432315">certificateMsg</span><span class="op" id="4432329">)</span><span class="op" id="4432330">;</span>&nbsp;<span class="op" id="4432332">!</span><span class="ident" id="4432333">ok</span>&nbsp;<span class="op" id="4432336">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4432341">c</span><span class="op" id="4432342">.</span><span class="ident" id="4432343">sendAlert</span><span class="op" id="4432352">(</span><span class="ident" id="4432353">alertUnexpectedMessage</span><span class="op" id="4432375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4432380">return</span>&nbsp;<span class="ident" id="4432387">unexpectedMessageError</span><span class="op" id="4432409">(</span><span class="ident" id="4432410">certMsg</span><span class="op" id="4432417">,</span>&nbsp;<span class="ident" id="4432419">msg</span><span class="op" id="4432422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4432426">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4432430">hs</span><span class="op" id="4432432">.</span><span class="ident" id="4432433">finishedHash</span><span class="op" id="4432445">.</span><span class="ident" id="4432446">Write</span><span class="op" id="4432451">(</span><span class="ident" id="4432452">certMsg</span><span class="op" id="4432459">.</span><span class="ident" id="4432460">marshal</span><span class="op" id="4432467">(</span><span class="op" id="4432468">)</span><span class="op" id="4432469">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4432474">if</span>&nbsp;<span class="builtinfunc" id="4432477">len</span><span class="op" id="4432480">(</span><span class="ident" id="4432481">certMsg</span><span class="op" id="4432488">.</span><span class="ident" id="4432489">certificates</span><span class="op" id="4432501">)</span>&nbsp;<span class="op" id="4432503">==</span>&nbsp;<span class="num" id="4432506">0</span>&nbsp;<span class="op" id="4432508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4432513">//&nbsp;The&nbsp;client&nbsp;didn&#39;t&nbsp;actually&nbsp;send&nbsp;a&nbsp;certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4432565">switch</span>&nbsp;<span class="ident" id="4432572">config</span><span class="op" id="4432578">.</span><span class="ident" id="4432579">ClientAuth</span>&nbsp;<span class="op" id="4432590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4432595">case</span>&nbsp;<span class="ident" id="4432600">RequireAnyClientCert</span><span class="op" id="4432620">,</span>&nbsp;<span class="ident" id="4432622">RequireAndVerifyClientCert</span><span class="op" id="4432648">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4432654">c</span><span class="op" id="4432655">.</span><span class="ident" id="4432656">sendAlert</span><span class="op" id="4432665">(</span><span class="ident" id="4432666">alertBadCertificate</span><span class="op" id="4432685">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4432691">return</span>&nbsp;<span class="ident" id="4432698">errors</span><span class="op" id="4432704">.</span><span class="ident" id="4432705">New</span><span class="op" id="4432708">(</span><span class="string" id="4432709">&#34;tls:&nbsp;client&nbsp;didn&#39;t&nbsp;provide&nbsp;a&nbsp;certificate&#34;</span><span class="op" id="4432751">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4432756">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4432760">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4432765">pub</span><span class="op" id="4432768">,</span>&nbsp;<span class="ident" id="4432770">err</span>&nbsp;<span class="op" id="4432774">=</span>&nbsp;<span class="ident" id="4432776">hs</span><span class="op" id="4432778">.</span><span class="ident" id="4432779">processCertsFromClient</span><span class="op" id="4432801">(</span><span class="ident" id="4432802">certMsg</span><span class="op" id="4432809">.</span><span class="ident" id="4432810">certificates</span><span class="op" id="4432822">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4432826">if</span>&nbsp;<span class="ident" id="4432829">err</span>&nbsp;<span class="op" id="4432833">!=</span>&nbsp;<span class="builtintype" id="4432836">nil</span>&nbsp;<span class="op" id="4432840">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4432845">return</span>&nbsp;<span class="ident" id="4432852">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4432858">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4432863">msg</span><span class="op" id="4432866">,</span>&nbsp;<span class="ident" id="4432868">err</span>&nbsp;<span class="op" id="4432872">=</span>&nbsp;<span class="ident" id="4432874">c</span><span class="op" id="4432875">.</span><span class="ident" id="4432876">readHandshake</span><span class="op" id="4432889">(</span><span class="op" id="4432890">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4432894">if</span>&nbsp;<span class="ident" id="4432897">err</span>&nbsp;<span class="op" id="4432901">!=</span>&nbsp;<span class="builtintype" id="4432904">nil</span>&nbsp;<span class="op" id="4432908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4432913">return</span>&nbsp;<span class="ident" id="4432920">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4432926">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4432929">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4432933">//&nbsp;Get&nbsp;client&nbsp;key&nbsp;exchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4432961">ckx</span><span class="op" id="4432964">,</span>&nbsp;<span class="ident" id="4432966">ok</span>&nbsp;<span class="op" id="4432969">:=</span>&nbsp;<span class="ident" id="4432972">msg</span><span class="op" id="4432975">.</span><span class="op" id="4432976">(</span><span class="op" id="4432977">*</span><span class="ident" id="4432978">clientKeyExchangeMsg</span><span class="op" id="4432998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4433001">if</span>&nbsp;<span class="op" id="4433004">!</span><span class="ident" id="4433005">ok</span>&nbsp;<span class="op" id="4433008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4433012">c</span><span class="op" id="4433013">.</span><span class="ident" id="4433014">sendAlert</span><span class="op" id="4433023">(</span><span class="ident" id="4433024">alertUnexpectedMessage</span><span class="op" id="4433046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4433050">return</span>&nbsp;<span class="ident" id="4433057">unexpectedMessageError</span><span class="op" id="4433079">(</span><span class="ident" id="4433080">ckx</span><span class="op" id="4433083">,</span>&nbsp;<span class="ident" id="4433085">msg</span><span class="op" id="4433088">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4433091">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4433094">hs</span><span class="op" id="4433096">.</span><span class="ident" id="4433097">finishedHash</span><span class="op" id="4433109">.</span><span class="ident" id="4433110">Write</span><span class="op" id="4433115">(</span><span class="ident" id="4433116">ckx</span><span class="op" id="4433119">.</span><span class="ident" id="4433120">marshal</span><span class="op" id="4433127">(</span><span class="op" id="4433128">)</span><span class="op" id="4433129">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4433133">//&nbsp;If&nbsp;we&nbsp;received&nbsp;a&nbsp;client&nbsp;cert&nbsp;in&nbsp;response&nbsp;to&nbsp;our&nbsp;certificate&nbsp;request&nbsp;message,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4433214">//&nbsp;the&nbsp;client&nbsp;will&nbsp;send&nbsp;us&nbsp;a&nbsp;certificateVerifyMsg&nbsp;immediately&nbsp;after&nbsp;the</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4433287">//&nbsp;clientKeyExchangeMsg.&nbsp;&nbsp;This&nbsp;message&nbsp;is&nbsp;a&nbsp;digest&nbsp;of&nbsp;all&nbsp;preceding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4433356">//&nbsp;handshake-layer&nbsp;messages&nbsp;that&nbsp;is&nbsp;signed&nbsp;using&nbsp;the&nbsp;private&nbsp;key&nbsp;corresponding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4433436">//&nbsp;to&nbsp;the&nbsp;client&#39;s&nbsp;certificate.&nbsp;This&nbsp;allows&nbsp;us&nbsp;to&nbsp;verify&nbsp;that&nbsp;the&nbsp;client&nbsp;is&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4433516">//&nbsp;possession&nbsp;of&nbsp;the&nbsp;private&nbsp;key&nbsp;of&nbsp;the&nbsp;certificate.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4433570">if</span>&nbsp;<span class="builtinfunc" id="4433573">len</span><span class="op" id="4433576">(</span><span class="ident" id="4433577">c</span><span class="op" id="4433578">.</span><span class="ident" id="4433579">peerCertificates</span><span class="op" id="4433595">)</span>&nbsp;<span class="op" id="4433597">&gt;</span>&nbsp;<span class="num" id="4433599">0</span>&nbsp;<span class="op" id="4433601">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4433605">msg</span><span class="op" id="4433608">,</span>&nbsp;<span class="ident" id="4433610">err</span>&nbsp;<span class="op" id="4433614">=</span>&nbsp;<span class="ident" id="4433616">c</span><span class="op" id="4433617">.</span><span class="ident" id="4433618">readHandshake</span><span class="op" id="4433631">(</span><span class="op" id="4433632">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4433636">if</span>&nbsp;<span class="ident" id="4433639">err</span>&nbsp;<span class="op" id="4433643">!=</span>&nbsp;<span class="builtintype" id="4433646">nil</span>&nbsp;<span class="op" id="4433650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4433655">return</span>&nbsp;<span class="ident" id="4433662">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4433668">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4433672">certVerify</span><span class="op" id="4433682">,</span>&nbsp;<span class="ident" id="4433684">ok</span>&nbsp;<span class="op" id="4433687">:=</span>&nbsp;<span class="ident" id="4433690">msg</span><span class="op" id="4433693">.</span><span class="op" id="4433694">(</span><span class="op" id="4433695">*</span><span class="ident" id="4433696">certificateVerifyMsg</span><span class="op" id="4433716">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4433720">if</span>&nbsp;<span class="op" id="4433723">!</span><span class="ident" id="4433724">ok</span>&nbsp;<span class="op" id="4433727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4433732">c</span><span class="op" id="4433733">.</span><span class="ident" id="4433734">sendAlert</span><span class="op" id="4433743">(</span><span class="ident" id="4433744">alertUnexpectedMessage</span><span class="op" id="4433766">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4433771">return</span>&nbsp;<span class="ident" id="4433778">unexpectedMessageError</span><span class="op" id="4433800">(</span><span class="ident" id="4433801">certVerify</span><span class="op" id="4433811">,</span>&nbsp;<span class="ident" id="4433813">msg</span><span class="op" id="4433816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4433820">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4433825">switch</span>&nbsp;<span class="ident" id="4433832">key</span>&nbsp;<span class="op" id="4433836">:=</span>&nbsp;<span class="ident" id="4433839">pub</span><span class="op" id="4433842">.</span><span class="op" id="4433843">(</span><span class="keyword" id="4433844">type</span><span class="op" id="4433848">)</span>&nbsp;<span class="op" id="4433850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4433854">case</span>&nbsp;<span class="op" id="4433859">*</span><span class="ident" id="4433860">ecdsa</span><span class="op" id="4433865">.</span><span class="ident" id="4433866">PublicKey</span><span class="op" id="4433875">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4433880">ecdsaSig</span>&nbsp;<span class="op" id="4433889">:=</span>&nbsp;<span class="builtinfunc" id="4433892">new</span><span class="op" id="4433895">(</span><span class="ident" id="4433896">ecdsaSignature</span><span class="op" id="4433910">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4433915">if</span>&nbsp;<span class="ident" id="4433918">_</span><span class="op" id="4433919">,</span>&nbsp;<span class="ident" id="4433921">err</span>&nbsp;<span class="op" id="4433925">=</span>&nbsp;<span class="ident" id="4433927">asn1</span><span class="op" id="4433931">.</span><span class="ident" id="4433932">Unmarshal</span><span class="op" id="4433941">(</span><span class="ident" id="4433942">certVerify</span><span class="op" id="4433952">.</span><span class="ident" id="4433953">signature</span><span class="op" id="4433962">,</span>&nbsp;<span class="ident" id="4433964">ecdsaSig</span><span class="op" id="4433972">)</span><span class="op" id="4433973">;</span>&nbsp;<span class="ident" id="4433975">err</span>&nbsp;<span class="op" id="4433979">!=</span>&nbsp;<span class="builtintype" id="4433982">nil</span>&nbsp;<span class="op" id="4433986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4433992">break</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4434001">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4434006">if</span>&nbsp;<span class="ident" id="4434009">ecdsaSig</span><span class="op" id="4434017">.</span><span class="ident" id="4434018">R</span><span class="op" id="4434019">.</span><span class="ident" id="4434020">Sign</span><span class="op" id="4434024">(</span><span class="op" id="4434025">)</span>&nbsp;<span class="op" id="4434027">&lt;=</span>&nbsp;<span class="num" id="4434030">0</span>&nbsp;<span class="op" id="4434032">||</span>&nbsp;<span class="ident" id="4434035">ecdsaSig</span><span class="op" id="4434043">.</span><span class="ident" id="4434044">S</span><span class="op" id="4434045">.</span><span class="ident" id="4434046">Sign</span><span class="op" id="4434050">(</span><span class="op" id="4434051">)</span>&nbsp;<span class="op" id="4434053">&lt;=</span>&nbsp;<span class="num" id="4434056">0</span>&nbsp;<span class="op" id="4434058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4434064">err</span>&nbsp;<span class="op" id="4434068">=</span>&nbsp;<span class="ident" id="4434070">errors</span><span class="op" id="4434076">.</span><span class="ident" id="4434077">New</span><span class="op" id="4434080">(</span><span class="string" id="4434081">&#34;ECDSA&nbsp;signature&nbsp;contained&nbsp;zero&nbsp;or&nbsp;negative&nbsp;values&#34;</span><span class="op" id="4434132">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4434138">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4434147">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4434152">digest</span><span class="op" id="4434158">,</span>&nbsp;<span class="ident" id="4434160">_</span><span class="op" id="4434161">,</span>&nbsp;<span class="ident" id="4434163">_</span>&nbsp;<span class="op" id="4434165">:=</span>&nbsp;<span class="ident" id="4434168">hs</span><span class="op" id="4434170">.</span><span class="ident" id="4434171">finishedHash</span><span class="op" id="4434183">.</span><span class="ident" id="4434184">hashForClientCertificate</span><span class="op" id="4434208">(</span><span class="ident" id="4434209">signatureECDSA</span><span class="op" id="4434223">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4434228">if</span>&nbsp;<span class="op" id="4434231">!</span><span class="ident" id="4434232">ecdsa</span><span class="op" id="4434237">.</span><span class="ident" id="4434238">Verify</span><span class="op" id="4434244">(</span><span class="ident" id="4434245">key</span><span class="op" id="4434248">,</span>&nbsp;<span class="ident" id="4434250">digest</span><span class="op" id="4434256">,</span>&nbsp;<span class="ident" id="4434258">ecdsaSig</span><span class="op" id="4434266">.</span><span class="ident" id="4434267">R</span><span class="op" id="4434268">,</span>&nbsp;<span class="ident" id="4434270">ecdsaSig</span><span class="op" id="4434278">.</span><span class="ident" id="4434279">S</span><span class="op" id="4434280">)</span>&nbsp;<span class="op" id="4434282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4434288">err</span>&nbsp;<span class="op" id="4434292">=</span>&nbsp;<span class="ident" id="4434294">errors</span><span class="op" id="4434300">.</span><span class="ident" id="4434301">New</span><span class="op" id="4434304">(</span><span class="string" id="4434305">&#34;ECDSA&nbsp;verification&nbsp;failure&#34;</span><span class="op" id="4434333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4434339">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4434348">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4434352">case</span>&nbsp;<span class="op" id="4434357">*</span><span class="ident" id="4434358">rsa</span><span class="op" id="4434361">.</span><span class="ident" id="4434362">PublicKey</span><span class="op" id="4434371">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4434376">digest</span><span class="op" id="4434382">,</span>&nbsp;<span class="ident" id="4434384">hashFunc</span><span class="op" id="4434392">,</span>&nbsp;<span class="ident" id="4434394">_</span>&nbsp;<span class="op" id="4434396">:=</span>&nbsp;<span class="ident" id="4434399">hs</span><span class="op" id="4434401">.</span><span class="ident" id="4434402">finishedHash</span><span class="op" id="4434414">.</span><span class="ident" id="4434415">hashForClientCertificate</span><span class="op" id="4434439">(</span><span class="ident" id="4434440">signatureRSA</span><span class="op" id="4434452">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4434457">err</span>&nbsp;<span class="op" id="4434461">=</span>&nbsp;<span class="ident" id="4434463">rsa</span><span class="op" id="4434466">.</span><span class="ident" id="4434467">VerifyPKCS1v15</span><span class="op" id="4434481">(</span><span class="ident" id="4434482">key</span><span class="op" id="4434485">,</span>&nbsp;<span class="ident" id="4434487">hashFunc</span><span class="op" id="4434495">,</span>&nbsp;<span class="ident" id="4434497">digest</span><span class="op" id="4434503">,</span>&nbsp;<span class="ident" id="4434505">certVerify</span><span class="op" id="4434515">.</span><span class="ident" id="4434516">signature</span><span class="op" id="4434525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4434529">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4434533">if</span>&nbsp;<span class="ident" id="4434536">err</span>&nbsp;<span class="op" id="4434540">!=</span>&nbsp;<span class="builtintype" id="4434543">nil</span>&nbsp;<span class="op" id="4434547">{</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4434552">c</span><span class="op" id="4434553">.</span><span class="ident" id="4434554">sendAlert</span><span class="op" id="4434563">(</span><span class="ident" id="4434564">alertBadCertificate</span><span class="op" id="4434583">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4434588">return</span>&nbsp;<span class="ident" id="4434595">errors</span><span class="op" id="4434601">.</span><span class="ident" id="4434602">New</span><span class="op" id="4434605">(</span><span class="string" id="4434606">&#34;could&nbsp;not&nbsp;validate&nbsp;signature&nbsp;of&nbsp;connection&nbsp;nonces:&nbsp;&#34;</span>&nbsp;<span class="op" id="4434660">+</span>&nbsp;<span class="ident" id="4434662">err</span><span class="op" id="4434665">.</span><span class="ident" id="4434666">Error</span><span class="op" id="4434671">(</span><span class="op" id="4434672">)</span><span class="op" id="4434673">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4434677">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4434682">hs</span><span class="op" id="4434684">.</span><span class="ident" id="4434685">finishedHash</span><span class="op" id="4434697">.</span><span class="ident" id="4434698">Write</span><span class="op" id="4434703">(</span><span class="ident" id="4434704">certVerify</span><span class="op" id="4434714">.</span><span class="ident" id="4434715">marshal</span><span class="op" id="4434722">(</span><span class="op" id="4434723">)</span><span class="op" id="4434724">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4434727">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4434731">preMasterSecret</span><span class="op" id="4434746">,</span>&nbsp;<span class="ident" id="4434748">err</span>&nbsp;<span class="op" id="4434752">:=</span>&nbsp;<span class="ident" id="4434755">keyAgreement</span><span class="op" id="4434767">.</span><span class="ident" id="4434768">processClientKeyExchange</span><span class="op" id="4434792">(</span><span class="ident" id="4434793">config</span><span class="op" id="4434799">,</span>&nbsp;<span class="ident" id="4434801">hs</span><span class="op" id="4434803">.</span><span class="ident" id="4434804">cert</span><span class="op" id="4434808">,</span>&nbsp;<span class="ident" id="4434810">ckx</span><span class="op" id="4434813">,</span>&nbsp;<span class="ident" id="4434815">c</span><span class="op" id="4434816">.</span><span class="ident" id="4434817">vers</span><span class="op" id="4434821">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4434824">if</span>&nbsp;<span class="ident" id="4434827">err</span>&nbsp;<span class="op" id="4434831">!=</span>&nbsp;<span class="builtintype" id="4434834">nil</span>&nbsp;<span class="op" id="4434838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4434842">c</span><span class="op" id="4434843">.</span><span class="ident" id="4434844">sendAlert</span><span class="op" id="4434853">(</span><span class="ident" id="4434854">alertHandshakeFailure</span><span class="op" id="4434875">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4434879">return</span>&nbsp;<span class="ident" id="4434886">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4434891">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4434894">hs</span><span class="op" id="4434896">.</span><span class="ident" id="4434897">masterSecret</span>&nbsp;<span class="op" id="4434910">=</span>&nbsp;<span class="ident" id="4434912">masterFromPreMasterSecret</span><span class="op" id="4434937">(</span><span class="ident" id="4434938">c</span><span class="op" id="4434939">.</span><span class="ident" id="4434940">vers</span><span class="op" id="4434944">,</span>&nbsp;<span class="ident" id="4434946">preMasterSecret</span><span class="op" id="4434961">,</span>&nbsp;<span class="ident" id="4434963">hs</span><span class="op" id="4434965">.</span><span class="ident" id="4434966">clientHello</span><span class="op" id="4434977">.</span><span class="ident" id="4434978">random</span><span class="op" id="4434984">,</span>&nbsp;<span class="ident" id="4434986">hs</span><span class="op" id="4434988">.</span><span class="ident" id="4434989">hello</span><span class="op" id="4434994">.</span><span class="ident" id="4434995">random</span><span class="op" id="4435001">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4435005">return</span>&nbsp;<span class="builtintype" id="4435012">nil</span><br>
<span class="lineno">475</span><span class="op" id="4435016">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4435019">func</span>&nbsp;<span class="op" id="4435024">(</span><span class="ident" id="4435025">hs</span>&nbsp;<span class="op" id="4435028">*</span><span class="ident" id="4435029">serverHandshakeState</span><span class="op" id="4435049">)</span>&nbsp;<span class="ident" id="4435051">establishKeys</span><span class="op" id="4435064">(</span><span class="op" id="4435065">)</span>&nbsp;<span class="builtintype" id="4435067">error</span>&nbsp;<span class="op" id="4435073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4435076">c</span>&nbsp;<span class="op" id="4435078">:=</span>&nbsp;<span class="ident" id="4435081">hs</span><span class="op" id="4435083">.</span><span class="ident" id="4435084">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4435088">clientMAC</span><span class="op" id="4435097">,</span>&nbsp;<span class="ident" id="4435099">serverMAC</span><span class="op" id="4435108">,</span>&nbsp;<span class="ident" id="4435110">clientKey</span><span class="op" id="4435119">,</span>&nbsp;<span class="ident" id="4435121">serverKey</span><span class="op" id="4435130">,</span>&nbsp;<span class="ident" id="4435132">clientIV</span><span class="op" id="4435140">,</span>&nbsp;<span class="ident" id="4435142">serverIV</span>&nbsp;<span class="op" id="4435151">:=</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4435156">keysFromMasterSecret</span><span class="op" id="4435176">(</span><span class="ident" id="4435177">c</span><span class="op" id="4435178">.</span><span class="ident" id="4435179">vers</span><span class="op" id="4435183">,</span>&nbsp;<span class="ident" id="4435185">hs</span><span class="op" id="4435187">.</span><span class="ident" id="4435188">masterSecret</span><span class="op" id="4435200">,</span>&nbsp;<span class="ident" id="4435202">hs</span><span class="op" id="4435204">.</span><span class="ident" id="4435205">clientHello</span><span class="op" id="4435216">.</span><span class="ident" id="4435217">random</span><span class="op" id="4435223">,</span>&nbsp;<span class="ident" id="4435225">hs</span><span class="op" id="4435227">.</span><span class="ident" id="4435228">hello</span><span class="op" id="4435233">.</span><span class="ident" id="4435234">random</span><span class="op" id="4435240">,</span>&nbsp;<span class="ident" id="4435242">hs</span><span class="op" id="4435244">.</span><span class="ident" id="4435245">suite</span><span class="op" id="4435250">.</span><span class="ident" id="4435251">macLen</span><span class="op" id="4435257">,</span>&nbsp;<span class="ident" id="4435259">hs</span><span class="op" id="4435261">.</span><span class="ident" id="4435262">suite</span><span class="op" id="4435267">.</span><span class="ident" id="4435268">keyLen</span><span class="op" id="4435274">,</span>&nbsp;<span class="ident" id="4435276">hs</span><span class="op" id="4435278">.</span><span class="ident" id="4435279">suite</span><span class="op" id="4435284">.</span><span class="ident" id="4435285">ivLen</span><span class="op" id="4435290">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4435294">var</span>&nbsp;<span class="ident" id="4435298">clientCipher</span><span class="op" id="4435310">,</span>&nbsp;<span class="ident" id="4435312">serverCipher</span>&nbsp;<span class="keyword" id="4435325">interface</span><span class="op" id="4435334">{</span><span class="op" id="4435335">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4435338">var</span>&nbsp;<span class="ident" id="4435342">clientHash</span><span class="op" id="4435352">,</span>&nbsp;<span class="ident" id="4435354">serverHash</span>&nbsp;<span class="ident" id="4435365">macFunction</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4435379">if</span>&nbsp;<span class="ident" id="4435382">hs</span><span class="op" id="4435384">.</span><span class="ident" id="4435385">suite</span><span class="op" id="4435390">.</span><span class="ident" id="4435391">aead</span>&nbsp;<span class="op" id="4435396">==</span>&nbsp;<span class="builtintype" id="4435399">nil</span>&nbsp;<span class="op" id="4435403">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4435407">clientCipher</span>&nbsp;<span class="op" id="4435420">=</span>&nbsp;<span class="ident" id="4435422">hs</span><span class="op" id="4435424">.</span><span class="ident" id="4435425">suite</span><span class="op" id="4435430">.</span><span class="ident" id="4435431">cipher</span><span class="op" id="4435437">(</span><span class="ident" id="4435438">clientKey</span><span class="op" id="4435447">,</span>&nbsp;<span class="ident" id="4435449">clientIV</span><span class="op" id="4435457">,</span>&nbsp;<span class="builtintype" id="4435459">true</span>&nbsp;<span class="comment" id="4435464">/*&nbsp;for&nbsp;reading&nbsp;*/</span><span class="op" id="4435481">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4435485">clientHash</span>&nbsp;<span class="op" id="4435496">=</span>&nbsp;<span class="ident" id="4435498">hs</span><span class="op" id="4435500">.</span><span class="ident" id="4435501">suite</span><span class="op" id="4435506">.</span><span class="ident" id="4435507">mac</span><span class="op" id="4435510">(</span><span class="ident" id="4435511">c</span><span class="op" id="4435512">.</span><span class="ident" id="4435513">vers</span><span class="op" id="4435517">,</span>&nbsp;<span class="ident" id="4435519">clientMAC</span><span class="op" id="4435528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4435532">serverCipher</span>&nbsp;<span class="op" id="4435545">=</span>&nbsp;<span class="ident" id="4435547">hs</span><span class="op" id="4435549">.</span><span class="ident" id="4435550">suite</span><span class="op" id="4435555">.</span><span class="ident" id="4435556">cipher</span><span class="op" id="4435562">(</span><span class="ident" id="4435563">serverKey</span><span class="op" id="4435572">,</span>&nbsp;<span class="ident" id="4435574">serverIV</span><span class="op" id="4435582">,</span>&nbsp;<span class="builtintype" id="4435584">false</span>&nbsp;<span class="comment" id="4435590">/*&nbsp;not&nbsp;for&nbsp;reading&nbsp;*/</span><span class="op" id="4435611">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4435615">serverHash</span>&nbsp;<span class="op" id="4435626">=</span>&nbsp;<span class="ident" id="4435628">hs</span><span class="op" id="4435630">.</span><span class="ident" id="4435631">suite</span><span class="op" id="4435636">.</span><span class="ident" id="4435637">mac</span><span class="op" id="4435640">(</span><span class="ident" id="4435641">c</span><span class="op" id="4435642">.</span><span class="ident" id="4435643">vers</span><span class="op" id="4435647">,</span>&nbsp;<span class="ident" id="4435649">serverMAC</span><span class="op" id="4435658">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4435661">}</span>&nbsp;<span class="keyword" id="4435663">else</span>&nbsp;<span class="op" id="4435668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4435672">clientCipher</span>&nbsp;<span class="op" id="4435685">=</span>&nbsp;<span class="ident" id="4435687">hs</span><span class="op" id="4435689">.</span><span class="ident" id="4435690">suite</span><span class="op" id="4435695">.</span><span class="ident" id="4435696">aead</span><span class="op" id="4435700">(</span><span class="ident" id="4435701">clientKey</span><span class="op" id="4435710">,</span>&nbsp;<span class="ident" id="4435712">clientIV</span><span class="op" id="4435720">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4435724">serverCipher</span>&nbsp;<span class="op" id="4435737">=</span>&nbsp;<span class="ident" id="4435739">hs</span><span class="op" id="4435741">.</span><span class="ident" id="4435742">suite</span><span class="op" id="4435747">.</span><span class="ident" id="4435748">aead</span><span class="op" id="4435752">(</span><span class="ident" id="4435753">serverKey</span><span class="op" id="4435762">,</span>&nbsp;<span class="ident" id="4435764">serverIV</span><span class="op" id="4435772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4435775">}</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4435779">c</span><span class="op" id="4435780">.</span><span class="ident" id="4435781">in</span><span class="op" id="4435783">.</span><span class="ident" id="4435784">prepareCipherSpec</span><span class="op" id="4435801">(</span><span class="ident" id="4435802">c</span><span class="op" id="4435803">.</span><span class="ident" id="4435804">vers</span><span class="op" id="4435808">,</span>&nbsp;<span class="ident" id="4435810">clientCipher</span><span class="op" id="4435822">,</span>&nbsp;<span class="ident" id="4435824">clientHash</span><span class="op" id="4435834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4435837">c</span><span class="op" id="4435838">.</span><span class="ident" id="4435839">out</span><span class="op" id="4435842">.</span><span class="ident" id="4435843">prepareCipherSpec</span><span class="op" id="4435860">(</span><span class="ident" id="4435861">c</span><span class="op" id="4435862">.</span><span class="ident" id="4435863">vers</span><span class="op" id="4435867">,</span>&nbsp;<span class="ident" id="4435869">serverCipher</span><span class="op" id="4435881">,</span>&nbsp;<span class="ident" id="4435883">serverHash</span><span class="op" id="4435893">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4435897">return</span>&nbsp;<span class="builtintype" id="4435904">nil</span><br>
<span class="lineno">500</span><span class="op" id="4435908">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4435911">func</span>&nbsp;<span class="op" id="4435916">(</span><span class="ident" id="4435917">hs</span>&nbsp;<span class="op" id="4435920">*</span><span class="ident" id="4435921">serverHandshakeState</span><span class="op" id="4435941">)</span>&nbsp;<span class="ident" id="4435943">readFinished</span><span class="op" id="4435955">(</span><span class="ident" id="4435956">out</span>&nbsp;<span class="op" id="4435960">[</span><span class="op" id="4435961">]</span><span class="builtintype" id="4435962">byte</span><span class="op" id="4435966">)</span>&nbsp;<span class="builtintype" id="4435968">error</span>&nbsp;<span class="op" id="4435974">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4435977">c</span>&nbsp;<span class="op" id="4435979">:=</span>&nbsp;<span class="ident" id="4435982">hs</span><span class="op" id="4435984">.</span><span class="ident" id="4435985">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4435989">c</span><span class="op" id="4435990">.</span><span class="ident" id="4435991">readRecord</span><span class="op" id="4436001">(</span><span class="ident" id="4436002">recordTypeChangeCipherSpec</span><span class="op" id="4436028">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4436031">if</span>&nbsp;<span class="ident" id="4436034">err</span>&nbsp;<span class="op" id="4436038">:=</span>&nbsp;<span class="ident" id="4436041">c</span><span class="op" id="4436042">.</span><span class="ident" id="4436043">in</span><span class="op" id="4436045">.</span><span class="builtintype" id="4436046">error</span><span class="op" id="4436051">(</span><span class="op" id="4436052">)</span><span class="op" id="4436053">;</span>&nbsp;<span class="ident" id="4436055">err</span>&nbsp;<span class="op" id="4436059">!=</span>&nbsp;<span class="builtintype" id="4436062">nil</span>&nbsp;<span class="op" id="4436066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4436070">return</span>&nbsp;<span class="ident" id="4436077">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4436082">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4436086">if</span>&nbsp;<span class="ident" id="4436089">hs</span><span class="op" id="4436091">.</span><span class="ident" id="4436092">hello</span><span class="op" id="4436097">.</span><span class="ident" id="4436098">nextProtoNeg</span>&nbsp;<span class="op" id="4436111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4436115">msg</span><span class="op" id="4436118">,</span>&nbsp;<span class="ident" id="4436120">err</span>&nbsp;<span class="op" id="4436124">:=</span>&nbsp;<span class="ident" id="4436127">c</span><span class="op" id="4436128">.</span><span class="ident" id="4436129">readHandshake</span><span class="op" id="4436142">(</span><span class="op" id="4436143">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4436147">if</span>&nbsp;<span class="ident" id="4436150">err</span>&nbsp;<span class="op" id="4436154">!=</span>&nbsp;<span class="builtintype" id="4436157">nil</span>&nbsp;<span class="op" id="4436161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4436166">return</span>&nbsp;<span class="ident" id="4436173">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4436179">}</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4436183">nextProto</span><span class="op" id="4436192">,</span>&nbsp;<span class="ident" id="4436194">ok</span>&nbsp;<span class="op" id="4436197">:=</span>&nbsp;<span class="ident" id="4436200">msg</span><span class="op" id="4436203">.</span><span class="op" id="4436204">(</span><span class="op" id="4436205">*</span><span class="ident" id="4436206">nextProtoMsg</span><span class="op" id="4436218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4436222">if</span>&nbsp;<span class="op" id="4436225">!</span><span class="ident" id="4436226">ok</span>&nbsp;<span class="op" id="4436229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4436234">c</span><span class="op" id="4436235">.</span><span class="ident" id="4436236">sendAlert</span><span class="op" id="4436245">(</span><span class="ident" id="4436246">alertUnexpectedMessage</span><span class="op" id="4436268">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4436273">return</span>&nbsp;<span class="ident" id="4436280">unexpectedMessageError</span><span class="op" id="4436302">(</span><span class="ident" id="4436303">nextProto</span><span class="op" id="4436312">,</span>&nbsp;<span class="ident" id="4436314">msg</span><span class="op" id="4436317">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4436321">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4436325">hs</span><span class="op" id="4436327">.</span><span class="ident" id="4436328">finishedHash</span><span class="op" id="4436340">.</span><span class="ident" id="4436341">Write</span><span class="op" id="4436346">(</span><span class="ident" id="4436347">nextProto</span><span class="op" id="4436356">.</span><span class="ident" id="4436357">marshal</span><span class="op" id="4436364">(</span><span class="op" id="4436365">)</span><span class="op" id="4436366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4436370">c</span><span class="op" id="4436371">.</span><span class="ident" id="4436372">clientProtocol</span>&nbsp;<span class="op" id="4436387">=</span>&nbsp;<span class="ident" id="4436389">nextProto</span><span class="op" id="4436398">.</span><span class="ident" id="4436399">proto</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4436406">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4436410">msg</span><span class="op" id="4436413">,</span>&nbsp;<span class="ident" id="4436415">err</span>&nbsp;<span class="op" id="4436419">:=</span>&nbsp;<span class="ident" id="4436422">c</span><span class="op" id="4436423">.</span><span class="ident" id="4436424">readHandshake</span><span class="op" id="4436437">(</span><span class="op" id="4436438">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4436441">if</span>&nbsp;<span class="ident" id="4436444">err</span>&nbsp;<span class="op" id="4436448">!=</span>&nbsp;<span class="builtintype" id="4436451">nil</span>&nbsp;<span class="op" id="4436455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4436459">return</span>&nbsp;<span class="ident" id="4436466">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4436471">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4436474">clientFinished</span><span class="op" id="4436488">,</span>&nbsp;<span class="ident" id="4436490">ok</span>&nbsp;<span class="op" id="4436493">:=</span>&nbsp;<span class="ident" id="4436496">msg</span><span class="op" id="4436499">.</span><span class="op" id="4436500">(</span><span class="op" id="4436501">*</span><span class="ident" id="4436502">finishedMsg</span><span class="op" id="4436513">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4436516">if</span>&nbsp;<span class="op" id="4436519">!</span><span class="ident" id="4436520">ok</span>&nbsp;<span class="op" id="4436523">{</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4436527">c</span><span class="op" id="4436528">.</span><span class="ident" id="4436529">sendAlert</span><span class="op" id="4436538">(</span><span class="ident" id="4436539">alertUnexpectedMessage</span><span class="op" id="4436561">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4436565">return</span>&nbsp;<span class="ident" id="4436572">unexpectedMessageError</span><span class="op" id="4436594">(</span><span class="ident" id="4436595">clientFinished</span><span class="op" id="4436609">,</span>&nbsp;<span class="ident" id="4436611">msg</span><span class="op" id="4436614">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4436617">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4436621">verify</span>&nbsp;<span class="op" id="4436628">:=</span>&nbsp;<span class="ident" id="4436631">hs</span><span class="op" id="4436633">.</span><span class="ident" id="4436634">finishedHash</span><span class="op" id="4436646">.</span><span class="ident" id="4436647">clientSum</span><span class="op" id="4436656">(</span><span class="ident" id="4436657">hs</span><span class="op" id="4436659">.</span><span class="ident" id="4436660">masterSecret</span><span class="op" id="4436672">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4436675">if</span>&nbsp;<span class="builtinfunc" id="4436678">len</span><span class="op" id="4436681">(</span><span class="ident" id="4436682">verify</span><span class="op" id="4436688">)</span>&nbsp;<span class="op" id="4436690">!=</span>&nbsp;<span class="builtinfunc" id="4436693">len</span><span class="op" id="4436696">(</span><span class="ident" id="4436697">clientFinished</span><span class="op" id="4436711">.</span><span class="ident" id="4436712">verifyData</span><span class="op" id="4436722">)</span>&nbsp;<span class="op" id="4436724">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4436729">subtle</span><span class="op" id="4436735">.</span><span class="ident" id="4436736">ConstantTimeCompare</span><span class="op" id="4436755">(</span><span class="ident" id="4436756">verify</span><span class="op" id="4436762">,</span>&nbsp;<span class="ident" id="4436764">clientFinished</span><span class="op" id="4436778">.</span><span class="ident" id="4436779">verifyData</span><span class="op" id="4436789">)</span>&nbsp;<span class="op" id="4436791">!=</span>&nbsp;<span class="num" id="4436794">1</span>&nbsp;<span class="op" id="4436796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4436800">c</span><span class="op" id="4436801">.</span><span class="ident" id="4436802">sendAlert</span><span class="op" id="4436811">(</span><span class="ident" id="4436812">alertHandshakeFailure</span><span class="op" id="4436833">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4436837">return</span>&nbsp;<span class="ident" id="4436844">errors</span><span class="op" id="4436850">.</span><span class="ident" id="4436851">New</span><span class="op" id="4436854">(</span><span class="string" id="4436855">&#34;tls:&nbsp;client&#39;s&nbsp;Finished&nbsp;message&nbsp;is&nbsp;incorrect&#34;</span><span class="op" id="4436900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4436903">}</span><br>
<span class="lineno">540</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4436907">hs</span><span class="op" id="4436909">.</span><span class="ident" id="4436910">finishedHash</span><span class="op" id="4436922">.</span><span class="ident" id="4436923">Write</span><span class="op" id="4436928">(</span><span class="ident" id="4436929">clientFinished</span><span class="op" id="4436943">.</span><span class="ident" id="4436944">marshal</span><span class="op" id="4436951">(</span><span class="op" id="4436952">)</span><span class="op" id="4436953">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4436956">copy</span><span class="op" id="4436960">(</span><span class="ident" id="4436961">out</span><span class="op" id="4436964">,</span>&nbsp;<span class="ident" id="4436966">verify</span><span class="op" id="4436972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4436975">return</span>&nbsp;<span class="builtintype" id="4436982">nil</span><br>
<span class="lineno"></span><span class="op" id="4436986">}</span><br>
<span class="lineno">545</span><br>
<span class="lineno"></span><span class="keyword" id="4436989">func</span>&nbsp;<span class="op" id="4436994">(</span><span class="ident" id="4436995">hs</span>&nbsp;<span class="op" id="4436998">*</span><span class="ident" id="4436999">serverHandshakeState</span><span class="op" id="4437019">)</span>&nbsp;<span class="ident" id="4437021">sendSessionTicket</span><span class="op" id="4437038">(</span><span class="op" id="4437039">)</span>&nbsp;<span class="builtintype" id="4437041">error</span>&nbsp;<span class="op" id="4437047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4437050">if</span>&nbsp;<span class="op" id="4437053">!</span><span class="ident" id="4437054">hs</span><span class="op" id="4437056">.</span><span class="ident" id="4437057">hello</span><span class="op" id="4437062">.</span><span class="ident" id="4437063">ticketSupported</span>&nbsp;<span class="op" id="4437079">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4437083">return</span>&nbsp;<span class="builtintype" id="4437090">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4437095">}</span><br>
<span class="lineno">550</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4437099">c</span>&nbsp;<span class="op" id="4437101">:=</span>&nbsp;<span class="ident" id="4437104">hs</span><span class="op" id="4437106">.</span><span class="ident" id="4437107">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4437110">m</span>&nbsp;<span class="op" id="4437112">:=</span>&nbsp;<span class="builtinfunc" id="4437115">new</span><span class="op" id="4437118">(</span><span class="ident" id="4437119">newSessionTicketMsg</span><span class="op" id="4437138">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4437142">var</span>&nbsp;<span class="ident" id="4437146">err</span>&nbsp;<span class="builtintype" id="4437150">error</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4437157">state</span>&nbsp;<span class="op" id="4437163">:=</span>&nbsp;<span class="ident" id="4437166">sessionState</span><span class="op" id="4437178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4437182">vers</span><span class="op" id="4437186">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4437196">c</span><span class="op" id="4437197">.</span><span class="ident" id="4437198">vers</span><span class="op" id="4437202">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4437206">cipherSuite</span><span class="op" id="4437217">:</span>&nbsp;&nbsp;<span class="ident" id="4437220">hs</span><span class="op" id="4437222">.</span><span class="ident" id="4437223">suite</span><span class="op" id="4437228">.</span><span class="ident" id="4437229">id</span><span class="op" id="4437231">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4437235">masterSecret</span><span class="op" id="4437247">:</span>&nbsp;<span class="ident" id="4437249">hs</span><span class="op" id="4437251">.</span><span class="ident" id="4437252">masterSecret</span><span class="op" id="4437264">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4437268">certificates</span><span class="op" id="4437280">:</span>&nbsp;<span class="ident" id="4437282">hs</span><span class="op" id="4437284">.</span><span class="ident" id="4437285">certsFromClient</span><span class="op" id="4437300">,</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4437303">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4437306">m</span><span class="op" id="4437307">.</span><span class="ident" id="4437308">ticket</span><span class="op" id="4437314">,</span>&nbsp;<span class="ident" id="4437316">err</span>&nbsp;<span class="op" id="4437320">=</span>&nbsp;<span class="ident" id="4437322">c</span><span class="op" id="4437323">.</span><span class="ident" id="4437324">encryptTicket</span><span class="op" id="4437337">(</span><span class="op" id="4437338">&amp;</span><span class="ident" id="4437339">state</span><span class="op" id="4437344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4437347">if</span>&nbsp;<span class="ident" id="4437350">err</span>&nbsp;<span class="op" id="4437354">!=</span>&nbsp;<span class="builtintype" id="4437357">nil</span>&nbsp;<span class="op" id="4437361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4437365">return</span>&nbsp;<span class="ident" id="4437372">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4437377">}</span><br>
<span class="lineno">565</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4437381">hs</span><span class="op" id="4437383">.</span><span class="ident" id="4437384">finishedHash</span><span class="op" id="4437396">.</span><span class="ident" id="4437397">Write</span><span class="op" id="4437402">(</span><span class="ident" id="4437403">m</span><span class="op" id="4437404">.</span><span class="ident" id="4437405">marshal</span><span class="op" id="4437412">(</span><span class="op" id="4437413">)</span><span class="op" id="4437414">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4437417">c</span><span class="op" id="4437418">.</span><span class="ident" id="4437419">writeRecord</span><span class="op" id="4437430">(</span><span class="ident" id="4437431">recordTypeHandshake</span><span class="op" id="4437450">,</span>&nbsp;<span class="ident" id="4437452">m</span><span class="op" id="4437453">.</span><span class="ident" id="4437454">marshal</span><span class="op" id="4437461">(</span><span class="op" id="4437462">)</span><span class="op" id="4437463">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4437467">return</span>&nbsp;<span class="builtintype" id="4437474">nil</span><br>
<span class="lineno">570</span><span class="op" id="4437478">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4437481">func</span>&nbsp;<span class="op" id="4437486">(</span><span class="ident" id="4437487">hs</span>&nbsp;<span class="op" id="4437490">*</span><span class="ident" id="4437491">serverHandshakeState</span><span class="op" id="4437511">)</span>&nbsp;<span class="ident" id="4437513">sendFinished</span><span class="op" id="4437525">(</span><span class="ident" id="4437526">out</span>&nbsp;<span class="op" id="4437530">[</span><span class="op" id="4437531">]</span><span class="builtintype" id="4437532">byte</span><span class="op" id="4437536">)</span>&nbsp;<span class="builtintype" id="4437538">error</span>&nbsp;<span class="op" id="4437544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4437547">c</span>&nbsp;<span class="op" id="4437549">:=</span>&nbsp;<span class="ident" id="4437552">hs</span><span class="op" id="4437554">.</span><span class="ident" id="4437555">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4437559">c</span><span class="op" id="4437560">.</span><span class="ident" id="4437561">writeRecord</span><span class="op" id="4437572">(</span><span class="ident" id="4437573">recordTypeChangeCipherSpec</span><span class="op" id="4437599">,</span>&nbsp;<span class="op" id="4437601">[</span><span class="op" id="4437602">]</span><span class="builtintype" id="4437603">byte</span><span class="op" id="4437607">{</span><span class="num" id="4437608">1</span><span class="op" id="4437609">}</span><span class="op" id="4437610">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4437614">finished</span>&nbsp;<span class="op" id="4437623">:=</span>&nbsp;<span class="builtinfunc" id="4437626">new</span><span class="op" id="4437629">(</span><span class="ident" id="4437630">finishedMsg</span><span class="op" id="4437641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4437644">finished</span><span class="op" id="4437652">.</span><span class="ident" id="4437653">verifyData</span>&nbsp;<span class="op" id="4437664">=</span>&nbsp;<span class="ident" id="4437666">hs</span><span class="op" id="4437668">.</span><span class="ident" id="4437669">finishedHash</span><span class="op" id="4437681">.</span><span class="ident" id="4437682">serverSum</span><span class="op" id="4437691">(</span><span class="ident" id="4437692">hs</span><span class="op" id="4437694">.</span><span class="ident" id="4437695">masterSecret</span><span class="op" id="4437707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4437710">hs</span><span class="op" id="4437712">.</span><span class="ident" id="4437713">finishedHash</span><span class="op" id="4437725">.</span><span class="ident" id="4437726">Write</span><span class="op" id="4437731">(</span><span class="ident" id="4437732">finished</span><span class="op" id="4437740">.</span><span class="ident" id="4437741">marshal</span><span class="op" id="4437748">(</span><span class="op" id="4437749">)</span><span class="op" id="4437750">)</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4437753">c</span><span class="op" id="4437754">.</span><span class="ident" id="4437755">writeRecord</span><span class="op" id="4437766">(</span><span class="ident" id="4437767">recordTypeHandshake</span><span class="op" id="4437786">,</span>&nbsp;<span class="ident" id="4437788">finished</span><span class="op" id="4437796">.</span><span class="ident" id="4437797">marshal</span><span class="op" id="4437804">(</span><span class="op" id="4437805">)</span><span class="op" id="4437806">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4437810">c</span><span class="op" id="4437811">.</span><span class="ident" id="4437812">cipherSuite</span>&nbsp;<span class="op" id="4437824">=</span>&nbsp;<span class="ident" id="4437826">hs</span><span class="op" id="4437828">.</span><span class="ident" id="4437829">suite</span><span class="op" id="4437834">.</span><span class="ident" id="4437835">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4437839">copy</span><span class="op" id="4437843">(</span><span class="ident" id="4437844">out</span><span class="op" id="4437847">,</span>&nbsp;<span class="ident" id="4437849">finished</span><span class="op" id="4437857">.</span><span class="ident" id="4437858">verifyData</span><span class="op" id="4437868">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4437872">return</span>&nbsp;<span class="builtintype" id="4437879">nil</span><br>
<span class="lineno"></span><span class="op" id="4437883">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4437886">//&nbsp;processCertsFromClient&nbsp;takes&nbsp;a&nbsp;chain&nbsp;of&nbsp;client&nbsp;certificates&nbsp;either&nbsp;from&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4437963">//&nbsp;Certificates&nbsp;message&nbsp;or&nbsp;from&nbsp;a&nbsp;sessionState&nbsp;and&nbsp;verifies&nbsp;them.&nbsp;It&nbsp;returns</span><br>
<span class="lineno">590</span><span class="comment" id="4438040">//&nbsp;the&nbsp;public&nbsp;key&nbsp;of&nbsp;the&nbsp;leaf&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="keyword" id="4438083">func</span>&nbsp;<span class="op" id="4438088">(</span><span class="ident" id="4438089">hs</span>&nbsp;<span class="op" id="4438092">*</span><span class="ident" id="4438093">serverHandshakeState</span><span class="op" id="4438113">)</span>&nbsp;<span class="ident" id="4438115">processCertsFromClient</span><span class="op" id="4438137">(</span><span class="ident" id="4438138">certificates</span>&nbsp;<span class="op" id="4438151">[</span><span class="op" id="4438152">]</span><span class="op" id="4438153">[</span><span class="op" id="4438154">]</span><span class="builtintype" id="4438155">byte</span><span class="op" id="4438159">)</span>&nbsp;<span class="op" id="4438161">(</span><span class="ident" id="4438162">crypto</span><span class="op" id="4438168">.</span><span class="ident" id="4438169">PublicKey</span><span class="op" id="4438178">,</span>&nbsp;<span class="builtintype" id="4438180">error</span><span class="op" id="4438185">)</span>&nbsp;<span class="op" id="4438187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4438190">c</span>&nbsp;<span class="op" id="4438192">:=</span>&nbsp;<span class="ident" id="4438195">hs</span><span class="op" id="4438197">.</span><span class="ident" id="4438198">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4438202">hs</span><span class="op" id="4438204">.</span><span class="ident" id="4438205">certsFromClient</span>&nbsp;<span class="op" id="4438221">=</span>&nbsp;<span class="ident" id="4438223">certificates</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4438237">certs</span>&nbsp;<span class="op" id="4438243">:=</span>&nbsp;<span class="builtinfunc" id="4438246">make</span><span class="op" id="4438250">(</span><span class="op" id="4438251">[</span><span class="op" id="4438252">]</span><span class="op" id="4438253">*</span><span class="ident" id="4438254">x509</span><span class="op" id="4438258">.</span><span class="ident" id="4438259">Certificate</span><span class="op" id="4438270">,</span>&nbsp;<span class="builtinfunc" id="4438272">len</span><span class="op" id="4438275">(</span><span class="ident" id="4438276">certificates</span><span class="op" id="4438288">)</span><span class="op" id="4438289">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4438292">var</span>&nbsp;<span class="ident" id="4438296">err</span>&nbsp;<span class="builtintype" id="4438300">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4438307">for</span>&nbsp;<span class="ident" id="4438311">i</span><span class="op" id="4438312">,</span>&nbsp;<span class="ident" id="4438314">asn1Data</span>&nbsp;<span class="op" id="4438323">:=</span>&nbsp;<span class="keyword" id="4438326">range</span>&nbsp;<span class="ident" id="4438332">certificates</span>&nbsp;<span class="op" id="4438345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4438349">if</span>&nbsp;<span class="ident" id="4438352">certs</span><span class="op" id="4438357">[</span><span class="ident" id="4438358">i</span><span class="op" id="4438359">]</span><span class="op" id="4438360">,</span>&nbsp;<span class="ident" id="4438362">err</span>&nbsp;<span class="op" id="4438366">=</span>&nbsp;<span class="ident" id="4438368">x509</span><span class="op" id="4438372">.</span><span class="ident" id="4438373">ParseCertificate</span><span class="op" id="4438389">(</span><span class="ident" id="4438390">asn1Data</span><span class="op" id="4438398">)</span><span class="op" id="4438399">;</span>&nbsp;<span class="ident" id="4438401">err</span>&nbsp;<span class="op" id="4438405">!=</span>&nbsp;<span class="builtintype" id="4438408">nil</span>&nbsp;<span class="op" id="4438412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4438417">c</span><span class="op" id="4438418">.</span><span class="ident" id="4438419">sendAlert</span><span class="op" id="4438428">(</span><span class="ident" id="4438429">alertBadCertificate</span><span class="op" id="4438448">)</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4438453">return</span>&nbsp;<span class="builtintype" id="4438460">nil</span><span class="op" id="4438463">,</span>&nbsp;<span class="ident" id="4438465">errors</span><span class="op" id="4438471">.</span><span class="ident" id="4438472">New</span><span class="op" id="4438475">(</span><span class="string" id="4438476">&#34;tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;client&nbsp;certificate:&nbsp;&#34;</span>&nbsp;<span class="op" id="4438520">+</span>&nbsp;<span class="ident" id="4438522">err</span><span class="op" id="4438525">.</span><span class="ident" id="4438526">Error</span><span class="op" id="4438531">(</span><span class="op" id="4438532">)</span><span class="op" id="4438533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4438537">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4438540">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4438544">if</span>&nbsp;<span class="ident" id="4438547">c</span><span class="op" id="4438548">.</span><span class="ident" id="4438549">config</span><span class="op" id="4438555">.</span><span class="ident" id="4438556">ClientAuth</span>&nbsp;<span class="op" id="4438567">&gt;=</span>&nbsp;<span class="ident" id="4438570">VerifyClientCertIfGiven</span>&nbsp;<span class="op" id="4438594">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="4438597">len</span><span class="op" id="4438600">(</span><span class="ident" id="4438601">certs</span><span class="op" id="4438606">)</span>&nbsp;<span class="op" id="4438608">&gt;</span>&nbsp;<span class="num" id="4438610">0</span>&nbsp;<span class="op" id="4438612">{</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4438616">opts</span>&nbsp;<span class="op" id="4438621">:=</span>&nbsp;<span class="ident" id="4438624">x509</span><span class="op" id="4438628">.</span><span class="ident" id="4438629">VerifyOptions</span><span class="op" id="4438642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4438647">Roots</span><span class="op" id="4438652">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4438662">c</span><span class="op" id="4438663">.</span><span class="ident" id="4438664">config</span><span class="op" id="4438670">.</span><span class="ident" id="4438671">ClientCAs</span><span class="op" id="4438680">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4438685">CurrentTime</span><span class="op" id="4438696">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4438700">c</span><span class="op" id="4438701">.</span><span class="ident" id="4438702">config</span><span class="op" id="4438708">.</span><span class="ident" id="4438709">time</span><span class="op" id="4438713">(</span><span class="op" id="4438714">)</span><span class="op" id="4438715">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4438720">Intermediates</span><span class="op" id="4438733">:</span>&nbsp;<span class="ident" id="4438735">x509</span><span class="op" id="4438739">.</span><span class="ident" id="4438740">NewCertPool</span><span class="op" id="4438751">(</span><span class="op" id="4438752">)</span><span class="op" id="4438753">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4438758">KeyUsages</span><span class="op" id="4438767">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4438773">[</span><span class="op" id="4438774">]</span><span class="ident" id="4438775">x509</span><span class="op" id="4438779">.</span><span class="ident" id="4438780">ExtKeyUsage</span><span class="op" id="4438791">{</span><span class="ident" id="4438792">x509</span><span class="op" id="4438796">.</span><span class="ident" id="4438797">ExtKeyUsageClientAuth</span><span class="op" id="4438818">}</span><span class="op" id="4438819">,</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4438823">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4438828">for</span>&nbsp;<span class="ident" id="4438832">_</span><span class="op" id="4438833">,</span>&nbsp;<span class="ident" id="4438835">cert</span>&nbsp;<span class="op" id="4438840">:=</span>&nbsp;<span class="keyword" id="4438843">range</span>&nbsp;<span class="ident" id="4438849">certs</span><span class="op" id="4438854">[</span><span class="num" id="4438855">1</span><span class="op" id="4438856">:</span><span class="op" id="4438857">]</span>&nbsp;<span class="op" id="4438859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4438864">opts</span><span class="op" id="4438868">.</span><span class="ident" id="4438869">Intermediates</span><span class="op" id="4438882">.</span><span class="ident" id="4438883">AddCert</span><span class="op" id="4438890">(</span><span class="ident" id="4438891">cert</span><span class="op" id="4438895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4438899">}</span><br>
<span class="lineno">615</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4438904">chains</span><span class="op" id="4438910">,</span>&nbsp;<span class="ident" id="4438912">err</span>&nbsp;<span class="op" id="4438916">:=</span>&nbsp;<span class="ident" id="4438919">certs</span><span class="op" id="4438924">[</span><span class="num" id="4438925">0</span><span class="op" id="4438926">]</span><span class="op" id="4438927">.</span><span class="ident" id="4438928">Verify</span><span class="op" id="4438934">(</span><span class="ident" id="4438935">opts</span><span class="op" id="4438939">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4438943">if</span>&nbsp;<span class="ident" id="4438946">err</span>&nbsp;<span class="op" id="4438950">!=</span>&nbsp;<span class="builtintype" id="4438953">nil</span>&nbsp;<span class="op" id="4438957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4438962">c</span><span class="op" id="4438963">.</span><span class="ident" id="4438964">sendAlert</span><span class="op" id="4438973">(</span><span class="ident" id="4438974">alertBadCertificate</span><span class="op" id="4438993">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4438998">return</span>&nbsp;<span class="builtintype" id="4439005">nil</span><span class="op" id="4439008">,</span>&nbsp;<span class="ident" id="4439010">errors</span><span class="op" id="4439016">.</span><span class="ident" id="4439017">New</span><span class="op" id="4439020">(</span><span class="string" id="4439021">&#34;tls:&nbsp;failed&nbsp;to&nbsp;verify&nbsp;client&#39;s&nbsp;certificate:&nbsp;&#34;</span>&nbsp;<span class="op" id="4439068">+</span>&nbsp;<span class="ident" id="4439070">err</span><span class="op" id="4439073">.</span><span class="ident" id="4439074">Error</span><span class="op" id="4439079">(</span><span class="op" id="4439080">)</span><span class="op" id="4439081">)</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4439085">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4439090">ok</span>&nbsp;<span class="op" id="4439093">:=</span>&nbsp;<span class="builtintype" id="4439096">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4439104">for</span>&nbsp;<span class="ident" id="4439108">_</span><span class="op" id="4439109">,</span>&nbsp;<span class="ident" id="4439111">ku</span>&nbsp;<span class="op" id="4439114">:=</span>&nbsp;<span class="keyword" id="4439117">range</span>&nbsp;<span class="ident" id="4439123">certs</span><span class="op" id="4439128">[</span><span class="num" id="4439129">0</span><span class="op" id="4439130">]</span><span class="op" id="4439131">.</span><span class="ident" id="4439132">ExtKeyUsage</span>&nbsp;<span class="op" id="4439144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4439149">if</span>&nbsp;<span class="ident" id="4439152">ku</span>&nbsp;<span class="op" id="4439155">==</span>&nbsp;<span class="ident" id="4439158">x509</span><span class="op" id="4439162">.</span><span class="ident" id="4439163">ExtKeyUsageClientAuth</span>&nbsp;<span class="op" id="4439185">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4439191">ok</span>&nbsp;<span class="op" id="4439194">=</span>&nbsp;<span class="builtintype" id="4439196">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4439205">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4439214">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4439218">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4439222">if</span>&nbsp;<span class="op" id="4439225">!</span><span class="ident" id="4439226">ok</span>&nbsp;<span class="op" id="4439229">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4439234">c</span><span class="op" id="4439235">.</span><span class="ident" id="4439236">sendAlert</span><span class="op" id="4439245">(</span><span class="ident" id="4439246">alertHandshakeFailure</span><span class="op" id="4439267">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4439272">return</span>&nbsp;<span class="builtintype" id="4439279">nil</span><span class="op" id="4439282">,</span>&nbsp;<span class="ident" id="4439284">errors</span><span class="op" id="4439290">.</span><span class="ident" id="4439291">New</span><span class="op" id="4439294">(</span><span class="string" id="4439295">&#34;tls:&nbsp;client&#39;s&nbsp;certificate&#39;s&nbsp;extended&nbsp;key&nbsp;usage&nbsp;doesn&#39;t&nbsp;permit&nbsp;it&nbsp;to&nbsp;be&nbsp;used&nbsp;for&nbsp;client&nbsp;authentication&#34;</span><span class="op" id="4439398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4439402">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4439407">c</span><span class="op" id="4439408">.</span><span class="ident" id="4439409">verifiedChains</span>&nbsp;<span class="op" id="4439424">=</span>&nbsp;<span class="ident" id="4439426">chains</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4439434">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4439438">if</span>&nbsp;<span class="builtinfunc" id="4439441">len</span><span class="op" id="4439444">(</span><span class="ident" id="4439445">certs</span><span class="op" id="4439450">)</span>&nbsp;<span class="op" id="4439452">&gt;</span>&nbsp;<span class="num" id="4439454">0</span>&nbsp;<span class="op" id="4439456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4439460">var</span>&nbsp;<span class="ident" id="4439464">pub</span>&nbsp;<span class="ident" id="4439468">crypto</span><span class="op" id="4439474">.</span><span class="ident" id="4439475">PublicKey</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4439487">switch</span>&nbsp;<span class="ident" id="4439494">key</span>&nbsp;<span class="op" id="4439498">:=</span>&nbsp;<span class="ident" id="4439501">certs</span><span class="op" id="4439506">[</span><span class="num" id="4439507">0</span><span class="op" id="4439508">]</span><span class="op" id="4439509">.</span><span class="ident" id="4439510">PublicKey</span><span class="op" id="4439519">.</span><span class="op" id="4439520">(</span><span class="keyword" id="4439521">type</span><span class="op" id="4439525">)</span>&nbsp;<span class="op" id="4439527">{</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4439531">case</span>&nbsp;<span class="op" id="4439536">*</span><span class="ident" id="4439537">ecdsa</span><span class="op" id="4439542">.</span><span class="ident" id="4439543">PublicKey</span><span class="op" id="4439552">,</span>&nbsp;<span class="op" id="4439554">*</span><span class="ident" id="4439555">rsa</span><span class="op" id="4439558">.</span><span class="ident" id="4439559">PublicKey</span><span class="op" id="4439568">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4439573">pub</span>&nbsp;<span class="op" id="4439577">=</span>&nbsp;<span class="ident" id="4439579">key</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4439585">default</span><span class="op" id="4439592">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4439597">c</span><span class="op" id="4439598">.</span><span class="ident" id="4439599">sendAlert</span><span class="op" id="4439608">(</span><span class="ident" id="4439609">alertUnsupportedCertificate</span><span class="op" id="4439636">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4439641">return</span>&nbsp;<span class="builtintype" id="4439648">nil</span><span class="op" id="4439651">,</span>&nbsp;<span class="ident" id="4439653">fmt</span><span class="op" id="4439656">.</span><span class="ident" id="4439657">Errorf</span><span class="op" id="4439663">(</span><span class="string" id="4439664">&#34;tls:&nbsp;client&#39;s&nbsp;certificate&nbsp;contains&nbsp;an&nbsp;unsupported&nbsp;public&nbsp;key&nbsp;of&nbsp;type&nbsp;%T&#34;</span><span class="op" id="4439737">,</span>&nbsp;<span class="ident" id="4439739">certs</span><span class="op" id="4439744">[</span><span class="num" id="4439745">0</span><span class="op" id="4439746">]</span><span class="op" id="4439747">.</span><span class="ident" id="4439748">PublicKey</span><span class="op" id="4439757">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4439761">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4439765">c</span><span class="op" id="4439766">.</span><span class="ident" id="4439767">peerCertificates</span>&nbsp;<span class="op" id="4439784">=</span>&nbsp;<span class="ident" id="4439786">certs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4439794">return</span>&nbsp;<span class="ident" id="4439801">pub</span><span class="op" id="4439804">,</span>&nbsp;<span class="builtintype" id="4439806">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4439811">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4439815">return</span>&nbsp;<span class="builtintype" id="4439822">nil</span><span class="op" id="4439825">,</span>&nbsp;<span class="builtintype" id="4439827">nil</span><br>
<span class="lineno"></span><span class="op" id="4439831">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4439834">//&nbsp;tryCipherSuite&nbsp;returns&nbsp;a&nbsp;cipherSuite&nbsp;with&nbsp;the&nbsp;given&nbsp;id&nbsp;if&nbsp;that&nbsp;cipher&nbsp;suite</span><br>
<span class="lineno"></span><span class="comment" id="4439913">//&nbsp;is&nbsp;acceptable&nbsp;to&nbsp;use.</span><br>
<span class="lineno">655</span><span class="keyword" id="4439938">func</span>&nbsp;<span class="op" id="4439943">(</span><span class="ident" id="4439944">c</span>&nbsp;<span class="op" id="4439946">*</span><span class="ident" id="4439947">Conn</span><span class="op" id="4439951">)</span>&nbsp;<span class="ident" id="4439953">tryCipherSuite</span><span class="op" id="4439967">(</span><span class="ident" id="4439968">id</span>&nbsp;<span class="builtintype" id="4439971">uint16</span><span class="op" id="4439977">,</span>&nbsp;<span class="ident" id="4439979">supportedCipherSuites</span>&nbsp;<span class="op" id="4440001">[</span><span class="op" id="4440002">]</span><span class="builtintype" id="4440003">uint16</span><span class="op" id="4440009">,</span>&nbsp;<span class="ident" id="4440011">version</span>&nbsp;<span class="builtintype" id="4440019">uint16</span><span class="op" id="4440025">,</span>&nbsp;<span class="ident" id="4440027">ellipticOk</span><span class="op" id="4440037">,</span>&nbsp;<span class="ident" id="4440039">ecdsaOk</span>&nbsp;<span class="builtintype" id="4440047">bool</span><span class="op" id="4440051">)</span>&nbsp;<span class="op" id="4440053">*</span><span class="ident" id="4440054">cipherSuite</span>&nbsp;<span class="op" id="4440066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4440069">for</span>&nbsp;<span class="ident" id="4440073">_</span><span class="op" id="4440074">,</span>&nbsp;<span class="ident" id="4440076">supported</span>&nbsp;<span class="op" id="4440086">:=</span>&nbsp;<span class="keyword" id="4440089">range</span>&nbsp;<span class="ident" id="4440095">supportedCipherSuites</span>&nbsp;<span class="op" id="4440117">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4440121">if</span>&nbsp;<span class="ident" id="4440124">id</span>&nbsp;<span class="op" id="4440127">==</span>&nbsp;<span class="ident" id="4440130">supported</span>&nbsp;<span class="op" id="4440140">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4440145">var</span>&nbsp;<span class="ident" id="4440149">candidate</span>&nbsp;<span class="op" id="4440159">*</span><span class="ident" id="4440160">cipherSuite</span><br>
<span class="lineno"></span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4440176">for</span>&nbsp;<span class="ident" id="4440180">_</span><span class="op" id="4440181">,</span>&nbsp;<span class="ident" id="4440183">s</span>&nbsp;<span class="op" id="4440185">:=</span>&nbsp;<span class="keyword" id="4440188">range</span>&nbsp;<span class="ident" id="4440194">cipherSuites</span>&nbsp;<span class="op" id="4440207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4440213">if</span>&nbsp;<span class="ident" id="4440216">s</span><span class="op" id="4440217">.</span><span class="ident" id="4440218">id</span>&nbsp;<span class="op" id="4440221">==</span>&nbsp;<span class="ident" id="4440224">id</span>&nbsp;<span class="op" id="4440227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4440234">candidate</span>&nbsp;<span class="op" id="4440244">=</span>&nbsp;<span class="ident" id="4440246">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4440253">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4440263">}</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4440268">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4440273">if</span>&nbsp;<span class="ident" id="4440276">candidate</span>&nbsp;<span class="op" id="4440286">==</span>&nbsp;<span class="builtintype" id="4440289">nil</span>&nbsp;<span class="op" id="4440293">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4440299">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4440311">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4440316">//&nbsp;Don&#39;t&nbsp;select&nbsp;a&nbsp;ciphersuite&nbsp;which&nbsp;we&nbsp;can&#39;t</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4440364">//&nbsp;support&nbsp;for&nbsp;this&nbsp;client.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4440395">if</span>&nbsp;<span class="op" id="4440398">(</span><span class="ident" id="4440399">candidate</span><span class="op" id="4440408">.</span><span class="ident" id="4440409">flags</span><span class="op" id="4440414">&amp;</span><span class="ident" id="4440415">suiteECDHE</span>&nbsp;<span class="op" id="4440426">!=</span>&nbsp;<span class="num" id="4440429">0</span><span class="op" id="4440430">)</span>&nbsp;<span class="op" id="4440432">&amp;&amp;</span>&nbsp;<span class="op" id="4440435">!</span><span class="ident" id="4440436">ellipticOk</span>&nbsp;<span class="op" id="4440447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4440453">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4440465">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4440470">if</span>&nbsp;<span class="op" id="4440473">(</span><span class="ident" id="4440474">candidate</span><span class="op" id="4440483">.</span><span class="ident" id="4440484">flags</span><span class="op" id="4440489">&amp;</span><span class="ident" id="4440490">suiteECDSA</span>&nbsp;<span class="op" id="4440501">!=</span>&nbsp;<span class="num" id="4440504">0</span><span class="op" id="4440505">)</span>&nbsp;<span class="op" id="4440507">!=</span>&nbsp;<span class="ident" id="4440510">ecdsaOk</span>&nbsp;<span class="op" id="4440518">{</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4440524">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4440536">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4440541">if</span>&nbsp;<span class="ident" id="4440544">version</span>&nbsp;<span class="op" id="4440552">&lt;</span>&nbsp;<span class="ident" id="4440554">VersionTLS12</span>&nbsp;<span class="op" id="4440567">&amp;&amp;</span>&nbsp;<span class="ident" id="4440570">candidate</span><span class="op" id="4440579">.</span><span class="ident" id="4440580">flags</span><span class="op" id="4440585">&amp;</span><span class="ident" id="4440586">suiteTLS12</span>&nbsp;<span class="op" id="4440597">!=</span>&nbsp;<span class="num" id="4440600">0</span>&nbsp;<span class="op" id="4440602">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4440608">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4440620">}</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4440625">return</span>&nbsp;<span class="ident" id="4440632">candidate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4440644">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4440647">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4440651">return</span>&nbsp;<span class="builtintype" id="4440658">nil</span><br>
<span class="lineno">685</span><span class="op" id="4440662">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
