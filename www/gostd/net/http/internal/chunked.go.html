<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/internal</h2>
<ul>
<li><a href="/gostd/net/http/internal/chunked.go.html">chunked.go</a></li>
<li><a href="/gostd/net/http/internal/chunked_test.go.html">chunked_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4965189">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4965244">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4965298">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4965349">//&nbsp;The&nbsp;wire&nbsp;protocol&nbsp;for&nbsp;HTTP&#39;s&nbsp;&#34;chunked&#34;&nbsp;Transfer-Encoding.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4965411">//&nbsp;Package&nbsp;internal&nbsp;contains&nbsp;HTTP&nbsp;internals&nbsp;shared&nbsp;by&nbsp;net/http&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4965478">//&nbsp;net/http/httputil.</span><br>
<span class="lineno"></span><span class="keyword" id="4965500">package</span>&nbsp;<span class="ident" id="4965508">internal</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="4965518">import</span>&nbsp;<span class="op" id="4965525">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4965528">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4965537">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4965546">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4965556">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4965563">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="4965568">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4965571">const</span>&nbsp;<span class="ident" id="4965577">maxLineLength</span>&nbsp;<span class="op" id="4965591">=</span>&nbsp;<span class="num" id="4965593">4096</span>&nbsp;<span class="comment" id="4965598">//&nbsp;assumed&nbsp;&lt;=&nbsp;bufio.defaultBufSize</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="4965634">var</span>&nbsp;<span class="ident" id="4965638">ErrLineTooLong</span>&nbsp;<span class="op" id="4965653">=</span>&nbsp;<span class="ident" id="4965655">errors</span><span class="op" id="4965661">.</span><span class="ident" id="4965662">New</span><span class="op" id="4965665">(</span><span class="string" id="4965666">&#34;header&nbsp;line&nbsp;too&nbsp;long&#34;</span><span class="op" id="4965688">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4965691">//&nbsp;NewChunkedReader&nbsp;returns&nbsp;a&nbsp;new&nbsp;chunkedReader&nbsp;that&nbsp;translates&nbsp;the&nbsp;data&nbsp;read&nbsp;from&nbsp;r</span><br>
<span class="lineno"></span><span class="comment" id="4965776">//&nbsp;out&nbsp;of&nbsp;HTTP&nbsp;&#34;chunked&#34;&nbsp;format&nbsp;before&nbsp;returning&nbsp;it.</span><br>
<span class="lineno">25</span><span class="comment" id="4965829">//&nbsp;The&nbsp;chunkedReader&nbsp;returns&nbsp;io.EOF&nbsp;when&nbsp;the&nbsp;final&nbsp;0-length&nbsp;chunk&nbsp;is&nbsp;read.</span><br>
<span class="lineno"></span><span class="comment" id="4965904">//</span><br>
<span class="lineno"></span><span class="comment" id="4965907">//&nbsp;NewChunkedReader&nbsp;is&nbsp;not&nbsp;needed&nbsp;by&nbsp;normal&nbsp;applications.&nbsp;The&nbsp;http&nbsp;package</span><br>
<span class="lineno"></span><span class="comment" id="4965982">//&nbsp;automatically&nbsp;decodes&nbsp;chunking&nbsp;when&nbsp;reading&nbsp;response&nbsp;bodies.</span><br>
<span class="lineno"></span><span class="keyword" id="4966046">func</span>&nbsp;<span class="ident" id="4966051">NewChunkedReader</span><span class="op" id="4966067">(</span><span class="ident" id="4966068">r</span>&nbsp;<span class="ident" id="4966070">io</span><span class="op" id="4966072">.</span><span class="ident" id="4966073">Reader</span><span class="op" id="4966079">)</span>&nbsp;<span class="ident" id="4966081">io</span><span class="op" id="4966083">.</span><span class="ident" id="4966084">Reader</span>&nbsp;<span class="op" id="4966091">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4966094">br</span><span class="op" id="4966096">,</span>&nbsp;<span class="ident" id="4966098">ok</span>&nbsp;<span class="op" id="4966101">:=</span>&nbsp;<span class="ident" id="4966104">r</span><span class="op" id="4966105">.</span><span class="op" id="4966106">(</span><span class="op" id="4966107">*</span><span class="ident" id="4966108">bufio</span><span class="op" id="4966113">.</span><span class="ident" id="4966114">Reader</span><span class="op" id="4966120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4966123">if</span>&nbsp;<span class="op" id="4966126">!</span><span class="ident" id="4966127">ok</span>&nbsp;<span class="op" id="4966130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4966134">br</span>&nbsp;<span class="op" id="4966137">=</span>&nbsp;<span class="ident" id="4966139">bufio</span><span class="op" id="4966144">.</span><span class="ident" id="4966145">NewReader</span><span class="op" id="4966154">(</span><span class="ident" id="4966155">r</span><span class="op" id="4966156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4966159">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4966162">return</span>&nbsp;<span class="op" id="4966169">&amp;</span><span class="ident" id="4966170">chunkedReader</span><span class="op" id="4966183">{</span><span class="ident" id="4966184">r</span><span class="op" id="4966185">:</span>&nbsp;<span class="ident" id="4966187">br</span><span class="op" id="4966189">}</span><br>
<span class="lineno">35</span><span class="op" id="4966191">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4966194">type</span>&nbsp;<span class="ident" id="4966199">chunkedReader</span>&nbsp;<span class="keyword" id="4966213">struct</span>&nbsp;<span class="op" id="4966220">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4966223">r</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4966227">*</span><span class="ident" id="4966228">bufio</span><span class="op" id="4966233">.</span><span class="ident" id="4966234">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4966242">n</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4966246">uint64</span>&nbsp;<span class="comment" id="4966253">//&nbsp;unread&nbsp;bytes&nbsp;in&nbsp;chunk</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4966279">err</span>&nbsp;<span class="builtintype" id="4966283">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4966290">buf</span>&nbsp;<span class="op" id="4966294">[</span><span class="num" id="4966295">2</span><span class="op" id="4966296">]</span><span class="builtintype" id="4966297">byte</span><br>
<span class="lineno"></span><span class="op" id="4966302">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4966305">func</span>&nbsp;<span class="op" id="4966310">(</span><span class="ident" id="4966311">cr</span>&nbsp;<span class="op" id="4966314">*</span><span class="ident" id="4966315">chunkedReader</span><span class="op" id="4966328">)</span>&nbsp;<span class="ident" id="4966330">beginChunk</span><span class="op" id="4966340">(</span><span class="op" id="4966341">)</span>&nbsp;<span class="op" id="4966343">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4966346">//&nbsp;chunk-size&nbsp;CRLF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4966366">var</span>&nbsp;<span class="ident" id="4966370">line</span>&nbsp;<span class="op" id="4966375">[</span><span class="op" id="4966376">]</span><span class="builtintype" id="4966377">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4966383">line</span><span class="op" id="4966387">,</span>&nbsp;<span class="ident" id="4966389">cr</span><span class="op" id="4966391">.</span><span class="ident" id="4966392">err</span>&nbsp;<span class="op" id="4966396">=</span>&nbsp;<span class="ident" id="4966398">readLine</span><span class="op" id="4966406">(</span><span class="ident" id="4966407">cr</span><span class="op" id="4966409">.</span><span class="ident" id="4966410">r</span><span class="op" id="4966411">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4966414">if</span>&nbsp;<span class="ident" id="4966417">cr</span><span class="op" id="4966419">.</span><span class="ident" id="4966420">err</span>&nbsp;<span class="op" id="4966424">!=</span>&nbsp;<span class="ident" id="4966427">nil</span>&nbsp;<span class="op" id="4966431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4966435">return</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4966443">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4966446">cr</span><span class="op" id="4966448">.</span><span class="ident" id="4966449">n</span><span class="op" id="4966450">,</span>&nbsp;<span class="ident" id="4966452">cr</span><span class="op" id="4966454">.</span><span class="ident" id="4966455">err</span>&nbsp;<span class="op" id="4966459">=</span>&nbsp;<span class="ident" id="4966461">parseHexUint</span><span class="op" id="4966473">(</span><span class="ident" id="4966474">line</span><span class="op" id="4966478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4966481">if</span>&nbsp;<span class="ident" id="4966484">cr</span><span class="op" id="4966486">.</span><span class="ident" id="4966487">err</span>&nbsp;<span class="op" id="4966491">!=</span>&nbsp;<span class="ident" id="4966494">nil</span>&nbsp;<span class="op" id="4966498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4966502">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4966510">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4966513">if</span>&nbsp;<span class="ident" id="4966516">cr</span><span class="op" id="4966518">.</span><span class="ident" id="4966519">n</span>&nbsp;<span class="op" id="4966521">==</span>&nbsp;<span class="num" id="4966524">0</span>&nbsp;<span class="op" id="4966526">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4966530">cr</span><span class="op" id="4966532">.</span><span class="ident" id="4966533">err</span>&nbsp;<span class="op" id="4966537">=</span>&nbsp;<span class="ident" id="4966539">io</span><span class="op" id="4966541">.</span><span class="ident" id="4966542">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4966547">}</span><br>
<span class="lineno"></span><span class="op" id="4966549">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="4966552">func</span>&nbsp;<span class="op" id="4966557">(</span><span class="ident" id="4966558">cr</span>&nbsp;<span class="op" id="4966561">*</span><span class="ident" id="4966562">chunkedReader</span><span class="op" id="4966575">)</span>&nbsp;<span class="ident" id="4966577">chunkHeaderAvailable</span><span class="op" id="4966597">(</span><span class="op" id="4966598">)</span>&nbsp;<span class="builtintype" id="4966600">bool</span>&nbsp;<span class="op" id="4966605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4966608">n</span>&nbsp;<span class="op" id="4966610">:=</span>&nbsp;<span class="ident" id="4966613">cr</span><span class="op" id="4966615">.</span><span class="ident" id="4966616">r</span><span class="op" id="4966617">.</span><span class="ident" id="4966618">Buffered</span><span class="op" id="4966626">(</span><span class="op" id="4966627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4966630">if</span>&nbsp;<span class="ident" id="4966633">n</span>&nbsp;<span class="op" id="4966635">&gt;</span>&nbsp;<span class="num" id="4966637">0</span>&nbsp;<span class="op" id="4966639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4966643">peek</span><span class="op" id="4966647">,</span>&nbsp;<span class="ident" id="4966649">_</span>&nbsp;<span class="op" id="4966651">:=</span>&nbsp;<span class="ident" id="4966654">cr</span><span class="op" id="4966656">.</span><span class="ident" id="4966657">r</span><span class="op" id="4966658">.</span><span class="ident" id="4966659">Peek</span><span class="op" id="4966663">(</span><span class="ident" id="4966664">n</span><span class="op" id="4966665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4966669">return</span>&nbsp;<span class="ident" id="4966676">bytes</span><span class="op" id="4966681">.</span><span class="ident" id="4966682">IndexByte</span><span class="op" id="4966691">(</span><span class="ident" id="4966692">peek</span><span class="op" id="4966696">,</span>&nbsp;<span class="string" id="4966698">&#39;\n&#39;</span><span class="op" id="4966702">)</span>&nbsp;<span class="op" id="4966704">&gt;=</span>&nbsp;<span class="num" id="4966707">0</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4966710">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4966713">return</span>&nbsp;<span class="builtintype" id="4966720">false</span><br>
<span class="lineno"></span><span class="op" id="4966726">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4966729">func</span>&nbsp;<span class="op" id="4966734">(</span><span class="ident" id="4966735">cr</span>&nbsp;<span class="op" id="4966738">*</span><span class="ident" id="4966739">chunkedReader</span><span class="op" id="4966752">)</span>&nbsp;<span class="ident" id="4966754">Read</span><span class="op" id="4966758">(</span><span class="ident" id="4966759">b</span>&nbsp;<span class="op" id="4966761">[</span><span class="op" id="4966762">]</span><span class="builtintype" id="4966763">uint8</span><span class="op" id="4966768">)</span>&nbsp;<span class="op" id="4966770">(</span><span class="ident" id="4966771">n</span>&nbsp;<span class="builtintype" id="4966773">int</span><span class="op" id="4966776">,</span>&nbsp;<span class="ident" id="4966778">err</span>&nbsp;<span class="builtintype" id="4966782">error</span><span class="op" id="4966787">)</span>&nbsp;<span class="op" id="4966789">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4966792">for</span>&nbsp;<span class="ident" id="4966796">cr</span><span class="op" id="4966798">.</span><span class="ident" id="4966799">err</span>&nbsp;<span class="op" id="4966803">==</span>&nbsp;<span class="ident" id="4966806">nil</span>&nbsp;<span class="op" id="4966810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4966814">if</span>&nbsp;<span class="ident" id="4966817">cr</span><span class="op" id="4966819">.</span><span class="ident" id="4966820">n</span>&nbsp;<span class="op" id="4966822">==</span>&nbsp;<span class="num" id="4966825">0</span>&nbsp;<span class="op" id="4966827">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4966832">if</span>&nbsp;<span class="ident" id="4966835">n</span>&nbsp;<span class="op" id="4966837">&gt;</span>&nbsp;<span class="num" id="4966839">0</span>&nbsp;<span class="op" id="4966841">&amp;&amp;</span>&nbsp;<span class="op" id="4966844">!</span><span class="ident" id="4966845">cr</span><span class="op" id="4966847">.</span><span class="ident" id="4966848">chunkHeaderAvailable</span><span class="op" id="4966868">(</span><span class="op" id="4966869">)</span>&nbsp;<span class="op" id="4966871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4966877">//&nbsp;We&#39;ve&nbsp;read&nbsp;enough.&nbsp;Don&#39;t&nbsp;potentially&nbsp;block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4966927">//&nbsp;reading&nbsp;a&nbsp;new&nbsp;chunk&nbsp;header.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4966962">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4966971">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4966976">cr</span><span class="op" id="4966978">.</span><span class="ident" id="4966979">beginChunk</span><span class="op" id="4966989">(</span><span class="op" id="4966990">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4966995">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4967006">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4967010">if</span>&nbsp;<span class="builtinfunc" id="4967013">len</span><span class="op" id="4967016">(</span><span class="ident" id="4967017">b</span><span class="op" id="4967018">)</span>&nbsp;<span class="op" id="4967020">==</span>&nbsp;<span class="num" id="4967023">0</span>&nbsp;<span class="op" id="4967025">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4967030">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4967038">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4967042">rbuf</span>&nbsp;<span class="op" id="4967047">:=</span>&nbsp;<span class="ident" id="4967050">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4967054">if</span>&nbsp;<span class="ident" id="4967057">uint64</span><span class="op" id="4967063">(</span><span class="builtinfunc" id="4967064">len</span><span class="op" id="4967067">(</span><span class="ident" id="4967068">rbuf</span><span class="op" id="4967072">)</span><span class="op" id="4967073">)</span>&nbsp;<span class="op" id="4967075">&gt;</span>&nbsp;<span class="ident" id="4967077">cr</span><span class="op" id="4967079">.</span><span class="ident" id="4967080">n</span>&nbsp;<span class="op" id="4967082">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4967087">rbuf</span>&nbsp;<span class="op" id="4967092">=</span>&nbsp;<span class="ident" id="4967094">rbuf</span><span class="op" id="4967098">[</span><span class="op" id="4967099">:</span><span class="ident" id="4967100">cr</span><span class="op" id="4967102">.</span><span class="ident" id="4967103">n</span><span class="op" id="4967104">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4967108">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4967112">var</span>&nbsp;<span class="ident" id="4967116">n0</span>&nbsp;<span class="builtintype" id="4967119">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4967125">n0</span><span class="op" id="4967127">,</span>&nbsp;<span class="ident" id="4967129">cr</span><span class="op" id="4967131">.</span><span class="ident" id="4967132">err</span>&nbsp;<span class="op" id="4967136">=</span>&nbsp;<span class="ident" id="4967138">cr</span><span class="op" id="4967140">.</span><span class="ident" id="4967141">r</span><span class="op" id="4967142">.</span><span class="ident" id="4967143">Read</span><span class="op" id="4967147">(</span><span class="ident" id="4967148">rbuf</span><span class="op" id="4967152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4967156">n</span>&nbsp;<span class="op" id="4967158">+=</span>&nbsp;<span class="ident" id="4967161">n0</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4967166">b</span>&nbsp;<span class="op" id="4967168">=</span>&nbsp;<span class="ident" id="4967170">b</span><span class="op" id="4967171">[</span><span class="ident" id="4967172">n0</span><span class="op" id="4967174">:</span><span class="op" id="4967175">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4967179">cr</span><span class="op" id="4967181">.</span><span class="ident" id="4967182">n</span>&nbsp;<span class="op" id="4967184">-=</span>&nbsp;<span class="ident" id="4967187">uint64</span><span class="op" id="4967193">(</span><span class="ident" id="4967194">n0</span><span class="op" id="4967196">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4967200">//&nbsp;If&nbsp;we&#39;re&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;a&nbsp;chunk,&nbsp;read&nbsp;the&nbsp;next&nbsp;two</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4967255">//&nbsp;bytes&nbsp;to&nbsp;verify&nbsp;they&nbsp;are&nbsp;&#34;\r\n&#34;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4967293">if</span>&nbsp;<span class="ident" id="4967296">cr</span><span class="op" id="4967298">.</span><span class="ident" id="4967299">n</span>&nbsp;<span class="op" id="4967301">==</span>&nbsp;<span class="num" id="4967304">0</span>&nbsp;<span class="op" id="4967306">&amp;&amp;</span>&nbsp;<span class="ident" id="4967309">cr</span><span class="op" id="4967311">.</span><span class="ident" id="4967312">err</span>&nbsp;<span class="op" id="4967316">==</span>&nbsp;<span class="ident" id="4967319">nil</span>&nbsp;<span class="op" id="4967323">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4967328">if</span>&nbsp;<span class="ident" id="4967331">_</span><span class="op" id="4967332">,</span>&nbsp;<span class="ident" id="4967334">cr</span><span class="op" id="4967336">.</span><span class="ident" id="4967337">err</span>&nbsp;<span class="op" id="4967341">=</span>&nbsp;<span class="ident" id="4967343">io</span><span class="op" id="4967345">.</span><span class="ident" id="4967346">ReadFull</span><span class="op" id="4967354">(</span><span class="ident" id="4967355">cr</span><span class="op" id="4967357">.</span><span class="ident" id="4967358">r</span><span class="op" id="4967359">,</span>&nbsp;<span class="ident" id="4967361">cr</span><span class="op" id="4967363">.</span><span class="ident" id="4967364">buf</span><span class="op" id="4967367">[</span><span class="op" id="4967368">:</span><span class="num" id="4967369">2</span><span class="op" id="4967370">]</span><span class="op" id="4967371">)</span><span class="op" id="4967372">;</span>&nbsp;<span class="ident" id="4967374">cr</span><span class="op" id="4967376">.</span><span class="ident" id="4967377">err</span>&nbsp;<span class="op" id="4967381">==</span>&nbsp;<span class="ident" id="4967384">nil</span>&nbsp;<span class="op" id="4967388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4967394">if</span>&nbsp;<span class="ident" id="4967397">cr</span><span class="op" id="4967399">.</span><span class="ident" id="4967400">buf</span><span class="op" id="4967403">[</span><span class="num" id="4967404">0</span><span class="op" id="4967405">]</span>&nbsp;<span class="op" id="4967407">!=</span>&nbsp;<span class="string" id="4967410">&#39;\r&#39;</span>&nbsp;<span class="op" id="4967415">||</span>&nbsp;<span class="ident" id="4967418">cr</span><span class="op" id="4967420">.</span><span class="ident" id="4967421">buf</span><span class="op" id="4967424">[</span><span class="num" id="4967425">1</span><span class="op" id="4967426">]</span>&nbsp;<span class="op" id="4967428">!=</span>&nbsp;<span class="string" id="4967431">&#39;\n&#39;</span>&nbsp;<span class="op" id="4967436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4967443">cr</span><span class="op" id="4967445">.</span><span class="ident" id="4967446">err</span>&nbsp;<span class="op" id="4967450">=</span>&nbsp;<span class="ident" id="4967452">errors</span><span class="op" id="4967458">.</span><span class="ident" id="4967459">New</span><span class="op" id="4967462">(</span><span class="string" id="4967463">&#34;malformed&nbsp;chunked&nbsp;encoding&#34;</span><span class="op" id="4967491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4967497">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4967502">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4967506">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4967509">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4967512">return</span>&nbsp;<span class="ident" id="4967519">n</span><span class="op" id="4967520">,</span>&nbsp;<span class="ident" id="4967522">cr</span><span class="op" id="4967524">.</span><span class="ident" id="4967525">err</span><br>
<span class="lineno"></span><span class="op" id="4967529">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="comment" id="4967532">//&nbsp;Read&nbsp;a&nbsp;line&nbsp;of&nbsp;bytes&nbsp;(up&nbsp;to&nbsp;\n)&nbsp;from&nbsp;b.</span><br>
<span class="lineno"></span><span class="comment" id="4967575">//&nbsp;Give&nbsp;up&nbsp;if&nbsp;the&nbsp;line&nbsp;exceeds&nbsp;maxLineLength.</span><br>
<span class="lineno"></span><span class="comment" id="4967621">//&nbsp;The&nbsp;returned&nbsp;bytes&nbsp;are&nbsp;a&nbsp;pointer&nbsp;into&nbsp;storage&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="4967673">//&nbsp;the&nbsp;bufio,&nbsp;so&nbsp;they&nbsp;are&nbsp;only&nbsp;valid&nbsp;until&nbsp;the&nbsp;next&nbsp;bufio&nbsp;read.</span><br>
<span class="lineno"></span><span class="keyword" id="4967737">func</span>&nbsp;<span class="ident" id="4967742">readLine</span><span class="op" id="4967750">(</span><span class="ident" id="4967751">b</span>&nbsp;<span class="op" id="4967753">*</span><span class="ident" id="4967754">bufio</span><span class="op" id="4967759">.</span><span class="ident" id="4967760">Reader</span><span class="op" id="4967766">)</span>&nbsp;<span class="op" id="4967768">(</span><span class="ident" id="4967769">p</span>&nbsp;<span class="op" id="4967771">[</span><span class="op" id="4967772">]</span><span class="builtintype" id="4967773">byte</span><span class="op" id="4967777">,</span>&nbsp;<span class="ident" id="4967779">err</span>&nbsp;<span class="builtintype" id="4967783">error</span><span class="op" id="4967788">)</span>&nbsp;<span class="op" id="4967790">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4967793">if</span>&nbsp;<span class="ident" id="4967796">p</span><span class="op" id="4967797">,</span>&nbsp;<span class="ident" id="4967799">err</span>&nbsp;<span class="op" id="4967803">=</span>&nbsp;<span class="ident" id="4967805">b</span><span class="op" id="4967806">.</span><span class="ident" id="4967807">ReadSlice</span><span class="op" id="4967816">(</span><span class="string" id="4967817">&#39;\n&#39;</span><span class="op" id="4967821">)</span><span class="op" id="4967822">;</span>&nbsp;<span class="ident" id="4967824">err</span>&nbsp;<span class="op" id="4967828">!=</span>&nbsp;<span class="ident" id="4967831">nil</span>&nbsp;<span class="op" id="4967835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4967839">//&nbsp;We&nbsp;always&nbsp;know&nbsp;when&nbsp;EOF&nbsp;is&nbsp;coming.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4967879">//&nbsp;If&nbsp;the&nbsp;caller&nbsp;asked&nbsp;for&nbsp;a&nbsp;line,&nbsp;there&nbsp;should&nbsp;be&nbsp;a&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4967940">if</span>&nbsp;<span class="ident" id="4967943">err</span>&nbsp;<span class="op" id="4967947">==</span>&nbsp;<span class="ident" id="4967950">io</span><span class="op" id="4967952">.</span><span class="ident" id="4967953">EOF</span>&nbsp;<span class="op" id="4967957">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4967962">err</span>&nbsp;<span class="op" id="4967966">=</span>&nbsp;<span class="ident" id="4967968">io</span><span class="op" id="4967970">.</span><span class="ident" id="4967971">ErrUnexpectedEOF</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4967990">}</span>&nbsp;<span class="keyword" id="4967992">else</span>&nbsp;<span class="keyword" id="4967997">if</span>&nbsp;<span class="ident" id="4968000">err</span>&nbsp;<span class="op" id="4968004">==</span>&nbsp;<span class="ident" id="4968007">bufio</span><span class="op" id="4968012">.</span><span class="ident" id="4968013">ErrBufferFull</span>&nbsp;<span class="op" id="4968027">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4968032">err</span>&nbsp;<span class="op" id="4968036">=</span>&nbsp;<span class="ident" id="4968038">ErrLineTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4968055">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4968059">return</span>&nbsp;<span class="ident" id="4968066">nil</span><span class="op" id="4968069">,</span>&nbsp;<span class="ident" id="4968071">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4968076">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4968079">if</span>&nbsp;<span class="builtinfunc" id="4968082">len</span><span class="op" id="4968085">(</span><span class="ident" id="4968086">p</span><span class="op" id="4968087">)</span>&nbsp;<span class="op" id="4968089">&gt;=</span>&nbsp;<span class="ident" id="4968092">maxLineLength</span>&nbsp;<span class="op" id="4968106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4968110">return</span>&nbsp;<span class="ident" id="4968117">nil</span><span class="op" id="4968120">,</span>&nbsp;<span class="ident" id="4968122">ErrLineTooLong</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4968138">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4968141">return</span>&nbsp;<span class="ident" id="4968148">trimTrailingWhitespace</span><span class="op" id="4968170">(</span><span class="ident" id="4968171">p</span><span class="op" id="4968172">)</span><span class="op" id="4968173">,</span>&nbsp;<span class="ident" id="4968175">nil</span><br>
<span class="lineno"></span><span class="op" id="4968179">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="keyword" id="4968182">func</span>&nbsp;<span class="ident" id="4968187">trimTrailingWhitespace</span><span class="op" id="4968209">(</span><span class="ident" id="4968210">b</span>&nbsp;<span class="op" id="4968212">[</span><span class="op" id="4968213">]</span><span class="builtintype" id="4968214">byte</span><span class="op" id="4968218">)</span>&nbsp;<span class="op" id="4968220">[</span><span class="op" id="4968221">]</span><span class="builtintype" id="4968222">byte</span>&nbsp;<span class="op" id="4968227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4968230">for</span>&nbsp;<span class="builtinfunc" id="4968234">len</span><span class="op" id="4968237">(</span><span class="ident" id="4968238">b</span><span class="op" id="4968239">)</span>&nbsp;<span class="op" id="4968241">&gt;</span>&nbsp;<span class="num" id="4968243">0</span>&nbsp;<span class="op" id="4968245">&amp;&amp;</span>&nbsp;<span class="ident" id="4968248">isASCIISpace</span><span class="op" id="4968260">(</span><span class="ident" id="4968261">b</span><span class="op" id="4968262">[</span><span class="builtinfunc" id="4968263">len</span><span class="op" id="4968266">(</span><span class="ident" id="4968267">b</span><span class="op" id="4968268">)</span><span class="op" id="4968269">-</span><span class="num" id="4968270">1</span><span class="op" id="4968271">]</span><span class="op" id="4968272">)</span>&nbsp;<span class="op" id="4968274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4968278">b</span>&nbsp;<span class="op" id="4968280">=</span>&nbsp;<span class="ident" id="4968282">b</span><span class="op" id="4968283">[</span><span class="op" id="4968284">:</span><span class="builtinfunc" id="4968285">len</span><span class="op" id="4968288">(</span><span class="ident" id="4968289">b</span><span class="op" id="4968290">)</span><span class="op" id="4968291">-</span><span class="num" id="4968292">1</span><span class="op" id="4968293">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4968296">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4968299">return</span>&nbsp;<span class="ident" id="4968306">b</span><br>
<span class="lineno"></span><span class="op" id="4968308">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4968311">func</span>&nbsp;<span class="ident" id="4968316">isASCIISpace</span><span class="op" id="4968328">(</span><span class="ident" id="4968329">b</span>&nbsp;<span class="builtintype" id="4968331">byte</span><span class="op" id="4968335">)</span>&nbsp;<span class="builtintype" id="4968337">bool</span>&nbsp;<span class="op" id="4968342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4968345">return</span>&nbsp;<span class="ident" id="4968352">b</span>&nbsp;<span class="op" id="4968354">==</span>&nbsp;<span class="string" id="4968357">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="4968361">||</span>&nbsp;<span class="ident" id="4968364">b</span>&nbsp;<span class="op" id="4968366">==</span>&nbsp;<span class="string" id="4968369">&#39;\t&#39;</span>&nbsp;<span class="op" id="4968374">||</span>&nbsp;<span class="ident" id="4968377">b</span>&nbsp;<span class="op" id="4968379">==</span>&nbsp;<span class="string" id="4968382">&#39;\n&#39;</span>&nbsp;<span class="op" id="4968387">||</span>&nbsp;<span class="ident" id="4968390">b</span>&nbsp;<span class="op" id="4968392">==</span>&nbsp;<span class="string" id="4968395">&#39;\r&#39;</span><br>
<span class="lineno">135</span><span class="op" id="4968400">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4968403">//&nbsp;NewChunkedWriter&nbsp;returns&nbsp;a&nbsp;new&nbsp;chunkedWriter&nbsp;that&nbsp;translates&nbsp;writes&nbsp;into&nbsp;HTTP</span><br>
<span class="lineno"></span><span class="comment" id="4968484">//&nbsp;&#34;chunked&#34;&nbsp;format&nbsp;before&nbsp;writing&nbsp;them&nbsp;to&nbsp;w.&nbsp;Closing&nbsp;the&nbsp;returned&nbsp;chunkedWriter</span><br>
<span class="lineno"></span><span class="comment" id="4968565">//&nbsp;sends&nbsp;the&nbsp;final&nbsp;0-length&nbsp;chunk&nbsp;that&nbsp;marks&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;stream.</span><br>
<span class="lineno">140</span><span class="comment" id="4968633">//</span><br>
<span class="lineno"></span><span class="comment" id="4968636">//&nbsp;NewChunkedWriter&nbsp;is&nbsp;not&nbsp;needed&nbsp;by&nbsp;normal&nbsp;applications.&nbsp;The&nbsp;http</span><br>
<span class="lineno"></span><span class="comment" id="4968703">//&nbsp;package&nbsp;adds&nbsp;chunking&nbsp;automatically&nbsp;if&nbsp;handlers&nbsp;don&#39;t&nbsp;set&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4968766">//&nbsp;Content-Length&nbsp;header.&nbsp;Using&nbsp;newChunkedWriter&nbsp;inside&nbsp;a&nbsp;handler</span><br>
<span class="lineno"></span><span class="comment" id="4968832">//&nbsp;would&nbsp;result&nbsp;in&nbsp;double&nbsp;chunking&nbsp;or&nbsp;chunking&nbsp;with&nbsp;a&nbsp;Content-Length</span><br>
<span class="lineno">145</span><span class="comment" id="4968901">//&nbsp;length,&nbsp;both&nbsp;of&nbsp;which&nbsp;are&nbsp;wrong.</span><br>
<span class="lineno"></span><span class="keyword" id="4968937">func</span>&nbsp;<span class="ident" id="4968942">NewChunkedWriter</span><span class="op" id="4968958">(</span><span class="ident" id="4968959">w</span>&nbsp;<span class="ident" id="4968961">io</span><span class="op" id="4968963">.</span><span class="ident" id="4968964">Writer</span><span class="op" id="4968970">)</span>&nbsp;<span class="ident" id="4968972">io</span><span class="op" id="4968974">.</span><span class="ident" id="4968975">WriteCloser</span>&nbsp;<span class="op" id="4968987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4968990">return</span>&nbsp;<span class="op" id="4968997">&amp;</span><span class="ident" id="4968998">chunkedWriter</span><span class="op" id="4969011">{</span><span class="ident" id="4969012">w</span><span class="op" id="4969013">}</span><br>
<span class="lineno"></span><span class="op" id="4969015">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span><span class="comment" id="4969018">//&nbsp;Writing&nbsp;to&nbsp;chunkedWriter&nbsp;translates&nbsp;to&nbsp;writing&nbsp;in&nbsp;HTTP&nbsp;chunked&nbsp;Transfer</span><br>
<span class="lineno"></span><span class="comment" id="4969093">//&nbsp;Encoding&nbsp;wire&nbsp;format&nbsp;to&nbsp;the&nbsp;underlying&nbsp;Wire&nbsp;chunkedWriter.</span><br>
<span class="lineno"></span><span class="keyword" id="4969155">type</span>&nbsp;<span class="ident" id="4969160">chunkedWriter</span>&nbsp;<span class="keyword" id="4969174">struct</span>&nbsp;<span class="op" id="4969181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4969184">Wire</span>&nbsp;<span class="ident" id="4969189">io</span><span class="op" id="4969191">.</span><span class="ident" id="4969192">Writer</span><br>
<span class="lineno"></span><span class="op" id="4969199">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="4969202">//&nbsp;Write&nbsp;the&nbsp;contents&nbsp;of&nbsp;data&nbsp;as&nbsp;one&nbsp;chunk&nbsp;to&nbsp;Wire.</span><br>
<span class="lineno"></span><span class="comment" id="4969254">//&nbsp;NOTE:&nbsp;Note&nbsp;that&nbsp;the&nbsp;corresponding&nbsp;chunk-writing&nbsp;procedure&nbsp;in&nbsp;Conn.Write&nbsp;has</span><br>
<span class="lineno"></span><span class="comment" id="4969333">//&nbsp;a&nbsp;bug&nbsp;since&nbsp;it&nbsp;does&nbsp;not&nbsp;check&nbsp;for&nbsp;success&nbsp;of&nbsp;io.WriteString</span><br>
<span class="lineno"></span><span class="keyword" id="4969396">func</span>&nbsp;<span class="op" id="4969401">(</span><span class="ident" id="4969402">cw</span>&nbsp;<span class="op" id="4969405">*</span><span class="ident" id="4969406">chunkedWriter</span><span class="op" id="4969419">)</span>&nbsp;<span class="ident" id="4969421">Write</span><span class="op" id="4969426">(</span><span class="ident" id="4969427">data</span>&nbsp;<span class="op" id="4969432">[</span><span class="op" id="4969433">]</span><span class="builtintype" id="4969434">byte</span><span class="op" id="4969438">)</span>&nbsp;<span class="op" id="4969440">(</span><span class="ident" id="4969441">n</span>&nbsp;<span class="builtintype" id="4969443">int</span><span class="op" id="4969446">,</span>&nbsp;<span class="ident" id="4969448">err</span>&nbsp;<span class="builtintype" id="4969452">error</span><span class="op" id="4969457">)</span>&nbsp;<span class="op" id="4969459">{</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4969463">//&nbsp;Don&#39;t&nbsp;send&nbsp;0-length&nbsp;data.&nbsp;It&nbsp;looks&nbsp;like&nbsp;EOF&nbsp;for&nbsp;chunked&nbsp;encoding.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4969533">if</span>&nbsp;<span class="builtinfunc" id="4969536">len</span><span class="op" id="4969539">(</span><span class="ident" id="4969540">data</span><span class="op" id="4969544">)</span>&nbsp;<span class="op" id="4969546">==</span>&nbsp;<span class="num" id="4969549">0</span>&nbsp;<span class="op" id="4969551">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4969555">return</span>&nbsp;<span class="num" id="4969562">0</span><span class="op" id="4969563">,</span>&nbsp;<span class="ident" id="4969565">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4969570">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4969574">if</span>&nbsp;<span class="ident" id="4969577">_</span><span class="op" id="4969578">,</span>&nbsp;<span class="ident" id="4969580">err</span>&nbsp;<span class="op" id="4969584">=</span>&nbsp;<span class="ident" id="4969586">fmt</span><span class="op" id="4969589">.</span><span class="ident" id="4969590">Fprintf</span><span class="op" id="4969597">(</span><span class="ident" id="4969598">cw</span><span class="op" id="4969600">.</span><span class="ident" id="4969601">Wire</span><span class="op" id="4969605">,</span>&nbsp;<span class="string" id="4969607">&#34;%x\r\n&#34;</span><span class="op" id="4969615">,</span>&nbsp;<span class="builtinfunc" id="4969617">len</span><span class="op" id="4969620">(</span><span class="ident" id="4969621">data</span><span class="op" id="4969625">)</span><span class="op" id="4969626">)</span><span class="op" id="4969627">;</span>&nbsp;<span class="ident" id="4969629">err</span>&nbsp;<span class="op" id="4969633">!=</span>&nbsp;<span class="ident" id="4969636">nil</span>&nbsp;<span class="op" id="4969640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4969644">return</span>&nbsp;<span class="num" id="4969651">0</span><span class="op" id="4969652">,</span>&nbsp;<span class="ident" id="4969654">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4969659">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4969662">if</span>&nbsp;<span class="ident" id="4969665">n</span><span class="op" id="4969666">,</span>&nbsp;<span class="ident" id="4969668">err</span>&nbsp;<span class="op" id="4969672">=</span>&nbsp;<span class="ident" id="4969674">cw</span><span class="op" id="4969676">.</span><span class="ident" id="4969677">Wire</span><span class="op" id="4969681">.</span><span class="ident" id="4969682">Write</span><span class="op" id="4969687">(</span><span class="ident" id="4969688">data</span><span class="op" id="4969692">)</span><span class="op" id="4969693">;</span>&nbsp;<span class="ident" id="4969695">err</span>&nbsp;<span class="op" id="4969699">!=</span>&nbsp;<span class="ident" id="4969702">nil</span>&nbsp;<span class="op" id="4969706">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4969710">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4969718">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4969721">if</span>&nbsp;<span class="ident" id="4969724">n</span>&nbsp;<span class="op" id="4969726">!=</span>&nbsp;<span class="builtinfunc" id="4969729">len</span><span class="op" id="4969732">(</span><span class="ident" id="4969733">data</span><span class="op" id="4969737">)</span>&nbsp;<span class="op" id="4969739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4969743">err</span>&nbsp;<span class="op" id="4969747">=</span>&nbsp;<span class="ident" id="4969749">io</span><span class="op" id="4969751">.</span><span class="ident" id="4969752">ErrShortWrite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4969768">return</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4969776">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4969779">_</span><span class="op" id="4969780">,</span>&nbsp;<span class="ident" id="4969782">err</span>&nbsp;<span class="op" id="4969786">=</span>&nbsp;<span class="ident" id="4969788">io</span><span class="op" id="4969790">.</span><span class="ident" id="4969791">WriteString</span><span class="op" id="4969802">(</span><span class="ident" id="4969803">cw</span><span class="op" id="4969805">.</span><span class="ident" id="4969806">Wire</span><span class="op" id="4969810">,</span>&nbsp;<span class="string" id="4969812">&#34;\r\n&#34;</span><span class="op" id="4969818">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4969822">return</span><br>
<span class="lineno"></span><span class="op" id="4969829">}</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span><span class="keyword" id="4969832">func</span>&nbsp;<span class="op" id="4969837">(</span><span class="ident" id="4969838">cw</span>&nbsp;<span class="op" id="4969841">*</span><span class="ident" id="4969842">chunkedWriter</span><span class="op" id="4969855">)</span>&nbsp;<span class="ident" id="4969857">Close</span><span class="op" id="4969862">(</span><span class="op" id="4969863">)</span>&nbsp;<span class="builtintype" id="4969865">error</span>&nbsp;<span class="op" id="4969871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4969874">_</span><span class="op" id="4969875">,</span>&nbsp;<span class="ident" id="4969877">err</span>&nbsp;<span class="op" id="4969881">:=</span>&nbsp;<span class="ident" id="4969884">io</span><span class="op" id="4969886">.</span><span class="ident" id="4969887">WriteString</span><span class="op" id="4969898">(</span><span class="ident" id="4969899">cw</span><span class="op" id="4969901">.</span><span class="ident" id="4969902">Wire</span><span class="op" id="4969906">,</span>&nbsp;<span class="string" id="4969908">&#34;0\r\n&#34;</span><span class="op" id="4969915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4969918">return</span>&nbsp;<span class="ident" id="4969925">err</span><br>
<span class="lineno"></span><span class="op" id="4969929">}</span><br>
<span class="lineno">185</span><br>
<span class="lineno"></span><span class="keyword" id="4969932">func</span>&nbsp;<span class="ident" id="4969937">parseHexUint</span><span class="op" id="4969949">(</span><span class="ident" id="4969950">v</span>&nbsp;<span class="op" id="4969952">[</span><span class="op" id="4969953">]</span><span class="builtintype" id="4969954">byte</span><span class="op" id="4969958">)</span>&nbsp;<span class="op" id="4969960">(</span><span class="ident" id="4969961">n</span>&nbsp;<span class="ident" id="4969963">uint64</span><span class="op" id="4969969">,</span>&nbsp;<span class="ident" id="4969971">err</span>&nbsp;<span class="builtintype" id="4969975">error</span><span class="op" id="4969980">)</span>&nbsp;<span class="op" id="4969982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4969985">for</span>&nbsp;<span class="ident" id="4969989">_</span><span class="op" id="4969990">,</span>&nbsp;<span class="ident" id="4969992">b</span>&nbsp;<span class="op" id="4969994">:=</span>&nbsp;<span class="keyword" id="4969997">range</span>&nbsp;<span class="ident" id="4970003">v</span>&nbsp;<span class="op" id="4970005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4970009">n</span>&nbsp;<span class="op" id="4970011">&lt;&lt;=</span>&nbsp;<span class="num" id="4970015">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4970019">switch</span>&nbsp;<span class="op" id="4970026">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4970030">case</span>&nbsp;<span class="string" id="4970035">&#39;0&#39;</span>&nbsp;<span class="op" id="4970039">&lt;=</span>&nbsp;<span class="ident" id="4970042">b</span>&nbsp;<span class="op" id="4970044">&amp;&amp;</span>&nbsp;<span class="ident" id="4970047">b</span>&nbsp;<span class="op" id="4970049">&lt;=</span>&nbsp;<span class="string" id="4970052">&#39;9&#39;</span><span class="op" id="4970055">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4970060">b</span>&nbsp;<span class="op" id="4970062">=</span>&nbsp;<span class="ident" id="4970064">b</span>&nbsp;<span class="op" id="4970066">-</span>&nbsp;<span class="string" id="4970068">&#39;0&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4970074">case</span>&nbsp;<span class="string" id="4970079">&#39;a&#39;</span>&nbsp;<span class="op" id="4970083">&lt;=</span>&nbsp;<span class="ident" id="4970086">b</span>&nbsp;<span class="op" id="4970088">&amp;&amp;</span>&nbsp;<span class="ident" id="4970091">b</span>&nbsp;<span class="op" id="4970093">&lt;=</span>&nbsp;<span class="string" id="4970096">&#39;f&#39;</span><span class="op" id="4970099">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4970104">b</span>&nbsp;<span class="op" id="4970106">=</span>&nbsp;<span class="ident" id="4970108">b</span>&nbsp;<span class="op" id="4970110">-</span>&nbsp;<span class="string" id="4970112">&#39;a&#39;</span>&nbsp;<span class="op" id="4970116">+</span>&nbsp;<span class="num" id="4970118">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4970123">case</span>&nbsp;<span class="string" id="4970128">&#39;A&#39;</span>&nbsp;<span class="op" id="4970132">&lt;=</span>&nbsp;<span class="ident" id="4970135">b</span>&nbsp;<span class="op" id="4970137">&amp;&amp;</span>&nbsp;<span class="ident" id="4970140">b</span>&nbsp;<span class="op" id="4970142">&lt;=</span>&nbsp;<span class="string" id="4970145">&#39;F&#39;</span><span class="op" id="4970148">:</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4970153">b</span>&nbsp;<span class="op" id="4970155">=</span>&nbsp;<span class="ident" id="4970157">b</span>&nbsp;<span class="op" id="4970159">-</span>&nbsp;<span class="string" id="4970161">&#39;A&#39;</span>&nbsp;<span class="op" id="4970165">+</span>&nbsp;<span class="num" id="4970167">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4970172">default</span><span class="op" id="4970179">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4970184">return</span>&nbsp;<span class="num" id="4970191">0</span><span class="op" id="4970192">,</span>&nbsp;<span class="ident" id="4970194">errors</span><span class="op" id="4970200">.</span><span class="ident" id="4970201">New</span><span class="op" id="4970204">(</span><span class="string" id="4970205">&#34;invalid&nbsp;byte&nbsp;in&nbsp;chunk&nbsp;length&#34;</span><span class="op" id="4970235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4970239">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4970243">n</span>&nbsp;<span class="op" id="4970245">|=</span>&nbsp;<span class="ident" id="4970248">uint64</span><span class="op" id="4970254">(</span><span class="ident" id="4970255">b</span><span class="op" id="4970256">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4970259">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4970262">return</span><br>
<span class="lineno"></span><span class="op" id="4970269">}</span>
</div>
</body>
</html>
