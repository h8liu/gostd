<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>runtime/pprof</h2>
<ul>
<li><a href="/gostd/runtime/pprof/mprof_test.go.html">mprof_test.go</a></li>
<li><a href="/gostd/runtime/pprof/pprof.go.html">pprof.go</a></li>
<li><a href="/gostd/runtime/pprof/pprof_test.go.html">pprof_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5988847">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5988903">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5988957">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5989008">//&nbsp;Package&nbsp;pprof&nbsp;writes&nbsp;runtime&nbsp;profiling&nbsp;data&nbsp;in&nbsp;the&nbsp;format&nbsp;expected</span><br>
<span class="lineno"></span><span class="comment" id="5989078">//&nbsp;by&nbsp;the&nbsp;pprof&nbsp;visualization&nbsp;tool.</span><br>
<span class="lineno"></span><span class="comment" id="5989114">//&nbsp;For&nbsp;more&nbsp;information&nbsp;about&nbsp;pprof,&nbsp;see</span><br>
<span class="lineno"></span><span class="comment" id="5989155">//&nbsp;http://code.google.com/p/google-perftools/.</span><br>
<span class="lineno"></span><span class="keyword" id="5989202">package</span>&nbsp;<span class="ident" id="5989210">pprof</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="keyword" id="5989217">import</span>&nbsp;<span class="op" id="5989224">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5989227">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5989236">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5989245">&#34;fmt&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5989252">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5989258">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5989269">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5989277">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5989288">&#34;sync&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5989296">&#34;text/tabwriter&#34;</span><br>
<span class="lineno"></span><span class="op" id="5989313">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5989316">//&nbsp;BUG(rsc):&nbsp;Profiles&nbsp;are&nbsp;incomplete&nbsp;and&nbsp;inaccurate&nbsp;on&nbsp;NetBSD&nbsp;and&nbsp;OS&nbsp;X.</span><br>
<span class="lineno"></span><span class="comment" id="5989388">//&nbsp;See&nbsp;http://golang.org/issue/6047&nbsp;for&nbsp;details.</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="comment" id="5989438">//&nbsp;A&nbsp;Profile&nbsp;is&nbsp;a&nbsp;collection&nbsp;of&nbsp;stack&nbsp;traces&nbsp;showing&nbsp;the&nbsp;call&nbsp;sequences</span><br>
<span class="lineno"></span><span class="comment" id="5989510">//&nbsp;that&nbsp;led&nbsp;to&nbsp;instances&nbsp;of&nbsp;a&nbsp;particular&nbsp;event,&nbsp;such&nbsp;as&nbsp;allocation.</span><br>
<span class="lineno"></span><span class="comment" id="5989578">//&nbsp;Packages&nbsp;can&nbsp;create&nbsp;and&nbsp;maintain&nbsp;their&nbsp;own&nbsp;profiles;&nbsp;the&nbsp;most&nbsp;common</span><br>
<span class="lineno"></span><span class="comment" id="5989650">//&nbsp;use&nbsp;is&nbsp;for&nbsp;tracking&nbsp;resources&nbsp;that&nbsp;must&nbsp;be&nbsp;explicitly&nbsp;closed,&nbsp;such&nbsp;as&nbsp;files</span><br>
<span class="lineno">30</span><span class="comment" id="5989729">//&nbsp;or&nbsp;network&nbsp;connections.</span><br>
<span class="lineno"></span><span class="comment" id="5989756">//</span><br>
<span class="lineno"></span><span class="comment" id="5989759">//&nbsp;A&nbsp;Profile&#39;s&nbsp;methods&nbsp;can&nbsp;be&nbsp;called&nbsp;from&nbsp;multiple&nbsp;goroutines&nbsp;simultaneously.</span><br>
<span class="lineno"></span><span class="comment" id="5989837">//</span><br>
<span class="lineno"></span><span class="comment" id="5989840">//&nbsp;Each&nbsp;Profile&nbsp;has&nbsp;a&nbsp;unique&nbsp;name.&nbsp;&nbsp;A&nbsp;few&nbsp;profiles&nbsp;are&nbsp;predefined:</span><br>
<span class="lineno">35</span><span class="comment" id="5989907">//</span><br>
<span class="lineno"></span><span class="comment" id="5989910">//&nbsp;&nbsp;&nbsp;&nbspgoroutine&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;stack&nbsp;traces&nbsp;of&nbsp;all&nbsp;current&nbsp;goroutines</span><br>
<span class="lineno"></span><span class="comment" id="5989967">//&nbsp;&nbsp;&nbsp;&nbspheap&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;a&nbsp;sampling&nbsp;of&nbsp;all&nbsp;heap&nbsp;allocations</span><br>
<span class="lineno"></span><span class="comment" id="5990020">//&nbsp;&nbsp;&nbsp;&nbspthreadcreate&nbsp;-&nbsp;stack&nbsp;traces&nbsp;that&nbsp;led&nbsp;to&nbsp;the&nbsp;creation&nbsp;of&nbsp;new&nbsp;OS&nbsp;threads</span><br>
<span class="lineno"></span><span class="comment" id="5990094">//&nbsp;&nbsp;&nbsp;&nbspblock&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;stack&nbsp;traces&nbsp;that&nbsp;led&nbsp;to&nbsp;blocking&nbsp;on&nbsp;synchronization&nbsp;primitives</span><br>
<span class="lineno">40</span><span class="comment" id="5990176">//</span><br>
<span class="lineno"></span><span class="comment" id="5990179">//&nbsp;These&nbsp;predefined&nbsp;profiles&nbsp;maintain&nbsp;themselves&nbsp;and&nbsp;panic&nbsp;on&nbsp;an&nbsp;explicit</span><br>
<span class="lineno"></span><span class="comment" id="5990253">//&nbsp;Add&nbsp;or&nbsp;Remove&nbsp;method&nbsp;call.</span><br>
<span class="lineno"></span><span class="comment" id="5990283">//</span><br>
<span class="lineno"></span><span class="comment" id="5990286">//&nbsp;The&nbsp;CPU&nbsp;profile&nbsp;is&nbsp;not&nbsp;available&nbsp;as&nbsp;a&nbsp;Profile.&nbsp;&nbsp;It&nbsp;has&nbsp;a&nbsp;special&nbsp;API,</span><br>
<span class="lineno">45</span><span class="comment" id="5990359">//&nbsp;the&nbsp;StartCPUProfile&nbsp;and&nbsp;StopCPUProfile&nbsp;functions,&nbsp;because&nbsp;it&nbsp;streams</span><br>
<span class="lineno"></span><span class="comment" id="5990431">//&nbsp;output&nbsp;to&nbsp;a&nbsp;writer&nbsp;during&nbsp;profiling.</span><br>
<span class="lineno"></span><span class="comment" id="5990471">//</span><br>
<span class="lineno"></span><span class="keyword" id="5990474">type</span>&nbsp;<span class="ident" id="5990479">Profile</span>&nbsp;<span class="keyword" id="5990487">struct</span>&nbsp;<span class="op" id="5990494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5990497">name</span>&nbsp;&nbsp;<span class="builtintype" id="5990503">string</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5990511">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5990517">sync</span><span class="op" id="5990521">.</span><span class="ident" id="5990522">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5990529">m</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5990535">map</span><span class="op" id="5990538">[</span><span class="keyword" id="5990539">interface</span><span class="op" id="5990548">{</span><span class="op" id="5990549">}</span><span class="op" id="5990550">]</span><span class="op" id="5990551">[</span><span class="op" id="5990552">]</span><span class="builtintype" id="5990553">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5990562">count</span>&nbsp;<span class="keyword" id="5990568">func</span><span class="op" id="5990572">(</span><span class="op" id="5990573">)</span>&nbsp;<span class="builtintype" id="5990575">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5990580">write</span>&nbsp;<span class="keyword" id="5990586">func</span><span class="op" id="5990590">(</span><span class="ident" id="5990591">io</span><span class="op" id="5990593">.</span><span class="ident" id="5990594">Writer</span><span class="op" id="5990600">,</span>&nbsp;<span class="builtintype" id="5990602">int</span><span class="op" id="5990605">)</span>&nbsp;<span class="builtintype" id="5990607">error</span><br>
<span class="lineno"></span><span class="op" id="5990613">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="comment" id="5990616">//&nbsp;profiles&nbsp;records&nbsp;all&nbsp;registered&nbsp;profiles.</span><br>
<span class="lineno"></span><span class="keyword" id="5990661">var</span>&nbsp;<span class="ident" id="5990665">profiles</span>&nbsp;<span class="keyword" id="5990674">struct</span>&nbsp;<span class="op" id="5990681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5990684">mu</span>&nbsp;<span class="ident" id="5990687">sync</span><span class="op" id="5990691">.</span><span class="ident" id="5990692">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5990699">m</span>&nbsp;&nbsp;<span class="keyword" id="5990702">map</span><span class="op" id="5990705">[</span><span class="builtintype" id="5990706">string</span><span class="op" id="5990712">]</span><span class="op" id="5990713">*</span><span class="ident" id="5990714">Profile</span><br>
<span class="lineno">60</span><span class="op" id="5990722">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5990725">var</span>&nbsp;<span class="ident" id="5990729">goroutineProfile</span>&nbsp;<span class="op" id="5990746">=</span>&nbsp;<span class="op" id="5990748">&amp;</span><span class="ident" id="5990749">Profile</span><span class="op" id="5990756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5990759">name</span><span class="op" id="5990763">:</span>&nbsp;&nbsp;<span class="string" id="5990766">&#34;goroutine&#34;</span><span class="op" id="5990777">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5990780">count</span><span class="op" id="5990785">:</span>&nbsp;<span class="ident" id="5990787">countGoroutine</span><span class="op" id="5990801">,</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5990804">write</span><span class="op" id="5990809">:</span>&nbsp;<span class="ident" id="5990811">writeGoroutine</span><span class="op" id="5990825">,</span><br>
<span class="lineno"></span><span class="op" id="5990827">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5990830">var</span>&nbsp;<span class="ident" id="5990834">threadcreateProfile</span>&nbsp;<span class="op" id="5990854">=</span>&nbsp;<span class="op" id="5990856">&amp;</span><span class="ident" id="5990857">Profile</span><span class="op" id="5990864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5990867">name</span><span class="op" id="5990871">:</span>&nbsp;&nbsp;<span class="string" id="5990874">&#34;threadcreate&#34;</span><span class="op" id="5990888">,</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5990891">count</span><span class="op" id="5990896">:</span>&nbsp;<span class="ident" id="5990898">countThreadCreate</span><span class="op" id="5990915">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5990918">write</span><span class="op" id="5990923">:</span>&nbsp;<span class="ident" id="5990925">writeThreadCreate</span><span class="op" id="5990942">,</span><br>
<span class="lineno"></span><span class="op" id="5990944">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5990947">var</span>&nbsp;<span class="ident" id="5990951">heapProfile</span>&nbsp;<span class="op" id="5990963">=</span>&nbsp;<span class="op" id="5990965">&amp;</span><span class="ident" id="5990966">Profile</span><span class="op" id="5990973">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5990976">name</span><span class="op" id="5990980">:</span>&nbsp;&nbsp;<span class="string" id="5990983">&#34;heap&#34;</span><span class="op" id="5990989">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5990992">count</span><span class="op" id="5990997">:</span>&nbsp;<span class="ident" id="5990999">countHeap</span><span class="op" id="5991008">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5991011">write</span><span class="op" id="5991016">:</span>&nbsp;<span class="ident" id="5991018">writeHeap</span><span class="op" id="5991027">,</span><br>
<span class="lineno"></span><span class="op" id="5991029">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">80</span><span class="keyword" id="5991032">var</span>&nbsp;<span class="ident" id="5991036">blockProfile</span>&nbsp;<span class="op" id="5991049">=</span>&nbsp;<span class="op" id="5991051">&amp;</span><span class="ident" id="5991052">Profile</span><span class="op" id="5991059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5991062">name</span><span class="op" id="5991066">:</span>&nbsp;&nbsp;<span class="string" id="5991069">&#34;block&#34;</span><span class="op" id="5991076">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5991079">count</span><span class="op" id="5991084">:</span>&nbsp;<span class="ident" id="5991086">countBlock</span><span class="op" id="5991096">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5991099">write</span><span class="op" id="5991104">:</span>&nbsp;<span class="ident" id="5991106">writeBlock</span><span class="op" id="5991116">,</span><br>
<span class="lineno"></span><span class="op" id="5991118">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span><span class="keyword" id="5991121">func</span>&nbsp;<span class="ident" id="5991126">lockProfiles</span><span class="op" id="5991138">(</span><span class="op" id="5991139">)</span>&nbsp;<span class="op" id="5991141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5991144">profiles</span><span class="op" id="5991152">.</span><span class="ident" id="5991153">mu</span><span class="op" id="5991155">.</span><span class="ident" id="5991156">Lock</span><span class="op" id="5991160">(</span><span class="op" id="5991161">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5991164">if</span>&nbsp;<span class="ident" id="5991167">profiles</span><span class="op" id="5991175">.</span><span class="ident" id="5991176">m</span>&nbsp;<span class="op" id="5991178">==</span>&nbsp;<span class="ident" id="5991181">nil</span>&nbsp;<span class="op" id="5991185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5991189">//&nbsp;Initial&nbsp;built-in&nbsp;profiles.</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5991221">profiles</span><span class="op" id="5991229">.</span><span class="ident" id="5991230">m</span>&nbsp;<span class="op" id="5991232">=</span>&nbsp;<span class="keyword" id="5991234">map</span><span class="op" id="5991237">[</span><span class="builtintype" id="5991238">string</span><span class="op" id="5991244">]</span><span class="op" id="5991245">*</span><span class="ident" id="5991246">Profile</span><span class="op" id="5991253">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5991258">&#34;goroutine&#34;</span><span class="op" id="5991269">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5991274">goroutineProfile</span><span class="op" id="5991290">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5991295">&#34;threadcreate&#34;</span><span class="op" id="5991309">:</span>&nbsp;<span class="ident" id="5991311">threadcreateProfile</span><span class="op" id="5991330">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5991335">&#34;heap&#34;</span><span class="op" id="5991341">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5991351">heapProfile</span><span class="op" id="5991362">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5991367">&#34;block&#34;</span><span class="op" id="5991374">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5991383">blockProfile</span><span class="op" id="5991395">,</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5991399">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5991402">}</span><br>
<span class="lineno"></span><span class="op" id="5991404">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5991407">func</span>&nbsp;<span class="ident" id="5991412">unlockProfiles</span><span class="op" id="5991426">(</span><span class="op" id="5991427">)</span>&nbsp;<span class="op" id="5991429">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5991432">profiles</span><span class="op" id="5991440">.</span><span class="ident" id="5991441">mu</span><span class="op" id="5991443">.</span><span class="ident" id="5991444">Unlock</span><span class="op" id="5991450">(</span><span class="op" id="5991451">)</span><br>
<span class="lineno"></span><span class="op" id="5991453">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5991456">//&nbsp;NewProfile&nbsp;creates&nbsp;a&nbsp;new&nbsp;profile&nbsp;with&nbsp;the&nbsp;given&nbsp;name.</span><br>
<span class="lineno"></span><span class="comment" id="5991513">//&nbsp;If&nbsp;a&nbsp;profile&nbsp;with&nbsp;that&nbsp;name&nbsp;already&nbsp;exists,&nbsp;NewProfile&nbsp;panics.</span><br>
<span class="lineno">105</span><span class="comment" id="5991579">//&nbsp;The&nbsp;convention&nbsp;is&nbsp;to&nbsp;use&nbsp;a&nbsp;&#39;import/path.&#39;&nbsp;prefix&nbsp;to&nbsp;create</span><br>
<span class="lineno"></span><span class="comment" id="5991641">//&nbsp;separate&nbsp;name&nbsp;spaces&nbsp;for&nbsp;each&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="5991683">func</span>&nbsp;<span class="ident" id="5991688">NewProfile</span><span class="op" id="5991698">(</span><span class="ident" id="5991699">name</span>&nbsp;<span class="builtintype" id="5991704">string</span><span class="op" id="5991710">)</span>&nbsp;<span class="op" id="5991712">*</span><span class="ident" id="5991713">Profile</span>&nbsp;<span class="op" id="5991721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5991724">lockProfiles</span><span class="op" id="5991736">(</span><span class="op" id="5991737">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5991740">defer</span>&nbsp;<span class="ident" id="5991746">unlockProfiles</span><span class="op" id="5991760">(</span><span class="op" id="5991761">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5991764">if</span>&nbsp;<span class="ident" id="5991767">name</span>&nbsp;<span class="op" id="5991772">==</span>&nbsp;<span class="string" id="5991775">&#34;&#34;</span>&nbsp;<span class="op" id="5991778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5991782">panic</span><span class="op" id="5991787">(</span><span class="string" id="5991788">&#34;pprof:&nbsp;NewProfile&nbsp;with&nbsp;empty&nbsp;name&#34;</span><span class="op" id="5991823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5991826">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5991829">if</span>&nbsp;<span class="ident" id="5991832">profiles</span><span class="op" id="5991840">.</span><span class="ident" id="5991841">m</span><span class="op" id="5991842">[</span><span class="ident" id="5991843">name</span><span class="op" id="5991847">]</span>&nbsp;<span class="op" id="5991849">!=</span>&nbsp;<span class="ident" id="5991852">nil</span>&nbsp;<span class="op" id="5991856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5991860">panic</span><span class="op" id="5991865">(</span><span class="string" id="5991866">&#34;pprof:&nbsp;NewProfile&nbsp;name&nbsp;already&nbsp;in&nbsp;use:&nbsp;&#34;</span>&nbsp;<span class="op" id="5991908">+</span>&nbsp;<span class="ident" id="5991910">name</span><span class="op" id="5991914">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5991917">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5991920">p</span>&nbsp;<span class="op" id="5991922">:=</span>&nbsp;<span class="op" id="5991925">&amp;</span><span class="ident" id="5991926">Profile</span><span class="op" id="5991933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5991937">name</span><span class="op" id="5991941">:</span>&nbsp;<span class="ident" id="5991943">name</span><span class="op" id="5991947">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5991951">m</span><span class="op" id="5991952">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5991957">map</span><span class="op" id="5991960">[</span><span class="keyword" id="5991961">interface</span><span class="op" id="5991970">{</span><span class="op" id="5991971">}</span><span class="op" id="5991972">]</span><span class="op" id="5991973">[</span><span class="op" id="5991974">]</span><span class="builtintype" id="5991975">uintptr</span><span class="op" id="5991982">{</span><span class="op" id="5991983">}</span><span class="op" id="5991984">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5991987">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5991990">profiles</span><span class="op" id="5991998">.</span><span class="ident" id="5991999">m</span><span class="op" id="5992000">[</span><span class="ident" id="5992001">name</span><span class="op" id="5992005">]</span>&nbsp;<span class="op" id="5992007">=</span>&nbsp;<span class="ident" id="5992009">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5992012">return</span>&nbsp;<span class="ident" id="5992019">p</span><br>
<span class="lineno"></span><span class="op" id="5992021">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5992024">//&nbsp;Lookup&nbsp;returns&nbsp;the&nbsp;profile&nbsp;with&nbsp;the&nbsp;given&nbsp;name,&nbsp;or&nbsp;nil&nbsp;if&nbsp;no&nbsp;such&nbsp;profile&nbsp;exists.</span><br>
<span class="lineno">125</span><span class="keyword" id="5992109">func</span>&nbsp;<span class="ident" id="5992114">Lookup</span><span class="op" id="5992120">(</span><span class="ident" id="5992121">name</span>&nbsp;<span class="builtintype" id="5992126">string</span><span class="op" id="5992132">)</span>&nbsp;<span class="op" id="5992134">*</span><span class="ident" id="5992135">Profile</span>&nbsp;<span class="op" id="5992143">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5992146">lockProfiles</span><span class="op" id="5992158">(</span><span class="op" id="5992159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5992162">defer</span>&nbsp;<span class="ident" id="5992168">unlockProfiles</span><span class="op" id="5992182">(</span><span class="op" id="5992183">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5992186">return</span>&nbsp;<span class="ident" id="5992193">profiles</span><span class="op" id="5992201">.</span><span class="ident" id="5992202">m</span><span class="op" id="5992203">[</span><span class="ident" id="5992204">name</span><span class="op" id="5992208">]</span><br>
<span class="lineno"></span><span class="op" id="5992210">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span><span class="comment" id="5992213">//&nbsp;Profiles&nbsp;returns&nbsp;a&nbsp;slice&nbsp;of&nbsp;all&nbsp;the&nbsp;known&nbsp;profiles,&nbsp;sorted&nbsp;by&nbsp;name.</span><br>
<span class="lineno"></span><span class="keyword" id="5992284">func</span>&nbsp;<span class="ident" id="5992289">Profiles</span><span class="op" id="5992297">(</span><span class="op" id="5992298">)</span>&nbsp;<span class="op" id="5992300">[</span><span class="op" id="5992301">]</span><span class="op" id="5992302">*</span><span class="ident" id="5992303">Profile</span>&nbsp;<span class="op" id="5992311">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5992314">lockProfiles</span><span class="op" id="5992326">(</span><span class="op" id="5992327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5992330">defer</span>&nbsp;<span class="ident" id="5992336">unlockProfiles</span><span class="op" id="5992350">(</span><span class="op" id="5992351">)</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5992355">var</span>&nbsp;<span class="ident" id="5992359">all</span>&nbsp;<span class="op" id="5992363">[</span><span class="op" id="5992364">]</span><span class="op" id="5992365">*</span><span class="ident" id="5992366">Profile</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5992375">for</span>&nbsp;<span class="ident" id="5992379">_</span><span class="op" id="5992380">,</span>&nbsp;<span class="ident" id="5992382">p</span>&nbsp;<span class="op" id="5992384">:=</span>&nbsp;<span class="keyword" id="5992387">range</span>&nbsp;<span class="ident" id="5992393">profiles</span><span class="op" id="5992401">.</span><span class="ident" id="5992402">m</span>&nbsp;<span class="op" id="5992404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5992408">all</span>&nbsp;<span class="op" id="5992412">=</span>&nbsp;<span class="builtinfunc" id="5992414">append</span><span class="op" id="5992420">(</span><span class="ident" id="5992421">all</span><span class="op" id="5992424">,</span>&nbsp;<span class="ident" id="5992426">p</span><span class="op" id="5992427">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5992430">}</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5992434">sort</span><span class="op" id="5992438">.</span><span class="ident" id="5992439">Sort</span><span class="op" id="5992443">(</span><span class="ident" id="5992444">byName</span><span class="op" id="5992450">(</span><span class="ident" id="5992451">all</span><span class="op" id="5992454">)</span><span class="op" id="5992455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5992458">return</span>&nbsp;<span class="ident" id="5992465">all</span><br>
<span class="lineno"></span><span class="op" id="5992469">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="keyword" id="5992472">type</span>&nbsp;<span class="ident" id="5992477">byName</span>&nbsp;<span class="op" id="5992484">[</span><span class="op" id="5992485">]</span><span class="op" id="5992486">*</span><span class="ident" id="5992487">Profile</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5992496">func</span>&nbsp;<span class="op" id="5992501">(</span><span class="ident" id="5992502">x</span>&nbsp;<span class="ident" id="5992504">byName</span><span class="op" id="5992510">)</span>&nbsp;<span class="ident" id="5992512">Len</span><span class="op" id="5992515">(</span><span class="op" id="5992516">)</span>&nbsp;<span class="builtintype" id="5992518">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5992532">{</span>&nbsp;<span class="keyword" id="5992534">return</span>&nbsp;<span class="builtinfunc" id="5992541">len</span><span class="op" id="5992544">(</span><span class="ident" id="5992545">x</span><span class="op" id="5992546">)</span>&nbsp;<span class="op" id="5992548">}</span><br>
<span class="lineno"></span><span class="keyword" id="5992550">func</span>&nbsp;<span class="op" id="5992555">(</span><span class="ident" id="5992556">x</span>&nbsp;<span class="ident" id="5992558">byName</span><span class="op" id="5992564">)</span>&nbsp;<span class="ident" id="5992566">Swap</span><span class="op" id="5992570">(</span><span class="ident" id="5992571">i</span><span class="op" id="5992572">,</span>&nbsp;<span class="ident" id="5992574">j</span>&nbsp;<span class="builtintype" id="5992576">int</span><span class="op" id="5992579">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5992586">{</span>&nbsp;<span class="ident" id="5992588">x</span><span class="op" id="5992589">[</span><span class="ident" id="5992590">i</span><span class="op" id="5992591">]</span><span class="op" id="5992592">,</span>&nbsp;<span class="ident" id="5992594">x</span><span class="op" id="5992595">[</span><span class="ident" id="5992596">j</span><span class="op" id="5992597">]</span>&nbsp;<span class="op" id="5992599">=</span>&nbsp;<span class="ident" id="5992601">x</span><span class="op" id="5992602">[</span><span class="ident" id="5992603">j</span><span class="op" id="5992604">]</span><span class="op" id="5992605">,</span>&nbsp;<span class="ident" id="5992607">x</span><span class="op" id="5992608">[</span><span class="ident" id="5992609">i</span><span class="op" id="5992610">]</span>&nbsp;<span class="op" id="5992612">}</span><br>
<span class="lineno"></span><span class="keyword" id="5992614">func</span>&nbsp;<span class="op" id="5992619">(</span><span class="ident" id="5992620">x</span>&nbsp;<span class="ident" id="5992622">byName</span><span class="op" id="5992628">)</span>&nbsp;<span class="ident" id="5992630">Less</span><span class="op" id="5992634">(</span><span class="ident" id="5992635">i</span><span class="op" id="5992636">,</span>&nbsp;<span class="ident" id="5992638">j</span>&nbsp;<span class="builtintype" id="5992640">int</span><span class="op" id="5992643">)</span>&nbsp;<span class="builtintype" id="5992645">bool</span>&nbsp;<span class="op" id="5992650">{</span>&nbsp;<span class="keyword" id="5992652">return</span>&nbsp;<span class="ident" id="5992659">x</span><span class="op" id="5992660">[</span><span class="ident" id="5992661">i</span><span class="op" id="5992662">]</span><span class="op" id="5992663">.</span><span class="ident" id="5992664">name</span>&nbsp;<span class="op" id="5992669">&lt;</span>&nbsp;<span class="ident" id="5992671">x</span><span class="op" id="5992672">[</span><span class="ident" id="5992673">j</span><span class="op" id="5992674">]</span><span class="op" id="5992675">.</span><span class="ident" id="5992676">name</span>&nbsp;<span class="op" id="5992681">}</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span><span class="comment" id="5992684">//&nbsp;Name&nbsp;returns&nbsp;this&nbsp;profile&#39;s&nbsp;name,&nbsp;which&nbsp;can&nbsp;be&nbsp;passed&nbsp;to&nbsp;Lookup&nbsp;to&nbsp;reobtain&nbsp;the&nbsp;profile.</span><br>
<span class="lineno"></span><span class="keyword" id="5992776">func</span>&nbsp;<span class="op" id="5992781">(</span><span class="ident" id="5992782">p</span>&nbsp;<span class="op" id="5992784">*</span><span class="ident" id="5992785">Profile</span><span class="op" id="5992792">)</span>&nbsp;<span class="ident" id="5992794">Name</span><span class="op" id="5992798">(</span><span class="op" id="5992799">)</span>&nbsp;<span class="builtintype" id="5992801">string</span>&nbsp;<span class="op" id="5992808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5992811">return</span>&nbsp;<span class="ident" id="5992818">p</span><span class="op" id="5992819">.</span><span class="ident" id="5992820">name</span><br>
<span class="lineno"></span><span class="op" id="5992825">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="5992828">//&nbsp;Count&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;execution&nbsp;stacks&nbsp;currently&nbsp;in&nbsp;the&nbsp;profile.</span><br>
<span class="lineno"></span><span class="keyword" id="5992902">func</span>&nbsp;<span class="op" id="5992907">(</span><span class="ident" id="5992908">p</span>&nbsp;<span class="op" id="5992910">*</span><span class="ident" id="5992911">Profile</span><span class="op" id="5992918">)</span>&nbsp;<span class="ident" id="5992920">Count</span><span class="op" id="5992925">(</span><span class="op" id="5992926">)</span>&nbsp;<span class="builtintype" id="5992928">int</span>&nbsp;<span class="op" id="5992932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5992935">p</span><span class="op" id="5992936">.</span><span class="ident" id="5992937">mu</span><span class="op" id="5992939">.</span><span class="ident" id="5992940">Lock</span><span class="op" id="5992944">(</span><span class="op" id="5992945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5992948">defer</span>&nbsp;<span class="ident" id="5992954">p</span><span class="op" id="5992955">.</span><span class="ident" id="5992956">mu</span><span class="op" id="5992958">.</span><span class="ident" id="5992959">Unlock</span><span class="op" id="5992965">(</span><span class="op" id="5992966">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5992969">if</span>&nbsp;<span class="ident" id="5992972">p</span><span class="op" id="5992973">.</span><span class="ident" id="5992974">count</span>&nbsp;<span class="op" id="5992980">!=</span>&nbsp;<span class="ident" id="5992983">nil</span>&nbsp;<span class="op" id="5992987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5992991">return</span>&nbsp;<span class="ident" id="5992998">p</span><span class="op" id="5992999">.</span><span class="ident" id="5993000">count</span><span class="op" id="5993005">(</span><span class="op" id="5993006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5993009">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5993012">return</span>&nbsp;<span class="builtinfunc" id="5993019">len</span><span class="op" id="5993022">(</span><span class="ident" id="5993023">p</span><span class="op" id="5993024">.</span><span class="ident" id="5993025">m</span><span class="op" id="5993026">)</span><br>
<span class="lineno"></span><span class="op" id="5993028">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="comment" id="5993031">//&nbsp;Add&nbsp;adds&nbsp;the&nbsp;current&nbsp;execution&nbsp;stack&nbsp;to&nbsp;the&nbsp;profile,&nbsp;associated&nbsp;with&nbsp;value.</span><br>
<span class="lineno"></span><span class="comment" id="5993110">//&nbsp;Add&nbsp;stores&nbsp;value&nbsp;in&nbsp;an&nbsp;internal&nbsp;map,&nbsp;so&nbsp;value&nbsp;must&nbsp;be&nbsp;suitable&nbsp;for&nbsp;use&nbsp;as</span><br>
<span class="lineno"></span><span class="comment" id="5993187">//&nbsp;a&nbsp;map&nbsp;key&nbsp;and&nbsp;will&nbsp;not&nbsp;be&nbsp;garbage&nbsp;collected&nbsp;until&nbsp;the&nbsp;corresponding</span><br>
<span class="lineno"></span><span class="comment" id="5993258">//&nbsp;call&nbsp;to&nbsp;Remove.&nbsp;&nbsp;Add&nbsp;panics&nbsp;if&nbsp;the&nbsp;profile&nbsp;already&nbsp;contains&nbsp;a&nbsp;stack&nbsp;for&nbsp;value.</span><br>
<span class="lineno">170</span><span class="comment" id="5993340">//</span><br>
<span class="lineno"></span><span class="comment" id="5993343">//&nbsp;The&nbsp;skip&nbsp;parameter&nbsp;has&nbsp;the&nbsp;same&nbsp;meaning&nbsp;as&nbsp;runtime.Caller&#39;s&nbsp;skip</span><br>
<span class="lineno"></span><span class="comment" id="5993411">//&nbsp;and&nbsp;controls&nbsp;where&nbsp;the&nbsp;stack&nbsp;trace&nbsp;begins.&nbsp;&nbsp;Passing&nbsp;skip=0&nbsp;begins&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5993484">//&nbsp;trace&nbsp;in&nbsp;the&nbsp;function&nbsp;calling&nbsp;Add.&nbsp;&nbsp;For&nbsp;example,&nbsp;given&nbsp;this</span><br>
<span class="lineno"></span><span class="comment" id="5993547">//&nbsp;execution&nbsp;stack:</span><br>
<span class="lineno">175</span><span class="comment" id="5993567">//</span><br>
<span class="lineno"></span><span class="comment" id="5993570">//&nbsp;&nbsp;&nbsp;&nbspAdd</span><br>
<span class="lineno"></span><span class="comment" id="5993577">//&nbsp;&nbsp;&nbsp;&nbspcalled&nbsp;from&nbsp;rpc.NewClient</span><br>
<span class="lineno"></span><span class="comment" id="5993606">//&nbsp;&nbsp;&nbsp;&nbspcalled&nbsp;from&nbsp;mypkg.Run</span><br>
<span class="lineno"></span><span class="comment" id="5993631">//&nbsp;&nbsp;&nbsp;&nbspcalled&nbsp;from&nbsp;main.main</span><br>
<span class="lineno">180</span><span class="comment" id="5993656">//</span><br>
<span class="lineno"></span><span class="comment" id="5993659">//&nbsp;Passing&nbsp;skip=0&nbsp;begins&nbsp;the&nbsp;stack&nbsp;trace&nbsp;at&nbsp;the&nbsp;call&nbsp;to&nbsp;Add&nbsp;inside&nbsp;rpc.NewClient.</span><br>
<span class="lineno"></span><span class="comment" id="5993741">//&nbsp;Passing&nbsp;skip=1&nbsp;begins&nbsp;the&nbsp;stack&nbsp;trace&nbsp;at&nbsp;the&nbsp;call&nbsp;to&nbsp;NewClient&nbsp;inside&nbsp;mypkg.Run.</span><br>
<span class="lineno"></span><span class="comment" id="5993825">//</span><br>
<span class="lineno"></span><span class="keyword" id="5993828">func</span>&nbsp;<span class="op" id="5993833">(</span><span class="ident" id="5993834">p</span>&nbsp;<span class="op" id="5993836">*</span><span class="ident" id="5993837">Profile</span><span class="op" id="5993844">)</span>&nbsp;<span class="ident" id="5993846">Add</span><span class="op" id="5993849">(</span><span class="ident" id="5993850">value</span>&nbsp;<span class="keyword" id="5993856">interface</span><span class="op" id="5993865">{</span><span class="op" id="5993866">}</span><span class="op" id="5993867">,</span>&nbsp;<span class="ident" id="5993869">skip</span>&nbsp;<span class="builtintype" id="5993874">int</span><span class="op" id="5993877">)</span>&nbsp;<span class="op" id="5993879">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5993882">if</span>&nbsp;<span class="ident" id="5993885">p</span><span class="op" id="5993886">.</span><span class="ident" id="5993887">name</span>&nbsp;<span class="op" id="5993892">==</span>&nbsp;<span class="string" id="5993895">&#34;&#34;</span>&nbsp;<span class="op" id="5993898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5993902">panic</span><span class="op" id="5993907">(</span><span class="string" id="5993908">&#34;pprof:&nbsp;use&nbsp;of&nbsp;uninitialized&nbsp;Profile&#34;</span><span class="op" id="5993945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5993948">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5993951">if</span>&nbsp;<span class="ident" id="5993954">p</span><span class="op" id="5993955">.</span><span class="ident" id="5993956">write</span>&nbsp;<span class="op" id="5993962">!=</span>&nbsp;<span class="ident" id="5993965">nil</span>&nbsp;<span class="op" id="5993969">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5993973">panic</span><span class="op" id="5993978">(</span><span class="string" id="5993979">&#34;pprof:&nbsp;Add&nbsp;called&nbsp;on&nbsp;built-in&nbsp;Profile&nbsp;&#34;</span>&nbsp;<span class="op" id="5994020">+</span>&nbsp;<span class="ident" id="5994022">p</span><span class="op" id="5994023">.</span><span class="ident" id="5994024">name</span><span class="op" id="5994028">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5994031">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5994035">stk</span>&nbsp;<span class="op" id="5994039">:=</span>&nbsp;<span class="builtinfunc" id="5994042">make</span><span class="op" id="5994046">(</span><span class="op" id="5994047">[</span><span class="op" id="5994048">]</span><span class="builtintype" id="5994049">uintptr</span><span class="op" id="5994056">,</span>&nbsp;<span class="num" id="5994058">32</span><span class="op" id="5994060">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5994063">n</span>&nbsp;<span class="op" id="5994065">:=</span>&nbsp;<span class="ident" id="5994068">runtime</span><span class="op" id="5994075">.</span><span class="ident" id="5994076">Callers</span><span class="op" id="5994083">(</span><span class="ident" id="5994084">skip</span><span class="op" id="5994088">+</span><span class="num" id="5994089">1</span><span class="op" id="5994090">,</span>&nbsp;<span class="ident" id="5994092">stk</span><span class="op" id="5994095">[</span><span class="op" id="5994096">:</span><span class="op" id="5994097">]</span><span class="op" id="5994098">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5994102">p</span><span class="op" id="5994103">.</span><span class="ident" id="5994104">mu</span><span class="op" id="5994106">.</span><span class="ident" id="5994107">Lock</span><span class="op" id="5994111">(</span><span class="op" id="5994112">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5994115">defer</span>&nbsp;<span class="ident" id="5994121">p</span><span class="op" id="5994122">.</span><span class="ident" id="5994123">mu</span><span class="op" id="5994125">.</span><span class="ident" id="5994126">Unlock</span><span class="op" id="5994132">(</span><span class="op" id="5994133">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5994136">if</span>&nbsp;<span class="ident" id="5994139">p</span><span class="op" id="5994140">.</span><span class="ident" id="5994141">m</span><span class="op" id="5994142">[</span><span class="ident" id="5994143">value</span><span class="op" id="5994148">]</span>&nbsp;<span class="op" id="5994150">!=</span>&nbsp;<span class="ident" id="5994153">nil</span>&nbsp;<span class="op" id="5994157">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5994161">panic</span><span class="op" id="5994166">(</span><span class="string" id="5994167">&#34;pprof:&nbsp;Profile.Add&nbsp;of&nbsp;duplicate&nbsp;value&#34;</span><span class="op" id="5994206">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5994209">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5994212">p</span><span class="op" id="5994213">.</span><span class="ident" id="5994214">m</span><span class="op" id="5994215">[</span><span class="ident" id="5994216">value</span><span class="op" id="5994221">]</span>&nbsp;<span class="op" id="5994223">=</span>&nbsp;<span class="ident" id="5994225">stk</span><span class="op" id="5994228">[</span><span class="op" id="5994229">:</span><span class="ident" id="5994230">n</span><span class="op" id="5994231">]</span><br>
<span class="lineno"></span><span class="op" id="5994233">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5994236">//&nbsp;Remove&nbsp;removes&nbsp;the&nbsp;execution&nbsp;stack&nbsp;associated&nbsp;with&nbsp;value&nbsp;from&nbsp;the&nbsp;profile.</span><br>
<span class="lineno"></span><span class="comment" id="5994314">//&nbsp;It&nbsp;is&nbsp;a&nbsp;no-op&nbsp;if&nbsp;the&nbsp;value&nbsp;is&nbsp;not&nbsp;in&nbsp;the&nbsp;profile.</span><br>
<span class="lineno">205</span><span class="keyword" id="5994367">func</span>&nbsp;<span class="op" id="5994372">(</span><span class="ident" id="5994373">p</span>&nbsp;<span class="op" id="5994375">*</span><span class="ident" id="5994376">Profile</span><span class="op" id="5994383">)</span>&nbsp;<span class="ident" id="5994385">Remove</span><span class="op" id="5994391">(</span><span class="ident" id="5994392">value</span>&nbsp;<span class="keyword" id="5994398">interface</span><span class="op" id="5994407">{</span><span class="op" id="5994408">}</span><span class="op" id="5994409">)</span>&nbsp;<span class="op" id="5994411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5994414">p</span><span class="op" id="5994415">.</span><span class="ident" id="5994416">mu</span><span class="op" id="5994418">.</span><span class="ident" id="5994419">Lock</span><span class="op" id="5994423">(</span><span class="op" id="5994424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5994427">defer</span>&nbsp;<span class="ident" id="5994433">p</span><span class="op" id="5994434">.</span><span class="ident" id="5994435">mu</span><span class="op" id="5994437">.</span><span class="ident" id="5994438">Unlock</span><span class="op" id="5994444">(</span><span class="op" id="5994445">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5994448">delete</span><span class="op" id="5994454">(</span><span class="ident" id="5994455">p</span><span class="op" id="5994456">.</span><span class="ident" id="5994457">m</span><span class="op" id="5994458">,</span>&nbsp;<span class="ident" id="5994460">value</span><span class="op" id="5994465">)</span><br>
<span class="lineno"></span><span class="op" id="5994467">}</span><br>
<span class="lineno">210</span><br>
<span class="lineno"></span><span class="comment" id="5994470">//&nbsp;WriteTo&nbsp;writes&nbsp;a&nbsp;pprof-formatted&nbsp;snapshot&nbsp;of&nbsp;the&nbsp;profile&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="comment" id="5994536">//&nbsp;If&nbsp;a&nbsp;write&nbsp;to&nbsp;w&nbsp;returns&nbsp;an&nbsp;error,&nbsp;WriteTo&nbsp;returns&nbsp;that&nbsp;error.</span><br>
<span class="lineno"></span><span class="comment" id="5994601">//&nbsp;Otherwise,&nbsp;WriteTo&nbsp;returns&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="5994636">//</span><br>
<span class="lineno">215</span><span class="comment" id="5994639">//&nbsp;The&nbsp;debug&nbsp;parameter&nbsp;enables&nbsp;additional&nbsp;output.</span><br>
<span class="lineno"></span><span class="comment" id="5994689">//&nbsp;Passing&nbsp;debug=0&nbsp;prints&nbsp;only&nbsp;the&nbsp;hexadecimal&nbsp;addresses&nbsp;that&nbsp;pprof&nbsp;needs.</span><br>
<span class="lineno"></span><span class="comment" id="5994764">//&nbsp;Passing&nbsp;debug=1&nbsp;adds&nbsp;comments&nbsp;translating&nbsp;addresses&nbsp;to&nbsp;function&nbsp;names</span><br>
<span class="lineno"></span><span class="comment" id="5994837">//&nbsp;and&nbsp;line&nbsp;numbers,&nbsp;so&nbsp;that&nbsp;a&nbsp;programmer&nbsp;can&nbsp;read&nbsp;the&nbsp;profile&nbsp;without&nbsp;tools.</span><br>
<span class="lineno"></span><span class="comment" id="5994915">//</span><br>
<span class="lineno">220</span><span class="comment" id="5994918">//&nbsp;The&nbsp;predefined&nbsp;profiles&nbsp;may&nbsp;assign&nbsp;meaning&nbsp;to&nbsp;other&nbsp;debug&nbsp;values;</span><br>
<span class="lineno"></span><span class="comment" id="5994987">//&nbsp;for&nbsp;example,&nbsp;when&nbsp;printing&nbsp;the&nbsp;&#34;goroutine&#34;&nbsp;profile,&nbsp;debug=2&nbsp;means&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="5995059">//&nbsp;print&nbsp;the&nbsp;goroutine&nbsp;stacks&nbsp;in&nbsp;the&nbsp;same&nbsp;form&nbsp;that&nbsp;a&nbsp;Go&nbsp;program&nbsp;uses</span><br>
<span class="lineno"></span><span class="comment" id="5995129">//&nbsp;when&nbsp;dying&nbsp;due&nbsp;to&nbsp;an&nbsp;unrecovered&nbsp;panic.</span><br>
<span class="lineno"></span><span class="keyword" id="5995172">func</span>&nbsp;<span class="op" id="5995177">(</span><span class="ident" id="5995178">p</span>&nbsp;<span class="op" id="5995180">*</span><span class="ident" id="5995181">Profile</span><span class="op" id="5995188">)</span>&nbsp;<span class="ident" id="5995190">WriteTo</span><span class="op" id="5995197">(</span><span class="ident" id="5995198">w</span>&nbsp;<span class="ident" id="5995200">io</span><span class="op" id="5995202">.</span><span class="ident" id="5995203">Writer</span><span class="op" id="5995209">,</span>&nbsp;<span class="ident" id="5995211">debug</span>&nbsp;<span class="builtintype" id="5995217">int</span><span class="op" id="5995220">)</span>&nbsp;<span class="builtintype" id="5995222">error</span>&nbsp;<span class="op" id="5995228">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5995231">if</span>&nbsp;<span class="ident" id="5995234">p</span><span class="op" id="5995235">.</span><span class="ident" id="5995236">name</span>&nbsp;<span class="op" id="5995241">==</span>&nbsp;<span class="string" id="5995244">&#34;&#34;</span>&nbsp;<span class="op" id="5995247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5995251">panic</span><span class="op" id="5995256">(</span><span class="string" id="5995257">&#34;pprof:&nbsp;use&nbsp;of&nbsp;zero&nbsp;Profile&#34;</span><span class="op" id="5995285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5995288">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5995291">if</span>&nbsp;<span class="ident" id="5995294">p</span><span class="op" id="5995295">.</span><span class="ident" id="5995296">write</span>&nbsp;<span class="op" id="5995302">!=</span>&nbsp;<span class="ident" id="5995305">nil</span>&nbsp;<span class="op" id="5995309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5995313">return</span>&nbsp;<span class="ident" id="5995320">p</span><span class="op" id="5995321">.</span><span class="ident" id="5995322">write</span><span class="op" id="5995327">(</span><span class="ident" id="5995328">w</span><span class="op" id="5995329">,</span>&nbsp;<span class="ident" id="5995331">debug</span><span class="op" id="5995336">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5995339">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5995343">//&nbsp;Obtain&nbsp;consistent&nbsp;snapshot&nbsp;under&nbsp;lock;&nbsp;then&nbsp;process&nbsp;without&nbsp;lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5995413">var</span>&nbsp;<span class="ident" id="5995417">all</span>&nbsp;<span class="op" id="5995421">[</span><span class="op" id="5995422">]</span><span class="op" id="5995423">[</span><span class="op" id="5995424">]</span><span class="builtintype" id="5995425">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5995434">p</span><span class="op" id="5995435">.</span><span class="ident" id="5995436">mu</span><span class="op" id="5995438">.</span><span class="ident" id="5995439">Lock</span><span class="op" id="5995443">(</span><span class="op" id="5995444">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5995447">for</span>&nbsp;<span class="ident" id="5995451">_</span><span class="op" id="5995452">,</span>&nbsp;<span class="ident" id="5995454">stk</span>&nbsp;<span class="op" id="5995458">:=</span>&nbsp;<span class="keyword" id="5995461">range</span>&nbsp;<span class="ident" id="5995467">p</span><span class="op" id="5995468">.</span><span class="ident" id="5995469">m</span>&nbsp;<span class="op" id="5995471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5995475">all</span>&nbsp;<span class="op" id="5995479">=</span>&nbsp;<span class="builtinfunc" id="5995481">append</span><span class="op" id="5995487">(</span><span class="ident" id="5995488">all</span><span class="op" id="5995491">,</span>&nbsp;<span class="ident" id="5995493">stk</span><span class="op" id="5995496">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5995499">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5995502">p</span><span class="op" id="5995503">.</span><span class="ident" id="5995504">mu</span><span class="op" id="5995506">.</span><span class="ident" id="5995507">Unlock</span><span class="op" id="5995513">(</span><span class="op" id="5995514">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5995518">//&nbsp;Map&nbsp;order&nbsp;is&nbsp;non-deterministic;&nbsp;make&nbsp;output&nbsp;deterministic.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5995581">sort</span><span class="op" id="5995585">.</span><span class="ident" id="5995586">Sort</span><span class="op" id="5995590">(</span><span class="ident" id="5995591">stackProfile</span><span class="op" id="5995603">(</span><span class="ident" id="5995604">all</span><span class="op" id="5995607">)</span><span class="op" id="5995608">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5995612">return</span>&nbsp;<span class="ident" id="5995619">printCountProfile</span><span class="op" id="5995636">(</span><span class="ident" id="5995637">w</span><span class="op" id="5995638">,</span>&nbsp;<span class="ident" id="5995640">debug</span><span class="op" id="5995645">,</span>&nbsp;<span class="ident" id="5995647">p</span><span class="op" id="5995648">.</span><span class="ident" id="5995649">name</span><span class="op" id="5995653">,</span>&nbsp;<span class="ident" id="5995655">stackProfile</span><span class="op" id="5995667">(</span><span class="ident" id="5995668">all</span><span class="op" id="5995671">)</span><span class="op" id="5995672">)</span><br>
<span class="lineno"></span><span class="op" id="5995674">}</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span><span class="keyword" id="5995677">type</span>&nbsp;<span class="ident" id="5995682">stackProfile</span>&nbsp;<span class="op" id="5995695">[</span><span class="op" id="5995696">]</span><span class="op" id="5995697">[</span><span class="op" id="5995698">]</span><span class="builtintype" id="5995699">uintptr</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5995708">func</span>&nbsp;<span class="op" id="5995713">(</span><span class="ident" id="5995714">x</span>&nbsp;<span class="ident" id="5995716">stackProfile</span><span class="op" id="5995728">)</span>&nbsp;<span class="ident" id="5995730">Len</span><span class="op" id="5995733">(</span><span class="op" id="5995734">)</span>&nbsp;<span class="builtintype" id="5995736">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5995753">{</span>&nbsp;<span class="keyword" id="5995755">return</span>&nbsp;<span class="builtinfunc" id="5995762">len</span><span class="op" id="5995765">(</span><span class="ident" id="5995766">x</span><span class="op" id="5995767">)</span>&nbsp;<span class="op" id="5995769">}</span><br>
<span class="lineno"></span><span class="keyword" id="5995771">func</span>&nbsp;<span class="op" id="5995776">(</span><span class="ident" id="5995777">x</span>&nbsp;<span class="ident" id="5995779">stackProfile</span><span class="op" id="5995791">)</span>&nbsp;<span class="ident" id="5995793">Stack</span><span class="op" id="5995798">(</span><span class="ident" id="5995799">i</span>&nbsp;<span class="builtintype" id="5995801">int</span><span class="op" id="5995804">)</span>&nbsp;<span class="op" id="5995806">[</span><span class="op" id="5995807">]</span><span class="builtintype" id="5995808">uintptr</span>&nbsp;<span class="op" id="5995816">{</span>&nbsp;<span class="keyword" id="5995818">return</span>&nbsp;<span class="ident" id="5995825">x</span><span class="op" id="5995826">[</span><span class="ident" id="5995827">i</span><span class="op" id="5995828">]</span>&nbsp;<span class="op" id="5995830">}</span><br>
<span class="lineno">250</span><span class="keyword" id="5995832">func</span>&nbsp;<span class="op" id="5995837">(</span><span class="ident" id="5995838">x</span>&nbsp;<span class="ident" id="5995840">stackProfile</span><span class="op" id="5995852">)</span>&nbsp;<span class="ident" id="5995854">Swap</span><span class="op" id="5995858">(</span><span class="ident" id="5995859">i</span><span class="op" id="5995860">,</span>&nbsp;<span class="ident" id="5995862">j</span>&nbsp;<span class="builtintype" id="5995864">int</span><span class="op" id="5995867">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5995877">{</span>&nbsp;<span class="ident" id="5995879">x</span><span class="op" id="5995880">[</span><span class="ident" id="5995881">i</span><span class="op" id="5995882">]</span><span class="op" id="5995883">,</span>&nbsp;<span class="ident" id="5995885">x</span><span class="op" id="5995886">[</span><span class="ident" id="5995887">j</span><span class="op" id="5995888">]</span>&nbsp;<span class="op" id="5995890">=</span>&nbsp;<span class="ident" id="5995892">x</span><span class="op" id="5995893">[</span><span class="ident" id="5995894">j</span><span class="op" id="5995895">]</span><span class="op" id="5995896">,</span>&nbsp;<span class="ident" id="5995898">x</span><span class="op" id="5995899">[</span><span class="ident" id="5995900">i</span><span class="op" id="5995901">]</span>&nbsp;<span class="op" id="5995903">}</span><br>
<span class="lineno"></span><span class="keyword" id="5995905">func</span>&nbsp;<span class="op" id="5995910">(</span><span class="ident" id="5995911">x</span>&nbsp;<span class="ident" id="5995913">stackProfile</span><span class="op" id="5995925">)</span>&nbsp;<span class="ident" id="5995927">Less</span><span class="op" id="5995931">(</span><span class="ident" id="5995932">i</span><span class="op" id="5995933">,</span>&nbsp;<span class="ident" id="5995935">j</span>&nbsp;<span class="builtintype" id="5995937">int</span><span class="op" id="5995940">)</span>&nbsp;<span class="builtintype" id="5995942">bool</span>&nbsp;<span class="op" id="5995947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5995950">t</span><span class="op" id="5995951">,</span>&nbsp;<span class="ident" id="5995953">u</span>&nbsp;<span class="op" id="5995955">:=</span>&nbsp;<span class="ident" id="5995958">x</span><span class="op" id="5995959">[</span><span class="ident" id="5995960">i</span><span class="op" id="5995961">]</span><span class="op" id="5995962">,</span>&nbsp;<span class="ident" id="5995964">x</span><span class="op" id="5995965">[</span><span class="ident" id="5995966">j</span><span class="op" id="5995967">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5995970">for</span>&nbsp;<span class="ident" id="5995974">k</span>&nbsp;<span class="op" id="5995976">:=</span>&nbsp;<span class="num" id="5995979">0</span><span class="op" id="5995980">;</span>&nbsp;<span class="ident" id="5995982">k</span>&nbsp;<span class="op" id="5995984">&lt;</span>&nbsp;<span class="builtinfunc" id="5995986">len</span><span class="op" id="5995989">(</span><span class="ident" id="5995990">t</span><span class="op" id="5995991">)</span>&nbsp;<span class="op" id="5995993">&amp;&amp;</span>&nbsp;<span class="ident" id="5995996">k</span>&nbsp;<span class="op" id="5995998">&lt;</span>&nbsp;<span class="builtinfunc" id="5996000">len</span><span class="op" id="5996003">(</span><span class="ident" id="5996004">u</span><span class="op" id="5996005">)</span><span class="op" id="5996006">;</span>&nbsp;<span class="ident" id="5996008">k</span><span class="op" id="5996009">++</span>&nbsp;<span class="op" id="5996012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5996016">if</span>&nbsp;<span class="ident" id="5996019">t</span><span class="op" id="5996020">[</span><span class="ident" id="5996021">k</span><span class="op" id="5996022">]</span>&nbsp;<span class="op" id="5996024">!=</span>&nbsp;<span class="ident" id="5996027">u</span><span class="op" id="5996028">[</span><span class="ident" id="5996029">k</span><span class="op" id="5996030">]</span>&nbsp;<span class="op" id="5996032">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5996037">return</span>&nbsp;<span class="ident" id="5996044">t</span><span class="op" id="5996045">[</span><span class="ident" id="5996046">k</span><span class="op" id="5996047">]</span>&nbsp;<span class="op" id="5996049">&lt;</span>&nbsp;<span class="ident" id="5996051">u</span><span class="op" id="5996052">[</span><span class="ident" id="5996053">k</span><span class="op" id="5996054">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5996058">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5996061">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5996064">return</span>&nbsp;<span class="builtinfunc" id="5996071">len</span><span class="op" id="5996074">(</span><span class="ident" id="5996075">t</span><span class="op" id="5996076">)</span>&nbsp;<span class="op" id="5996078">&lt;</span>&nbsp;<span class="builtinfunc" id="5996080">len</span><span class="op" id="5996083">(</span><span class="ident" id="5996084">u</span><span class="op" id="5996085">)</span><br>
<span class="lineno"></span><span class="op" id="5996087">}</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span><span class="comment" id="5996090">//&nbsp;A&nbsp;countProfile&nbsp;is&nbsp;a&nbsp;set&nbsp;of&nbsp;stack&nbsp;traces&nbsp;to&nbsp;be&nbsp;printed&nbsp;as&nbsp;counts</span><br>
<span class="lineno"></span><span class="comment" id="5996157">//&nbsp;grouped&nbsp;by&nbsp;stack&nbsp;trace.&nbsp;&nbsp;There&nbsp;are&nbsp;multiple&nbsp;implementations:</span><br>
<span class="lineno"></span><span class="comment" id="5996221">//&nbsp;all&nbsp;that&nbsp;matters&nbsp;is&nbsp;that&nbsp;we&nbsp;can&nbsp;find&nbsp;out&nbsp;how&nbsp;many&nbsp;traces&nbsp;there&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="5996291">//&nbsp;and&nbsp;obtain&nbsp;each&nbsp;trace&nbsp;in&nbsp;turn.</span><br>
<span class="lineno">265</span><span class="keyword" id="5996325">type</span>&nbsp;<span class="ident" id="5996330">countProfile</span>&nbsp;<span class="keyword" id="5996343">interface</span>&nbsp;<span class="op" id="5996353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5996356">Len</span><span class="op" id="5996359">(</span><span class="op" id="5996360">)</span>&nbsp;<span class="builtintype" id="5996362">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5996367">Stack</span><span class="op" id="5996372">(</span><span class="ident" id="5996373">i</span>&nbsp;<span class="builtintype" id="5996375">int</span><span class="op" id="5996378">)</span>&nbsp;<span class="op" id="5996380">[</span><span class="op" id="5996381">]</span><span class="builtintype" id="5996382">uintptr</span><br>
<span class="lineno"></span><span class="op" id="5996390">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">270</span><span class="comment" id="5996393">//&nbsp;printCountProfile&nbsp;prints&nbsp;a&nbsp;countProfile&nbsp;at&nbsp;the&nbsp;specified&nbsp;debug&nbsp;level.</span><br>
<span class="lineno"></span><span class="keyword" id="5996466">func</span>&nbsp;<span class="ident" id="5996471">printCountProfile</span><span class="op" id="5996488">(</span><span class="ident" id="5996489">w</span>&nbsp;<span class="ident" id="5996491">io</span><span class="op" id="5996493">.</span><span class="ident" id="5996494">Writer</span><span class="op" id="5996500">,</span>&nbsp;<span class="ident" id="5996502">debug</span>&nbsp;<span class="builtintype" id="5996508">int</span><span class="op" id="5996511">,</span>&nbsp;<span class="ident" id="5996513">name</span>&nbsp;<span class="builtintype" id="5996518">string</span><span class="op" id="5996524">,</span>&nbsp;<span class="ident" id="5996526">p</span>&nbsp;<span class="ident" id="5996528">countProfile</span><span class="op" id="5996540">)</span>&nbsp;<span class="builtintype" id="5996542">error</span>&nbsp;<span class="op" id="5996548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5996551">b</span>&nbsp;<span class="op" id="5996553">:=</span>&nbsp;<span class="ident" id="5996556">bufio</span><span class="op" id="5996561">.</span><span class="ident" id="5996562">NewWriter</span><span class="op" id="5996571">(</span><span class="ident" id="5996572">w</span><span class="op" id="5996573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5996576">var</span>&nbsp;<span class="ident" id="5996580">tw</span>&nbsp;<span class="op" id="5996583">*</span><span class="ident" id="5996584">tabwriter</span><span class="op" id="5996593">.</span><span class="ident" id="5996594">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5996602">w</span>&nbsp;<span class="op" id="5996604">=</span>&nbsp;<span class="ident" id="5996606">b</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5996609">if</span>&nbsp;<span class="ident" id="5996612">debug</span>&nbsp;<span class="op" id="5996618">&gt;</span>&nbsp;<span class="num" id="5996620">0</span>&nbsp;<span class="op" id="5996622">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5996626">tw</span>&nbsp;<span class="op" id="5996629">=</span>&nbsp;<span class="ident" id="5996631">tabwriter</span><span class="op" id="5996640">.</span><span class="ident" id="5996641">NewWriter</span><span class="op" id="5996650">(</span><span class="ident" id="5996651">w</span><span class="op" id="5996652">,</span>&nbsp;<span class="num" id="5996654">1</span><span class="op" id="5996655">,</span>&nbsp;<span class="num" id="5996657">8</span><span class="op" id="5996658">,</span>&nbsp;<span class="num" id="5996660">1</span><span class="op" id="5996661">,</span>&nbsp;<span class="string" id="5996663">&#39;\t&#39;</span><span class="op" id="5996667">,</span>&nbsp;<span class="num" id="5996669">0</span><span class="op" id="5996670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5996674">w</span>&nbsp;<span class="op" id="5996676">=</span>&nbsp;<span class="ident" id="5996678">tw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5996682">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5996686">fmt</span><span class="op" id="5996689">.</span><span class="ident" id="5996690">Fprintf</span><span class="op" id="5996697">(</span><span class="ident" id="5996698">w</span><span class="op" id="5996699">,</span>&nbsp;<span class="string" id="5996701">&#34;%s&nbsp;profile:&nbsp;total&nbsp;%d\n&#34;</span><span class="op" id="5996725">,</span>&nbsp;<span class="ident" id="5996727">name</span><span class="op" id="5996731">,</span>&nbsp;<span class="ident" id="5996733">p</span><span class="op" id="5996734">.</span><span class="ident" id="5996735">Len</span><span class="op" id="5996738">(</span><span class="op" id="5996739">)</span><span class="op" id="5996740">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5996744">//&nbsp;Build&nbsp;count&nbsp;of&nbsp;each&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5996775">var</span>&nbsp;<span class="ident" id="5996779">buf</span>&nbsp;<span class="ident" id="5996783">bytes</span><span class="op" id="5996788">.</span><span class="ident" id="5996789">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5996797">key</span>&nbsp;<span class="op" id="5996801">:=</span>&nbsp;<span class="keyword" id="5996804">func</span><span class="op" id="5996808">(</span><span class="ident" id="5996809">stk</span>&nbsp;<span class="op" id="5996813">[</span><span class="op" id="5996814">]</span><span class="builtintype" id="5996815">uintptr</span><span class="op" id="5996822">)</span>&nbsp;<span class="builtintype" id="5996824">string</span>&nbsp;<span class="op" id="5996831">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5996835">buf</span><span class="op" id="5996838">.</span><span class="ident" id="5996839">Reset</span><span class="op" id="5996844">(</span><span class="op" id="5996845">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5996849">fmt</span><span class="op" id="5996852">.</span><span class="ident" id="5996853">Fprintf</span><span class="op" id="5996860">(</span><span class="op" id="5996861">&amp;</span><span class="ident" id="5996862">buf</span><span class="op" id="5996865">,</span>&nbsp;<span class="string" id="5996867">&#34;@&#34;</span><span class="op" id="5996870">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5996874">for</span>&nbsp;<span class="ident" id="5996878">_</span><span class="op" id="5996879">,</span>&nbsp;<span class="ident" id="5996881">pc</span>&nbsp;<span class="op" id="5996884">:=</span>&nbsp;<span class="keyword" id="5996887">range</span>&nbsp;<span class="ident" id="5996893">stk</span>&nbsp;<span class="op" id="5996897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5996902">fmt</span><span class="op" id="5996905">.</span><span class="ident" id="5996906">Fprintf</span><span class="op" id="5996913">(</span><span class="op" id="5996914">&amp;</span><span class="ident" id="5996915">buf</span><span class="op" id="5996918">,</span>&nbsp;<span class="string" id="5996920">&#34;&nbsp;%#x&#34;</span><span class="op" id="5996926">,</span>&nbsp;<span class="ident" id="5996928">pc</span><span class="op" id="5996930">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5996934">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5996938">return</span>&nbsp;<span class="ident" id="5996945">buf</span><span class="op" id="5996948">.</span><span class="ident" id="5996949">String</span><span class="op" id="5996955">(</span><span class="op" id="5996956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5996959">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5996962">m</span>&nbsp;<span class="op" id="5996964">:=</span>&nbsp;<span class="keyword" id="5996967">map</span><span class="op" id="5996970">[</span><span class="builtintype" id="5996971">string</span><span class="op" id="5996977">]</span><span class="builtintype" id="5996978">int</span><span class="op" id="5996981">{</span><span class="op" id="5996982">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5996985">n</span>&nbsp;<span class="op" id="5996987">:=</span>&nbsp;<span class="ident" id="5996990">p</span><span class="op" id="5996991">.</span><span class="ident" id="5996992">Len</span><span class="op" id="5996995">(</span><span class="op" id="5996996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5996999">for</span>&nbsp;<span class="ident" id="5997003">i</span>&nbsp;<span class="op" id="5997005">:=</span>&nbsp;<span class="num" id="5997008">0</span><span class="op" id="5997009">;</span>&nbsp;<span class="ident" id="5997011">i</span>&nbsp;<span class="op" id="5997013">&lt;</span>&nbsp;<span class="ident" id="5997015">n</span><span class="op" id="5997016">;</span>&nbsp;<span class="ident" id="5997018">i</span><span class="op" id="5997019">++</span>&nbsp;<span class="op" id="5997022">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5997026">m</span><span class="op" id="5997027">[</span><span class="ident" id="5997028">key</span><span class="op" id="5997031">(</span><span class="ident" id="5997032">p</span><span class="op" id="5997033">.</span><span class="ident" id="5997034">Stack</span><span class="op" id="5997039">(</span><span class="ident" id="5997040">i</span><span class="op" id="5997041">)</span><span class="op" id="5997042">)</span><span class="op" id="5997043">]</span><span class="op" id="5997044">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5997048">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5997052">//&nbsp;Print&nbsp;stacks,&nbsp;listing&nbsp;count&nbsp;on&nbsp;first&nbsp;occurrence&nbsp;of&nbsp;a&nbsp;unique&nbsp;stack.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5997123">for</span>&nbsp;<span class="ident" id="5997127">i</span>&nbsp;<span class="op" id="5997129">:=</span>&nbsp;<span class="num" id="5997132">0</span><span class="op" id="5997133">;</span>&nbsp;<span class="ident" id="5997135">i</span>&nbsp;<span class="op" id="5997137">&lt;</span>&nbsp;<span class="ident" id="5997139">n</span><span class="op" id="5997140">;</span>&nbsp;<span class="ident" id="5997142">i</span><span class="op" id="5997143">++</span>&nbsp;<span class="op" id="5997146">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5997150">stk</span>&nbsp;<span class="op" id="5997154">:=</span>&nbsp;<span class="ident" id="5997157">p</span><span class="op" id="5997158">.</span><span class="ident" id="5997159">Stack</span><span class="op" id="5997164">(</span><span class="ident" id="5997165">i</span><span class="op" id="5997166">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5997170">s</span>&nbsp;<span class="op" id="5997172">:=</span>&nbsp;<span class="ident" id="5997175">key</span><span class="op" id="5997178">(</span><span class="ident" id="5997179">stk</span><span class="op" id="5997182">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5997186">if</span>&nbsp;<span class="ident" id="5997189">count</span>&nbsp;<span class="op" id="5997195">:=</span>&nbsp;<span class="ident" id="5997198">m</span><span class="op" id="5997199">[</span><span class="ident" id="5997200">s</span><span class="op" id="5997201">]</span><span class="op" id="5997202">;</span>&nbsp;<span class="ident" id="5997204">count</span>&nbsp;<span class="op" id="5997210">!=</span>&nbsp;<span class="num" id="5997213">0</span>&nbsp;<span class="op" id="5997215">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5997220">fmt</span><span class="op" id="5997223">.</span><span class="ident" id="5997224">Fprintf</span><span class="op" id="5997231">(</span><span class="ident" id="5997232">w</span><span class="op" id="5997233">,</span>&nbsp;<span class="string" id="5997235">&#34;%d&nbsp;%s\n&#34;</span><span class="op" id="5997244">,</span>&nbsp;<span class="ident" id="5997246">count</span><span class="op" id="5997251">,</span>&nbsp;<span class="ident" id="5997253">s</span><span class="op" id="5997254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5997259">if</span>&nbsp;<span class="ident" id="5997262">debug</span>&nbsp;<span class="op" id="5997268">&gt;</span>&nbsp;<span class="num" id="5997270">0</span>&nbsp;<span class="op" id="5997272">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5997278">printStackRecord</span><span class="op" id="5997294">(</span><span class="ident" id="5997295">w</span><span class="op" id="5997296">,</span>&nbsp;<span class="ident" id="5997298">stk</span><span class="op" id="5997301">,</span>&nbsp;<span class="builtintype" id="5997303">false</span><span class="op" id="5997308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5997313">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="5997318">delete</span><span class="op" id="5997324">(</span><span class="ident" id="5997325">m</span><span class="op" id="5997326">,</span>&nbsp;<span class="ident" id="5997328">s</span><span class="op" id="5997329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5997333">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5997336">}</span><br>
<span class="lineno">310</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5997340">if</span>&nbsp;<span class="ident" id="5997343">tw</span>&nbsp;<span class="op" id="5997346">!=</span>&nbsp;<span class="ident" id="5997349">nil</span>&nbsp;<span class="op" id="5997353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5997357">tw</span><span class="op" id="5997359">.</span><span class="ident" id="5997360">Flush</span><span class="op" id="5997365">(</span><span class="op" id="5997366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5997369">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5997372">return</span>&nbsp;<span class="ident" id="5997379">b</span><span class="op" id="5997380">.</span><span class="ident" id="5997381">Flush</span><span class="op" id="5997386">(</span><span class="op" id="5997387">)</span><br>
<span class="lineno">315</span><span class="op" id="5997389">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5997392">//&nbsp;printStackRecord&nbsp;prints&nbsp;the&nbsp;function&nbsp;+&nbsp;source&nbsp;line&nbsp;information</span><br>
<span class="lineno"></span><span class="comment" id="5997458">//&nbsp;for&nbsp;a&nbsp;single&nbsp;stack&nbsp;trace.</span><br>
<span class="lineno"></span><span class="keyword" id="5997487">func</span>&nbsp;<span class="ident" id="5997492">printStackRecord</span><span class="op" id="5997508">(</span><span class="ident" id="5997509">w</span>&nbsp;<span class="ident" id="5997511">io</span><span class="op" id="5997513">.</span><span class="ident" id="5997514">Writer</span><span class="op" id="5997520">,</span>&nbsp;<span class="ident" id="5997522">stk</span>&nbsp;<span class="op" id="5997526">[</span><span class="op" id="5997527">]</span><span class="builtintype" id="5997528">uintptr</span><span class="op" id="5997535">,</span>&nbsp;<span class="ident" id="5997537">allFrames</span>&nbsp;<span class="builtintype" id="5997547">bool</span><span class="op" id="5997551">)</span>&nbsp;<span class="op" id="5997553">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5997556">show</span>&nbsp;<span class="op" id="5997561">:=</span>&nbsp;<span class="ident" id="5997564">allFrames</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5997575">wasPanic</span>&nbsp;<span class="op" id="5997584">:=</span>&nbsp;<span class="builtintype" id="5997587">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5997594">for</span>&nbsp;<span class="ident" id="5997598">i</span><span class="op" id="5997599">,</span>&nbsp;<span class="ident" id="5997601">pc</span>&nbsp;<span class="op" id="5997604">:=</span>&nbsp;<span class="keyword" id="5997607">range</span>&nbsp;<span class="ident" id="5997613">stk</span>&nbsp;<span class="op" id="5997617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5997621">f</span>&nbsp;<span class="op" id="5997623">:=</span>&nbsp;<span class="ident" id="5997626">runtime</span><span class="op" id="5997633">.</span><span class="ident" id="5997634">FuncForPC</span><span class="op" id="5997643">(</span><span class="ident" id="5997644">pc</span><span class="op" id="5997646">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5997650">if</span>&nbsp;<span class="ident" id="5997653">f</span>&nbsp;<span class="op" id="5997655">==</span>&nbsp;<span class="ident" id="5997658">nil</span>&nbsp;<span class="op" id="5997662">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5997667">show</span>&nbsp;<span class="op" id="5997672">=</span>&nbsp;<span class="builtintype" id="5997674">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5997682">fmt</span><span class="op" id="5997685">.</span><span class="ident" id="5997686">Fprintf</span><span class="op" id="5997693">(</span><span class="ident" id="5997694">w</span><span class="op" id="5997695">,</span>&nbsp;<span class="string" id="5997697">&#34;#\t%#x\n&#34;</span><span class="op" id="5997707">,</span>&nbsp;<span class="ident" id="5997709">pc</span><span class="op" id="5997711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5997716">wasPanic</span>&nbsp;<span class="op" id="5997725">=</span>&nbsp;<span class="builtintype" id="5997727">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5997735">}</span>&nbsp;<span class="keyword" id="5997737">else</span>&nbsp;<span class="op" id="5997742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5997747">tracepc</span>&nbsp;<span class="op" id="5997755">:=</span>&nbsp;<span class="ident" id="5997758">pc</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5997764">//&nbsp;Back&nbsp;up&nbsp;to&nbsp;call&nbsp;instruction.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5997799">if</span>&nbsp;<span class="ident" id="5997802">i</span>&nbsp;<span class="op" id="5997804">&gt;</span>&nbsp;<span class="num" id="5997806">0</span>&nbsp;<span class="op" id="5997808">&amp;&amp;</span>&nbsp;<span class="ident" id="5997811">pc</span>&nbsp;<span class="op" id="5997814">&gt;</span>&nbsp;<span class="ident" id="5997816">f</span><span class="op" id="5997817">.</span><span class="ident" id="5997818">Entry</span><span class="op" id="5997823">(</span><span class="op" id="5997824">)</span>&nbsp;<span class="op" id="5997826">&amp;&amp;</span>&nbsp;<span class="op" id="5997829">!</span><span class="ident" id="5997830">wasPanic</span>&nbsp;<span class="op" id="5997839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5997845">if</span>&nbsp;<span class="ident" id="5997848">runtime</span><span class="op" id="5997855">.</span><span class="ident" id="5997856">GOARCH</span>&nbsp;<span class="op" id="5997863">==</span>&nbsp;<span class="string" id="5997866">&#34;386&#34;</span>&nbsp;<span class="op" id="5997872">||</span>&nbsp;<span class="ident" id="5997875">runtime</span><span class="op" id="5997882">.</span><span class="ident" id="5997883">GOARCH</span>&nbsp;<span class="op" id="5997890">==</span>&nbsp;<span class="string" id="5997893">&#34;amd64&#34;</span>&nbsp;<span class="op" id="5997901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5997908">tracepc</span><span class="op" id="5997915">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5997922">}</span>&nbsp;<span class="keyword" id="5997924">else</span>&nbsp;<span class="op" id="5997929">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5997936">tracepc</span>&nbsp;<span class="op" id="5997944">-=</span>&nbsp;<span class="num" id="5997947">4</span>&nbsp;<span class="comment" id="5997949">//&nbsp;arm,&nbsp;etc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5997965">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5997970">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5997975">file</span><span class="op" id="5997979">,</span>&nbsp;<span class="ident" id="5997981">line</span>&nbsp;<span class="op" id="5997986">:=</span>&nbsp;<span class="ident" id="5997989">f</span><span class="op" id="5997990">.</span><span class="ident" id="5997991">FileLine</span><span class="op" id="5997999">(</span><span class="ident" id="5998000">tracepc</span><span class="op" id="5998007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5998012">name</span>&nbsp;<span class="op" id="5998017">:=</span>&nbsp;<span class="ident" id="5998020">f</span><span class="op" id="5998021">.</span><span class="ident" id="5998022">Name</span><span class="op" id="5998026">(</span><span class="op" id="5998027">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5998032">//&nbsp;Hide&nbsp;runtime.goexit&nbsp;and&nbsp;any&nbsp;runtime&nbsp;functions&nbsp;at&nbsp;the&nbsp;beginning.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5998102">//&nbsp;This&nbsp;is&nbsp;useful&nbsp;mainly&nbsp;for&nbsp;allocation&nbsp;traces.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5998153">wasPanic</span>&nbsp;<span class="op" id="5998162">=</span>&nbsp;<span class="ident" id="5998164">name</span>&nbsp;<span class="op" id="5998169">==</span>&nbsp;<span class="string" id="5998172">&#34;runtime.panic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5998191">if</span>&nbsp;<span class="ident" id="5998194">name</span>&nbsp;<span class="op" id="5998199">==</span>&nbsp;<span class="string" id="5998202">&#34;runtime.goexit&#34;</span>&nbsp;<span class="op" id="5998219">||</span>&nbsp;<span class="op" id="5998222">!</span><span class="ident" id="5998223">show</span>&nbsp;<span class="op" id="5998228">&amp;&amp;</span>&nbsp;<span class="ident" id="5998231">strings</span><span class="op" id="5998238">.</span><span class="ident" id="5998239">HasPrefix</span><span class="op" id="5998248">(</span><span class="ident" id="5998249">name</span><span class="op" id="5998253">,</span>&nbsp;<span class="string" id="5998255">&#34;runtime.&#34;</span><span class="op" id="5998265">)</span>&nbsp;<span class="op" id="5998267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5998273">continue</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5998285">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5998290">show</span>&nbsp;<span class="op" id="5998295">=</span>&nbsp;<span class="builtintype" id="5998297">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5998305">fmt</span><span class="op" id="5998308">.</span><span class="ident" id="5998309">Fprintf</span><span class="op" id="5998316">(</span><span class="ident" id="5998317">w</span><span class="op" id="5998318">,</span>&nbsp;<span class="string" id="5998320">&#34;#\t%#x\t%s+%#x\t%s:%d\n&#34;</span><span class="op" id="5998345">,</span>&nbsp;<span class="ident" id="5998347">pc</span><span class="op" id="5998349">,</span>&nbsp;<span class="ident" id="5998351">name</span><span class="op" id="5998355">,</span>&nbsp;<span class="ident" id="5998357">pc</span><span class="op" id="5998359">-</span><span class="ident" id="5998360">f</span><span class="op" id="5998361">.</span><span class="ident" id="5998362">Entry</span><span class="op" id="5998367">(</span><span class="op" id="5998368">)</span><span class="op" id="5998369">,</span>&nbsp;<span class="ident" id="5998371">file</span><span class="op" id="5998375">,</span>&nbsp;<span class="ident" id="5998377">line</span><span class="op" id="5998381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5998385">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5998388">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5998391">if</span>&nbsp;<span class="op" id="5998394">!</span><span class="ident" id="5998395">show</span>&nbsp;<span class="op" id="5998400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5998404">//&nbsp;We&nbsp;didn&#39;t&nbsp;print&nbsp;anything;&nbsp;do&nbsp;it&nbsp;again,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5998448">//&nbsp;and&nbsp;this&nbsp;time&nbsp;include&nbsp;runtime&nbsp;functions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5998494">printStackRecord</span><span class="op" id="5998510">(</span><span class="ident" id="5998511">w</span><span class="op" id="5998512">,</span>&nbsp;<span class="ident" id="5998514">stk</span><span class="op" id="5998517">,</span>&nbsp;<span class="builtintype" id="5998519">true</span><span class="op" id="5998523">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5998527">return</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5998535">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5998538">fmt</span><span class="op" id="5998541">.</span><span class="ident" id="5998542">Fprintf</span><span class="op" id="5998549">(</span><span class="ident" id="5998550">w</span><span class="op" id="5998551">,</span>&nbsp;<span class="string" id="5998553">&#34;\n&#34;</span><span class="op" id="5998557">)</span><br>
<span class="lineno"></span><span class="op" id="5998559">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5998562">//&nbsp;Interface&nbsp;to&nbsp;system&nbsp;profiles.</span><br>
<span class="lineno">360</span><br>
<span class="lineno"></span><span class="keyword" id="5998596">type</span>&nbsp;<span class="ident" id="5998601">byInUseBytes</span>&nbsp;<span class="op" id="5998614">[</span><span class="op" id="5998615">]</span><span class="ident" id="5998616">runtime</span><span class="op" id="5998623">.</span><span class="ident" id="5998624">MemProfileRecord</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5998642">func</span>&nbsp;<span class="op" id="5998647">(</span><span class="ident" id="5998648">x</span>&nbsp;<span class="ident" id="5998650">byInUseBytes</span><span class="op" id="5998662">)</span>&nbsp;<span class="ident" id="5998664">Len</span><span class="op" id="5998667">(</span><span class="op" id="5998668">)</span>&nbsp;<span class="builtintype" id="5998670">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5998684">{</span>&nbsp;<span class="keyword" id="5998686">return</span>&nbsp;<span class="builtinfunc" id="5998693">len</span><span class="op" id="5998696">(</span><span class="ident" id="5998697">x</span><span class="op" id="5998698">)</span>&nbsp;<span class="op" id="5998700">}</span><br>
<span class="lineno"></span><span class="keyword" id="5998702">func</span>&nbsp;<span class="op" id="5998707">(</span><span class="ident" id="5998708">x</span>&nbsp;<span class="ident" id="5998710">byInUseBytes</span><span class="op" id="5998722">)</span>&nbsp;<span class="ident" id="5998724">Swap</span><span class="op" id="5998728">(</span><span class="ident" id="5998729">i</span><span class="op" id="5998730">,</span>&nbsp;<span class="ident" id="5998732">j</span>&nbsp;<span class="builtintype" id="5998734">int</span><span class="op" id="5998737">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5998744">{</span>&nbsp;<span class="ident" id="5998746">x</span><span class="op" id="5998747">[</span><span class="ident" id="5998748">i</span><span class="op" id="5998749">]</span><span class="op" id="5998750">,</span>&nbsp;<span class="ident" id="5998752">x</span><span class="op" id="5998753">[</span><span class="ident" id="5998754">j</span><span class="op" id="5998755">]</span>&nbsp;<span class="op" id="5998757">=</span>&nbsp;<span class="ident" id="5998759">x</span><span class="op" id="5998760">[</span><span class="ident" id="5998761">j</span><span class="op" id="5998762">]</span><span class="op" id="5998763">,</span>&nbsp;<span class="ident" id="5998765">x</span><span class="op" id="5998766">[</span><span class="ident" id="5998767">i</span><span class="op" id="5998768">]</span>&nbsp;<span class="op" id="5998770">}</span><br>
<span class="lineno">365</span><span class="keyword" id="5998772">func</span>&nbsp;<span class="op" id="5998777">(</span><span class="ident" id="5998778">x</span>&nbsp;<span class="ident" id="5998780">byInUseBytes</span><span class="op" id="5998792">)</span>&nbsp;<span class="ident" id="5998794">Less</span><span class="op" id="5998798">(</span><span class="ident" id="5998799">i</span><span class="op" id="5998800">,</span>&nbsp;<span class="ident" id="5998802">j</span>&nbsp;<span class="builtintype" id="5998804">int</span><span class="op" id="5998807">)</span>&nbsp;<span class="builtintype" id="5998809">bool</span>&nbsp;<span class="op" id="5998814">{</span>&nbsp;<span class="keyword" id="5998816">return</span>&nbsp;<span class="ident" id="5998823">x</span><span class="op" id="5998824">[</span><span class="ident" id="5998825">i</span><span class="op" id="5998826">]</span><span class="op" id="5998827">.</span><span class="ident" id="5998828">InUseBytes</span><span class="op" id="5998838">(</span><span class="op" id="5998839">)</span>&nbsp;<span class="op" id="5998841">&gt;</span>&nbsp;<span class="ident" id="5998843">x</span><span class="op" id="5998844">[</span><span class="ident" id="5998845">j</span><span class="op" id="5998846">]</span><span class="op" id="5998847">.</span><span class="ident" id="5998848">InUseBytes</span><span class="op" id="5998858">(</span><span class="op" id="5998859">)</span>&nbsp;<span class="op" id="5998861">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5998864">//&nbsp;WriteHeapProfile&nbsp;is&nbsp;shorthand&nbsp;for&nbsp;Lookup(&#34;heap&#34;).WriteTo(w,&nbsp;0).</span><br>
<span class="lineno"></span><span class="comment" id="5998931">//&nbsp;It&nbsp;is&nbsp;preserved&nbsp;for&nbsp;backwards&nbsp;compatibility.</span><br>
<span class="lineno"></span><span class="keyword" id="5998979">func</span>&nbsp;<span class="ident" id="5998984">WriteHeapProfile</span><span class="op" id="5999000">(</span><span class="ident" id="5999001">w</span>&nbsp;<span class="ident" id="5999003">io</span><span class="op" id="5999005">.</span><span class="ident" id="5999006">Writer</span><span class="op" id="5999012">)</span>&nbsp;<span class="builtintype" id="5999014">error</span>&nbsp;<span class="op" id="5999020">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5999023">return</span>&nbsp;<span class="ident" id="5999030">writeHeap</span><span class="op" id="5999039">(</span><span class="ident" id="5999040">w</span><span class="op" id="5999041">,</span>&nbsp;<span class="num" id="5999043">0</span><span class="op" id="5999044">)</span><br>
<span class="lineno"></span><span class="op" id="5999046">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5999049">//&nbsp;countHeap&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;heap&nbsp;profile.</span><br>
<span class="lineno"></span><span class="keyword" id="5999113">func</span>&nbsp;<span class="ident" id="5999118">countHeap</span><span class="op" id="5999127">(</span><span class="op" id="5999128">)</span>&nbsp;<span class="builtintype" id="5999130">int</span>&nbsp;<span class="op" id="5999134">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5999137">n</span><span class="op" id="5999138">,</span>&nbsp;<span class="ident" id="5999140">_</span>&nbsp;<span class="op" id="5999142">:=</span>&nbsp;<span class="ident" id="5999145">runtime</span><span class="op" id="5999152">.</span><span class="ident" id="5999153">MemProfile</span><span class="op" id="5999163">(</span><span class="ident" id="5999164">nil</span><span class="op" id="5999167">,</span>&nbsp;<span class="builtintype" id="5999169">true</span><span class="op" id="5999173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5999176">return</span>&nbsp;<span class="ident" id="5999183">n</span><br>
<span class="lineno"></span><span class="op" id="5999185">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5999188">//&nbsp;writeHeap&nbsp;writes&nbsp;the&nbsp;current&nbsp;runtime&nbsp;heap&nbsp;profile&nbsp;to&nbsp;w.</span><br>
<span class="lineno">380</span><span class="keyword" id="5999247">func</span>&nbsp;<span class="ident" id="5999252">writeHeap</span><span class="op" id="5999261">(</span><span class="ident" id="5999262">w</span>&nbsp;<span class="ident" id="5999264">io</span><span class="op" id="5999266">.</span><span class="ident" id="5999267">Writer</span><span class="op" id="5999273">,</span>&nbsp;<span class="ident" id="5999275">debug</span>&nbsp;<span class="builtintype" id="5999281">int</span><span class="op" id="5999284">)</span>&nbsp;<span class="builtintype" id="5999286">error</span>&nbsp;<span class="op" id="5999292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5999295">//&nbsp;Find&nbsp;out&nbsp;how&nbsp;many&nbsp;records&nbsp;there&nbsp;are&nbsp;(MemProfile(nil,&nbsp;true)),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5999360">//&nbsp;allocate&nbsp;that&nbsp;many&nbsp;records,&nbsp;and&nbsp;get&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5999410">//&nbsp;There&#39;s&nbsp;a&nbsp;race—more&nbsp;records&nbsp;might&nbsp;be&nbsp;added&nbsp;between</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5999467">//&nbsp;the&nbsp;two&nbsp;calls—so&nbsp;allocate&nbsp;a&nbsp;few&nbsp;extra&nbsp;records&nbsp;for&nbsp;safety</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5999530">//&nbsp;and&nbsp;also&nbsp;try&nbsp;again&nbsp;if&nbsp;we&#39;re&nbsp;very&nbsp;unlucky.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5999576">//&nbsp;The&nbsp;loop&nbsp;should&nbsp;only&nbsp;execute&nbsp;one&nbsp;iteration&nbsp;in&nbsp;the&nbsp;common&nbsp;case.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5999643">var</span>&nbsp;<span class="ident" id="5999647">p</span>&nbsp;<span class="op" id="5999649">[</span><span class="op" id="5999650">]</span><span class="ident" id="5999651">runtime</span><span class="op" id="5999658">.</span><span class="ident" id="5999659">MemProfileRecord</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5999677">n</span><span class="op" id="5999678">,</span>&nbsp;<span class="ident" id="5999680">ok</span>&nbsp;<span class="op" id="5999683">:=</span>&nbsp;<span class="ident" id="5999686">runtime</span><span class="op" id="5999693">.</span><span class="ident" id="5999694">MemProfile</span><span class="op" id="5999704">(</span><span class="ident" id="5999705">nil</span><span class="op" id="5999708">,</span>&nbsp;<span class="builtintype" id="5999710">true</span><span class="op" id="5999714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5999717">for</span>&nbsp;<span class="op" id="5999721">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5999725">//&nbsp;Allocate&nbsp;room&nbsp;for&nbsp;a&nbsp;slightly&nbsp;bigger&nbsp;profile,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5999775">//&nbsp;in&nbsp;case&nbsp;a&nbsp;few&nbsp;more&nbsp;entries&nbsp;have&nbsp;been&nbsp;added</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5999823">//&nbsp;since&nbsp;the&nbsp;call&nbsp;to&nbsp;MemProfile.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5999858">p</span>&nbsp;<span class="op" id="5999860">=</span>&nbsp;<span class="builtinfunc" id="5999862">make</span><span class="op" id="5999866">(</span><span class="op" id="5999867">[</span><span class="op" id="5999868">]</span><span class="ident" id="5999869">runtime</span><span class="op" id="5999876">.</span><span class="ident" id="5999877">MemProfileRecord</span><span class="op" id="5999893">,</span>&nbsp;<span class="ident" id="5999895">n</span><span class="op" id="5999896">+</span><span class="num" id="5999897">50</span><span class="op" id="5999899">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5999903">n</span><span class="op" id="5999904">,</span>&nbsp;<span class="ident" id="5999906">ok</span>&nbsp;<span class="op" id="5999909">=</span>&nbsp;<span class="ident" id="5999911">runtime</span><span class="op" id="5999918">.</span><span class="ident" id="5999919">MemProfile</span><span class="op" id="5999929">(</span><span class="ident" id="5999930">p</span><span class="op" id="5999931">,</span>&nbsp;<span class="builtintype" id="5999933">true</span><span class="op" id="5999937">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5999941">if</span>&nbsp;<span class="ident" id="5999944">ok</span>&nbsp;<span class="op" id="5999947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5999952">p</span>&nbsp;<span class="op" id="5999954">=</span>&nbsp;<span class="ident" id="5999956">p</span><span class="op" id="5999957">[</span><span class="num" id="5999958">0</span><span class="op" id="5999959">:</span><span class="ident" id="5999960">n</span><span class="op" id="5999961">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5999966">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5999974">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5999978">//&nbsp;Profile&nbsp;grew;&nbsp;try&nbsp;again.</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6000007">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6000011">sort</span><span class="op" id="6000015">.</span><span class="ident" id="6000016">Sort</span><span class="op" id="6000020">(</span><span class="ident" id="6000021">byInUseBytes</span><span class="op" id="6000033">(</span><span class="ident" id="6000034">p</span><span class="op" id="6000035">)</span><span class="op" id="6000036">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6000040">b</span>&nbsp;<span class="op" id="6000042">:=</span>&nbsp;<span class="ident" id="6000045">bufio</span><span class="op" id="6000050">.</span><span class="ident" id="6000051">NewWriter</span><span class="op" id="6000060">(</span><span class="ident" id="6000061">w</span><span class="op" id="6000062">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6000065">var</span>&nbsp;<span class="ident" id="6000069">tw</span>&nbsp;<span class="op" id="6000072">*</span><span class="ident" id="6000073">tabwriter</span><span class="op" id="6000082">.</span><span class="ident" id="6000083">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6000091">w</span>&nbsp;<span class="op" id="6000093">=</span>&nbsp;<span class="ident" id="6000095">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6000098">if</span>&nbsp;<span class="ident" id="6000101">debug</span>&nbsp;<span class="op" id="6000107">&gt;</span>&nbsp;<span class="num" id="6000109">0</span>&nbsp;<span class="op" id="6000111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6000115">tw</span>&nbsp;<span class="op" id="6000118">=</span>&nbsp;<span class="ident" id="6000120">tabwriter</span><span class="op" id="6000129">.</span><span class="ident" id="6000130">NewWriter</span><span class="op" id="6000139">(</span><span class="ident" id="6000140">w</span><span class="op" id="6000141">,</span>&nbsp;<span class="num" id="6000143">1</span><span class="op" id="6000144">,</span>&nbsp;<span class="num" id="6000146">8</span><span class="op" id="6000147">,</span>&nbsp;<span class="num" id="6000149">1</span><span class="op" id="6000150">,</span>&nbsp;<span class="string" id="6000152">&#39;\t&#39;</span><span class="op" id="6000156">,</span>&nbsp;<span class="num" id="6000158">0</span><span class="op" id="6000159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6000163">w</span>&nbsp;<span class="op" id="6000165">=</span>&nbsp;<span class="ident" id="6000167">tw</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6000171">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6000175">var</span>&nbsp;<span class="ident" id="6000179">total</span>&nbsp;<span class="ident" id="6000185">runtime</span><span class="op" id="6000192">.</span><span class="ident" id="6000193">MemProfileRecord</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6000211">for</span>&nbsp;<span class="ident" id="6000215">i</span>&nbsp;<span class="op" id="6000217">:=</span>&nbsp;<span class="keyword" id="6000220">range</span>&nbsp;<span class="ident" id="6000226">p</span>&nbsp;<span class="op" id="6000228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6000232">r</span>&nbsp;<span class="op" id="6000234">:=</span>&nbsp;<span class="op" id="6000237">&amp;</span><span class="ident" id="6000238">p</span><span class="op" id="6000239">[</span><span class="ident" id="6000240">i</span><span class="op" id="6000241">]</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6000245">total</span><span class="op" id="6000250">.</span><span class="ident" id="6000251">AllocBytes</span>&nbsp;<span class="op" id="6000262">+=</span>&nbsp;<span class="ident" id="6000265">r</span><span class="op" id="6000266">.</span><span class="ident" id="6000267">AllocBytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6000280">total</span><span class="op" id="6000285">.</span><span class="ident" id="6000286">AllocObjects</span>&nbsp;<span class="op" id="6000299">+=</span>&nbsp;<span class="ident" id="6000302">r</span><span class="op" id="6000303">.</span><span class="ident" id="6000304">AllocObjects</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6000319">total</span><span class="op" id="6000324">.</span><span class="ident" id="6000325">FreeBytes</span>&nbsp;<span class="op" id="6000335">+=</span>&nbsp;<span class="ident" id="6000338">r</span><span class="op" id="6000339">.</span><span class="ident" id="6000340">FreeBytes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6000352">total</span><span class="op" id="6000357">.</span><span class="ident" id="6000358">FreeObjects</span>&nbsp;<span class="op" id="6000370">+=</span>&nbsp;<span class="ident" id="6000373">r</span><span class="op" id="6000374">.</span><span class="ident" id="6000375">FreeObjects</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6000388">}</span><br>
<span class="lineno">420</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6000392">//&nbsp;Technically&nbsp;the&nbsp;rate&nbsp;is&nbsp;MemProfileRate&nbsp;not&nbsp;2*MemProfileRate,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6000457">//&nbsp;but&nbsp;early&nbsp;versions&nbsp;of&nbsp;the&nbsp;C++&nbsp;heap&nbsp;profiler&nbsp;reported&nbsp;2*MemProfileRate,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6000532">//&nbsp;so&nbsp;that&#39;s&nbsp;what&nbsp;pprof&nbsp;has&nbsp;come&nbsp;to&nbsp;expect.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6000577">fmt</span><span class="op" id="6000580">.</span><span class="ident" id="6000581">Fprintf</span><span class="op" id="6000588">(</span><span class="ident" id="6000589">w</span><span class="op" id="6000590">,</span>&nbsp;<span class="string" id="6000592">&#34;heap&nbsp;profile:&nbsp;%d:&nbsp;%d&nbsp;[%d:&nbsp;%d]&nbsp;@&nbsp;heap/%d\n&#34;</span><span class="op" id="6000635">,</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6000639">total</span><span class="op" id="6000644">.</span><span class="ident" id="6000645">InUseObjects</span><span class="op" id="6000657">(</span><span class="op" id="6000658">)</span><span class="op" id="6000659">,</span>&nbsp;<span class="ident" id="6000661">total</span><span class="op" id="6000666">.</span><span class="ident" id="6000667">InUseBytes</span><span class="op" id="6000677">(</span><span class="op" id="6000678">)</span><span class="op" id="6000679">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6000683">total</span><span class="op" id="6000688">.</span><span class="ident" id="6000689">AllocObjects</span><span class="op" id="6000701">,</span>&nbsp;<span class="ident" id="6000703">total</span><span class="op" id="6000708">.</span><span class="ident" id="6000709">AllocBytes</span><span class="op" id="6000719">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="6000723">2</span><span class="op" id="6000724">*</span><span class="ident" id="6000725">runtime</span><span class="op" id="6000732">.</span><span class="ident" id="6000733">MemProfileRate</span><span class="op" id="6000747">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6000751">for</span>&nbsp;<span class="ident" id="6000755">i</span>&nbsp;<span class="op" id="6000757">:=</span>&nbsp;<span class="keyword" id="6000760">range</span>&nbsp;<span class="ident" id="6000766">p</span>&nbsp;<span class="op" id="6000768">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6000772">r</span>&nbsp;<span class="op" id="6000774">:=</span>&nbsp;<span class="op" id="6000777">&amp;</span><span class="ident" id="6000778">p</span><span class="op" id="6000779">[</span><span class="ident" id="6000780">i</span><span class="op" id="6000781">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6000785">fmt</span><span class="op" id="6000788">.</span><span class="ident" id="6000789">Fprintf</span><span class="op" id="6000796">(</span><span class="ident" id="6000797">w</span><span class="op" id="6000798">,</span>&nbsp;<span class="string" id="6000800">&#34;%d:&nbsp;%d&nbsp;[%d:&nbsp;%d]&nbsp;@&#34;</span><span class="op" id="6000819">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6000824">r</span><span class="op" id="6000825">.</span><span class="ident" id="6000826">InUseObjects</span><span class="op" id="6000838">(</span><span class="op" id="6000839">)</span><span class="op" id="6000840">,</span>&nbsp;<span class="ident" id="6000842">r</span><span class="op" id="6000843">.</span><span class="ident" id="6000844">InUseBytes</span><span class="op" id="6000854">(</span><span class="op" id="6000855">)</span><span class="op" id="6000856">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6000861">r</span><span class="op" id="6000862">.</span><span class="ident" id="6000863">AllocObjects</span><span class="op" id="6000875">,</span>&nbsp;<span class="ident" id="6000877">r</span><span class="op" id="6000878">.</span><span class="ident" id="6000879">AllocBytes</span><span class="op" id="6000889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6000893">for</span>&nbsp;<span class="ident" id="6000897">_</span><span class="op" id="6000898">,</span>&nbsp;<span class="ident" id="6000900">pc</span>&nbsp;<span class="op" id="6000903">:=</span>&nbsp;<span class="keyword" id="6000906">range</span>&nbsp;<span class="ident" id="6000912">r</span><span class="op" id="6000913">.</span><span class="ident" id="6000914">Stack</span><span class="op" id="6000919">(</span><span class="op" id="6000920">)</span>&nbsp;<span class="op" id="6000922">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6000927">fmt</span><span class="op" id="6000930">.</span><span class="ident" id="6000931">Fprintf</span><span class="op" id="6000938">(</span><span class="ident" id="6000939">w</span><span class="op" id="6000940">,</span>&nbsp;<span class="string" id="6000942">&#34;&nbsp;%#x&#34;</span><span class="op" id="6000948">,</span>&nbsp;<span class="ident" id="6000950">pc</span><span class="op" id="6000952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6000956">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6000960">fmt</span><span class="op" id="6000963">.</span><span class="ident" id="6000964">Fprintf</span><span class="op" id="6000971">(</span><span class="ident" id="6000972">w</span><span class="op" id="6000973">,</span>&nbsp;<span class="string" id="6000975">&#34;\n&#34;</span><span class="op" id="6000979">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6000983">if</span>&nbsp;<span class="ident" id="6000986">debug</span>&nbsp;<span class="op" id="6000992">&gt;</span>&nbsp;<span class="num" id="6000994">0</span>&nbsp;<span class="op" id="6000996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6001001">printStackRecord</span><span class="op" id="6001017">(</span><span class="ident" id="6001018">w</span><span class="op" id="6001019">,</span>&nbsp;<span class="ident" id="6001021">r</span><span class="op" id="6001022">.</span><span class="ident" id="6001023">Stack</span><span class="op" id="6001028">(</span><span class="op" id="6001029">)</span><span class="op" id="6001030">,</span>&nbsp;<span class="builtintype" id="6001032">false</span><span class="op" id="6001037">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6001041">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6001044">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6001048">//&nbsp;Print&nbsp;memstats&nbsp;information&nbsp;too.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6001084">//&nbsp;Pprof&nbsp;will&nbsp;ignore,&nbsp;but&nbsp;useful&nbsp;for&nbsp;people</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6001129">if</span>&nbsp;<span class="ident" id="6001132">debug</span>&nbsp;<span class="op" id="6001138">&gt;</span>&nbsp;<span class="num" id="6001140">0</span>&nbsp;<span class="op" id="6001142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6001146">s</span>&nbsp;<span class="op" id="6001148">:=</span>&nbsp;<span class="builtinfunc" id="6001151">new</span><span class="op" id="6001154">(</span><span class="ident" id="6001155">runtime</span><span class="op" id="6001162">.</span><span class="ident" id="6001163">MemStats</span><span class="op" id="6001171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6001175">runtime</span><span class="op" id="6001182">.</span><span class="ident" id="6001183">ReadMemStats</span><span class="op" id="6001195">(</span><span class="ident" id="6001196">s</span><span class="op" id="6001197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6001201">fmt</span><span class="op" id="6001204">.</span><span class="ident" id="6001205">Fprintf</span><span class="op" id="6001212">(</span><span class="ident" id="6001213">w</span><span class="op" id="6001214">,</span>&nbsp;<span class="string" id="6001216">&#34;\n#&nbsp;runtime.MemStats\n&#34;</span><span class="op" id="6001240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6001244">fmt</span><span class="op" id="6001247">.</span><span class="ident" id="6001248">Fprintf</span><span class="op" id="6001255">(</span><span class="ident" id="6001256">w</span><span class="op" id="6001257">,</span>&nbsp;<span class="string" id="6001259">&#34;#&nbsp;Alloc&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="6001275">,</span>&nbsp;<span class="ident" id="6001277">s</span><span class="op" id="6001278">.</span><span class="ident" id="6001279">Alloc</span><span class="op" id="6001284">)</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6001288">fmt</span><span class="op" id="6001291">.</span><span class="ident" id="6001292">Fprintf</span><span class="op" id="6001299">(</span><span class="ident" id="6001300">w</span><span class="op" id="6001301">,</span>&nbsp;<span class="string" id="6001303">&#34;#&nbsp;TotalAlloc&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="6001324">,</span>&nbsp;<span class="ident" id="6001326">s</span><span class="op" id="6001327">.</span><span class="ident" id="6001328">TotalAlloc</span><span class="op" id="6001338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6001342">fmt</span><span class="op" id="6001345">.</span><span class="ident" id="6001346">Fprintf</span><span class="op" id="6001353">(</span><span class="ident" id="6001354">w</span><span class="op" id="6001355">,</span>&nbsp;<span class="string" id="6001357">&#34;#&nbsp;Sys&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="6001371">,</span>&nbsp;<span class="ident" id="6001373">s</span><span class="op" id="6001374">.</span><span class="ident" id="6001375">Sys</span><span class="op" id="6001378">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6001382">fmt</span><span class="op" id="6001385">.</span><span class="ident" id="6001386">Fprintf</span><span class="op" id="6001393">(</span><span class="ident" id="6001394">w</span><span class="op" id="6001395">,</span>&nbsp;<span class="string" id="6001397">&#34;#&nbsp;Lookups&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="6001415">,</span>&nbsp;<span class="ident" id="6001417">s</span><span class="op" id="6001418">.</span><span class="ident" id="6001419">Lookups</span><span class="op" id="6001426">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6001430">fmt</span><span class="op" id="6001433">.</span><span class="ident" id="6001434">Fprintf</span><span class="op" id="6001441">(</span><span class="ident" id="6001442">w</span><span class="op" id="6001443">,</span>&nbsp;<span class="string" id="6001445">&#34;#&nbsp;Mallocs&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="6001463">,</span>&nbsp;<span class="ident" id="6001465">s</span><span class="op" id="6001466">.</span><span class="ident" id="6001467">Mallocs</span><span class="op" id="6001474">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6001478">fmt</span><span class="op" id="6001481">.</span><span class="ident" id="6001482">Fprintf</span><span class="op" id="6001489">(</span><span class="ident" id="6001490">w</span><span class="op" id="6001491">,</span>&nbsp;<span class="string" id="6001493">&#34;#&nbsp;Frees&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="6001509">,</span>&nbsp;<span class="ident" id="6001511">s</span><span class="op" id="6001512">.</span><span class="ident" id="6001513">Frees</span><span class="op" id="6001518">)</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6001523">fmt</span><span class="op" id="6001526">.</span><span class="ident" id="6001527">Fprintf</span><span class="op" id="6001534">(</span><span class="ident" id="6001535">w</span><span class="op" id="6001536">,</span>&nbsp;<span class="string" id="6001538">&#34;#&nbsp;HeapAlloc&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="6001558">,</span>&nbsp;<span class="ident" id="6001560">s</span><span class="op" id="6001561">.</span><span class="ident" id="6001562">HeapAlloc</span><span class="op" id="6001571">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6001575">fmt</span><span class="op" id="6001578">.</span><span class="ident" id="6001579">Fprintf</span><span class="op" id="6001586">(</span><span class="ident" id="6001587">w</span><span class="op" id="6001588">,</span>&nbsp;<span class="string" id="6001590">&#34;#&nbsp;HeapSys&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="6001608">,</span>&nbsp;<span class="ident" id="6001610">s</span><span class="op" id="6001611">.</span><span class="ident" id="6001612">HeapSys</span><span class="op" id="6001619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6001623">fmt</span><span class="op" id="6001626">.</span><span class="ident" id="6001627">Fprintf</span><span class="op" id="6001634">(</span><span class="ident" id="6001635">w</span><span class="op" id="6001636">,</span>&nbsp;<span class="string" id="6001638">&#34;#&nbsp;HeapIdle&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="6001657">,</span>&nbsp;<span class="ident" id="6001659">s</span><span class="op" id="6001660">.</span><span class="ident" id="6001661">HeapIdle</span><span class="op" id="6001669">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6001673">fmt</span><span class="op" id="6001676">.</span><span class="ident" id="6001677">Fprintf</span><span class="op" id="6001684">(</span><span class="ident" id="6001685">w</span><span class="op" id="6001686">,</span>&nbsp;<span class="string" id="6001688">&#34;#&nbsp;HeapInuse&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="6001708">,</span>&nbsp;<span class="ident" id="6001710">s</span><span class="op" id="6001711">.</span><span class="ident" id="6001712">HeapInuse</span><span class="op" id="6001721">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6001725">fmt</span><span class="op" id="6001728">.</span><span class="ident" id="6001729">Fprintf</span><span class="op" id="6001736">(</span><span class="ident" id="6001737">w</span><span class="op" id="6001738">,</span>&nbsp;<span class="string" id="6001740">&#34;#&nbsp;HeapReleased&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="6001763">,</span>&nbsp;<span class="ident" id="6001765">s</span><span class="op" id="6001766">.</span><span class="ident" id="6001767">HeapReleased</span><span class="op" id="6001779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6001783">fmt</span><span class="op" id="6001786">.</span><span class="ident" id="6001787">Fprintf</span><span class="op" id="6001794">(</span><span class="ident" id="6001795">w</span><span class="op" id="6001796">,</span>&nbsp;<span class="string" id="6001798">&#34;#&nbsp;HeapObjects&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="6001820">,</span>&nbsp;<span class="ident" id="6001822">s</span><span class="op" id="6001823">.</span><span class="ident" id="6001824">HeapObjects</span><span class="op" id="6001835">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6001840">fmt</span><span class="op" id="6001843">.</span><span class="ident" id="6001844">Fprintf</span><span class="op" id="6001851">(</span><span class="ident" id="6001852">w</span><span class="op" id="6001853">,</span>&nbsp;<span class="string" id="6001855">&#34;#&nbsp;Stack&nbsp;=&nbsp;%d&nbsp;/&nbsp;%d\n&#34;</span><span class="op" id="6001876">,</span>&nbsp;<span class="ident" id="6001878">s</span><span class="op" id="6001879">.</span><span class="ident" id="6001880">StackInuse</span><span class="op" id="6001890">,</span>&nbsp;<span class="ident" id="6001892">s</span><span class="op" id="6001893">.</span><span class="ident" id="6001894">StackSys</span><span class="op" id="6001902">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6001906">fmt</span><span class="op" id="6001909">.</span><span class="ident" id="6001910">Fprintf</span><span class="op" id="6001917">(</span><span class="ident" id="6001918">w</span><span class="op" id="6001919">,</span>&nbsp;<span class="string" id="6001921">&#34;#&nbsp;MSpan&nbsp;=&nbsp;%d&nbsp;/&nbsp;%d\n&#34;</span><span class="op" id="6001942">,</span>&nbsp;<span class="ident" id="6001944">s</span><span class="op" id="6001945">.</span><span class="ident" id="6001946">MSpanInuse</span><span class="op" id="6001956">,</span>&nbsp;<span class="ident" id="6001958">s</span><span class="op" id="6001959">.</span><span class="ident" id="6001960">MSpanSys</span><span class="op" id="6001968">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6001972">fmt</span><span class="op" id="6001975">.</span><span class="ident" id="6001976">Fprintf</span><span class="op" id="6001983">(</span><span class="ident" id="6001984">w</span><span class="op" id="6001985">,</span>&nbsp;<span class="string" id="6001987">&#34;#&nbsp;MCache&nbsp;=&nbsp;%d&nbsp;/&nbsp;%d\n&#34;</span><span class="op" id="6002009">,</span>&nbsp;<span class="ident" id="6002011">s</span><span class="op" id="6002012">.</span><span class="ident" id="6002013">MCacheInuse</span><span class="op" id="6002024">,</span>&nbsp;<span class="ident" id="6002026">s</span><span class="op" id="6002027">.</span><span class="ident" id="6002028">MCacheSys</span><span class="op" id="6002037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6002041">fmt</span><span class="op" id="6002044">.</span><span class="ident" id="6002045">Fprintf</span><span class="op" id="6002052">(</span><span class="ident" id="6002053">w</span><span class="op" id="6002054">,</span>&nbsp;<span class="string" id="6002056">&#34;#&nbsp;BuckHashSys&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="6002078">,</span>&nbsp;<span class="ident" id="6002080">s</span><span class="op" id="6002081">.</span><span class="ident" id="6002082">BuckHashSys</span><span class="op" id="6002093">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6002098">fmt</span><span class="op" id="6002101">.</span><span class="ident" id="6002102">Fprintf</span><span class="op" id="6002109">(</span><span class="ident" id="6002110">w</span><span class="op" id="6002111">,</span>&nbsp;<span class="string" id="6002113">&#34;#&nbsp;NextGC&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="6002130">,</span>&nbsp;<span class="ident" id="6002132">s</span><span class="op" id="6002133">.</span><span class="ident" id="6002134">NextGC</span><span class="op" id="6002140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6002144">fmt</span><span class="op" id="6002147">.</span><span class="ident" id="6002148">Fprintf</span><span class="op" id="6002155">(</span><span class="ident" id="6002156">w</span><span class="op" id="6002157">,</span>&nbsp;<span class="string" id="6002159">&#34;#&nbsp;PauseNs&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="6002177">,</span>&nbsp;<span class="ident" id="6002179">s</span><span class="op" id="6002180">.</span><span class="ident" id="6002181">PauseNs</span><span class="op" id="6002188">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6002192">fmt</span><span class="op" id="6002195">.</span><span class="ident" id="6002196">Fprintf</span><span class="op" id="6002203">(</span><span class="ident" id="6002204">w</span><span class="op" id="6002205">,</span>&nbsp;<span class="string" id="6002207">&#34;#&nbsp;NumGC&nbsp;=&nbsp;%d\n&#34;</span><span class="op" id="6002223">,</span>&nbsp;<span class="ident" id="6002225">s</span><span class="op" id="6002226">.</span><span class="ident" id="6002227">NumGC</span><span class="op" id="6002232">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6002236">fmt</span><span class="op" id="6002239">.</span><span class="ident" id="6002240">Fprintf</span><span class="op" id="6002247">(</span><span class="ident" id="6002248">w</span><span class="op" id="6002249">,</span>&nbsp;<span class="string" id="6002251">&#34;#&nbsp;EnableGC&nbsp;=&nbsp;%v\n&#34;</span><span class="op" id="6002270">,</span>&nbsp;<span class="ident" id="6002272">s</span><span class="op" id="6002273">.</span><span class="ident" id="6002274">EnableGC</span><span class="op" id="6002282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6002286">fmt</span><span class="op" id="6002289">.</span><span class="ident" id="6002290">Fprintf</span><span class="op" id="6002297">(</span><span class="ident" id="6002298">w</span><span class="op" id="6002299">,</span>&nbsp;<span class="string" id="6002301">&#34;#&nbsp;DebugGC&nbsp;=&nbsp;%v\n&#34;</span><span class="op" id="6002319">,</span>&nbsp;<span class="ident" id="6002321">s</span><span class="op" id="6002322">.</span><span class="ident" id="6002323">DebugGC</span><span class="op" id="6002330">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6002333">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6002337">if</span>&nbsp;<span class="ident" id="6002340">tw</span>&nbsp;<span class="op" id="6002343">!=</span>&nbsp;<span class="ident" id="6002346">nil</span>&nbsp;<span class="op" id="6002350">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6002354">tw</span><span class="op" id="6002356">.</span><span class="ident" id="6002357">Flush</span><span class="op" id="6002362">(</span><span class="op" id="6002363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6002366">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6002369">return</span>&nbsp;<span class="ident" id="6002376">b</span><span class="op" id="6002377">.</span><span class="ident" id="6002378">Flush</span><span class="op" id="6002383">(</span><span class="op" id="6002384">)</span><br>
<span class="lineno"></span><span class="op" id="6002386">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span><span class="comment" id="6002389">//&nbsp;countThreadCreate&nbsp;returns&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;current&nbsp;ThreadCreateProfile.</span><br>
<span class="lineno"></span><span class="keyword" id="6002463">func</span>&nbsp;<span class="ident" id="6002468">countThreadCreate</span><span class="op" id="6002485">(</span><span class="op" id="6002486">)</span>&nbsp;<span class="builtintype" id="6002488">int</span>&nbsp;<span class="op" id="6002492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6002495">n</span><span class="op" id="6002496">,</span>&nbsp;<span class="ident" id="6002498">_</span>&nbsp;<span class="op" id="6002500">:=</span>&nbsp;<span class="ident" id="6002503">runtime</span><span class="op" id="6002510">.</span><span class="ident" id="6002511">ThreadCreateProfile</span><span class="op" id="6002530">(</span><span class="ident" id="6002531">nil</span><span class="op" id="6002534">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6002537">return</span>&nbsp;<span class="ident" id="6002544">n</span><br>
<span class="lineno">485</span><span class="op" id="6002546">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6002549">//&nbsp;writeThreadCreate&nbsp;writes&nbsp;the&nbsp;current&nbsp;runtime&nbsp;ThreadCreateProfile&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="keyword" id="6002623">func</span>&nbsp;<span class="ident" id="6002628">writeThreadCreate</span><span class="op" id="6002645">(</span><span class="ident" id="6002646">w</span>&nbsp;<span class="ident" id="6002648">io</span><span class="op" id="6002650">.</span><span class="ident" id="6002651">Writer</span><span class="op" id="6002657">,</span>&nbsp;<span class="ident" id="6002659">debug</span>&nbsp;<span class="builtintype" id="6002665">int</span><span class="op" id="6002668">)</span>&nbsp;<span class="builtintype" id="6002670">error</span>&nbsp;<span class="op" id="6002676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6002679">return</span>&nbsp;<span class="ident" id="6002686">writeRuntimeProfile</span><span class="op" id="6002705">(</span><span class="ident" id="6002706">w</span><span class="op" id="6002707">,</span>&nbsp;<span class="ident" id="6002709">debug</span><span class="op" id="6002714">,</span>&nbsp;<span class="string" id="6002716">&#34;threadcreate&#34;</span><span class="op" id="6002730">,</span>&nbsp;<span class="ident" id="6002732">runtime</span><span class="op" id="6002739">.</span><span class="ident" id="6002740">ThreadCreateProfile</span><span class="op" id="6002759">)</span><br>
<span class="lineno">490</span><span class="op" id="6002761">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6002764">//&nbsp;countGoroutine&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="keyword" id="6002816">func</span>&nbsp;<span class="ident" id="6002821">countGoroutine</span><span class="op" id="6002835">(</span><span class="op" id="6002836">)</span>&nbsp;<span class="builtintype" id="6002838">int</span>&nbsp;<span class="op" id="6002842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6002845">return</span>&nbsp;<span class="ident" id="6002852">runtime</span><span class="op" id="6002859">.</span><span class="ident" id="6002860">NumGoroutine</span><span class="op" id="6002872">(</span><span class="op" id="6002873">)</span><br>
<span class="lineno">495</span><span class="op" id="6002875">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6002878">//&nbsp;writeGoroutine&nbsp;writes&nbsp;the&nbsp;current&nbsp;runtime&nbsp;GoroutineProfile&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="keyword" id="6002946">func</span>&nbsp;<span class="ident" id="6002951">writeGoroutine</span><span class="op" id="6002965">(</span><span class="ident" id="6002966">w</span>&nbsp;<span class="ident" id="6002968">io</span><span class="op" id="6002970">.</span><span class="ident" id="6002971">Writer</span><span class="op" id="6002977">,</span>&nbsp;<span class="ident" id="6002979">debug</span>&nbsp;<span class="builtintype" id="6002985">int</span><span class="op" id="6002988">)</span>&nbsp;<span class="builtintype" id="6002990">error</span>&nbsp;<span class="op" id="6002996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6002999">if</span>&nbsp;<span class="ident" id="6003002">debug</span>&nbsp;<span class="op" id="6003008">&gt;=</span>&nbsp;<span class="num" id="6003011">2</span>&nbsp;<span class="op" id="6003013">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6003017">return</span>&nbsp;<span class="ident" id="6003024">writeGoroutineStacks</span><span class="op" id="6003044">(</span><span class="ident" id="6003045">w</span><span class="op" id="6003046">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6003049">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6003052">return</span>&nbsp;<span class="ident" id="6003059">writeRuntimeProfile</span><span class="op" id="6003078">(</span><span class="ident" id="6003079">w</span><span class="op" id="6003080">,</span>&nbsp;<span class="ident" id="6003082">debug</span><span class="op" id="6003087">,</span>&nbsp;<span class="string" id="6003089">&#34;goroutine&#34;</span><span class="op" id="6003100">,</span>&nbsp;<span class="ident" id="6003102">runtime</span><span class="op" id="6003109">.</span><span class="ident" id="6003110">GoroutineProfile</span><span class="op" id="6003126">)</span><br>
<span class="lineno"></span><span class="op" id="6003128">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">505</span><span class="keyword" id="6003131">func</span>&nbsp;<span class="ident" id="6003136">writeGoroutineStacks</span><span class="op" id="6003156">(</span><span class="ident" id="6003157">w</span>&nbsp;<span class="ident" id="6003159">io</span><span class="op" id="6003161">.</span><span class="ident" id="6003162">Writer</span><span class="op" id="6003168">)</span>&nbsp;<span class="builtintype" id="6003170">error</span>&nbsp;<span class="op" id="6003176">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6003179">//&nbsp;We&nbsp;don&#39;t&nbsp;know&nbsp;how&nbsp;big&nbsp;the&nbsp;buffer&nbsp;needs&nbsp;to&nbsp;be&nbsp;to&nbsp;collect</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6003239">//&nbsp;all&nbsp;the&nbsp;goroutines.&nbsp;&nbsp;Start&nbsp;with&nbsp;1&nbsp;MB&nbsp;and&nbsp;try&nbsp;a&nbsp;few&nbsp;times,&nbsp;doubling&nbsp;each&nbsp;time.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6003321">//&nbsp;Give&nbsp;up&nbsp;and&nbsp;use&nbsp;a&nbsp;truncated&nbsp;trace&nbsp;if&nbsp;64&nbsp;MB&nbsp;is&nbsp;not&nbsp;enough.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6003383">buf</span>&nbsp;<span class="op" id="6003387">:=</span>&nbsp;<span class="builtinfunc" id="6003390">make</span><span class="op" id="6003394">(</span><span class="op" id="6003395">[</span><span class="op" id="6003396">]</span><span class="builtintype" id="6003397">byte</span><span class="op" id="6003401">,</span>&nbsp;<span class="num" id="6003403">1</span><span class="op" id="6003404">&lt;&lt;</span><span class="num" id="6003406">20</span><span class="op" id="6003408">)</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6003411">for</span>&nbsp;<span class="ident" id="6003415">i</span>&nbsp;<span class="op" id="6003417">:=</span>&nbsp;<span class="num" id="6003420">0</span><span class="op" id="6003421">;</span>&nbsp;<span class="op" id="6003423">;</span>&nbsp;<span class="ident" id="6003425">i</span><span class="op" id="6003426">++</span>&nbsp;<span class="op" id="6003429">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6003433">n</span>&nbsp;<span class="op" id="6003435">:=</span>&nbsp;<span class="ident" id="6003438">runtime</span><span class="op" id="6003445">.</span><span class="ident" id="6003446">Stack</span><span class="op" id="6003451">(</span><span class="ident" id="6003452">buf</span><span class="op" id="6003455">,</span>&nbsp;<span class="builtintype" id="6003457">true</span><span class="op" id="6003461">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6003465">if</span>&nbsp;<span class="ident" id="6003468">n</span>&nbsp;<span class="op" id="6003470">&lt;</span>&nbsp;<span class="builtinfunc" id="6003472">len</span><span class="op" id="6003475">(</span><span class="ident" id="6003476">buf</span><span class="op" id="6003479">)</span>&nbsp;<span class="op" id="6003481">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6003486">buf</span>&nbsp;<span class="op" id="6003490">=</span>&nbsp;<span class="ident" id="6003492">buf</span><span class="op" id="6003495">[</span><span class="op" id="6003496">:</span><span class="ident" id="6003497">n</span><span class="op" id="6003498">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6003503">break</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6003511">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6003515">if</span>&nbsp;<span class="builtinfunc" id="6003518">len</span><span class="op" id="6003521">(</span><span class="ident" id="6003522">buf</span><span class="op" id="6003525">)</span>&nbsp;<span class="op" id="6003527">&gt;=</span>&nbsp;<span class="num" id="6003530">64</span><span class="op" id="6003532">&lt;&lt;</span><span class="num" id="6003534">20</span>&nbsp;<span class="op" id="6003537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6003542">//&nbsp;Filled&nbsp;64&nbsp;MB&nbsp;-&nbsp;stop&nbsp;there.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6003575">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6003583">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6003587">buf</span>&nbsp;<span class="op" id="6003591">=</span>&nbsp;<span class="builtinfunc" id="6003593">make</span><span class="op" id="6003597">(</span><span class="op" id="6003598">[</span><span class="op" id="6003599">]</span><span class="builtintype" id="6003600">byte</span><span class="op" id="6003604">,</span>&nbsp;<span class="num" id="6003606">2</span><span class="op" id="6003607">*</span><span class="builtinfunc" id="6003608">len</span><span class="op" id="6003611">(</span><span class="ident" id="6003612">buf</span><span class="op" id="6003615">)</span><span class="op" id="6003616">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6003619">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6003622">_</span><span class="op" id="6003623">,</span>&nbsp;<span class="ident" id="6003625">err</span>&nbsp;<span class="op" id="6003629">:=</span>&nbsp;<span class="ident" id="6003632">w</span><span class="op" id="6003633">.</span><span class="ident" id="6003634">Write</span><span class="op" id="6003639">(</span><span class="ident" id="6003640">buf</span><span class="op" id="6003643">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6003646">return</span>&nbsp;<span class="ident" id="6003653">err</span><br>
<span class="lineno"></span><span class="op" id="6003657">}</span><br>
<span class="lineno">525</span><br>
<span class="lineno"></span><span class="keyword" id="6003660">func</span>&nbsp;<span class="ident" id="6003665">writeRuntimeProfile</span><span class="op" id="6003684">(</span><span class="ident" id="6003685">w</span>&nbsp;<span class="ident" id="6003687">io</span><span class="op" id="6003689">.</span><span class="ident" id="6003690">Writer</span><span class="op" id="6003696">,</span>&nbsp;<span class="ident" id="6003698">debug</span>&nbsp;<span class="builtintype" id="6003704">int</span><span class="op" id="6003707">,</span>&nbsp;<span class="ident" id="6003709">name</span>&nbsp;<span class="builtintype" id="6003714">string</span><span class="op" id="6003720">,</span>&nbsp;<span class="ident" id="6003722">fetch</span>&nbsp;<span class="keyword" id="6003728">func</span><span class="op" id="6003732">(</span><span class="op" id="6003733">[</span><span class="op" id="6003734">]</span><span class="ident" id="6003735">runtime</span><span class="op" id="6003742">.</span><span class="ident" id="6003743">StackRecord</span><span class="op" id="6003754">)</span>&nbsp;<span class="op" id="6003756">(</span><span class="builtintype" id="6003757">int</span><span class="op" id="6003760">,</span>&nbsp;<span class="builtintype" id="6003762">bool</span><span class="op" id="6003766">)</span><span class="op" id="6003767">)</span>&nbsp;<span class="builtintype" id="6003769">error</span>&nbsp;<span class="op" id="6003775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6003778">//&nbsp;Find&nbsp;out&nbsp;how&nbsp;many&nbsp;records&nbsp;there&nbsp;are&nbsp;(fetch(nil)),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6003832">//&nbsp;allocate&nbsp;that&nbsp;many&nbsp;records,&nbsp;and&nbsp;get&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6003882">//&nbsp;There&#39;s&nbsp;a&nbsp;race—more&nbsp;records&nbsp;might&nbsp;be&nbsp;added&nbsp;between</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6003939">//&nbsp;the&nbsp;two&nbsp;calls—so&nbsp;allocate&nbsp;a&nbsp;few&nbsp;extra&nbsp;records&nbsp;for&nbsp;safety</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6004002">//&nbsp;and&nbsp;also&nbsp;try&nbsp;again&nbsp;if&nbsp;we&#39;re&nbsp;very&nbsp;unlucky.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6004048">//&nbsp;The&nbsp;loop&nbsp;should&nbsp;only&nbsp;execute&nbsp;one&nbsp;iteration&nbsp;in&nbsp;the&nbsp;common&nbsp;case.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6004115">var</span>&nbsp;<span class="ident" id="6004119">p</span>&nbsp;<span class="op" id="6004121">[</span><span class="op" id="6004122">]</span><span class="ident" id="6004123">runtime</span><span class="op" id="6004130">.</span><span class="ident" id="6004131">StackRecord</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6004144">n</span><span class="op" id="6004145">,</span>&nbsp;<span class="ident" id="6004147">ok</span>&nbsp;<span class="op" id="6004150">:=</span>&nbsp;<span class="ident" id="6004153">fetch</span><span class="op" id="6004158">(</span><span class="ident" id="6004159">nil</span><span class="op" id="6004162">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6004165">for</span>&nbsp;<span class="op" id="6004169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6004173">//&nbsp;Allocate&nbsp;room&nbsp;for&nbsp;a&nbsp;slightly&nbsp;bigger&nbsp;profile,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6004223">//&nbsp;in&nbsp;case&nbsp;a&nbsp;few&nbsp;more&nbsp;entries&nbsp;have&nbsp;been&nbsp;added</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6004271">//&nbsp;since&nbsp;the&nbsp;call&nbsp;to&nbsp;ThreadProfile.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6004309">p</span>&nbsp;<span class="op" id="6004311">=</span>&nbsp;<span class="builtinfunc" id="6004313">make</span><span class="op" id="6004317">(</span><span class="op" id="6004318">[</span><span class="op" id="6004319">]</span><span class="ident" id="6004320">runtime</span><span class="op" id="6004327">.</span><span class="ident" id="6004328">StackRecord</span><span class="op" id="6004339">,</span>&nbsp;<span class="ident" id="6004341">n</span><span class="op" id="6004342">+</span><span class="num" id="6004343">10</span><span class="op" id="6004345">)</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6004349">n</span><span class="op" id="6004350">,</span>&nbsp;<span class="ident" id="6004352">ok</span>&nbsp;<span class="op" id="6004355">=</span>&nbsp;<span class="ident" id="6004357">fetch</span><span class="op" id="6004362">(</span><span class="ident" id="6004363">p</span><span class="op" id="6004364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6004368">if</span>&nbsp;<span class="ident" id="6004371">ok</span>&nbsp;<span class="op" id="6004374">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6004379">p</span>&nbsp;<span class="op" id="6004381">=</span>&nbsp;<span class="ident" id="6004383">p</span><span class="op" id="6004384">[</span><span class="num" id="6004385">0</span><span class="op" id="6004386">:</span><span class="ident" id="6004387">n</span><span class="op" id="6004388">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6004393">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6004401">}</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6004405">//&nbsp;Profile&nbsp;grew;&nbsp;try&nbsp;again.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6004434">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6004438">return</span>&nbsp;<span class="ident" id="6004445">printCountProfile</span><span class="op" id="6004462">(</span><span class="ident" id="6004463">w</span><span class="op" id="6004464">,</span>&nbsp;<span class="ident" id="6004466">debug</span><span class="op" id="6004471">,</span>&nbsp;<span class="ident" id="6004473">name</span><span class="op" id="6004477">,</span>&nbsp;<span class="ident" id="6004479">runtimeProfile</span><span class="op" id="6004493">(</span><span class="ident" id="6004494">p</span><span class="op" id="6004495">)</span><span class="op" id="6004496">)</span><br>
<span class="lineno"></span><span class="op" id="6004498">}</span><br>
<span class="lineno">550</span><br>
<span class="lineno"></span><span class="keyword" id="6004501">type</span>&nbsp;<span class="ident" id="6004506">runtimeProfile</span>&nbsp;<span class="op" id="6004521">[</span><span class="op" id="6004522">]</span><span class="ident" id="6004523">runtime</span><span class="op" id="6004530">.</span><span class="ident" id="6004531">StackRecord</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6004544">func</span>&nbsp;<span class="op" id="6004549">(</span><span class="ident" id="6004550">p</span>&nbsp;<span class="ident" id="6004552">runtimeProfile</span><span class="op" id="6004566">)</span>&nbsp;<span class="ident" id="6004568">Len</span><span class="op" id="6004571">(</span><span class="op" id="6004572">)</span>&nbsp;<span class="builtintype" id="6004574">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6004591">{</span>&nbsp;<span class="keyword" id="6004593">return</span>&nbsp;<span class="builtinfunc" id="6004600">len</span><span class="op" id="6004603">(</span><span class="ident" id="6004604">p</span><span class="op" id="6004605">)</span>&nbsp;<span class="op" id="6004607">}</span><br>
<span class="lineno"></span><span class="keyword" id="6004609">func</span>&nbsp;<span class="op" id="6004614">(</span><span class="ident" id="6004615">p</span>&nbsp;<span class="ident" id="6004617">runtimeProfile</span><span class="op" id="6004631">)</span>&nbsp;<span class="ident" id="6004633">Stack</span><span class="op" id="6004638">(</span><span class="ident" id="6004639">i</span>&nbsp;<span class="builtintype" id="6004641">int</span><span class="op" id="6004644">)</span>&nbsp;<span class="op" id="6004646">[</span><span class="op" id="6004647">]</span><span class="builtintype" id="6004648">uintptr</span>&nbsp;<span class="op" id="6004656">{</span>&nbsp;<span class="keyword" id="6004658">return</span>&nbsp;<span class="ident" id="6004665">p</span><span class="op" id="6004666">[</span><span class="ident" id="6004667">i</span><span class="op" id="6004668">]</span><span class="op" id="6004669">.</span><span class="ident" id="6004670">Stack</span><span class="op" id="6004675">(</span><span class="op" id="6004676">)</span>&nbsp;<span class="op" id="6004678">}</span><br>
<span class="lineno">555</span><br>
<span class="lineno"></span><span class="keyword" id="6004681">var</span>&nbsp;<span class="ident" id="6004685">cpu</span>&nbsp;<span class="keyword" id="6004689">struct</span>&nbsp;<span class="op" id="6004696">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6004699">sync</span><span class="op" id="6004703">.</span><span class="ident" id="6004704">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6004711">profiling</span>&nbsp;<span class="builtintype" id="6004721">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6004727">done</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6004737">chan</span>&nbsp;<span class="builtintype" id="6004742">bool</span><br>
<span class="lineno">560</span><span class="op" id="6004747">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6004750">//&nbsp;StartCPUProfile&nbsp;enables&nbsp;CPU&nbsp;profiling&nbsp;for&nbsp;the&nbsp;current&nbsp;process.</span><br>
<span class="lineno"></span><span class="comment" id="6004816">//&nbsp;While&nbsp;profiling,&nbsp;the&nbsp;profile&nbsp;will&nbsp;be&nbsp;buffered&nbsp;and&nbsp;written&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="comment" id="6004883">//&nbsp;StartCPUProfile&nbsp;returns&nbsp;an&nbsp;error&nbsp;if&nbsp;profiling&nbsp;is&nbsp;already&nbsp;enabled.</span><br>
<span class="lineno">565</span><span class="keyword" id="6004952">func</span>&nbsp;<span class="ident" id="6004957">StartCPUProfile</span><span class="op" id="6004972">(</span><span class="ident" id="6004973">w</span>&nbsp;<span class="ident" id="6004975">io</span><span class="op" id="6004977">.</span><span class="ident" id="6004978">Writer</span><span class="op" id="6004984">)</span>&nbsp;<span class="builtintype" id="6004986">error</span>&nbsp;<span class="op" id="6004992">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6004995">//&nbsp;The&nbsp;runtime&nbsp;routines&nbsp;allow&nbsp;a&nbsp;variable&nbsp;profiling&nbsp;rate,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6005053">//&nbsp;but&nbsp;in&nbsp;practice&nbsp;operating&nbsp;systems&nbsp;cannot&nbsp;trigger&nbsp;signals</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6005114">//&nbsp;at&nbsp;more&nbsp;than&nbsp;about&nbsp;500&nbsp;Hz,&nbsp;and&nbsp;our&nbsp;processing&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6005171">//&nbsp;signal&nbsp;is&nbsp;not&nbsp;cheap&nbsp;(mostly&nbsp;getting&nbsp;the&nbsp;stack&nbsp;trace).</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6005229">//&nbsp;100&nbsp;Hz&nbsp;is&nbsp;a&nbsp;reasonable&nbsp;choice:&nbsp;it&nbsp;is&nbsp;frequent&nbsp;enough&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6005289">//&nbsp;produce&nbsp;useful&nbsp;data,&nbsp;rare&nbsp;enough&nbsp;not&nbsp;to&nbsp;bog&nbsp;down&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6005346">//&nbsp;system,&nbsp;and&nbsp;a&nbsp;nice&nbsp;round&nbsp;number&nbsp;to&nbsp;make&nbsp;it&nbsp;easy&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6005401">//&nbsp;convert&nbsp;sample&nbsp;counts&nbsp;to&nbsp;seconds.&nbsp;&nbsp;Instead&nbsp;of&nbsp;requiring</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6005461">//&nbsp;each&nbsp;client&nbsp;to&nbsp;specify&nbsp;the&nbsp;frequency,&nbsp;we&nbsp;hard&nbsp;code&nbsp;it.</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6005520">const</span>&nbsp;<span class="ident" id="6005526">hz</span>&nbsp;<span class="op" id="6005529">=</span>&nbsp;<span class="num" id="6005531">100</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6005537">cpu</span><span class="op" id="6005540">.</span><span class="ident" id="6005541">Lock</span><span class="op" id="6005545">(</span><span class="op" id="6005546">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6005549">defer</span>&nbsp;<span class="ident" id="6005555">cpu</span><span class="op" id="6005558">.</span><span class="ident" id="6005559">Unlock</span><span class="op" id="6005565">(</span><span class="op" id="6005566">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6005569">if</span>&nbsp;<span class="ident" id="6005572">cpu</span><span class="op" id="6005575">.</span><span class="ident" id="6005576">done</span>&nbsp;<span class="op" id="6005581">==</span>&nbsp;<span class="ident" id="6005584">nil</span>&nbsp;<span class="op" id="6005588">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6005592">cpu</span><span class="op" id="6005595">.</span><span class="ident" id="6005596">done</span>&nbsp;<span class="op" id="6005601">=</span>&nbsp;<span class="builtinfunc" id="6005603">make</span><span class="op" id="6005607">(</span><span class="keyword" id="6005608">chan</span>&nbsp;<span class="builtintype" id="6005613">bool</span><span class="op" id="6005617">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6005620">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6005623">//&nbsp;Double-check.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6005641">if</span>&nbsp;<span class="ident" id="6005644">cpu</span><span class="op" id="6005647">.</span><span class="ident" id="6005648">profiling</span>&nbsp;<span class="op" id="6005658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6005662">return</span>&nbsp;<span class="ident" id="6005669">fmt</span><span class="op" id="6005672">.</span><span class="ident" id="6005673">Errorf</span><span class="op" id="6005679">(</span><span class="string" id="6005680">&#34;cpu&nbsp;profiling&nbsp;already&nbsp;in&nbsp;use&#34;</span><span class="op" id="6005710">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6005713">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6005716">cpu</span><span class="op" id="6005719">.</span><span class="ident" id="6005720">profiling</span>&nbsp;<span class="op" id="6005730">=</span>&nbsp;<span class="builtintype" id="6005732">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6005738">runtime</span><span class="op" id="6005745">.</span><span class="ident" id="6005746">SetCPUProfileRate</span><span class="op" id="6005763">(</span><span class="ident" id="6005764">hz</span><span class="op" id="6005766">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6005769">go</span>&nbsp;<span class="ident" id="6005772">profileWriter</span><span class="op" id="6005785">(</span><span class="ident" id="6005786">w</span><span class="op" id="6005787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6005790">return</span>&nbsp;<span class="ident" id="6005797">nil</span><br>
<span class="lineno">590</span><span class="op" id="6005801">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6005804">func</span>&nbsp;<span class="ident" id="6005809">profileWriter</span><span class="op" id="6005822">(</span><span class="ident" id="6005823">w</span>&nbsp;<span class="ident" id="6005825">io</span><span class="op" id="6005827">.</span><span class="ident" id="6005828">Writer</span><span class="op" id="6005834">)</span>&nbsp;<span class="op" id="6005836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6005839">for</span>&nbsp;<span class="op" id="6005843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6005847">data</span>&nbsp;<span class="op" id="6005852">:=</span>&nbsp;<span class="ident" id="6005855">runtime</span><span class="op" id="6005862">.</span><span class="ident" id="6005863">CPUProfile</span><span class="op" id="6005873">(</span><span class="op" id="6005874">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6005878">if</span>&nbsp;<span class="ident" id="6005881">data</span>&nbsp;<span class="op" id="6005886">==</span>&nbsp;<span class="ident" id="6005889">nil</span>&nbsp;<span class="op" id="6005893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6005898">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6005906">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6005910">w</span><span class="op" id="6005911">.</span><span class="ident" id="6005912">Write</span><span class="op" id="6005917">(</span><span class="ident" id="6005918">data</span><span class="op" id="6005922">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6005925">}</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6005928">cpu</span><span class="op" id="6005931">.</span><span class="ident" id="6005932">done</span>&nbsp;<span class="op" id="6005937">&lt;-</span>&nbsp;<span class="builtintype" id="6005940">true</span><br>
<span class="lineno"></span><span class="op" id="6005945">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6005948">//&nbsp;StopCPUProfile&nbsp;stops&nbsp;the&nbsp;current&nbsp;CPU&nbsp;profile,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span><span class="comment" id="6006005">//&nbsp;StopCPUProfile&nbsp;only&nbsp;returns&nbsp;after&nbsp;all&nbsp;the&nbsp;writes&nbsp;for&nbsp;the</span><br>
<span class="lineno">605</span><span class="comment" id="6006065">//&nbsp;profile&nbsp;have&nbsp;completed.</span><br>
<span class="lineno"></span><span class="keyword" id="6006092">func</span>&nbsp;<span class="ident" id="6006097">StopCPUProfile</span><span class="op" id="6006111">(</span><span class="op" id="6006112">)</span>&nbsp;<span class="op" id="6006114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6006117">cpu</span><span class="op" id="6006120">.</span><span class="ident" id="6006121">Lock</span><span class="op" id="6006125">(</span><span class="op" id="6006126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6006129">defer</span>&nbsp;<span class="ident" id="6006135">cpu</span><span class="op" id="6006138">.</span><span class="ident" id="6006139">Unlock</span><span class="op" id="6006145">(</span><span class="op" id="6006146">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6006150">if</span>&nbsp;<span class="op" id="6006153">!</span><span class="ident" id="6006154">cpu</span><span class="op" id="6006157">.</span><span class="ident" id="6006158">profiling</span>&nbsp;<span class="op" id="6006168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6006172">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6006180">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6006183">cpu</span><span class="op" id="6006186">.</span><span class="ident" id="6006187">profiling</span>&nbsp;<span class="op" id="6006197">=</span>&nbsp;<span class="builtintype" id="6006199">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6006206">runtime</span><span class="op" id="6006213">.</span><span class="ident" id="6006214">SetCPUProfileRate</span><span class="op" id="6006231">(</span><span class="num" id="6006232">0</span><span class="op" id="6006233">)</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6006236">&lt;-</span><span class="ident" id="6006238">cpu</span><span class="op" id="6006241">.</span><span class="ident" id="6006242">done</span><br>
<span class="lineno"></span><span class="op" id="6006247">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6006250">type</span>&nbsp;<span class="ident" id="6006255">byCycles</span>&nbsp;<span class="op" id="6006264">[</span><span class="op" id="6006265">]</span><span class="ident" id="6006266">runtime</span><span class="op" id="6006273">.</span><span class="ident" id="6006274">BlockProfileRecord</span><br>
<span class="lineno"></span><br>
<span class="lineno">620</span><span class="keyword" id="6006294">func</span>&nbsp;<span class="op" id="6006299">(</span><span class="ident" id="6006300">x</span>&nbsp;<span class="ident" id="6006302">byCycles</span><span class="op" id="6006310">)</span>&nbsp;<span class="ident" id="6006312">Len</span><span class="op" id="6006315">(</span><span class="op" id="6006316">)</span>&nbsp;<span class="builtintype" id="6006318">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6006332">{</span>&nbsp;<span class="keyword" id="6006334">return</span>&nbsp;<span class="builtinfunc" id="6006341">len</span><span class="op" id="6006344">(</span><span class="ident" id="6006345">x</span><span class="op" id="6006346">)</span>&nbsp;<span class="op" id="6006348">}</span><br>
<span class="lineno"></span><span class="keyword" id="6006350">func</span>&nbsp;<span class="op" id="6006355">(</span><span class="ident" id="6006356">x</span>&nbsp;<span class="ident" id="6006358">byCycles</span><span class="op" id="6006366">)</span>&nbsp;<span class="ident" id="6006368">Swap</span><span class="op" id="6006372">(</span><span class="ident" id="6006373">i</span><span class="op" id="6006374">,</span>&nbsp;<span class="ident" id="6006376">j</span>&nbsp;<span class="builtintype" id="6006378">int</span><span class="op" id="6006381">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6006388">{</span>&nbsp;<span class="ident" id="6006390">x</span><span class="op" id="6006391">[</span><span class="ident" id="6006392">i</span><span class="op" id="6006393">]</span><span class="op" id="6006394">,</span>&nbsp;<span class="ident" id="6006396">x</span><span class="op" id="6006397">[</span><span class="ident" id="6006398">j</span><span class="op" id="6006399">]</span>&nbsp;<span class="op" id="6006401">=</span>&nbsp;<span class="ident" id="6006403">x</span><span class="op" id="6006404">[</span><span class="ident" id="6006405">j</span><span class="op" id="6006406">]</span><span class="op" id="6006407">,</span>&nbsp;<span class="ident" id="6006409">x</span><span class="op" id="6006410">[</span><span class="ident" id="6006411">i</span><span class="op" id="6006412">]</span>&nbsp;<span class="op" id="6006414">}</span><br>
<span class="lineno"></span><span class="keyword" id="6006416">func</span>&nbsp;<span class="op" id="6006421">(</span><span class="ident" id="6006422">x</span>&nbsp;<span class="ident" id="6006424">byCycles</span><span class="op" id="6006432">)</span>&nbsp;<span class="ident" id="6006434">Less</span><span class="op" id="6006438">(</span><span class="ident" id="6006439">i</span><span class="op" id="6006440">,</span>&nbsp;<span class="ident" id="6006442">j</span>&nbsp;<span class="builtintype" id="6006444">int</span><span class="op" id="6006447">)</span>&nbsp;<span class="builtintype" id="6006449">bool</span>&nbsp;<span class="op" id="6006454">{</span>&nbsp;<span class="keyword" id="6006456">return</span>&nbsp;<span class="ident" id="6006463">x</span><span class="op" id="6006464">[</span><span class="ident" id="6006465">i</span><span class="op" id="6006466">]</span><span class="op" id="6006467">.</span><span class="ident" id="6006468">Cycles</span>&nbsp;<span class="op" id="6006475">&gt;</span>&nbsp;<span class="ident" id="6006477">x</span><span class="op" id="6006478">[</span><span class="ident" id="6006479">j</span><span class="op" id="6006480">]</span><span class="op" id="6006481">.</span><span class="ident" id="6006482">Cycles</span>&nbsp;<span class="op" id="6006489">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6006492">//&nbsp;countBlock&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;records&nbsp;in&nbsp;the&nbsp;blocking&nbsp;profile.</span><br>
<span class="lineno">625</span><span class="keyword" id="6006561">func</span>&nbsp;<span class="ident" id="6006566">countBlock</span><span class="op" id="6006576">(</span><span class="op" id="6006577">)</span>&nbsp;<span class="builtintype" id="6006579">int</span>&nbsp;<span class="op" id="6006583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6006586">n</span><span class="op" id="6006587">,</span>&nbsp;<span class="ident" id="6006589">_</span>&nbsp;<span class="op" id="6006591">:=</span>&nbsp;<span class="ident" id="6006594">runtime</span><span class="op" id="6006601">.</span><span class="ident" id="6006602">BlockProfile</span><span class="op" id="6006614">(</span><span class="ident" id="6006615">nil</span><span class="op" id="6006618">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6006621">return</span>&nbsp;<span class="ident" id="6006628">n</span><br>
<span class="lineno"></span><span class="op" id="6006630">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">630</span><span class="comment" id="6006633">//&nbsp;writeBlock&nbsp;writes&nbsp;the&nbsp;current&nbsp;blocking&nbsp;profile&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span><span class="keyword" id="6006689">func</span>&nbsp;<span class="ident" id="6006694">writeBlock</span><span class="op" id="6006704">(</span><span class="ident" id="6006705">w</span>&nbsp;<span class="ident" id="6006707">io</span><span class="op" id="6006709">.</span><span class="ident" id="6006710">Writer</span><span class="op" id="6006716">,</span>&nbsp;<span class="ident" id="6006718">debug</span>&nbsp;<span class="builtintype" id="6006724">int</span><span class="op" id="6006727">)</span>&nbsp;<span class="builtintype" id="6006729">error</span>&nbsp;<span class="op" id="6006735">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6006738">var</span>&nbsp;<span class="ident" id="6006742">p</span>&nbsp;<span class="op" id="6006744">[</span><span class="op" id="6006745">]</span><span class="ident" id="6006746">runtime</span><span class="op" id="6006753">.</span><span class="ident" id="6006754">BlockProfileRecord</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6006774">n</span><span class="op" id="6006775">,</span>&nbsp;<span class="ident" id="6006777">ok</span>&nbsp;<span class="op" id="6006780">:=</span>&nbsp;<span class="ident" id="6006783">runtime</span><span class="op" id="6006790">.</span><span class="ident" id="6006791">BlockProfile</span><span class="op" id="6006803">(</span><span class="ident" id="6006804">nil</span><span class="op" id="6006807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6006810">for</span>&nbsp;<span class="op" id="6006814">{</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6006818">p</span>&nbsp;<span class="op" id="6006820">=</span>&nbsp;<span class="builtinfunc" id="6006822">make</span><span class="op" id="6006826">(</span><span class="op" id="6006827">[</span><span class="op" id="6006828">]</span><span class="ident" id="6006829">runtime</span><span class="op" id="6006836">.</span><span class="ident" id="6006837">BlockProfileRecord</span><span class="op" id="6006855">,</span>&nbsp;<span class="ident" id="6006857">n</span><span class="op" id="6006858">+</span><span class="num" id="6006859">50</span><span class="op" id="6006861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6006865">n</span><span class="op" id="6006866">,</span>&nbsp;<span class="ident" id="6006868">ok</span>&nbsp;<span class="op" id="6006871">=</span>&nbsp;<span class="ident" id="6006873">runtime</span><span class="op" id="6006880">.</span><span class="ident" id="6006881">BlockProfile</span><span class="op" id="6006893">(</span><span class="ident" id="6006894">p</span><span class="op" id="6006895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6006899">if</span>&nbsp;<span class="ident" id="6006902">ok</span>&nbsp;<span class="op" id="6006905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6006910">p</span>&nbsp;<span class="op" id="6006912">=</span>&nbsp;<span class="ident" id="6006914">p</span><span class="op" id="6006915">[</span><span class="op" id="6006916">:</span><span class="ident" id="6006917">n</span><span class="op" id="6006918">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6006923">break</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6006931">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6006934">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6006938">sort</span><span class="op" id="6006942">.</span><span class="ident" id="6006943">Sort</span><span class="op" id="6006947">(</span><span class="ident" id="6006948">byCycles</span><span class="op" id="6006956">(</span><span class="ident" id="6006957">p</span><span class="op" id="6006958">)</span><span class="op" id="6006959">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6006963">b</span>&nbsp;<span class="op" id="6006965">:=</span>&nbsp;<span class="ident" id="6006968">bufio</span><span class="op" id="6006973">.</span><span class="ident" id="6006974">NewWriter</span><span class="op" id="6006983">(</span><span class="ident" id="6006984">w</span><span class="op" id="6006985">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6006988">var</span>&nbsp;<span class="ident" id="6006992">tw</span>&nbsp;<span class="op" id="6006995">*</span><span class="ident" id="6006996">tabwriter</span><span class="op" id="6007005">.</span><span class="ident" id="6007006">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6007014">w</span>&nbsp;<span class="op" id="6007016">=</span>&nbsp;<span class="ident" id="6007018">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6007021">if</span>&nbsp;<span class="ident" id="6007024">debug</span>&nbsp;<span class="op" id="6007030">&gt;</span>&nbsp;<span class="num" id="6007032">0</span>&nbsp;<span class="op" id="6007034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6007038">tw</span>&nbsp;<span class="op" id="6007041">=</span>&nbsp;<span class="ident" id="6007043">tabwriter</span><span class="op" id="6007052">.</span><span class="ident" id="6007053">NewWriter</span><span class="op" id="6007062">(</span><span class="ident" id="6007063">w</span><span class="op" id="6007064">,</span>&nbsp;<span class="num" id="6007066">1</span><span class="op" id="6007067">,</span>&nbsp;<span class="num" id="6007069">8</span><span class="op" id="6007070">,</span>&nbsp;<span class="num" id="6007072">1</span><span class="op" id="6007073">,</span>&nbsp;<span class="string" id="6007075">&#39;\t&#39;</span><span class="op" id="6007079">,</span>&nbsp;<span class="num" id="6007081">0</span><span class="op" id="6007082">)</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6007086">w</span>&nbsp;<span class="op" id="6007088">=</span>&nbsp;<span class="ident" id="6007090">tw</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6007094">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6007098">fmt</span><span class="op" id="6007101">.</span><span class="ident" id="6007102">Fprintf</span><span class="op" id="6007109">(</span><span class="ident" id="6007110">w</span><span class="op" id="6007111">,</span>&nbsp;<span class="string" id="6007113">&#34;---&nbsp;contention:\n&#34;</span><span class="op" id="6007132">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6007135">fmt</span><span class="op" id="6007138">.</span><span class="ident" id="6007139">Fprintf</span><span class="op" id="6007146">(</span><span class="ident" id="6007147">w</span><span class="op" id="6007148">,</span>&nbsp;<span class="string" id="6007150">&#34;cycles/second=%v\n&#34;</span><span class="op" id="6007170">,</span>&nbsp;<span class="ident" id="6007172">runtime_cyclesPerSecond</span><span class="op" id="6007195">(</span><span class="op" id="6007196">)</span><span class="op" id="6007197">)</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6007200">for</span>&nbsp;<span class="ident" id="6007204">i</span>&nbsp;<span class="op" id="6007206">:=</span>&nbsp;<span class="keyword" id="6007209">range</span>&nbsp;<span class="ident" id="6007215">p</span>&nbsp;<span class="op" id="6007217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6007221">r</span>&nbsp;<span class="op" id="6007223">:=</span>&nbsp;<span class="op" id="6007226">&amp;</span><span class="ident" id="6007227">p</span><span class="op" id="6007228">[</span><span class="ident" id="6007229">i</span><span class="op" id="6007230">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6007234">fmt</span><span class="op" id="6007237">.</span><span class="ident" id="6007238">Fprintf</span><span class="op" id="6007245">(</span><span class="ident" id="6007246">w</span><span class="op" id="6007247">,</span>&nbsp;<span class="string" id="6007249">&#34;%v&nbsp;%v&nbsp;@&#34;</span><span class="op" id="6007258">,</span>&nbsp;<span class="ident" id="6007260">r</span><span class="op" id="6007261">.</span><span class="ident" id="6007262">Cycles</span><span class="op" id="6007268">,</span>&nbsp;<span class="ident" id="6007270">r</span><span class="op" id="6007271">.</span><span class="ident" id="6007272">Count</span><span class="op" id="6007277">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6007281">for</span>&nbsp;<span class="ident" id="6007285">_</span><span class="op" id="6007286">,</span>&nbsp;<span class="ident" id="6007288">pc</span>&nbsp;<span class="op" id="6007291">:=</span>&nbsp;<span class="keyword" id="6007294">range</span>&nbsp;<span class="ident" id="6007300">r</span><span class="op" id="6007301">.</span><span class="ident" id="6007302">Stack</span><span class="op" id="6007307">(</span><span class="op" id="6007308">)</span>&nbsp;<span class="op" id="6007310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6007315">fmt</span><span class="op" id="6007318">.</span><span class="ident" id="6007319">Fprintf</span><span class="op" id="6007326">(</span><span class="ident" id="6007327">w</span><span class="op" id="6007328">,</span>&nbsp;<span class="string" id="6007330">&#34;&nbsp;%#x&#34;</span><span class="op" id="6007336">,</span>&nbsp;<span class="ident" id="6007338">pc</span><span class="op" id="6007340">)</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6007344">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6007348">fmt</span><span class="op" id="6007351">.</span><span class="ident" id="6007352">Fprint</span><span class="op" id="6007358">(</span><span class="ident" id="6007359">w</span><span class="op" id="6007360">,</span>&nbsp;<span class="string" id="6007362">&#34;\n&#34;</span><span class="op" id="6007366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6007370">if</span>&nbsp;<span class="ident" id="6007373">debug</span>&nbsp;<span class="op" id="6007379">&gt;</span>&nbsp;<span class="num" id="6007381">0</span>&nbsp;<span class="op" id="6007383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6007388">printStackRecord</span><span class="op" id="6007404">(</span><span class="ident" id="6007405">w</span><span class="op" id="6007406">,</span>&nbsp;<span class="ident" id="6007408">r</span><span class="op" id="6007409">.</span><span class="ident" id="6007410">Stack</span><span class="op" id="6007415">(</span><span class="op" id="6007416">)</span><span class="op" id="6007417">,</span>&nbsp;<span class="builtintype" id="6007419">true</span><span class="op" id="6007423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6007427">}</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6007430">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6007434">if</span>&nbsp;<span class="ident" id="6007437">tw</span>&nbsp;<span class="op" id="6007440">!=</span>&nbsp;<span class="ident" id="6007443">nil</span>&nbsp;<span class="op" id="6007447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6007451">tw</span><span class="op" id="6007453">.</span><span class="ident" id="6007454">Flush</span><span class="op" id="6007459">(</span><span class="op" id="6007460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6007463">}</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6007466">return</span>&nbsp;<span class="ident" id="6007473">b</span><span class="op" id="6007474">.</span><span class="ident" id="6007475">Flush</span><span class="op" id="6007480">(</span><span class="op" id="6007481">)</span><br>
<span class="lineno"></span><span class="op" id="6007483">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6007486">func</span>&nbsp;<span class="ident" id="6007491">runtime_cyclesPerSecond</span><span class="op" id="6007514">(</span><span class="op" id="6007515">)</span>&nbsp;<span class="ident" id="6007517">int64</span>
</div>
</body>
</html>
