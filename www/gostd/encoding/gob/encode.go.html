<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="4472513">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4472568">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4472622">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4472673">//go:generate&nbsp;go&nbsp;run&nbsp;encgen.go&nbsp;-output&nbsp;enc_helpers.go</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4472728">package</span>&nbsp;<span class="ident" id="4472736">gob</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4472741">import</span>&nbsp;<span class="op" id="4472748">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4472751">&#34;encoding&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4472763">&#34;math&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4472771">&#34;reflect&#34;</span><br>
<span class="lineno"></span><span class="op" id="4472781">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="4472784">const</span>&nbsp;<span class="ident" id="4472790">uint64Size</span>&nbsp;<span class="op" id="4472801">=</span>&nbsp;<span class="num" id="4472803">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4472806">type</span>&nbsp;<span class="ident" id="4472811">encHelper</span>&nbsp;<span class="keyword" id="4472821">func</span><span class="op" id="4472825">(</span><span class="ident" id="4472826">state</span>&nbsp;<span class="op" id="4472832">*</span><span class="ident" id="4472833">encoderState</span><span class="op" id="4472845">,</span>&nbsp;<span class="ident" id="4472847">v</span>&nbsp;<span class="ident" id="4472849">reflect</span><span class="op" id="4472856">.</span><span class="ident" id="4472857">Value</span><span class="op" id="4472862">)</span>&nbsp;<span class="builtintype" id="4472864">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4472870">//&nbsp;encoderState&nbsp;is&nbsp;the&nbsp;global&nbsp;execution&nbsp;state&nbsp;of&nbsp;an&nbsp;instance&nbsp;of&nbsp;the&nbsp;encoder.</span><br>
<span class="lineno">20</span><span class="comment" id="4472947">//&nbsp;Field&nbsp;numbers&nbsp;are&nbsp;delta&nbsp;encoded&nbsp;and&nbsp;always&nbsp;increase.&nbsp;The&nbsp;field</span><br>
<span class="lineno"></span><span class="comment" id="4473013">//&nbsp;number&nbsp;is&nbsp;initialized&nbsp;to&nbsp;-1&nbsp;so&nbsp;0&nbsp;comes&nbsp;out&nbsp;as&nbsp;delta(1).&nbsp;A&nbsp;delta&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="4473083">//&nbsp;0&nbsp;terminates&nbsp;the&nbsp;structure.</span><br>
<span class="lineno"></span><span class="keyword" id="4473114">type</span>&nbsp;<span class="ident" id="4473119">encoderState</span>&nbsp;<span class="keyword" id="4473132">struct</span>&nbsp;<span class="op" id="4473139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4473142">enc</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4473151">*</span><span class="ident" id="4473152">Encoder</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4473161">b</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4473170">*</span><span class="ident" id="4473171">encBuffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4473182">sendZero</span>&nbsp;<span class="builtintype" id="4473191">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4473212">//&nbsp;encoding&nbsp;an&nbsp;array&nbsp;element&nbsp;or&nbsp;map&nbsp;key/value&nbsp;pair;&nbsp;send&nbsp;zero&nbsp;values</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4473282">fieldnum</span>&nbsp;<span class="builtintype" id="4473291">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4473312">//&nbsp;the&nbsp;last&nbsp;field&nbsp;number&nbsp;written.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4473347">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4473356">[</span><span class="num" id="4473357">1</span>&nbsp;<span class="op" id="4473359">+</span>&nbsp;<span class="ident" id="4473361">uint64Size</span><span class="op" id="4473371">]</span><span class="builtintype" id="4473372">byte</span>&nbsp;<span class="comment" id="4473377">//&nbsp;buffer&nbsp;used&nbsp;by&nbsp;the&nbsp;encoder;&nbsp;here&nbsp;to&nbsp;avoid&nbsp;allocation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4473435">next</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4473444">*</span><span class="ident" id="4473445">encoderState</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4473465">//&nbsp;for&nbsp;free&nbsp;list</span><br>
<span class="lineno">30</span><span class="op" id="4473482">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4473485">//&nbsp;encBuffer&nbsp;is&nbsp;an&nbsp;extremely&nbsp;simple,&nbsp;fast&nbsp;implementation&nbsp;of&nbsp;a&nbsp;write-only&nbsp;byte&nbsp;buffer.</span><br>
<span class="lineno"></span><span class="comment" id="4473571">//&nbsp;It&nbsp;never&nbsp;returns&nbsp;a&nbsp;non-nil&nbsp;error,&nbsp;but&nbsp;Write&nbsp;returns&nbsp;an&nbsp;error&nbsp;value&nbsp;so&nbsp;it&nbsp;matches&nbsp;io.Writer.</span><br>
<span class="lineno"></span><span class="keyword" id="4473666">type</span>&nbsp;<span class="ident" id="4473671">encBuffer</span>&nbsp;<span class="keyword" id="4473681">struct</span>&nbsp;<span class="op" id="4473688">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4473691">data</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4473699">[</span><span class="op" id="4473700">]</span><span class="builtintype" id="4473701">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4473707">scratch</span>&nbsp;<span class="op" id="4473715">[</span><span class="num" id="4473716">64</span><span class="op" id="4473718">]</span><span class="builtintype" id="4473719">byte</span><br>
<span class="lineno"></span><span class="op" id="4473724">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4473727">func</span>&nbsp;<span class="op" id="4473732">(</span><span class="ident" id="4473733">e</span>&nbsp;<span class="op" id="4473735">*</span><span class="ident" id="4473736">encBuffer</span><span class="op" id="4473745">)</span>&nbsp;<span class="ident" id="4473747">WriteByte</span><span class="op" id="4473756">(</span><span class="ident" id="4473757">c</span>&nbsp;<span class="builtintype" id="4473759">byte</span><span class="op" id="4473763">)</span>&nbsp;<span class="op" id="4473765">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4473768">e</span><span class="op" id="4473769">.</span><span class="ident" id="4473770">data</span>&nbsp;<span class="op" id="4473775">=</span>&nbsp;<span class="builtinfunc" id="4473777">append</span><span class="op" id="4473783">(</span><span class="ident" id="4473784">e</span><span class="op" id="4473785">.</span><span class="ident" id="4473786">data</span><span class="op" id="4473790">,</span>&nbsp;<span class="ident" id="4473792">c</span><span class="op" id="4473793">)</span><br>
<span class="lineno"></span><span class="op" id="4473795">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4473798">func</span>&nbsp;<span class="op" id="4473803">(</span><span class="ident" id="4473804">e</span>&nbsp;<span class="op" id="4473806">*</span><span class="ident" id="4473807">encBuffer</span><span class="op" id="4473816">)</span>&nbsp;<span class="ident" id="4473818">Write</span><span class="op" id="4473823">(</span><span class="ident" id="4473824">p</span>&nbsp;<span class="op" id="4473826">[</span><span class="op" id="4473827">]</span><span class="builtintype" id="4473828">byte</span><span class="op" id="4473832">)</span>&nbsp;<span class="op" id="4473834">(</span><span class="builtintype" id="4473835">int</span><span class="op" id="4473838">,</span>&nbsp;<span class="builtintype" id="4473840">error</span><span class="op" id="4473845">)</span>&nbsp;<span class="op" id="4473847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4473850">e</span><span class="op" id="4473851">.</span><span class="ident" id="4473852">data</span>&nbsp;<span class="op" id="4473857">=</span>&nbsp;<span class="builtinfunc" id="4473859">append</span><span class="op" id="4473865">(</span><span class="ident" id="4473866">e</span><span class="op" id="4473867">.</span><span class="ident" id="4473868">data</span><span class="op" id="4473872">,</span>&nbsp;<span class="ident" id="4473874">p</span><span class="op" id="4473875">...</span><span class="op" id="4473878">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4473881">return</span>&nbsp;<span class="builtinfunc" id="4473888">len</span><span class="op" id="4473891">(</span><span class="ident" id="4473892">p</span><span class="op" id="4473893">)</span><span class="op" id="4473894">,</span>&nbsp;<span class="ident" id="4473896">nil</span><br>
<span class="lineno"></span><span class="op" id="4473900">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4473903">func</span>&nbsp;<span class="op" id="4473908">(</span><span class="ident" id="4473909">e</span>&nbsp;<span class="op" id="4473911">*</span><span class="ident" id="4473912">encBuffer</span><span class="op" id="4473921">)</span>&nbsp;<span class="ident" id="4473923">WriteString</span><span class="op" id="4473934">(</span><span class="ident" id="4473935">s</span>&nbsp;<span class="builtintype" id="4473937">string</span><span class="op" id="4473943">)</span>&nbsp;<span class="op" id="4473945">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4473948">e</span><span class="op" id="4473949">.</span><span class="ident" id="4473950">data</span>&nbsp;<span class="op" id="4473955">=</span>&nbsp;<span class="builtinfunc" id="4473957">append</span><span class="op" id="4473963">(</span><span class="ident" id="4473964">e</span><span class="op" id="4473965">.</span><span class="ident" id="4473966">data</span><span class="op" id="4473970">,</span>&nbsp;<span class="ident" id="4473972">s</span><span class="op" id="4473973">...</span><span class="op" id="4473976">)</span><br>
<span class="lineno">50</span><span class="op" id="4473978">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4473981">func</span>&nbsp;<span class="op" id="4473986">(</span><span class="ident" id="4473987">e</span>&nbsp;<span class="op" id="4473989">*</span><span class="ident" id="4473990">encBuffer</span><span class="op" id="4473999">)</span>&nbsp;<span class="ident" id="4474001">Len</span><span class="op" id="4474004">(</span><span class="op" id="4474005">)</span>&nbsp;<span class="builtintype" id="4474007">int</span>&nbsp;<span class="op" id="4474011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4474014">return</span>&nbsp;<span class="builtinfunc" id="4474021">len</span><span class="op" id="4474024">(</span><span class="ident" id="4474025">e</span><span class="op" id="4474026">.</span><span class="ident" id="4474027">data</span><span class="op" id="4474031">)</span><br>
<span class="lineno"></span><span class="op" id="4474033">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span><span class="keyword" id="4474036">func</span>&nbsp;<span class="op" id="4474041">(</span><span class="ident" id="4474042">e</span>&nbsp;<span class="op" id="4474044">*</span><span class="ident" id="4474045">encBuffer</span><span class="op" id="4474054">)</span>&nbsp;<span class="ident" id="4474056">Bytes</span><span class="op" id="4474061">(</span><span class="op" id="4474062">)</span>&nbsp;<span class="op" id="4474064">[</span><span class="op" id="4474065">]</span><span class="builtintype" id="4474066">byte</span>&nbsp;<span class="op" id="4474071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4474074">return</span>&nbsp;<span class="ident" id="4474081">e</span><span class="op" id="4474082">.</span><span class="ident" id="4474083">data</span><br>
<span class="lineno"></span><span class="op" id="4474088">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="4474091">func</span>&nbsp;<span class="op" id="4474096">(</span><span class="ident" id="4474097">e</span>&nbsp;<span class="op" id="4474099">*</span><span class="ident" id="4474100">encBuffer</span><span class="op" id="4474109">)</span>&nbsp;<span class="ident" id="4474111">Reset</span><span class="op" id="4474116">(</span><span class="op" id="4474117">)</span>&nbsp;<span class="op" id="4474119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4474122">e</span><span class="op" id="4474123">.</span><span class="ident" id="4474124">data</span>&nbsp;<span class="op" id="4474129">=</span>&nbsp;<span class="ident" id="4474131">e</span><span class="op" id="4474132">.</span><span class="ident" id="4474133">data</span><span class="op" id="4474137">[</span><span class="num" id="4474138">0</span><span class="op" id="4474139">:</span><span class="num" id="4474140">0</span><span class="op" id="4474141">]</span><br>
<span class="lineno"></span><span class="op" id="4474143">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4474146">func</span>&nbsp;<span class="op" id="4474151">(</span><span class="ident" id="4474152">enc</span>&nbsp;<span class="op" id="4474156">*</span><span class="ident" id="4474157">Encoder</span><span class="op" id="4474164">)</span>&nbsp;<span class="ident" id="4474166">newEncoderState</span><span class="op" id="4474181">(</span><span class="ident" id="4474182">b</span>&nbsp;<span class="op" id="4474184">*</span><span class="ident" id="4474185">encBuffer</span><span class="op" id="4474194">)</span>&nbsp;<span class="op" id="4474196">*</span><span class="ident" id="4474197">encoderState</span>&nbsp;<span class="op" id="4474210">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4474213">e</span>&nbsp;<span class="op" id="4474215">:=</span>&nbsp;<span class="ident" id="4474218">enc</span><span class="op" id="4474221">.</span><span class="ident" id="4474222">freeList</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4474232">if</span>&nbsp;<span class="ident" id="4474235">e</span>&nbsp;<span class="op" id="4474237">==</span>&nbsp;<span class="ident" id="4474240">nil</span>&nbsp;<span class="op" id="4474244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4474248">e</span>&nbsp;<span class="op" id="4474250">=</span>&nbsp;<span class="builtinfunc" id="4474252">new</span><span class="op" id="4474255">(</span><span class="ident" id="4474256">encoderState</span><span class="op" id="4474268">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4474272">e</span><span class="op" id="4474273">.</span><span class="ident" id="4474274">enc</span>&nbsp;<span class="op" id="4474278">=</span>&nbsp;<span class="ident" id="4474280">enc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4474285">}</span>&nbsp;<span class="keyword" id="4474287">else</span>&nbsp;<span class="op" id="4474292">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4474296">enc</span><span class="op" id="4474299">.</span><span class="ident" id="4474300">freeList</span>&nbsp;<span class="op" id="4474309">=</span>&nbsp;<span class="ident" id="4474311">e</span><span class="op" id="4474312">.</span><span class="ident" id="4474313">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4474319">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4474322">e</span><span class="op" id="4474323">.</span><span class="ident" id="4474324">sendZero</span>&nbsp;<span class="op" id="4474333">=</span>&nbsp;<span class="builtintype" id="4474335">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4474342">e</span><span class="op" id="4474343">.</span><span class="ident" id="4474344">fieldnum</span>&nbsp;<span class="op" id="4474353">=</span>&nbsp;<span class="num" id="4474355">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4474358">e</span><span class="op" id="4474359">.</span><span class="ident" id="4474360">b</span>&nbsp;<span class="op" id="4474362">=</span>&nbsp;<span class="ident" id="4474364">b</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4474367">if</span>&nbsp;<span class="builtinfunc" id="4474370">len</span><span class="op" id="4474373">(</span><span class="ident" id="4474374">b</span><span class="op" id="4474375">.</span><span class="ident" id="4474376">data</span><span class="op" id="4474380">)</span>&nbsp;<span class="op" id="4474382">==</span>&nbsp;<span class="num" id="4474385">0</span>&nbsp;<span class="op" id="4474387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4474391">b</span><span class="op" id="4474392">.</span><span class="ident" id="4474393">data</span>&nbsp;<span class="op" id="4474398">=</span>&nbsp;<span class="ident" id="4474400">b</span><span class="op" id="4474401">.</span><span class="ident" id="4474402">scratch</span><span class="op" id="4474409">[</span><span class="num" id="4474410">0</span><span class="op" id="4474411">:</span><span class="num" id="4474412">0</span><span class="op" id="4474413">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4474416">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4474419">return</span>&nbsp;<span class="ident" id="4474426">e</span><br>
<span class="lineno"></span><span class="op" id="4474428">}</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span><span class="keyword" id="4474431">func</span>&nbsp;<span class="op" id="4474436">(</span><span class="ident" id="4474437">enc</span>&nbsp;<span class="op" id="4474441">*</span><span class="ident" id="4474442">Encoder</span><span class="op" id="4474449">)</span>&nbsp;<span class="ident" id="4474451">freeEncoderState</span><span class="op" id="4474467">(</span><span class="ident" id="4474468">e</span>&nbsp;<span class="op" id="4474470">*</span><span class="ident" id="4474471">encoderState</span><span class="op" id="4474483">)</span>&nbsp;<span class="op" id="4474485">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4474488">e</span><span class="op" id="4474489">.</span><span class="ident" id="4474490">next</span>&nbsp;<span class="op" id="4474495">=</span>&nbsp;<span class="ident" id="4474497">enc</span><span class="op" id="4474500">.</span><span class="ident" id="4474501">freeList</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4474511">enc</span><span class="op" id="4474514">.</span><span class="ident" id="4474515">freeList</span>&nbsp;<span class="op" id="4474524">=</span>&nbsp;<span class="ident" id="4474526">e</span><br>
<span class="lineno"></span><span class="op" id="4474528">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span><span class="comment" id="4474531">//&nbsp;Unsigned&nbsp;integers&nbsp;have&nbsp;a&nbsp;two-state&nbsp;encoding.&nbsp;&nbsp;If&nbsp;the&nbsp;number&nbsp;is&nbsp;less</span><br>
<span class="lineno"></span><span class="comment" id="4474602">//&nbsp;than&nbsp;128&nbsp;(0&nbsp;through&nbsp;0x7F),&nbsp;its&nbsp;value&nbsp;is&nbsp;written&nbsp;directly.</span><br>
<span class="lineno"></span><span class="comment" id="4474663">//&nbsp;Otherwise&nbsp;the&nbsp;value&nbsp;is&nbsp;written&nbsp;in&nbsp;big-endian&nbsp;byte&nbsp;order&nbsp;preceded</span><br>
<span class="lineno"></span><span class="comment" id="4474731">//&nbsp;by&nbsp;the&nbsp;byte&nbsp;length,&nbsp;negated.</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="comment" id="4474764">//&nbsp;encodeUint&nbsp;writes&nbsp;an&nbsp;encoded&nbsp;unsigned&nbsp;integer&nbsp;to&nbsp;state.b.</span><br>
<span class="lineno"></span><span class="keyword" id="4474825">func</span>&nbsp;<span class="op" id="4474830">(</span><span class="ident" id="4474831">state</span>&nbsp;<span class="op" id="4474837">*</span><span class="ident" id="4474838">encoderState</span><span class="op" id="4474850">)</span>&nbsp;<span class="ident" id="4474852">encodeUint</span><span class="op" id="4474862">(</span><span class="ident" id="4474863">x</span>&nbsp;<span class="ident" id="4474865">uint64</span><span class="op" id="4474871">)</span>&nbsp;<span class="op" id="4474873">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4474876">if</span>&nbsp;<span class="ident" id="4474879">x</span>&nbsp;<span class="op" id="4474881">&lt;=</span>&nbsp;<span class="num" id="4474884">0x7F</span>&nbsp;<span class="op" id="4474889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4474893">state</span><span class="op" id="4474898">.</span><span class="ident" id="4474899">b</span><span class="op" id="4474900">.</span><span class="ident" id="4474901">WriteByte</span><span class="op" id="4474910">(</span><span class="builtintype" id="4474911">uint8</span><span class="op" id="4474916">(</span><span class="ident" id="4474917">x</span><span class="op" id="4474918">)</span><span class="op" id="4474919">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4474923">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4474931">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4474934">i</span>&nbsp;<span class="op" id="4474936">:=</span>&nbsp;<span class="ident" id="4474939">uint64Size</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4474951">for</span>&nbsp;<span class="ident" id="4474955">x</span>&nbsp;<span class="op" id="4474957">&gt;</span>&nbsp;<span class="num" id="4474959">0</span>&nbsp;<span class="op" id="4474961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4474965">state</span><span class="op" id="4474970">.</span><span class="ident" id="4474971">buf</span><span class="op" id="4474974">[</span><span class="ident" id="4474975">i</span><span class="op" id="4474976">]</span>&nbsp;<span class="op" id="4474978">=</span>&nbsp;<span class="builtintype" id="4474980">uint8</span><span class="op" id="4474985">(</span><span class="ident" id="4474986">x</span><span class="op" id="4474987">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4474991">x</span>&nbsp;<span class="op" id="4474993">&gt;&gt;=</span>&nbsp;<span class="num" id="4474997">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4475001">i</span><span class="op" id="4475002">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4475006">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4475009">state</span><span class="op" id="4475014">.</span><span class="ident" id="4475015">buf</span><span class="op" id="4475018">[</span><span class="ident" id="4475019">i</span><span class="op" id="4475020">]</span>&nbsp;<span class="op" id="4475022">=</span>&nbsp;<span class="builtintype" id="4475024">uint8</span><span class="op" id="4475029">(</span><span class="ident" id="4475030">i</span>&nbsp;<span class="op" id="4475032">-</span>&nbsp;<span class="ident" id="4475034">uint64Size</span><span class="op" id="4475044">)</span>&nbsp;<span class="comment" id="4475046">//&nbsp;=&nbsp;loop&nbsp;count,&nbsp;negated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4475072">state</span><span class="op" id="4475077">.</span><span class="ident" id="4475078">b</span><span class="op" id="4475079">.</span><span class="ident" id="4475080">Write</span><span class="op" id="4475085">(</span><span class="ident" id="4475086">state</span><span class="op" id="4475091">.</span><span class="ident" id="4475092">buf</span><span class="op" id="4475095">[</span><span class="ident" id="4475096">i</span>&nbsp;<span class="op" id="4475098">:</span>&nbsp;<span class="ident" id="4475100">uint64Size</span><span class="op" id="4475110">+</span><span class="num" id="4475111">1</span><span class="op" id="4475112">]</span><span class="op" id="4475113">)</span><br>
<span class="lineno">105</span><span class="op" id="4475115">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4475118">//&nbsp;encodeInt&nbsp;writes&nbsp;an&nbsp;encoded&nbsp;signed&nbsp;integer&nbsp;to&nbsp;state.w.</span><br>
<span class="lineno"></span><span class="comment" id="4475176">//&nbsp;The&nbsp;low&nbsp;bit&nbsp;of&nbsp;the&nbsp;encoding&nbsp;says&nbsp;whether&nbsp;to&nbsp;bit&nbsp;complement&nbsp;the&nbsp;(other&nbsp;bits&nbsp;of&nbsp;the)</span><br>
<span class="lineno"></span><span class="comment" id="4475262">//&nbsp;uint&nbsp;to&nbsp;recover&nbsp;the&nbsp;int.</span><br>
<span class="lineno">110</span><span class="keyword" id="4475290">func</span>&nbsp;<span class="op" id="4475295">(</span><span class="ident" id="4475296">state</span>&nbsp;<span class="op" id="4475302">*</span><span class="ident" id="4475303">encoderState</span><span class="op" id="4475315">)</span>&nbsp;<span class="ident" id="4475317">encodeInt</span><span class="op" id="4475326">(</span><span class="ident" id="4475327">i</span>&nbsp;<span class="ident" id="4475329">int64</span><span class="op" id="4475334">)</span>&nbsp;<span class="op" id="4475336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4475339">var</span>&nbsp;<span class="ident" id="4475343">x</span>&nbsp;<span class="ident" id="4475345">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4475353">if</span>&nbsp;<span class="ident" id="4475356">i</span>&nbsp;<span class="op" id="4475358">&lt;</span>&nbsp;<span class="num" id="4475360">0</span>&nbsp;<span class="op" id="4475362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4475366">x</span>&nbsp;<span class="op" id="4475368">=</span>&nbsp;<span class="ident" id="4475370">uint64</span><span class="op" id="4475376">(</span><span class="op" id="4475377">^</span><span class="ident" id="4475378">i</span><span class="op" id="4475379">&lt;&lt;</span><span class="num" id="4475381">1</span><span class="op" id="4475382">)</span>&nbsp;<span class="op" id="4475384">|</span>&nbsp;<span class="num" id="4475386">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4475389">}</span>&nbsp;<span class="keyword" id="4475391">else</span>&nbsp;<span class="op" id="4475396">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4475400">x</span>&nbsp;<span class="op" id="4475402">=</span>&nbsp;<span class="ident" id="4475404">uint64</span><span class="op" id="4475410">(</span><span class="ident" id="4475411">i</span>&nbsp;<span class="op" id="4475413">&lt;&lt;</span>&nbsp;<span class="num" id="4475416">1</span><span class="op" id="4475417">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4475420">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4475423">state</span><span class="op" id="4475428">.</span><span class="ident" id="4475429">encodeUint</span><span class="op" id="4475439">(</span><span class="ident" id="4475440">uint64</span><span class="op" id="4475446">(</span><span class="ident" id="4475447">x</span><span class="op" id="4475448">)</span><span class="op" id="4475449">)</span><br>
<span class="lineno"></span><span class="op" id="4475451">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="comment" id="4475454">//&nbsp;encOp&nbsp;is&nbsp;the&nbsp;signature&nbsp;of&nbsp;an&nbsp;encoding&nbsp;operator&nbsp;for&nbsp;a&nbsp;given&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="4475522">type</span>&nbsp;<span class="ident" id="4475527">encOp</span>&nbsp;<span class="keyword" id="4475533">func</span><span class="op" id="4475537">(</span><span class="ident" id="4475538">i</span>&nbsp;<span class="op" id="4475540">*</span><span class="ident" id="4475541">encInstr</span><span class="op" id="4475549">,</span>&nbsp;<span class="ident" id="4475551">state</span>&nbsp;<span class="op" id="4475557">*</span><span class="ident" id="4475558">encoderState</span><span class="op" id="4475570">,</span>&nbsp;<span class="ident" id="4475572">v</span>&nbsp;<span class="ident" id="4475574">reflect</span><span class="op" id="4475581">.</span><span class="ident" id="4475582">Value</span><span class="op" id="4475587">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4475590">//&nbsp;The&nbsp;&#39;instructions&#39;&nbsp;of&nbsp;the&nbsp;encoding&nbsp;machine</span><br>
<span class="lineno"></span><span class="keyword" id="4475636">type</span>&nbsp;<span class="ident" id="4475641">encInstr</span>&nbsp;<span class="keyword" id="4475650">struct</span>&nbsp;<span class="op" id="4475657">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4475660">op</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4475666">encOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4475673">field</span>&nbsp;<span class="builtintype" id="4475679">int</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="4475685">//&nbsp;field&nbsp;number&nbsp;in&nbsp;input</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4475711">index</span>&nbsp;<span class="op" id="4475717">[</span><span class="op" id="4475718">]</span><span class="builtintype" id="4475719">int</span>&nbsp;<span class="comment" id="4475723">//&nbsp;struct&nbsp;index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4475740">indir</span>&nbsp;<span class="builtintype" id="4475746">int</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="4475752">//&nbsp;how&nbsp;many&nbsp;pointer&nbsp;indirections&nbsp;to&nbsp;reach&nbsp;the&nbsp;value&nbsp;in&nbsp;the&nbsp;struct</span><br>
<span class="lineno"></span><span class="op" id="4475818">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span><span class="comment" id="4475821">//&nbsp;update&nbsp;emits&nbsp;a&nbsp;field&nbsp;number&nbsp;and&nbsp;updates&nbsp;the&nbsp;state&nbsp;to&nbsp;record&nbsp;its&nbsp;value&nbsp;for&nbsp;delta&nbsp;encoding.</span><br>
<span class="lineno"></span><span class="comment" id="4475914">//&nbsp;If&nbsp;the&nbsp;instruction&nbsp;pointer&nbsp;is&nbsp;nil,&nbsp;it&nbsp;does&nbsp;nothing</span><br>
<span class="lineno"></span><span class="keyword" id="4475968">func</span>&nbsp;<span class="op" id="4475973">(</span><span class="ident" id="4475974">state</span>&nbsp;<span class="op" id="4475980">*</span><span class="ident" id="4475981">encoderState</span><span class="op" id="4475993">)</span>&nbsp;<span class="ident" id="4475995">update</span><span class="op" id="4476001">(</span><span class="ident" id="4476002">instr</span>&nbsp;<span class="op" id="4476008">*</span><span class="ident" id="4476009">encInstr</span><span class="op" id="4476017">)</span>&nbsp;<span class="op" id="4476019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4476022">if</span>&nbsp;<span class="ident" id="4476025">instr</span>&nbsp;<span class="op" id="4476031">!=</span>&nbsp;<span class="ident" id="4476034">nil</span>&nbsp;<span class="op" id="4476038">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4476042">state</span><span class="op" id="4476047">.</span><span class="ident" id="4476048">encodeUint</span><span class="op" id="4476058">(</span><span class="ident" id="4476059">uint64</span><span class="op" id="4476065">(</span><span class="ident" id="4476066">instr</span><span class="op" id="4476071">.</span><span class="ident" id="4476072">field</span>&nbsp;<span class="op" id="4476078">-</span>&nbsp;<span class="ident" id="4476080">state</span><span class="op" id="4476085">.</span><span class="ident" id="4476086">fieldnum</span><span class="op" id="4476094">)</span><span class="op" id="4476095">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4476099">state</span><span class="op" id="4476104">.</span><span class="ident" id="4476105">fieldnum</span>&nbsp;<span class="op" id="4476114">=</span>&nbsp;<span class="ident" id="4476116">instr</span><span class="op" id="4476121">.</span><span class="ident" id="4476122">field</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4476129">}</span><br>
<span class="lineno"></span><span class="op" id="4476131">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="comment" id="4476134">//&nbsp;Each&nbsp;encoder&nbsp;for&nbsp;a&nbsp;composite&nbsp;is&nbsp;responsible&nbsp;for&nbsp;handling&nbsp;any</span><br>
<span class="lineno"></span><span class="comment" id="4476198">//&nbsp;indirections&nbsp;associated&nbsp;with&nbsp;the&nbsp;elements&nbsp;of&nbsp;the&nbsp;data&nbsp;structure.</span><br>
<span class="lineno"></span><span class="comment" id="4476266">//&nbsp;If&nbsp;any&nbsp;pointer&nbsp;so&nbsp;reached&nbsp;is&nbsp;nil,&nbsp;no&nbsp;bytes&nbsp;are&nbsp;written.&nbsp;&nbsp;If&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4476333">//&nbsp;data&nbsp;item&nbsp;is&nbsp;zero,&nbsp;no&nbsp;bytes&nbsp;are&nbsp;written.&nbsp;&nbsp;Single&nbsp;values&nbsp;-&nbsp;ints,</span><br>
<span class="lineno"></span><span class="comment" id="4476400">//&nbsp;strings&nbsp;etc.&nbsp;-&nbsp;are&nbsp;indirected&nbsp;before&nbsp;calling&nbsp;their&nbsp;encoders.</span><br>
<span class="lineno">145</span><span class="comment" id="4476464">//&nbsp;Otherwise,&nbsp;the&nbsp;output&nbsp;(for&nbsp;a&nbsp;scalar)&nbsp;is&nbsp;the&nbsp;field&nbsp;number,&nbsp;as&nbsp;an</span><br>
<span class="lineno"></span><span class="comment" id="4476531">//&nbsp;encoded&nbsp;integer,&nbsp;followed&nbsp;by&nbsp;the&nbsp;field&nbsp;data&nbsp;in&nbsp;its&nbsp;appropriate</span><br>
<span class="lineno"></span><span class="comment" id="4476597">//&nbsp;format.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4476609">//&nbsp;encIndirect&nbsp;dereferences&nbsp;pv&nbsp;indir&nbsp;times&nbsp;and&nbsp;returns&nbsp;the&nbsp;result.</span><br>
<span class="lineno">150</span><span class="keyword" id="4476676">func</span>&nbsp;<span class="ident" id="4476681">encIndirect</span><span class="op" id="4476692">(</span><span class="ident" id="4476693">pv</span>&nbsp;<span class="ident" id="4476696">reflect</span><span class="op" id="4476703">.</span><span class="ident" id="4476704">Value</span><span class="op" id="4476709">,</span>&nbsp;<span class="ident" id="4476711">indir</span>&nbsp;<span class="builtintype" id="4476717">int</span><span class="op" id="4476720">)</span>&nbsp;<span class="ident" id="4476722">reflect</span><span class="op" id="4476729">.</span><span class="ident" id="4476730">Value</span>&nbsp;<span class="op" id="4476736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4476739">for</span>&nbsp;<span class="op" id="4476743">;</span>&nbsp;<span class="ident" id="4476745">indir</span>&nbsp;<span class="op" id="4476751">&gt;</span>&nbsp;<span class="num" id="4476753">0</span><span class="op" id="4476754">;</span>&nbsp;<span class="ident" id="4476756">indir</span><span class="op" id="4476761">--</span>&nbsp;<span class="op" id="4476764">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4476768">if</span>&nbsp;<span class="ident" id="4476771">pv</span><span class="op" id="4476773">.</span><span class="ident" id="4476774">IsNil</span><span class="op" id="4476779">(</span><span class="op" id="4476780">)</span>&nbsp;<span class="op" id="4476782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4476787">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4476795">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4476799">pv</span>&nbsp;<span class="op" id="4476802">=</span>&nbsp;<span class="ident" id="4476804">pv</span><span class="op" id="4476806">.</span><span class="ident" id="4476807">Elem</span><span class="op" id="4476811">(</span><span class="op" id="4476812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4476815">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4476818">return</span>&nbsp;<span class="ident" id="4476825">pv</span><br>
<span class="lineno"></span><span class="op" id="4476828">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="comment" id="4476831">//&nbsp;encBool&nbsp;encodes&nbsp;the&nbsp;bool&nbsp;referenced&nbsp;by&nbsp;v&nbsp;as&nbsp;an&nbsp;unsigned&nbsp;0&nbsp;or&nbsp;1.</span><br>
<span class="lineno"></span><span class="keyword" id="4476898">func</span>&nbsp;<span class="ident" id="4476903">encBool</span><span class="op" id="4476910">(</span><span class="ident" id="4476911">i</span>&nbsp;<span class="op" id="4476913">*</span><span class="ident" id="4476914">encInstr</span><span class="op" id="4476922">,</span>&nbsp;<span class="ident" id="4476924">state</span>&nbsp;<span class="op" id="4476930">*</span><span class="ident" id="4476931">encoderState</span><span class="op" id="4476943">,</span>&nbsp;<span class="ident" id="4476945">v</span>&nbsp;<span class="ident" id="4476947">reflect</span><span class="op" id="4476954">.</span><span class="ident" id="4476955">Value</span><span class="op" id="4476960">)</span>&nbsp;<span class="op" id="4476962">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4476965">b</span>&nbsp;<span class="op" id="4476967">:=</span>&nbsp;<span class="ident" id="4476970">v</span><span class="op" id="4476971">.</span><span class="ident" id="4476972">Bool</span><span class="op" id="4476976">(</span><span class="op" id="4476977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4476980">if</span>&nbsp;<span class="ident" id="4476983">b</span>&nbsp;<span class="op" id="4476985">||</span>&nbsp;<span class="ident" id="4476988">state</span><span class="op" id="4476993">.</span><span class="ident" id="4476994">sendZero</span>&nbsp;<span class="op" id="4477003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4477007">state</span><span class="op" id="4477012">.</span><span class="ident" id="4477013">update</span><span class="op" id="4477019">(</span><span class="ident" id="4477020">i</span><span class="op" id="4477021">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4477025">if</span>&nbsp;<span class="ident" id="4477028">b</span>&nbsp;<span class="op" id="4477030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4477035">state</span><span class="op" id="4477040">.</span><span class="ident" id="4477041">encodeUint</span><span class="op" id="4477051">(</span><span class="num" id="4477052">1</span><span class="op" id="4477053">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4477057">}</span>&nbsp;<span class="keyword" id="4477059">else</span>&nbsp;<span class="op" id="4477064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4477069">state</span><span class="op" id="4477074">.</span><span class="ident" id="4477075">encodeUint</span><span class="op" id="4477085">(</span><span class="num" id="4477086">0</span><span class="op" id="4477087">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4477091">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4477094">}</span><br>
<span class="lineno"></span><span class="op" id="4477096">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4477099">//&nbsp;encInt&nbsp;encodes&nbsp;the&nbsp;signed&nbsp;integer&nbsp;(int&nbsp;int8&nbsp;int16&nbsp;int32&nbsp;int64)&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="4477182">func</span>&nbsp;<span class="ident" id="4477187">encInt</span><span class="op" id="4477193">(</span><span class="ident" id="4477194">i</span>&nbsp;<span class="op" id="4477196">*</span><span class="ident" id="4477197">encInstr</span><span class="op" id="4477205">,</span>&nbsp;<span class="ident" id="4477207">state</span>&nbsp;<span class="op" id="4477213">*</span><span class="ident" id="4477214">encoderState</span><span class="op" id="4477226">,</span>&nbsp;<span class="ident" id="4477228">v</span>&nbsp;<span class="ident" id="4477230">reflect</span><span class="op" id="4477237">.</span><span class="ident" id="4477238">Value</span><span class="op" id="4477243">)</span>&nbsp;<span class="op" id="4477245">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4477248">value</span>&nbsp;<span class="op" id="4477254">:=</span>&nbsp;<span class="ident" id="4477257">v</span><span class="op" id="4477258">.</span><span class="ident" id="4477259">Int</span><span class="op" id="4477262">(</span><span class="op" id="4477263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4477266">if</span>&nbsp;<span class="ident" id="4477269">value</span>&nbsp;<span class="op" id="4477275">!=</span>&nbsp;<span class="num" id="4477278">0</span>&nbsp;<span class="op" id="4477280">||</span>&nbsp;<span class="ident" id="4477283">state</span><span class="op" id="4477288">.</span><span class="ident" id="4477289">sendZero</span>&nbsp;<span class="op" id="4477298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4477302">state</span><span class="op" id="4477307">.</span><span class="ident" id="4477308">update</span><span class="op" id="4477314">(</span><span class="ident" id="4477315">i</span><span class="op" id="4477316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4477320">state</span><span class="op" id="4477325">.</span><span class="ident" id="4477326">encodeInt</span><span class="op" id="4477335">(</span><span class="ident" id="4477336">value</span><span class="op" id="4477341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4477344">}</span><br>
<span class="lineno">180</span><span class="op" id="4477346">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4477349">//&nbsp;encUint&nbsp;encodes&nbsp;the&nbsp;unsigned&nbsp;integer&nbsp;(uint&nbsp;uint8&nbsp;uint16&nbsp;uint32&nbsp;uint64&nbsp;uintptr)&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="4477448">func</span>&nbsp;<span class="ident" id="4477453">encUint</span><span class="op" id="4477460">(</span><span class="ident" id="4477461">i</span>&nbsp;<span class="op" id="4477463">*</span><span class="ident" id="4477464">encInstr</span><span class="op" id="4477472">,</span>&nbsp;<span class="ident" id="4477474">state</span>&nbsp;<span class="op" id="4477480">*</span><span class="ident" id="4477481">encoderState</span><span class="op" id="4477493">,</span>&nbsp;<span class="ident" id="4477495">v</span>&nbsp;<span class="ident" id="4477497">reflect</span><span class="op" id="4477504">.</span><span class="ident" id="4477505">Value</span><span class="op" id="4477510">)</span>&nbsp;<span class="op" id="4477512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4477515">value</span>&nbsp;<span class="op" id="4477521">:=</span>&nbsp;<span class="ident" id="4477524">v</span><span class="op" id="4477525">.</span><span class="ident" id="4477526">Uint</span><span class="op" id="4477530">(</span><span class="op" id="4477531">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4477534">if</span>&nbsp;<span class="ident" id="4477537">value</span>&nbsp;<span class="op" id="4477543">!=</span>&nbsp;<span class="num" id="4477546">0</span>&nbsp;<span class="op" id="4477548">||</span>&nbsp;<span class="ident" id="4477551">state</span><span class="op" id="4477556">.</span><span class="ident" id="4477557">sendZero</span>&nbsp;<span class="op" id="4477566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4477570">state</span><span class="op" id="4477575">.</span><span class="ident" id="4477576">update</span><span class="op" id="4477582">(</span><span class="ident" id="4477583">i</span><span class="op" id="4477584">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4477588">state</span><span class="op" id="4477593">.</span><span class="ident" id="4477594">encodeUint</span><span class="op" id="4477604">(</span><span class="ident" id="4477605">value</span><span class="op" id="4477610">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4477613">}</span><br>
<span class="lineno"></span><span class="op" id="4477615">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span><span class="comment" id="4477618">//&nbsp;floatBits&nbsp;returns&nbsp;a&nbsp;uint64&nbsp;holding&nbsp;the&nbsp;bits&nbsp;of&nbsp;a&nbsp;floating-point&nbsp;number.</span><br>
<span class="lineno"></span><span class="comment" id="4477693">//&nbsp;Floating-point&nbsp;numbers&nbsp;are&nbsp;transmitted&nbsp;as&nbsp;uint64s&nbsp;holding&nbsp;the&nbsp;bits</span><br>
<span class="lineno"></span><span class="comment" id="4477763">//&nbsp;of&nbsp;the&nbsp;underlying&nbsp;representation.&nbsp;&nbsp;They&nbsp;are&nbsp;sent&nbsp;byte-reversed,&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="4477835">//&nbsp;the&nbsp;exponent&nbsp;end&nbsp;coming&nbsp;out&nbsp;first,&nbsp;so&nbsp;integer&nbsp;floating&nbsp;point&nbsp;numbers</span><br>
<span class="lineno">195</span><span class="comment" id="4477907">//&nbsp;(for&nbsp;example)&nbsp;transmit&nbsp;more&nbsp;compactly.&nbsp;&nbsp;This&nbsp;routine&nbsp;does&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4477972">//&nbsp;swizzling.</span><br>
<span class="lineno"></span><span class="keyword" id="4477986">func</span>&nbsp;<span class="ident" id="4477991">floatBits</span><span class="op" id="4478000">(</span><span class="ident" id="4478001">f</span>&nbsp;<span class="builtintype" id="4478003">float64</span><span class="op" id="4478010">)</span>&nbsp;<span class="ident" id="4478012">uint64</span>&nbsp;<span class="op" id="4478019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4478022">u</span>&nbsp;<span class="op" id="4478024">:=</span>&nbsp;<span class="ident" id="4478027">math</span><span class="op" id="4478031">.</span><span class="ident" id="4478032">Float64bits</span><span class="op" id="4478043">(</span><span class="ident" id="4478044">f</span><span class="op" id="4478045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4478048">var</span>&nbsp;<span class="ident" id="4478052">v</span>&nbsp;<span class="ident" id="4478054">uint64</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4478062">for</span>&nbsp;<span class="ident" id="4478066">i</span>&nbsp;<span class="op" id="4478068">:=</span>&nbsp;<span class="num" id="4478071">0</span><span class="op" id="4478072">;</span>&nbsp;<span class="ident" id="4478074">i</span>&nbsp;<span class="op" id="4478076">&lt;</span>&nbsp;<span class="num" id="4478078">8</span><span class="op" id="4478079">;</span>&nbsp;<span class="ident" id="4478081">i</span><span class="op" id="4478082">++</span>&nbsp;<span class="op" id="4478085">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4478089">v</span>&nbsp;<span class="op" id="4478091">&lt;&lt;=</span>&nbsp;<span class="num" id="4478095">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4478099">v</span>&nbsp;<span class="op" id="4478101">|=</span>&nbsp;<span class="ident" id="4478104">u</span>&nbsp;<span class="op" id="4478106">&amp;</span>&nbsp;<span class="num" id="4478108">0xFF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4478115">u</span>&nbsp;<span class="op" id="4478117">&gt;&gt;=</span>&nbsp;<span class="num" id="4478121">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4478124">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4478127">return</span>&nbsp;<span class="ident" id="4478134">v</span><br>
<span class="lineno"></span><span class="op" id="4478136">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4478139">//&nbsp;encFloat&nbsp;encodes&nbsp;the&nbsp;floating&nbsp;point&nbsp;value&nbsp;(float32&nbsp;float64)&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="4478219">func</span>&nbsp;<span class="ident" id="4478224">encFloat</span><span class="op" id="4478232">(</span><span class="ident" id="4478233">i</span>&nbsp;<span class="op" id="4478235">*</span><span class="ident" id="4478236">encInstr</span><span class="op" id="4478244">,</span>&nbsp;<span class="ident" id="4478246">state</span>&nbsp;<span class="op" id="4478252">*</span><span class="ident" id="4478253">encoderState</span><span class="op" id="4478265">,</span>&nbsp;<span class="ident" id="4478267">v</span>&nbsp;<span class="ident" id="4478269">reflect</span><span class="op" id="4478276">.</span><span class="ident" id="4478277">Value</span><span class="op" id="4478282">)</span>&nbsp;<span class="op" id="4478284">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4478287">f</span>&nbsp;<span class="op" id="4478289">:=</span>&nbsp;<span class="ident" id="4478292">v</span><span class="op" id="4478293">.</span><span class="ident" id="4478294">Float</span><span class="op" id="4478299">(</span><span class="op" id="4478300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4478303">if</span>&nbsp;<span class="ident" id="4478306">f</span>&nbsp;<span class="op" id="4478308">!=</span>&nbsp;<span class="num" id="4478311">0</span>&nbsp;<span class="op" id="4478313">||</span>&nbsp;<span class="ident" id="4478316">state</span><span class="op" id="4478321">.</span><span class="ident" id="4478322">sendZero</span>&nbsp;<span class="op" id="4478331">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4478335">bits</span>&nbsp;<span class="op" id="4478340">:=</span>&nbsp;<span class="ident" id="4478343">floatBits</span><span class="op" id="4478352">(</span><span class="ident" id="4478353">f</span><span class="op" id="4478354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4478358">state</span><span class="op" id="4478363">.</span><span class="ident" id="4478364">update</span><span class="op" id="4478370">(</span><span class="ident" id="4478371">i</span><span class="op" id="4478372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4478376">state</span><span class="op" id="4478381">.</span><span class="ident" id="4478382">encodeUint</span><span class="op" id="4478392">(</span><span class="ident" id="4478393">bits</span><span class="op" id="4478397">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4478400">}</span><br>
<span class="lineno"></span><span class="op" id="4478402">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4478405">//&nbsp;encComplex&nbsp;encodes&nbsp;the&nbsp;complex&nbsp;value&nbsp;(complex64&nbsp;complex128)&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="comment" id="4478485">//&nbsp;Complex&nbsp;numbers&nbsp;are&nbsp;just&nbsp;a&nbsp;pair&nbsp;of&nbsp;floating-point&nbsp;numbers,&nbsp;real&nbsp;part&nbsp;first.</span><br>
<span class="lineno">220</span><span class="keyword" id="4478564">func</span>&nbsp;<span class="ident" id="4478569">encComplex</span><span class="op" id="4478579">(</span><span class="ident" id="4478580">i</span>&nbsp;<span class="op" id="4478582">*</span><span class="ident" id="4478583">encInstr</span><span class="op" id="4478591">,</span>&nbsp;<span class="ident" id="4478593">state</span>&nbsp;<span class="op" id="4478599">*</span><span class="ident" id="4478600">encoderState</span><span class="op" id="4478612">,</span>&nbsp;<span class="ident" id="4478614">v</span>&nbsp;<span class="ident" id="4478616">reflect</span><span class="op" id="4478623">.</span><span class="ident" id="4478624">Value</span><span class="op" id="4478629">)</span>&nbsp;<span class="op" id="4478631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4478634">c</span>&nbsp;<span class="op" id="4478636">:=</span>&nbsp;<span class="ident" id="4478639">v</span><span class="op" id="4478640">.</span><span class="ident" id="4478641">Complex</span><span class="op" id="4478648">(</span><span class="op" id="4478649">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4478652">if</span>&nbsp;<span class="ident" id="4478655">c</span>&nbsp;<span class="op" id="4478657">!=</span>&nbsp;<span class="num" id="4478660">0</span><span class="op" id="4478661">+</span><span class="num" id="4478662">0i</span>&nbsp;<span class="op" id="4478665">||</span>&nbsp;<span class="ident" id="4478668">state</span><span class="op" id="4478673">.</span><span class="ident" id="4478674">sendZero</span>&nbsp;<span class="op" id="4478683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4478687">rpart</span>&nbsp;<span class="op" id="4478693">:=</span>&nbsp;<span class="ident" id="4478696">floatBits</span><span class="op" id="4478705">(</span><span class="builtinfunc" id="4478706">real</span><span class="op" id="4478710">(</span><span class="ident" id="4478711">c</span><span class="op" id="4478712">)</span><span class="op" id="4478713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4478717">ipart</span>&nbsp;<span class="op" id="4478723">:=</span>&nbsp;<span class="ident" id="4478726">floatBits</span><span class="op" id="4478735">(</span><span class="builtinfunc" id="4478736">imag</span><span class="op" id="4478740">(</span><span class="ident" id="4478741">c</span><span class="op" id="4478742">)</span><span class="op" id="4478743">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4478747">state</span><span class="op" id="4478752">.</span><span class="ident" id="4478753">update</span><span class="op" id="4478759">(</span><span class="ident" id="4478760">i</span><span class="op" id="4478761">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4478765">state</span><span class="op" id="4478770">.</span><span class="ident" id="4478771">encodeUint</span><span class="op" id="4478781">(</span><span class="ident" id="4478782">rpart</span><span class="op" id="4478787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4478791">state</span><span class="op" id="4478796">.</span><span class="ident" id="4478797">encodeUint</span><span class="op" id="4478807">(</span><span class="ident" id="4478808">ipart</span><span class="op" id="4478813">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4478816">}</span><br>
<span class="lineno"></span><span class="op" id="4478818">}</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span><span class="comment" id="4478821">//&nbsp;encUint8Array&nbsp;encodes&nbsp;the&nbsp;byte&nbsp;array&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="comment" id="4478878">//&nbsp;Byte&nbsp;arrays&nbsp;are&nbsp;encoded&nbsp;as&nbsp;an&nbsp;unsigned&nbsp;count&nbsp;followed&nbsp;by&nbsp;the&nbsp;raw&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="keyword" id="4478953">func</span>&nbsp;<span class="ident" id="4478958">encUint8Array</span><span class="op" id="4478971">(</span><span class="ident" id="4478972">i</span>&nbsp;<span class="op" id="4478974">*</span><span class="ident" id="4478975">encInstr</span><span class="op" id="4478983">,</span>&nbsp;<span class="ident" id="4478985">state</span>&nbsp;<span class="op" id="4478991">*</span><span class="ident" id="4478992">encoderState</span><span class="op" id="4479004">,</span>&nbsp;<span class="ident" id="4479006">v</span>&nbsp;<span class="ident" id="4479008">reflect</span><span class="op" id="4479015">.</span><span class="ident" id="4479016">Value</span><span class="op" id="4479021">)</span>&nbsp;<span class="op" id="4479023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4479026">b</span>&nbsp;<span class="op" id="4479028">:=</span>&nbsp;<span class="ident" id="4479031">v</span><span class="op" id="4479032">.</span><span class="ident" id="4479033">Bytes</span><span class="op" id="4479038">(</span><span class="op" id="4479039">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4479042">if</span>&nbsp;<span class="builtinfunc" id="4479045">len</span><span class="op" id="4479048">(</span><span class="ident" id="4479049">b</span><span class="op" id="4479050">)</span>&nbsp;<span class="op" id="4479052">&gt;</span>&nbsp;<span class="num" id="4479054">0</span>&nbsp;<span class="op" id="4479056">||</span>&nbsp;<span class="ident" id="4479059">state</span><span class="op" id="4479064">.</span><span class="ident" id="4479065">sendZero</span>&nbsp;<span class="op" id="4479074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4479078">state</span><span class="op" id="4479083">.</span><span class="ident" id="4479084">update</span><span class="op" id="4479090">(</span><span class="ident" id="4479091">i</span><span class="op" id="4479092">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4479096">state</span><span class="op" id="4479101">.</span><span class="ident" id="4479102">encodeUint</span><span class="op" id="4479112">(</span><span class="ident" id="4479113">uint64</span><span class="op" id="4479119">(</span><span class="builtinfunc" id="4479120">len</span><span class="op" id="4479123">(</span><span class="ident" id="4479124">b</span><span class="op" id="4479125">)</span><span class="op" id="4479126">)</span><span class="op" id="4479127">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4479131">state</span><span class="op" id="4479136">.</span><span class="ident" id="4479137">b</span><span class="op" id="4479138">.</span><span class="ident" id="4479139">Write</span><span class="op" id="4479144">(</span><span class="ident" id="4479145">b</span><span class="op" id="4479146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4479149">}</span><br>
<span class="lineno">240</span><span class="op" id="4479151">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4479154">//&nbsp;encString&nbsp;encodes&nbsp;the&nbsp;string&nbsp;referenced&nbsp;by&nbsp;v.</span><br>
<span class="lineno"></span><span class="comment" id="4479203">//&nbsp;Strings&nbsp;are&nbsp;encoded&nbsp;as&nbsp;an&nbsp;unsigned&nbsp;count&nbsp;followed&nbsp;by&nbsp;the&nbsp;raw&nbsp;bytes.</span><br>
<span class="lineno"></span><span class="keyword" id="4479274">func</span>&nbsp;<span class="ident" id="4479279">encString</span><span class="op" id="4479288">(</span><span class="ident" id="4479289">i</span>&nbsp;<span class="op" id="4479291">*</span><span class="ident" id="4479292">encInstr</span><span class="op" id="4479300">,</span>&nbsp;<span class="ident" id="4479302">state</span>&nbsp;<span class="op" id="4479308">*</span><span class="ident" id="4479309">encoderState</span><span class="op" id="4479321">,</span>&nbsp;<span class="ident" id="4479323">v</span>&nbsp;<span class="ident" id="4479325">reflect</span><span class="op" id="4479332">.</span><span class="ident" id="4479333">Value</span><span class="op" id="4479338">)</span>&nbsp;<span class="op" id="4479340">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4479343">s</span>&nbsp;<span class="op" id="4479345">:=</span>&nbsp;<span class="ident" id="4479348">v</span><span class="op" id="4479349">.</span><span class="ident" id="4479350">String</span><span class="op" id="4479356">(</span><span class="op" id="4479357">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4479360">if</span>&nbsp;<span class="builtinfunc" id="4479363">len</span><span class="op" id="4479366">(</span><span class="ident" id="4479367">s</span><span class="op" id="4479368">)</span>&nbsp;<span class="op" id="4479370">&gt;</span>&nbsp;<span class="num" id="4479372">0</span>&nbsp;<span class="op" id="4479374">||</span>&nbsp;<span class="ident" id="4479377">state</span><span class="op" id="4479382">.</span><span class="ident" id="4479383">sendZero</span>&nbsp;<span class="op" id="4479392">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4479396">state</span><span class="op" id="4479401">.</span><span class="ident" id="4479402">update</span><span class="op" id="4479408">(</span><span class="ident" id="4479409">i</span><span class="op" id="4479410">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4479414">state</span><span class="op" id="4479419">.</span><span class="ident" id="4479420">encodeUint</span><span class="op" id="4479430">(</span><span class="ident" id="4479431">uint64</span><span class="op" id="4479437">(</span><span class="builtinfunc" id="4479438">len</span><span class="op" id="4479441">(</span><span class="ident" id="4479442">s</span><span class="op" id="4479443">)</span><span class="op" id="4479444">)</span><span class="op" id="4479445">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4479449">state</span><span class="op" id="4479454">.</span><span class="ident" id="4479455">b</span><span class="op" id="4479456">.</span><span class="ident" id="4479457">WriteString</span><span class="op" id="4479468">(</span><span class="ident" id="4479469">s</span><span class="op" id="4479470">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4479473">}</span><br>
<span class="lineno"></span><span class="op" id="4479475">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4479478">//&nbsp;encStructTerminator&nbsp;encodes&nbsp;the&nbsp;end&nbsp;of&nbsp;an&nbsp;encoded&nbsp;struct</span><br>
<span class="lineno"></span><span class="comment" id="4479538">//&nbsp;as&nbsp;delta&nbsp;field&nbsp;number&nbsp;of&nbsp;0.</span><br>
<span class="lineno">255</span><span class="keyword" id="4479569">func</span>&nbsp;<span class="ident" id="4479574">encStructTerminator</span><span class="op" id="4479593">(</span><span class="ident" id="4479594">i</span>&nbsp;<span class="op" id="4479596">*</span><span class="ident" id="4479597">encInstr</span><span class="op" id="4479605">,</span>&nbsp;<span class="ident" id="4479607">state</span>&nbsp;<span class="op" id="4479613">*</span><span class="ident" id="4479614">encoderState</span><span class="op" id="4479626">,</span>&nbsp;<span class="ident" id="4479628">v</span>&nbsp;<span class="ident" id="4479630">reflect</span><span class="op" id="4479637">.</span><span class="ident" id="4479638">Value</span><span class="op" id="4479643">)</span>&nbsp;<span class="op" id="4479645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4479648">state</span><span class="op" id="4479653">.</span><span class="ident" id="4479654">encodeUint</span><span class="op" id="4479664">(</span><span class="num" id="4479665">0</span><span class="op" id="4479666">)</span><br>
<span class="lineno"></span><span class="op" id="4479668">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4479671">//&nbsp;Execution&nbsp;engine</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span><span class="comment" id="4479692">//&nbsp;encEngine&nbsp;an&nbsp;array&nbsp;of&nbsp;instructions&nbsp;indexed&nbsp;by&nbsp;field&nbsp;number&nbsp;of&nbsp;the&nbsp;encoding</span><br>
<span class="lineno"></span><span class="comment" id="4479770">//&nbsp;data,&nbsp;typically&nbsp;a&nbsp;struct.&nbsp;&nbsp;It&nbsp;is&nbsp;executed&nbsp;top&nbsp;to&nbsp;bottom,&nbsp;walking&nbsp;the&nbsp;struct.</span><br>
<span class="lineno"></span><span class="keyword" id="4479850">type</span>&nbsp;<span class="ident" id="4479855">encEngine</span>&nbsp;<span class="keyword" id="4479865">struct</span>&nbsp;<span class="op" id="4479872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4479875">instr</span>&nbsp;<span class="op" id="4479881">[</span><span class="op" id="4479882">]</span><span class="ident" id="4479883">encInstr</span><br>
<span class="lineno">265</span><span class="op" id="4479892">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4479895">const</span>&nbsp;<span class="ident" id="4479901">singletonField</span>&nbsp;<span class="op" id="4479916">=</span>&nbsp;<span class="num" id="4479918">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4479921">//&nbsp;valid&nbsp;reports&nbsp;whether&nbsp;the&nbsp;value&nbsp;is&nbsp;valid&nbsp;and&nbsp;a&nbsp;non-nil&nbsp;pointer.</span><br>
<span class="lineno">270</span><span class="comment" id="4479988">//&nbsp;(Slices,&nbsp;maps,&nbsp;and&nbsp;chans&nbsp;take&nbsp;care&nbsp;of&nbsp;themselves.)</span><br>
<span class="lineno"></span><span class="keyword" id="4480042">func</span>&nbsp;<span class="ident" id="4480047">valid</span><span class="op" id="4480052">(</span><span class="ident" id="4480053">v</span>&nbsp;<span class="ident" id="4480055">reflect</span><span class="op" id="4480062">.</span><span class="ident" id="4480063">Value</span><span class="op" id="4480068">)</span>&nbsp;<span class="builtintype" id="4480070">bool</span>&nbsp;<span class="op" id="4480075">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4480078">switch</span>&nbsp;<span class="ident" id="4480085">v</span><span class="op" id="4480086">.</span><span class="ident" id="4480087">Kind</span><span class="op" id="4480091">(</span><span class="op" id="4480092">)</span>&nbsp;<span class="op" id="4480094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4480097">case</span>&nbsp;<span class="ident" id="4480102">reflect</span><span class="op" id="4480109">.</span><span class="ident" id="4480110">Invalid</span><span class="op" id="4480117">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4480121">return</span>&nbsp;<span class="builtintype" id="4480128">false</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4480135">case</span>&nbsp;<span class="ident" id="4480140">reflect</span><span class="op" id="4480147">.</span><span class="ident" id="4480148">Ptr</span><span class="op" id="4480151">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4480155">return</span>&nbsp;<span class="op" id="4480162">!</span><span class="ident" id="4480163">v</span><span class="op" id="4480164">.</span><span class="ident" id="4480165">IsNil</span><span class="op" id="4480170">(</span><span class="op" id="4480171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4480174">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4480177">return</span>&nbsp;<span class="builtintype" id="4480184">true</span><br>
<span class="lineno"></span><span class="op" id="4480189">}</span><br>
<span class="lineno">280</span><br>
<span class="lineno"></span><span class="comment" id="4480192">//&nbsp;encodeSingle&nbsp;encodes&nbsp;a&nbsp;single&nbsp;top-level&nbsp;non-struct&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="4480253">func</span>&nbsp;<span class="op" id="4480258">(</span><span class="ident" id="4480259">enc</span>&nbsp;<span class="op" id="4480263">*</span><span class="ident" id="4480264">Encoder</span><span class="op" id="4480271">)</span>&nbsp;<span class="ident" id="4480273">encodeSingle</span><span class="op" id="4480285">(</span><span class="ident" id="4480286">b</span>&nbsp;<span class="op" id="4480288">*</span><span class="ident" id="4480289">encBuffer</span><span class="op" id="4480298">,</span>&nbsp;<span class="ident" id="4480300">engine</span>&nbsp;<span class="op" id="4480307">*</span><span class="ident" id="4480308">encEngine</span><span class="op" id="4480317">,</span>&nbsp;<span class="ident" id="4480319">value</span>&nbsp;<span class="ident" id="4480325">reflect</span><span class="op" id="4480332">.</span><span class="ident" id="4480333">Value</span><span class="op" id="4480338">)</span>&nbsp;<span class="op" id="4480340">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4480343">state</span>&nbsp;<span class="op" id="4480349">:=</span>&nbsp;<span class="ident" id="4480352">enc</span><span class="op" id="4480355">.</span><span class="ident" id="4480356">newEncoderState</span><span class="op" id="4480371">(</span><span class="ident" id="4480372">b</span><span class="op" id="4480373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4480376">defer</span>&nbsp;<span class="ident" id="4480382">enc</span><span class="op" id="4480385">.</span><span class="ident" id="4480386">freeEncoderState</span><span class="op" id="4480402">(</span><span class="ident" id="4480403">state</span><span class="op" id="4480408">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4480411">state</span><span class="op" id="4480416">.</span><span class="ident" id="4480417">fieldnum</span>&nbsp;<span class="op" id="4480426">=</span>&nbsp;<span class="ident" id="4480428">singletonField</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4480444">//&nbsp;There&nbsp;is&nbsp;no&nbsp;surrounding&nbsp;struct&nbsp;to&nbsp;frame&nbsp;the&nbsp;transmission,&nbsp;so&nbsp;we&nbsp;must</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4480517">//&nbsp;generate&nbsp;data&nbsp;even&nbsp;if&nbsp;the&nbsp;item&nbsp;is&nbsp;zero.&nbsp;&nbsp;To&nbsp;do&nbsp;this,&nbsp;set&nbsp;sendZero.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4480588">state</span><span class="op" id="4480593">.</span><span class="ident" id="4480594">sendZero</span>&nbsp;<span class="op" id="4480603">=</span>&nbsp;<span class="builtintype" id="4480605">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4480611">instr</span>&nbsp;<span class="op" id="4480617">:=</span>&nbsp;<span class="op" id="4480620">&amp;</span><span class="ident" id="4480621">engine</span><span class="op" id="4480627">.</span><span class="ident" id="4480628">instr</span><span class="op" id="4480633">[</span><span class="ident" id="4480634">singletonField</span><span class="op" id="4480648">]</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4480651">if</span>&nbsp;<span class="ident" id="4480654">instr</span><span class="op" id="4480659">.</span><span class="ident" id="4480660">indir</span>&nbsp;<span class="op" id="4480666">&gt;</span>&nbsp;<span class="num" id="4480668">0</span>&nbsp;<span class="op" id="4480670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4480674">value</span>&nbsp;<span class="op" id="4480680">=</span>&nbsp;<span class="ident" id="4480682">encIndirect</span><span class="op" id="4480693">(</span><span class="ident" id="4480694">value</span><span class="op" id="4480699">,</span>&nbsp;<span class="ident" id="4480701">instr</span><span class="op" id="4480706">.</span><span class="ident" id="4480707">indir</span><span class="op" id="4480712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4480715">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4480718">if</span>&nbsp;<span class="ident" id="4480721">valid</span><span class="op" id="4480726">(</span><span class="ident" id="4480727">value</span><span class="op" id="4480732">)</span>&nbsp;<span class="op" id="4480734">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4480738">instr</span><span class="op" id="4480743">.</span><span class="ident" id="4480744">op</span><span class="op" id="4480746">(</span><span class="ident" id="4480747">instr</span><span class="op" id="4480752">,</span>&nbsp;<span class="ident" id="4480754">state</span><span class="op" id="4480759">,</span>&nbsp;<span class="ident" id="4480761">value</span><span class="op" id="4480766">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4480769">}</span><br>
<span class="lineno"></span><span class="op" id="4480771">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4480774">//&nbsp;encodeStruct&nbsp;encodes&nbsp;a&nbsp;single&nbsp;struct&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="4480821">func</span>&nbsp;<span class="op" id="4480826">(</span><span class="ident" id="4480827">enc</span>&nbsp;<span class="op" id="4480831">*</span><span class="ident" id="4480832">Encoder</span><span class="op" id="4480839">)</span>&nbsp;<span class="ident" id="4480841">encodeStruct</span><span class="op" id="4480853">(</span><span class="ident" id="4480854">b</span>&nbsp;<span class="op" id="4480856">*</span><span class="ident" id="4480857">encBuffer</span><span class="op" id="4480866">,</span>&nbsp;<span class="ident" id="4480868">engine</span>&nbsp;<span class="op" id="4480875">*</span><span class="ident" id="4480876">encEngine</span><span class="op" id="4480885">,</span>&nbsp;<span class="ident" id="4480887">value</span>&nbsp;<span class="ident" id="4480893">reflect</span><span class="op" id="4480900">.</span><span class="ident" id="4480901">Value</span><span class="op" id="4480906">)</span>&nbsp;<span class="op" id="4480908">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4480911">if</span>&nbsp;<span class="op" id="4480914">!</span><span class="ident" id="4480915">valid</span><span class="op" id="4480920">(</span><span class="ident" id="4480921">value</span><span class="op" id="4480926">)</span>&nbsp;<span class="op" id="4480928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4480932">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4480940">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4480943">state</span>&nbsp;<span class="op" id="4480949">:=</span>&nbsp;<span class="ident" id="4480952">enc</span><span class="op" id="4480955">.</span><span class="ident" id="4480956">newEncoderState</span><span class="op" id="4480971">(</span><span class="ident" id="4480972">b</span><span class="op" id="4480973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4480976">defer</span>&nbsp;<span class="ident" id="4480982">enc</span><span class="op" id="4480985">.</span><span class="ident" id="4480986">freeEncoderState</span><span class="op" id="4481002">(</span><span class="ident" id="4481003">state</span><span class="op" id="4481008">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4481011">state</span><span class="op" id="4481016">.</span><span class="ident" id="4481017">fieldnum</span>&nbsp;<span class="op" id="4481026">=</span>&nbsp;<span class="op" id="4481028">-</span><span class="num" id="4481029">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4481032">for</span>&nbsp;<span class="ident" id="4481036">i</span>&nbsp;<span class="op" id="4481038">:=</span>&nbsp;<span class="num" id="4481041">0</span><span class="op" id="4481042">;</span>&nbsp;<span class="ident" id="4481044">i</span>&nbsp;<span class="op" id="4481046">&lt;</span>&nbsp;<span class="builtinfunc" id="4481048">len</span><span class="op" id="4481051">(</span><span class="ident" id="4481052">engine</span><span class="op" id="4481058">.</span><span class="ident" id="4481059">instr</span><span class="op" id="4481064">)</span><span class="op" id="4481065">;</span>&nbsp;<span class="ident" id="4481067">i</span><span class="op" id="4481068">++</span>&nbsp;<span class="op" id="4481071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4481075">instr</span>&nbsp;<span class="op" id="4481081">:=</span>&nbsp;<span class="op" id="4481084">&amp;</span><span class="ident" id="4481085">engine</span><span class="op" id="4481091">.</span><span class="ident" id="4481092">instr</span><span class="op" id="4481097">[</span><span class="ident" id="4481098">i</span><span class="op" id="4481099">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4481103">if</span>&nbsp;<span class="ident" id="4481106">i</span>&nbsp;<span class="op" id="4481108">&gt;=</span>&nbsp;<span class="ident" id="4481111">value</span><span class="op" id="4481116">.</span><span class="ident" id="4481117">NumField</span><span class="op" id="4481125">(</span><span class="op" id="4481126">)</span>&nbsp;<span class="op" id="4481128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4481133">//&nbsp;encStructTerminator</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4481159">instr</span><span class="op" id="4481164">.</span><span class="ident" id="4481165">op</span><span class="op" id="4481167">(</span><span class="ident" id="4481168">instr</span><span class="op" id="4481173">,</span>&nbsp;<span class="ident" id="4481175">state</span><span class="op" id="4481180">,</span>&nbsp;<span class="ident" id="4481182">reflect</span><span class="op" id="4481189">.</span><span class="ident" id="4481190">Value</span><span class="op" id="4481195">{</span><span class="op" id="4481196">}</span><span class="op" id="4481197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4481202">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4481210">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4481214">field</span>&nbsp;<span class="op" id="4481220">:=</span>&nbsp;<span class="ident" id="4481223">value</span><span class="op" id="4481228">.</span><span class="ident" id="4481229">FieldByIndex</span><span class="op" id="4481241">(</span><span class="ident" id="4481242">instr</span><span class="op" id="4481247">.</span><span class="ident" id="4481248">index</span><span class="op" id="4481253">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4481257">if</span>&nbsp;<span class="ident" id="4481260">instr</span><span class="op" id="4481265">.</span><span class="ident" id="4481266">indir</span>&nbsp;<span class="op" id="4481272">&gt;</span>&nbsp;<span class="num" id="4481274">0</span>&nbsp;<span class="op" id="4481276">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4481281">field</span>&nbsp;<span class="op" id="4481287">=</span>&nbsp;<span class="ident" id="4481289">encIndirect</span><span class="op" id="4481300">(</span><span class="ident" id="4481301">field</span><span class="op" id="4481306">,</span>&nbsp;<span class="ident" id="4481308">instr</span><span class="op" id="4481313">.</span><span class="ident" id="4481314">indir</span><span class="op" id="4481319">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4481324">//&nbsp;TODO:&nbsp;Is&nbsp;field&nbsp;guaranteed&nbsp;valid?&nbsp;If&nbsp;so&nbsp;we&nbsp;could&nbsp;avoid&nbsp;this&nbsp;check.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4481396">if</span>&nbsp;<span class="op" id="4481399">!</span><span class="ident" id="4481400">valid</span><span class="op" id="4481405">(</span><span class="ident" id="4481406">field</span><span class="op" id="4481411">)</span>&nbsp;<span class="op" id="4481413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4481419">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4481431">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4481435">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4481439">instr</span><span class="op" id="4481444">.</span><span class="ident" id="4481445">op</span><span class="op" id="4481447">(</span><span class="ident" id="4481448">instr</span><span class="op" id="4481453">,</span>&nbsp;<span class="ident" id="4481455">state</span><span class="op" id="4481460">,</span>&nbsp;<span class="ident" id="4481462">field</span><span class="op" id="4481467">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4481470">}</span><br>
<span class="lineno"></span><span class="op" id="4481472">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">325</span><span class="comment" id="4481475">//&nbsp;encodeArray&nbsp;encodes&nbsp;an&nbsp;array.</span><br>
<span class="lineno"></span><span class="keyword" id="4481508">func</span>&nbsp;<span class="op" id="4481513">(</span><span class="ident" id="4481514">enc</span>&nbsp;<span class="op" id="4481518">*</span><span class="ident" id="4481519">Encoder</span><span class="op" id="4481526">)</span>&nbsp;<span class="ident" id="4481528">encodeArray</span><span class="op" id="4481539">(</span><span class="ident" id="4481540">b</span>&nbsp;<span class="op" id="4481542">*</span><span class="ident" id="4481543">encBuffer</span><span class="op" id="4481552">,</span>&nbsp;<span class="ident" id="4481554">value</span>&nbsp;<span class="ident" id="4481560">reflect</span><span class="op" id="4481567">.</span><span class="ident" id="4481568">Value</span><span class="op" id="4481573">,</span>&nbsp;<span class="ident" id="4481575">op</span>&nbsp;<span class="ident" id="4481578">encOp</span><span class="op" id="4481583">,</span>&nbsp;<span class="ident" id="4481585">elemIndir</span>&nbsp;<span class="builtintype" id="4481595">int</span><span class="op" id="4481598">,</span>&nbsp;<span class="ident" id="4481600">length</span>&nbsp;<span class="builtintype" id="4481607">int</span><span class="op" id="4481610">,</span>&nbsp;<span class="ident" id="4481612">helper</span>&nbsp;<span class="ident" id="4481619">encHelper</span><span class="op" id="4481628">)</span>&nbsp;<span class="op" id="4481630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4481633">state</span>&nbsp;<span class="op" id="4481639">:=</span>&nbsp;<span class="ident" id="4481642">enc</span><span class="op" id="4481645">.</span><span class="ident" id="4481646">newEncoderState</span><span class="op" id="4481661">(</span><span class="ident" id="4481662">b</span><span class="op" id="4481663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4481666">defer</span>&nbsp;<span class="ident" id="4481672">enc</span><span class="op" id="4481675">.</span><span class="ident" id="4481676">freeEncoderState</span><span class="op" id="4481692">(</span><span class="ident" id="4481693">state</span><span class="op" id="4481698">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4481701">state</span><span class="op" id="4481706">.</span><span class="ident" id="4481707">fieldnum</span>&nbsp;<span class="op" id="4481716">=</span>&nbsp;<span class="op" id="4481718">-</span><span class="num" id="4481719">1</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4481722">state</span><span class="op" id="4481727">.</span><span class="ident" id="4481728">sendZero</span>&nbsp;<span class="op" id="4481737">=</span>&nbsp;<span class="builtintype" id="4481739">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4481745">state</span><span class="op" id="4481750">.</span><span class="ident" id="4481751">encodeUint</span><span class="op" id="4481761">(</span><span class="ident" id="4481762">uint64</span><span class="op" id="4481768">(</span><span class="ident" id="4481769">length</span><span class="op" id="4481775">)</span><span class="op" id="4481776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4481779">if</span>&nbsp;<span class="ident" id="4481782">helper</span>&nbsp;<span class="op" id="4481789">!=</span>&nbsp;<span class="ident" id="4481792">nil</span>&nbsp;<span class="op" id="4481796">&amp;&amp;</span>&nbsp;<span class="ident" id="4481799">helper</span><span class="op" id="4481805">(</span><span class="ident" id="4481806">state</span><span class="op" id="4481811">,</span>&nbsp;<span class="ident" id="4481813">value</span><span class="op" id="4481818">)</span>&nbsp;<span class="op" id="4481820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4481824">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4481832">}</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4481835">for</span>&nbsp;<span class="ident" id="4481839">i</span>&nbsp;<span class="op" id="4481841">:=</span>&nbsp;<span class="num" id="4481844">0</span><span class="op" id="4481845">;</span>&nbsp;<span class="ident" id="4481847">i</span>&nbsp;<span class="op" id="4481849">&lt;</span>&nbsp;<span class="ident" id="4481851">length</span><span class="op" id="4481857">;</span>&nbsp;<span class="ident" id="4481859">i</span><span class="op" id="4481860">++</span>&nbsp;<span class="op" id="4481863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4481867">elem</span>&nbsp;<span class="op" id="4481872">:=</span>&nbsp;<span class="ident" id="4481875">value</span><span class="op" id="4481880">.</span><span class="ident" id="4481881">Index</span><span class="op" id="4481886">(</span><span class="ident" id="4481887">i</span><span class="op" id="4481888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4481892">if</span>&nbsp;<span class="ident" id="4481895">elemIndir</span>&nbsp;<span class="op" id="4481905">&gt;</span>&nbsp;<span class="num" id="4481907">0</span>&nbsp;<span class="op" id="4481909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4481914">elem</span>&nbsp;<span class="op" id="4481919">=</span>&nbsp;<span class="ident" id="4481921">encIndirect</span><span class="op" id="4481932">(</span><span class="ident" id="4481933">elem</span><span class="op" id="4481937">,</span>&nbsp;<span class="ident" id="4481939">elemIndir</span><span class="op" id="4481948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4481953">//&nbsp;TODO:&nbsp;Is&nbsp;elem&nbsp;guaranteed&nbsp;valid?&nbsp;If&nbsp;so&nbsp;we&nbsp;could&nbsp;avoid&nbsp;this&nbsp;check.</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4482024">if</span>&nbsp;<span class="op" id="4482027">!</span><span class="ident" id="4482028">valid</span><span class="op" id="4482033">(</span><span class="ident" id="4482034">elem</span><span class="op" id="4482038">)</span>&nbsp;<span class="op" id="4482040">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4482046">errorf</span><span class="op" id="4482052">(</span><span class="string" id="4482053">&#34;encodeArray:&nbsp;nil&nbsp;element&#34;</span><span class="op" id="4482079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4482084">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4482088">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4482092">op</span><span class="op" id="4482094">(</span><span class="ident" id="4482095">nil</span><span class="op" id="4482098">,</span>&nbsp;<span class="ident" id="4482100">state</span><span class="op" id="4482105">,</span>&nbsp;<span class="ident" id="4482107">elem</span><span class="op" id="4482111">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4482114">}</span><br>
<span class="lineno"></span><span class="op" id="4482116">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4482119">//&nbsp;encodeReflectValue&nbsp;is&nbsp;a&nbsp;helper&nbsp;for&nbsp;maps.&nbsp;It&nbsp;encodes&nbsp;the&nbsp;value&nbsp;v.</span><br>
<span class="lineno"></span><span class="keyword" id="4482187">func</span>&nbsp;<span class="ident" id="4482192">encodeReflectValue</span><span class="op" id="4482210">(</span><span class="ident" id="4482211">state</span>&nbsp;<span class="op" id="4482217">*</span><span class="ident" id="4482218">encoderState</span><span class="op" id="4482230">,</span>&nbsp;<span class="ident" id="4482232">v</span>&nbsp;<span class="ident" id="4482234">reflect</span><span class="op" id="4482241">.</span><span class="ident" id="4482242">Value</span><span class="op" id="4482247">,</span>&nbsp;<span class="ident" id="4482249">op</span>&nbsp;<span class="ident" id="4482252">encOp</span><span class="op" id="4482257">,</span>&nbsp;<span class="ident" id="4482259">indir</span>&nbsp;<span class="builtintype" id="4482265">int</span><span class="op" id="4482268">)</span>&nbsp;<span class="op" id="4482270">{</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4482273">for</span>&nbsp;<span class="ident" id="4482277">i</span>&nbsp;<span class="op" id="4482279">:=</span>&nbsp;<span class="num" id="4482282">0</span><span class="op" id="4482283">;</span>&nbsp;<span class="ident" id="4482285">i</span>&nbsp;<span class="op" id="4482287">&lt;</span>&nbsp;<span class="ident" id="4482289">indir</span>&nbsp;<span class="op" id="4482295">&amp;&amp;</span>&nbsp;<span class="ident" id="4482298">v</span><span class="op" id="4482299">.</span><span class="ident" id="4482300">IsValid</span><span class="op" id="4482307">(</span><span class="op" id="4482308">)</span><span class="op" id="4482309">;</span>&nbsp;<span class="ident" id="4482311">i</span><span class="op" id="4482312">++</span>&nbsp;<span class="op" id="4482315">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4482319">v</span>&nbsp;<span class="op" id="4482321">=</span>&nbsp;<span class="ident" id="4482323">reflect</span><span class="op" id="4482330">.</span><span class="ident" id="4482331">Indirect</span><span class="op" id="4482339">(</span><span class="ident" id="4482340">v</span><span class="op" id="4482341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4482344">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4482347">if</span>&nbsp;<span class="op" id="4482350">!</span><span class="ident" id="4482351">v</span><span class="op" id="4482352">.</span><span class="ident" id="4482353">IsValid</span><span class="op" id="4482360">(</span><span class="op" id="4482361">)</span>&nbsp;<span class="op" id="4482363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4482367">errorf</span><span class="op" id="4482373">(</span><span class="string" id="4482374">&#34;encodeReflectValue:&nbsp;nil&nbsp;element&#34;</span><span class="op" id="4482407">)</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4482410">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4482413">op</span><span class="op" id="4482415">(</span><span class="ident" id="4482416">nil</span><span class="op" id="4482419">,</span>&nbsp;<span class="ident" id="4482421">state</span><span class="op" id="4482426">,</span>&nbsp;<span class="ident" id="4482428">v</span><span class="op" id="4482429">)</span><br>
<span class="lineno"></span><span class="op" id="4482431">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4482434">//&nbsp;encodeMap&nbsp;encodes&nbsp;a&nbsp;map&nbsp;as&nbsp;unsigned&nbsp;count&nbsp;followed&nbsp;by&nbsp;key:value&nbsp;pairs.</span><br>
<span class="lineno">360</span><span class="keyword" id="4482508">func</span>&nbsp;<span class="op" id="4482513">(</span><span class="ident" id="4482514">enc</span>&nbsp;<span class="op" id="4482518">*</span><span class="ident" id="4482519">Encoder</span><span class="op" id="4482526">)</span>&nbsp;<span class="ident" id="4482528">encodeMap</span><span class="op" id="4482537">(</span><span class="ident" id="4482538">b</span>&nbsp;<span class="op" id="4482540">*</span><span class="ident" id="4482541">encBuffer</span><span class="op" id="4482550">,</span>&nbsp;<span class="ident" id="4482552">mv</span>&nbsp;<span class="ident" id="4482555">reflect</span><span class="op" id="4482562">.</span><span class="ident" id="4482563">Value</span><span class="op" id="4482568">,</span>&nbsp;<span class="ident" id="4482570">keyOp</span><span class="op" id="4482575">,</span>&nbsp;<span class="ident" id="4482577">elemOp</span>&nbsp;<span class="ident" id="4482584">encOp</span><span class="op" id="4482589">,</span>&nbsp;<span class="ident" id="4482591">keyIndir</span><span class="op" id="4482599">,</span>&nbsp;<span class="ident" id="4482601">elemIndir</span>&nbsp;<span class="builtintype" id="4482611">int</span><span class="op" id="4482614">)</span>&nbsp;<span class="op" id="4482616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4482619">state</span>&nbsp;<span class="op" id="4482625">:=</span>&nbsp;<span class="ident" id="4482628">enc</span><span class="op" id="4482631">.</span><span class="ident" id="4482632">newEncoderState</span><span class="op" id="4482647">(</span><span class="ident" id="4482648">b</span><span class="op" id="4482649">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4482652">state</span><span class="op" id="4482657">.</span><span class="ident" id="4482658">fieldnum</span>&nbsp;<span class="op" id="4482667">=</span>&nbsp;<span class="op" id="4482669">-</span><span class="num" id="4482670">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4482673">state</span><span class="op" id="4482678">.</span><span class="ident" id="4482679">sendZero</span>&nbsp;<span class="op" id="4482688">=</span>&nbsp;<span class="builtintype" id="4482690">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4482696">keys</span>&nbsp;<span class="op" id="4482701">:=</span>&nbsp;<span class="ident" id="4482704">mv</span><span class="op" id="4482706">.</span><span class="ident" id="4482707">MapKeys</span><span class="op" id="4482714">(</span><span class="op" id="4482715">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4482718">state</span><span class="op" id="4482723">.</span><span class="ident" id="4482724">encodeUint</span><span class="op" id="4482734">(</span><span class="ident" id="4482735">uint64</span><span class="op" id="4482741">(</span><span class="builtinfunc" id="4482742">len</span><span class="op" id="4482745">(</span><span class="ident" id="4482746">keys</span><span class="op" id="4482750">)</span><span class="op" id="4482751">)</span><span class="op" id="4482752">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4482755">for</span>&nbsp;<span class="ident" id="4482759">_</span><span class="op" id="4482760">,</span>&nbsp;<span class="ident" id="4482762">key</span>&nbsp;<span class="op" id="4482766">:=</span>&nbsp;<span class="keyword" id="4482769">range</span>&nbsp;<span class="ident" id="4482775">keys</span>&nbsp;<span class="op" id="4482780">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4482784">encodeReflectValue</span><span class="op" id="4482802">(</span><span class="ident" id="4482803">state</span><span class="op" id="4482808">,</span>&nbsp;<span class="ident" id="4482810">key</span><span class="op" id="4482813">,</span>&nbsp;<span class="ident" id="4482815">keyOp</span><span class="op" id="4482820">,</span>&nbsp;<span class="ident" id="4482822">keyIndir</span><span class="op" id="4482830">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4482834">encodeReflectValue</span><span class="op" id="4482852">(</span><span class="ident" id="4482853">state</span><span class="op" id="4482858">,</span>&nbsp;<span class="ident" id="4482860">mv</span><span class="op" id="4482862">.</span><span class="ident" id="4482863">MapIndex</span><span class="op" id="4482871">(</span><span class="ident" id="4482872">key</span><span class="op" id="4482875">)</span><span class="op" id="4482876">,</span>&nbsp;<span class="ident" id="4482878">elemOp</span><span class="op" id="4482884">,</span>&nbsp;<span class="ident" id="4482886">elemIndir</span><span class="op" id="4482895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4482898">}</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4482901">enc</span><span class="op" id="4482904">.</span><span class="ident" id="4482905">freeEncoderState</span><span class="op" id="4482921">(</span><span class="ident" id="4482922">state</span><span class="op" id="4482927">)</span><br>
<span class="lineno"></span><span class="op" id="4482929">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4482932">//&nbsp;encodeInterface&nbsp;encodes&nbsp;the&nbsp;interface&nbsp;value&nbsp;iv.</span><br>
<span class="lineno"></span><span class="comment" id="4482983">//&nbsp;To&nbsp;send&nbsp;an&nbsp;interface,&nbsp;we&nbsp;send&nbsp;a&nbsp;string&nbsp;identifying&nbsp;the&nbsp;concrete&nbsp;type,&nbsp;followed</span><br>
<span class="lineno">375</span><span class="comment" id="4483065">//&nbsp;by&nbsp;the&nbsp;type&nbsp;identifier&nbsp;(which&nbsp;might&nbsp;require&nbsp;defining&nbsp;that&nbsp;type&nbsp;right&nbsp;now),&nbsp;followed</span><br>
<span class="lineno"></span><span class="comment" id="4483152">//&nbsp;by&nbsp;the&nbsp;concrete&nbsp;value.&nbsp;&nbsp;A&nbsp;nil&nbsp;value&nbsp;gets&nbsp;sent&nbsp;as&nbsp;the&nbsp;empty&nbsp;string&nbsp;for&nbsp;the&nbsp;name,</span><br>
<span class="lineno"></span><span class="comment" id="4483235">//&nbsp;followed&nbsp;by&nbsp;no&nbsp;value.</span><br>
<span class="lineno"></span><span class="keyword" id="4483260">func</span>&nbsp;<span class="op" id="4483265">(</span><span class="ident" id="4483266">enc</span>&nbsp;<span class="op" id="4483270">*</span><span class="ident" id="4483271">Encoder</span><span class="op" id="4483278">)</span>&nbsp;<span class="ident" id="4483280">encodeInterface</span><span class="op" id="4483295">(</span><span class="ident" id="4483296">b</span>&nbsp;<span class="op" id="4483298">*</span><span class="ident" id="4483299">encBuffer</span><span class="op" id="4483308">,</span>&nbsp;<span class="ident" id="4483310">iv</span>&nbsp;<span class="ident" id="4483313">reflect</span><span class="op" id="4483320">.</span><span class="ident" id="4483321">Value</span><span class="op" id="4483326">)</span>&nbsp;<span class="op" id="4483328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4483331">//&nbsp;Gobs&nbsp;can&nbsp;encode&nbsp;nil&nbsp;interface&nbsp;values&nbsp;but&nbsp;not&nbsp;typed&nbsp;interface</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4483396">//&nbsp;values&nbsp;holding&nbsp;nil&nbsp;pointers,&nbsp;since&nbsp;nil&nbsp;pointers&nbsp;point&nbsp;to&nbsp;no&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4483467">elem</span>&nbsp;<span class="op" id="4483472">:=</span>&nbsp;<span class="ident" id="4483475">iv</span><span class="op" id="4483477">.</span><span class="ident" id="4483478">Elem</span><span class="op" id="4483482">(</span><span class="op" id="4483483">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4483486">if</span>&nbsp;<span class="ident" id="4483489">elem</span><span class="op" id="4483493">.</span><span class="ident" id="4483494">Kind</span><span class="op" id="4483498">(</span><span class="op" id="4483499">)</span>&nbsp;<span class="op" id="4483501">==</span>&nbsp;<span class="ident" id="4483504">reflect</span><span class="op" id="4483511">.</span><span class="ident" id="4483512">Ptr</span>&nbsp;<span class="op" id="4483516">&amp;&amp;</span>&nbsp;<span class="ident" id="4483519">elem</span><span class="op" id="4483523">.</span><span class="ident" id="4483524">IsNil</span><span class="op" id="4483529">(</span><span class="op" id="4483530">)</span>&nbsp;<span class="op" id="4483532">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4483536">errorf</span><span class="op" id="4483542">(</span><span class="string" id="4483543">&#34;gob:&nbsp;cannot&nbsp;encode&nbsp;nil&nbsp;pointer&nbsp;of&nbsp;type&nbsp;%s&nbsp;inside&nbsp;interface&#34;</span><span class="op" id="4483603">,</span>&nbsp;<span class="ident" id="4483605">iv</span><span class="op" id="4483607">.</span><span class="ident" id="4483608">Elem</span><span class="op" id="4483612">(</span><span class="op" id="4483613">)</span><span class="op" id="4483614">.</span><span class="ident" id="4483615">Type</span><span class="op" id="4483619">(</span><span class="op" id="4483620">)</span><span class="op" id="4483621">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4483624">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4483627">state</span>&nbsp;<span class="op" id="4483633">:=</span>&nbsp;<span class="ident" id="4483636">enc</span><span class="op" id="4483639">.</span><span class="ident" id="4483640">newEncoderState</span><span class="op" id="4483655">(</span><span class="ident" id="4483656">b</span><span class="op" id="4483657">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4483660">state</span><span class="op" id="4483665">.</span><span class="ident" id="4483666">fieldnum</span>&nbsp;<span class="op" id="4483675">=</span>&nbsp;<span class="op" id="4483677">-</span><span class="num" id="4483678">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4483681">state</span><span class="op" id="4483686">.</span><span class="ident" id="4483687">sendZero</span>&nbsp;<span class="op" id="4483696">=</span>&nbsp;<span class="builtintype" id="4483698">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4483704">if</span>&nbsp;<span class="ident" id="4483707">iv</span><span class="op" id="4483709">.</span><span class="ident" id="4483710">IsNil</span><span class="op" id="4483715">(</span><span class="op" id="4483716">)</span>&nbsp;<span class="op" id="4483718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4483722">state</span><span class="op" id="4483727">.</span><span class="ident" id="4483728">encodeUint</span><span class="op" id="4483738">(</span><span class="num" id="4483739">0</span><span class="op" id="4483740">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4483744">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4483752">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4483756">ut</span>&nbsp;<span class="op" id="4483759">:=</span>&nbsp;<span class="ident" id="4483762">userType</span><span class="op" id="4483770">(</span><span class="ident" id="4483771">iv</span><span class="op" id="4483773">.</span><span class="ident" id="4483774">Elem</span><span class="op" id="4483778">(</span><span class="op" id="4483779">)</span><span class="op" id="4483780">.</span><span class="ident" id="4483781">Type</span><span class="op" id="4483785">(</span><span class="op" id="4483786">)</span><span class="op" id="4483787">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4483790">registerLock</span><span class="op" id="4483802">.</span><span class="ident" id="4483803">RLock</span><span class="op" id="4483808">(</span><span class="op" id="4483809">)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4483812">name</span><span class="op" id="4483816">,</span>&nbsp;<span class="ident" id="4483818">ok</span>&nbsp;<span class="op" id="4483821">:=</span>&nbsp;<span class="ident" id="4483824">concreteTypeToName</span><span class="op" id="4483842">[</span><span class="ident" id="4483843">ut</span><span class="op" id="4483845">.</span><span class="ident" id="4483846">base</span><span class="op" id="4483850">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4483853">registerLock</span><span class="op" id="4483865">.</span><span class="ident" id="4483866">RUnlock</span><span class="op" id="4483873">(</span><span class="op" id="4483874">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4483877">if</span>&nbsp;<span class="op" id="4483880">!</span><span class="ident" id="4483881">ok</span>&nbsp;<span class="op" id="4483884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4483888">errorf</span><span class="op" id="4483894">(</span><span class="string" id="4483895">&#34;type&nbsp;not&nbsp;registered&nbsp;for&nbsp;interface:&nbsp;%s&#34;</span><span class="op" id="4483934">,</span>&nbsp;<span class="ident" id="4483936">ut</span><span class="op" id="4483938">.</span><span class="ident" id="4483939">base</span><span class="op" id="4483943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4483946">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4483949">//&nbsp;Send&nbsp;the&nbsp;name.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4483968">state</span><span class="op" id="4483973">.</span><span class="ident" id="4483974">encodeUint</span><span class="op" id="4483984">(</span><span class="ident" id="4483985">uint64</span><span class="op" id="4483991">(</span><span class="builtinfunc" id="4483992">len</span><span class="op" id="4483995">(</span><span class="ident" id="4483996">name</span><span class="op" id="4484000">)</span><span class="op" id="4484001">)</span><span class="op" id="4484002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4484005">state</span><span class="op" id="4484010">.</span><span class="ident" id="4484011">b</span><span class="op" id="4484012">.</span><span class="ident" id="4484013">WriteString</span><span class="op" id="4484024">(</span><span class="ident" id="4484025">name</span><span class="op" id="4484029">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4484032">//&nbsp;Define&nbsp;the&nbsp;type&nbsp;id&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4484069">enc</span><span class="op" id="4484072">.</span><span class="ident" id="4484073">sendTypeDescriptor</span><span class="op" id="4484091">(</span><span class="ident" id="4484092">enc</span><span class="op" id="4484095">.</span><span class="ident" id="4484096">writer</span><span class="op" id="4484102">(</span><span class="op" id="4484103">)</span><span class="op" id="4484104">,</span>&nbsp;<span class="ident" id="4484106">state</span><span class="op" id="4484111">,</span>&nbsp;<span class="ident" id="4484113">ut</span><span class="op" id="4484115">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4484118">//&nbsp;Send&nbsp;the&nbsp;type&nbsp;id.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4484140">enc</span><span class="op" id="4484143">.</span><span class="ident" id="4484144">sendTypeId</span><span class="op" id="4484154">(</span><span class="ident" id="4484155">state</span><span class="op" id="4484160">,</span>&nbsp;<span class="ident" id="4484162">ut</span><span class="op" id="4484164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4484167">//&nbsp;Encode&nbsp;the&nbsp;value&nbsp;into&nbsp;a&nbsp;new&nbsp;buffer.&nbsp;&nbsp;Any&nbsp;nested&nbsp;type&nbsp;definitions</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4484236">//&nbsp;should&nbsp;be&nbsp;written&nbsp;to&nbsp;b,&nbsp;before&nbsp;the&nbsp;encoded&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4484290">enc</span><span class="op" id="4484293">.</span><span class="ident" id="4484294">pushWriter</span><span class="op" id="4484304">(</span><span class="ident" id="4484305">b</span><span class="op" id="4484306">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4484309">data</span>&nbsp;<span class="op" id="4484314">:=</span>&nbsp;<span class="builtinfunc" id="4484317">new</span><span class="op" id="4484320">(</span><span class="ident" id="4484321">encBuffer</span><span class="op" id="4484330">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4484333">data</span><span class="op" id="4484337">.</span><span class="ident" id="4484338">Write</span><span class="op" id="4484343">(</span><span class="ident" id="4484344">spaceForLength</span><span class="op" id="4484358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4484361">enc</span><span class="op" id="4484364">.</span><span class="ident" id="4484365">encode</span><span class="op" id="4484371">(</span><span class="ident" id="4484372">data</span><span class="op" id="4484376">,</span>&nbsp;<span class="ident" id="4484378">elem</span><span class="op" id="4484382">,</span>&nbsp;<span class="ident" id="4484384">ut</span><span class="op" id="4484386">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4484389">if</span>&nbsp;<span class="ident" id="4484392">enc</span><span class="op" id="4484395">.</span><span class="ident" id="4484396">err</span>&nbsp;<span class="op" id="4484400">!=</span>&nbsp;<span class="ident" id="4484403">nil</span>&nbsp;<span class="op" id="4484407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4484411">error_</span><span class="op" id="4484417">(</span><span class="ident" id="4484418">enc</span><span class="op" id="4484421">.</span><span class="ident" id="4484422">err</span><span class="op" id="4484425">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4484428">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4484431">enc</span><span class="op" id="4484434">.</span><span class="ident" id="4484435">popWriter</span><span class="op" id="4484444">(</span><span class="op" id="4484445">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4484448">enc</span><span class="op" id="4484451">.</span><span class="ident" id="4484452">writeMessage</span><span class="op" id="4484464">(</span><span class="ident" id="4484465">b</span><span class="op" id="4484466">,</span>&nbsp;<span class="ident" id="4484468">data</span><span class="op" id="4484472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4484475">if</span>&nbsp;<span class="ident" id="4484478">enc</span><span class="op" id="4484481">.</span><span class="ident" id="4484482">err</span>&nbsp;<span class="op" id="4484486">!=</span>&nbsp;<span class="ident" id="4484489">nil</span>&nbsp;<span class="op" id="4484493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4484497">error_</span><span class="op" id="4484503">(</span><span class="ident" id="4484504">enc</span><span class="op" id="4484507">.</span><span class="ident" id="4484508">err</span><span class="op" id="4484511">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4484514">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4484517">enc</span><span class="op" id="4484520">.</span><span class="ident" id="4484521">freeEncoderState</span><span class="op" id="4484537">(</span><span class="ident" id="4484538">state</span><span class="op" id="4484543">)</span><br>
<span class="lineno"></span><span class="op" id="4484545">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4484548">//&nbsp;isZero&nbsp;reports&nbsp;whether&nbsp;the&nbsp;value&nbsp;is&nbsp;the&nbsp;zero&nbsp;of&nbsp;its&nbsp;type.</span><br>
<span class="lineno">425</span><span class="keyword" id="4484609">func</span>&nbsp;<span class="ident" id="4484614">isZero</span><span class="op" id="4484620">(</span><span class="ident" id="4484621">val</span>&nbsp;<span class="ident" id="4484625">reflect</span><span class="op" id="4484632">.</span><span class="ident" id="4484633">Value</span><span class="op" id="4484638">)</span>&nbsp;<span class="builtintype" id="4484640">bool</span>&nbsp;<span class="op" id="4484645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4484648">switch</span>&nbsp;<span class="ident" id="4484655">val</span><span class="op" id="4484658">.</span><span class="ident" id="4484659">Kind</span><span class="op" id="4484663">(</span><span class="op" id="4484664">)</span>&nbsp;<span class="op" id="4484666">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4484669">case</span>&nbsp;<span class="ident" id="4484674">reflect</span><span class="op" id="4484681">.</span><span class="ident" id="4484682">Array</span><span class="op" id="4484687">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4484691">for</span>&nbsp;<span class="ident" id="4484695">i</span>&nbsp;<span class="op" id="4484697">:=</span>&nbsp;<span class="num" id="4484700">0</span><span class="op" id="4484701">;</span>&nbsp;<span class="ident" id="4484703">i</span>&nbsp;<span class="op" id="4484705">&lt;</span>&nbsp;<span class="ident" id="4484707">val</span><span class="op" id="4484710">.</span><span class="ident" id="4484711">Len</span><span class="op" id="4484714">(</span><span class="op" id="4484715">)</span><span class="op" id="4484716">;</span>&nbsp;<span class="ident" id="4484718">i</span><span class="op" id="4484719">++</span>&nbsp;<span class="op" id="4484722">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4484727">if</span>&nbsp;<span class="op" id="4484730">!</span><span class="ident" id="4484731">isZero</span><span class="op" id="4484737">(</span><span class="ident" id="4484738">val</span><span class="op" id="4484741">.</span><span class="ident" id="4484742">Index</span><span class="op" id="4484747">(</span><span class="ident" id="4484748">i</span><span class="op" id="4484749">)</span><span class="op" id="4484750">)</span>&nbsp;<span class="op" id="4484752">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4484758">return</span>&nbsp;<span class="builtintype" id="4484765">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4484774">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4484778">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4484782">return</span>&nbsp;<span class="builtintype" id="4484789">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4484795">case</span>&nbsp;<span class="ident" id="4484800">reflect</span><span class="op" id="4484807">.</span><span class="ident" id="4484808">Map</span><span class="op" id="4484811">,</span>&nbsp;<span class="ident" id="4484813">reflect</span><span class="op" id="4484820">.</span><span class="ident" id="4484821">Slice</span><span class="op" id="4484826">,</span>&nbsp;<span class="ident" id="4484828">reflect</span><span class="op" id="4484835">.</span><span class="ident" id="4484836">String</span><span class="op" id="4484842">:</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4484846">return</span>&nbsp;<span class="ident" id="4484853">val</span><span class="op" id="4484856">.</span><span class="ident" id="4484857">Len</span><span class="op" id="4484860">(</span><span class="op" id="4484861">)</span>&nbsp;<span class="op" id="4484863">==</span>&nbsp;<span class="num" id="4484866">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4484869">case</span>&nbsp;<span class="ident" id="4484874">reflect</span><span class="op" id="4484881">.</span><span class="ident" id="4484882">Bool</span><span class="op" id="4484886">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4484890">return</span>&nbsp;<span class="op" id="4484897">!</span><span class="ident" id="4484898">val</span><span class="op" id="4484901">.</span><span class="ident" id="4484902">Bool</span><span class="op" id="4484906">(</span><span class="op" id="4484907">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4484910">case</span>&nbsp;<span class="ident" id="4484915">reflect</span><span class="op" id="4484922">.</span><span class="ident" id="4484923">Complex64</span><span class="op" id="4484932">,</span>&nbsp;<span class="ident" id="4484934">reflect</span><span class="op" id="4484941">.</span><span class="ident" id="4484942">Complex128</span><span class="op" id="4484952">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4484956">return</span>&nbsp;<span class="ident" id="4484963">val</span><span class="op" id="4484966">.</span><span class="ident" id="4484967">Complex</span><span class="op" id="4484974">(</span><span class="op" id="4484975">)</span>&nbsp;<span class="op" id="4484977">==</span>&nbsp;<span class="num" id="4484980">0</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4484983">case</span>&nbsp;<span class="ident" id="4484988">reflect</span><span class="op" id="4484995">.</span><span class="ident" id="4484996">Chan</span><span class="op" id="4485000">,</span>&nbsp;<span class="ident" id="4485002">reflect</span><span class="op" id="4485009">.</span><span class="ident" id="4485010">Func</span><span class="op" id="4485014">,</span>&nbsp;<span class="ident" id="4485016">reflect</span><span class="op" id="4485023">.</span><span class="ident" id="4485024">Interface</span><span class="op" id="4485033">,</span>&nbsp;<span class="ident" id="4485035">reflect</span><span class="op" id="4485042">.</span><span class="ident" id="4485043">Ptr</span><span class="op" id="4485046">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4485050">return</span>&nbsp;<span class="ident" id="4485057">val</span><span class="op" id="4485060">.</span><span class="ident" id="4485061">IsNil</span><span class="op" id="4485066">(</span><span class="op" id="4485067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4485070">case</span>&nbsp;<span class="ident" id="4485075">reflect</span><span class="op" id="4485082">.</span><span class="ident" id="4485083">Int</span><span class="op" id="4485086">,</span>&nbsp;<span class="ident" id="4485088">reflect</span><span class="op" id="4485095">.</span><span class="ident" id="4485096">Int8</span><span class="op" id="4485100">,</span>&nbsp;<span class="ident" id="4485102">reflect</span><span class="op" id="4485109">.</span><span class="ident" id="4485110">Int16</span><span class="op" id="4485115">,</span>&nbsp;<span class="ident" id="4485117">reflect</span><span class="op" id="4485124">.</span><span class="ident" id="4485125">Int32</span><span class="op" id="4485130">,</span>&nbsp;<span class="ident" id="4485132">reflect</span><span class="op" id="4485139">.</span><span class="ident" id="4485140">Int64</span><span class="op" id="4485145">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4485149">return</span>&nbsp;<span class="ident" id="4485156">val</span><span class="op" id="4485159">.</span><span class="ident" id="4485160">Int</span><span class="op" id="4485163">(</span><span class="op" id="4485164">)</span>&nbsp;<span class="op" id="4485166">==</span>&nbsp;<span class="num" id="4485169">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4485172">case</span>&nbsp;<span class="ident" id="4485177">reflect</span><span class="op" id="4485184">.</span><span class="ident" id="4485185">Float32</span><span class="op" id="4485192">,</span>&nbsp;<span class="ident" id="4485194">reflect</span><span class="op" id="4485201">.</span><span class="ident" id="4485202">Float64</span><span class="op" id="4485209">:</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4485213">return</span>&nbsp;<span class="ident" id="4485220">val</span><span class="op" id="4485223">.</span><span class="ident" id="4485224">Float</span><span class="op" id="4485229">(</span><span class="op" id="4485230">)</span>&nbsp;<span class="op" id="4485232">==</span>&nbsp;<span class="num" id="4485235">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4485238">case</span>&nbsp;<span class="ident" id="4485243">reflect</span><span class="op" id="4485250">.</span><span class="ident" id="4485251">Uint</span><span class="op" id="4485255">,</span>&nbsp;<span class="ident" id="4485257">reflect</span><span class="op" id="4485264">.</span><span class="ident" id="4485265">Uint8</span><span class="op" id="4485270">,</span>&nbsp;<span class="ident" id="4485272">reflect</span><span class="op" id="4485279">.</span><span class="ident" id="4485280">Uint16</span><span class="op" id="4485286">,</span>&nbsp;<span class="ident" id="4485288">reflect</span><span class="op" id="4485295">.</span><span class="ident" id="4485296">Uint32</span><span class="op" id="4485302">,</span>&nbsp;<span class="ident" id="4485304">reflect</span><span class="op" id="4485311">.</span><span class="ident" id="4485312">Uint64</span><span class="op" id="4485318">,</span>&nbsp;<span class="ident" id="4485320">reflect</span><span class="op" id="4485327">.</span><span class="ident" id="4485328">Uintptr</span><span class="op" id="4485335">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4485339">return</span>&nbsp;<span class="ident" id="4485346">val</span><span class="op" id="4485349">.</span><span class="ident" id="4485350">Uint</span><span class="op" id="4485354">(</span><span class="op" id="4485355">)</span>&nbsp;<span class="op" id="4485357">==</span>&nbsp;<span class="num" id="4485360">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4485363">case</span>&nbsp;<span class="ident" id="4485368">reflect</span><span class="op" id="4485375">.</span><span class="ident" id="4485376">Struct</span><span class="op" id="4485382">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4485386">for</span>&nbsp;<span class="ident" id="4485390">i</span>&nbsp;<span class="op" id="4485392">:=</span>&nbsp;<span class="num" id="4485395">0</span><span class="op" id="4485396">;</span>&nbsp;<span class="ident" id="4485398">i</span>&nbsp;<span class="op" id="4485400">&lt;</span>&nbsp;<span class="ident" id="4485402">val</span><span class="op" id="4485405">.</span><span class="ident" id="4485406">NumField</span><span class="op" id="4485414">(</span><span class="op" id="4485415">)</span><span class="op" id="4485416">;</span>&nbsp;<span class="ident" id="4485418">i</span><span class="op" id="4485419">++</span>&nbsp;<span class="op" id="4485422">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4485427">if</span>&nbsp;<span class="op" id="4485430">!</span><span class="ident" id="4485431">isZero</span><span class="op" id="4485437">(</span><span class="ident" id="4485438">val</span><span class="op" id="4485441">.</span><span class="ident" id="4485442">Field</span><span class="op" id="4485447">(</span><span class="ident" id="4485448">i</span><span class="op" id="4485449">)</span><span class="op" id="4485450">)</span>&nbsp;<span class="op" id="4485452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4485458">return</span>&nbsp;<span class="builtintype" id="4485465">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4485474">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4485478">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4485482">return</span>&nbsp;<span class="builtintype" id="4485489">true</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4485495">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4485498">panic</span><span class="op" id="4485503">(</span><span class="string" id="4485504">&#34;unknown&nbsp;type&nbsp;in&nbsp;isZero&nbsp;&#34;</span>&nbsp;<span class="op" id="4485530">+</span>&nbsp;<span class="ident" id="4485532">val</span><span class="op" id="4485535">.</span><span class="ident" id="4485536">Type</span><span class="op" id="4485540">(</span><span class="op" id="4485541">)</span><span class="op" id="4485542">.</span><span class="ident" id="4485543">String</span><span class="op" id="4485549">(</span><span class="op" id="4485550">)</span><span class="op" id="4485551">)</span><br>
<span class="lineno"></span><span class="op" id="4485553">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4485556">//&nbsp;encGobEncoder&nbsp;encodes&nbsp;a&nbsp;value&nbsp;that&nbsp;implements&nbsp;the&nbsp;GobEncoder&nbsp;interface.</span><br>
<span class="lineno">460</span><span class="comment" id="4485631">//&nbsp;The&nbsp;data&nbsp;is&nbsp;sent&nbsp;as&nbsp;a&nbsp;byte&nbsp;array.</span><br>
<span class="lineno"></span><span class="keyword" id="4485668">func</span>&nbsp;<span class="op" id="4485673">(</span><span class="ident" id="4485674">enc</span>&nbsp;<span class="op" id="4485678">*</span><span class="ident" id="4485679">Encoder</span><span class="op" id="4485686">)</span>&nbsp;<span class="ident" id="4485688">encodeGobEncoder</span><span class="op" id="4485704">(</span><span class="ident" id="4485705">b</span>&nbsp;<span class="op" id="4485707">*</span><span class="ident" id="4485708">encBuffer</span><span class="op" id="4485717">,</span>&nbsp;<span class="ident" id="4485719">ut</span>&nbsp;<span class="op" id="4485722">*</span><span class="ident" id="4485723">userTypeInfo</span><span class="op" id="4485735">,</span>&nbsp;<span class="ident" id="4485737">v</span>&nbsp;<span class="ident" id="4485739">reflect</span><span class="op" id="4485746">.</span><span class="ident" id="4485747">Value</span><span class="op" id="4485752">)</span>&nbsp;<span class="op" id="4485754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4485757">//&nbsp;TODO:&nbsp;should&nbsp;we&nbsp;catch&nbsp;panics&nbsp;from&nbsp;the&nbsp;called&nbsp;method?</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4485815">var</span>&nbsp;<span class="ident" id="4485819">data</span>&nbsp;<span class="op" id="4485824">[</span><span class="op" id="4485825">]</span><span class="builtintype" id="4485826">byte</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4485832">var</span>&nbsp;<span class="ident" id="4485836">err</span>&nbsp;<span class="builtintype" id="4485840">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4485847">//&nbsp;We&nbsp;know&nbsp;it&#39;s&nbsp;one&nbsp;of&nbsp;these.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4485878">switch</span>&nbsp;<span class="ident" id="4485885">ut</span><span class="op" id="4485887">.</span><span class="ident" id="4485888">externalEnc</span>&nbsp;<span class="op" id="4485900">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4485903">case</span>&nbsp;<span class="ident" id="4485908">xGob</span><span class="op" id="4485912">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4485916">data</span><span class="op" id="4485920">,</span>&nbsp;<span class="ident" id="4485922">err</span>&nbsp;<span class="op" id="4485926">=</span>&nbsp;<span class="ident" id="4485928">v</span><span class="op" id="4485929">.</span><span class="ident" id="4485930">Interface</span><span class="op" id="4485939">(</span><span class="op" id="4485940">)</span><span class="op" id="4485941">.</span><span class="op" id="4485942">(</span><span class="ident" id="4485943">GobEncoder</span><span class="op" id="4485953">)</span><span class="op" id="4485954">.</span><span class="ident" id="4485955">GobEncode</span><span class="op" id="4485964">(</span><span class="op" id="4485965">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4485968">case</span>&nbsp;<span class="ident" id="4485973">xBinary</span><span class="op" id="4485980">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4485984">data</span><span class="op" id="4485988">,</span>&nbsp;<span class="ident" id="4485990">err</span>&nbsp;<span class="op" id="4485994">=</span>&nbsp;<span class="ident" id="4485996">v</span><span class="op" id="4485997">.</span><span class="ident" id="4485998">Interface</span><span class="op" id="4486007">(</span><span class="op" id="4486008">)</span><span class="op" id="4486009">.</span><span class="op" id="4486010">(</span><span class="ident" id="4486011">encoding</span><span class="op" id="4486019">.</span><span class="ident" id="4486020">BinaryMarshaler</span><span class="op" id="4486035">)</span><span class="op" id="4486036">.</span><span class="ident" id="4486037">MarshalBinary</span><span class="op" id="4486050">(</span><span class="op" id="4486051">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4486054">case</span>&nbsp;<span class="ident" id="4486059">xText</span><span class="op" id="4486064">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4486068">data</span><span class="op" id="4486072">,</span>&nbsp;<span class="ident" id="4486074">err</span>&nbsp;<span class="op" id="4486078">=</span>&nbsp;<span class="ident" id="4486080">v</span><span class="op" id="4486081">.</span><span class="ident" id="4486082">Interface</span><span class="op" id="4486091">(</span><span class="op" id="4486092">)</span><span class="op" id="4486093">.</span><span class="op" id="4486094">(</span><span class="ident" id="4486095">encoding</span><span class="op" id="4486103">.</span><span class="ident" id="4486104">TextMarshaler</span><span class="op" id="4486117">)</span><span class="op" id="4486118">.</span><span class="ident" id="4486119">MarshalText</span><span class="op" id="4486130">(</span><span class="op" id="4486131">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4486134">}</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4486137">if</span>&nbsp;<span class="ident" id="4486140">err</span>&nbsp;<span class="op" id="4486144">!=</span>&nbsp;<span class="ident" id="4486147">nil</span>&nbsp;<span class="op" id="4486151">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4486155">error_</span><span class="op" id="4486161">(</span><span class="ident" id="4486162">err</span><span class="op" id="4486165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4486168">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4486171">state</span>&nbsp;<span class="op" id="4486177">:=</span>&nbsp;<span class="ident" id="4486180">enc</span><span class="op" id="4486183">.</span><span class="ident" id="4486184">newEncoderState</span><span class="op" id="4486199">(</span><span class="ident" id="4486200">b</span><span class="op" id="4486201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4486204">state</span><span class="op" id="4486209">.</span><span class="ident" id="4486210">fieldnum</span>&nbsp;<span class="op" id="4486219">=</span>&nbsp;<span class="op" id="4486221">-</span><span class="num" id="4486222">1</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4486225">state</span><span class="op" id="4486230">.</span><span class="ident" id="4486231">encodeUint</span><span class="op" id="4486241">(</span><span class="ident" id="4486242">uint64</span><span class="op" id="4486248">(</span><span class="builtinfunc" id="4486249">len</span><span class="op" id="4486252">(</span><span class="ident" id="4486253">data</span><span class="op" id="4486257">)</span><span class="op" id="4486258">)</span><span class="op" id="4486259">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4486262">state</span><span class="op" id="4486267">.</span><span class="ident" id="4486268">b</span><span class="op" id="4486269">.</span><span class="ident" id="4486270">Write</span><span class="op" id="4486275">(</span><span class="ident" id="4486276">data</span><span class="op" id="4486280">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4486283">enc</span><span class="op" id="4486286">.</span><span class="ident" id="4486287">freeEncoderState</span><span class="op" id="4486303">(</span><span class="ident" id="4486304">state</span><span class="op" id="4486309">)</span><br>
<span class="lineno"></span><span class="op" id="4486311">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">485</span><span class="keyword" id="4486314">var</span>&nbsp;<span class="ident" id="4486318">encOpTable</span>&nbsp;<span class="op" id="4486329">=</span>&nbsp;<span class="op" id="4486331">[</span><span class="op" id="4486332">...</span><span class="op" id="4486335">]</span><span class="ident" id="4486336">encOp</span><span class="op" id="4486341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4486344">reflect</span><span class="op" id="4486351">.</span><span class="ident" id="4486352">Bool</span><span class="op" id="4486356">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4486364">encBool</span><span class="op" id="4486371">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4486374">reflect</span><span class="op" id="4486381">.</span><span class="ident" id="4486382">Int</span><span class="op" id="4486385">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4486394">encInt</span><span class="op" id="4486400">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4486403">reflect</span><span class="op" id="4486410">.</span><span class="ident" id="4486411">Int8</span><span class="op" id="4486415">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4486423">encInt</span><span class="op" id="4486429">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4486432">reflect</span><span class="op" id="4486439">.</span><span class="ident" id="4486440">Int16</span><span class="op" id="4486445">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4486452">encInt</span><span class="op" id="4486458">,</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4486461">reflect</span><span class="op" id="4486468">.</span><span class="ident" id="4486469">Int32</span><span class="op" id="4486474">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4486481">encInt</span><span class="op" id="4486487">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4486490">reflect</span><span class="op" id="4486497">.</span><span class="ident" id="4486498">Int64</span><span class="op" id="4486503">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4486510">encInt</span><span class="op" id="4486516">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4486519">reflect</span><span class="op" id="4486526">.</span><span class="ident" id="4486527">Uint</span><span class="op" id="4486531">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4486539">encUint</span><span class="op" id="4486546">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4486549">reflect</span><span class="op" id="4486556">.</span><span class="ident" id="4486557">Uint8</span><span class="op" id="4486562">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4486569">encUint</span><span class="op" id="4486576">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4486579">reflect</span><span class="op" id="4486586">.</span><span class="ident" id="4486587">Uint16</span><span class="op" id="4486593">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4486599">encUint</span><span class="op" id="4486606">,</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4486609">reflect</span><span class="op" id="4486616">.</span><span class="ident" id="4486617">Uint32</span><span class="op" id="4486623">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4486629">encUint</span><span class="op" id="4486636">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4486639">reflect</span><span class="op" id="4486646">.</span><span class="ident" id="4486647">Uint64</span><span class="op" id="4486653">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4486659">encUint</span><span class="op" id="4486666">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4486669">reflect</span><span class="op" id="4486676">.</span><span class="ident" id="4486677">Uintptr</span><span class="op" id="4486684">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4486689">encUint</span><span class="op" id="4486696">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4486699">reflect</span><span class="op" id="4486706">.</span><span class="ident" id="4486707">Float32</span><span class="op" id="4486714">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4486719">encFloat</span><span class="op" id="4486727">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4486730">reflect</span><span class="op" id="4486737">.</span><span class="ident" id="4486738">Float64</span><span class="op" id="4486745">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4486750">encFloat</span><span class="op" id="4486758">,</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4486761">reflect</span><span class="op" id="4486768">.</span><span class="ident" id="4486769">Complex64</span><span class="op" id="4486778">:</span>&nbsp;&nbsp;<span class="ident" id="4486781">encComplex</span><span class="op" id="4486791">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4486794">reflect</span><span class="op" id="4486801">.</span><span class="ident" id="4486802">Complex128</span><span class="op" id="4486812">:</span>&nbsp;<span class="ident" id="4486814">encComplex</span><span class="op" id="4486824">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4486827">reflect</span><span class="op" id="4486834">.</span><span class="ident" id="4486835">String</span><span class="op" id="4486841">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4486847">encString</span><span class="op" id="4486856">,</span><br>
<span class="lineno"></span><span class="op" id="4486858">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">505</span><span class="comment" id="4486861">//&nbsp;encOpFor&nbsp;returns&nbsp;(a&nbsp;pointer&nbsp;to)&nbsp;the&nbsp;encoding&nbsp;op&nbsp;for&nbsp;the&nbsp;base&nbsp;type&nbsp;under&nbsp;rt&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4486943">//&nbsp;the&nbsp;indirection&nbsp;count&nbsp;to&nbsp;reach&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="4486981">func</span>&nbsp;<span class="ident" id="4486986">encOpFor</span><span class="op" id="4486994">(</span><span class="ident" id="4486995">rt</span>&nbsp;<span class="ident" id="4486998">reflect</span><span class="op" id="4487005">.</span><span class="ident" id="4487006">Type</span><span class="op" id="4487010">,</span>&nbsp;<span class="ident" id="4487012">inProgress</span>&nbsp;<span class="keyword" id="4487023">map</span><span class="op" id="4487026">[</span><span class="ident" id="4487027">reflect</span><span class="op" id="4487034">.</span><span class="ident" id="4487035">Type</span><span class="op" id="4487039">]</span><span class="op" id="4487040">*</span><span class="ident" id="4487041">encOp</span><span class="op" id="4487046">,</span>&nbsp;<span class="ident" id="4487048">building</span>&nbsp;<span class="keyword" id="4487057">map</span><span class="op" id="4487060">[</span><span class="op" id="4487061">*</span><span class="ident" id="4487062">typeInfo</span><span class="op" id="4487070">]</span><span class="builtintype" id="4487071">bool</span><span class="op" id="4487075">)</span>&nbsp;<span class="op" id="4487077">(</span><span class="op" id="4487078">*</span><span class="ident" id="4487079">encOp</span><span class="op" id="4487084">,</span>&nbsp;<span class="builtintype" id="4487086">int</span><span class="op" id="4487089">)</span>&nbsp;<span class="op" id="4487091">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4487094">ut</span>&nbsp;<span class="op" id="4487097">:=</span>&nbsp;<span class="ident" id="4487100">userType</span><span class="op" id="4487108">(</span><span class="ident" id="4487109">rt</span><span class="op" id="4487111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4487114">//&nbsp;If&nbsp;the&nbsp;type&nbsp;implements&nbsp;GobEncoder,&nbsp;we&nbsp;handle&nbsp;it&nbsp;without&nbsp;further&nbsp;processing.</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4487194">if</span>&nbsp;<span class="ident" id="4487197">ut</span><span class="op" id="4487199">.</span><span class="ident" id="4487200">externalEnc</span>&nbsp;<span class="op" id="4487212">!=</span>&nbsp;<span class="num" id="4487215">0</span>&nbsp;<span class="op" id="4487217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4487221">return</span>&nbsp;<span class="ident" id="4487228">gobEncodeOpFor</span><span class="op" id="4487242">(</span><span class="ident" id="4487243">ut</span><span class="op" id="4487245">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4487248">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4487251">//&nbsp;If&nbsp;this&nbsp;type&nbsp;is&nbsp;already&nbsp;in&nbsp;progress,&nbsp;it&#39;s&nbsp;a&nbsp;recursive&nbsp;type&nbsp;(e.g.&nbsp;map[string]*T).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4487336">//&nbsp;Return&nbsp;the&nbsp;pointer&nbsp;to&nbsp;the&nbsp;op&nbsp;we&#39;re&nbsp;already&nbsp;building.</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4487393">if</span>&nbsp;<span class="ident" id="4487396">opPtr</span>&nbsp;<span class="op" id="4487402">:=</span>&nbsp;<span class="ident" id="4487405">inProgress</span><span class="op" id="4487415">[</span><span class="ident" id="4487416">rt</span><span class="op" id="4487418">]</span><span class="op" id="4487419">;</span>&nbsp;<span class="ident" id="4487421">opPtr</span>&nbsp;<span class="op" id="4487427">!=</span>&nbsp;<span class="ident" id="4487430">nil</span>&nbsp;<span class="op" id="4487434">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4487438">return</span>&nbsp;<span class="ident" id="4487445">opPtr</span><span class="op" id="4487450">,</span>&nbsp;<span class="ident" id="4487452">ut</span><span class="op" id="4487454">.</span><span class="ident" id="4487455">indir</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4487462">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4487465">typ</span>&nbsp;<span class="op" id="4487469">:=</span>&nbsp;<span class="ident" id="4487472">ut</span><span class="op" id="4487474">.</span><span class="ident" id="4487475">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4487481">indir</span>&nbsp;<span class="op" id="4487487">:=</span>&nbsp;<span class="ident" id="4487490">ut</span><span class="op" id="4487492">.</span><span class="ident" id="4487493">indir</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4487500">k</span>&nbsp;<span class="op" id="4487502">:=</span>&nbsp;<span class="ident" id="4487505">typ</span><span class="op" id="4487508">.</span><span class="ident" id="4487509">Kind</span><span class="op" id="4487513">(</span><span class="op" id="4487514">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4487517">var</span>&nbsp;<span class="ident" id="4487521">op</span>&nbsp;<span class="ident" id="4487524">encOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4487531">if</span>&nbsp;<span class="builtintype" id="4487534">int</span><span class="op" id="4487537">(</span><span class="ident" id="4487538">k</span><span class="op" id="4487539">)</span>&nbsp;<span class="op" id="4487541">&lt;</span>&nbsp;<span class="builtinfunc" id="4487543">len</span><span class="op" id="4487546">(</span><span class="ident" id="4487547">encOpTable</span><span class="op" id="4487557">)</span>&nbsp;<span class="op" id="4487559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4487563">op</span>&nbsp;<span class="op" id="4487566">=</span>&nbsp;<span class="ident" id="4487568">encOpTable</span><span class="op" id="4487578">[</span><span class="ident" id="4487579">k</span><span class="op" id="4487580">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4487583">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4487586">if</span>&nbsp;<span class="ident" id="4487589">op</span>&nbsp;<span class="op" id="4487592">==</span>&nbsp;<span class="ident" id="4487595">nil</span>&nbsp;<span class="op" id="4487599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4487603">inProgress</span><span class="op" id="4487613">[</span><span class="ident" id="4487614">rt</span><span class="op" id="4487616">]</span>&nbsp;<span class="op" id="4487618">=</span>&nbsp;<span class="op" id="4487620">&amp;</span><span class="ident" id="4487621">op</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4487626">//&nbsp;Special&nbsp;cases</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4487645">switch</span>&nbsp;<span class="ident" id="4487652">t</span>&nbsp;<span class="op" id="4487654">:=</span>&nbsp;<span class="ident" id="4487657">typ</span><span class="op" id="4487660">;</span>&nbsp;<span class="ident" id="4487662">t</span><span class="op" id="4487663">.</span><span class="ident" id="4487664">Kind</span><span class="op" id="4487668">(</span><span class="op" id="4487669">)</span>&nbsp;<span class="op" id="4487671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4487675">case</span>&nbsp;<span class="ident" id="4487680">reflect</span><span class="op" id="4487687">.</span><span class="ident" id="4487688">Slice</span><span class="op" id="4487693">:</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4487698">if</span>&nbsp;<span class="ident" id="4487701">t</span><span class="op" id="4487702">.</span><span class="ident" id="4487703">Elem</span><span class="op" id="4487707">(</span><span class="op" id="4487708">)</span><span class="op" id="4487709">.</span><span class="ident" id="4487710">Kind</span><span class="op" id="4487714">(</span><span class="op" id="4487715">)</span>&nbsp;<span class="op" id="4487717">==</span>&nbsp;<span class="ident" id="4487720">reflect</span><span class="op" id="4487727">.</span><span class="ident" id="4487728">Uint8</span>&nbsp;<span class="op" id="4487734">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4487740">op</span>&nbsp;<span class="op" id="4487743">=</span>&nbsp;<span class="ident" id="4487745">encUint8Array</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4487763">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4487772">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4487777">//&nbsp;Slices&nbsp;have&nbsp;a&nbsp;header;&nbsp;we&nbsp;decode&nbsp;it&nbsp;to&nbsp;find&nbsp;the&nbsp;underlying&nbsp;array.</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4487848">elemOp</span><span class="op" id="4487854">,</span>&nbsp;<span class="ident" id="4487856">elemIndir</span>&nbsp;<span class="op" id="4487866">:=</span>&nbsp;<span class="ident" id="4487869">encOpFor</span><span class="op" id="4487877">(</span><span class="ident" id="4487878">t</span><span class="op" id="4487879">.</span><span class="ident" id="4487880">Elem</span><span class="op" id="4487884">(</span><span class="op" id="4487885">)</span><span class="op" id="4487886">,</span>&nbsp;<span class="ident" id="4487888">inProgress</span><span class="op" id="4487898">,</span>&nbsp;<span class="ident" id="4487900">building</span><span class="op" id="4487908">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4487913">helper</span>&nbsp;<span class="op" id="4487920">:=</span>&nbsp;<span class="ident" id="4487923">encSliceHelper</span><span class="op" id="4487937">[</span><span class="ident" id="4487938">t</span><span class="op" id="4487939">.</span><span class="ident" id="4487940">Elem</span><span class="op" id="4487944">(</span><span class="op" id="4487945">)</span><span class="op" id="4487946">.</span><span class="ident" id="4487947">Kind</span><span class="op" id="4487951">(</span><span class="op" id="4487952">)</span><span class="op" id="4487953">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4487958">op</span>&nbsp;<span class="op" id="4487961">=</span>&nbsp;<span class="keyword" id="4487963">func</span><span class="op" id="4487967">(</span><span class="ident" id="4487968">i</span>&nbsp;<span class="op" id="4487970">*</span><span class="ident" id="4487971">encInstr</span><span class="op" id="4487979">,</span>&nbsp;<span class="ident" id="4487981">state</span>&nbsp;<span class="op" id="4487987">*</span><span class="ident" id="4487988">encoderState</span><span class="op" id="4488000">,</span>&nbsp;<span class="ident" id="4488002">slice</span>&nbsp;<span class="ident" id="4488008">reflect</span><span class="op" id="4488015">.</span><span class="ident" id="4488016">Value</span><span class="op" id="4488021">)</span>&nbsp;<span class="op" id="4488023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4488029">if</span>&nbsp;<span class="op" id="4488032">!</span><span class="ident" id="4488033">state</span><span class="op" id="4488038">.</span><span class="ident" id="4488039">sendZero</span>&nbsp;<span class="op" id="4488048">&amp;&amp;</span>&nbsp;<span class="ident" id="4488051">slice</span><span class="op" id="4488056">.</span><span class="ident" id="4488057">Len</span><span class="op" id="4488060">(</span><span class="op" id="4488061">)</span>&nbsp;<span class="op" id="4488063">==</span>&nbsp;<span class="num" id="4488066">0</span>&nbsp;<span class="op" id="4488068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4488075">return</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4488086">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4488092">state</span><span class="op" id="4488097">.</span><span class="ident" id="4488098">update</span><span class="op" id="4488104">(</span><span class="ident" id="4488105">i</span><span class="op" id="4488106">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4488112">state</span><span class="op" id="4488117">.</span><span class="ident" id="4488118">enc</span><span class="op" id="4488121">.</span><span class="ident" id="4488122">encodeArray</span><span class="op" id="4488133">(</span><span class="ident" id="4488134">state</span><span class="op" id="4488139">.</span><span class="ident" id="4488140">b</span><span class="op" id="4488141">,</span>&nbsp;<span class="ident" id="4488143">slice</span><span class="op" id="4488148">,</span>&nbsp;<span class="op" id="4488150">*</span><span class="ident" id="4488151">elemOp</span><span class="op" id="4488157">,</span>&nbsp;<span class="ident" id="4488159">elemIndir</span><span class="op" id="4488168">,</span>&nbsp;<span class="ident" id="4488170">slice</span><span class="op" id="4488175">.</span><span class="ident" id="4488176">Len</span><span class="op" id="4488179">(</span><span class="op" id="4488180">)</span><span class="op" id="4488181">,</span>&nbsp;<span class="ident" id="4488183">helper</span><span class="op" id="4488189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4488194">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4488198">case</span>&nbsp;<span class="ident" id="4488203">reflect</span><span class="op" id="4488210">.</span><span class="ident" id="4488211">Array</span><span class="op" id="4488216">:</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4488221">//&nbsp;True&nbsp;arrays&nbsp;have&nbsp;size&nbsp;in&nbsp;the&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4488262">elemOp</span><span class="op" id="4488268">,</span>&nbsp;<span class="ident" id="4488270">elemIndir</span>&nbsp;<span class="op" id="4488280">:=</span>&nbsp;<span class="ident" id="4488283">encOpFor</span><span class="op" id="4488291">(</span><span class="ident" id="4488292">t</span><span class="op" id="4488293">.</span><span class="ident" id="4488294">Elem</span><span class="op" id="4488298">(</span><span class="op" id="4488299">)</span><span class="op" id="4488300">,</span>&nbsp;<span class="ident" id="4488302">inProgress</span><span class="op" id="4488312">,</span>&nbsp;<span class="ident" id="4488314">building</span><span class="op" id="4488322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4488327">helper</span>&nbsp;<span class="op" id="4488334">:=</span>&nbsp;<span class="ident" id="4488337">encArrayHelper</span><span class="op" id="4488351">[</span><span class="ident" id="4488352">t</span><span class="op" id="4488353">.</span><span class="ident" id="4488354">Elem</span><span class="op" id="4488358">(</span><span class="op" id="4488359">)</span><span class="op" id="4488360">.</span><span class="ident" id="4488361">Kind</span><span class="op" id="4488365">(</span><span class="op" id="4488366">)</span><span class="op" id="4488367">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4488372">op</span>&nbsp;<span class="op" id="4488375">=</span>&nbsp;<span class="keyword" id="4488377">func</span><span class="op" id="4488381">(</span><span class="ident" id="4488382">i</span>&nbsp;<span class="op" id="4488384">*</span><span class="ident" id="4488385">encInstr</span><span class="op" id="4488393">,</span>&nbsp;<span class="ident" id="4488395">state</span>&nbsp;<span class="op" id="4488401">*</span><span class="ident" id="4488402">encoderState</span><span class="op" id="4488414">,</span>&nbsp;<span class="ident" id="4488416">array</span>&nbsp;<span class="ident" id="4488422">reflect</span><span class="op" id="4488429">.</span><span class="ident" id="4488430">Value</span><span class="op" id="4488435">)</span>&nbsp;<span class="op" id="4488437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4488443">state</span><span class="op" id="4488448">.</span><span class="ident" id="4488449">update</span><span class="op" id="4488455">(</span><span class="ident" id="4488456">i</span><span class="op" id="4488457">)</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4488463">state</span><span class="op" id="4488468">.</span><span class="ident" id="4488469">enc</span><span class="op" id="4488472">.</span><span class="ident" id="4488473">encodeArray</span><span class="op" id="4488484">(</span><span class="ident" id="4488485">state</span><span class="op" id="4488490">.</span><span class="ident" id="4488491">b</span><span class="op" id="4488492">,</span>&nbsp;<span class="ident" id="4488494">array</span><span class="op" id="4488499">,</span>&nbsp;<span class="op" id="4488501">*</span><span class="ident" id="4488502">elemOp</span><span class="op" id="4488508">,</span>&nbsp;<span class="ident" id="4488510">elemIndir</span><span class="op" id="4488519">,</span>&nbsp;<span class="ident" id="4488521">array</span><span class="op" id="4488526">.</span><span class="ident" id="4488527">Len</span><span class="op" id="4488530">(</span><span class="op" id="4488531">)</span><span class="op" id="4488532">,</span>&nbsp;<span class="ident" id="4488534">helper</span><span class="op" id="4488540">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4488545">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4488549">case</span>&nbsp;<span class="ident" id="4488554">reflect</span><span class="op" id="4488561">.</span><span class="ident" id="4488562">Map</span><span class="op" id="4488565">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4488570">keyOp</span><span class="op" id="4488575">,</span>&nbsp;<span class="ident" id="4488577">keyIndir</span>&nbsp;<span class="op" id="4488586">:=</span>&nbsp;<span class="ident" id="4488589">encOpFor</span><span class="op" id="4488597">(</span><span class="ident" id="4488598">t</span><span class="op" id="4488599">.</span><span class="ident" id="4488600">Key</span><span class="op" id="4488603">(</span><span class="op" id="4488604">)</span><span class="op" id="4488605">,</span>&nbsp;<span class="ident" id="4488607">inProgress</span><span class="op" id="4488617">,</span>&nbsp;<span class="ident" id="4488619">building</span><span class="op" id="4488627">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4488632">elemOp</span><span class="op" id="4488638">,</span>&nbsp;<span class="ident" id="4488640">elemIndir</span>&nbsp;<span class="op" id="4488650">:=</span>&nbsp;<span class="ident" id="4488653">encOpFor</span><span class="op" id="4488661">(</span><span class="ident" id="4488662">t</span><span class="op" id="4488663">.</span><span class="ident" id="4488664">Elem</span><span class="op" id="4488668">(</span><span class="op" id="4488669">)</span><span class="op" id="4488670">,</span>&nbsp;<span class="ident" id="4488672">inProgress</span><span class="op" id="4488682">,</span>&nbsp;<span class="ident" id="4488684">building</span><span class="op" id="4488692">)</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4488697">op</span>&nbsp;<span class="op" id="4488700">=</span>&nbsp;<span class="keyword" id="4488702">func</span><span class="op" id="4488706">(</span><span class="ident" id="4488707">i</span>&nbsp;<span class="op" id="4488709">*</span><span class="ident" id="4488710">encInstr</span><span class="op" id="4488718">,</span>&nbsp;<span class="ident" id="4488720">state</span>&nbsp;<span class="op" id="4488726">*</span><span class="ident" id="4488727">encoderState</span><span class="op" id="4488739">,</span>&nbsp;<span class="ident" id="4488741">mv</span>&nbsp;<span class="ident" id="4488744">reflect</span><span class="op" id="4488751">.</span><span class="ident" id="4488752">Value</span><span class="op" id="4488757">)</span>&nbsp;<span class="op" id="4488759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4488765">//&nbsp;We&nbsp;send&nbsp;zero-length&nbsp;(but&nbsp;non-nil)&nbsp;maps&nbsp;because&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4488823">//&nbsp;receiver&nbsp;might&nbsp;want&nbsp;to&nbsp;use&nbsp;the&nbsp;map.&nbsp;&nbsp;(Maps&nbsp;don&#39;t&nbsp;use&nbsp;append.)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4488892">if</span>&nbsp;<span class="op" id="4488895">!</span><span class="ident" id="4488896">state</span><span class="op" id="4488901">.</span><span class="ident" id="4488902">sendZero</span>&nbsp;<span class="op" id="4488911">&amp;&amp;</span>&nbsp;<span class="ident" id="4488914">mv</span><span class="op" id="4488916">.</span><span class="ident" id="4488917">IsNil</span><span class="op" id="4488922">(</span><span class="op" id="4488923">)</span>&nbsp;<span class="op" id="4488925">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4488932">return</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4488943">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4488949">state</span><span class="op" id="4488954">.</span><span class="ident" id="4488955">update</span><span class="op" id="4488961">(</span><span class="ident" id="4488962">i</span><span class="op" id="4488963">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4488969">state</span><span class="op" id="4488974">.</span><span class="ident" id="4488975">enc</span><span class="op" id="4488978">.</span><span class="ident" id="4488979">encodeMap</span><span class="op" id="4488988">(</span><span class="ident" id="4488989">state</span><span class="op" id="4488994">.</span><span class="ident" id="4488995">b</span><span class="op" id="4488996">,</span>&nbsp;<span class="ident" id="4488998">mv</span><span class="op" id="4489000">,</span>&nbsp;<span class="op" id="4489002">*</span><span class="ident" id="4489003">keyOp</span><span class="op" id="4489008">,</span>&nbsp;<span class="op" id="4489010">*</span><span class="ident" id="4489011">elemOp</span><span class="op" id="4489017">,</span>&nbsp;<span class="ident" id="4489019">keyIndir</span><span class="op" id="4489027">,</span>&nbsp;<span class="ident" id="4489029">elemIndir</span><span class="op" id="4489038">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4489043">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4489047">case</span>&nbsp;<span class="ident" id="4489052">reflect</span><span class="op" id="4489059">.</span><span class="ident" id="4489060">Struct</span><span class="op" id="4489066">:</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4489071">//&nbsp;Generate&nbsp;a&nbsp;closure&nbsp;that&nbsp;calls&nbsp;out&nbsp;to&nbsp;the&nbsp;engine&nbsp;for&nbsp;the&nbsp;nested&nbsp;type.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4489146">getEncEngine</span><span class="op" id="4489158">(</span><span class="ident" id="4489159">userType</span><span class="op" id="4489167">(</span><span class="ident" id="4489168">typ</span><span class="op" id="4489171">)</span><span class="op" id="4489172">,</span>&nbsp;<span class="ident" id="4489174">building</span><span class="op" id="4489182">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4489187">info</span>&nbsp;<span class="op" id="4489192">:=</span>&nbsp;<span class="ident" id="4489195">mustGetTypeInfo</span><span class="op" id="4489210">(</span><span class="ident" id="4489211">typ</span><span class="op" id="4489214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4489219">op</span>&nbsp;<span class="op" id="4489222">=</span>&nbsp;<span class="keyword" id="4489224">func</span><span class="op" id="4489228">(</span><span class="ident" id="4489229">i</span>&nbsp;<span class="op" id="4489231">*</span><span class="ident" id="4489232">encInstr</span><span class="op" id="4489240">,</span>&nbsp;<span class="ident" id="4489242">state</span>&nbsp;<span class="op" id="4489248">*</span><span class="ident" id="4489249">encoderState</span><span class="op" id="4489261">,</span>&nbsp;<span class="ident" id="4489263">sv</span>&nbsp;<span class="ident" id="4489266">reflect</span><span class="op" id="4489273">.</span><span class="ident" id="4489274">Value</span><span class="op" id="4489279">)</span>&nbsp;<span class="op" id="4489281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4489287">state</span><span class="op" id="4489292">.</span><span class="ident" id="4489293">update</span><span class="op" id="4489299">(</span><span class="ident" id="4489300">i</span><span class="op" id="4489301">)</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4489307">//&nbsp;indirect&nbsp;through&nbsp;info&nbsp;to&nbsp;delay&nbsp;evaluation&nbsp;for&nbsp;recursive&nbsp;structs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4489378">enc</span>&nbsp;<span class="op" id="4489382">:=</span>&nbsp;<span class="ident" id="4489385">info</span><span class="op" id="4489389">.</span><span class="ident" id="4489390">encoder</span><span class="op" id="4489397">.</span><span class="ident" id="4489398">Load</span><span class="op" id="4489402">(</span><span class="op" id="4489403">)</span><span class="op" id="4489404">.</span><span class="op" id="4489405">(</span><span class="op" id="4489406">*</span><span class="ident" id="4489407">encEngine</span><span class="op" id="4489416">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4489422">state</span><span class="op" id="4489427">.</span><span class="ident" id="4489428">enc</span><span class="op" id="4489431">.</span><span class="ident" id="4489432">encodeStruct</span><span class="op" id="4489444">(</span><span class="ident" id="4489445">state</span><span class="op" id="4489450">.</span><span class="ident" id="4489451">b</span><span class="op" id="4489452">,</span>&nbsp;<span class="ident" id="4489454">enc</span><span class="op" id="4489457">,</span>&nbsp;<span class="ident" id="4489459">sv</span><span class="op" id="4489461">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4489466">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4489470">case</span>&nbsp;<span class="ident" id="4489475">reflect</span><span class="op" id="4489482">.</span><span class="ident" id="4489483">Interface</span><span class="op" id="4489492">:</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4489497">op</span>&nbsp;<span class="op" id="4489500">=</span>&nbsp;<span class="keyword" id="4489502">func</span><span class="op" id="4489506">(</span><span class="ident" id="4489507">i</span>&nbsp;<span class="op" id="4489509">*</span><span class="ident" id="4489510">encInstr</span><span class="op" id="4489518">,</span>&nbsp;<span class="ident" id="4489520">state</span>&nbsp;<span class="op" id="4489526">*</span><span class="ident" id="4489527">encoderState</span><span class="op" id="4489539">,</span>&nbsp;<span class="ident" id="4489541">iv</span>&nbsp;<span class="ident" id="4489544">reflect</span><span class="op" id="4489551">.</span><span class="ident" id="4489552">Value</span><span class="op" id="4489557">)</span>&nbsp;<span class="op" id="4489559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4489565">if</span>&nbsp;<span class="op" id="4489568">!</span><span class="ident" id="4489569">state</span><span class="op" id="4489574">.</span><span class="ident" id="4489575">sendZero</span>&nbsp;<span class="op" id="4489584">&amp;&amp;</span>&nbsp;<span class="op" id="4489587">(</span><span class="op" id="4489588">!</span><span class="ident" id="4489589">iv</span><span class="op" id="4489591">.</span><span class="ident" id="4489592">IsValid</span><span class="op" id="4489599">(</span><span class="op" id="4489600">)</span>&nbsp;<span class="op" id="4489602">||</span>&nbsp;<span class="ident" id="4489605">iv</span><span class="op" id="4489607">.</span><span class="ident" id="4489608">IsNil</span><span class="op" id="4489613">(</span><span class="op" id="4489614">)</span><span class="op" id="4489615">)</span>&nbsp;<span class="op" id="4489617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4489624">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4489635">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4489641">state</span><span class="op" id="4489646">.</span><span class="ident" id="4489647">update</span><span class="op" id="4489653">(</span><span class="ident" id="4489654">i</span><span class="op" id="4489655">)</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4489661">state</span><span class="op" id="4489666">.</span><span class="ident" id="4489667">enc</span><span class="op" id="4489670">.</span><span class="ident" id="4489671">encodeInterface</span><span class="op" id="4489686">(</span><span class="ident" id="4489687">state</span><span class="op" id="4489692">.</span><span class="ident" id="4489693">b</span><span class="op" id="4489694">,</span>&nbsp;<span class="ident" id="4489696">iv</span><span class="op" id="4489698">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4489703">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4489707">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4489710">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4489713">if</span>&nbsp;<span class="ident" id="4489716">op</span>&nbsp;<span class="op" id="4489719">==</span>&nbsp;<span class="ident" id="4489722">nil</span>&nbsp;<span class="op" id="4489726">{</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4489730">errorf</span><span class="op" id="4489736">(</span><span class="string" id="4489737">&#34;can&#39;t&nbsp;happen:&nbsp;encode&nbsp;type&nbsp;%s&#34;</span><span class="op" id="4489767">,</span>&nbsp;<span class="ident" id="4489769">rt</span><span class="op" id="4489771">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4489774">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4489777">return</span>&nbsp;<span class="op" id="4489784">&amp;</span><span class="ident" id="4489785">op</span><span class="op" id="4489787">,</span>&nbsp;<span class="ident" id="4489789">indir</span><br>
<span class="lineno"></span><span class="op" id="4489795">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">590</span><span class="comment" id="4489798">//&nbsp;gobEncodeOpFor&nbsp;returns&nbsp;the&nbsp;op&nbsp;for&nbsp;a&nbsp;type&nbsp;that&nbsp;is&nbsp;known&nbsp;to&nbsp;implement&nbsp;GobEncoder.</span><br>
<span class="lineno"></span><span class="keyword" id="4489881">func</span>&nbsp;<span class="ident" id="4489886">gobEncodeOpFor</span><span class="op" id="4489900">(</span><span class="ident" id="4489901">ut</span>&nbsp;<span class="op" id="4489904">*</span><span class="ident" id="4489905">userTypeInfo</span><span class="op" id="4489917">)</span>&nbsp;<span class="op" id="4489919">(</span><span class="op" id="4489920">*</span><span class="ident" id="4489921">encOp</span><span class="op" id="4489926">,</span>&nbsp;<span class="builtintype" id="4489928">int</span><span class="op" id="4489931">)</span>&nbsp;<span class="op" id="4489933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4489936">rt</span>&nbsp;<span class="op" id="4489939">:=</span>&nbsp;<span class="ident" id="4489942">ut</span><span class="op" id="4489944">.</span><span class="ident" id="4489945">user</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4489951">if</span>&nbsp;<span class="ident" id="4489954">ut</span><span class="op" id="4489956">.</span><span class="ident" id="4489957">encIndir</span>&nbsp;<span class="op" id="4489966">==</span>&nbsp;<span class="op" id="4489969">-</span><span class="num" id="4489970">1</span>&nbsp;<span class="op" id="4489972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4489976">rt</span>&nbsp;<span class="op" id="4489979">=</span>&nbsp;<span class="ident" id="4489981">reflect</span><span class="op" id="4489988">.</span><span class="ident" id="4489989">PtrTo</span><span class="op" id="4489994">(</span><span class="ident" id="4489995">rt</span><span class="op" id="4489997">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4490000">}</span>&nbsp;<span class="keyword" id="4490002">else</span>&nbsp;<span class="keyword" id="4490007">if</span>&nbsp;<span class="ident" id="4490010">ut</span><span class="op" id="4490012">.</span><span class="ident" id="4490013">encIndir</span>&nbsp;<span class="op" id="4490022">&gt;</span>&nbsp;<span class="num" id="4490024">0</span>&nbsp;<span class="op" id="4490026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4490030">for</span>&nbsp;<span class="ident" id="4490034">i</span>&nbsp;<span class="op" id="4490036">:=</span>&nbsp;<span class="builtintype" id="4490039">int8</span><span class="op" id="4490043">(</span><span class="num" id="4490044">0</span><span class="op" id="4490045">)</span><span class="op" id="4490046">;</span>&nbsp;<span class="ident" id="4490048">i</span>&nbsp;<span class="op" id="4490050">&lt;</span>&nbsp;<span class="ident" id="4490052">ut</span><span class="op" id="4490054">.</span><span class="ident" id="4490055">encIndir</span><span class="op" id="4490063">;</span>&nbsp;<span class="ident" id="4490065">i</span><span class="op" id="4490066">++</span>&nbsp;<span class="op" id="4490069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4490074">rt</span>&nbsp;<span class="op" id="4490077">=</span>&nbsp;<span class="ident" id="4490079">rt</span><span class="op" id="4490081">.</span><span class="ident" id="4490082">Elem</span><span class="op" id="4490086">(</span><span class="op" id="4490087">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4490091">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4490094">}</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4490097">var</span>&nbsp;<span class="ident" id="4490101">op</span>&nbsp;<span class="ident" id="4490104">encOp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4490111">op</span>&nbsp;<span class="op" id="4490114">=</span>&nbsp;<span class="keyword" id="4490116">func</span><span class="op" id="4490120">(</span><span class="ident" id="4490121">i</span>&nbsp;<span class="op" id="4490123">*</span><span class="ident" id="4490124">encInstr</span><span class="op" id="4490132">,</span>&nbsp;<span class="ident" id="4490134">state</span>&nbsp;<span class="op" id="4490140">*</span><span class="ident" id="4490141">encoderState</span><span class="op" id="4490153">,</span>&nbsp;<span class="ident" id="4490155">v</span>&nbsp;<span class="ident" id="4490157">reflect</span><span class="op" id="4490164">.</span><span class="ident" id="4490165">Value</span><span class="op" id="4490170">)</span>&nbsp;<span class="op" id="4490172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4490176">if</span>&nbsp;<span class="ident" id="4490179">ut</span><span class="op" id="4490181">.</span><span class="ident" id="4490182">encIndir</span>&nbsp;<span class="op" id="4490191">==</span>&nbsp;<span class="op" id="4490194">-</span><span class="num" id="4490195">1</span>&nbsp;<span class="op" id="4490197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4490202">//&nbsp;Need&nbsp;to&nbsp;climb&nbsp;up&nbsp;one&nbsp;level&nbsp;to&nbsp;turn&nbsp;value&nbsp;into&nbsp;pointer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4490263">if</span>&nbsp;<span class="op" id="4490266">!</span><span class="ident" id="4490267">v</span><span class="op" id="4490268">.</span><span class="ident" id="4490269">CanAddr</span><span class="op" id="4490276">(</span><span class="op" id="4490277">)</span>&nbsp;<span class="op" id="4490279">{</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4490285">errorf</span><span class="op" id="4490291">(</span><span class="string" id="4490292">&#34;unaddressable&nbsp;value&nbsp;of&nbsp;type&nbsp;%s&#34;</span><span class="op" id="4490324">,</span>&nbsp;<span class="ident" id="4490326">rt</span><span class="op" id="4490328">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4490333">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4490338">v</span>&nbsp;<span class="op" id="4490340">=</span>&nbsp;<span class="ident" id="4490342">v</span><span class="op" id="4490343">.</span><span class="ident" id="4490344">Addr</span><span class="op" id="4490348">(</span><span class="op" id="4490349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4490353">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4490357">if</span>&nbsp;<span class="op" id="4490360">!</span><span class="ident" id="4490361">state</span><span class="op" id="4490366">.</span><span class="ident" id="4490367">sendZero</span>&nbsp;<span class="op" id="4490376">&amp;&amp;</span>&nbsp;<span class="ident" id="4490379">isZero</span><span class="op" id="4490385">(</span><span class="ident" id="4490386">v</span><span class="op" id="4490387">)</span>&nbsp;<span class="op" id="4490389">{</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4490394">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4490403">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4490407">state</span><span class="op" id="4490412">.</span><span class="ident" id="4490413">update</span><span class="op" id="4490419">(</span><span class="ident" id="4490420">i</span><span class="op" id="4490421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4490425">state</span><span class="op" id="4490430">.</span><span class="ident" id="4490431">enc</span><span class="op" id="4490434">.</span><span class="ident" id="4490435">encodeGobEncoder</span><span class="op" id="4490451">(</span><span class="ident" id="4490452">state</span><span class="op" id="4490457">.</span><span class="ident" id="4490458">b</span><span class="op" id="4490459">,</span>&nbsp;<span class="ident" id="4490461">ut</span><span class="op" id="4490463">,</span>&nbsp;<span class="ident" id="4490465">v</span><span class="op" id="4490466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4490469">}</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4490472">return</span>&nbsp;<span class="op" id="4490479">&amp;</span><span class="ident" id="4490480">op</span><span class="op" id="4490482">,</span>&nbsp;<span class="builtintype" id="4490484">int</span><span class="op" id="4490487">(</span><span class="ident" id="4490488">ut</span><span class="op" id="4490490">.</span><span class="ident" id="4490491">encIndir</span><span class="op" id="4490499">)</span>&nbsp;<span class="comment" id="4490501">//&nbsp;encIndir:&nbsp;op&nbsp;will&nbsp;get&nbsp;called&nbsp;with&nbsp;p&nbsp;==&nbsp;address&nbsp;of&nbsp;receiver.</span><br>
<span class="lineno"></span><span class="op" id="4490564">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4490567">//&nbsp;compileEnc&nbsp;returns&nbsp;the&nbsp;engine&nbsp;to&nbsp;compile&nbsp;the&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="4490621">func</span>&nbsp;<span class="ident" id="4490626">compileEnc</span><span class="op" id="4490636">(</span><span class="ident" id="4490637">ut</span>&nbsp;<span class="op" id="4490640">*</span><span class="ident" id="4490641">userTypeInfo</span><span class="op" id="4490653">,</span>&nbsp;<span class="ident" id="4490655">building</span>&nbsp;<span class="keyword" id="4490664">map</span><span class="op" id="4490667">[</span><span class="op" id="4490668">*</span><span class="ident" id="4490669">typeInfo</span><span class="op" id="4490677">]</span><span class="builtintype" id="4490678">bool</span><span class="op" id="4490682">)</span>&nbsp;<span class="op" id="4490684">*</span><span class="ident" id="4490685">encEngine</span>&nbsp;<span class="op" id="4490695">{</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4490698">srt</span>&nbsp;<span class="op" id="4490702">:=</span>&nbsp;<span class="ident" id="4490705">ut</span><span class="op" id="4490707">.</span><span class="ident" id="4490708">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4490714">engine</span>&nbsp;<span class="op" id="4490721">:=</span>&nbsp;<span class="builtinfunc" id="4490724">new</span><span class="op" id="4490727">(</span><span class="ident" id="4490728">encEngine</span><span class="op" id="4490737">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4490740">seen</span>&nbsp;<span class="op" id="4490745">:=</span>&nbsp;<span class="builtinfunc" id="4490748">make</span><span class="op" id="4490752">(</span><span class="keyword" id="4490753">map</span><span class="op" id="4490756">[</span><span class="ident" id="4490757">reflect</span><span class="op" id="4490764">.</span><span class="ident" id="4490765">Type</span><span class="op" id="4490769">]</span><span class="op" id="4490770">*</span><span class="ident" id="4490771">encOp</span><span class="op" id="4490776">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4490779">rt</span>&nbsp;<span class="op" id="4490782">:=</span>&nbsp;<span class="ident" id="4490785">ut</span><span class="op" id="4490787">.</span><span class="ident" id="4490788">base</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4490794">if</span>&nbsp;<span class="ident" id="4490797">ut</span><span class="op" id="4490799">.</span><span class="ident" id="4490800">externalEnc</span>&nbsp;<span class="op" id="4490812">!=</span>&nbsp;<span class="num" id="4490815">0</span>&nbsp;<span class="op" id="4490817">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4490821">rt</span>&nbsp;<span class="op" id="4490824">=</span>&nbsp;<span class="ident" id="4490826">ut</span><span class="op" id="4490828">.</span><span class="ident" id="4490829">user</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4490835">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4490838">if</span>&nbsp;<span class="ident" id="4490841">ut</span><span class="op" id="4490843">.</span><span class="ident" id="4490844">externalEnc</span>&nbsp;<span class="op" id="4490856">==</span>&nbsp;<span class="num" id="4490859">0</span>&nbsp;<span class="op" id="4490861">&amp;&amp;</span>&nbsp;<span class="ident" id="4490864">srt</span><span class="op" id="4490867">.</span><span class="ident" id="4490868">Kind</span><span class="op" id="4490872">(</span><span class="op" id="4490873">)</span>&nbsp;<span class="op" id="4490875">==</span>&nbsp;<span class="ident" id="4490878">reflect</span><span class="op" id="4490885">.</span><span class="ident" id="4490886">Struct</span>&nbsp;<span class="op" id="4490893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4490897">for</span>&nbsp;<span class="ident" id="4490901">fieldNum</span><span class="op" id="4490909">,</span>&nbsp;<span class="ident" id="4490911">wireFieldNum</span>&nbsp;<span class="op" id="4490924">:=</span>&nbsp;<span class="num" id="4490927">0</span><span class="op" id="4490928">,</span>&nbsp;<span class="num" id="4490930">0</span><span class="op" id="4490931">;</span>&nbsp;<span class="ident" id="4490933">fieldNum</span>&nbsp;<span class="op" id="4490942">&lt;</span>&nbsp;<span class="ident" id="4490944">srt</span><span class="op" id="4490947">.</span><span class="ident" id="4490948">NumField</span><span class="op" id="4490956">(</span><span class="op" id="4490957">)</span><span class="op" id="4490958">;</span>&nbsp;<span class="ident" id="4490960">fieldNum</span><span class="op" id="4490968">++</span>&nbsp;<span class="op" id="4490971">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4490976">f</span>&nbsp;<span class="op" id="4490978">:=</span>&nbsp;<span class="ident" id="4490981">srt</span><span class="op" id="4490984">.</span><span class="ident" id="4490985">Field</span><span class="op" id="4490990">(</span><span class="ident" id="4490991">fieldNum</span><span class="op" id="4490999">)</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4491004">if</span>&nbsp;<span class="op" id="4491007">!</span><span class="ident" id="4491008">isSent</span><span class="op" id="4491014">(</span><span class="op" id="4491015">&amp;</span><span class="ident" id="4491016">f</span><span class="op" id="4491017">)</span>&nbsp;<span class="op" id="4491019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4491025">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4491037">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4491042">op</span><span class="op" id="4491044">,</span>&nbsp;<span class="ident" id="4491046">indir</span>&nbsp;<span class="op" id="4491052">:=</span>&nbsp;<span class="ident" id="4491055">encOpFor</span><span class="op" id="4491063">(</span><span class="ident" id="4491064">f</span><span class="op" id="4491065">.</span><span class="ident" id="4491066">Type</span><span class="op" id="4491070">,</span>&nbsp;<span class="ident" id="4491072">seen</span><span class="op" id="4491076">,</span>&nbsp;<span class="ident" id="4491078">building</span><span class="op" id="4491086">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4491091">engine</span><span class="op" id="4491097">.</span><span class="ident" id="4491098">instr</span>&nbsp;<span class="op" id="4491104">=</span>&nbsp;<span class="builtinfunc" id="4491106">append</span><span class="op" id="4491112">(</span><span class="ident" id="4491113">engine</span><span class="op" id="4491119">.</span><span class="ident" id="4491120">instr</span><span class="op" id="4491125">,</span>&nbsp;<span class="ident" id="4491127">encInstr</span><span class="op" id="4491135">{</span><span class="op" id="4491136">*</span><span class="ident" id="4491137">op</span><span class="op" id="4491139">,</span>&nbsp;<span class="ident" id="4491141">wireFieldNum</span><span class="op" id="4491153">,</span>&nbsp;<span class="ident" id="4491155">f</span><span class="op" id="4491156">.</span><span class="ident" id="4491157">Index</span><span class="op" id="4491162">,</span>&nbsp;<span class="ident" id="4491164">indir</span><span class="op" id="4491169">}</span><span class="op" id="4491170">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4491175">wireFieldNum</span><span class="op" id="4491187">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4491192">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4491196">if</span>&nbsp;<span class="ident" id="4491199">srt</span><span class="op" id="4491202">.</span><span class="ident" id="4491203">NumField</span><span class="op" id="4491211">(</span><span class="op" id="4491212">)</span>&nbsp;<span class="op" id="4491214">&gt;</span>&nbsp;<span class="num" id="4491216">0</span>&nbsp;<span class="op" id="4491218">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="4491221">len</span><span class="op" id="4491224">(</span><span class="ident" id="4491225">engine</span><span class="op" id="4491231">.</span><span class="ident" id="4491232">instr</span><span class="op" id="4491237">)</span>&nbsp;<span class="op" id="4491239">==</span>&nbsp;<span class="num" id="4491242">0</span>&nbsp;<span class="op" id="4491244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4491249">errorf</span><span class="op" id="4491255">(</span><span class="string" id="4491256">&#34;type&nbsp;%s&nbsp;has&nbsp;no&nbsp;exported&nbsp;fields&#34;</span><span class="op" id="4491288">,</span>&nbsp;<span class="ident" id="4491290">rt</span><span class="op" id="4491292">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4491296">}</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4491300">engine</span><span class="op" id="4491306">.</span><span class="ident" id="4491307">instr</span>&nbsp;<span class="op" id="4491313">=</span>&nbsp;<span class="builtinfunc" id="4491315">append</span><span class="op" id="4491321">(</span><span class="ident" id="4491322">engine</span><span class="op" id="4491328">.</span><span class="ident" id="4491329">instr</span><span class="op" id="4491334">,</span>&nbsp;<span class="ident" id="4491336">encInstr</span><span class="op" id="4491344">{</span><span class="ident" id="4491345">encStructTerminator</span><span class="op" id="4491364">,</span>&nbsp;<span class="num" id="4491366">0</span><span class="op" id="4491367">,</span>&nbsp;<span class="ident" id="4491369">nil</span><span class="op" id="4491372">,</span>&nbsp;<span class="num" id="4491374">0</span><span class="op" id="4491375">}</span><span class="op" id="4491376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4491379">}</span>&nbsp;<span class="keyword" id="4491381">else</span>&nbsp;<span class="op" id="4491386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4491390">engine</span><span class="op" id="4491396">.</span><span class="ident" id="4491397">instr</span>&nbsp;<span class="op" id="4491403">=</span>&nbsp;<span class="builtinfunc" id="4491405">make</span><span class="op" id="4491409">(</span><span class="op" id="4491410">[</span><span class="op" id="4491411">]</span><span class="ident" id="4491412">encInstr</span><span class="op" id="4491420">,</span>&nbsp;<span class="num" id="4491422">1</span><span class="op" id="4491423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4491427">op</span><span class="op" id="4491429">,</span>&nbsp;<span class="ident" id="4491431">indir</span>&nbsp;<span class="op" id="4491437">:=</span>&nbsp;<span class="ident" id="4491440">encOpFor</span><span class="op" id="4491448">(</span><span class="ident" id="4491449">rt</span><span class="op" id="4491451">,</span>&nbsp;<span class="ident" id="4491453">seen</span><span class="op" id="4491457">,</span>&nbsp;<span class="ident" id="4491459">building</span><span class="op" id="4491467">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4491471">engine</span><span class="op" id="4491477">.</span><span class="ident" id="4491478">instr</span><span class="op" id="4491483">[</span><span class="num" id="4491484">0</span><span class="op" id="4491485">]</span>&nbsp;<span class="op" id="4491487">=</span>&nbsp;<span class="ident" id="4491489">encInstr</span><span class="op" id="4491497">{</span><span class="op" id="4491498">*</span><span class="ident" id="4491499">op</span><span class="op" id="4491501">,</span>&nbsp;<span class="ident" id="4491503">singletonField</span><span class="op" id="4491517">,</span>&nbsp;<span class="ident" id="4491519">nil</span><span class="op" id="4491522">,</span>&nbsp;<span class="ident" id="4491524">indir</span><span class="op" id="4491529">}</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4491532">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4491535">return</span>&nbsp;<span class="ident" id="4491542">engine</span><br>
<span class="lineno"></span><span class="op" id="4491549">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4491552">//&nbsp;getEncEngine&nbsp;returns&nbsp;the&nbsp;engine&nbsp;to&nbsp;compile&nbsp;the&nbsp;type.</span><br>
<span class="lineno">650</span><span class="keyword" id="4491608">func</span>&nbsp;<span class="ident" id="4491613">getEncEngine</span><span class="op" id="4491625">(</span><span class="ident" id="4491626">ut</span>&nbsp;<span class="op" id="4491629">*</span><span class="ident" id="4491630">userTypeInfo</span><span class="op" id="4491642">,</span>&nbsp;<span class="ident" id="4491644">building</span>&nbsp;<span class="keyword" id="4491653">map</span><span class="op" id="4491656">[</span><span class="op" id="4491657">*</span><span class="ident" id="4491658">typeInfo</span><span class="op" id="4491666">]</span><span class="builtintype" id="4491667">bool</span><span class="op" id="4491671">)</span>&nbsp;<span class="op" id="4491673">*</span><span class="ident" id="4491674">encEngine</span>&nbsp;<span class="op" id="4491684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4491687">info</span><span class="op" id="4491691">,</span>&nbsp;<span class="ident" id="4491693">err</span>&nbsp;<span class="op" id="4491697">:=</span>&nbsp;<span class="ident" id="4491700">getTypeInfo</span><span class="op" id="4491711">(</span><span class="ident" id="4491712">ut</span><span class="op" id="4491714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4491717">if</span>&nbsp;<span class="ident" id="4491720">err</span>&nbsp;<span class="op" id="4491724">!=</span>&nbsp;<span class="ident" id="4491727">nil</span>&nbsp;<span class="op" id="4491731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4491735">error_</span><span class="op" id="4491741">(</span><span class="ident" id="4491742">err</span><span class="op" id="4491745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4491748">}</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4491751">enc</span><span class="op" id="4491754">,</span>&nbsp;<span class="ident" id="4491756">ok</span>&nbsp;<span class="op" id="4491759">:=</span>&nbsp;<span class="ident" id="4491762">info</span><span class="op" id="4491766">.</span><span class="ident" id="4491767">encoder</span><span class="op" id="4491774">.</span><span class="ident" id="4491775">Load</span><span class="op" id="4491779">(</span><span class="op" id="4491780">)</span><span class="op" id="4491781">.</span><span class="op" id="4491782">(</span><span class="op" id="4491783">*</span><span class="ident" id="4491784">encEngine</span><span class="op" id="4491793">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4491796">if</span>&nbsp;<span class="op" id="4491799">!</span><span class="ident" id="4491800">ok</span>&nbsp;<span class="op" id="4491803">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4491807">enc</span>&nbsp;<span class="op" id="4491811">=</span>&nbsp;<span class="ident" id="4491813">buildEncEngine</span><span class="op" id="4491827">(</span><span class="ident" id="4491828">info</span><span class="op" id="4491832">,</span>&nbsp;<span class="ident" id="4491834">ut</span><span class="op" id="4491836">,</span>&nbsp;<span class="ident" id="4491838">building</span><span class="op" id="4491846">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4491849">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4491852">return</span>&nbsp;<span class="ident" id="4491859">enc</span><br>
<span class="lineno">660</span><span class="op" id="4491863">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4491866">func</span>&nbsp;<span class="ident" id="4491871">buildEncEngine</span><span class="op" id="4491885">(</span><span class="ident" id="4491886">info</span>&nbsp;<span class="op" id="4491891">*</span><span class="ident" id="4491892">typeInfo</span><span class="op" id="4491900">,</span>&nbsp;<span class="ident" id="4491902">ut</span>&nbsp;<span class="op" id="4491905">*</span><span class="ident" id="4491906">userTypeInfo</span><span class="op" id="4491918">,</span>&nbsp;<span class="ident" id="4491920">building</span>&nbsp;<span class="keyword" id="4491929">map</span><span class="op" id="4491932">[</span><span class="op" id="4491933">*</span><span class="ident" id="4491934">typeInfo</span><span class="op" id="4491942">]</span><span class="builtintype" id="4491943">bool</span><span class="op" id="4491947">)</span>&nbsp;<span class="op" id="4491949">*</span><span class="ident" id="4491950">encEngine</span>&nbsp;<span class="op" id="4491960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4491963">//&nbsp;Check&nbsp;for&nbsp;recursive&nbsp;types.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4491994">if</span>&nbsp;<span class="ident" id="4491997">building</span>&nbsp;<span class="op" id="4492006">!=</span>&nbsp;<span class="ident" id="4492009">nil</span>&nbsp;<span class="op" id="4492013">&amp;&amp;</span>&nbsp;<span class="ident" id="4492016">building</span><span class="op" id="4492024">[</span><span class="ident" id="4492025">info</span><span class="op" id="4492029">]</span>&nbsp;<span class="op" id="4492031">{</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4492035">return</span>&nbsp;<span class="ident" id="4492042">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4492047">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4492050">info</span><span class="op" id="4492054">.</span><span class="ident" id="4492055">encInit</span><span class="op" id="4492062">.</span><span class="ident" id="4492063">Lock</span><span class="op" id="4492067">(</span><span class="op" id="4492068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4492071">defer</span>&nbsp;<span class="ident" id="4492077">info</span><span class="op" id="4492081">.</span><span class="ident" id="4492082">encInit</span><span class="op" id="4492089">.</span><span class="ident" id="4492090">Unlock</span><span class="op" id="4492096">(</span><span class="op" id="4492097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4492100">enc</span><span class="op" id="4492103">,</span>&nbsp;<span class="ident" id="4492105">ok</span>&nbsp;<span class="op" id="4492108">:=</span>&nbsp;<span class="ident" id="4492111">info</span><span class="op" id="4492115">.</span><span class="ident" id="4492116">encoder</span><span class="op" id="4492123">.</span><span class="ident" id="4492124">Load</span><span class="op" id="4492128">(</span><span class="op" id="4492129">)</span><span class="op" id="4492130">.</span><span class="op" id="4492131">(</span><span class="op" id="4492132">*</span><span class="ident" id="4492133">encEngine</span><span class="op" id="4492142">)</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4492145">if</span>&nbsp;<span class="op" id="4492148">!</span><span class="ident" id="4492149">ok</span>&nbsp;<span class="op" id="4492152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4492156">if</span>&nbsp;<span class="ident" id="4492159">building</span>&nbsp;<span class="op" id="4492168">==</span>&nbsp;<span class="ident" id="4492171">nil</span>&nbsp;<span class="op" id="4492175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4492180">building</span>&nbsp;<span class="op" id="4492189">=</span>&nbsp;<span class="builtinfunc" id="4492191">make</span><span class="op" id="4492195">(</span><span class="keyword" id="4492196">map</span><span class="op" id="4492199">[</span><span class="op" id="4492200">*</span><span class="ident" id="4492201">typeInfo</span><span class="op" id="4492209">]</span><span class="builtintype" id="4492210">bool</span><span class="op" id="4492214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4492218">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4492222">building</span><span class="op" id="4492230">[</span><span class="ident" id="4492231">info</span><span class="op" id="4492235">]</span>&nbsp;<span class="op" id="4492237">=</span>&nbsp;<span class="builtintype" id="4492239">true</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4492246">enc</span>&nbsp;<span class="op" id="4492250">=</span>&nbsp;<span class="ident" id="4492252">compileEnc</span><span class="op" id="4492262">(</span><span class="ident" id="4492263">ut</span><span class="op" id="4492265">,</span>&nbsp;<span class="ident" id="4492267">building</span><span class="op" id="4492275">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4492279">info</span><span class="op" id="4492283">.</span><span class="ident" id="4492284">encoder</span><span class="op" id="4492291">.</span><span class="ident" id="4492292">Store</span><span class="op" id="4492297">(</span><span class="ident" id="4492298">enc</span><span class="op" id="4492301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4492304">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4492307">return</span>&nbsp;<span class="ident" id="4492314">enc</span><br>
<span class="lineno"></span><span class="op" id="4492318">}</span><br>
<span class="lineno">680</span><br>
<span class="lineno"></span><span class="keyword" id="4492321">func</span>&nbsp;<span class="op" id="4492326">(</span><span class="ident" id="4492327">enc</span>&nbsp;<span class="op" id="4492331">*</span><span class="ident" id="4492332">Encoder</span><span class="op" id="4492339">)</span>&nbsp;<span class="ident" id="4492341">encode</span><span class="op" id="4492347">(</span><span class="ident" id="4492348">b</span>&nbsp;<span class="op" id="4492350">*</span><span class="ident" id="4492351">encBuffer</span><span class="op" id="4492360">,</span>&nbsp;<span class="ident" id="4492362">value</span>&nbsp;<span class="ident" id="4492368">reflect</span><span class="op" id="4492375">.</span><span class="ident" id="4492376">Value</span><span class="op" id="4492381">,</span>&nbsp;<span class="ident" id="4492383">ut</span>&nbsp;<span class="op" id="4492386">*</span><span class="ident" id="4492387">userTypeInfo</span><span class="op" id="4492399">)</span>&nbsp;<span class="op" id="4492401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4492404">defer</span>&nbsp;<span class="ident" id="4492410">catchError</span><span class="op" id="4492420">(</span><span class="op" id="4492421">&amp;</span><span class="ident" id="4492422">enc</span><span class="op" id="4492425">.</span><span class="ident" id="4492426">err</span><span class="op" id="4492429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4492432">engine</span>&nbsp;<span class="op" id="4492439">:=</span>&nbsp;<span class="ident" id="4492442">getEncEngine</span><span class="op" id="4492454">(</span><span class="ident" id="4492455">ut</span><span class="op" id="4492457">,</span>&nbsp;<span class="ident" id="4492459">nil</span><span class="op" id="4492462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4492465">indir</span>&nbsp;<span class="op" id="4492471">:=</span>&nbsp;<span class="ident" id="4492474">ut</span><span class="op" id="4492476">.</span><span class="ident" id="4492477">indir</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4492484">if</span>&nbsp;<span class="ident" id="4492487">ut</span><span class="op" id="4492489">.</span><span class="ident" id="4492490">externalEnc</span>&nbsp;<span class="op" id="4492502">!=</span>&nbsp;<span class="num" id="4492505">0</span>&nbsp;<span class="op" id="4492507">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4492511">indir</span>&nbsp;<span class="op" id="4492517">=</span>&nbsp;<span class="builtintype" id="4492519">int</span><span class="op" id="4492522">(</span><span class="ident" id="4492523">ut</span><span class="op" id="4492525">.</span><span class="ident" id="4492526">encIndir</span><span class="op" id="4492534">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4492537">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4492540">for</span>&nbsp;<span class="ident" id="4492544">i</span>&nbsp;<span class="op" id="4492546">:=</span>&nbsp;<span class="num" id="4492549">0</span><span class="op" id="4492550">;</span>&nbsp;<span class="ident" id="4492552">i</span>&nbsp;<span class="op" id="4492554">&lt;</span>&nbsp;<span class="ident" id="4492556">indir</span><span class="op" id="4492561">;</span>&nbsp;<span class="ident" id="4492563">i</span><span class="op" id="4492564">++</span>&nbsp;<span class="op" id="4492567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4492571">value</span>&nbsp;<span class="op" id="4492577">=</span>&nbsp;<span class="ident" id="4492579">reflect</span><span class="op" id="4492586">.</span><span class="ident" id="4492587">Indirect</span><span class="op" id="4492595">(</span><span class="ident" id="4492596">value</span><span class="op" id="4492601">)</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4492604">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4492607">if</span>&nbsp;<span class="ident" id="4492610">ut</span><span class="op" id="4492612">.</span><span class="ident" id="4492613">externalEnc</span>&nbsp;<span class="op" id="4492625">==</span>&nbsp;<span class="num" id="4492628">0</span>&nbsp;<span class="op" id="4492630">&amp;&amp;</span>&nbsp;<span class="ident" id="4492633">value</span><span class="op" id="4492638">.</span><span class="ident" id="4492639">Type</span><span class="op" id="4492643">(</span><span class="op" id="4492644">)</span><span class="op" id="4492645">.</span><span class="ident" id="4492646">Kind</span><span class="op" id="4492650">(</span><span class="op" id="4492651">)</span>&nbsp;<span class="op" id="4492653">==</span>&nbsp;<span class="ident" id="4492656">reflect</span><span class="op" id="4492663">.</span><span class="ident" id="4492664">Struct</span>&nbsp;<span class="op" id="4492671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4492675">enc</span><span class="op" id="4492678">.</span><span class="ident" id="4492679">encodeStruct</span><span class="op" id="4492691">(</span><span class="ident" id="4492692">b</span><span class="op" id="4492693">,</span>&nbsp;<span class="ident" id="4492695">engine</span><span class="op" id="4492701">,</span>&nbsp;<span class="ident" id="4492703">value</span><span class="op" id="4492708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4492711">}</span>&nbsp;<span class="keyword" id="4492713">else</span>&nbsp;<span class="op" id="4492718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4492722">enc</span><span class="op" id="4492725">.</span><span class="ident" id="4492726">encodeSingle</span><span class="op" id="4492738">(</span><span class="ident" id="4492739">b</span><span class="op" id="4492740">,</span>&nbsp;<span class="ident" id="4492742">engine</span><span class="op" id="4492748">,</span>&nbsp;<span class="ident" id="4492750">value</span><span class="op" id="4492755">)</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4492758">}</span><br>
<span class="lineno"></span><span class="op" id="4492760">}</span>
</div>
</body>
</html>
