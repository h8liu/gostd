<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/cipher</h2>
<ul>
<li><a href="/gostd/crypto/cipher/benchmark_test.go.html">benchmark_test.go</a></li>
<li><a href="/gostd/crypto/cipher/cbc.go.html">cbc.go</a></li>
<li><a href="/gostd/crypto/cipher/cbc_aes_test.go.html">cbc_aes_test.go</a></li>
<li><a href="/gostd/crypto/cipher/cfb.go.html">cfb.go</a></li>
<li><a href="/gostd/crypto/cipher/cfb_test.go.html">cfb_test.go</a></li>
<li><a href="/gostd/crypto/cipher/cipher.go.html">cipher.go</a></li>
<li><a href="/gostd/crypto/cipher/cipher_test.go.html">cipher_test.go</a></li>
<li><a href="/gostd/crypto/cipher/common_test.go.html">common_test.go</a></li>
<li><a href="/gostd/crypto/cipher/ctr.go.html">ctr.go</a></li>
<li><a href="/gostd/crypto/cipher/ctr_aes_test.go.html">ctr_aes_test.go</a></li>
<li><a href="/gostd/crypto/cipher/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/cipher/gcm.go.html">gcm.go</a></li>
<li><a href="/gostd/crypto/cipher/gcm_test.go.html">gcm_test.go</a></li>
<li><a href="/gostd/crypto/cipher/io.go.html">io.go</a></li>
<li><a href="/gostd/crypto/cipher/ofb.go.html">ofb.go</a></li>
<li><a href="/gostd/crypto/cipher/ofb_test.go.html">ofb_test.go</a></li>
<li><a href="/gostd/crypto/cipher/xor.go.html">xor.go</a></li>
<li><a href="/gostd/crypto/cipher/xor_test.go.html">xor_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3919750">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3919805">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3919859">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3919910">//&nbsp;Cipher&nbsp;block&nbsp;chaining&nbsp;(CBC)&nbsp;mode.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3919948">//&nbsp;CBC&nbsp;provides&nbsp;confidentiality&nbsp;by&nbsp;xoring&nbsp;(chaining)&nbsp;each&nbsp;plaintext&nbsp;block</span><br>
<span class="lineno"></span><span class="comment" id="3920022">//&nbsp;with&nbsp;the&nbsp;previous&nbsp;ciphertext&nbsp;block&nbsp;before&nbsp;applying&nbsp;the&nbsp;block&nbsp;cipher.</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="comment" id="3920095">//&nbsp;See&nbsp;NIST&nbsp;SP&nbsp;800-38A,&nbsp;pp&nbsp;10-11</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3920129">package</span>&nbsp;<span class="ident" id="3920137">cipher</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3920145">type</span>&nbsp;<span class="ident" id="3920150">cbc</span>&nbsp;<span class="keyword" id="3920154">struct</span>&nbsp;<span class="op" id="3920161">{</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3920164">b</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3920174">Block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3920181">blockSize</span>&nbsp;<span class="builtintype" id="3920191">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3920196">iv</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3920206">[</span><span class="op" id="3920207">]</span><span class="builtintype" id="3920208">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3920214">tmp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3920224">[</span><span class="op" id="3920225">]</span><span class="builtintype" id="3920226">byte</span><br>
<span class="lineno"></span><span class="op" id="3920231">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="3920234">func</span>&nbsp;<span class="ident" id="3920239">newCBC</span><span class="op" id="3920245">(</span><span class="ident" id="3920246">b</span>&nbsp;<span class="ident" id="3920248">Block</span><span class="op" id="3920253">,</span>&nbsp;<span class="ident" id="3920255">iv</span>&nbsp;<span class="op" id="3920258">[</span><span class="op" id="3920259">]</span><span class="builtintype" id="3920260">byte</span><span class="op" id="3920264">)</span>&nbsp;<span class="op" id="3920266">*</span><span class="ident" id="3920267">cbc</span>&nbsp;<span class="op" id="3920271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3920274">return</span>&nbsp;<span class="op" id="3920281">&amp;</span><span class="ident" id="3920282">cbc</span><span class="op" id="3920285">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3920289">b</span><span class="op" id="3920290">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3920300">b</span><span class="op" id="3920301">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3920305">blockSize</span><span class="op" id="3920314">:</span>&nbsp;<span class="ident" id="3920316">b</span><span class="op" id="3920317">.</span><span class="ident" id="3920318">BlockSize</span><span class="op" id="3920327">(</span><span class="op" id="3920328">)</span><span class="op" id="3920329">,</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3920333">iv</span><span class="op" id="3920335">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3920344">dup</span><span class="op" id="3920347">(</span><span class="ident" id="3920348">iv</span><span class="op" id="3920350">)</span><span class="op" id="3920351">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3920355">tmp</span><span class="op" id="3920358">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3920366">make</span><span class="op" id="3920370">(</span><span class="op" id="3920371">[</span><span class="op" id="3920372">]</span><span class="builtintype" id="3920373">byte</span><span class="op" id="3920377">,</span>&nbsp;<span class="ident" id="3920379">b</span><span class="op" id="3920380">.</span><span class="ident" id="3920381">BlockSize</span><span class="op" id="3920390">(</span><span class="op" id="3920391">)</span><span class="op" id="3920392">)</span><span class="op" id="3920393">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3920396">}</span><br>
<span class="lineno"></span><span class="op" id="3920398">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span><span class="keyword" id="3920401">type</span>&nbsp;<span class="ident" id="3920406">cbcEncrypter</span>&nbsp;<span class="ident" id="3920419">cbc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3920424">//&nbsp;NewCBCEncrypter&nbsp;returns&nbsp;a&nbsp;BlockMode&nbsp;which&nbsp;encrypts&nbsp;in&nbsp;cipher&nbsp;block&nbsp;chaining</span><br>
<span class="lineno"></span><span class="comment" id="3920503">//&nbsp;mode,&nbsp;using&nbsp;the&nbsp;given&nbsp;Block.&nbsp;The&nbsp;length&nbsp;of&nbsp;iv&nbsp;must&nbsp;be&nbsp;the&nbsp;same&nbsp;as&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3920576">//&nbsp;Block&#39;s&nbsp;block&nbsp;size.</span><br>
<span class="lineno">35</span><span class="keyword" id="3920599">func</span>&nbsp;<span class="ident" id="3920604">NewCBCEncrypter</span><span class="op" id="3920619">(</span><span class="ident" id="3920620">b</span>&nbsp;<span class="ident" id="3920622">Block</span><span class="op" id="3920627">,</span>&nbsp;<span class="ident" id="3920629">iv</span>&nbsp;<span class="op" id="3920632">[</span><span class="op" id="3920633">]</span><span class="builtintype" id="3920634">byte</span><span class="op" id="3920638">)</span>&nbsp;<span class="ident" id="3920640">BlockMode</span>&nbsp;<span class="op" id="3920650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3920653">if</span>&nbsp;<span class="builtinfunc" id="3920656">len</span><span class="op" id="3920659">(</span><span class="ident" id="3920660">iv</span><span class="op" id="3920662">)</span>&nbsp;<span class="op" id="3920664">!=</span>&nbsp;<span class="ident" id="3920667">b</span><span class="op" id="3920668">.</span><span class="ident" id="3920669">BlockSize</span><span class="op" id="3920678">(</span><span class="op" id="3920679">)</span>&nbsp;<span class="op" id="3920681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3920685">panic</span><span class="op" id="3920690">(</span><span class="string" id="3920691">&#34;cipher.NewCBCEncrypter:&nbsp;IV&nbsp;length&nbsp;must&nbsp;equal&nbsp;block&nbsp;size&#34;</span><span class="op" id="3920748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3920751">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3920754">return</span>&nbsp;<span class="op" id="3920761">(</span><span class="op" id="3920762">*</span><span class="ident" id="3920763">cbcEncrypter</span><span class="op" id="3920775">)</span><span class="op" id="3920776">(</span><span class="ident" id="3920777">newCBC</span><span class="op" id="3920783">(</span><span class="ident" id="3920784">b</span><span class="op" id="3920785">,</span>&nbsp;<span class="ident" id="3920787">iv</span><span class="op" id="3920789">)</span><span class="op" id="3920790">)</span><br>
<span class="lineno">40</span><span class="op" id="3920792">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3920795">func</span>&nbsp;<span class="op" id="3920800">(</span><span class="ident" id="3920801">x</span>&nbsp;<span class="op" id="3920803">*</span><span class="ident" id="3920804">cbcEncrypter</span><span class="op" id="3920816">)</span>&nbsp;<span class="ident" id="3920818">BlockSize</span><span class="op" id="3920827">(</span><span class="op" id="3920828">)</span>&nbsp;<span class="builtintype" id="3920830">int</span>&nbsp;<span class="op" id="3920834">{</span>&nbsp;<span class="keyword" id="3920836">return</span>&nbsp;<span class="ident" id="3920843">x</span><span class="op" id="3920844">.</span><span class="ident" id="3920845">blockSize</span>&nbsp;<span class="op" id="3920855">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3920858">func</span>&nbsp;<span class="op" id="3920863">(</span><span class="ident" id="3920864">x</span>&nbsp;<span class="op" id="3920866">*</span><span class="ident" id="3920867">cbcEncrypter</span><span class="op" id="3920879">)</span>&nbsp;<span class="ident" id="3920881">CryptBlocks</span><span class="op" id="3920892">(</span><span class="ident" id="3920893">dst</span><span class="op" id="3920896">,</span>&nbsp;<span class="ident" id="3920898">src</span>&nbsp;<span class="op" id="3920902">[</span><span class="op" id="3920903">]</span><span class="builtintype" id="3920904">byte</span><span class="op" id="3920908">)</span>&nbsp;<span class="op" id="3920910">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3920913">if</span>&nbsp;<span class="builtinfunc" id="3920916">len</span><span class="op" id="3920919">(</span><span class="ident" id="3920920">src</span><span class="op" id="3920923">)</span><span class="op" id="3920924">%</span><span class="ident" id="3920925">x</span><span class="op" id="3920926">.</span><span class="ident" id="3920927">blockSize</span>&nbsp;<span class="op" id="3920937">!=</span>&nbsp;<span class="num" id="3920940">0</span>&nbsp;<span class="op" id="3920942">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3920946">panic</span><span class="op" id="3920951">(</span><span class="string" id="3920952">&#34;crypto/cipher:&nbsp;input&nbsp;not&nbsp;full&nbsp;blocks&#34;</span><span class="op" id="3920990">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3920993">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3920996">if</span>&nbsp;<span class="builtinfunc" id="3920999">len</span><span class="op" id="3921002">(</span><span class="ident" id="3921003">dst</span><span class="op" id="3921006">)</span>&nbsp;<span class="op" id="3921008">&lt;</span>&nbsp;<span class="builtinfunc" id="3921010">len</span><span class="op" id="3921013">(</span><span class="ident" id="3921014">src</span><span class="op" id="3921017">)</span>&nbsp;<span class="op" id="3921019">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3921023">panic</span><span class="op" id="3921028">(</span><span class="string" id="3921029">&#34;crypto/cipher:&nbsp;output&nbsp;smaller&nbsp;than&nbsp;input&#34;</span><span class="op" id="3921071">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3921074">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3921078">iv</span>&nbsp;<span class="op" id="3921081">:=</span>&nbsp;<span class="ident" id="3921084">x</span><span class="op" id="3921085">.</span><span class="ident" id="3921086">iv</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3921091">for</span>&nbsp;<span class="builtinfunc" id="3921095">len</span><span class="op" id="3921098">(</span><span class="ident" id="3921099">src</span><span class="op" id="3921102">)</span>&nbsp;<span class="op" id="3921104">&gt;</span>&nbsp;<span class="num" id="3921106">0</span>&nbsp;<span class="op" id="3921108">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3921112">//&nbsp;Write&nbsp;the&nbsp;xor&nbsp;to&nbsp;dst,&nbsp;then&nbsp;encrypt&nbsp;in&nbsp;place.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3921162">xorBytes</span><span class="op" id="3921170">(</span><span class="ident" id="3921171">dst</span><span class="op" id="3921174">[</span><span class="op" id="3921175">:</span><span class="ident" id="3921176">x</span><span class="op" id="3921177">.</span><span class="ident" id="3921178">blockSize</span><span class="op" id="3921187">]</span><span class="op" id="3921188">,</span>&nbsp;<span class="ident" id="3921190">src</span><span class="op" id="3921193">[</span><span class="op" id="3921194">:</span><span class="ident" id="3921195">x</span><span class="op" id="3921196">.</span><span class="ident" id="3921197">blockSize</span><span class="op" id="3921206">]</span><span class="op" id="3921207">,</span>&nbsp;<span class="ident" id="3921209">iv</span><span class="op" id="3921211">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3921215">x</span><span class="op" id="3921216">.</span><span class="ident" id="3921217">b</span><span class="op" id="3921218">.</span><span class="ident" id="3921219">Encrypt</span><span class="op" id="3921226">(</span><span class="ident" id="3921227">dst</span><span class="op" id="3921230">[</span><span class="op" id="3921231">:</span><span class="ident" id="3921232">x</span><span class="op" id="3921233">.</span><span class="ident" id="3921234">blockSize</span><span class="op" id="3921243">]</span><span class="op" id="3921244">,</span>&nbsp;<span class="ident" id="3921246">dst</span><span class="op" id="3921249">[</span><span class="op" id="3921250">:</span><span class="ident" id="3921251">x</span><span class="op" id="3921252">.</span><span class="ident" id="3921253">blockSize</span><span class="op" id="3921262">]</span><span class="op" id="3921263">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3921268">//&nbsp;Move&nbsp;to&nbsp;the&nbsp;next&nbsp;block&nbsp;with&nbsp;this&nbsp;block&nbsp;as&nbsp;the&nbsp;next&nbsp;iv.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3921328">iv</span>&nbsp;<span class="op" id="3921331">=</span>&nbsp;<span class="ident" id="3921333">dst</span><span class="op" id="3921336">[</span><span class="op" id="3921337">:</span><span class="ident" id="3921338">x</span><span class="op" id="3921339">.</span><span class="ident" id="3921340">blockSize</span><span class="op" id="3921349">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3921353">src</span>&nbsp;<span class="op" id="3921357">=</span>&nbsp;<span class="ident" id="3921359">src</span><span class="op" id="3921362">[</span><span class="ident" id="3921363">x</span><span class="op" id="3921364">.</span><span class="ident" id="3921365">blockSize</span><span class="op" id="3921374">:</span><span class="op" id="3921375">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3921379">dst</span>&nbsp;<span class="op" id="3921383">=</span>&nbsp;<span class="ident" id="3921385">dst</span><span class="op" id="3921388">[</span><span class="ident" id="3921389">x</span><span class="op" id="3921390">.</span><span class="ident" id="3921391">blockSize</span><span class="op" id="3921400">:</span><span class="op" id="3921401">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3921404">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3921408">//&nbsp;Save&nbsp;the&nbsp;iv&nbsp;for&nbsp;the&nbsp;next&nbsp;CryptBlocks&nbsp;call.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3921455">copy</span><span class="op" id="3921459">(</span><span class="ident" id="3921460">x</span><span class="op" id="3921461">.</span><span class="ident" id="3921462">iv</span><span class="op" id="3921464">,</span>&nbsp;<span class="ident" id="3921466">iv</span><span class="op" id="3921468">)</span><br>
<span class="lineno"></span><span class="op" id="3921470">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3921473">func</span>&nbsp;<span class="op" id="3921478">(</span><span class="ident" id="3921479">x</span>&nbsp;<span class="op" id="3921481">*</span><span class="ident" id="3921482">cbcEncrypter</span><span class="op" id="3921494">)</span>&nbsp;<span class="ident" id="3921496">SetIV</span><span class="op" id="3921501">(</span><span class="ident" id="3921502">iv</span>&nbsp;<span class="op" id="3921505">[</span><span class="op" id="3921506">]</span><span class="builtintype" id="3921507">byte</span><span class="op" id="3921511">)</span>&nbsp;<span class="op" id="3921513">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3921516">if</span>&nbsp;<span class="builtinfunc" id="3921519">len</span><span class="op" id="3921522">(</span><span class="ident" id="3921523">iv</span><span class="op" id="3921525">)</span>&nbsp;<span class="op" id="3921527">!=</span>&nbsp;<span class="builtinfunc" id="3921530">len</span><span class="op" id="3921533">(</span><span class="ident" id="3921534">x</span><span class="op" id="3921535">.</span><span class="ident" id="3921536">iv</span><span class="op" id="3921538">)</span>&nbsp;<span class="op" id="3921540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3921544">panic</span><span class="op" id="3921549">(</span><span class="string" id="3921550">&#34;cipher:&nbsp;incorrect&nbsp;length&nbsp;IV&#34;</span><span class="op" id="3921579">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3921582">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3921585">copy</span><span class="op" id="3921589">(</span><span class="ident" id="3921590">x</span><span class="op" id="3921591">.</span><span class="ident" id="3921592">iv</span><span class="op" id="3921594">,</span>&nbsp;<span class="ident" id="3921596">iv</span><span class="op" id="3921598">)</span><br>
<span class="lineno"></span><span class="op" id="3921600">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="keyword" id="3921603">type</span>&nbsp;<span class="ident" id="3921608">cbcDecrypter</span>&nbsp;<span class="ident" id="3921621">cbc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3921626">//&nbsp;NewCBCDecrypter&nbsp;returns&nbsp;a&nbsp;BlockMode&nbsp;which&nbsp;decrypts&nbsp;in&nbsp;cipher&nbsp;block&nbsp;chaining</span><br>
<span class="lineno"></span><span class="comment" id="3921705">//&nbsp;mode,&nbsp;using&nbsp;the&nbsp;given&nbsp;Block.&nbsp;The&nbsp;length&nbsp;of&nbsp;iv&nbsp;must&nbsp;be&nbsp;the&nbsp;same&nbsp;as&nbsp;the</span><br>
<span class="lineno">80</span><span class="comment" id="3921778">//&nbsp;Block&#39;s&nbsp;block&nbsp;size&nbsp;and&nbsp;must&nbsp;match&nbsp;the&nbsp;iv&nbsp;used&nbsp;to&nbsp;encrypt&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="3921848">func</span>&nbsp;<span class="ident" id="3921853">NewCBCDecrypter</span><span class="op" id="3921868">(</span><span class="ident" id="3921869">b</span>&nbsp;<span class="ident" id="3921871">Block</span><span class="op" id="3921876">,</span>&nbsp;<span class="ident" id="3921878">iv</span>&nbsp;<span class="op" id="3921881">[</span><span class="op" id="3921882">]</span><span class="builtintype" id="3921883">byte</span><span class="op" id="3921887">)</span>&nbsp;<span class="ident" id="3921889">BlockMode</span>&nbsp;<span class="op" id="3921899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3921902">if</span>&nbsp;<span class="builtinfunc" id="3921905">len</span><span class="op" id="3921908">(</span><span class="ident" id="3921909">iv</span><span class="op" id="3921911">)</span>&nbsp;<span class="op" id="3921913">!=</span>&nbsp;<span class="ident" id="3921916">b</span><span class="op" id="3921917">.</span><span class="ident" id="3921918">BlockSize</span><span class="op" id="3921927">(</span><span class="op" id="3921928">)</span>&nbsp;<span class="op" id="3921930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3921934">panic</span><span class="op" id="3921939">(</span><span class="string" id="3921940">&#34;cipher.NewCBCDecrypter:&nbsp;IV&nbsp;length&nbsp;must&nbsp;equal&nbsp;block&nbsp;size&#34;</span><span class="op" id="3921997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3922000">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3922003">return</span>&nbsp;<span class="op" id="3922010">(</span><span class="op" id="3922011">*</span><span class="ident" id="3922012">cbcDecrypter</span><span class="op" id="3922024">)</span><span class="op" id="3922025">(</span><span class="ident" id="3922026">newCBC</span><span class="op" id="3922032">(</span><span class="ident" id="3922033">b</span><span class="op" id="3922034">,</span>&nbsp;<span class="ident" id="3922036">iv</span><span class="op" id="3922038">)</span><span class="op" id="3922039">)</span><br>
<span class="lineno"></span><span class="op" id="3922041">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3922044">func</span>&nbsp;<span class="op" id="3922049">(</span><span class="ident" id="3922050">x</span>&nbsp;<span class="op" id="3922052">*</span><span class="ident" id="3922053">cbcDecrypter</span><span class="op" id="3922065">)</span>&nbsp;<span class="ident" id="3922067">BlockSize</span><span class="op" id="3922076">(</span><span class="op" id="3922077">)</span>&nbsp;<span class="builtintype" id="3922079">int</span>&nbsp;<span class="op" id="3922083">{</span>&nbsp;<span class="keyword" id="3922085">return</span>&nbsp;<span class="ident" id="3922092">x</span><span class="op" id="3922093">.</span><span class="ident" id="3922094">blockSize</span>&nbsp;<span class="op" id="3922104">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="keyword" id="3922107">func</span>&nbsp;<span class="op" id="3922112">(</span><span class="ident" id="3922113">x</span>&nbsp;<span class="op" id="3922115">*</span><span class="ident" id="3922116">cbcDecrypter</span><span class="op" id="3922128">)</span>&nbsp;<span class="ident" id="3922130">CryptBlocks</span><span class="op" id="3922141">(</span><span class="ident" id="3922142">dst</span><span class="op" id="3922145">,</span>&nbsp;<span class="ident" id="3922147">src</span>&nbsp;<span class="op" id="3922151">[</span><span class="op" id="3922152">]</span><span class="builtintype" id="3922153">byte</span><span class="op" id="3922157">)</span>&nbsp;<span class="op" id="3922159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3922162">if</span>&nbsp;<span class="builtinfunc" id="3922165">len</span><span class="op" id="3922168">(</span><span class="ident" id="3922169">src</span><span class="op" id="3922172">)</span><span class="op" id="3922173">%</span><span class="ident" id="3922174">x</span><span class="op" id="3922175">.</span><span class="ident" id="3922176">blockSize</span>&nbsp;<span class="op" id="3922186">!=</span>&nbsp;<span class="num" id="3922189">0</span>&nbsp;<span class="op" id="3922191">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3922195">panic</span><span class="op" id="3922200">(</span><span class="string" id="3922201">&#34;crypto/cipher:&nbsp;input&nbsp;not&nbsp;full&nbsp;blocks&#34;</span><span class="op" id="3922239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3922242">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3922245">if</span>&nbsp;<span class="builtinfunc" id="3922248">len</span><span class="op" id="3922251">(</span><span class="ident" id="3922252">dst</span><span class="op" id="3922255">)</span>&nbsp;<span class="op" id="3922257">&lt;</span>&nbsp;<span class="builtinfunc" id="3922259">len</span><span class="op" id="3922262">(</span><span class="ident" id="3922263">src</span><span class="op" id="3922266">)</span>&nbsp;<span class="op" id="3922268">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3922272">panic</span><span class="op" id="3922277">(</span><span class="string" id="3922278">&#34;crypto/cipher:&nbsp;output&nbsp;smaller&nbsp;than&nbsp;input&#34;</span><span class="op" id="3922320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3922323">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3922326">if</span>&nbsp;<span class="builtinfunc" id="3922329">len</span><span class="op" id="3922332">(</span><span class="ident" id="3922333">src</span><span class="op" id="3922336">)</span>&nbsp;<span class="op" id="3922338">==</span>&nbsp;<span class="num" id="3922341">0</span>&nbsp;<span class="op" id="3922343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3922347">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3922355">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3922359">//&nbsp;For&nbsp;each&nbsp;block,&nbsp;we&nbsp;need&nbsp;to&nbsp;xor&nbsp;the&nbsp;decrypted&nbsp;data&nbsp;with&nbsp;the&nbsp;previous&nbsp;block&#39;s&nbsp;ciphertext&nbsp;(the&nbsp;iv).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3922460">//&nbsp;To&nbsp;avoid&nbsp;making&nbsp;a&nbsp;copy&nbsp;each&nbsp;time,&nbsp;we&nbsp;loop&nbsp;over&nbsp;the&nbsp;blocks&nbsp;BACKWARDS.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3922533">end</span>&nbsp;<span class="op" id="3922537">:=</span>&nbsp;<span class="builtinfunc" id="3922540">len</span><span class="op" id="3922543">(</span><span class="ident" id="3922544">src</span><span class="op" id="3922547">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3922550">start</span>&nbsp;<span class="op" id="3922556">:=</span>&nbsp;<span class="ident" id="3922559">end</span>&nbsp;<span class="op" id="3922563">-</span>&nbsp;<span class="ident" id="3922565">x</span><span class="op" id="3922566">.</span><span class="ident" id="3922567">blockSize</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3922578">prev</span>&nbsp;<span class="op" id="3922583">:=</span>&nbsp;<span class="ident" id="3922586">start</span>&nbsp;<span class="op" id="3922592">-</span>&nbsp;<span class="ident" id="3922594">x</span><span class="op" id="3922595">.</span><span class="ident" id="3922596">blockSize</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3922608">//&nbsp;Copy&nbsp;the&nbsp;last&nbsp;block&nbsp;of&nbsp;ciphertext&nbsp;in&nbsp;preparation&nbsp;as&nbsp;the&nbsp;new&nbsp;iv.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3922676">copy</span><span class="op" id="3922680">(</span><span class="ident" id="3922681">x</span><span class="op" id="3922682">.</span><span class="ident" id="3922683">tmp</span><span class="op" id="3922686">,</span>&nbsp;<span class="ident" id="3922688">src</span><span class="op" id="3922691">[</span><span class="ident" id="3922692">start</span><span class="op" id="3922697">:</span><span class="ident" id="3922698">end</span><span class="op" id="3922701">]</span><span class="op" id="3922702">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3922706">//&nbsp;Loop&nbsp;over&nbsp;all&nbsp;but&nbsp;the&nbsp;first&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3922745">for</span>&nbsp;<span class="ident" id="3922749">start</span>&nbsp;<span class="op" id="3922755">&gt;</span>&nbsp;<span class="num" id="3922757">0</span>&nbsp;<span class="op" id="3922759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3922763">x</span><span class="op" id="3922764">.</span><span class="ident" id="3922765">b</span><span class="op" id="3922766">.</span><span class="ident" id="3922767">Decrypt</span><span class="op" id="3922774">(</span><span class="ident" id="3922775">dst</span><span class="op" id="3922778">[</span><span class="ident" id="3922779">start</span><span class="op" id="3922784">:</span><span class="ident" id="3922785">end</span><span class="op" id="3922788">]</span><span class="op" id="3922789">,</span>&nbsp;<span class="ident" id="3922791">src</span><span class="op" id="3922794">[</span><span class="ident" id="3922795">start</span><span class="op" id="3922800">:</span><span class="ident" id="3922801">end</span><span class="op" id="3922804">]</span><span class="op" id="3922805">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3922809">xorBytes</span><span class="op" id="3922817">(</span><span class="ident" id="3922818">dst</span><span class="op" id="3922821">[</span><span class="ident" id="3922822">start</span><span class="op" id="3922827">:</span><span class="ident" id="3922828">end</span><span class="op" id="3922831">]</span><span class="op" id="3922832">,</span>&nbsp;<span class="ident" id="3922834">dst</span><span class="op" id="3922837">[</span><span class="ident" id="3922838">start</span><span class="op" id="3922843">:</span><span class="ident" id="3922844">end</span><span class="op" id="3922847">]</span><span class="op" id="3922848">,</span>&nbsp;<span class="ident" id="3922850">src</span><span class="op" id="3922853">[</span><span class="ident" id="3922854">prev</span><span class="op" id="3922858">:</span><span class="ident" id="3922859">start</span><span class="op" id="3922864">]</span><span class="op" id="3922865">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3922870">end</span>&nbsp;<span class="op" id="3922874">=</span>&nbsp;<span class="ident" id="3922876">start</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3922884">start</span>&nbsp;<span class="op" id="3922890">=</span>&nbsp;<span class="ident" id="3922892">prev</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3922899">prev</span>&nbsp;<span class="op" id="3922904">-=</span>&nbsp;<span class="ident" id="3922907">x</span><span class="op" id="3922908">.</span><span class="ident" id="3922909">blockSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3922920">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3922924">//&nbsp;The&nbsp;first&nbsp;block&nbsp;is&nbsp;special&nbsp;because&nbsp;it&nbsp;uses&nbsp;the&nbsp;saved&nbsp;iv.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3922985">x</span><span class="op" id="3922986">.</span><span class="ident" id="3922987">b</span><span class="op" id="3922988">.</span><span class="ident" id="3922989">Decrypt</span><span class="op" id="3922996">(</span><span class="ident" id="3922997">dst</span><span class="op" id="3923000">[</span><span class="ident" id="3923001">start</span><span class="op" id="3923006">:</span><span class="ident" id="3923007">end</span><span class="op" id="3923010">]</span><span class="op" id="3923011">,</span>&nbsp;<span class="ident" id="3923013">src</span><span class="op" id="3923016">[</span><span class="ident" id="3923017">start</span><span class="op" id="3923022">:</span><span class="ident" id="3923023">end</span><span class="op" id="3923026">]</span><span class="op" id="3923027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3923030">xorBytes</span><span class="op" id="3923038">(</span><span class="ident" id="3923039">dst</span><span class="op" id="3923042">[</span><span class="ident" id="3923043">start</span><span class="op" id="3923048">:</span><span class="ident" id="3923049">end</span><span class="op" id="3923052">]</span><span class="op" id="3923053">,</span>&nbsp;<span class="ident" id="3923055">dst</span><span class="op" id="3923058">[</span><span class="ident" id="3923059">start</span><span class="op" id="3923064">:</span><span class="ident" id="3923065">end</span><span class="op" id="3923068">]</span><span class="op" id="3923069">,</span>&nbsp;<span class="ident" id="3923071">x</span><span class="op" id="3923072">.</span><span class="ident" id="3923073">iv</span><span class="op" id="3923075">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3923079">//&nbsp;Set&nbsp;the&nbsp;new&nbsp;iv&nbsp;to&nbsp;the&nbsp;first&nbsp;block&nbsp;we&nbsp;copied&nbsp;earlier.</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3923136">x</span><span class="op" id="3923137">.</span><span class="ident" id="3923138">iv</span><span class="op" id="3923140">,</span>&nbsp;<span class="ident" id="3923142">x</span><span class="op" id="3923143">.</span><span class="ident" id="3923144">tmp</span>&nbsp;<span class="op" id="3923148">=</span>&nbsp;<span class="ident" id="3923150">x</span><span class="op" id="3923151">.</span><span class="ident" id="3923152">tmp</span><span class="op" id="3923155">,</span>&nbsp;<span class="ident" id="3923157">x</span><span class="op" id="3923158">.</span><span class="ident" id="3923159">iv</span><br>
<span class="lineno"></span><span class="op" id="3923162">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3923165">func</span>&nbsp;<span class="op" id="3923170">(</span><span class="ident" id="3923171">x</span>&nbsp;<span class="op" id="3923173">*</span><span class="ident" id="3923174">cbcDecrypter</span><span class="op" id="3923186">)</span>&nbsp;<span class="ident" id="3923188">SetIV</span><span class="op" id="3923193">(</span><span class="ident" id="3923194">iv</span>&nbsp;<span class="op" id="3923197">[</span><span class="op" id="3923198">]</span><span class="builtintype" id="3923199">byte</span><span class="op" id="3923203">)</span>&nbsp;<span class="op" id="3923205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3923208">if</span>&nbsp;<span class="builtinfunc" id="3923211">len</span><span class="op" id="3923214">(</span><span class="ident" id="3923215">iv</span><span class="op" id="3923217">)</span>&nbsp;<span class="op" id="3923219">!=</span>&nbsp;<span class="builtinfunc" id="3923222">len</span><span class="op" id="3923225">(</span><span class="ident" id="3923226">x</span><span class="op" id="3923227">.</span><span class="ident" id="3923228">iv</span><span class="op" id="3923230">)</span>&nbsp;<span class="op" id="3923232">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3923236">panic</span><span class="op" id="3923241">(</span><span class="string" id="3923242">&#34;cipher:&nbsp;incorrect&nbsp;length&nbsp;IV&#34;</span><span class="op" id="3923271">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3923274">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3923277">copy</span><span class="op" id="3923281">(</span><span class="ident" id="3923282">x</span><span class="op" id="3923283">.</span><span class="ident" id="3923284">iv</span><span class="op" id="3923286">,</span>&nbsp;<span class="ident" id="3923288">iv</span><span class="op" id="3923290">)</span><br>
<span class="lineno"></span><span class="op" id="3923292">}</span>
</div>
</body>
</html>
