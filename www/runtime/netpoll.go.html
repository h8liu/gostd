<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="1624087">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1624142">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1624196">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1624247">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;nacl&nbsp;netbsd&nbsp;openbsd&nbsp;solaris&nbsp;windows</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1624325">package</span>&nbsp;<span class="ident" id="1624333">runtime</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1624342">import</span>&nbsp;<span class="string" id="1624349">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span><span class="comment" id="1624359">//&nbsp;Integrated&nbsp;network&nbsp;poller&nbsp;(platform-independent&nbsp;part).</span><br>
<span class="lineno"></span><span class="comment" id="1624417">//&nbsp;A&nbsp;particular&nbsp;implementation&nbsp;(epoll/kqueue)&nbsp;must&nbsp;define&nbsp;the&nbsp;following&nbsp;functions:</span><br>
<span class="lineno"></span><span class="comment" id="1624500">//&nbsp;func&nbsp;netpollinit()&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;to&nbsp;initialize&nbsp;the&nbsp;poller</span><br>
<span class="lineno"></span><span class="comment" id="1624552">//&nbsp;func&nbsp;netpollopen(fd&nbsp;uintptr,&nbsp;pd&nbsp;*pollDesc)&nbsp;int32&nbsp;&nbsp;&nbsp;&nbsp//&nbsp;to&nbsp;arm&nbsp;edge-triggered&nbsp;notifications</span><br>
<span class="lineno">15</span><span class="comment" id="1624643">//&nbsp;and&nbsp;associate&nbsp;fd&nbsp;with&nbsp;pd.</span><br>
<span class="lineno"></span><span class="comment" id="1624672">//&nbsp;An&nbsp;implementation&nbsp;must&nbsp;call&nbsp;the&nbsp;following&nbsp;function&nbsp;to&nbsp;denote&nbsp;that&nbsp;the&nbsp;pd&nbsp;is&nbsp;ready.</span><br>
<span class="lineno"></span><span class="comment" id="1624758">//&nbsp;func&nbsp;netpollready(gpp&nbsp;**g,&nbsp;pd&nbsp;*pollDesc,&nbsp;mode&nbsp;int32)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1624815">//&nbsp;pollDesc&nbsp;contains&nbsp;2&nbsp;binary&nbsp;semaphores,&nbsp;rg&nbsp;and&nbsp;wg,&nbsp;to&nbsp;park&nbsp;reader&nbsp;and&nbsp;writer</span><br>
<span class="lineno">20</span><span class="comment" id="1624894">//&nbsp;goroutines&nbsp;respectively.&nbsp;The&nbsp;semaphore&nbsp;can&nbsp;be&nbsp;in&nbsp;the&nbsp;following&nbsp;states:</span><br>
<span class="lineno"></span><span class="comment" id="1624968">//&nbsp;pdReady&nbsp;-&nbsp;io&nbsp;readiness&nbsp;notification&nbsp;is&nbsp;pending;</span><br>
<span class="lineno"></span><span class="comment" id="1625019">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a&nbsp;goroutine&nbsp;consumes&nbsp;the&nbsp;notification&nbsp;by&nbsp;changing&nbsp;the&nbsp;state&nbsp;to&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="1625100">//&nbsp;pdWait&nbsp;-&nbsp;a&nbsp;goroutine&nbsp;prepares&nbsp;to&nbsp;park&nbsp;on&nbsp;the&nbsp;semaphore,&nbsp;but&nbsp;not&nbsp;yet&nbsp;parked;</span><br>
<span class="lineno"></span><span class="comment" id="1625179">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;goroutine&nbsp;commits&nbsp;to&nbsp;park&nbsp;by&nbsp;changing&nbsp;the&nbsp;state&nbsp;to&nbsp;G&nbsp;pointer,</span><br>
<span class="lineno">25</span><span class="comment" id="1625257">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or,&nbsp;alternatively,&nbsp;concurrent&nbsp;io&nbsp;notification&nbsp;changes&nbsp;the&nbsp;state&nbsp;to&nbsp;READY,</span><br>
<span class="lineno"></span><span class="comment" id="1625343">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or,&nbsp;alternatively,&nbsp;concurrent&nbsp;timeout/close&nbsp;changes&nbsp;the&nbsp;state&nbsp;to&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="1625425">//&nbsp;G&nbsp;pointer&nbsp;-&nbsp;the&nbsp;goroutine&nbsp;is&nbsp;blocked&nbsp;on&nbsp;the&nbsp;semaphore;</span><br>
<span class="lineno"></span><span class="comment" id="1625483">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;io&nbsp;notification&nbsp;or&nbsp;timeout/close&nbsp;changes&nbsp;the&nbsp;state&nbsp;to&nbsp;READY&nbsp;or&nbsp;nil&nbsp;respectively</span><br>
<span class="lineno"></span><span class="comment" id="1625578">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;unparks&nbsp;the&nbsp;goroutine.</span><br>
<span class="lineno">30</span><span class="comment" id="1625620">//&nbsp;nil&nbsp;-&nbsp;nothing&nbsp;of&nbsp;the&nbsp;above.</span><br>
<span class="lineno"></span><span class="keyword" id="1625651">const</span>&nbsp;<span class="op" id="1625657">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1625660">pdReady</span>&nbsp;<span class="builtintype" id="1625668">uintptr</span>&nbsp;<span class="op" id="1625676">=</span>&nbsp;<span class="num" id="1625678">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1625681">pdWait</span>&nbsp;&nbsp;<span class="builtintype" id="1625689">uintptr</span>&nbsp;<span class="op" id="1625697">=</span>&nbsp;<span class="num" id="1625699">2</span><br>
<span class="lineno"></span><span class="op" id="1625701">)</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="1625704">const</span>&nbsp;<span class="ident" id="1625710">pollBlockSize</span>&nbsp;<span class="op" id="1625724">=</span>&nbsp;<span class="num" id="1625726">4</span>&nbsp;<span class="op" id="1625728">*</span>&nbsp;<span class="num" id="1625730">1024</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1625736">//&nbsp;Network&nbsp;poller&nbsp;descriptor.</span><br>
<span class="lineno"></span><span class="keyword" id="1625766">type</span>&nbsp;<span class="ident" id="1625771">pollDesc</span>&nbsp;<span class="keyword" id="1625780">struct</span>&nbsp;<span class="op" id="1625787">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1625790">link</span>&nbsp;<span class="op" id="1625795">*</span><span class="ident" id="1625796">pollDesc</span>&nbsp;<span class="comment" id="1625805">//&nbsp;in&nbsp;pollcache,&nbsp;protected&nbsp;by&nbsp;pollcache.lock</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1625852">//&nbsp;The&nbsp;lock&nbsp;protects&nbsp;pollOpen,&nbsp;pollSetDeadline,&nbsp;pollUnblock&nbsp;and&nbsp;deadlineimpl&nbsp;operations.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1625942">//&nbsp;This&nbsp;fully&nbsp;covers&nbsp;seq,&nbsp;rt&nbsp;and&nbsp;wt&nbsp;variables.&nbsp;fd&nbsp;is&nbsp;constant&nbsp;throughout&nbsp;the&nbsp;PollDesc&nbsp;lifetime.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1626039">//&nbsp;pollReset,&nbsp;pollWait,&nbsp;pollWaitCanceled&nbsp;and&nbsp;runtimeÂ·netpollready&nbsp;(IO&nbsp;readiness&nbsp;notification)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1626135">//&nbsp;proceed&nbsp;w/o&nbsp;taking&nbsp;the&nbsp;lock.&nbsp;So&nbsp;closing,&nbsp;rg,&nbsp;rd,&nbsp;wg&nbsp;and&nbsp;wd&nbsp;are&nbsp;manipulated</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1626214">//&nbsp;in&nbsp;a&nbsp;lock-free&nbsp;way&nbsp;by&nbsp;all&nbsp;operations.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1626256">//&nbsp;NOTE(dvyukov):&nbsp;the&nbsp;following&nbsp;code&nbsp;uses&nbsp;uintptr&nbsp;to&nbsp;store&nbsp;*g&nbsp;(rg/wg),</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1626328">//&nbsp;that&nbsp;will&nbsp;blow&nbsp;up&nbsp;when&nbsp;GC&nbsp;starts&nbsp;moving&nbsp;objects.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626381">lock</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1626389">mutex</span>&nbsp;<span class="comment" id="1626395">//&nbsp;protectes&nbsp;the&nbsp;following&nbsp;fields</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626430">fd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1626438">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626447">closing</span>&nbsp;<span class="builtintype" id="1626455">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626461">seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1626469">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1626484">//&nbsp;protects&nbsp;from&nbsp;stale&nbsp;timers&nbsp;and&nbsp;ready&nbsp;notifications</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626539">rg</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1626547">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1626562">//&nbsp;pdReady,&nbsp;pdWait,&nbsp;G&nbsp;waiting&nbsp;for&nbsp;read&nbsp;or&nbsp;nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626609">rt</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1626617">timer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1626632">//&nbsp;read&nbsp;deadline&nbsp;timer&nbsp;(set&nbsp;if&nbsp;rt.f&nbsp;!=&nbsp;nil)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626677">rd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1626685">int64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1626700">//&nbsp;read&nbsp;deadline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626718">wg</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1626726">uintptr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1626741">//&nbsp;pdReady,&nbsp;pdWait,&nbsp;G&nbsp;waiting&nbsp;for&nbsp;write&nbsp;or&nbsp;nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626789">wt</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1626797">timer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1626812">//&nbsp;write&nbsp;deadline&nbsp;timer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626837">wd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1626845">int64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="1626860">//&nbsp;write&nbsp;deadline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626879">user</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1626887">unsafe</span><span class="op" id="1626893">.</span><span class="ident" id="1626894">Pointer</span>&nbsp;<span class="comment" id="1626902">//&nbsp;user&nbsp;settable&nbsp;cookie</span><br>
<span class="lineno">60</span><span class="op" id="1626926">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1626929">type</span>&nbsp;<span class="ident" id="1626934">pollCache</span>&nbsp;<span class="keyword" id="1626944">struct</span>&nbsp;<span class="op" id="1626951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626954">lock</span>&nbsp;&nbsp;<span class="ident" id="1626960">mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1626967">first</span>&nbsp;<span class="op" id="1626973">*</span><span class="ident" id="1626974">pollDesc</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1626984">//&nbsp;PollDesc&nbsp;objects&nbsp;must&nbsp;be&nbsp;type-stable,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1627026">//&nbsp;because&nbsp;we&nbsp;can&nbsp;get&nbsp;ready&nbsp;notification&nbsp;from&nbsp;epoll/kqueue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1627086">//&nbsp;after&nbsp;the&nbsp;descriptor&nbsp;is&nbsp;closed/reused.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1627129">//&nbsp;Stale&nbsp;notifications&nbsp;are&nbsp;detected&nbsp;using&nbsp;seq&nbsp;variable,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1627186">//&nbsp;seq&nbsp;is&nbsp;incremented&nbsp;when&nbsp;deadlines&nbsp;are&nbsp;changed&nbsp;or&nbsp;descriptor&nbsp;is&nbsp;reused.</span><br>
<span class="lineno">70</span><span class="op" id="1627260">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1627263">var</span>&nbsp;<span class="ident" id="1627267">pollcache</span>&nbsp;<span class="ident" id="1627277">pollCache</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1627288">func</span>&nbsp;<span class="ident" id="1627293">netpollServerInit</span><span class="op" id="1627310">(</span><span class="op" id="1627311">)</span>&nbsp;<span class="op" id="1627313">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627316">onM</span><span class="op" id="1627319">(</span><span class="ident" id="1627320">netpollinit</span><span class="op" id="1627331">)</span><br>
<span class="lineno"></span><span class="op" id="1627333">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1627336">func</span>&nbsp;<span class="ident" id="1627341">netpollOpen</span><span class="op" id="1627352">(</span><span class="ident" id="1627353">fd</span>&nbsp;<span class="builtintype" id="1627356">uintptr</span><span class="op" id="1627363">)</span>&nbsp;<span class="op" id="1627365">(</span><span class="op" id="1627366">*</span><span class="ident" id="1627367">pollDesc</span><span class="op" id="1627375">,</span>&nbsp;<span class="builtintype" id="1627377">int</span><span class="op" id="1627380">)</span>&nbsp;<span class="op" id="1627382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627385">pd</span>&nbsp;<span class="op" id="1627388">:=</span>&nbsp;<span class="ident" id="1627391">pollcache</span><span class="op" id="1627400">.</span><span class="ident" id="1627401">alloc</span><span class="op" id="1627406">(</span><span class="op" id="1627407">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627410">lock</span><span class="op" id="1627414">(</span><span class="op" id="1627415">&amp;</span><span class="ident" id="1627416">pd</span><span class="op" id="1627418">.</span><span class="ident" id="1627419">lock</span><span class="op" id="1627423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1627426">if</span>&nbsp;<span class="ident" id="1627429">pd</span><span class="op" id="1627431">.</span><span class="ident" id="1627432">wg</span>&nbsp;<span class="op" id="1627435">!=</span>&nbsp;<span class="num" id="1627438">0</span>&nbsp;<span class="op" id="1627440">&amp;&amp;</span>&nbsp;<span class="ident" id="1627443">pd</span><span class="op" id="1627445">.</span><span class="ident" id="1627446">wg</span>&nbsp;<span class="op" id="1627449">!=</span>&nbsp;<span class="ident" id="1627452">pdReady</span>&nbsp;<span class="op" id="1627460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627464">gothrow</span><span class="op" id="1627471">(</span><span class="string" id="1627472">&#34;netpollOpen:&nbsp;blocked&nbsp;write&nbsp;on&nbsp;free&nbsp;descriptor&#34;</span><span class="op" id="1627519">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1627522">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1627525">if</span>&nbsp;<span class="ident" id="1627528">pd</span><span class="op" id="1627530">.</span><span class="ident" id="1627531">rg</span>&nbsp;<span class="op" id="1627534">!=</span>&nbsp;<span class="num" id="1627537">0</span>&nbsp;<span class="op" id="1627539">&amp;&amp;</span>&nbsp;<span class="ident" id="1627542">pd</span><span class="op" id="1627544">.</span><span class="ident" id="1627545">rg</span>&nbsp;<span class="op" id="1627548">!=</span>&nbsp;<span class="ident" id="1627551">pdReady</span>&nbsp;<span class="op" id="1627559">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627563">gothrow</span><span class="op" id="1627570">(</span><span class="string" id="1627571">&#34;netpollOpen:&nbsp;blocked&nbsp;read&nbsp;on&nbsp;free&nbsp;descriptor&#34;</span><span class="op" id="1627617">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1627620">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627623">pd</span><span class="op" id="1627625">.</span><span class="ident" id="1627626">fd</span>&nbsp;<span class="op" id="1627629">=</span>&nbsp;<span class="ident" id="1627631">fd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627635">pd</span><span class="op" id="1627637">.</span><span class="ident" id="1627638">closing</span>&nbsp;<span class="op" id="1627646">=</span>&nbsp;<span class="ident" id="1627648">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627655">pd</span><span class="op" id="1627657">.</span><span class="ident" id="1627658">seq</span><span class="op" id="1627661">++</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627665">pd</span><span class="op" id="1627667">.</span><span class="ident" id="1627668">rg</span>&nbsp;<span class="op" id="1627671">=</span>&nbsp;<span class="num" id="1627673">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627676">pd</span><span class="op" id="1627678">.</span><span class="ident" id="1627679">rd</span>&nbsp;<span class="op" id="1627682">=</span>&nbsp;<span class="num" id="1627684">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627687">pd</span><span class="op" id="1627689">.</span><span class="ident" id="1627690">wg</span>&nbsp;<span class="op" id="1627693">=</span>&nbsp;<span class="num" id="1627695">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627698">pd</span><span class="op" id="1627700">.</span><span class="ident" id="1627701">wd</span>&nbsp;<span class="op" id="1627704">=</span>&nbsp;<span class="num" id="1627706">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627709">unlock</span><span class="op" id="1627715">(</span><span class="op" id="1627716">&amp;</span><span class="ident" id="1627717">pd</span><span class="op" id="1627719">.</span><span class="ident" id="1627720">lock</span><span class="op" id="1627724">)</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1627728">var</span>&nbsp;<span class="ident" id="1627732">errno</span>&nbsp;<span class="builtintype" id="1627738">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627745">onM</span><span class="op" id="1627748">(</span><span class="keyword" id="1627749">func</span><span class="op" id="1627753">(</span><span class="op" id="1627754">)</span>&nbsp;<span class="op" id="1627756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627760">errno</span>&nbsp;<span class="op" id="1627766">=</span>&nbsp;<span class="ident" id="1627768">netpollopen</span><span class="op" id="1627779">(</span><span class="ident" id="1627780">fd</span><span class="op" id="1627782">,</span>&nbsp;<span class="ident" id="1627784">pd</span><span class="op" id="1627786">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1627789">}</span><span class="op" id="1627790">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1627793">return</span>&nbsp;<span class="ident" id="1627800">pd</span><span class="op" id="1627802">,</span>&nbsp;<span class="builtintype" id="1627804">int</span><span class="op" id="1627807">(</span><span class="ident" id="1627808">errno</span><span class="op" id="1627813">)</span><br>
<span class="lineno"></span><span class="op" id="1627815">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1627818">func</span>&nbsp;<span class="ident" id="1627823">netpollClose</span><span class="op" id="1627835">(</span><span class="ident" id="1627836">pd</span>&nbsp;<span class="op" id="1627839">*</span><span class="ident" id="1627840">pollDesc</span><span class="op" id="1627848">)</span>&nbsp;<span class="op" id="1627850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1627853">if</span>&nbsp;<span class="op" id="1627856">!</span><span class="ident" id="1627857">pd</span><span class="op" id="1627859">.</span><span class="ident" id="1627860">closing</span>&nbsp;<span class="op" id="1627868">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627872">gothrow</span><span class="op" id="1627879">(</span><span class="string" id="1627880">&#34;netpollClose:&nbsp;close&nbsp;w/o&nbsp;unblock&#34;</span><span class="op" id="1627913">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1627916">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1627919">if</span>&nbsp;<span class="ident" id="1627922">pd</span><span class="op" id="1627924">.</span><span class="ident" id="1627925">wg</span>&nbsp;<span class="op" id="1627928">!=</span>&nbsp;<span class="num" id="1627931">0</span>&nbsp;<span class="op" id="1627933">&amp;&amp;</span>&nbsp;<span class="ident" id="1627936">pd</span><span class="op" id="1627938">.</span><span class="ident" id="1627939">wg</span>&nbsp;<span class="op" id="1627942">!=</span>&nbsp;<span class="ident" id="1627945">pdReady</span>&nbsp;<span class="op" id="1627953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1627957">gothrow</span><span class="op" id="1627964">(</span><span class="string" id="1627965">&#34;netpollClose:&nbsp;blocked&nbsp;write&nbsp;on&nbsp;closing&nbsp;descriptor&#34;</span><span class="op" id="1628016">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1628019">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1628022">if</span>&nbsp;<span class="ident" id="1628025">pd</span><span class="op" id="1628027">.</span><span class="ident" id="1628028">rg</span>&nbsp;<span class="op" id="1628031">!=</span>&nbsp;<span class="num" id="1628034">0</span>&nbsp;<span class="op" id="1628036">&amp;&amp;</span>&nbsp;<span class="ident" id="1628039">pd</span><span class="op" id="1628041">.</span><span class="ident" id="1628042">rg</span>&nbsp;<span class="op" id="1628045">!=</span>&nbsp;<span class="ident" id="1628048">pdReady</span>&nbsp;<span class="op" id="1628056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628060">gothrow</span><span class="op" id="1628067">(</span><span class="string" id="1628068">&#34;netpollClose:&nbsp;blocked&nbsp;read&nbsp;on&nbsp;closing&nbsp;descriptor&#34;</span><span class="op" id="1628118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1628121">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628124">onM</span><span class="op" id="1628127">(</span><span class="keyword" id="1628128">func</span><span class="op" id="1628132">(</span><span class="op" id="1628133">)</span>&nbsp;<span class="op" id="1628135">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628139">netpollclose</span><span class="op" id="1628151">(</span><span class="builtintype" id="1628152">uintptr</span><span class="op" id="1628159">(</span><span class="ident" id="1628160">pd</span><span class="op" id="1628162">.</span><span class="ident" id="1628163">fd</span><span class="op" id="1628165">)</span><span class="op" id="1628166">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1628169">}</span><span class="op" id="1628170">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628173">pollcache</span><span class="op" id="1628182">.</span><span class="ident" id="1628183">free</span><span class="op" id="1628187">(</span><span class="ident" id="1628188">pd</span><span class="op" id="1628190">)</span><br>
<span class="lineno"></span><span class="op" id="1628192">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1628195">func</span>&nbsp;<span class="op" id="1628200">(</span><span class="ident" id="1628201">c</span>&nbsp;<span class="op" id="1628203">*</span><span class="ident" id="1628204">pollCache</span><span class="op" id="1628213">)</span>&nbsp;<span class="ident" id="1628215">free</span><span class="op" id="1628219">(</span><span class="ident" id="1628220">pd</span>&nbsp;<span class="op" id="1628223">*</span><span class="ident" id="1628224">pollDesc</span><span class="op" id="1628232">)</span>&nbsp;<span class="op" id="1628234">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628237">lock</span><span class="op" id="1628241">(</span><span class="op" id="1628242">&amp;</span><span class="ident" id="1628243">c</span><span class="op" id="1628244">.</span><span class="ident" id="1628245">lock</span><span class="op" id="1628249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628252">pd</span><span class="op" id="1628254">.</span><span class="ident" id="1628255">link</span>&nbsp;<span class="op" id="1628260">=</span>&nbsp;<span class="ident" id="1628262">c</span><span class="op" id="1628263">.</span><span class="ident" id="1628264">first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628271">c</span><span class="op" id="1628272">.</span><span class="ident" id="1628273">first</span>&nbsp;<span class="op" id="1628279">=</span>&nbsp;<span class="ident" id="1628281">pd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628285">unlock</span><span class="op" id="1628291">(</span><span class="op" id="1628292">&amp;</span><span class="ident" id="1628293">c</span><span class="op" id="1628294">.</span><span class="ident" id="1628295">lock</span><span class="op" id="1628299">)</span><br>
<span class="lineno"></span><span class="op" id="1628301">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="keyword" id="1628304">func</span>&nbsp;<span class="ident" id="1628309">netpollReset</span><span class="op" id="1628321">(</span><span class="ident" id="1628322">pd</span>&nbsp;<span class="op" id="1628325">*</span><span class="ident" id="1628326">pollDesc</span><span class="op" id="1628334">,</span>&nbsp;<span class="ident" id="1628336">mode</span>&nbsp;<span class="builtintype" id="1628341">int</span><span class="op" id="1628344">)</span>&nbsp;<span class="builtintype" id="1628346">int</span>&nbsp;<span class="op" id="1628350">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628353">err</span>&nbsp;<span class="op" id="1628357">:=</span>&nbsp;<span class="ident" id="1628360">netpollcheckerr</span><span class="op" id="1628375">(</span><span class="ident" id="1628376">pd</span><span class="op" id="1628378">,</span>&nbsp;<span class="builtintype" id="1628380">int32</span><span class="op" id="1628385">(</span><span class="ident" id="1628386">mode</span><span class="op" id="1628390">)</span><span class="op" id="1628391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1628394">if</span>&nbsp;<span class="ident" id="1628397">err</span>&nbsp;<span class="op" id="1628401">!=</span>&nbsp;<span class="num" id="1628404">0</span>&nbsp;<span class="op" id="1628406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1628410">return</span>&nbsp;<span class="ident" id="1628417">err</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1628422">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1628425">if</span>&nbsp;<span class="ident" id="1628428">mode</span>&nbsp;<span class="op" id="1628433">==</span>&nbsp;<span class="string" id="1628436">&#39;r&#39;</span>&nbsp;<span class="op" id="1628440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628444">pd</span><span class="op" id="1628446">.</span><span class="ident" id="1628447">rg</span>&nbsp;<span class="op" id="1628450">=</span>&nbsp;<span class="num" id="1628452">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1628455">}</span>&nbsp;<span class="keyword" id="1628457">else</span>&nbsp;<span class="keyword" id="1628462">if</span>&nbsp;<span class="ident" id="1628465">mode</span>&nbsp;<span class="op" id="1628470">==</span>&nbsp;<span class="string" id="1628473">&#39;w&#39;</span>&nbsp;<span class="op" id="1628477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628481">pd</span><span class="op" id="1628483">.</span><span class="ident" id="1628484">wg</span>&nbsp;<span class="op" id="1628487">=</span>&nbsp;<span class="num" id="1628489">0</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1628492">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1628495">return</span>&nbsp;<span class="num" id="1628502">0</span><br>
<span class="lineno"></span><span class="op" id="1628504">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1628507">func</span>&nbsp;<span class="ident" id="1628512">netpollWait</span><span class="op" id="1628523">(</span><span class="ident" id="1628524">pd</span>&nbsp;<span class="op" id="1628527">*</span><span class="ident" id="1628528">pollDesc</span><span class="op" id="1628536">,</span>&nbsp;<span class="ident" id="1628538">mode</span>&nbsp;<span class="builtintype" id="1628543">int</span><span class="op" id="1628546">)</span>&nbsp;<span class="builtintype" id="1628548">int</span>&nbsp;<span class="op" id="1628552">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628555">err</span>&nbsp;<span class="op" id="1628559">:=</span>&nbsp;<span class="ident" id="1628562">netpollcheckerr</span><span class="op" id="1628577">(</span><span class="ident" id="1628578">pd</span><span class="op" id="1628580">,</span>&nbsp;<span class="builtintype" id="1628582">int32</span><span class="op" id="1628587">(</span><span class="ident" id="1628588">mode</span><span class="op" id="1628592">)</span><span class="op" id="1628593">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1628596">if</span>&nbsp;<span class="ident" id="1628599">err</span>&nbsp;<span class="op" id="1628603">!=</span>&nbsp;<span class="num" id="1628606">0</span>&nbsp;<span class="op" id="1628608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1628612">return</span>&nbsp;<span class="ident" id="1628619">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1628624">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1628627">//&nbsp;As&nbsp;for&nbsp;now&nbsp;only&nbsp;Solaris&nbsp;uses&nbsp;level-triggered&nbsp;IO.</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1628680">if</span>&nbsp;<span class="ident" id="1628683">GOOS</span>&nbsp;<span class="op" id="1628688">==</span>&nbsp;<span class="string" id="1628691">&#34;solaris&#34;</span>&nbsp;<span class="op" id="1628701">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628705">onM</span><span class="op" id="1628708">(</span><span class="keyword" id="1628709">func</span><span class="op" id="1628713">(</span><span class="op" id="1628714">)</span>&nbsp;<span class="op" id="1628716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628721">netpollarm</span><span class="op" id="1628731">(</span><span class="ident" id="1628732">pd</span><span class="op" id="1628734">,</span>&nbsp;<span class="ident" id="1628736">mode</span><span class="op" id="1628740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1628744">}</span><span class="op" id="1628745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1628748">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1628751">for</span>&nbsp;<span class="op" id="1628755">!</span><span class="ident" id="1628756">netpollblock</span><span class="op" id="1628768">(</span><span class="ident" id="1628769">pd</span><span class="op" id="1628771">,</span>&nbsp;<span class="builtintype" id="1628773">int32</span><span class="op" id="1628778">(</span><span class="ident" id="1628779">mode</span><span class="op" id="1628783">)</span><span class="op" id="1628784">,</span>&nbsp;<span class="ident" id="1628786">false</span><span class="op" id="1628791">)</span>&nbsp;<span class="op" id="1628793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1628797">err</span>&nbsp;<span class="op" id="1628801">=</span>&nbsp;<span class="ident" id="1628803">netpollcheckerr</span><span class="op" id="1628818">(</span><span class="ident" id="1628819">pd</span><span class="op" id="1628821">,</span>&nbsp;<span class="builtintype" id="1628823">int32</span><span class="op" id="1628828">(</span><span class="ident" id="1628829">mode</span><span class="op" id="1628833">)</span><span class="op" id="1628834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1628838">if</span>&nbsp;<span class="ident" id="1628841">err</span>&nbsp;<span class="op" id="1628845">!=</span>&nbsp;<span class="num" id="1628848">0</span>&nbsp;<span class="op" id="1628850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1628855">return</span>&nbsp;<span class="ident" id="1628862">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1628868">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1628872">//&nbsp;Can&nbsp;happen&nbsp;if&nbsp;timeout&nbsp;has&nbsp;fired&nbsp;and&nbsp;unblocked&nbsp;us,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1628927">//&nbsp;but&nbsp;before&nbsp;we&nbsp;had&nbsp;a&nbsp;chance&nbsp;to&nbsp;run,&nbsp;timeout&nbsp;has&nbsp;been&nbsp;reset.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1628991">//&nbsp;Pretend&nbsp;it&nbsp;has&nbsp;not&nbsp;happened&nbsp;and&nbsp;retry.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1629034">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1629037">return</span>&nbsp;<span class="num" id="1629044">0</span><br>
<span class="lineno">160</span><span class="op" id="1629046">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1629049">func</span>&nbsp;<span class="ident" id="1629054">netpollWaitCanceled</span><span class="op" id="1629073">(</span><span class="ident" id="1629074">pd</span>&nbsp;<span class="op" id="1629077">*</span><span class="ident" id="1629078">pollDesc</span><span class="op" id="1629086">,</span>&nbsp;<span class="ident" id="1629088">mode</span>&nbsp;<span class="builtintype" id="1629093">int</span><span class="op" id="1629096">)</span>&nbsp;<span class="op" id="1629098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1629101">//&nbsp;This&nbsp;function&nbsp;is&nbsp;used&nbsp;only&nbsp;on&nbsp;windows&nbsp;after&nbsp;a&nbsp;failed&nbsp;attempt&nbsp;to&nbsp;cancel</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1629176">//&nbsp;a&nbsp;pending&nbsp;async&nbsp;IO&nbsp;operation.&nbsp;Wait&nbsp;for&nbsp;ioready,&nbsp;ignore&nbsp;closing&nbsp;or&nbsp;timeouts.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1629256">for</span>&nbsp;<span class="op" id="1629260">!</span><span class="ident" id="1629261">netpollblock</span><span class="op" id="1629273">(</span><span class="ident" id="1629274">pd</span><span class="op" id="1629276">,</span>&nbsp;<span class="builtintype" id="1629278">int32</span><span class="op" id="1629283">(</span><span class="ident" id="1629284">mode</span><span class="op" id="1629288">)</span><span class="op" id="1629289">,</span>&nbsp;<span class="ident" id="1629291">true</span><span class="op" id="1629295">)</span>&nbsp;<span class="op" id="1629297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1629300">}</span><br>
<span class="lineno"></span><span class="op" id="1629302">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1629305">func</span>&nbsp;<span class="ident" id="1629310">netpollSetDeadline</span><span class="op" id="1629328">(</span><span class="ident" id="1629329">pd</span>&nbsp;<span class="op" id="1629332">*</span><span class="ident" id="1629333">pollDesc</span><span class="op" id="1629341">,</span>&nbsp;<span class="ident" id="1629343">d</span>&nbsp;<span class="ident" id="1629345">int64</span><span class="op" id="1629350">,</span>&nbsp;<span class="ident" id="1629352">mode</span>&nbsp;<span class="builtintype" id="1629357">int</span><span class="op" id="1629360">)</span>&nbsp;<span class="op" id="1629362">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1629365">lock</span><span class="op" id="1629369">(</span><span class="op" id="1629370">&amp;</span><span class="ident" id="1629371">pd</span><span class="op" id="1629373">.</span><span class="ident" id="1629374">lock</span><span class="op" id="1629378">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1629381">if</span>&nbsp;<span class="ident" id="1629384">pd</span><span class="op" id="1629386">.</span><span class="ident" id="1629387">closing</span>&nbsp;<span class="op" id="1629395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1629399">unlock</span><span class="op" id="1629405">(</span><span class="op" id="1629406">&amp;</span><span class="ident" id="1629407">pd</span><span class="op" id="1629409">.</span><span class="ident" id="1629410">lock</span><span class="op" id="1629414">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1629418">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1629426">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1629429">pd</span><span class="op" id="1629431">.</span><span class="ident" id="1629432">seq</span><span class="op" id="1629435">++</span>&nbsp;<span class="comment" id="1629438">//&nbsp;invalidate&nbsp;current&nbsp;timers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1629468">//&nbsp;Reset&nbsp;current&nbsp;timers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1629494">if</span>&nbsp;<span class="ident" id="1629497">pd</span><span class="op" id="1629499">.</span><span class="ident" id="1629500">rt</span><span class="op" id="1629502">.</span><span class="ident" id="1629503">f</span>&nbsp;<span class="op" id="1629505">!=</span>&nbsp;<span class="ident" id="1629508">nil</span>&nbsp;<span class="op" id="1629512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1629516">deltimer</span><span class="op" id="1629524">(</span><span class="op" id="1629525">&amp;</span><span class="ident" id="1629526">pd</span><span class="op" id="1629528">.</span><span class="ident" id="1629529">rt</span><span class="op" id="1629531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1629535">pd</span><span class="op" id="1629537">.</span><span class="ident" id="1629538">rt</span><span class="op" id="1629540">.</span><span class="ident" id="1629541">f</span>&nbsp;<span class="op" id="1629543">=</span>&nbsp;<span class="ident" id="1629545">nil</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1629550">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1629553">if</span>&nbsp;<span class="ident" id="1629556">pd</span><span class="op" id="1629558">.</span><span class="ident" id="1629559">wt</span><span class="op" id="1629561">.</span><span class="ident" id="1629562">f</span>&nbsp;<span class="op" id="1629564">!=</span>&nbsp;<span class="ident" id="1629567">nil</span>&nbsp;<span class="op" id="1629571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1629575">deltimer</span><span class="op" id="1629583">(</span><span class="op" id="1629584">&amp;</span><span class="ident" id="1629585">pd</span><span class="op" id="1629587">.</span><span class="ident" id="1629588">wt</span><span class="op" id="1629590">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1629594">pd</span><span class="op" id="1629596">.</span><span class="ident" id="1629597">wt</span><span class="op" id="1629599">.</span><span class="ident" id="1629600">f</span>&nbsp;<span class="op" id="1629602">=</span>&nbsp;<span class="ident" id="1629604">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1629609">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1629612">//&nbsp;Setup&nbsp;new&nbsp;timers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1629634">if</span>&nbsp;<span class="ident" id="1629637">d</span>&nbsp;<span class="op" id="1629639">!=</span>&nbsp;<span class="num" id="1629642">0</span>&nbsp;<span class="op" id="1629644">&amp;&amp;</span>&nbsp;<span class="ident" id="1629647">d</span>&nbsp;<span class="op" id="1629649">&lt;=</span>&nbsp;<span class="ident" id="1629652">nanotime</span><span class="op" id="1629660">(</span><span class="op" id="1629661">)</span>&nbsp;<span class="op" id="1629663">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1629667">d</span>&nbsp;<span class="op" id="1629669">=</span>&nbsp;<span class="op" id="1629671">-</span><span class="num" id="1629672">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1629675">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1629678">if</span>&nbsp;<span class="ident" id="1629681">mode</span>&nbsp;<span class="op" id="1629686">==</span>&nbsp;<span class="string" id="1629689">&#39;r&#39;</span>&nbsp;<span class="op" id="1629693">||</span>&nbsp;<span class="ident" id="1629696">mode</span>&nbsp;<span class="op" id="1629701">==</span>&nbsp;<span class="string" id="1629704">&#39;r&#39;</span><span class="op" id="1629707">+</span><span class="string" id="1629708">&#39;w&#39;</span>&nbsp;<span class="op" id="1629712">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1629716">pd</span><span class="op" id="1629718">.</span><span class="ident" id="1629719">rd</span>&nbsp;<span class="op" id="1629722">=</span>&nbsp;<span class="ident" id="1629724">d</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1629727">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1629730">if</span>&nbsp;<span class="ident" id="1629733">mode</span>&nbsp;<span class="op" id="1629738">==</span>&nbsp;<span class="string" id="1629741">&#39;w&#39;</span>&nbsp;<span class="op" id="1629745">||</span>&nbsp;<span class="ident" id="1629748">mode</span>&nbsp;<span class="op" id="1629753">==</span>&nbsp;<span class="string" id="1629756">&#39;r&#39;</span><span class="op" id="1629759">+</span><span class="string" id="1629760">&#39;w&#39;</span>&nbsp;<span class="op" id="1629764">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1629768">pd</span><span class="op" id="1629770">.</span><span class="ident" id="1629771">wd</span>&nbsp;<span class="op" id="1629774">=</span>&nbsp;<span class="ident" id="1629776">d</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1629779">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1629782">if</span>&nbsp;<span class="ident" id="1629785">pd</span><span class="op" id="1629787">.</span><span class="ident" id="1629788">rd</span>&nbsp;<span class="op" id="1629791">&gt;</span>&nbsp;<span class="num" id="1629793">0</span>&nbsp;<span class="op" id="1629795">&amp;&amp;</span>&nbsp;<span class="ident" id="1629798">pd</span><span class="op" id="1629800">.</span><span class="ident" id="1629801">rd</span>&nbsp;<span class="op" id="1629804">==</span>&nbsp;<span class="ident" id="1629807">pd</span><span class="op" id="1629809">.</span><span class="ident" id="1629810">wd</span>&nbsp;<span class="op" id="1629813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1629817">pd</span><span class="op" id="1629819">.</span><span class="ident" id="1629820">rt</span><span class="op" id="1629822">.</span><span class="ident" id="1629823">f</span>&nbsp;<span class="op" id="1629825">=</span>&nbsp;<span class="ident" id="1629827">netpollDeadline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1629845">pd</span><span class="op" id="1629847">.</span><span class="ident" id="1629848">rt</span><span class="op" id="1629850">.</span><span class="ident" id="1629851">when</span>&nbsp;<span class="op" id="1629856">=</span>&nbsp;<span class="ident" id="1629858">pd</span><span class="op" id="1629860">.</span><span class="ident" id="1629861">rd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1629866">//&nbsp;Copy&nbsp;current&nbsp;seq&nbsp;into&nbsp;the&nbsp;timer&nbsp;arg.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1629908">//&nbsp;Timer&nbsp;func&nbsp;will&nbsp;check&nbsp;the&nbsp;seq&nbsp;against&nbsp;current&nbsp;descriptor&nbsp;seq,</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1629975">//&nbsp;if&nbsp;they&nbsp;differ&nbsp;the&nbsp;descriptor&nbsp;was&nbsp;reused&nbsp;or&nbsp;timers&nbsp;were&nbsp;reset.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630043">pd</span><span class="op" id="1630045">.</span><span class="ident" id="1630046">rt</span><span class="op" id="1630048">.</span><span class="ident" id="1630049">arg</span>&nbsp;<span class="op" id="1630053">=</span>&nbsp;<span class="ident" id="1630055">pd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630060">pd</span><span class="op" id="1630062">.</span><span class="ident" id="1630063">rt</span><span class="op" id="1630065">.</span><span class="ident" id="1630066">seq</span>&nbsp;<span class="op" id="1630070">=</span>&nbsp;<span class="ident" id="1630072">pd</span><span class="op" id="1630074">.</span><span class="ident" id="1630075">seq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630081">addtimer</span><span class="op" id="1630089">(</span><span class="op" id="1630090">&amp;</span><span class="ident" id="1630091">pd</span><span class="op" id="1630093">.</span><span class="ident" id="1630094">rt</span><span class="op" id="1630096">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1630099">}</span>&nbsp;<span class="keyword" id="1630101">else</span>&nbsp;<span class="op" id="1630106">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1630110">if</span>&nbsp;<span class="ident" id="1630113">pd</span><span class="op" id="1630115">.</span><span class="ident" id="1630116">rd</span>&nbsp;<span class="op" id="1630119">&gt;</span>&nbsp;<span class="num" id="1630121">0</span>&nbsp;<span class="op" id="1630123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630128">pd</span><span class="op" id="1630130">.</span><span class="ident" id="1630131">rt</span><span class="op" id="1630133">.</span><span class="ident" id="1630134">f</span>&nbsp;<span class="op" id="1630136">=</span>&nbsp;<span class="ident" id="1630138">netpollReadDeadline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630161">pd</span><span class="op" id="1630163">.</span><span class="ident" id="1630164">rt</span><span class="op" id="1630166">.</span><span class="ident" id="1630167">when</span>&nbsp;<span class="op" id="1630172">=</span>&nbsp;<span class="ident" id="1630174">pd</span><span class="op" id="1630176">.</span><span class="ident" id="1630177">rd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630183">pd</span><span class="op" id="1630185">.</span><span class="ident" id="1630186">rt</span><span class="op" id="1630188">.</span><span class="ident" id="1630189">arg</span>&nbsp;<span class="op" id="1630193">=</span>&nbsp;<span class="ident" id="1630195">pd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630201">pd</span><span class="op" id="1630203">.</span><span class="ident" id="1630204">rt</span><span class="op" id="1630206">.</span><span class="ident" id="1630207">seq</span>&nbsp;<span class="op" id="1630211">=</span>&nbsp;<span class="ident" id="1630213">pd</span><span class="op" id="1630215">.</span><span class="ident" id="1630216">seq</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630223">addtimer</span><span class="op" id="1630231">(</span><span class="op" id="1630232">&amp;</span><span class="ident" id="1630233">pd</span><span class="op" id="1630235">.</span><span class="ident" id="1630236">rt</span><span class="op" id="1630238">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1630242">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1630246">if</span>&nbsp;<span class="ident" id="1630249">pd</span><span class="op" id="1630251">.</span><span class="ident" id="1630252">wd</span>&nbsp;<span class="op" id="1630255">&gt;</span>&nbsp;<span class="num" id="1630257">0</span>&nbsp;<span class="op" id="1630259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630264">pd</span><span class="op" id="1630266">.</span><span class="ident" id="1630267">wt</span><span class="op" id="1630269">.</span><span class="ident" id="1630270">f</span>&nbsp;<span class="op" id="1630272">=</span>&nbsp;<span class="ident" id="1630274">netpollWriteDeadline</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630298">pd</span><span class="op" id="1630300">.</span><span class="ident" id="1630301">wt</span><span class="op" id="1630303">.</span><span class="ident" id="1630304">when</span>&nbsp;<span class="op" id="1630309">=</span>&nbsp;<span class="ident" id="1630311">pd</span><span class="op" id="1630313">.</span><span class="ident" id="1630314">wd</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630320">pd</span><span class="op" id="1630322">.</span><span class="ident" id="1630323">wt</span><span class="op" id="1630325">.</span><span class="ident" id="1630326">arg</span>&nbsp;<span class="op" id="1630330">=</span>&nbsp;<span class="ident" id="1630332">pd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630338">pd</span><span class="op" id="1630340">.</span><span class="ident" id="1630341">wt</span><span class="op" id="1630343">.</span><span class="ident" id="1630344">seq</span>&nbsp;<span class="op" id="1630348">=</span>&nbsp;<span class="ident" id="1630350">pd</span><span class="op" id="1630352">.</span><span class="ident" id="1630353">seq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630360">addtimer</span><span class="op" id="1630368">(</span><span class="op" id="1630369">&amp;</span><span class="ident" id="1630370">pd</span><span class="op" id="1630372">.</span><span class="ident" id="1630373">wt</span><span class="op" id="1630375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1630379">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1630382">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1630385">//&nbsp;If&nbsp;we&nbsp;set&nbsp;the&nbsp;new&nbsp;deadline&nbsp;in&nbsp;the&nbsp;past,&nbsp;unblock&nbsp;currently&nbsp;pending&nbsp;IO&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1630466">var</span>&nbsp;<span class="ident" id="1630470">rg</span><span class="op" id="1630472">,</span>&nbsp;<span class="ident" id="1630474">wg</span>&nbsp;<span class="op" id="1630477">*</span><span class="ident" id="1630478">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630481">atomicstorep</span><span class="op" id="1630493">(</span><span class="ident" id="1630494">unsafe</span><span class="op" id="1630500">.</span><span class="ident" id="1630501">Pointer</span><span class="op" id="1630508">(</span><span class="op" id="1630509">&amp;</span><span class="ident" id="1630510">wg</span><span class="op" id="1630512">)</span><span class="op" id="1630513">,</span>&nbsp;<span class="ident" id="1630515">nil</span><span class="op" id="1630518">)</span>&nbsp;<span class="comment" id="1630520">//&nbsp;full&nbsp;memory&nbsp;barrier&nbsp;between&nbsp;stores&nbsp;to&nbsp;rd/wd&nbsp;and&nbsp;load&nbsp;of&nbsp;rg/wg&nbsp;in&nbsp;netpollunblock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1630604">if</span>&nbsp;<span class="ident" id="1630607">pd</span><span class="op" id="1630609">.</span><span class="ident" id="1630610">rd</span>&nbsp;<span class="op" id="1630613">&lt;</span>&nbsp;<span class="num" id="1630615">0</span>&nbsp;<span class="op" id="1630617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630621">rg</span>&nbsp;<span class="op" id="1630624">=</span>&nbsp;<span class="ident" id="1630626">netpollunblock</span><span class="op" id="1630640">(</span><span class="ident" id="1630641">pd</span><span class="op" id="1630643">,</span>&nbsp;<span class="string" id="1630645">&#39;r&#39;</span><span class="op" id="1630648">,</span>&nbsp;<span class="ident" id="1630650">false</span><span class="op" id="1630655">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1630658">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1630661">if</span>&nbsp;<span class="ident" id="1630664">pd</span><span class="op" id="1630666">.</span><span class="ident" id="1630667">wd</span>&nbsp;<span class="op" id="1630670">&lt;</span>&nbsp;<span class="num" id="1630672">0</span>&nbsp;<span class="op" id="1630674">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630678">wg</span>&nbsp;<span class="op" id="1630681">=</span>&nbsp;<span class="ident" id="1630683">netpollunblock</span><span class="op" id="1630697">(</span><span class="ident" id="1630698">pd</span><span class="op" id="1630700">,</span>&nbsp;<span class="string" id="1630702">&#39;w&#39;</span><span class="op" id="1630705">,</span>&nbsp;<span class="ident" id="1630707">false</span><span class="op" id="1630712">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1630715">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630718">unlock</span><span class="op" id="1630724">(</span><span class="op" id="1630725">&amp;</span><span class="ident" id="1630726">pd</span><span class="op" id="1630728">.</span><span class="ident" id="1630729">lock</span><span class="op" id="1630733">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1630736">if</span>&nbsp;<span class="ident" id="1630739">rg</span>&nbsp;<span class="op" id="1630742">!=</span>&nbsp;<span class="ident" id="1630745">nil</span>&nbsp;<span class="op" id="1630749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630753">goready</span><span class="op" id="1630760">(</span><span class="ident" id="1630761">rg</span><span class="op" id="1630763">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1630766">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1630769">if</span>&nbsp;<span class="ident" id="1630772">wg</span>&nbsp;<span class="op" id="1630775">!=</span>&nbsp;<span class="ident" id="1630778">nil</span>&nbsp;<span class="op" id="1630782">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630786">goready</span><span class="op" id="1630793">(</span><span class="ident" id="1630794">wg</span><span class="op" id="1630796">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1630799">}</span><br>
<span class="lineno"></span><span class="op" id="1630801">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1630804">func</span>&nbsp;<span class="ident" id="1630809">netpollUnblock</span><span class="op" id="1630823">(</span><span class="ident" id="1630824">pd</span>&nbsp;<span class="op" id="1630827">*</span><span class="ident" id="1630828">pollDesc</span><span class="op" id="1630836">)</span>&nbsp;<span class="op" id="1630838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630841">lock</span><span class="op" id="1630845">(</span><span class="op" id="1630846">&amp;</span><span class="ident" id="1630847">pd</span><span class="op" id="1630849">.</span><span class="ident" id="1630850">lock</span><span class="op" id="1630854">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1630857">if</span>&nbsp;<span class="ident" id="1630860">pd</span><span class="op" id="1630862">.</span><span class="ident" id="1630863">closing</span>&nbsp;<span class="op" id="1630871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630875">gothrow</span><span class="op" id="1630882">(</span><span class="string" id="1630883">&#34;netpollUnblock:&nbsp;already&nbsp;closing&#34;</span><span class="op" id="1630916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1630919">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630922">pd</span><span class="op" id="1630924">.</span><span class="ident" id="1630925">closing</span>&nbsp;<span class="op" id="1630933">=</span>&nbsp;<span class="ident" id="1630935">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630941">pd</span><span class="op" id="1630943">.</span><span class="ident" id="1630944">seq</span><span class="op" id="1630947">++</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1630951">var</span>&nbsp;<span class="ident" id="1630955">rg</span><span class="op" id="1630957">,</span>&nbsp;<span class="ident" id="1630959">wg</span>&nbsp;<span class="op" id="1630962">*</span><span class="ident" id="1630963">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1630966">atomicstorep</span><span class="op" id="1630978">(</span><span class="ident" id="1630979">unsafe</span><span class="op" id="1630985">.</span><span class="ident" id="1630986">Pointer</span><span class="op" id="1630993">(</span><span class="op" id="1630994">&amp;</span><span class="ident" id="1630995">rg</span><span class="op" id="1630997">)</span><span class="op" id="1630998">,</span>&nbsp;<span class="ident" id="1631000">nil</span><span class="op" id="1631003">)</span>&nbsp;<span class="comment" id="1631005">//&nbsp;full&nbsp;memory&nbsp;barrier&nbsp;between&nbsp;store&nbsp;to&nbsp;closing&nbsp;and&nbsp;read&nbsp;of&nbsp;rg/wg&nbsp;in&nbsp;netpollunblock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1631090">rg</span>&nbsp;<span class="op" id="1631093">=</span>&nbsp;<span class="ident" id="1631095">netpollunblock</span><span class="op" id="1631109">(</span><span class="ident" id="1631110">pd</span><span class="op" id="1631112">,</span>&nbsp;<span class="string" id="1631114">&#39;r&#39;</span><span class="op" id="1631117">,</span>&nbsp;<span class="ident" id="1631119">false</span><span class="op" id="1631124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1631127">wg</span>&nbsp;<span class="op" id="1631130">=</span>&nbsp;<span class="ident" id="1631132">netpollunblock</span><span class="op" id="1631146">(</span><span class="ident" id="1631147">pd</span><span class="op" id="1631149">,</span>&nbsp;<span class="string" id="1631151">&#39;w&#39;</span><span class="op" id="1631154">,</span>&nbsp;<span class="ident" id="1631156">false</span><span class="op" id="1631161">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1631164">if</span>&nbsp;<span class="ident" id="1631167">pd</span><span class="op" id="1631169">.</span><span class="ident" id="1631170">rt</span><span class="op" id="1631172">.</span><span class="ident" id="1631173">f</span>&nbsp;<span class="op" id="1631175">!=</span>&nbsp;<span class="ident" id="1631178">nil</span>&nbsp;<span class="op" id="1631182">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1631186">deltimer</span><span class="op" id="1631194">(</span><span class="op" id="1631195">&amp;</span><span class="ident" id="1631196">pd</span><span class="op" id="1631198">.</span><span class="ident" id="1631199">rt</span><span class="op" id="1631201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1631205">pd</span><span class="op" id="1631207">.</span><span class="ident" id="1631208">rt</span><span class="op" id="1631210">.</span><span class="ident" id="1631211">f</span>&nbsp;<span class="op" id="1631213">=</span>&nbsp;<span class="ident" id="1631215">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1631220">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1631223">if</span>&nbsp;<span class="ident" id="1631226">pd</span><span class="op" id="1631228">.</span><span class="ident" id="1631229">wt</span><span class="op" id="1631231">.</span><span class="ident" id="1631232">f</span>&nbsp;<span class="op" id="1631234">!=</span>&nbsp;<span class="ident" id="1631237">nil</span>&nbsp;<span class="op" id="1631241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1631245">deltimer</span><span class="op" id="1631253">(</span><span class="op" id="1631254">&amp;</span><span class="ident" id="1631255">pd</span><span class="op" id="1631257">.</span><span class="ident" id="1631258">wt</span><span class="op" id="1631260">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1631264">pd</span><span class="op" id="1631266">.</span><span class="ident" id="1631267">wt</span><span class="op" id="1631269">.</span><span class="ident" id="1631270">f</span>&nbsp;<span class="op" id="1631272">=</span>&nbsp;<span class="ident" id="1631274">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1631279">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1631282">unlock</span><span class="op" id="1631288">(</span><span class="op" id="1631289">&amp;</span><span class="ident" id="1631290">pd</span><span class="op" id="1631292">.</span><span class="ident" id="1631293">lock</span><span class="op" id="1631297">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1631300">if</span>&nbsp;<span class="ident" id="1631303">rg</span>&nbsp;<span class="op" id="1631306">!=</span>&nbsp;<span class="ident" id="1631309">nil</span>&nbsp;<span class="op" id="1631313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1631317">goready</span><span class="op" id="1631324">(</span><span class="ident" id="1631325">rg</span><span class="op" id="1631327">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1631330">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1631333">if</span>&nbsp;<span class="ident" id="1631336">wg</span>&nbsp;<span class="op" id="1631339">!=</span>&nbsp;<span class="ident" id="1631342">nil</span>&nbsp;<span class="op" id="1631346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1631350">goready</span><span class="op" id="1631357">(</span><span class="ident" id="1631358">wg</span><span class="op" id="1631360">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1631363">}</span><br>
<span class="lineno"></span><span class="op" id="1631365">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span><span class="keyword" id="1631368">func</span>&nbsp;<span class="ident" id="1631373">netpollfd</span><span class="op" id="1631382">(</span><span class="ident" id="1631383">pd</span>&nbsp;<span class="op" id="1631386">*</span><span class="ident" id="1631387">pollDesc</span><span class="op" id="1631395">)</span>&nbsp;<span class="builtintype" id="1631397">uintptr</span>&nbsp;<span class="op" id="1631405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1631408">return</span>&nbsp;<span class="ident" id="1631415">pd</span><span class="op" id="1631417">.</span><span class="ident" id="1631418">fd</span><br>
<span class="lineno"></span><span class="op" id="1631421">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">270</span><span class="keyword" id="1631424">func</span>&nbsp;<span class="ident" id="1631429">netpolluser</span><span class="op" id="1631440">(</span><span class="ident" id="1631441">pd</span>&nbsp;<span class="op" id="1631444">*</span><span class="ident" id="1631445">pollDesc</span><span class="op" id="1631453">)</span>&nbsp;<span class="op" id="1631455">*</span><span class="ident" id="1631456">unsafe</span><span class="op" id="1631462">.</span><span class="ident" id="1631463">Pointer</span>&nbsp;<span class="op" id="1631471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1631474">return</span>&nbsp;<span class="op" id="1631481">&amp;</span><span class="ident" id="1631482">pd</span><span class="op" id="1631484">.</span><span class="ident" id="1631485">user</span><br>
<span class="lineno"></span><span class="op" id="1631490">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1631493">func</span>&nbsp;<span class="ident" id="1631498">netpollclosing</span><span class="op" id="1631512">(</span><span class="ident" id="1631513">pd</span>&nbsp;<span class="op" id="1631516">*</span><span class="ident" id="1631517">pollDesc</span><span class="op" id="1631525">)</span>&nbsp;<span class="builtintype" id="1631527">bool</span>&nbsp;<span class="op" id="1631532">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1631535">return</span>&nbsp;<span class="ident" id="1631542">pd</span><span class="op" id="1631544">.</span><span class="ident" id="1631545">closing</span><br>
<span class="lineno"></span><span class="op" id="1631553">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1631556">func</span>&nbsp;<span class="ident" id="1631561">netpolllock</span><span class="op" id="1631572">(</span><span class="ident" id="1631573">pd</span>&nbsp;<span class="op" id="1631576">*</span><span class="ident" id="1631577">pollDesc</span><span class="op" id="1631585">)</span>&nbsp;<span class="op" id="1631587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1631590">lock</span><span class="op" id="1631594">(</span><span class="op" id="1631595">&amp;</span><span class="ident" id="1631596">pd</span><span class="op" id="1631598">.</span><span class="ident" id="1631599">lock</span><span class="op" id="1631603">)</span><br>
<span class="lineno">280</span><span class="op" id="1631605">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1631608">func</span>&nbsp;<span class="ident" id="1631613">netpollunlock</span><span class="op" id="1631626">(</span><span class="ident" id="1631627">pd</span>&nbsp;<span class="op" id="1631630">*</span><span class="ident" id="1631631">pollDesc</span><span class="op" id="1631639">)</span>&nbsp;<span class="op" id="1631641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1631644">unlock</span><span class="op" id="1631650">(</span><span class="op" id="1631651">&amp;</span><span class="ident" id="1631652">pd</span><span class="op" id="1631654">.</span><span class="ident" id="1631655">lock</span><span class="op" id="1631659">)</span><br>
<span class="lineno"></span><span class="op" id="1631661">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="comment" id="1631664">//&nbsp;make&nbsp;pd&nbsp;ready,&nbsp;newly&nbsp;runnable&nbsp;goroutines&nbsp;(if&nbsp;any)&nbsp;are&nbsp;returned&nbsp;in&nbsp;rg/wg</span><br>
<span class="lineno"></span><span class="keyword" id="1631739">func</span>&nbsp;<span class="ident" id="1631744">netpollready</span><span class="op" id="1631756">(</span><span class="ident" id="1631757">gpp</span>&nbsp;<span class="op" id="1631761">*</span><span class="op" id="1631762">*</span><span class="ident" id="1631763">g</span><span class="op" id="1631764">,</span>&nbsp;<span class="ident" id="1631766">pd</span>&nbsp;<span class="op" id="1631769">*</span><span class="ident" id="1631770">pollDesc</span><span class="op" id="1631778">,</span>&nbsp;<span class="ident" id="1631780">mode</span>&nbsp;<span class="builtintype" id="1631785">int32</span><span class="op" id="1631790">)</span>&nbsp;<span class="op" id="1631792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1631795">var</span>&nbsp;<span class="ident" id="1631799">rg</span><span class="op" id="1631801">,</span>&nbsp;<span class="ident" id="1631803">wg</span>&nbsp;<span class="op" id="1631806">*</span><span class="ident" id="1631807">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1631810">if</span>&nbsp;<span class="ident" id="1631813">mode</span>&nbsp;<span class="op" id="1631818">==</span>&nbsp;<span class="string" id="1631821">&#39;r&#39;</span>&nbsp;<span class="op" id="1631825">||</span>&nbsp;<span class="ident" id="1631828">mode</span>&nbsp;<span class="op" id="1631833">==</span>&nbsp;<span class="string" id="1631836">&#39;r&#39;</span><span class="op" id="1631839">+</span><span class="string" id="1631840">&#39;w&#39;</span>&nbsp;<span class="op" id="1631844">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1631848">rg</span>&nbsp;<span class="op" id="1631851">=</span>&nbsp;<span class="ident" id="1631853">netpollunblock</span><span class="op" id="1631867">(</span><span class="ident" id="1631868">pd</span><span class="op" id="1631870">,</span>&nbsp;<span class="string" id="1631872">&#39;r&#39;</span><span class="op" id="1631875">,</span>&nbsp;<span class="ident" id="1631877">true</span><span class="op" id="1631881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1631884">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1631887">if</span>&nbsp;<span class="ident" id="1631890">mode</span>&nbsp;<span class="op" id="1631895">==</span>&nbsp;<span class="string" id="1631898">&#39;w&#39;</span>&nbsp;<span class="op" id="1631902">||</span>&nbsp;<span class="ident" id="1631905">mode</span>&nbsp;<span class="op" id="1631910">==</span>&nbsp;<span class="string" id="1631913">&#39;r&#39;</span><span class="op" id="1631916">+</span><span class="string" id="1631917">&#39;w&#39;</span>&nbsp;<span class="op" id="1631921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1631925">wg</span>&nbsp;<span class="op" id="1631928">=</span>&nbsp;<span class="ident" id="1631930">netpollunblock</span><span class="op" id="1631944">(</span><span class="ident" id="1631945">pd</span><span class="op" id="1631947">,</span>&nbsp;<span class="string" id="1631949">&#39;w&#39;</span><span class="op" id="1631952">,</span>&nbsp;<span class="ident" id="1631954">true</span><span class="op" id="1631958">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1631961">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1631964">if</span>&nbsp;<span class="ident" id="1631967">rg</span>&nbsp;<span class="op" id="1631970">!=</span>&nbsp;<span class="ident" id="1631973">nil</span>&nbsp;<span class="op" id="1631977">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1631981">rg</span><span class="op" id="1631983">.</span><span class="ident" id="1631984">schedlink</span>&nbsp;<span class="op" id="1631994">=</span>&nbsp;<span class="op" id="1631996">*</span><span class="ident" id="1631997">gpp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1632003">*</span><span class="ident" id="1632004">gpp</span>&nbsp;<span class="op" id="1632008">=</span>&nbsp;<span class="ident" id="1632010">rg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1632014">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1632017">if</span>&nbsp;<span class="ident" id="1632020">wg</span>&nbsp;<span class="op" id="1632023">!=</span>&nbsp;<span class="ident" id="1632026">nil</span>&nbsp;<span class="op" id="1632030">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632034">wg</span><span class="op" id="1632036">.</span><span class="ident" id="1632037">schedlink</span>&nbsp;<span class="op" id="1632047">=</span>&nbsp;<span class="op" id="1632049">*</span><span class="ident" id="1632050">gpp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1632056">*</span><span class="ident" id="1632057">gpp</span>&nbsp;<span class="op" id="1632061">=</span>&nbsp;<span class="ident" id="1632063">wg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1632067">}</span><br>
<span class="lineno"></span><span class="op" id="1632069">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">305</span><span class="keyword" id="1632072">func</span>&nbsp;<span class="ident" id="1632077">netpollcheckerr</span><span class="op" id="1632092">(</span><span class="ident" id="1632093">pd</span>&nbsp;<span class="op" id="1632096">*</span><span class="ident" id="1632097">pollDesc</span><span class="op" id="1632105">,</span>&nbsp;<span class="ident" id="1632107">mode</span>&nbsp;<span class="builtintype" id="1632112">int32</span><span class="op" id="1632117">)</span>&nbsp;<span class="builtintype" id="1632119">int</span>&nbsp;<span class="op" id="1632123">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1632126">if</span>&nbsp;<span class="ident" id="1632129">pd</span><span class="op" id="1632131">.</span><span class="ident" id="1632132">closing</span>&nbsp;<span class="op" id="1632140">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1632144">return</span>&nbsp;<span class="num" id="1632151">1</span>&nbsp;<span class="comment" id="1632153">//&nbsp;errClosing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1632168">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1632171">if</span>&nbsp;<span class="op" id="1632174">(</span><span class="ident" id="1632175">mode</span>&nbsp;<span class="op" id="1632180">==</span>&nbsp;<span class="string" id="1632183">&#39;r&#39;</span>&nbsp;<span class="op" id="1632187">&amp;&amp;</span>&nbsp;<span class="ident" id="1632190">pd</span><span class="op" id="1632192">.</span><span class="ident" id="1632193">rd</span>&nbsp;<span class="op" id="1632196">&lt;</span>&nbsp;<span class="num" id="1632198">0</span><span class="op" id="1632199">)</span>&nbsp;<span class="op" id="1632201">||</span>&nbsp;<span class="op" id="1632204">(</span><span class="ident" id="1632205">mode</span>&nbsp;<span class="op" id="1632210">==</span>&nbsp;<span class="string" id="1632213">&#39;w&#39;</span>&nbsp;<span class="op" id="1632217">&amp;&amp;</span>&nbsp;<span class="ident" id="1632220">pd</span><span class="op" id="1632222">.</span><span class="ident" id="1632223">wd</span>&nbsp;<span class="op" id="1632226">&lt;</span>&nbsp;<span class="num" id="1632228">0</span><span class="op" id="1632229">)</span>&nbsp;<span class="op" id="1632231">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1632235">return</span>&nbsp;<span class="num" id="1632242">2</span>&nbsp;<span class="comment" id="1632244">//&nbsp;errTimeout</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1632259">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1632262">return</span>&nbsp;<span class="num" id="1632269">0</span><br>
<span class="lineno"></span><span class="op" id="1632271">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span><span class="keyword" id="1632274">func</span>&nbsp;<span class="ident" id="1632279">netpollblockcommit</span><span class="op" id="1632297">(</span><span class="ident" id="1632298">gp</span>&nbsp;<span class="op" id="1632301">*</span><span class="ident" id="1632302">g</span><span class="op" id="1632303">,</span>&nbsp;<span class="ident" id="1632305">gpp</span>&nbsp;<span class="ident" id="1632309">unsafe</span><span class="op" id="1632315">.</span><span class="ident" id="1632316">Pointer</span><span class="op" id="1632323">)</span>&nbsp;<span class="builtintype" id="1632325">bool</span>&nbsp;<span class="op" id="1632330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1632333">return</span>&nbsp;<span class="ident" id="1632340">casuintptr</span><span class="op" id="1632350">(</span><span class="op" id="1632351">(</span><span class="op" id="1632352">*</span><span class="builtintype" id="1632353">uintptr</span><span class="op" id="1632360">)</span><span class="op" id="1632361">(</span><span class="ident" id="1632362">gpp</span><span class="op" id="1632365">)</span><span class="op" id="1632366">,</span>&nbsp;<span class="ident" id="1632368">pdWait</span><span class="op" id="1632374">,</span>&nbsp;<span class="builtintype" id="1632376">uintptr</span><span class="op" id="1632383">(</span><span class="ident" id="1632384">unsafe</span><span class="op" id="1632390">.</span><span class="ident" id="1632391">Pointer</span><span class="op" id="1632398">(</span><span class="ident" id="1632399">gp</span><span class="op" id="1632401">)</span><span class="op" id="1632402">)</span><span class="op" id="1632403">)</span><br>
<span class="lineno"></span><span class="op" id="1632405">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1632408">//&nbsp;returns&nbsp;true&nbsp;if&nbsp;IO&nbsp;is&nbsp;ready,&nbsp;or&nbsp;false&nbsp;if&nbsp;timedout&nbsp;or&nbsp;closed</span><br>
<span class="lineno">320</span><span class="comment" id="1632471">//&nbsp;waitio&nbsp;-&nbsp;wait&nbsp;only&nbsp;for&nbsp;completed&nbsp;IO,&nbsp;ignore&nbsp;errors</span><br>
<span class="lineno"></span><span class="keyword" id="1632525">func</span>&nbsp;<span class="ident" id="1632530">netpollblock</span><span class="op" id="1632542">(</span><span class="ident" id="1632543">pd</span>&nbsp;<span class="op" id="1632546">*</span><span class="ident" id="1632547">pollDesc</span><span class="op" id="1632555">,</span>&nbsp;<span class="ident" id="1632557">mode</span>&nbsp;<span class="builtintype" id="1632562">int32</span><span class="op" id="1632567">,</span>&nbsp;<span class="ident" id="1632569">waitio</span>&nbsp;<span class="builtintype" id="1632576">bool</span><span class="op" id="1632580">)</span>&nbsp;<span class="builtintype" id="1632582">bool</span>&nbsp;<span class="op" id="1632587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632590">gpp</span>&nbsp;<span class="op" id="1632594">:=</span>&nbsp;<span class="op" id="1632597">&amp;</span><span class="ident" id="1632598">pd</span><span class="op" id="1632600">.</span><span class="ident" id="1632601">rg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1632605">if</span>&nbsp;<span class="ident" id="1632608">mode</span>&nbsp;<span class="op" id="1632613">==</span>&nbsp;<span class="string" id="1632616">&#39;w&#39;</span>&nbsp;<span class="op" id="1632620">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632624">gpp</span>&nbsp;<span class="op" id="1632628">=</span>&nbsp;<span class="op" id="1632630">&amp;</span><span class="ident" id="1632631">pd</span><span class="op" id="1632633">.</span><span class="ident" id="1632634">wg</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1632638">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1632642">//&nbsp;set&nbsp;the&nbsp;gpp&nbsp;semaphore&nbsp;to&nbsp;WAIT</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1632676">for</span>&nbsp;<span class="op" id="1632680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632684">old</span>&nbsp;<span class="op" id="1632688">:=</span>&nbsp;<span class="op" id="1632691">*</span><span class="ident" id="1632692">gpp</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1632698">if</span>&nbsp;<span class="ident" id="1632701">old</span>&nbsp;<span class="op" id="1632705">==</span>&nbsp;<span class="ident" id="1632708">pdReady</span>&nbsp;<span class="op" id="1632716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1632721">*</span><span class="ident" id="1632722">gpp</span>&nbsp;<span class="op" id="1632726">=</span>&nbsp;<span class="num" id="1632728">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1632733">return</span>&nbsp;<span class="ident" id="1632740">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1632747">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1632751">if</span>&nbsp;<span class="ident" id="1632754">old</span>&nbsp;<span class="op" id="1632758">!=</span>&nbsp;<span class="num" id="1632761">0</span>&nbsp;<span class="op" id="1632763">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1632768">gothrow</span><span class="op" id="1632775">(</span><span class="string" id="1632776">&#34;netpollblock:&nbsp;double&nbsp;wait&#34;</span><span class="op" id="1632803">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1632807">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1632811">if</span>&nbsp;<span class="ident" id="1632814">casuintptr</span><span class="op" id="1632824">(</span><span class="ident" id="1632825">gpp</span><span class="op" id="1632828">,</span>&nbsp;<span class="num" id="1632830">0</span><span class="op" id="1632831">,</span>&nbsp;<span class="ident" id="1632833">pdWait</span><span class="op" id="1632839">)</span>&nbsp;<span class="op" id="1632841">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1632846">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1632854">}</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1632857">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1632861">//&nbsp;need&nbsp;to&nbsp;recheck&nbsp;error&nbsp;states&nbsp;after&nbsp;setting&nbsp;gpp&nbsp;to&nbsp;WAIT</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1632920">//&nbsp;this&nbsp;is&nbsp;necessary&nbsp;because&nbsp;runtime_pollUnblock/runtime_pollSetDeadline/deadlineimpl</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1633007">//&nbsp;do&nbsp;the&nbsp;opposite:&nbsp;store&nbsp;to&nbsp;closing/rd/wd,&nbsp;membarrier,&nbsp;load&nbsp;of&nbsp;rg/wg</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1633078">if</span>&nbsp;<span class="ident" id="1633081">waitio</span>&nbsp;<span class="op" id="1633088">||</span>&nbsp;<span class="ident" id="1633091">netpollcheckerr</span><span class="op" id="1633106">(</span><span class="ident" id="1633107">pd</span><span class="op" id="1633109">,</span>&nbsp;<span class="ident" id="1633111">mode</span><span class="op" id="1633115">)</span>&nbsp;<span class="op" id="1633117">==</span>&nbsp;<span class="num" id="1633120">0</span>&nbsp;<span class="op" id="1633122">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1633126">f</span>&nbsp;<span class="op" id="1633128">:=</span>&nbsp;<span class="ident" id="1633131">netpollblockcommit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1633152">gopark</span><span class="op" id="1633158">(</span><span class="op" id="1633159">*</span><span class="op" id="1633160">*</span><span class="op" id="1633161">(</span><span class="op" id="1633162">*</span><span class="op" id="1633163">*</span><span class="ident" id="1633164">unsafe</span><span class="op" id="1633170">.</span><span class="ident" id="1633171">Pointer</span><span class="op" id="1633178">)</span><span class="op" id="1633179">(</span><span class="ident" id="1633180">unsafe</span><span class="op" id="1633186">.</span><span class="ident" id="1633187">Pointer</span><span class="op" id="1633194">(</span><span class="op" id="1633195">&amp;</span><span class="ident" id="1633196">f</span><span class="op" id="1633197">)</span><span class="op" id="1633198">)</span><span class="op" id="1633199">,</span>&nbsp;<span class="ident" id="1633201">unsafe</span><span class="op" id="1633207">.</span><span class="ident" id="1633208">Pointer</span><span class="op" id="1633215">(</span><span class="ident" id="1633216">gpp</span><span class="op" id="1633219">)</span><span class="op" id="1633220">,</span>&nbsp;<span class="string" id="1633222">&#34;IO&nbsp;wait&#34;</span><span class="op" id="1633231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1633234">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1633237">//&nbsp;be&nbsp;careful&nbsp;to&nbsp;not&nbsp;lose&nbsp;concurrent&nbsp;READY&nbsp;notification</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1633294">old</span>&nbsp;<span class="op" id="1633298">:=</span>&nbsp;<span class="ident" id="1633301">xchguintptr</span><span class="op" id="1633312">(</span><span class="ident" id="1633313">gpp</span><span class="op" id="1633316">,</span>&nbsp;<span class="num" id="1633318">0</span><span class="op" id="1633319">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1633322">if</span>&nbsp;<span class="ident" id="1633325">old</span>&nbsp;<span class="op" id="1633329">&gt;</span>&nbsp;<span class="ident" id="1633331">pdWait</span>&nbsp;<span class="op" id="1633338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1633342">gothrow</span><span class="op" id="1633349">(</span><span class="string" id="1633350">&#34;netpollblock:&nbsp;corrupted&nbsp;state&#34;</span><span class="op" id="1633381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1633384">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1633387">return</span>&nbsp;<span class="ident" id="1633394">old</span>&nbsp;<span class="op" id="1633398">==</span>&nbsp;<span class="ident" id="1633401">pdReady</span><br>
<span class="lineno">355</span><span class="op" id="1633409">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1633412">func</span>&nbsp;<span class="ident" id="1633417">netpollunblock</span><span class="op" id="1633431">(</span><span class="ident" id="1633432">pd</span>&nbsp;<span class="op" id="1633435">*</span><span class="ident" id="1633436">pollDesc</span><span class="op" id="1633444">,</span>&nbsp;<span class="ident" id="1633446">mode</span>&nbsp;<span class="builtintype" id="1633451">int32</span><span class="op" id="1633456">,</span>&nbsp;<span class="ident" id="1633458">ioready</span>&nbsp;<span class="builtintype" id="1633466">bool</span><span class="op" id="1633470">)</span>&nbsp;<span class="op" id="1633472">*</span><span class="ident" id="1633473">g</span>&nbsp;<span class="op" id="1633475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1633478">gpp</span>&nbsp;<span class="op" id="1633482">:=</span>&nbsp;<span class="op" id="1633485">&amp;</span><span class="ident" id="1633486">pd</span><span class="op" id="1633488">.</span><span class="ident" id="1633489">rg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1633493">if</span>&nbsp;<span class="ident" id="1633496">mode</span>&nbsp;<span class="op" id="1633501">==</span>&nbsp;<span class="string" id="1633504">&#39;w&#39;</span>&nbsp;<span class="op" id="1633508">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1633512">gpp</span>&nbsp;<span class="op" id="1633516">=</span>&nbsp;<span class="op" id="1633518">&amp;</span><span class="ident" id="1633519">pd</span><span class="op" id="1633521">.</span><span class="ident" id="1633522">wg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1633526">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1633530">for</span>&nbsp;<span class="op" id="1633534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1633538">old</span>&nbsp;<span class="op" id="1633542">:=</span>&nbsp;<span class="op" id="1633545">*</span><span class="ident" id="1633546">gpp</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1633552">if</span>&nbsp;<span class="ident" id="1633555">old</span>&nbsp;<span class="op" id="1633559">==</span>&nbsp;<span class="ident" id="1633562">pdReady</span>&nbsp;<span class="op" id="1633570">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1633575">return</span>&nbsp;<span class="ident" id="1633582">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1633588">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1633592">if</span>&nbsp;<span class="ident" id="1633595">old</span>&nbsp;<span class="op" id="1633599">==</span>&nbsp;<span class="num" id="1633602">0</span>&nbsp;<span class="op" id="1633604">&amp;&amp;</span>&nbsp;<span class="op" id="1633607">!</span><span class="ident" id="1633608">ioready</span>&nbsp;<span class="op" id="1633616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1633621">//&nbsp;Only&nbsp;set&nbsp;READY&nbsp;for&nbsp;ioready.&nbsp;runtime_pollWait</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1633672">//&nbsp;will&nbsp;check&nbsp;for&nbsp;timeout/cancel&nbsp;before&nbsp;waiting.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1633724">return</span>&nbsp;<span class="ident" id="1633731">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1633737">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1633741">var</span>&nbsp;<span class="builtinfunc" id="1633745">new</span>&nbsp;<span class="builtintype" id="1633749">uintptr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1633759">if</span>&nbsp;<span class="ident" id="1633762">ioready</span>&nbsp;<span class="op" id="1633770">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1633775">new</span>&nbsp;<span class="op" id="1633779">=</span>&nbsp;<span class="ident" id="1633781">pdReady</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1633791">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1633795">if</span>&nbsp;<span class="ident" id="1633798">casuintptr</span><span class="op" id="1633808">(</span><span class="ident" id="1633809">gpp</span><span class="op" id="1633812">,</span>&nbsp;<span class="ident" id="1633814">old</span><span class="op" id="1633817">,</span>&nbsp;<span class="builtinfunc" id="1633819">new</span><span class="op" id="1633822">)</span>&nbsp;<span class="op" id="1633824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1633829">if</span>&nbsp;<span class="ident" id="1633832">old</span>&nbsp;<span class="op" id="1633836">==</span>&nbsp;<span class="ident" id="1633839">pdReady</span>&nbsp;<span class="op" id="1633847">||</span>&nbsp;<span class="ident" id="1633850">old</span>&nbsp;<span class="op" id="1633854">==</span>&nbsp;<span class="ident" id="1633857">pdWait</span>&nbsp;<span class="op" id="1633864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1633870">old</span>&nbsp;<span class="op" id="1633874">=</span>&nbsp;<span class="num" id="1633876">0</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1633881">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1633886">return</span>&nbsp;<span class="op" id="1633893">(</span><span class="op" id="1633894">*</span><span class="ident" id="1633895">g</span><span class="op" id="1633896">)</span><span class="op" id="1633897">(</span><span class="ident" id="1633898">unsafe</span><span class="op" id="1633904">.</span><span class="ident" id="1633905">Pointer</span><span class="op" id="1633912">(</span><span class="ident" id="1633913">old</span><span class="op" id="1633916">)</span><span class="op" id="1633917">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1633921">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1633924">}</span><br>
<span class="lineno"></span><span class="op" id="1633926">}</span><br>
<span class="lineno">385</span><br>
<span class="lineno"></span><span class="keyword" id="1633929">func</span>&nbsp;<span class="ident" id="1633934">netpolldeadlineimpl</span><span class="op" id="1633953">(</span><span class="ident" id="1633954">pd</span>&nbsp;<span class="op" id="1633957">*</span><span class="ident" id="1633958">pollDesc</span><span class="op" id="1633966">,</span>&nbsp;<span class="ident" id="1633968">seq</span>&nbsp;<span class="builtintype" id="1633972">uintptr</span><span class="op" id="1633979">,</span>&nbsp;<span class="ident" id="1633981">read</span><span class="op" id="1633985">,</span>&nbsp;<span class="ident" id="1633987">write</span>&nbsp;<span class="builtintype" id="1633993">bool</span><span class="op" id="1633997">)</span>&nbsp;<span class="op" id="1633999">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1634002">lock</span><span class="op" id="1634006">(</span><span class="op" id="1634007">&amp;</span><span class="ident" id="1634008">pd</span><span class="op" id="1634010">.</span><span class="ident" id="1634011">lock</span><span class="op" id="1634015">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1634018">//&nbsp;Seq&nbsp;arg&nbsp;is&nbsp;seq&nbsp;when&nbsp;the&nbsp;timer&nbsp;was&nbsp;set.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1634061">//&nbsp;If&nbsp;it&#39;s&nbsp;stale,&nbsp;ignore&nbsp;the&nbsp;timer&nbsp;event.</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1634104">if</span>&nbsp;<span class="ident" id="1634107">seq</span>&nbsp;<span class="op" id="1634111">!=</span>&nbsp;<span class="ident" id="1634114">pd</span><span class="op" id="1634116">.</span><span class="ident" id="1634117">seq</span>&nbsp;<span class="op" id="1634121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1634125">//&nbsp;The&nbsp;descriptor&nbsp;was&nbsp;reused&nbsp;or&nbsp;timers&nbsp;were&nbsp;reset.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1634178">unlock</span><span class="op" id="1634184">(</span><span class="op" id="1634185">&amp;</span><span class="ident" id="1634186">pd</span><span class="op" id="1634188">.</span><span class="ident" id="1634189">lock</span><span class="op" id="1634193">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1634197">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1634205">}</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1634208">var</span>&nbsp;<span class="ident" id="1634212">rg</span>&nbsp;<span class="op" id="1634215">*</span><span class="ident" id="1634216">g</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1634219">if</span>&nbsp;<span class="ident" id="1634222">read</span>&nbsp;<span class="op" id="1634227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1634231">if</span>&nbsp;<span class="ident" id="1634234">pd</span><span class="op" id="1634236">.</span><span class="ident" id="1634237">rd</span>&nbsp;<span class="op" id="1634240">&lt;=</span>&nbsp;<span class="num" id="1634243">0</span>&nbsp;<span class="op" id="1634245">||</span>&nbsp;<span class="ident" id="1634248">pd</span><span class="op" id="1634250">.</span><span class="ident" id="1634251">rt</span><span class="op" id="1634253">.</span><span class="ident" id="1634254">f</span>&nbsp;<span class="op" id="1634256">==</span>&nbsp;<span class="ident" id="1634259">nil</span>&nbsp;<span class="op" id="1634263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1634268">gothrow</span><span class="op" id="1634275">(</span><span class="string" id="1634276">&#34;netpolldeadlineimpl:&nbsp;inconsistent&nbsp;read&nbsp;deadline&#34;</span><span class="op" id="1634325">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1634329">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1634333">pd</span><span class="op" id="1634335">.</span><span class="ident" id="1634336">rd</span>&nbsp;<span class="op" id="1634339">=</span>&nbsp;<span class="op" id="1634341">-</span><span class="num" id="1634342">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1634346">atomicstorep</span><span class="op" id="1634358">(</span><span class="ident" id="1634359">unsafe</span><span class="op" id="1634365">.</span><span class="ident" id="1634366">Pointer</span><span class="op" id="1634373">(</span><span class="op" id="1634374">&amp;</span><span class="ident" id="1634375">pd</span><span class="op" id="1634377">.</span><span class="ident" id="1634378">rt</span><span class="op" id="1634380">.</span><span class="ident" id="1634381">f</span><span class="op" id="1634382">)</span><span class="op" id="1634383">,</span>&nbsp;<span class="ident" id="1634385">nil</span><span class="op" id="1634388">)</span>&nbsp;<span class="comment" id="1634390">//&nbsp;full&nbsp;memory&nbsp;barrier&nbsp;between&nbsp;store&nbsp;to&nbsp;rd&nbsp;and&nbsp;load&nbsp;of&nbsp;rg&nbsp;in&nbsp;netpollunblock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1634468">rg</span>&nbsp;<span class="op" id="1634471">=</span>&nbsp;<span class="ident" id="1634473">netpollunblock</span><span class="op" id="1634487">(</span><span class="ident" id="1634488">pd</span><span class="op" id="1634490">,</span>&nbsp;<span class="string" id="1634492">&#39;r&#39;</span><span class="op" id="1634495">,</span>&nbsp;<span class="ident" id="1634497">false</span><span class="op" id="1634502">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1634505">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1634508">var</span>&nbsp;<span class="ident" id="1634512">wg</span>&nbsp;<span class="op" id="1634515">*</span><span class="ident" id="1634516">g</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1634519">if</span>&nbsp;<span class="ident" id="1634522">write</span>&nbsp;<span class="op" id="1634528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1634532">if</span>&nbsp;<span class="ident" id="1634535">pd</span><span class="op" id="1634537">.</span><span class="ident" id="1634538">wd</span>&nbsp;<span class="op" id="1634541">&lt;=</span>&nbsp;<span class="num" id="1634544">0</span>&nbsp;<span class="op" id="1634546">||</span>&nbsp;<span class="ident" id="1634549">pd</span><span class="op" id="1634551">.</span><span class="ident" id="1634552">wt</span><span class="op" id="1634554">.</span><span class="ident" id="1634555">f</span>&nbsp;<span class="op" id="1634557">==</span>&nbsp;<span class="ident" id="1634560">nil</span>&nbsp;<span class="op" id="1634564">&amp;&amp;</span>&nbsp;<span class="op" id="1634567">!</span><span class="ident" id="1634568">read</span>&nbsp;<span class="op" id="1634573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1634578">gothrow</span><span class="op" id="1634585">(</span><span class="string" id="1634586">&#34;netpolldeadlineimpl:&nbsp;inconsistent&nbsp;write&nbsp;deadline&#34;</span><span class="op" id="1634636">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1634640">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1634644">pd</span><span class="op" id="1634646">.</span><span class="ident" id="1634647">wd</span>&nbsp;<span class="op" id="1634650">=</span>&nbsp;<span class="op" id="1634652">-</span><span class="num" id="1634653">1</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1634657">atomicstorep</span><span class="op" id="1634669">(</span><span class="ident" id="1634670">unsafe</span><span class="op" id="1634676">.</span><span class="ident" id="1634677">Pointer</span><span class="op" id="1634684">(</span><span class="op" id="1634685">&amp;</span><span class="ident" id="1634686">pd</span><span class="op" id="1634688">.</span><span class="ident" id="1634689">wt</span><span class="op" id="1634691">.</span><span class="ident" id="1634692">f</span><span class="op" id="1634693">)</span><span class="op" id="1634694">,</span>&nbsp;<span class="ident" id="1634696">nil</span><span class="op" id="1634699">)</span>&nbsp;<span class="comment" id="1634701">//&nbsp;full&nbsp;memory&nbsp;barrier&nbsp;between&nbsp;store&nbsp;to&nbsp;wd&nbsp;and&nbsp;load&nbsp;of&nbsp;wg&nbsp;in&nbsp;netpollunblock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1634779">wg</span>&nbsp;<span class="op" id="1634782">=</span>&nbsp;<span class="ident" id="1634784">netpollunblock</span><span class="op" id="1634798">(</span><span class="ident" id="1634799">pd</span><span class="op" id="1634801">,</span>&nbsp;<span class="string" id="1634803">&#39;w&#39;</span><span class="op" id="1634806">,</span>&nbsp;<span class="ident" id="1634808">false</span><span class="op" id="1634813">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1634816">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1634819">unlock</span><span class="op" id="1634825">(</span><span class="op" id="1634826">&amp;</span><span class="ident" id="1634827">pd</span><span class="op" id="1634829">.</span><span class="ident" id="1634830">lock</span><span class="op" id="1634834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1634837">if</span>&nbsp;<span class="ident" id="1634840">rg</span>&nbsp;<span class="op" id="1634843">!=</span>&nbsp;<span class="ident" id="1634846">nil</span>&nbsp;<span class="op" id="1634850">{</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1634854">goready</span><span class="op" id="1634861">(</span><span class="ident" id="1634862">rg</span><span class="op" id="1634864">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1634867">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1634870">if</span>&nbsp;<span class="ident" id="1634873">wg</span>&nbsp;<span class="op" id="1634876">!=</span>&nbsp;<span class="ident" id="1634879">nil</span>&nbsp;<span class="op" id="1634883">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1634887">goready</span><span class="op" id="1634894">(</span><span class="ident" id="1634895">wg</span><span class="op" id="1634897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1634900">}</span><br>
<span class="lineno">420</span><span class="op" id="1634902">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1634905">func</span>&nbsp;<span class="ident" id="1634910">netpollDeadline</span><span class="op" id="1634925">(</span><span class="ident" id="1634926">arg</span>&nbsp;<span class="keyword" id="1634930">interface</span><span class="op" id="1634939">{</span><span class="op" id="1634940">}</span><span class="op" id="1634941">,</span>&nbsp;<span class="ident" id="1634943">seq</span>&nbsp;<span class="builtintype" id="1634947">uintptr</span><span class="op" id="1634954">)</span>&nbsp;<span class="op" id="1634956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1634959">netpolldeadlineimpl</span><span class="op" id="1634978">(</span><span class="ident" id="1634979">arg</span><span class="op" id="1634982">.</span><span class="op" id="1634983">(</span><span class="op" id="1634984">*</span><span class="ident" id="1634985">pollDesc</span><span class="op" id="1634993">)</span><span class="op" id="1634994">,</span>&nbsp;<span class="ident" id="1634996">seq</span><span class="op" id="1634999">,</span>&nbsp;<span class="ident" id="1635001">true</span><span class="op" id="1635005">,</span>&nbsp;<span class="ident" id="1635007">true</span><span class="op" id="1635011">)</span><br>
<span class="lineno"></span><span class="op" id="1635013">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span><span class="keyword" id="1635016">func</span>&nbsp;<span class="ident" id="1635021">netpollReadDeadline</span><span class="op" id="1635040">(</span><span class="ident" id="1635041">arg</span>&nbsp;<span class="keyword" id="1635045">interface</span><span class="op" id="1635054">{</span><span class="op" id="1635055">}</span><span class="op" id="1635056">,</span>&nbsp;<span class="ident" id="1635058">seq</span>&nbsp;<span class="builtintype" id="1635062">uintptr</span><span class="op" id="1635069">)</span>&nbsp;<span class="op" id="1635071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1635074">netpolldeadlineimpl</span><span class="op" id="1635093">(</span><span class="ident" id="1635094">arg</span><span class="op" id="1635097">.</span><span class="op" id="1635098">(</span><span class="op" id="1635099">*</span><span class="ident" id="1635100">pollDesc</span><span class="op" id="1635108">)</span><span class="op" id="1635109">,</span>&nbsp;<span class="ident" id="1635111">seq</span><span class="op" id="1635114">,</span>&nbsp;<span class="ident" id="1635116">true</span><span class="op" id="1635120">,</span>&nbsp;<span class="ident" id="1635122">false</span><span class="op" id="1635127">)</span><br>
<span class="lineno"></span><span class="op" id="1635129">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">430</span><span class="keyword" id="1635132">func</span>&nbsp;<span class="ident" id="1635137">netpollWriteDeadline</span><span class="op" id="1635157">(</span><span class="ident" id="1635158">arg</span>&nbsp;<span class="keyword" id="1635162">interface</span><span class="op" id="1635171">{</span><span class="op" id="1635172">}</span><span class="op" id="1635173">,</span>&nbsp;<span class="ident" id="1635175">seq</span>&nbsp;<span class="builtintype" id="1635179">uintptr</span><span class="op" id="1635186">)</span>&nbsp;<span class="op" id="1635188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1635191">netpolldeadlineimpl</span><span class="op" id="1635210">(</span><span class="ident" id="1635211">arg</span><span class="op" id="1635214">.</span><span class="op" id="1635215">(</span><span class="op" id="1635216">*</span><span class="ident" id="1635217">pollDesc</span><span class="op" id="1635225">)</span><span class="op" id="1635226">,</span>&nbsp;<span class="ident" id="1635228">seq</span><span class="op" id="1635231">,</span>&nbsp;<span class="ident" id="1635233">false</span><span class="op" id="1635238">,</span>&nbsp;<span class="ident" id="1635240">true</span><span class="op" id="1635244">)</span><br>
<span class="lineno"></span><span class="op" id="1635246">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1635249">func</span>&nbsp;<span class="op" id="1635254">(</span><span class="ident" id="1635255">c</span>&nbsp;<span class="op" id="1635257">*</span><span class="ident" id="1635258">pollCache</span><span class="op" id="1635267">)</span>&nbsp;<span class="ident" id="1635269">alloc</span><span class="op" id="1635274">(</span><span class="op" id="1635275">)</span>&nbsp;<span class="op" id="1635277">*</span><span class="ident" id="1635278">pollDesc</span>&nbsp;<span class="op" id="1635287">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1635290">lock</span><span class="op" id="1635294">(</span><span class="op" id="1635295">&amp;</span><span class="ident" id="1635296">c</span><span class="op" id="1635297">.</span><span class="ident" id="1635298">lock</span><span class="op" id="1635302">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1635305">if</span>&nbsp;<span class="ident" id="1635308">c</span><span class="op" id="1635309">.</span><span class="ident" id="1635310">first</span>&nbsp;<span class="op" id="1635316">==</span>&nbsp;<span class="ident" id="1635319">nil</span>&nbsp;<span class="op" id="1635323">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1635327">const</span>&nbsp;<span class="ident" id="1635333">pdSize</span>&nbsp;<span class="op" id="1635340">=</span>&nbsp;<span class="ident" id="1635342">unsafe</span><span class="op" id="1635348">.</span><span class="ident" id="1635349">Sizeof</span><span class="op" id="1635355">(</span><span class="ident" id="1635356">pollDesc</span><span class="op" id="1635364">{</span><span class="op" id="1635365">}</span><span class="op" id="1635366">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1635370">n</span>&nbsp;<span class="op" id="1635372">:=</span>&nbsp;<span class="ident" id="1635375">pollBlockSize</span>&nbsp;<span class="op" id="1635389">/</span>&nbsp;<span class="ident" id="1635391">pdSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1635400">if</span>&nbsp;<span class="ident" id="1635403">n</span>&nbsp;<span class="op" id="1635405">==</span>&nbsp;<span class="num" id="1635408">0</span>&nbsp;<span class="op" id="1635410">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1635415">n</span>&nbsp;<span class="op" id="1635417">=</span>&nbsp;<span class="num" id="1635419">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1635423">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1635427">//&nbsp;Must&nbsp;be&nbsp;in&nbsp;non-GC&nbsp;memory&nbsp;because&nbsp;can&nbsp;be&nbsp;referenced</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1635483">//&nbsp;only&nbsp;from&nbsp;epoll/kqueue&nbsp;internals.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1635522">mem</span>&nbsp;<span class="op" id="1635526">:=</span>&nbsp;<span class="ident" id="1635529">persistentalloc</span><span class="op" id="1635544">(</span><span class="ident" id="1635545">n</span><span class="op" id="1635546">*</span><span class="ident" id="1635547">pdSize</span><span class="op" id="1635553">,</span>&nbsp;<span class="num" id="1635555">0</span><span class="op" id="1635556">,</span>&nbsp;<span class="op" id="1635558">&amp;</span><span class="ident" id="1635559">memstats</span><span class="op" id="1635567">.</span><span class="ident" id="1635568">other_sys</span><span class="op" id="1635577">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1635581">for</span>&nbsp;<span class="ident" id="1635585">i</span>&nbsp;<span class="op" id="1635587">:=</span>&nbsp;<span class="builtintype" id="1635590">uintptr</span><span class="op" id="1635597">(</span><span class="num" id="1635598">0</span><span class="op" id="1635599">)</span><span class="op" id="1635600">;</span>&nbsp;<span class="ident" id="1635602">i</span>&nbsp;<span class="op" id="1635604">&lt;</span>&nbsp;<span class="ident" id="1635606">n</span><span class="op" id="1635607">;</span>&nbsp;<span class="ident" id="1635609">i</span><span class="op" id="1635610">++</span>&nbsp;<span class="op" id="1635613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1635618">pd</span>&nbsp;<span class="op" id="1635621">:=</span>&nbsp;<span class="op" id="1635624">(</span><span class="op" id="1635625">*</span><span class="ident" id="1635626">pollDesc</span><span class="op" id="1635634">)</span><span class="op" id="1635635">(</span><span class="ident" id="1635636">add</span><span class="op" id="1635639">(</span><span class="ident" id="1635640">mem</span><span class="op" id="1635643">,</span>&nbsp;<span class="ident" id="1635645">i</span><span class="op" id="1635646">*</span><span class="ident" id="1635647">pdSize</span><span class="op" id="1635653">)</span><span class="op" id="1635654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1635659">pd</span><span class="op" id="1635661">.</span><span class="ident" id="1635662">link</span>&nbsp;<span class="op" id="1635667">=</span>&nbsp;<span class="ident" id="1635669">c</span><span class="op" id="1635670">.</span><span class="ident" id="1635671">first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1635680">c</span><span class="op" id="1635681">.</span><span class="ident" id="1635682">first</span>&nbsp;<span class="op" id="1635688">=</span>&nbsp;<span class="ident" id="1635690">pd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1635695">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1635698">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1635701">pd</span>&nbsp;<span class="op" id="1635704">:=</span>&nbsp;<span class="ident" id="1635707">c</span><span class="op" id="1635708">.</span><span class="ident" id="1635709">first</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1635716">c</span><span class="op" id="1635717">.</span><span class="ident" id="1635718">first</span>&nbsp;<span class="op" id="1635724">=</span>&nbsp;<span class="ident" id="1635726">pd</span><span class="op" id="1635728">.</span><span class="ident" id="1635729">link</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1635735">unlock</span><span class="op" id="1635741">(</span><span class="op" id="1635742">&amp;</span><span class="ident" id="1635743">c</span><span class="op" id="1635744">.</span><span class="ident" id="1635745">lock</span><span class="op" id="1635749">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1635752">return</span>&nbsp;<span class="ident" id="1635759">pd</span><br>
<span class="lineno">455</span><span class="op" id="1635762">}</span>
</div>
</body>
</html>
