<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>compress/bzip2</h2>
<ul>
<li><a href="/gostd/compress/bzip2/bit_reader.go.html">bit_reader.go</a></li>
<li><a href="/gostd/compress/bzip2/bzip2.go.html" class="current">bzip2.go</a></li>
<li><a href="/gostd/compress/bzip2/bzip2_test.go.html">bzip2_test.go</a></li>
<li><a href="/gostd/compress/bzip2/huffman.go.html">huffman.go</a></li>
<li><a href="/gostd/compress/bzip2/move_to_front.go.html">move_to_front.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6280123">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6280178">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6280232">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6280283">//&nbsp;Package&nbsp;bzip2&nbsp;implements&nbsp;bzip2&nbsp;decompression.</span><br>
<span class="lineno"></span><span class="keyword" id="6280332">package</span>&nbsp;<span class="ident" id="6280340">bzip2</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6280347">import</span>&nbsp;<span class="string" id="6280354">&#34;io&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="comment" id="6280360">//&nbsp;There&#39;s&nbsp;no&nbsp;RFC&nbsp;for&nbsp;bzip2.&nbsp;I&nbsp;used&nbsp;the&nbsp;Wikipedia&nbsp;page&nbsp;for&nbsp;reference&nbsp;and&nbsp;a&nbsp;lot</span><br>
<span class="lineno"></span><span class="comment" id="6280439">//&nbsp;of&nbsp;guessing:&nbsp;http://en.wikipedia.org/wiki/Bzip2</span><br>
<span class="lineno"></span><span class="comment" id="6280490">//&nbsp;The&nbsp;source&nbsp;code&nbsp;to&nbsp;pyflate&nbsp;was&nbsp;useful&nbsp;for&nbsp;debugging:</span><br>
<span class="lineno"></span><span class="comment" id="6280546">//&nbsp;http://www.paul.sladen.org/projects/pyflate</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="comment" id="6280594">//&nbsp;A&nbsp;StructuralError&nbsp;is&nbsp;returned&nbsp;when&nbsp;the&nbsp;bzip2&nbsp;data&nbsp;is&nbsp;found&nbsp;to&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="6280662">//&nbsp;syntactically&nbsp;invalid.</span><br>
<span class="lineno"></span><span class="keyword" id="6280688">type</span>&nbsp;<span class="ident" id="6280693">StructuralError</span>&nbsp;<span class="builtintype" id="6280709">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6280717">func</span>&nbsp;<span class="op" id="6280722">(</span><span class="ident" id="6280723">s</span>&nbsp;<span class="ident" id="6280725">StructuralError</span><span class="op" id="6280740">)</span>&nbsp;<span class="ident" id="6280742">Error</span><span class="op" id="6280747">(</span><span class="op" id="6280748">)</span>&nbsp;<span class="builtintype" id="6280750">string</span>&nbsp;<span class="op" id="6280757">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6280760">return</span>&nbsp;<span class="string" id="6280767">&#34;bzip2&nbsp;data&nbsp;invalid:&nbsp;&#34;</span>&nbsp;<span class="op" id="6280790">+</span>&nbsp;<span class="builtintype" id="6280792">string</span><span class="op" id="6280798">(</span><span class="ident" id="6280799">s</span><span class="op" id="6280800">)</span><br>
<span class="lineno"></span><span class="op" id="6280802">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6280805">//&nbsp;A&nbsp;reader&nbsp;decompresses&nbsp;bzip2&nbsp;compressed&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="6280853">type</span>&nbsp;<span class="ident" id="6280858">reader</span>&nbsp;<span class="keyword" id="6280865">struct</span>&nbsp;<span class="op" id="6280872">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6280875">br</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6280888">bitReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6280899">fileCRC</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6280912">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6280920">blockCRC</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6280933">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6280941">wantBlockCRC</span>&nbsp;<span class="builtintype" id="6280954">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6280962">setupDone</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6280975">bool</span>&nbsp;<span class="comment" id="6280980">//&nbsp;true&nbsp;if&nbsp;we&nbsp;have&nbsp;parsed&nbsp;the&nbsp;bzip2&nbsp;header.</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6281025">blockSize</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6281038">int</span>&nbsp;&nbsp;<span class="comment" id="6281043">//&nbsp;blockSize&nbsp;in&nbsp;bytes,&nbsp;i.e.&nbsp;900&nbsp;*&nbsp;1024.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6281084">eof</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6281097">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6281103">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6281116">[</span><span class="op" id="6281117">]</span><span class="builtintype" id="6281118">byte</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6281126">//&nbsp;stores&nbsp;Burrows-Wheeler&nbsp;transformed&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6281171">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6281184">[</span><span class="num" id="6281185">256</span><span class="op" id="6281188">]</span><span class="builtintype" id="6281189">uint</span>&nbsp;<span class="comment" id="6281194">//&nbsp;the&nbsp;`C&#39;&nbsp;array&nbsp;for&nbsp;the&nbsp;inverse&nbsp;BWT.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6281233">tt</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6281246">[</span><span class="op" id="6281247">]</span><span class="builtintype" id="6281248">uint32</span>&nbsp;&nbsp;<span class="comment" id="6281256">//&nbsp;mirrors&nbsp;the&nbsp;`tt&#39;&nbsp;array&nbsp;in&nbsp;the&nbsp;bzip2&nbsp;source&nbsp;and&nbsp;contains&nbsp;the&nbsp;P&nbsp;array&nbsp;in&nbsp;the&nbsp;upper&nbsp;24&nbsp;bits.</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6281350">tPos</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6281363">uint32</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6281373">//&nbsp;Index&nbsp;of&nbsp;the&nbsp;next&nbsp;output&nbsp;byte&nbsp;in&nbsp;tt.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6281415">preRLE</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6281427">[</span><span class="op" id="6281428">]</span><span class="builtintype" id="6281429">uint32</span>&nbsp;<span class="comment" id="6281436">//&nbsp;contains&nbsp;the&nbsp;RLE&nbsp;data&nbsp;still&nbsp;to&nbsp;be&nbsp;processed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6281485">preRLEUsed</span>&nbsp;&nbsp;<span class="builtintype" id="6281497">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6281506">//&nbsp;number&nbsp;of&nbsp;entries&nbsp;of&nbsp;preRLE&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6281544">lastByte</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6281556">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6281565">//&nbsp;the&nbsp;last&nbsp;byte&nbsp;value&nbsp;seen.</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6281595">byteRepeats</span>&nbsp;<span class="builtintype" id="6281607">uint</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6281616">//&nbsp;the&nbsp;number&nbsp;of&nbsp;repeats&nbsp;of&nbsp;lastByte&nbsp;seen.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6281660">repeats</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6281672">uint</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6281681">//&nbsp;the&nbsp;number&nbsp;of&nbsp;copies&nbsp;of&nbsp;lastByte&nbsp;to&nbsp;output.</span><br>
<span class="lineno"></span><span class="op" id="6281728">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6281731">//&nbsp;NewReader&nbsp;returns&nbsp;an&nbsp;io.Reader&nbsp;which&nbsp;decompresses&nbsp;bzip2&nbsp;data&nbsp;from&nbsp;r.</span><br>
<span class="lineno">45</span><span class="comment" id="6281803">//&nbsp;If&nbsp;r&nbsp;does&nbsp;not&nbsp;also&nbsp;implement&nbsp;io.ByteReader,</span><br>
<span class="lineno"></span><span class="comment" id="6281850">//&nbsp;the&nbsp;decompressor&nbsp;may&nbsp;read&nbsp;more&nbsp;data&nbsp;than&nbsp;necessary&nbsp;from&nbsp;r.</span><br>
<span class="lineno"></span><span class="keyword" id="6281912">func</span>&nbsp;<span class="ident" id="6281917">NewReader</span><span class="op" id="6281926">(</span><span class="ident" id="6281927">r</span>&nbsp;<span class="ident" id="6281929">io</span><span class="op" id="6281931">.</span><span class="ident" id="6281932">Reader</span><span class="op" id="6281938">)</span>&nbsp;<span class="ident" id="6281940">io</span><span class="op" id="6281942">.</span><span class="ident" id="6281943">Reader</span>&nbsp;<span class="op" id="6281950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6281953">bz2</span>&nbsp;<span class="op" id="6281957">:=</span>&nbsp;<span class="builtinfunc" id="6281960">new</span><span class="op" id="6281963">(</span><span class="ident" id="6281964">reader</span><span class="op" id="6281970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6281973">bz2</span><span class="op" id="6281976">.</span><span class="ident" id="6281977">br</span>&nbsp;<span class="op" id="6281980">=</span>&nbsp;<span class="ident" id="6281982">newBitReader</span><span class="op" id="6281994">(</span><span class="ident" id="6281995">r</span><span class="op" id="6281996">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6281999">return</span>&nbsp;<span class="ident" id="6282006">bz2</span><br>
<span class="lineno"></span><span class="op" id="6282010">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6282013">const</span>&nbsp;<span class="ident" id="6282019">bzip2FileMagic</span>&nbsp;<span class="op" id="6282034">=</span>&nbsp;<span class="num" id="6282036">0x425a</span>&nbsp;<span class="comment" id="6282043">//&nbsp;&#34;BZ&#34;</span><br>
<span class="lineno"></span><span class="keyword" id="6282051">const</span>&nbsp;<span class="ident" id="6282057">bzip2BlockMagic</span>&nbsp;<span class="op" id="6282073">=</span>&nbsp;<span class="num" id="6282075">0x314159265359</span><br>
<span class="lineno">55</span><span class="keyword" id="6282090">const</span>&nbsp;<span class="ident" id="6282096">bzip2FinalMagic</span>&nbsp;<span class="op" id="6282112">=</span>&nbsp;<span class="num" id="6282114">0x177245385090</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6282130">//&nbsp;setup&nbsp;parses&nbsp;the&nbsp;bzip2&nbsp;header.</span><br>
<span class="lineno"></span><span class="keyword" id="6282164">func</span>&nbsp;<span class="op" id="6282169">(</span><span class="ident" id="6282170">bz2</span>&nbsp;<span class="op" id="6282174">*</span><span class="ident" id="6282175">reader</span><span class="op" id="6282181">)</span>&nbsp;<span class="ident" id="6282183">setup</span><span class="op" id="6282188">(</span><span class="ident" id="6282189">needMagic</span>&nbsp;<span class="builtintype" id="6282199">bool</span><span class="op" id="6282203">)</span>&nbsp;<span class="builtintype" id="6282205">error</span>&nbsp;<span class="op" id="6282211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6282214">br</span>&nbsp;<span class="op" id="6282217">:=</span>&nbsp;<span class="op" id="6282220">&amp;</span><span class="ident" id="6282221">bz2</span><span class="op" id="6282224">.</span><span class="ident" id="6282225">br</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6282230">if</span>&nbsp;<span class="ident" id="6282233">needMagic</span>&nbsp;<span class="op" id="6282243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6282247">magic</span>&nbsp;<span class="op" id="6282253">:=</span>&nbsp;<span class="ident" id="6282256">br</span><span class="op" id="6282258">.</span><span class="ident" id="6282259">ReadBits</span><span class="op" id="6282267">(</span><span class="num" id="6282268">16</span><span class="op" id="6282270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6282274">if</span>&nbsp;<span class="ident" id="6282277">magic</span>&nbsp;<span class="op" id="6282283">!=</span>&nbsp;<span class="ident" id="6282286">bzip2FileMagic</span>&nbsp;<span class="op" id="6282301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6282306">return</span>&nbsp;<span class="ident" id="6282313">StructuralError</span><span class="op" id="6282328">(</span><span class="string" id="6282329">&#34;bad&nbsp;magic&nbsp;value&#34;</span><span class="op" id="6282346">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6282350">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6282353">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6282357">t</span>&nbsp;<span class="op" id="6282359">:=</span>&nbsp;<span class="ident" id="6282362">br</span><span class="op" id="6282364">.</span><span class="ident" id="6282365">ReadBits</span><span class="op" id="6282373">(</span><span class="num" id="6282374">8</span><span class="op" id="6282375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6282378">if</span>&nbsp;<span class="ident" id="6282381">t</span>&nbsp;<span class="op" id="6282383">!=</span>&nbsp;<span class="string" id="6282386">&#39;h&#39;</span>&nbsp;<span class="op" id="6282390">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6282394">return</span>&nbsp;<span class="ident" id="6282401">StructuralError</span><span class="op" id="6282416">(</span><span class="string" id="6282417">&#34;non-Huffman&nbsp;entropy&nbsp;encoding&#34;</span><span class="op" id="6282447">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6282450">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6282454">level</span>&nbsp;<span class="op" id="6282460">:=</span>&nbsp;<span class="ident" id="6282463">br</span><span class="op" id="6282465">.</span><span class="ident" id="6282466">ReadBits</span><span class="op" id="6282474">(</span><span class="num" id="6282475">8</span><span class="op" id="6282476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6282479">if</span>&nbsp;<span class="ident" id="6282482">level</span>&nbsp;<span class="op" id="6282488">&lt;</span>&nbsp;<span class="string" id="6282490">&#39;1&#39;</span>&nbsp;<span class="op" id="6282494">||</span>&nbsp;<span class="ident" id="6282497">level</span>&nbsp;<span class="op" id="6282503">&gt;</span>&nbsp;<span class="string" id="6282505">&#39;9&#39;</span>&nbsp;<span class="op" id="6282509">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6282513">return</span>&nbsp;<span class="ident" id="6282520">StructuralError</span><span class="op" id="6282535">(</span><span class="string" id="6282536">&#34;invalid&nbsp;compression&nbsp;level&#34;</span><span class="op" id="6282563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6282566">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6282570">bz2</span><span class="op" id="6282573">.</span><span class="ident" id="6282574">fileCRC</span>&nbsp;<span class="op" id="6282582">=</span>&nbsp;<span class="num" id="6282584">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6282587">bz2</span><span class="op" id="6282590">.</span><span class="ident" id="6282591">blockSize</span>&nbsp;<span class="op" id="6282601">=</span>&nbsp;<span class="num" id="6282603">100</span>&nbsp;<span class="op" id="6282607">*</span>&nbsp;<span class="num" id="6282609">1024</span>&nbsp;<span class="op" id="6282614">*</span>&nbsp;<span class="op" id="6282616">(</span><span class="builtintype" id="6282617">int</span><span class="op" id="6282620">(</span><span class="ident" id="6282621">level</span><span class="op" id="6282626">)</span>&nbsp;<span class="op" id="6282628">-</span>&nbsp;<span class="string" id="6282630">&#39;0&#39;</span><span class="op" id="6282633">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6282636">if</span>&nbsp;<span class="ident" id="6282639">bz2</span><span class="op" id="6282642">.</span><span class="ident" id="6282643">blockSize</span>&nbsp;<span class="op" id="6282653">&gt;</span>&nbsp;<span class="builtinfunc" id="6282655">len</span><span class="op" id="6282658">(</span><span class="ident" id="6282659">bz2</span><span class="op" id="6282662">.</span><span class="ident" id="6282663">tt</span><span class="op" id="6282665">)</span>&nbsp;<span class="op" id="6282667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6282671">bz2</span><span class="op" id="6282674">.</span><span class="ident" id="6282675">tt</span>&nbsp;<span class="op" id="6282678">=</span>&nbsp;<span class="builtinfunc" id="6282680">make</span><span class="op" id="6282684">(</span><span class="op" id="6282685">[</span><span class="op" id="6282686">]</span><span class="builtintype" id="6282687">uint32</span><span class="op" id="6282693">,</span>&nbsp;<span class="ident" id="6282695">bz2</span><span class="op" id="6282698">.</span><span class="ident" id="6282699">blockSize</span><span class="op" id="6282708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6282711">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6282714">return</span>&nbsp;<span class="builtintype" id="6282721">nil</span><br>
<span class="lineno"></span><span class="op" id="6282725">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span><span class="keyword" id="6282728">func</span>&nbsp;<span class="op" id="6282733">(</span><span class="ident" id="6282734">bz2</span>&nbsp;<span class="op" id="6282738">*</span><span class="ident" id="6282739">reader</span><span class="op" id="6282745">)</span>&nbsp;<span class="ident" id="6282747">Read</span><span class="op" id="6282751">(</span><span class="ident" id="6282752">buf</span>&nbsp;<span class="op" id="6282756">[</span><span class="op" id="6282757">]</span><span class="builtintype" id="6282758">byte</span><span class="op" id="6282762">)</span>&nbsp;<span class="op" id="6282764">(</span><span class="ident" id="6282765">n</span>&nbsp;<span class="builtintype" id="6282767">int</span><span class="op" id="6282770">,</span>&nbsp;<span class="ident" id="6282772">err</span>&nbsp;<span class="builtintype" id="6282776">error</span><span class="op" id="6282781">)</span>&nbsp;<span class="op" id="6282783">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6282786">if</span>&nbsp;<span class="ident" id="6282789">bz2</span><span class="op" id="6282792">.</span><span class="ident" id="6282793">eof</span>&nbsp;<span class="op" id="6282797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6282801">return</span>&nbsp;<span class="num" id="6282808">0</span><span class="op" id="6282809">,</span>&nbsp;<span class="ident" id="6282811">io</span><span class="op" id="6282813">.</span><span class="ident" id="6282814">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6282819">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6282823">if</span>&nbsp;<span class="op" id="6282826">!</span><span class="ident" id="6282827">bz2</span><span class="op" id="6282830">.</span><span class="ident" id="6282831">setupDone</span>&nbsp;<span class="op" id="6282841">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6282845">err</span>&nbsp;<span class="op" id="6282849">=</span>&nbsp;<span class="ident" id="6282851">bz2</span><span class="op" id="6282854">.</span><span class="ident" id="6282855">setup</span><span class="op" id="6282860">(</span><span class="builtintype" id="6282861">true</span><span class="op" id="6282865">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6282869">brErr</span>&nbsp;<span class="op" id="6282875">:=</span>&nbsp;<span class="ident" id="6282878">bz2</span><span class="op" id="6282881">.</span><span class="ident" id="6282882">br</span><span class="op" id="6282884">.</span><span class="ident" id="6282885">Err</span><span class="op" id="6282888">(</span><span class="op" id="6282889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6282893">if</span>&nbsp;<span class="ident" id="6282896">brErr</span>&nbsp;<span class="op" id="6282902">!=</span>&nbsp;<span class="builtintype" id="6282905">nil</span>&nbsp;<span class="op" id="6282909">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6282914">err</span>&nbsp;<span class="op" id="6282918">=</span>&nbsp;<span class="ident" id="6282920">brErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6282928">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6282932">if</span>&nbsp;<span class="ident" id="6282935">err</span>&nbsp;<span class="op" id="6282939">!=</span>&nbsp;<span class="builtintype" id="6282942">nil</span>&nbsp;<span class="op" id="6282946">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6282951">return</span>&nbsp;<span class="num" id="6282958">0</span><span class="op" id="6282959">,</span>&nbsp;<span class="ident" id="6282961">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6282967">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6282971">bz2</span><span class="op" id="6282974">.</span><span class="ident" id="6282975">setupDone</span>&nbsp;<span class="op" id="6282985">=</span>&nbsp;<span class="builtintype" id="6282987">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6282993">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6282997">n</span><span class="op" id="6282998">,</span>&nbsp;<span class="ident" id="6283000">err</span>&nbsp;<span class="op" id="6283004">=</span>&nbsp;<span class="ident" id="6283006">bz2</span><span class="op" id="6283009">.</span><span class="ident" id="6283010">read</span><span class="op" id="6283014">(</span><span class="ident" id="6283015">buf</span><span class="op" id="6283018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6283021">brErr</span>&nbsp;<span class="op" id="6283027">:=</span>&nbsp;<span class="ident" id="6283030">bz2</span><span class="op" id="6283033">.</span><span class="ident" id="6283034">br</span><span class="op" id="6283036">.</span><span class="ident" id="6283037">Err</span><span class="op" id="6283040">(</span><span class="op" id="6283041">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6283044">if</span>&nbsp;<span class="ident" id="6283047">brErr</span>&nbsp;<span class="op" id="6283053">!=</span>&nbsp;<span class="builtintype" id="6283056">nil</span>&nbsp;<span class="op" id="6283060">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6283064">err</span>&nbsp;<span class="op" id="6283068">=</span>&nbsp;<span class="ident" id="6283070">brErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6283077">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6283080">return</span><br>
<span class="lineno"></span><span class="op" id="6283087">}</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span><span class="keyword" id="6283090">func</span>&nbsp;<span class="op" id="6283095">(</span><span class="ident" id="6283096">bz2</span>&nbsp;<span class="op" id="6283100">*</span><span class="ident" id="6283101">reader</span><span class="op" id="6283107">)</span>&nbsp;<span class="ident" id="6283109">readFromBlock</span><span class="op" id="6283122">(</span><span class="ident" id="6283123">buf</span>&nbsp;<span class="op" id="6283127">[</span><span class="op" id="6283128">]</span><span class="builtintype" id="6283129">byte</span><span class="op" id="6283133">)</span>&nbsp;<span class="builtintype" id="6283135">int</span>&nbsp;<span class="op" id="6283139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6283142">//&nbsp;bzip2&nbsp;is&nbsp;a&nbsp;block&nbsp;based&nbsp;compressor,&nbsp;except&nbsp;that&nbsp;it&nbsp;has&nbsp;a&nbsp;run-length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6283213">//&nbsp;preprocessing&nbsp;step.&nbsp;The&nbsp;block&nbsp;based&nbsp;nature&nbsp;means&nbsp;that&nbsp;we&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6283278">//&nbsp;preallocate&nbsp;fixed-size&nbsp;buffers&nbsp;and&nbsp;reuse&nbsp;them.&nbsp;However,&nbsp;the&nbsp;RLE</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6283346">//&nbsp;preprocessing&nbsp;would&nbsp;require&nbsp;allocating&nbsp;huge&nbsp;buffers&nbsp;to&nbsp;store&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6283415">//&nbsp;maximum&nbsp;expansion.&nbsp;Thus&nbsp;we&nbsp;process&nbsp;blocks&nbsp;all&nbsp;at&nbsp;once,&nbsp;except&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6283485">//&nbsp;the&nbsp;RLE&nbsp;which&nbsp;we&nbsp;decompress&nbsp;as&nbsp;required.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6283530">n</span>&nbsp;<span class="op" id="6283532">:=</span>&nbsp;<span class="num" id="6283535">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6283538">for</span>&nbsp;<span class="op" id="6283542">(</span><span class="ident" id="6283543">bz2</span><span class="op" id="6283546">.</span><span class="ident" id="6283547">repeats</span>&nbsp;<span class="op" id="6283555">&gt;</span>&nbsp;<span class="num" id="6283557">0</span>&nbsp;<span class="op" id="6283559">||</span>&nbsp;<span class="ident" id="6283562">bz2</span><span class="op" id="6283565">.</span><span class="ident" id="6283566">preRLEUsed</span>&nbsp;<span class="op" id="6283577">&lt;</span>&nbsp;<span class="builtinfunc" id="6283579">len</span><span class="op" id="6283582">(</span><span class="ident" id="6283583">bz2</span><span class="op" id="6283586">.</span><span class="ident" id="6283587">preRLE</span><span class="op" id="6283593">)</span><span class="op" id="6283594">)</span>&nbsp;<span class="op" id="6283596">&amp;&amp;</span>&nbsp;<span class="ident" id="6283599">n</span>&nbsp;<span class="op" id="6283601">&lt;</span>&nbsp;<span class="builtinfunc" id="6283603">len</span><span class="op" id="6283606">(</span><span class="ident" id="6283607">buf</span><span class="op" id="6283610">)</span>&nbsp;<span class="op" id="6283612">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6283616">//&nbsp;We&nbsp;have&nbsp;RLE&nbsp;data&nbsp;pending.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6283648">//&nbsp;The&nbsp;run-length&nbsp;encoding&nbsp;works&nbsp;like&nbsp;this:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6283694">//&nbsp;Any&nbsp;sequence&nbsp;of&nbsp;four&nbsp;equal&nbsp;bytes&nbsp;is&nbsp;followed&nbsp;by&nbsp;a&nbsp;length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6283756">//&nbsp;byte&nbsp;which&nbsp;contains&nbsp;the&nbsp;number&nbsp;of&nbsp;repeats&nbsp;of&nbsp;that&nbsp;byte&nbsp;to</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6283819">//&nbsp;include.&nbsp;(The&nbsp;number&nbsp;of&nbsp;repeats&nbsp;can&nbsp;be&nbsp;zero.)&nbsp;Because&nbsp;we&nbsp;are</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6283885">//&nbsp;decompressing&nbsp;on-demand&nbsp;our&nbsp;state&nbsp;is&nbsp;kept&nbsp;in&nbsp;the&nbsp;reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6283946">//&nbsp;object.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6283960">if</span>&nbsp;<span class="ident" id="6283963">bz2</span><span class="op" id="6283966">.</span><span class="ident" id="6283967">repeats</span>&nbsp;<span class="op" id="6283975">&gt;</span>&nbsp;<span class="num" id="6283977">0</span>&nbsp;<span class="op" id="6283979">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6283984">buf</span><span class="op" id="6283987">[</span><span class="ident" id="6283988">n</span><span class="op" id="6283989">]</span>&nbsp;<span class="op" id="6283991">=</span>&nbsp;<span class="builtintype" id="6283993">byte</span><span class="op" id="6283997">(</span><span class="ident" id="6283998">bz2</span><span class="op" id="6284001">.</span><span class="ident" id="6284002">lastByte</span><span class="op" id="6284010">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6284015">n</span><span class="op" id="6284016">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6284022">bz2</span><span class="op" id="6284025">.</span><span class="ident" id="6284026">repeats</span><span class="op" id="6284033">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6284039">if</span>&nbsp;<span class="ident" id="6284042">bz2</span><span class="op" id="6284045">.</span><span class="ident" id="6284046">repeats</span>&nbsp;<span class="op" id="6284054">==</span>&nbsp;<span class="num" id="6284057">0</span>&nbsp;<span class="op" id="6284059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6284065">bz2</span><span class="op" id="6284068">.</span><span class="ident" id="6284069">lastByte</span>&nbsp;<span class="op" id="6284078">=</span>&nbsp;<span class="op" id="6284080">-</span><span class="num" id="6284081">1</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6284086">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6284091">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6284102">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6284107">bz2</span><span class="op" id="6284110">.</span><span class="ident" id="6284111">tPos</span>&nbsp;<span class="op" id="6284116">=</span>&nbsp;<span class="ident" id="6284118">bz2</span><span class="op" id="6284121">.</span><span class="ident" id="6284122">preRLE</span><span class="op" id="6284128">[</span><span class="ident" id="6284129">bz2</span><span class="op" id="6284132">.</span><span class="ident" id="6284133">tPos</span><span class="op" id="6284137">]</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6284141">b</span>&nbsp;<span class="op" id="6284143">:=</span>&nbsp;<span class="builtintype" id="6284146">byte</span><span class="op" id="6284150">(</span><span class="ident" id="6284151">bz2</span><span class="op" id="6284154">.</span><span class="ident" id="6284155">tPos</span><span class="op" id="6284159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6284163">bz2</span><span class="op" id="6284166">.</span><span class="ident" id="6284167">tPos</span>&nbsp;<span class="op" id="6284172">&gt;&gt;=</span>&nbsp;<span class="num" id="6284176">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6284180">bz2</span><span class="op" id="6284183">.</span><span class="ident" id="6284184">preRLEUsed</span><span class="op" id="6284194">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6284200">if</span>&nbsp;<span class="ident" id="6284203">bz2</span><span class="op" id="6284206">.</span><span class="ident" id="6284207">byteRepeats</span>&nbsp;<span class="op" id="6284219">==</span>&nbsp;<span class="num" id="6284222">3</span>&nbsp;<span class="op" id="6284224">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6284229">bz2</span><span class="op" id="6284232">.</span><span class="ident" id="6284233">repeats</span>&nbsp;<span class="op" id="6284241">=</span>&nbsp;<span class="builtintype" id="6284243">uint</span><span class="op" id="6284247">(</span><span class="ident" id="6284248">b</span><span class="op" id="6284249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6284254">bz2</span><span class="op" id="6284257">.</span><span class="ident" id="6284258">byteRepeats</span>&nbsp;<span class="op" id="6284270">=</span>&nbsp;<span class="num" id="6284272">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6284277">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6284288">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6284293">if</span>&nbsp;<span class="ident" id="6284296">bz2</span><span class="op" id="6284299">.</span><span class="ident" id="6284300">lastByte</span>&nbsp;<span class="op" id="6284309">==</span>&nbsp;<span class="builtintype" id="6284312">int</span><span class="op" id="6284315">(</span><span class="ident" id="6284316">b</span><span class="op" id="6284317">)</span>&nbsp;<span class="op" id="6284319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6284324">bz2</span><span class="op" id="6284327">.</span><span class="ident" id="6284328">byteRepeats</span><span class="op" id="6284339">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6284344">}</span>&nbsp;<span class="keyword" id="6284346">else</span>&nbsp;<span class="op" id="6284351">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6284356">bz2</span><span class="op" id="6284359">.</span><span class="ident" id="6284360">byteRepeats</span>&nbsp;<span class="op" id="6284372">=</span>&nbsp;<span class="num" id="6284374">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6284378">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6284382">bz2</span><span class="op" id="6284385">.</span><span class="ident" id="6284386">lastByte</span>&nbsp;<span class="op" id="6284395">=</span>&nbsp;<span class="builtintype" id="6284397">int</span><span class="op" id="6284400">(</span><span class="ident" id="6284401">b</span><span class="op" id="6284402">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6284407">buf</span><span class="op" id="6284410">[</span><span class="ident" id="6284411">n</span><span class="op" id="6284412">]</span>&nbsp;<span class="op" id="6284414">=</span>&nbsp;<span class="ident" id="6284416">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6284420">n</span><span class="op" id="6284421">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6284425">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6284429">return</span>&nbsp;<span class="ident" id="6284436">n</span><br>
<span class="lineno"></span><span class="op" id="6284438">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6284441">func</span>&nbsp;<span class="op" id="6284446">(</span><span class="ident" id="6284447">bz2</span>&nbsp;<span class="op" id="6284451">*</span><span class="ident" id="6284452">reader</span><span class="op" id="6284458">)</span>&nbsp;<span class="ident" id="6284460">read</span><span class="op" id="6284464">(</span><span class="ident" id="6284465">buf</span>&nbsp;<span class="op" id="6284469">[</span><span class="op" id="6284470">]</span><span class="builtintype" id="6284471">byte</span><span class="op" id="6284475">)</span>&nbsp;<span class="op" id="6284477">(</span><span class="builtintype" id="6284478">int</span><span class="op" id="6284481">,</span>&nbsp;<span class="builtintype" id="6284483">error</span><span class="op" id="6284488">)</span>&nbsp;<span class="op" id="6284490">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6284493">for</span>&nbsp;<span class="op" id="6284497">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6284501">n</span>&nbsp;<span class="op" id="6284503">:=</span>&nbsp;<span class="ident" id="6284506">bz2</span><span class="op" id="6284509">.</span><span class="ident" id="6284510">readFromBlock</span><span class="op" id="6284523">(</span><span class="ident" id="6284524">buf</span><span class="op" id="6284527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6284531">if</span>&nbsp;<span class="ident" id="6284534">n</span>&nbsp;<span class="op" id="6284536">&gt;</span>&nbsp;<span class="num" id="6284538">0</span>&nbsp;<span class="op" id="6284540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6284545">bz2</span><span class="op" id="6284548">.</span><span class="ident" id="6284549">blockCRC</span>&nbsp;<span class="op" id="6284558">=</span>&nbsp;<span class="ident" id="6284560">updateCRC</span><span class="op" id="6284569">(</span><span class="ident" id="6284570">bz2</span><span class="op" id="6284573">.</span><span class="ident" id="6284574">blockCRC</span><span class="op" id="6284582">,</span>&nbsp;<span class="ident" id="6284584">buf</span><span class="op" id="6284587">[</span><span class="op" id="6284588">:</span><span class="ident" id="6284589">n</span><span class="op" id="6284590">]</span><span class="op" id="6284591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6284596">return</span>&nbsp;<span class="ident" id="6284603">n</span><span class="op" id="6284604">,</span>&nbsp;<span class="builtintype" id="6284606">nil</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6284612">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6284617">//&nbsp;End&nbsp;of&nbsp;block.&nbsp;Check&nbsp;CRC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6284647">if</span>&nbsp;<span class="ident" id="6284650">bz2</span><span class="op" id="6284653">.</span><span class="ident" id="6284654">blockCRC</span>&nbsp;<span class="op" id="6284663">!=</span>&nbsp;<span class="ident" id="6284666">bz2</span><span class="op" id="6284669">.</span><span class="ident" id="6284670">wantBlockCRC</span>&nbsp;<span class="op" id="6284683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6284688">bz2</span><span class="op" id="6284691">.</span><span class="ident" id="6284692">br</span><span class="op" id="6284694">.</span><span class="ident" id="6284695">err</span>&nbsp;<span class="op" id="6284699">=</span>&nbsp;<span class="ident" id="6284701">StructuralError</span><span class="op" id="6284716">(</span><span class="string" id="6284717">&#34;block&nbsp;checksum&nbsp;mismatch&#34;</span><span class="op" id="6284742">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6284747">return</span>&nbsp;<span class="num" id="6284754">0</span><span class="op" id="6284755">,</span>&nbsp;<span class="ident" id="6284757">bz2</span><span class="op" id="6284760">.</span><span class="ident" id="6284761">br</span><span class="op" id="6284763">.</span><span class="ident" id="6284764">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6284770">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6284775">//&nbsp;Find&nbsp;next&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6284797">br</span>&nbsp;<span class="op" id="6284800">:=</span>&nbsp;<span class="op" id="6284803">&amp;</span><span class="ident" id="6284804">bz2</span><span class="op" id="6284807">.</span><span class="ident" id="6284808">br</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6284813">switch</span>&nbsp;<span class="ident" id="6284820">br</span><span class="op" id="6284822">.</span><span class="ident" id="6284823">ReadBits64</span><span class="op" id="6284833">(</span><span class="num" id="6284834">48</span><span class="op" id="6284836">)</span>&nbsp;<span class="op" id="6284838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6284842">default</span><span class="op" id="6284849">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6284854">return</span>&nbsp;<span class="num" id="6284861">0</span><span class="op" id="6284862">,</span>&nbsp;<span class="ident" id="6284864">StructuralError</span><span class="op" id="6284879">(</span><span class="string" id="6284880">&#34;bad&nbsp;magic&nbsp;value&nbsp;found&#34;</span><span class="op" id="6284903">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6284908">case</span>&nbsp;<span class="ident" id="6284913">bzip2BlockMagic</span><span class="op" id="6284928">:</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6284933">//&nbsp;Start&nbsp;of&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6284955">err</span>&nbsp;<span class="op" id="6284959">:=</span>&nbsp;<span class="ident" id="6284962">bz2</span><span class="op" id="6284965">.</span><span class="ident" id="6284966">readBlock</span><span class="op" id="6284975">(</span><span class="op" id="6284976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6284981">if</span>&nbsp;<span class="ident" id="6284984">err</span>&nbsp;<span class="op" id="6284988">!=</span>&nbsp;<span class="builtintype" id="6284991">nil</span>&nbsp;<span class="op" id="6284995">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6285001">return</span>&nbsp;<span class="num" id="6285008">0</span><span class="op" id="6285009">,</span>&nbsp;<span class="ident" id="6285011">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6285018">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6285023">case</span>&nbsp;<span class="ident" id="6285028">bzip2FinalMagic</span><span class="op" id="6285043">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6285048">//&nbsp;Check&nbsp;end-of-file&nbsp;CRC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6285077">wantFileCRC</span>&nbsp;<span class="op" id="6285089">:=</span>&nbsp;<span class="builtintype" id="6285092">uint32</span><span class="op" id="6285098">(</span><span class="ident" id="6285099">br</span><span class="op" id="6285101">.</span><span class="ident" id="6285102">ReadBits64</span><span class="op" id="6285112">(</span><span class="num" id="6285113">32</span><span class="op" id="6285115">)</span><span class="op" id="6285116">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6285121">if</span>&nbsp;<span class="ident" id="6285124">br</span><span class="op" id="6285126">.</span><span class="ident" id="6285127">err</span>&nbsp;<span class="op" id="6285131">!=</span>&nbsp;<span class="builtintype" id="6285134">nil</span>&nbsp;<span class="op" id="6285138">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6285144">return</span>&nbsp;<span class="num" id="6285151">0</span><span class="op" id="6285152">,</span>&nbsp;<span class="ident" id="6285154">br</span><span class="op" id="6285156">.</span><span class="ident" id="6285157">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6285164">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6285169">if</span>&nbsp;<span class="ident" id="6285172">bz2</span><span class="op" id="6285175">.</span><span class="ident" id="6285176">fileCRC</span>&nbsp;<span class="op" id="6285184">!=</span>&nbsp;<span class="ident" id="6285187">wantFileCRC</span>&nbsp;<span class="op" id="6285199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6285205">br</span><span class="op" id="6285207">.</span><span class="ident" id="6285208">err</span>&nbsp;<span class="op" id="6285212">=</span>&nbsp;<span class="ident" id="6285214">StructuralError</span><span class="op" id="6285229">(</span><span class="string" id="6285230">&#34;file&nbsp;checksum&nbsp;mismatch&#34;</span><span class="op" id="6285254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6285260">return</span>&nbsp;<span class="num" id="6285267">0</span><span class="op" id="6285268">,</span>&nbsp;<span class="ident" id="6285270">br</span><span class="op" id="6285272">.</span><span class="ident" id="6285273">err</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6285280">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6285286">//&nbsp;Skip&nbsp;ahead&nbsp;to&nbsp;byte&nbsp;boundary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6285321">//&nbsp;Is&nbsp;there&nbsp;a&nbsp;file&nbsp;concatenated&nbsp;to&nbsp;this&nbsp;one?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6285369">//&nbsp;It&nbsp;would&nbsp;start&nbsp;with&nbsp;BZ.</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6285399">if</span>&nbsp;<span class="ident" id="6285402">br</span><span class="op" id="6285404">.</span><span class="ident" id="6285405">bits</span><span class="op" id="6285409">%</span><span class="num" id="6285410">8</span>&nbsp;<span class="op" id="6285412">!=</span>&nbsp;<span class="num" id="6285415">0</span>&nbsp;<span class="op" id="6285417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6285423">br</span><span class="op" id="6285425">.</span><span class="ident" id="6285426">ReadBits</span><span class="op" id="6285434">(</span><span class="ident" id="6285435">br</span><span class="op" id="6285437">.</span><span class="ident" id="6285438">bits</span>&nbsp;<span class="op" id="6285443">%</span>&nbsp;<span class="num" id="6285445">8</span><span class="op" id="6285446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6285451">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6285456">b</span><span class="op" id="6285457">,</span>&nbsp;<span class="ident" id="6285459">err</span>&nbsp;<span class="op" id="6285463">:=</span>&nbsp;<span class="ident" id="6285466">br</span><span class="op" id="6285468">.</span><span class="ident" id="6285469">r</span><span class="op" id="6285470">.</span><span class="ident" id="6285471">ReadByte</span><span class="op" id="6285479">(</span><span class="op" id="6285480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6285485">if</span>&nbsp;<span class="ident" id="6285488">err</span>&nbsp;<span class="op" id="6285492">==</span>&nbsp;<span class="ident" id="6285495">io</span><span class="op" id="6285497">.</span><span class="ident" id="6285498">EOF</span>&nbsp;<span class="op" id="6285502">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6285508">br</span><span class="op" id="6285510">.</span><span class="ident" id="6285511">err</span>&nbsp;<span class="op" id="6285515">=</span>&nbsp;<span class="ident" id="6285517">io</span><span class="op" id="6285519">.</span><span class="ident" id="6285520">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6285528">bz2</span><span class="op" id="6285531">.</span><span class="ident" id="6285532">eof</span>&nbsp;<span class="op" id="6285536">=</span>&nbsp;<span class="builtintype" id="6285538">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6285547">return</span>&nbsp;<span class="num" id="6285554">0</span><span class="op" id="6285555">,</span>&nbsp;<span class="ident" id="6285557">io</span><span class="op" id="6285559">.</span><span class="ident" id="6285560">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6285567">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6285572">if</span>&nbsp;<span class="ident" id="6285575">err</span>&nbsp;<span class="op" id="6285579">!=</span>&nbsp;<span class="builtintype" id="6285582">nil</span>&nbsp;<span class="op" id="6285586">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6285592">br</span><span class="op" id="6285594">.</span><span class="ident" id="6285595">err</span>&nbsp;<span class="op" id="6285599">=</span>&nbsp;<span class="ident" id="6285601">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6285609">return</span>&nbsp;<span class="num" id="6285616">0</span><span class="op" id="6285617">,</span>&nbsp;<span class="ident" id="6285619">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6285626">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6285631">z</span><span class="op" id="6285632">,</span>&nbsp;<span class="ident" id="6285634">err</span>&nbsp;<span class="op" id="6285638">:=</span>&nbsp;<span class="ident" id="6285641">br</span><span class="op" id="6285643">.</span><span class="ident" id="6285644">r</span><span class="op" id="6285645">.</span><span class="ident" id="6285646">ReadByte</span><span class="op" id="6285654">(</span><span class="op" id="6285655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6285660">if</span>&nbsp;<span class="ident" id="6285663">err</span>&nbsp;<span class="op" id="6285667">!=</span>&nbsp;<span class="builtintype" id="6285670">nil</span>&nbsp;<span class="op" id="6285674">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6285680">if</span>&nbsp;<span class="ident" id="6285683">err</span>&nbsp;<span class="op" id="6285687">==</span>&nbsp;<span class="ident" id="6285690">io</span><span class="op" id="6285692">.</span><span class="ident" id="6285693">EOF</span>&nbsp;<span class="op" id="6285697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6285704">err</span>&nbsp;<span class="op" id="6285708">=</span>&nbsp;<span class="ident" id="6285710">io</span><span class="op" id="6285712">.</span><span class="ident" id="6285713">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6285734">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6285740">br</span><span class="op" id="6285742">.</span><span class="ident" id="6285743">err</span>&nbsp;<span class="op" id="6285747">=</span>&nbsp;<span class="ident" id="6285749">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6285757">return</span>&nbsp;<span class="num" id="6285764">0</span><span class="op" id="6285765">,</span>&nbsp;<span class="ident" id="6285767">err</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6285774">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6285779">if</span>&nbsp;<span class="ident" id="6285782">b</span>&nbsp;<span class="op" id="6285784">!=</span>&nbsp;<span class="string" id="6285787">&#39;B&#39;</span>&nbsp;<span class="op" id="6285791">||</span>&nbsp;<span class="ident" id="6285794">z</span>&nbsp;<span class="op" id="6285796">!=</span>&nbsp;<span class="string" id="6285799">&#39;Z&#39;</span>&nbsp;<span class="op" id="6285803">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6285809">return</span>&nbsp;<span class="num" id="6285816">0</span><span class="op" id="6285817">,</span>&nbsp;<span class="ident" id="6285819">StructuralError</span><span class="op" id="6285834">(</span><span class="string" id="6285835">&#34;bad&nbsp;magic&nbsp;value&nbsp;in&nbsp;continuation&nbsp;file&#34;</span><span class="op" id="6285873">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6285878">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6285883">if</span>&nbsp;<span class="ident" id="6285886">err</span>&nbsp;<span class="op" id="6285890">:=</span>&nbsp;<span class="ident" id="6285893">bz2</span><span class="op" id="6285896">.</span><span class="ident" id="6285897">setup</span><span class="op" id="6285902">(</span><span class="builtintype" id="6285903">false</span><span class="op" id="6285908">)</span><span class="op" id="6285909">;</span>&nbsp;<span class="ident" id="6285911">err</span>&nbsp;<span class="op" id="6285915">!=</span>&nbsp;<span class="builtintype" id="6285918">nil</span>&nbsp;<span class="op" id="6285922">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6285928">return</span>&nbsp;<span class="num" id="6285935">0</span><span class="op" id="6285936">,</span>&nbsp;<span class="ident" id="6285938">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6285945">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6285949">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6285952">}</span><br>
<span class="lineno"></span><span class="op" id="6285954">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span><span class="comment" id="6285957">//&nbsp;readBlock&nbsp;reads&nbsp;a&nbsp;bzip2&nbsp;block.&nbsp;The&nbsp;magic&nbsp;number&nbsp;should&nbsp;already&nbsp;have&nbsp;been&nbsp;consumed.</span><br>
<span class="lineno"></span><span class="keyword" id="6286043">func</span>&nbsp;<span class="op" id="6286048">(</span><span class="ident" id="6286049">bz2</span>&nbsp;<span class="op" id="6286053">*</span><span class="ident" id="6286054">reader</span><span class="op" id="6286060">)</span>&nbsp;<span class="ident" id="6286062">readBlock</span><span class="op" id="6286071">(</span><span class="op" id="6286072">)</span>&nbsp;<span class="op" id="6286074">(</span><span class="ident" id="6286075">err</span>&nbsp;<span class="builtintype" id="6286079">error</span><span class="op" id="6286084">)</span>&nbsp;<span class="op" id="6286086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6286089">br</span>&nbsp;<span class="op" id="6286092">:=</span>&nbsp;<span class="op" id="6286095">&amp;</span><span class="ident" id="6286096">bz2</span><span class="op" id="6286099">.</span><span class="ident" id="6286100">br</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6286104">bz2</span><span class="op" id="6286107">.</span><span class="ident" id="6286108">wantBlockCRC</span>&nbsp;<span class="op" id="6286121">=</span>&nbsp;<span class="builtintype" id="6286123">uint32</span><span class="op" id="6286129">(</span><span class="ident" id="6286130">br</span><span class="op" id="6286132">.</span><span class="ident" id="6286133">ReadBits64</span><span class="op" id="6286143">(</span><span class="num" id="6286144">32</span><span class="op" id="6286146">)</span><span class="op" id="6286147">)</span>&nbsp;<span class="comment" id="6286149">//&nbsp;skip&nbsp;checksum.&nbsp;TODO:&nbsp;check&nbsp;it&nbsp;if&nbsp;we&nbsp;can&nbsp;figure&nbsp;out&nbsp;what&nbsp;it&nbsp;is.</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6286216">bz2</span><span class="op" id="6286219">.</span><span class="ident" id="6286220">blockCRC</span>&nbsp;<span class="op" id="6286229">=</span>&nbsp;<span class="num" id="6286231">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6286234">bz2</span><span class="op" id="6286237">.</span><span class="ident" id="6286238">fileCRC</span>&nbsp;<span class="op" id="6286246">=</span>&nbsp;<span class="op" id="6286248">(</span><span class="ident" id="6286249">bz2</span><span class="op" id="6286252">.</span><span class="ident" id="6286253">fileCRC</span><span class="op" id="6286260">&lt;&lt;</span><span class="num" id="6286262">1</span>&nbsp;<span class="op" id="6286264">|</span>&nbsp;<span class="ident" id="6286266">bz2</span><span class="op" id="6286269">.</span><span class="ident" id="6286270">fileCRC</span><span class="op" id="6286277">&gt;&gt;</span><span class="num" id="6286279">31</span><span class="op" id="6286281">)</span>&nbsp;<span class="op" id="6286283">^</span>&nbsp;<span class="ident" id="6286285">bz2</span><span class="op" id="6286288">.</span><span class="ident" id="6286289">wantBlockCRC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6286303">randomized</span>&nbsp;<span class="op" id="6286314">:=</span>&nbsp;<span class="ident" id="6286317">br</span><span class="op" id="6286319">.</span><span class="ident" id="6286320">ReadBits</span><span class="op" id="6286328">(</span><span class="num" id="6286329">1</span><span class="op" id="6286330">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6286333">if</span>&nbsp;<span class="ident" id="6286336">randomized</span>&nbsp;<span class="op" id="6286347">!=</span>&nbsp;<span class="num" id="6286350">0</span>&nbsp;<span class="op" id="6286352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6286356">return</span>&nbsp;<span class="ident" id="6286363">StructuralError</span><span class="op" id="6286378">(</span><span class="string" id="6286379">&#34;deprecated&nbsp;randomized&nbsp;files&#34;</span><span class="op" id="6286408">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6286411">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6286414">origPtr</span>&nbsp;<span class="op" id="6286422">:=</span>&nbsp;<span class="builtintype" id="6286425">uint</span><span class="op" id="6286429">(</span><span class="ident" id="6286430">br</span><span class="op" id="6286432">.</span><span class="ident" id="6286433">ReadBits</span><span class="op" id="6286441">(</span><span class="num" id="6286442">24</span><span class="op" id="6286444">)</span><span class="op" id="6286445">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6286449">//&nbsp;If&nbsp;not&nbsp;every&nbsp;byte&nbsp;value&nbsp;is&nbsp;used&nbsp;in&nbsp;the&nbsp;block&nbsp;(i.e.,&nbsp;it&#39;s&nbsp;text)&nbsp;then</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6286521">//&nbsp;the&nbsp;symbol&nbsp;set&nbsp;is&nbsp;reduced.&nbsp;The&nbsp;symbols&nbsp;used&nbsp;are&nbsp;stored&nbsp;as&nbsp;a</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6286585">//&nbsp;two-level,&nbsp;16x16&nbsp;bitmap.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6286614">symbolRangeUsedBitmap</span>&nbsp;<span class="op" id="6286636">:=</span>&nbsp;<span class="ident" id="6286639">br</span><span class="op" id="6286641">.</span><span class="ident" id="6286642">ReadBits</span><span class="op" id="6286650">(</span><span class="num" id="6286651">16</span><span class="op" id="6286653">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6286656">symbolPresent</span>&nbsp;<span class="op" id="6286670">:=</span>&nbsp;<span class="builtinfunc" id="6286673">make</span><span class="op" id="6286677">(</span><span class="op" id="6286678">[</span><span class="op" id="6286679">]</span><span class="builtintype" id="6286680">bool</span><span class="op" id="6286684">,</span>&nbsp;<span class="num" id="6286686">256</span><span class="op" id="6286689">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6286692">numSymbols</span>&nbsp;<span class="op" id="6286703">:=</span>&nbsp;<span class="num" id="6286706">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6286709">for</span>&nbsp;<span class="ident" id="6286713">symRange</span>&nbsp;<span class="op" id="6286722">:=</span>&nbsp;<span class="builtintype" id="6286725">uint</span><span class="op" id="6286729">(</span><span class="num" id="6286730">0</span><span class="op" id="6286731">)</span><span class="op" id="6286732">;</span>&nbsp;<span class="ident" id="6286734">symRange</span>&nbsp;<span class="op" id="6286743">&lt;</span>&nbsp;<span class="num" id="6286745">16</span><span class="op" id="6286747">;</span>&nbsp;<span class="ident" id="6286749">symRange</span><span class="op" id="6286757">++</span>&nbsp;<span class="op" id="6286760">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6286764">if</span>&nbsp;<span class="ident" id="6286767">symbolRangeUsedBitmap</span><span class="op" id="6286788">&amp;</span><span class="op" id="6286789">(</span><span class="num" id="6286790">1</span><span class="op" id="6286791">&lt;&lt;</span><span class="op" id="6286793">(</span><span class="num" id="6286794">15</span><span class="op" id="6286796">-</span><span class="ident" id="6286797">symRange</span><span class="op" id="6286805">)</span><span class="op" id="6286806">)</span>&nbsp;<span class="op" id="6286808">!=</span>&nbsp;<span class="num" id="6286811">0</span>&nbsp;<span class="op" id="6286813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6286818">bits</span>&nbsp;<span class="op" id="6286823">:=</span>&nbsp;<span class="ident" id="6286826">br</span><span class="op" id="6286828">.</span><span class="ident" id="6286829">ReadBits</span><span class="op" id="6286837">(</span><span class="num" id="6286838">16</span><span class="op" id="6286840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6286845">for</span>&nbsp;<span class="ident" id="6286849">symbol</span>&nbsp;<span class="op" id="6286856">:=</span>&nbsp;<span class="builtintype" id="6286859">uint</span><span class="op" id="6286863">(</span><span class="num" id="6286864">0</span><span class="op" id="6286865">)</span><span class="op" id="6286866">;</span>&nbsp;<span class="ident" id="6286868">symbol</span>&nbsp;<span class="op" id="6286875">&lt;</span>&nbsp;<span class="num" id="6286877">16</span><span class="op" id="6286879">;</span>&nbsp;<span class="ident" id="6286881">symbol</span><span class="op" id="6286887">++</span>&nbsp;<span class="op" id="6286890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6286896">if</span>&nbsp;<span class="ident" id="6286899">bits</span><span class="op" id="6286903">&amp;</span><span class="op" id="6286904">(</span><span class="num" id="6286905">1</span><span class="op" id="6286906">&lt;&lt;</span><span class="op" id="6286908">(</span><span class="num" id="6286909">15</span><span class="op" id="6286911">-</span><span class="ident" id="6286912">symbol</span><span class="op" id="6286918">)</span><span class="op" id="6286919">)</span>&nbsp;<span class="op" id="6286921">!=</span>&nbsp;<span class="num" id="6286924">0</span>&nbsp;<span class="op" id="6286926">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6286933">symbolPresent</span><span class="op" id="6286946">[</span><span class="num" id="6286947">16</span><span class="op" id="6286949">*</span><span class="ident" id="6286950">symRange</span><span class="op" id="6286958">+</span><span class="ident" id="6286959">symbol</span><span class="op" id="6286965">]</span>&nbsp;<span class="op" id="6286967">=</span>&nbsp;<span class="builtintype" id="6286969">true</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6286979">numSymbols</span><span class="op" id="6286989">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6286996">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6287001">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6287005">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6287008">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6287012">if</span>&nbsp;<span class="ident" id="6287015">numSymbols</span>&nbsp;<span class="op" id="6287026">==</span>&nbsp;<span class="num" id="6287029">0</span>&nbsp;<span class="op" id="6287031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6287035">//&nbsp;There&nbsp;must&nbsp;be&nbsp;an&nbsp;EOF&nbsp;symbol.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6287069">return</span>&nbsp;<span class="ident" id="6287076">StructuralError</span><span class="op" id="6287091">(</span><span class="string" id="6287092">&#34;no&nbsp;symbols&nbsp;in&nbsp;input&#34;</span><span class="op" id="6287113">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6287116">}</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6287120">//&nbsp;A&nbsp;block&nbsp;uses&nbsp;between&nbsp;two&nbsp;and&nbsp;six&nbsp;different&nbsp;Huffman&nbsp;trees.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6287182">numHuffmanTrees</span>&nbsp;<span class="op" id="6287198">:=</span>&nbsp;<span class="ident" id="6287201">br</span><span class="op" id="6287203">.</span><span class="ident" id="6287204">ReadBits</span><span class="op" id="6287212">(</span><span class="num" id="6287213">3</span><span class="op" id="6287214">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6287217">if</span>&nbsp;<span class="ident" id="6287220">numHuffmanTrees</span>&nbsp;<span class="op" id="6287236">&lt;</span>&nbsp;<span class="num" id="6287238">2</span>&nbsp;<span class="op" id="6287240">||</span>&nbsp;<span class="ident" id="6287243">numHuffmanTrees</span>&nbsp;<span class="op" id="6287259">&gt;</span>&nbsp;<span class="num" id="6287261">6</span>&nbsp;<span class="op" id="6287263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6287267">return</span>&nbsp;<span class="ident" id="6287274">StructuralError</span><span class="op" id="6287289">(</span><span class="string" id="6287290">&#34;invalid&nbsp;number&nbsp;of&nbsp;Huffman&nbsp;trees&#34;</span><span class="op" id="6287323">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6287326">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6287330">//&nbsp;The&nbsp;Huffman&nbsp;tree&nbsp;can&nbsp;switch&nbsp;every&nbsp;50&nbsp;symbols&nbsp;so&nbsp;there&#39;s&nbsp;a&nbsp;list&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6287400">//&nbsp;tree&nbsp;indexes&nbsp;telling&nbsp;us&nbsp;which&nbsp;tree&nbsp;to&nbsp;use&nbsp;for&nbsp;each&nbsp;50&nbsp;symbol&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6287472">numSelectors</span>&nbsp;<span class="op" id="6287485">:=</span>&nbsp;<span class="ident" id="6287488">br</span><span class="op" id="6287490">.</span><span class="ident" id="6287491">ReadBits</span><span class="op" id="6287499">(</span><span class="num" id="6287500">15</span><span class="op" id="6287502">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6287505">treeIndexes</span>&nbsp;<span class="op" id="6287517">:=</span>&nbsp;<span class="builtinfunc" id="6287520">make</span><span class="op" id="6287524">(</span><span class="op" id="6287525">[</span><span class="op" id="6287526">]</span><span class="builtintype" id="6287527">uint8</span><span class="op" id="6287532">,</span>&nbsp;<span class="ident" id="6287534">numSelectors</span><span class="op" id="6287546">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6287550">//&nbsp;The&nbsp;tree&nbsp;indexes&nbsp;are&nbsp;move-to-front&nbsp;transformed&nbsp;and&nbsp;stored&nbsp;as&nbsp;unary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6287621">//&nbsp;numbers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6287634">mtfTreeDecoder</span>&nbsp;<span class="op" id="6287649">:=</span>&nbsp;<span class="ident" id="6287652">newMTFDecoderWithRange</span><span class="op" id="6287674">(</span><span class="ident" id="6287675">numHuffmanTrees</span><span class="op" id="6287690">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6287693">for</span>&nbsp;<span class="ident" id="6287697">i</span>&nbsp;<span class="op" id="6287699">:=</span>&nbsp;<span class="keyword" id="6287702">range</span>&nbsp;<span class="ident" id="6287708">treeIndexes</span>&nbsp;<span class="op" id="6287720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6287724">c</span>&nbsp;<span class="op" id="6287726">:=</span>&nbsp;<span class="num" id="6287729">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6287733">for</span>&nbsp;<span class="op" id="6287737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6287742">inc</span>&nbsp;<span class="op" id="6287746">:=</span>&nbsp;<span class="ident" id="6287749">br</span><span class="op" id="6287751">.</span><span class="ident" id="6287752">ReadBits</span><span class="op" id="6287760">(</span><span class="num" id="6287761">1</span><span class="op" id="6287762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6287767">if</span>&nbsp;<span class="ident" id="6287770">inc</span>&nbsp;<span class="op" id="6287774">==</span>&nbsp;<span class="num" id="6287777">0</span>&nbsp;<span class="op" id="6287779">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6287785">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6287794">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6287799">c</span><span class="op" id="6287800">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6287805">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6287809">if</span>&nbsp;<span class="ident" id="6287812">c</span>&nbsp;<span class="op" id="6287814">&gt;=</span>&nbsp;<span class="ident" id="6287817">numHuffmanTrees</span>&nbsp;<span class="op" id="6287833">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6287838">return</span>&nbsp;<span class="ident" id="6287845">StructuralError</span><span class="op" id="6287860">(</span><span class="string" id="6287861">&#34;tree&nbsp;index&nbsp;too&nbsp;large&#34;</span><span class="op" id="6287883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6287887">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6287891">treeIndexes</span><span class="op" id="6287902">[</span><span class="ident" id="6287903">i</span><span class="op" id="6287904">]</span>&nbsp;<span class="op" id="6287906">=</span>&nbsp;<span class="builtintype" id="6287908">uint8</span><span class="op" id="6287913">(</span><span class="ident" id="6287914">mtfTreeDecoder</span><span class="op" id="6287928">.</span><span class="ident" id="6287929">Decode</span><span class="op" id="6287935">(</span><span class="ident" id="6287936">c</span><span class="op" id="6287937">)</span><span class="op" id="6287938">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6287941">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6287945">//&nbsp;The&nbsp;list&nbsp;of&nbsp;symbols&nbsp;for&nbsp;the&nbsp;move-to-front&nbsp;transform&nbsp;is&nbsp;taken&nbsp;from</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6288015">//&nbsp;the&nbsp;previously&nbsp;decoded&nbsp;symbol&nbsp;bitmap.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6288057">symbols</span>&nbsp;<span class="op" id="6288065">:=</span>&nbsp;<span class="builtinfunc" id="6288068">make</span><span class="op" id="6288072">(</span><span class="op" id="6288073">[</span><span class="op" id="6288074">]</span><span class="builtintype" id="6288075">byte</span><span class="op" id="6288079">,</span>&nbsp;<span class="ident" id="6288081">numSymbols</span><span class="op" id="6288091">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6288094">nextSymbol</span>&nbsp;<span class="op" id="6288105">:=</span>&nbsp;<span class="num" id="6288108">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6288111">for</span>&nbsp;<span class="ident" id="6288115">i</span>&nbsp;<span class="op" id="6288117">:=</span>&nbsp;<span class="num" id="6288120">0</span><span class="op" id="6288121">;</span>&nbsp;<span class="ident" id="6288123">i</span>&nbsp;<span class="op" id="6288125">&lt;</span>&nbsp;<span class="num" id="6288127">256</span><span class="op" id="6288130">;</span>&nbsp;<span class="ident" id="6288132">i</span><span class="op" id="6288133">++</span>&nbsp;<span class="op" id="6288136">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6288140">if</span>&nbsp;<span class="ident" id="6288143">symbolPresent</span><span class="op" id="6288156">[</span><span class="ident" id="6288157">i</span><span class="op" id="6288158">]</span>&nbsp;<span class="op" id="6288160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6288165">symbols</span><span class="op" id="6288172">[</span><span class="ident" id="6288173">nextSymbol</span><span class="op" id="6288183">]</span>&nbsp;<span class="op" id="6288185">=</span>&nbsp;<span class="builtintype" id="6288187">byte</span><span class="op" id="6288191">(</span><span class="ident" id="6288192">i</span><span class="op" id="6288193">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6288198">nextSymbol</span><span class="op" id="6288208">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6288213">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6288216">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6288219">mtf</span>&nbsp;<span class="op" id="6288223">:=</span>&nbsp;<span class="ident" id="6288226">newMTFDecoder</span><span class="op" id="6288239">(</span><span class="ident" id="6288240">symbols</span><span class="op" id="6288247">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6288251">numSymbols</span>&nbsp;<span class="op" id="6288262">+=</span>&nbsp;<span class="num" id="6288265">2</span>&nbsp;<span class="comment" id="6288267">//&nbsp;to&nbsp;account&nbsp;for&nbsp;RUNA&nbsp;and&nbsp;RUNB&nbsp;symbols</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6288308">huffmanTrees</span>&nbsp;<span class="op" id="6288321">:=</span>&nbsp;<span class="builtinfunc" id="6288324">make</span><span class="op" id="6288328">(</span><span class="op" id="6288329">[</span><span class="op" id="6288330">]</span><span class="ident" id="6288331">huffmanTree</span><span class="op" id="6288342">,</span>&nbsp;<span class="ident" id="6288344">numHuffmanTrees</span><span class="op" id="6288359">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6288363">//&nbsp;Now&nbsp;we&nbsp;decode&nbsp;the&nbsp;arrays&nbsp;of&nbsp;code-lengths&nbsp;for&nbsp;each&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6288423">lengths</span>&nbsp;<span class="op" id="6288431">:=</span>&nbsp;<span class="builtinfunc" id="6288434">make</span><span class="op" id="6288438">(</span><span class="op" id="6288439">[</span><span class="op" id="6288440">]</span><span class="builtintype" id="6288441">uint8</span><span class="op" id="6288446">,</span>&nbsp;<span class="ident" id="6288448">numSymbols</span><span class="op" id="6288458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6288461">for</span>&nbsp;<span class="ident" id="6288465">i</span>&nbsp;<span class="op" id="6288467">:=</span>&nbsp;<span class="keyword" id="6288470">range</span>&nbsp;<span class="ident" id="6288476">huffmanTrees</span>&nbsp;<span class="op" id="6288489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6288493">//&nbsp;The&nbsp;code&nbsp;lengths&nbsp;are&nbsp;delta&nbsp;encoded&nbsp;from&nbsp;a&nbsp;5-bit&nbsp;base&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6288558">length</span>&nbsp;<span class="op" id="6288565">:=</span>&nbsp;<span class="ident" id="6288568">br</span><span class="op" id="6288570">.</span><span class="ident" id="6288571">ReadBits</span><span class="op" id="6288579">(</span><span class="num" id="6288580">5</span><span class="op" id="6288581">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6288585">for</span>&nbsp;<span class="ident" id="6288589">j</span>&nbsp;<span class="op" id="6288591">:=</span>&nbsp;<span class="keyword" id="6288594">range</span>&nbsp;<span class="ident" id="6288600">lengths</span>&nbsp;<span class="op" id="6288608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6288613">for</span>&nbsp;<span class="op" id="6288617">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6288623">if</span>&nbsp;<span class="op" id="6288626">!</span><span class="ident" id="6288627">br</span><span class="op" id="6288629">.</span><span class="ident" id="6288630">ReadBit</span><span class="op" id="6288637">(</span><span class="op" id="6288638">)</span>&nbsp;<span class="op" id="6288640">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6288647">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6288657">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6288663">if</span>&nbsp;<span class="ident" id="6288666">br</span><span class="op" id="6288668">.</span><span class="ident" id="6288669">ReadBit</span><span class="op" id="6288676">(</span><span class="op" id="6288677">)</span>&nbsp;<span class="op" id="6288679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6288686">length</span><span class="op" id="6288692">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6288699">}</span>&nbsp;<span class="keyword" id="6288701">else</span>&nbsp;<span class="op" id="6288706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6288713">length</span><span class="op" id="6288719">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6288726">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6288731">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6288736">if</span>&nbsp;<span class="ident" id="6288739">length</span>&nbsp;<span class="op" id="6288746">&lt;</span>&nbsp;<span class="num" id="6288748">0</span>&nbsp;<span class="op" id="6288750">||</span>&nbsp;<span class="ident" id="6288753">length</span>&nbsp;<span class="op" id="6288760">&gt;</span>&nbsp;<span class="num" id="6288762">20</span>&nbsp;<span class="op" id="6288765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6288771">return</span>&nbsp;<span class="ident" id="6288778">StructuralError</span><span class="op" id="6288793">(</span><span class="string" id="6288794">&#34;Huffman&nbsp;length&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="6288823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6288828">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6288833">lengths</span><span class="op" id="6288840">[</span><span class="ident" id="6288841">j</span><span class="op" id="6288842">]</span>&nbsp;<span class="op" id="6288844">=</span>&nbsp;<span class="builtintype" id="6288846">uint8</span><span class="op" id="6288851">(</span><span class="ident" id="6288852">length</span><span class="op" id="6288858">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6288862">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6288866">huffmanTrees</span><span class="op" id="6288878">[</span><span class="ident" id="6288879">i</span><span class="op" id="6288880">]</span><span class="op" id="6288881">,</span>&nbsp;<span class="ident" id="6288883">err</span>&nbsp;<span class="op" id="6288887">=</span>&nbsp;<span class="ident" id="6288889">newHuffmanTree</span><span class="op" id="6288903">(</span><span class="ident" id="6288904">lengths</span><span class="op" id="6288911">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6288915">if</span>&nbsp;<span class="ident" id="6288918">err</span>&nbsp;<span class="op" id="6288922">!=</span>&nbsp;<span class="builtintype" id="6288925">nil</span>&nbsp;<span class="op" id="6288929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6288934">return</span>&nbsp;<span class="ident" id="6288941">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6288947">}</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6288950">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6288954">selectorIndex</span>&nbsp;<span class="op" id="6288968">:=</span>&nbsp;<span class="num" id="6288971">1</span>&nbsp;<span class="comment" id="6288973">//&nbsp;the&nbsp;next&nbsp;tree&nbsp;index&nbsp;to&nbsp;use</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6289004">if</span>&nbsp;<span class="builtinfunc" id="6289007">len</span><span class="op" id="6289010">(</span><span class="ident" id="6289011">treeIndexes</span><span class="op" id="6289022">)</span>&nbsp;<span class="op" id="6289024">==</span>&nbsp;<span class="num" id="6289027">0</span>&nbsp;<span class="op" id="6289029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6289033">return</span>&nbsp;<span class="ident" id="6289040">StructuralError</span><span class="op" id="6289055">(</span><span class="string" id="6289056">&#34;no&nbsp;tree&nbsp;selectors&nbsp;given&#34;</span><span class="op" id="6289081">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6289084">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6289087">if</span>&nbsp;<span class="builtintype" id="6289090">int</span><span class="op" id="6289093">(</span><span class="ident" id="6289094">treeIndexes</span><span class="op" id="6289105">[</span><span class="num" id="6289106">0</span><span class="op" id="6289107">]</span><span class="op" id="6289108">)</span>&nbsp;<span class="op" id="6289110">&gt;=</span>&nbsp;<span class="builtinfunc" id="6289113">len</span><span class="op" id="6289116">(</span><span class="ident" id="6289117">huffmanTrees</span><span class="op" id="6289129">)</span>&nbsp;<span class="op" id="6289131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6289135">return</span>&nbsp;<span class="ident" id="6289142">StructuralError</span><span class="op" id="6289157">(</span><span class="string" id="6289158">&#34;tree&nbsp;selector&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="6289186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6289189">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6289192">currentHuffmanTree</span>&nbsp;<span class="op" id="6289211">:=</span>&nbsp;<span class="ident" id="6289214">huffmanTrees</span><span class="op" id="6289226">[</span><span class="ident" id="6289227">treeIndexes</span><span class="op" id="6289238">[</span><span class="num" id="6289239">0</span><span class="op" id="6289240">]</span><span class="op" id="6289241">]</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6289244">bufIndex</span>&nbsp;<span class="op" id="6289253">:=</span>&nbsp;<span class="num" id="6289256">0</span>&nbsp;<span class="comment" id="6289258">//&nbsp;indexes&nbsp;bz2.buf,&nbsp;the&nbsp;output&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6289298">//&nbsp;The&nbsp;output&nbsp;of&nbsp;the&nbsp;move-to-front&nbsp;transform&nbsp;is&nbsp;run-length&nbsp;encoded&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6289370">//&nbsp;we&nbsp;merge&nbsp;the&nbsp;decoding&nbsp;into&nbsp;the&nbsp;Huffman&nbsp;parsing&nbsp;loop.&nbsp;These&nbsp;two</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6289437">//&nbsp;variables&nbsp;accumulate&nbsp;the&nbsp;repeat&nbsp;count.&nbsp;See&nbsp;the&nbsp;Wikipedia&nbsp;page&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6289507">//&nbsp;details.</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6289520">repeat</span>&nbsp;<span class="op" id="6289527">:=</span>&nbsp;<span class="num" id="6289530">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6289533">repeat_power</span>&nbsp;<span class="op" id="6289546">:=</span>&nbsp;<span class="num" id="6289549">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6289553">//&nbsp;The&nbsp;`C&#39;&nbsp;array&nbsp;(used&nbsp;by&nbsp;the&nbsp;inverse&nbsp;BWT)&nbsp;needs&nbsp;to&nbsp;be&nbsp;zero&nbsp;initialized.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6289627">for</span>&nbsp;<span class="ident" id="6289631">i</span>&nbsp;<span class="op" id="6289633">:=</span>&nbsp;<span class="keyword" id="6289636">range</span>&nbsp;<span class="ident" id="6289642">bz2</span><span class="op" id="6289645">.</span><span class="ident" id="6289646">c</span>&nbsp;<span class="op" id="6289648">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6289652">bz2</span><span class="op" id="6289655">.</span><span class="ident" id="6289656">c</span><span class="op" id="6289657">[</span><span class="ident" id="6289658">i</span><span class="op" id="6289659">]</span>&nbsp;<span class="op" id="6289661">=</span>&nbsp;<span class="num" id="6289663">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6289666">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6289670">decoded</span>&nbsp;<span class="op" id="6289678">:=</span>&nbsp;<span class="num" id="6289681">0</span>&nbsp;<span class="comment" id="6289683">//&nbsp;counts&nbsp;the&nbsp;number&nbsp;of&nbsp;symbols&nbsp;decoded&nbsp;by&nbsp;the&nbsp;current&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6289745">for</span>&nbsp;<span class="op" id="6289749">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6289753">if</span>&nbsp;<span class="ident" id="6289756">decoded</span>&nbsp;<span class="op" id="6289764">==</span>&nbsp;<span class="num" id="6289767">50</span>&nbsp;<span class="op" id="6289770">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6289775">if</span>&nbsp;<span class="ident" id="6289778">selectorIndex</span>&nbsp;<span class="op" id="6289792">&gt;=</span>&nbsp;<span class="ident" id="6289795">numSelectors</span>&nbsp;<span class="op" id="6289808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6289814">return</span>&nbsp;<span class="ident" id="6289821">StructuralError</span><span class="op" id="6289836">(</span><span class="string" id="6289837">&#34;insufficient&nbsp;selector&nbsp;indices&nbsp;for&nbsp;number&nbsp;of&nbsp;symbols&#34;</span><span class="op" id="6289890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6289895">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6289900">if</span>&nbsp;<span class="builtintype" id="6289903">int</span><span class="op" id="6289906">(</span><span class="ident" id="6289907">treeIndexes</span><span class="op" id="6289918">[</span><span class="ident" id="6289919">selectorIndex</span><span class="op" id="6289932">]</span><span class="op" id="6289933">)</span>&nbsp;<span class="op" id="6289935">&gt;=</span>&nbsp;<span class="builtinfunc" id="6289938">len</span><span class="op" id="6289941">(</span><span class="ident" id="6289942">huffmanTrees</span><span class="op" id="6289954">)</span>&nbsp;<span class="op" id="6289956">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6289962">return</span>&nbsp;<span class="ident" id="6289969">StructuralError</span><span class="op" id="6289984">(</span><span class="string" id="6289985">&#34;tree&nbsp;selector&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="6290013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6290018">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6290023">currentHuffmanTree</span>&nbsp;<span class="op" id="6290042">=</span>&nbsp;<span class="ident" id="6290044">huffmanTrees</span><span class="op" id="6290056">[</span><span class="ident" id="6290057">treeIndexes</span><span class="op" id="6290068">[</span><span class="ident" id="6290069">selectorIndex</span><span class="op" id="6290082">]</span><span class="op" id="6290083">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6290088">selectorIndex</span><span class="op" id="6290101">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6290107">decoded</span>&nbsp;<span class="op" id="6290115">=</span>&nbsp;<span class="num" id="6290117">0</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6290121">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6290126">v</span>&nbsp;<span class="op" id="6290128">:=</span>&nbsp;<span class="ident" id="6290131">currentHuffmanTree</span><span class="op" id="6290149">.</span><span class="ident" id="6290150">Decode</span><span class="op" id="6290156">(</span><span class="ident" id="6290157">br</span><span class="op" id="6290159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6290163">decoded</span><span class="op" id="6290170">++</span><br>
<span class="lineno"></span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6290176">if</span>&nbsp;<span class="ident" id="6290179">v</span>&nbsp;<span class="op" id="6290181">&lt;</span>&nbsp;<span class="num" id="6290183">2</span>&nbsp;<span class="op" id="6290185">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6290190">//&nbsp;This&nbsp;is&nbsp;either&nbsp;the&nbsp;RUNA&nbsp;or&nbsp;RUNB&nbsp;symbol.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6290236">if</span>&nbsp;<span class="ident" id="6290239">repeat</span>&nbsp;<span class="op" id="6290246">==</span>&nbsp;<span class="num" id="6290249">0</span>&nbsp;<span class="op" id="6290251">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6290257">repeat_power</span>&nbsp;<span class="op" id="6290270">=</span>&nbsp;<span class="num" id="6290272">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6290277">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6290282">repeat</span>&nbsp;<span class="op" id="6290289">+=</span>&nbsp;<span class="ident" id="6290292">repeat_power</span>&nbsp;<span class="op" id="6290305">&lt;&lt;</span>&nbsp;<span class="ident" id="6290308">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6290313">repeat_power</span>&nbsp;<span class="op" id="6290326">&lt;&lt;=</span>&nbsp;<span class="num" id="6290330">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6290336">//&nbsp;This&nbsp;limit&nbsp;of&nbsp;2&nbsp;million&nbsp;comes&nbsp;from&nbsp;the&nbsp;bzip2&nbsp;source</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6290394">//&nbsp;code.&nbsp;It&nbsp;prevents&nbsp;repeat&nbsp;from&nbsp;overflowing.</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6290443">if</span>&nbsp;<span class="ident" id="6290446">repeat</span>&nbsp;<span class="op" id="6290453">&gt;</span>&nbsp;<span class="num" id="6290455">2</span><span class="op" id="6290456">*</span><span class="num" id="6290457">1024</span><span class="op" id="6290461">*</span><span class="num" id="6290462">1024</span>&nbsp;<span class="op" id="6290467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6290473">return</span>&nbsp;<span class="ident" id="6290480">StructuralError</span><span class="op" id="6290495">(</span><span class="string" id="6290496">&#34;repeat&nbsp;count&nbsp;too&nbsp;large&#34;</span><span class="op" id="6290520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6290525">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6290530">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6290541">}</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6290546">if</span>&nbsp;<span class="ident" id="6290549">repeat</span>&nbsp;<span class="op" id="6290556">&gt;</span>&nbsp;<span class="num" id="6290558">0</span>&nbsp;<span class="op" id="6290560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6290565">//&nbsp;We&nbsp;have&nbsp;decoded&nbsp;a&nbsp;complete&nbsp;run-length&nbsp;so&nbsp;we&nbsp;need&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6290623">//&nbsp;replicate&nbsp;the&nbsp;last&nbsp;output&nbsp;symbol.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6290663">if</span>&nbsp;<span class="ident" id="6290666">repeat</span>&nbsp;<span class="op" id="6290673">&gt;</span>&nbsp;<span class="ident" id="6290675">bz2</span><span class="op" id="6290678">.</span><span class="ident" id="6290679">blockSize</span><span class="op" id="6290688">-</span><span class="ident" id="6290689">bufIndex</span>&nbsp;<span class="op" id="6290698">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6290704">return</span>&nbsp;<span class="ident" id="6290711">StructuralError</span><span class="op" id="6290726">(</span><span class="string" id="6290727">&#34;repeats&nbsp;past&nbsp;end&nbsp;of&nbsp;block&#34;</span><span class="op" id="6290754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6290759">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6290764">for</span>&nbsp;<span class="ident" id="6290768">i</span>&nbsp;<span class="op" id="6290770">:=</span>&nbsp;<span class="num" id="6290773">0</span><span class="op" id="6290774">;</span>&nbsp;<span class="ident" id="6290776">i</span>&nbsp;<span class="op" id="6290778">&lt;</span>&nbsp;<span class="ident" id="6290780">repeat</span><span class="op" id="6290786">;</span>&nbsp;<span class="ident" id="6290788">i</span><span class="op" id="6290789">++</span>&nbsp;<span class="op" id="6290792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6290798">b</span>&nbsp;<span class="op" id="6290800">:=</span>&nbsp;<span class="builtintype" id="6290803">byte</span><span class="op" id="6290807">(</span><span class="ident" id="6290808">mtf</span><span class="op" id="6290811">.</span><span class="ident" id="6290812">First</span><span class="op" id="6290817">(</span><span class="op" id="6290818">)</span><span class="op" id="6290819">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6290825">bz2</span><span class="op" id="6290828">.</span><span class="ident" id="6290829">tt</span><span class="op" id="6290831">[</span><span class="ident" id="6290832">bufIndex</span><span class="op" id="6290840">]</span>&nbsp;<span class="op" id="6290842">=</span>&nbsp;<span class="builtintype" id="6290844">uint32</span><span class="op" id="6290850">(</span><span class="ident" id="6290851">b</span><span class="op" id="6290852">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6290858">bz2</span><span class="op" id="6290861">.</span><span class="ident" id="6290862">c</span><span class="op" id="6290863">[</span><span class="ident" id="6290864">b</span><span class="op" id="6290865">]</span><span class="op" id="6290866">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6290873">bufIndex</span><span class="op" id="6290881">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6290887">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6290892">repeat</span>&nbsp;<span class="op" id="6290899">=</span>&nbsp;<span class="num" id="6290901">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6290905">}</span><br>
<span class="lineno">410</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6290910">if</span>&nbsp;<span class="builtintype" id="6290913">int</span><span class="op" id="6290916">(</span><span class="ident" id="6290917">v</span><span class="op" id="6290918">)</span>&nbsp;<span class="op" id="6290920">==</span>&nbsp;<span class="ident" id="6290923">numSymbols</span><span class="op" id="6290933">-</span><span class="num" id="6290934">1</span>&nbsp;<span class="op" id="6290936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6290941">//&nbsp;This&nbsp;is&nbsp;the&nbsp;EOF&nbsp;symbol.&nbsp;Because&nbsp;it&#39;s&nbsp;always&nbsp;at&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6290998">//&nbsp;end&nbsp;of&nbsp;the&nbsp;move-to-front&nbsp;list,&nbsp;and&nbsp;never&nbsp;gets&nbsp;moved</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6291056">//&nbsp;to&nbsp;the&nbsp;front,&nbsp;it&nbsp;has&nbsp;this&nbsp;unique&nbsp;value.</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6291102">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6291110">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6291115">//&nbsp;Since&nbsp;two&nbsp;metasymbols&nbsp;(RUNA&nbsp;and&nbsp;RUNB)&nbsp;have&nbsp;values&nbsp;0&nbsp;and&nbsp;1,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6291179">//&nbsp;one&nbsp;would&nbsp;expect&nbsp;|v-2|&nbsp;to&nbsp;be&nbsp;passed&nbsp;to&nbsp;the&nbsp;MTF&nbsp;decoder.</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6291240">//&nbsp;However,&nbsp;the&nbsp;front&nbsp;of&nbsp;the&nbsp;MTF&nbsp;list&nbsp;is&nbsp;never&nbsp;referenced&nbsp;as&nbsp;0,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6291306">//&nbsp;it&#39;s&nbsp;always&nbsp;referenced&nbsp;with&nbsp;a&nbsp;run-length&nbsp;of&nbsp;1.&nbsp;Thus&nbsp;0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6291365">//&nbsp;doesn&#39;t&nbsp;need&nbsp;to&nbsp;be&nbsp;encoded&nbsp;and&nbsp;we&nbsp;have&nbsp;|v-1|&nbsp;in&nbsp;the&nbsp;next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6291427">//&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6291438">b</span>&nbsp;<span class="op" id="6291440">:=</span>&nbsp;<span class="builtintype" id="6291443">byte</span><span class="op" id="6291447">(</span><span class="ident" id="6291448">mtf</span><span class="op" id="6291451">.</span><span class="ident" id="6291452">Decode</span><span class="op" id="6291458">(</span><span class="builtintype" id="6291459">int</span><span class="op" id="6291462">(</span><span class="ident" id="6291463">v</span>&nbsp;<span class="op" id="6291465">-</span>&nbsp;<span class="num" id="6291467">1</span><span class="op" id="6291468">)</span><span class="op" id="6291469">)</span><span class="op" id="6291470">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6291474">if</span>&nbsp;<span class="ident" id="6291477">bufIndex</span>&nbsp;<span class="op" id="6291486">&gt;=</span>&nbsp;<span class="ident" id="6291489">bz2</span><span class="op" id="6291492">.</span><span class="ident" id="6291493">blockSize</span>&nbsp;<span class="op" id="6291503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6291508">return</span>&nbsp;<span class="ident" id="6291515">StructuralError</span><span class="op" id="6291530">(</span><span class="string" id="6291531">&#34;data&nbsp;exceeds&nbsp;block&nbsp;size&#34;</span><span class="op" id="6291556">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6291560">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6291564">bz2</span><span class="op" id="6291567">.</span><span class="ident" id="6291568">tt</span><span class="op" id="6291570">[</span><span class="ident" id="6291571">bufIndex</span><span class="op" id="6291579">]</span>&nbsp;<span class="op" id="6291581">=</span>&nbsp;<span class="builtintype" id="6291583">uint32</span><span class="op" id="6291589">(</span><span class="ident" id="6291590">b</span><span class="op" id="6291591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6291595">bz2</span><span class="op" id="6291598">.</span><span class="ident" id="6291599">c</span><span class="op" id="6291600">[</span><span class="ident" id="6291601">b</span><span class="op" id="6291602">]</span><span class="op" id="6291603">++</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6291608">bufIndex</span><span class="op" id="6291616">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6291620">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6291624">if</span>&nbsp;<span class="ident" id="6291627">origPtr</span>&nbsp;<span class="op" id="6291635">&gt;=</span>&nbsp;<span class="builtintype" id="6291638">uint</span><span class="op" id="6291642">(</span><span class="ident" id="6291643">bufIndex</span><span class="op" id="6291651">)</span>&nbsp;<span class="op" id="6291653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6291657">return</span>&nbsp;<span class="ident" id="6291664">StructuralError</span><span class="op" id="6291679">(</span><span class="string" id="6291680">&#34;origPtr&nbsp;out&nbsp;of&nbsp;bounds&#34;</span><span class="op" id="6291703">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6291706">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6291710">//&nbsp;We&nbsp;have&nbsp;completed&nbsp;the&nbsp;entropy&nbsp;decoding.&nbsp;Now&nbsp;we&nbsp;can&nbsp;perform&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6291777">//&nbsp;inverse&nbsp;BWT&nbsp;and&nbsp;setup&nbsp;the&nbsp;RLE&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6291819">bz2</span><span class="op" id="6291822">.</span><span class="ident" id="6291823">preRLE</span>&nbsp;<span class="op" id="6291830">=</span>&nbsp;<span class="ident" id="6291832">bz2</span><span class="op" id="6291835">.</span><span class="ident" id="6291836">tt</span><span class="op" id="6291838">[</span><span class="op" id="6291839">:</span><span class="ident" id="6291840">bufIndex</span><span class="op" id="6291848">]</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6291851">bz2</span><span class="op" id="6291854">.</span><span class="ident" id="6291855">preRLEUsed</span>&nbsp;<span class="op" id="6291866">=</span>&nbsp;<span class="num" id="6291868">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6291871">bz2</span><span class="op" id="6291874">.</span><span class="ident" id="6291875">tPos</span>&nbsp;<span class="op" id="6291880">=</span>&nbsp;<span class="ident" id="6291882">inverseBWT</span><span class="op" id="6291892">(</span><span class="ident" id="6291893">bz2</span><span class="op" id="6291896">.</span><span class="ident" id="6291897">preRLE</span><span class="op" id="6291903">,</span>&nbsp;<span class="ident" id="6291905">origPtr</span><span class="op" id="6291912">,</span>&nbsp;<span class="ident" id="6291914">bz2</span><span class="op" id="6291917">.</span><span class="ident" id="6291918">c</span><span class="op" id="6291919">[</span><span class="op" id="6291920">:</span><span class="op" id="6291921">]</span><span class="op" id="6291922">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6291925">bz2</span><span class="op" id="6291928">.</span><span class="ident" id="6291929">lastByte</span>&nbsp;<span class="op" id="6291938">=</span>&nbsp;<span class="op" id="6291940">-</span><span class="num" id="6291941">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6291944">bz2</span><span class="op" id="6291947">.</span><span class="ident" id="6291948">byteRepeats</span>&nbsp;<span class="op" id="6291960">=</span>&nbsp;<span class="num" id="6291962">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6291965">bz2</span><span class="op" id="6291968">.</span><span class="ident" id="6291969">repeats</span>&nbsp;<span class="op" id="6291977">=</span>&nbsp;<span class="num" id="6291979">0</span><br>
<span class="lineno">445</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6291983">return</span>&nbsp;<span class="builtintype" id="6291990">nil</span><br>
<span class="lineno"></span><span class="op" id="6291994">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6291997">//&nbsp;inverseBWT&nbsp;implements&nbsp;the&nbsp;inverse&nbsp;Burrows-Wheeler&nbsp;transform&nbsp;as&nbsp;described&nbsp;in</span><br>
<span class="lineno">450</span><span class="comment" id="6292076">//&nbsp;http://www.hpl.hp.com/techreports/Compaq-DEC/SRC-RR-124.pdf,&nbsp;section&nbsp;4.2.</span><br>
<span class="lineno"></span><span class="comment" id="6292153">//&nbsp;In&nbsp;that&nbsp;document,&nbsp;origPtr&nbsp;is&nbsp;called&nbsp;`I&#39;&nbsp;and&nbsp;c&nbsp;is&nbsp;the&nbsp;`C&#39;&nbsp;array&nbsp;after&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6292229">//&nbsp;first&nbsp;pass&nbsp;over&nbsp;the&nbsp;data.&nbsp;It&#39;s&nbsp;an&nbsp;argument&nbsp;here&nbsp;because&nbsp;we&nbsp;merge&nbsp;the&nbsp;first</span><br>
<span class="lineno"></span><span class="comment" id="6292307">//&nbsp;pass&nbsp;with&nbsp;the&nbsp;Huffman&nbsp;decoding.</span><br>
<span class="lineno"></span><span class="comment" id="6292342">//</span><br>
<span class="lineno">455</span><span class="comment" id="6292345">//&nbsp;This&nbsp;also&nbsp;implements&nbsp;the&nbsp;`single&nbsp;array&#39;&nbsp;method&nbsp;from&nbsp;the&nbsp;bzip2&nbsp;source&nbsp;code</span><br>
<span class="lineno"></span><span class="comment" id="6292422">//&nbsp;which&nbsp;leaves&nbsp;the&nbsp;output,&nbsp;still&nbsp;shuffled,&nbsp;in&nbsp;the&nbsp;bottom&nbsp;8&nbsp;bits&nbsp;of&nbsp;tt&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6292502">//&nbsp;index&nbsp;of&nbsp;the&nbsp;next&nbsp;byte&nbsp;in&nbsp;the&nbsp;top&nbsp;24-bits.&nbsp;The&nbsp;index&nbsp;of&nbsp;the&nbsp;first&nbsp;byte&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="6292579">//&nbsp;returned.</span><br>
<span class="lineno"></span><span class="keyword" id="6292592">func</span>&nbsp;<span class="ident" id="6292597">inverseBWT</span><span class="op" id="6292607">(</span><span class="ident" id="6292608">tt</span>&nbsp;<span class="op" id="6292611">[</span><span class="op" id="6292612">]</span><span class="builtintype" id="6292613">uint32</span><span class="op" id="6292619">,</span>&nbsp;<span class="ident" id="6292621">origPtr</span>&nbsp;<span class="builtintype" id="6292629">uint</span><span class="op" id="6292633">,</span>&nbsp;<span class="ident" id="6292635">c</span>&nbsp;<span class="op" id="6292637">[</span><span class="op" id="6292638">]</span><span class="builtintype" id="6292639">uint</span><span class="op" id="6292643">)</span>&nbsp;<span class="builtintype" id="6292645">uint32</span>&nbsp;<span class="op" id="6292652">{</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6292655">sum</span>&nbsp;<span class="op" id="6292659">:=</span>&nbsp;<span class="builtintype" id="6292662">uint</span><span class="op" id="6292666">(</span><span class="num" id="6292667">0</span><span class="op" id="6292668">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6292671">for</span>&nbsp;<span class="ident" id="6292675">i</span>&nbsp;<span class="op" id="6292677">:=</span>&nbsp;<span class="num" id="6292680">0</span><span class="op" id="6292681">;</span>&nbsp;<span class="ident" id="6292683">i</span>&nbsp;<span class="op" id="6292685">&lt;</span>&nbsp;<span class="num" id="6292687">256</span><span class="op" id="6292690">;</span>&nbsp;<span class="ident" id="6292692">i</span><span class="op" id="6292693">++</span>&nbsp;<span class="op" id="6292696">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6292700">sum</span>&nbsp;<span class="op" id="6292704">+=</span>&nbsp;<span class="ident" id="6292707">c</span><span class="op" id="6292708">[</span><span class="ident" id="6292709">i</span><span class="op" id="6292710">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6292714">c</span><span class="op" id="6292715">[</span><span class="ident" id="6292716">i</span><span class="op" id="6292717">]</span>&nbsp;<span class="op" id="6292719">=</span>&nbsp;<span class="ident" id="6292721">sum</span>&nbsp;<span class="op" id="6292725">-</span>&nbsp;<span class="ident" id="6292727">c</span><span class="op" id="6292728">[</span><span class="ident" id="6292729">i</span><span class="op" id="6292730">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6292733">}</span><br>
<span class="lineno">465</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6292737">for</span>&nbsp;<span class="ident" id="6292741">i</span>&nbsp;<span class="op" id="6292743">:=</span>&nbsp;<span class="keyword" id="6292746">range</span>&nbsp;<span class="ident" id="6292752">tt</span>&nbsp;<span class="op" id="6292755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6292759">b</span>&nbsp;<span class="op" id="6292761">:=</span>&nbsp;<span class="ident" id="6292764">tt</span><span class="op" id="6292766">[</span><span class="ident" id="6292767">i</span><span class="op" id="6292768">]</span>&nbsp;<span class="op" id="6292770">&amp;</span>&nbsp;<span class="num" id="6292772">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6292779">tt</span><span class="op" id="6292781">[</span><span class="ident" id="6292782">c</span><span class="op" id="6292783">[</span><span class="ident" id="6292784">b</span><span class="op" id="6292785">]</span><span class="op" id="6292786">]</span>&nbsp;<span class="op" id="6292788">|=</span>&nbsp;<span class="builtintype" id="6292791">uint32</span><span class="op" id="6292797">(</span><span class="ident" id="6292798">i</span><span class="op" id="6292799">)</span>&nbsp;<span class="op" id="6292801">&lt;&lt;</span>&nbsp;<span class="num" id="6292804">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6292808">c</span><span class="op" id="6292809">[</span><span class="ident" id="6292810">b</span><span class="op" id="6292811">]</span><span class="op" id="6292812">++</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6292816">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6292820">return</span>&nbsp;<span class="ident" id="6292827">tt</span><span class="op" id="6292829">[</span><span class="ident" id="6292830">origPtr</span><span class="op" id="6292837">]</span>&nbsp;<span class="op" id="6292839">&gt;&gt;</span>&nbsp;<span class="num" id="6292842">8</span><br>
<span class="lineno"></span><span class="op" id="6292844">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">475</span><span class="comment" id="6292847">//&nbsp;This&nbsp;is&nbsp;a&nbsp;standard&nbsp;CRC32&nbsp;like&nbsp;in&nbsp;hash/crc32&nbsp;except&nbsp;that&nbsp;all&nbsp;the&nbsp;shifts&nbsp;are&nbsp;reversed,</span><br>
<span class="lineno"></span><span class="comment" id="6292935">//&nbsp;causing&nbsp;the&nbsp;bits&nbsp;in&nbsp;the&nbsp;input&nbsp;to&nbsp;be&nbsp;processed&nbsp;in&nbsp;the&nbsp;reverse&nbsp;of&nbsp;the&nbsp;usual&nbsp;order.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6293020">var</span>&nbsp;<span class="ident" id="6293024">crctab</span>&nbsp;<span class="op" id="6293031">[</span><span class="num" id="6293032">256</span><span class="op" id="6293035">]</span><span class="builtintype" id="6293036">uint32</span><br>
<span class="lineno"></span><br>
<span class="lineno">480</span><span class="keyword" id="6293044">func</span>&nbsp;<span class="ident" id="6293049">init</span><span class="op" id="6293053">(</span><span class="op" id="6293054">)</span>&nbsp;<span class="op" id="6293056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6293059">const</span>&nbsp;<span class="ident" id="6293065">poly</span>&nbsp;<span class="op" id="6293070">=</span>&nbsp;<span class="num" id="6293072">0x04C11DB7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6293084">for</span>&nbsp;<span class="ident" id="6293088">i</span>&nbsp;<span class="op" id="6293090">:=</span>&nbsp;<span class="keyword" id="6293093">range</span>&nbsp;<span class="ident" id="6293099">crctab</span>&nbsp;<span class="op" id="6293106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6293110">crc</span>&nbsp;<span class="op" id="6293114">:=</span>&nbsp;<span class="builtintype" id="6293117">uint32</span><span class="op" id="6293123">(</span><span class="ident" id="6293124">i</span><span class="op" id="6293125">)</span>&nbsp;<span class="op" id="6293127">&lt;&lt;</span>&nbsp;<span class="num" id="6293130">24</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6293135">for</span>&nbsp;<span class="ident" id="6293139">j</span>&nbsp;<span class="op" id="6293141">:=</span>&nbsp;<span class="num" id="6293144">0</span><span class="op" id="6293145">;</span>&nbsp;<span class="ident" id="6293147">j</span>&nbsp;<span class="op" id="6293149">&lt;</span>&nbsp;<span class="num" id="6293151">8</span><span class="op" id="6293152">;</span>&nbsp;<span class="ident" id="6293154">j</span><span class="op" id="6293155">++</span>&nbsp;<span class="op" id="6293158">{</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6293163">if</span>&nbsp;<span class="ident" id="6293166">crc</span><span class="op" id="6293169">&amp;</span><span class="num" id="6293170">0x80000000</span>&nbsp;<span class="op" id="6293181">!=</span>&nbsp;<span class="num" id="6293184">0</span>&nbsp;<span class="op" id="6293186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6293192">crc</span>&nbsp;<span class="op" id="6293196">=</span>&nbsp;<span class="op" id="6293198">(</span><span class="ident" id="6293199">crc</span>&nbsp;<span class="op" id="6293203">&lt;&lt;</span>&nbsp;<span class="num" id="6293206">1</span><span class="op" id="6293207">)</span>&nbsp;<span class="op" id="6293209">^</span>&nbsp;<span class="ident" id="6293211">poly</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6293219">}</span>&nbsp;<span class="keyword" id="6293221">else</span>&nbsp;<span class="op" id="6293226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6293232">crc</span>&nbsp;<span class="op" id="6293236">&lt;&lt;=</span>&nbsp;<span class="num" id="6293240">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6293245">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6293249">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6293253">crctab</span><span class="op" id="6293259">[</span><span class="ident" id="6293260">i</span><span class="op" id="6293261">]</span>&nbsp;<span class="op" id="6293263">=</span>&nbsp;<span class="ident" id="6293265">crc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6293270">}</span><br>
<span class="lineno"></span><span class="op" id="6293272">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">495</span><span class="comment" id="6293275">//&nbsp;updateCRC&nbsp;updates&nbsp;the&nbsp;crc&nbsp;value&nbsp;to&nbsp;incorporate&nbsp;the&nbsp;data&nbsp;in&nbsp;b.</span><br>
<span class="lineno"></span><span class="comment" id="6293340">//&nbsp;The&nbsp;initial&nbsp;value&nbsp;is&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="6293367">func</span>&nbsp;<span class="ident" id="6293372">updateCRC</span><span class="op" id="6293381">(</span><span class="ident" id="6293382">val</span>&nbsp;<span class="builtintype" id="6293386">uint32</span><span class="op" id="6293392">,</span>&nbsp;<span class="ident" id="6293394">b</span>&nbsp;<span class="op" id="6293396">[</span><span class="op" id="6293397">]</span><span class="builtintype" id="6293398">byte</span><span class="op" id="6293402">)</span>&nbsp;<span class="builtintype" id="6293404">uint32</span>&nbsp;<span class="op" id="6293411">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6293414">crc</span>&nbsp;<span class="op" id="6293418">:=</span>&nbsp;<span class="op" id="6293421">^</span><span class="ident" id="6293422">val</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6293427">for</span>&nbsp;<span class="ident" id="6293431">_</span><span class="op" id="6293432">,</span>&nbsp;<span class="ident" id="6293434">v</span>&nbsp;<span class="op" id="6293436">:=</span>&nbsp;<span class="keyword" id="6293439">range</span>&nbsp;<span class="ident" id="6293445">b</span>&nbsp;<span class="op" id="6293447">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6293451">crc</span>&nbsp;<span class="op" id="6293455">=</span>&nbsp;<span class="ident" id="6293457">crctab</span><span class="op" id="6293463">[</span><span class="builtintype" id="6293464">byte</span><span class="op" id="6293468">(</span><span class="ident" id="6293469">crc</span><span class="op" id="6293472">&gt;&gt;</span><span class="num" id="6293474">24</span><span class="op" id="6293476">)</span><span class="op" id="6293477">^</span><span class="ident" id="6293478">v</span><span class="op" id="6293479">]</span>&nbsp;<span class="op" id="6293481">^</span>&nbsp;<span class="op" id="6293483">(</span><span class="ident" id="6293484">crc</span>&nbsp;<span class="op" id="6293488">&lt;&lt;</span>&nbsp;<span class="num" id="6293491">8</span><span class="op" id="6293492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6293495">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6293498">return</span>&nbsp;<span class="op" id="6293505">^</span><span class="ident" id="6293506">crc</span><br>
<span class="lineno"></span><span class="op" id="6293510">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
