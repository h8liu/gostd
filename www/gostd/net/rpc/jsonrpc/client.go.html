<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/rpc/jsonrpc</h2>
<ul>
<li><a href="/gostd/net/rpc/jsonrpc/all_test.go.html">all_test.go</a></li>
<li><a href="/gostd/net/rpc/jsonrpc/client.go.html" class="current">client.go</a></li>
<li><a href="/gostd/net/rpc/jsonrpc/server.go.html">server.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5780539">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5780595">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5780649">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5780700">//&nbsp;Package&nbsp;jsonrpc&nbsp;implements&nbsp;a&nbsp;JSON-RPC&nbsp;ClientCodec&nbsp;and&nbsp;ServerCodec</span><br>
<span class="lineno"></span><span class="comment" id="5780769">//&nbsp;for&nbsp;the&nbsp;rpc&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="5780793">package</span>&nbsp;<span class="ident" id="5780801">jsonrpc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5780810">import</span>&nbsp;<span class="op" id="5780817">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5780820">&#34;encoding/json&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5780837">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5780844">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5780850">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5780857">&#34;net/rpc&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5780868">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="5780875">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5780878">type</span>&nbsp;<span class="ident" id="5780883">clientCodec</span>&nbsp;<span class="keyword" id="5780895">struct</span>&nbsp;<span class="op" id="5780902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5780905">dec</span>&nbsp;<span class="op" id="5780909">*</span><span class="ident" id="5780910">json</span><span class="op" id="5780914">.</span><span class="ident" id="5780915">Decoder</span>&nbsp;<span class="comment" id="5780923">//&nbsp;for&nbsp;reading&nbsp;JSON&nbsp;values</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5780951">enc</span>&nbsp;<span class="op" id="5780955">*</span><span class="ident" id="5780956">json</span><span class="op" id="5780960">.</span><span class="ident" id="5780961">Encoder</span>&nbsp;<span class="comment" id="5780969">//&nbsp;for&nbsp;writing&nbsp;JSON&nbsp;values</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5780997">c</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5781001">io</span><span class="op" id="5781003">.</span><span class="ident" id="5781004">Closer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5781013">//&nbsp;temporary&nbsp;work&nbsp;space</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5781038">req</span>&nbsp;&nbsp;<span class="ident" id="5781043">clientRequest</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5781058">resp</span>&nbsp;<span class="ident" id="5781063">clientResponse</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5781080">//&nbsp;JSON-RPC&nbsp;responses&nbsp;include&nbsp;the&nbsp;request&nbsp;id&nbsp;but&nbsp;not&nbsp;the&nbsp;request&nbsp;method.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5781154">//&nbsp;Package&nbsp;rpc&nbsp;expects&nbsp;both.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5781184">//&nbsp;We&nbsp;save&nbsp;the&nbsp;request&nbsp;method&nbsp;in&nbsp;pending&nbsp;when&nbsp;sending&nbsp;a&nbsp;request</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5781249">//&nbsp;and&nbsp;then&nbsp;look&nbsp;it&nbsp;up&nbsp;by&nbsp;request&nbsp;ID&nbsp;when&nbsp;filling&nbsp;out&nbsp;the&nbsp;rpc&nbsp;Response.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5781322">mutex</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5781330">sync</span><span class="op" id="5781334">.</span><span class="ident" id="5781335">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5781348">//&nbsp;protects&nbsp;pending</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5781369">pending</span>&nbsp;<span class="keyword" id="5781377">map</span><span class="op" id="5781380">[</span><span class="ident" id="5781381">uint64</span><span class="op" id="5781387">]</span><span class="builtintype" id="5781388">string</span>&nbsp;<span class="comment" id="5781395">//&nbsp;map&nbsp;request&nbsp;id&nbsp;to&nbsp;method&nbsp;name</span><br>
<span class="lineno"></span><span class="op" id="5781428">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="comment" id="5781431">//&nbsp;NewClientCodec&nbsp;returns&nbsp;a&nbsp;new&nbsp;rpc.ClientCodec&nbsp;using&nbsp;JSON-RPC&nbsp;on&nbsp;conn.</span><br>
<span class="lineno"></span><span class="keyword" id="5781503">func</span>&nbsp;<span class="ident" id="5781508">NewClientCodec</span><span class="op" id="5781522">(</span><span class="ident" id="5781523">conn</span>&nbsp;<span class="ident" id="5781528">io</span><span class="op" id="5781530">.</span><span class="ident" id="5781531">ReadWriteCloser</span><span class="op" id="5781546">)</span>&nbsp;<span class="ident" id="5781548">rpc</span><span class="op" id="5781551">.</span><span class="ident" id="5781552">ClientCodec</span>&nbsp;<span class="op" id="5781564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5781567">return</span>&nbsp;<span class="op" id="5781574">&amp;</span><span class="ident" id="5781575">clientCodec</span><span class="op" id="5781586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5781590">dec</span><span class="op" id="5781593">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5781599">json</span><span class="op" id="5781603">.</span><span class="ident" id="5781604">NewDecoder</span><span class="op" id="5781614">(</span><span class="ident" id="5781615">conn</span><span class="op" id="5781619">)</span><span class="op" id="5781620">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5781624">enc</span><span class="op" id="5781627">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5781633">json</span><span class="op" id="5781637">.</span><span class="ident" id="5781638">NewEncoder</span><span class="op" id="5781648">(</span><span class="ident" id="5781649">conn</span><span class="op" id="5781653">)</span><span class="op" id="5781654">,</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5781658">c</span><span class="op" id="5781659">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5781667">conn</span><span class="op" id="5781671">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5781675">pending</span><span class="op" id="5781682">:</span>&nbsp;<span class="builtinfunc" id="5781684">make</span><span class="op" id="5781688">(</span><span class="keyword" id="5781689">map</span><span class="op" id="5781692">[</span><span class="ident" id="5781693">uint64</span><span class="op" id="5781699">]</span><span class="builtintype" id="5781700">string</span><span class="op" id="5781706">)</span><span class="op" id="5781707">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5781710">}</span><br>
<span class="lineno"></span><span class="op" id="5781712">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="keyword" id="5781715">type</span>&nbsp;<span class="ident" id="5781720">clientRequest</span>&nbsp;<span class="keyword" id="5781734">struct</span>&nbsp;<span class="op" id="5781741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5781744">Method</span>&nbsp;<span class="builtintype" id="5781751">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5781766">`json:&#34;method&#34;`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5781783">Params</span>&nbsp;<span class="op" id="5781790">[</span><span class="num" id="5781791">1</span><span class="op" id="5781792">]</span><span class="keyword" id="5781793">interface</span><span class="op" id="5781802">{</span><span class="op" id="5781803">}</span>&nbsp;<span class="string" id="5781805">`json:&#34;params&#34;`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5781822">Id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5781829">uint64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5781844">`json:&#34;id&#34;`</span><br>
<span class="lineno"></span><span class="op" id="5781856">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="keyword" id="5781859">func</span>&nbsp;<span class="op" id="5781864">(</span><span class="ident" id="5781865">c</span>&nbsp;<span class="op" id="5781867">*</span><span class="ident" id="5781868">clientCodec</span><span class="op" id="5781879">)</span>&nbsp;<span class="ident" id="5781881">WriteRequest</span><span class="op" id="5781893">(</span><span class="ident" id="5781894">r</span>&nbsp;<span class="op" id="5781896">*</span><span class="ident" id="5781897">rpc</span><span class="op" id="5781900">.</span><span class="ident" id="5781901">Request</span><span class="op" id="5781908">,</span>&nbsp;<span class="ident" id="5781910">param</span>&nbsp;<span class="keyword" id="5781916">interface</span><span class="op" id="5781925">{</span><span class="op" id="5781926">}</span><span class="op" id="5781927">)</span>&nbsp;<span class="builtintype" id="5781929">error</span>&nbsp;<span class="op" id="5781935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5781938">c</span><span class="op" id="5781939">.</span><span class="ident" id="5781940">mutex</span><span class="op" id="5781945">.</span><span class="ident" id="5781946">Lock</span><span class="op" id="5781950">(</span><span class="op" id="5781951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5781954">c</span><span class="op" id="5781955">.</span><span class="ident" id="5781956">pending</span><span class="op" id="5781963">[</span><span class="ident" id="5781964">r</span><span class="op" id="5781965">.</span><span class="ident" id="5781966">Seq</span><span class="op" id="5781969">]</span>&nbsp;<span class="op" id="5781971">=</span>&nbsp;<span class="ident" id="5781973">r</span><span class="op" id="5781974">.</span><span class="ident" id="5781975">ServiceMethod</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5781990">c</span><span class="op" id="5781991">.</span><span class="ident" id="5781992">mutex</span><span class="op" id="5781997">.</span><span class="ident" id="5781998">Unlock</span><span class="op" id="5782004">(</span><span class="op" id="5782005">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5782008">c</span><span class="op" id="5782009">.</span><span class="ident" id="5782010">req</span><span class="op" id="5782013">.</span><span class="ident" id="5782014">Method</span>&nbsp;<span class="op" id="5782021">=</span>&nbsp;<span class="ident" id="5782023">r</span><span class="op" id="5782024">.</span><span class="ident" id="5782025">ServiceMethod</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5782040">c</span><span class="op" id="5782041">.</span><span class="ident" id="5782042">req</span><span class="op" id="5782045">.</span><span class="ident" id="5782046">Params</span><span class="op" id="5782052">[</span><span class="num" id="5782053">0</span><span class="op" id="5782054">]</span>&nbsp;<span class="op" id="5782056">=</span>&nbsp;<span class="ident" id="5782058">param</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5782065">c</span><span class="op" id="5782066">.</span><span class="ident" id="5782067">req</span><span class="op" id="5782070">.</span><span class="ident" id="5782071">Id</span>&nbsp;<span class="op" id="5782074">=</span>&nbsp;<span class="ident" id="5782076">r</span><span class="op" id="5782077">.</span><span class="ident" id="5782078">Seq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5782083">return</span>&nbsp;<span class="ident" id="5782090">c</span><span class="op" id="5782091">.</span><span class="ident" id="5782092">enc</span><span class="op" id="5782095">.</span><span class="ident" id="5782096">Encode</span><span class="op" id="5782102">(</span><span class="op" id="5782103">&amp;</span><span class="ident" id="5782104">c</span><span class="op" id="5782105">.</span><span class="ident" id="5782106">req</span><span class="op" id="5782109">)</span><br>
<span class="lineno"></span><span class="op" id="5782111">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="keyword" id="5782114">type</span>&nbsp;<span class="ident" id="5782119">clientResponse</span>&nbsp;<span class="keyword" id="5782134">struct</span>&nbsp;<span class="op" id="5782141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5782144">Id</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5782151">uint64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5782168">`json:&#34;id&#34;`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5782181">Result</span>&nbsp;<span class="op" id="5782188">*</span><span class="ident" id="5782189">json</span><span class="op" id="5782193">.</span><span class="ident" id="5782194">RawMessage</span>&nbsp;<span class="string" id="5782205">`json:&#34;result&#34;`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5782222">Error</span>&nbsp;&nbsp;<span class="keyword" id="5782229">interface</span><span class="op" id="5782238">{</span><span class="op" id="5782239">}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5782246">`json:&#34;error&#34;`</span><br>
<span class="lineno">65</span><span class="op" id="5782261">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5782264">func</span>&nbsp;<span class="op" id="5782269">(</span><span class="ident" id="5782270">r</span>&nbsp;<span class="op" id="5782272">*</span><span class="ident" id="5782273">clientResponse</span><span class="op" id="5782287">)</span>&nbsp;<span class="ident" id="5782289">reset</span><span class="op" id="5782294">(</span><span class="op" id="5782295">)</span>&nbsp;<span class="op" id="5782297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5782300">r</span><span class="op" id="5782301">.</span><span class="ident" id="5782302">Id</span>&nbsp;<span class="op" id="5782305">=</span>&nbsp;<span class="num" id="5782307">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5782310">r</span><span class="op" id="5782311">.</span><span class="ident" id="5782312">Result</span>&nbsp;<span class="op" id="5782319">=</span>&nbsp;<span class="builtintype" id="5782321">nil</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5782326">r</span><span class="op" id="5782327">.</span><span class="ident" id="5782328">Error</span>&nbsp;<span class="op" id="5782334">=</span>&nbsp;<span class="builtintype" id="5782336">nil</span><br>
<span class="lineno"></span><span class="op" id="5782340">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5782343">func</span>&nbsp;<span class="op" id="5782348">(</span><span class="ident" id="5782349">c</span>&nbsp;<span class="op" id="5782351">*</span><span class="ident" id="5782352">clientCodec</span><span class="op" id="5782363">)</span>&nbsp;<span class="ident" id="5782365">ReadResponseHeader</span><span class="op" id="5782383">(</span><span class="ident" id="5782384">r</span>&nbsp;<span class="op" id="5782386">*</span><span class="ident" id="5782387">rpc</span><span class="op" id="5782390">.</span><span class="ident" id="5782391">Response</span><span class="op" id="5782399">)</span>&nbsp;<span class="builtintype" id="5782401">error</span>&nbsp;<span class="op" id="5782407">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5782410">c</span><span class="op" id="5782411">.</span><span class="ident" id="5782412">resp</span><span class="op" id="5782416">.</span><span class="ident" id="5782417">reset</span><span class="op" id="5782422">(</span><span class="op" id="5782423">)</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5782426">if</span>&nbsp;<span class="ident" id="5782429">err</span>&nbsp;<span class="op" id="5782433">:=</span>&nbsp;<span class="ident" id="5782436">c</span><span class="op" id="5782437">.</span><span class="ident" id="5782438">dec</span><span class="op" id="5782441">.</span><span class="ident" id="5782442">Decode</span><span class="op" id="5782448">(</span><span class="op" id="5782449">&amp;</span><span class="ident" id="5782450">c</span><span class="op" id="5782451">.</span><span class="ident" id="5782452">resp</span><span class="op" id="5782456">)</span><span class="op" id="5782457">;</span>&nbsp;<span class="ident" id="5782459">err</span>&nbsp;<span class="op" id="5782463">!=</span>&nbsp;<span class="builtintype" id="5782466">nil</span>&nbsp;<span class="op" id="5782470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5782474">return</span>&nbsp;<span class="ident" id="5782481">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5782486">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5782490">c</span><span class="op" id="5782491">.</span><span class="ident" id="5782492">mutex</span><span class="op" id="5782497">.</span><span class="ident" id="5782498">Lock</span><span class="op" id="5782502">(</span><span class="op" id="5782503">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5782506">r</span><span class="op" id="5782507">.</span><span class="ident" id="5782508">ServiceMethod</span>&nbsp;<span class="op" id="5782522">=</span>&nbsp;<span class="ident" id="5782524">c</span><span class="op" id="5782525">.</span><span class="ident" id="5782526">pending</span><span class="op" id="5782533">[</span><span class="ident" id="5782534">c</span><span class="op" id="5782535">.</span><span class="ident" id="5782536">resp</span><span class="op" id="5782540">.</span><span class="ident" id="5782541">Id</span><span class="op" id="5782543">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5782546">delete</span><span class="op" id="5782552">(</span><span class="ident" id="5782553">c</span><span class="op" id="5782554">.</span><span class="ident" id="5782555">pending</span><span class="op" id="5782562">,</span>&nbsp;<span class="ident" id="5782564">c</span><span class="op" id="5782565">.</span><span class="ident" id="5782566">resp</span><span class="op" id="5782570">.</span><span class="ident" id="5782571">Id</span><span class="op" id="5782573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5782576">c</span><span class="op" id="5782577">.</span><span class="ident" id="5782578">mutex</span><span class="op" id="5782583">.</span><span class="ident" id="5782584">Unlock</span><span class="op" id="5782590">(</span><span class="op" id="5782591">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5782595">r</span><span class="op" id="5782596">.</span><span class="ident" id="5782597">Error</span>&nbsp;<span class="op" id="5782603">=</span>&nbsp;<span class="string" id="5782605">&#34;&#34;</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5782609">r</span><span class="op" id="5782610">.</span><span class="ident" id="5782611">Seq</span>&nbsp;<span class="op" id="5782615">=</span>&nbsp;<span class="ident" id="5782617">c</span><span class="op" id="5782618">.</span><span class="ident" id="5782619">resp</span><span class="op" id="5782623">.</span><span class="ident" id="5782624">Id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5782628">if</span>&nbsp;<span class="ident" id="5782631">c</span><span class="op" id="5782632">.</span><span class="ident" id="5782633">resp</span><span class="op" id="5782637">.</span><span class="ident" id="5782638">Error</span>&nbsp;<span class="op" id="5782644">!=</span>&nbsp;<span class="builtintype" id="5782647">nil</span>&nbsp;<span class="op" id="5782651">||</span>&nbsp;<span class="ident" id="5782654">c</span><span class="op" id="5782655">.</span><span class="ident" id="5782656">resp</span><span class="op" id="5782660">.</span><span class="ident" id="5782661">Result</span>&nbsp;<span class="op" id="5782668">==</span>&nbsp;<span class="builtintype" id="5782671">nil</span>&nbsp;<span class="op" id="5782675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5782679">x</span><span class="op" id="5782680">,</span>&nbsp;<span class="ident" id="5782682">ok</span>&nbsp;<span class="op" id="5782685">:=</span>&nbsp;<span class="ident" id="5782688">c</span><span class="op" id="5782689">.</span><span class="ident" id="5782690">resp</span><span class="op" id="5782694">.</span><span class="ident" id="5782695">Error</span><span class="op" id="5782700">.</span><span class="op" id="5782701">(</span><span class="builtintype" id="5782702">string</span><span class="op" id="5782708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5782712">if</span>&nbsp;<span class="op" id="5782715">!</span><span class="ident" id="5782716">ok</span>&nbsp;<span class="op" id="5782719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5782724">return</span>&nbsp;<span class="ident" id="5782731">fmt</span><span class="op" id="5782734">.</span><span class="ident" id="5782735">Errorf</span><span class="op" id="5782741">(</span><span class="string" id="5782742">&#34;invalid&nbsp;error&nbsp;%v&#34;</span><span class="op" id="5782760">,</span>&nbsp;<span class="ident" id="5782762">c</span><span class="op" id="5782763">.</span><span class="ident" id="5782764">resp</span><span class="op" id="5782768">.</span><span class="ident" id="5782769">Error</span><span class="op" id="5782774">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5782778">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5782782">if</span>&nbsp;<span class="ident" id="5782785">x</span>&nbsp;<span class="op" id="5782787">==</span>&nbsp;<span class="string" id="5782790">&#34;&#34;</span>&nbsp;<span class="op" id="5782793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5782798">x</span>&nbsp;<span class="op" id="5782800">=</span>&nbsp;<span class="string" id="5782802">&#34;unspecified&nbsp;error&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5782824">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5782828">r</span><span class="op" id="5782829">.</span><span class="ident" id="5782830">Error</span>&nbsp;<span class="op" id="5782836">=</span>&nbsp;<span class="ident" id="5782838">x</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5782841">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5782844">return</span>&nbsp;<span class="builtintype" id="5782851">nil</span><br>
<span class="lineno"></span><span class="op" id="5782855">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5782858">func</span>&nbsp;<span class="op" id="5782863">(</span><span class="ident" id="5782864">c</span>&nbsp;<span class="op" id="5782866">*</span><span class="ident" id="5782867">clientCodec</span><span class="op" id="5782878">)</span>&nbsp;<span class="ident" id="5782880">ReadResponseBody</span><span class="op" id="5782896">(</span><span class="ident" id="5782897">x</span>&nbsp;<span class="keyword" id="5782899">interface</span><span class="op" id="5782908">{</span><span class="op" id="5782909">}</span><span class="op" id="5782910">)</span>&nbsp;<span class="builtintype" id="5782912">error</span>&nbsp;<span class="op" id="5782918">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5782921">if</span>&nbsp;<span class="ident" id="5782924">x</span>&nbsp;<span class="op" id="5782926">==</span>&nbsp;<span class="builtintype" id="5782929">nil</span>&nbsp;<span class="op" id="5782933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5782937">return</span>&nbsp;<span class="builtintype" id="5782944">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5782949">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5782952">return</span>&nbsp;<span class="ident" id="5782959">json</span><span class="op" id="5782963">.</span><span class="ident" id="5782964">Unmarshal</span><span class="op" id="5782973">(</span><span class="op" id="5782974">*</span><span class="ident" id="5782975">c</span><span class="op" id="5782976">.</span><span class="ident" id="5782977">resp</span><span class="op" id="5782981">.</span><span class="ident" id="5782982">Result</span><span class="op" id="5782988">,</span>&nbsp;<span class="ident" id="5782990">x</span><span class="op" id="5782991">)</span><br>
<span class="lineno"></span><span class="op" id="5782993">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="keyword" id="5782996">func</span>&nbsp;<span class="op" id="5783001">(</span><span class="ident" id="5783002">c</span>&nbsp;<span class="op" id="5783004">*</span><span class="ident" id="5783005">clientCodec</span><span class="op" id="5783016">)</span>&nbsp;<span class="ident" id="5783018">Close</span><span class="op" id="5783023">(</span><span class="op" id="5783024">)</span>&nbsp;<span class="builtintype" id="5783026">error</span>&nbsp;<span class="op" id="5783032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5783035">return</span>&nbsp;<span class="ident" id="5783042">c</span><span class="op" id="5783043">.</span><span class="ident" id="5783044">c</span><span class="op" id="5783045">.</span><span class="ident" id="5783046">Close</span><span class="op" id="5783051">(</span><span class="op" id="5783052">)</span><br>
<span class="lineno"></span><span class="op" id="5783054">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span><span class="comment" id="5783057">//&nbsp;NewClient&nbsp;returns&nbsp;a&nbsp;new&nbsp;rpc.Client&nbsp;to&nbsp;handle&nbsp;requests&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5783121">//&nbsp;set&nbsp;of&nbsp;services&nbsp;at&nbsp;the&nbsp;other&nbsp;end&nbsp;of&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="5783176">func</span>&nbsp;<span class="ident" id="5783181">NewClient</span><span class="op" id="5783190">(</span><span class="ident" id="5783191">conn</span>&nbsp;<span class="ident" id="5783196">io</span><span class="op" id="5783198">.</span><span class="ident" id="5783199">ReadWriteCloser</span><span class="op" id="5783214">)</span>&nbsp;<span class="op" id="5783216">*</span><span class="ident" id="5783217">rpc</span><span class="op" id="5783220">.</span><span class="ident" id="5783221">Client</span>&nbsp;<span class="op" id="5783228">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5783231">return</span>&nbsp;<span class="ident" id="5783238">rpc</span><span class="op" id="5783241">.</span><span class="ident" id="5783242">NewClientWithCodec</span><span class="op" id="5783260">(</span><span class="ident" id="5783261">NewClientCodec</span><span class="op" id="5783275">(</span><span class="ident" id="5783276">conn</span><span class="op" id="5783280">)</span><span class="op" id="5783281">)</span><br>
<span class="lineno"></span><span class="op" id="5783283">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span><span class="comment" id="5783286">//&nbsp;Dial&nbsp;connects&nbsp;to&nbsp;a&nbsp;JSON-RPC&nbsp;server&nbsp;at&nbsp;the&nbsp;specified&nbsp;network&nbsp;address.</span><br>
<span class="lineno"></span><span class="keyword" id="5783358">func</span>&nbsp;<span class="ident" id="5783363">Dial</span><span class="op" id="5783367">(</span><span class="ident" id="5783368">network</span><span class="op" id="5783375">,</span>&nbsp;<span class="ident" id="5783377">address</span>&nbsp;<span class="builtintype" id="5783385">string</span><span class="op" id="5783391">)</span>&nbsp;<span class="op" id="5783393">(</span><span class="op" id="5783394">*</span><span class="ident" id="5783395">rpc</span><span class="op" id="5783398">.</span><span class="ident" id="5783399">Client</span><span class="op" id="5783405">,</span>&nbsp;<span class="builtintype" id="5783407">error</span><span class="op" id="5783412">)</span>&nbsp;<span class="op" id="5783414">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5783417">conn</span><span class="op" id="5783421">,</span>&nbsp;<span class="ident" id="5783423">err</span>&nbsp;<span class="op" id="5783427">:=</span>&nbsp;<span class="ident" id="5783430">net</span><span class="op" id="5783433">.</span><span class="ident" id="5783434">Dial</span><span class="op" id="5783438">(</span><span class="ident" id="5783439">network</span><span class="op" id="5783446">,</span>&nbsp;<span class="ident" id="5783448">address</span><span class="op" id="5783455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5783458">if</span>&nbsp;<span class="ident" id="5783461">err</span>&nbsp;<span class="op" id="5783465">!=</span>&nbsp;<span class="builtintype" id="5783468">nil</span>&nbsp;<span class="op" id="5783472">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5783476">return</span>&nbsp;<span class="builtintype" id="5783483">nil</span><span class="op" id="5783486">,</span>&nbsp;<span class="ident" id="5783488">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5783493">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5783496">return</span>&nbsp;<span class="ident" id="5783503">NewClient</span><span class="op" id="5783512">(</span><span class="ident" id="5783513">conn</span><span class="op" id="5783517">)</span><span class="op" id="5783518">,</span>&nbsp;<span class="ident" id="5783520">err</span><br>
<span class="lineno"></span><span class="op" id="5783524">}</span>
</div>
</body>
</html>
