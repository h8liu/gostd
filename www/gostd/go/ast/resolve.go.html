<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="1395301">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1395356">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1395410">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1395461">//&nbsp;This&nbsp;file&nbsp;implements&nbsp;NewPackage.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1395498">package</span>&nbsp;<span class="ident" id="1395506">ast</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1395511">import</span>&nbsp;<span class="op" id="1395518">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1395521">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1395528">&#34;go/scanner&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1395542">&#34;go/token&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1395554">&#34;strconv&#34;</span><br>
<span class="lineno"></span><span class="op" id="1395564">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword" id="1395567">type</span>&nbsp;<span class="ident" id="1395572">pkgBuilder</span>&nbsp;<span class="keyword" id="1395583">struct</span>&nbsp;<span class="op" id="1395590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1395593">fset</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1395600">*</span><span class="ident" id="1395601">token</span><span class="op" id="1395606">.</span><span class="ident" id="1395607">FileSet</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1395616">errors</span>&nbsp;<span class="ident" id="1395623">scanner</span><span class="op" id="1395630">.</span><span class="ident" id="1395631">ErrorList</span><br>
<span class="lineno"></span><span class="op" id="1395641">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="1395644">func</span>&nbsp;<span class="op" id="1395649">(</span><span class="ident" id="1395650">p</span>&nbsp;<span class="op" id="1395652">*</span><span class="ident" id="1395653">pkgBuilder</span><span class="op" id="1395663">)</span>&nbsp;<span class="builtintype" id="1395665">error</span><span class="op" id="1395670">(</span><span class="ident" id="1395671">pos</span>&nbsp;<span class="ident" id="1395675">token</span><span class="op" id="1395680">.</span><span class="ident" id="1395681">Pos</span><span class="op" id="1395684">,</span>&nbsp;<span class="ident" id="1395686">msg</span>&nbsp;<span class="builtintype" id="1395690">string</span><span class="op" id="1395696">)</span>&nbsp;<span class="op" id="1395698">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1395701">p</span><span class="op" id="1395702">.</span><span class="ident" id="1395703">errors</span><span class="op" id="1395709">.</span><span class="ident" id="1395710">Add</span><span class="op" id="1395713">(</span><span class="ident" id="1395714">p</span><span class="op" id="1395715">.</span><span class="ident" id="1395716">fset</span><span class="op" id="1395720">.</span><span class="ident" id="1395721">Position</span><span class="op" id="1395729">(</span><span class="ident" id="1395730">pos</span><span class="op" id="1395733">)</span><span class="op" id="1395734">,</span>&nbsp;<span class="ident" id="1395736">msg</span><span class="op" id="1395739">)</span><br>
<span class="lineno"></span><span class="op" id="1395741">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="1395744">func</span>&nbsp;<span class="op" id="1395749">(</span><span class="ident" id="1395750">p</span>&nbsp;<span class="op" id="1395752">*</span><span class="ident" id="1395753">pkgBuilder</span><span class="op" id="1395763">)</span>&nbsp;<span class="ident" id="1395765">errorf</span><span class="op" id="1395771">(</span><span class="ident" id="1395772">pos</span>&nbsp;<span class="ident" id="1395776">token</span><span class="op" id="1395781">.</span><span class="ident" id="1395782">Pos</span><span class="op" id="1395785">,</span>&nbsp;<span class="ident" id="1395787">format</span>&nbsp;<span class="builtintype" id="1395794">string</span><span class="op" id="1395800">,</span>&nbsp;<span class="ident" id="1395802">args</span>&nbsp;<span class="op" id="1395807">...</span><span class="keyword" id="1395810">interface</span><span class="op" id="1395819">{</span><span class="op" id="1395820">}</span><span class="op" id="1395821">)</span>&nbsp;<span class="op" id="1395823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1395826">p</span><span class="op" id="1395827">.</span><span class="builtintype" id="1395828">error</span><span class="op" id="1395833">(</span><span class="ident" id="1395834">pos</span><span class="op" id="1395837">,</span>&nbsp;<span class="ident" id="1395839">fmt</span><span class="op" id="1395842">.</span><span class="ident" id="1395843">Sprintf</span><span class="op" id="1395850">(</span><span class="ident" id="1395851">format</span><span class="op" id="1395857">,</span>&nbsp;<span class="ident" id="1395859">args</span><span class="op" id="1395863">...</span><span class="op" id="1395866">)</span><span class="op" id="1395867">)</span><br>
<span class="lineno"></span><span class="op" id="1395869">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1395872">func</span>&nbsp;<span class="op" id="1395877">(</span><span class="ident" id="1395878">p</span>&nbsp;<span class="op" id="1395880">*</span><span class="ident" id="1395881">pkgBuilder</span><span class="op" id="1395891">)</span>&nbsp;<span class="ident" id="1395893">declare</span><span class="op" id="1395900">(</span><span class="ident" id="1395901">scope</span><span class="op" id="1395906">,</span>&nbsp;<span class="ident" id="1395908">altScope</span>&nbsp;<span class="op" id="1395917">*</span><span class="ident" id="1395918">Scope</span><span class="op" id="1395923">,</span>&nbsp;<span class="ident" id="1395925">obj</span>&nbsp;<span class="op" id="1395929">*</span><span class="ident" id="1395930">Object</span><span class="op" id="1395936">)</span>&nbsp;<span class="op" id="1395938">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1395941">alt</span>&nbsp;<span class="op" id="1395945">:=</span>&nbsp;<span class="ident" id="1395948">scope</span><span class="op" id="1395953">.</span><span class="ident" id="1395954">Insert</span><span class="op" id="1395960">(</span><span class="ident" id="1395961">obj</span><span class="op" id="1395964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1395967">if</span>&nbsp;<span class="ident" id="1395970">alt</span>&nbsp;<span class="op" id="1395974">==</span>&nbsp;<span class="ident" id="1395977">nil</span>&nbsp;<span class="op" id="1395981">&amp;&amp;</span>&nbsp;<span class="ident" id="1395984">altScope</span>&nbsp;<span class="op" id="1395993">!=</span>&nbsp;<span class="ident" id="1395996">nil</span>&nbsp;<span class="op" id="1396000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1396004">//&nbsp;see&nbsp;if&nbsp;there&nbsp;is&nbsp;a&nbsp;conflicting&nbsp;declaration&nbsp;in&nbsp;altScope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1396063">alt</span>&nbsp;<span class="op" id="1396067">=</span>&nbsp;<span class="ident" id="1396069">altScope</span><span class="op" id="1396077">.</span><span class="ident" id="1396078">Lookup</span><span class="op" id="1396084">(</span><span class="ident" id="1396085">obj</span><span class="op" id="1396088">.</span><span class="ident" id="1396089">Name</span><span class="op" id="1396093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1396096">}</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1396099">if</span>&nbsp;<span class="ident" id="1396102">alt</span>&nbsp;<span class="op" id="1396106">!=</span>&nbsp;<span class="ident" id="1396109">nil</span>&nbsp;<span class="op" id="1396113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1396117">prevDecl</span>&nbsp;<span class="op" id="1396126">:=</span>&nbsp;<span class="string" id="1396129">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1396134">if</span>&nbsp;<span class="ident" id="1396137">pos</span>&nbsp;<span class="op" id="1396141">:=</span>&nbsp;<span class="ident" id="1396144">alt</span><span class="op" id="1396147">.</span><span class="ident" id="1396148">Pos</span><span class="op" id="1396151">(</span><span class="op" id="1396152">)</span><span class="op" id="1396153">;</span>&nbsp;<span class="ident" id="1396155">pos</span><span class="op" id="1396158">.</span><span class="ident" id="1396159">IsValid</span><span class="op" id="1396166">(</span><span class="op" id="1396167">)</span>&nbsp;<span class="op" id="1396169">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1396174">prevDecl</span>&nbsp;<span class="op" id="1396183">=</span>&nbsp;<span class="ident" id="1396185">fmt</span><span class="op" id="1396188">.</span><span class="ident" id="1396189">Sprintf</span><span class="op" id="1396196">(</span><span class="string" id="1396197">&#34;\n\tprevious&nbsp;declaration&nbsp;at&nbsp;%s&#34;</span><span class="op" id="1396229">,</span>&nbsp;<span class="ident" id="1396231">p</span><span class="op" id="1396232">.</span><span class="ident" id="1396233">fset</span><span class="op" id="1396237">.</span><span class="ident" id="1396238">Position</span><span class="op" id="1396246">(</span><span class="ident" id="1396247">pos</span><span class="op" id="1396250">)</span><span class="op" id="1396251">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1396255">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1396259">p</span><span class="op" id="1396260">.</span><span class="builtintype" id="1396261">error</span><span class="op" id="1396266">(</span><span class="ident" id="1396267">obj</span><span class="op" id="1396270">.</span><span class="ident" id="1396271">Pos</span><span class="op" id="1396274">(</span><span class="op" id="1396275">)</span><span class="op" id="1396276">,</span>&nbsp;<span class="ident" id="1396278">fmt</span><span class="op" id="1396281">.</span><span class="ident" id="1396282">Sprintf</span><span class="op" id="1396289">(</span><span class="string" id="1396290">&#34;%s&nbsp;redeclared&nbsp;in&nbsp;this&nbsp;block%s&#34;</span><span class="op" id="1396321">,</span>&nbsp;<span class="ident" id="1396323">obj</span><span class="op" id="1396326">.</span><span class="ident" id="1396327">Name</span><span class="op" id="1396331">,</span>&nbsp;<span class="ident" id="1396333">prevDecl</span><span class="op" id="1396341">)</span><span class="op" id="1396342">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1396345">}</span><br>
<span class="lineno"></span><span class="op" id="1396347">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1396350">func</span>&nbsp;<span class="ident" id="1396355">resolve</span><span class="op" id="1396362">(</span><span class="ident" id="1396363">scope</span>&nbsp;<span class="op" id="1396369">*</span><span class="ident" id="1396370">Scope</span><span class="op" id="1396375">,</span>&nbsp;<span class="ident" id="1396377">ident</span>&nbsp;<span class="op" id="1396383">*</span><span class="ident" id="1396384">Ident</span><span class="op" id="1396389">)</span>&nbsp;<span class="builtintype" id="1396391">bool</span>&nbsp;<span class="op" id="1396396">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1396399">for</span>&nbsp;<span class="op" id="1396403">;</span>&nbsp;<span class="ident" id="1396405">scope</span>&nbsp;<span class="op" id="1396411">!=</span>&nbsp;<span class="ident" id="1396414">nil</span><span class="op" id="1396417">;</span>&nbsp;<span class="ident" id="1396419">scope</span>&nbsp;<span class="op" id="1396425">=</span>&nbsp;<span class="ident" id="1396427">scope</span><span class="op" id="1396432">.</span><span class="ident" id="1396433">Outer</span>&nbsp;<span class="op" id="1396439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1396443">if</span>&nbsp;<span class="ident" id="1396446">obj</span>&nbsp;<span class="op" id="1396450">:=</span>&nbsp;<span class="ident" id="1396453">scope</span><span class="op" id="1396458">.</span><span class="ident" id="1396459">Lookup</span><span class="op" id="1396465">(</span><span class="ident" id="1396466">ident</span><span class="op" id="1396471">.</span><span class="ident" id="1396472">Name</span><span class="op" id="1396476">)</span><span class="op" id="1396477">;</span>&nbsp;<span class="ident" id="1396479">obj</span>&nbsp;<span class="op" id="1396483">!=</span>&nbsp;<span class="ident" id="1396486">nil</span>&nbsp;<span class="op" id="1396490">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1396495">ident</span><span class="op" id="1396500">.</span><span class="ident" id="1396501">Obj</span>&nbsp;<span class="op" id="1396505">=</span>&nbsp;<span class="ident" id="1396507">obj</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1396514">return</span>&nbsp;<span class="builtintype" id="1396521">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1396528">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1396531">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1396534">return</span>&nbsp;<span class="builtintype" id="1396541">false</span><br>
<span class="lineno"></span><span class="op" id="1396547">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1396550">//&nbsp;An&nbsp;Importer&nbsp;resolves&nbsp;import&nbsp;paths&nbsp;to&nbsp;package&nbsp;Objects.</span><br>
<span class="lineno">55</span><span class="comment" id="1396607">//&nbsp;The&nbsp;imports&nbsp;map&nbsp;records&nbsp;the&nbsp;packages&nbsp;already&nbsp;imported,</span><br>
<span class="lineno"></span><span class="comment" id="1396665">//&nbsp;indexed&nbsp;by&nbsp;package&nbsp;id&nbsp;(canonical&nbsp;import&nbsp;path).</span><br>
<span class="lineno"></span><span class="comment" id="1396715">//&nbsp;An&nbsp;Importer&nbsp;must&nbsp;determine&nbsp;the&nbsp;canonical&nbsp;import&nbsp;path&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="1396775">//&nbsp;check&nbsp;the&nbsp;map&nbsp;to&nbsp;see&nbsp;if&nbsp;it&nbsp;is&nbsp;already&nbsp;present&nbsp;in&nbsp;the&nbsp;imports&nbsp;map.</span><br>
<span class="lineno"></span><span class="comment" id="1396844">//&nbsp;If&nbsp;so,&nbsp;the&nbsp;Importer&nbsp;can&nbsp;return&nbsp;the&nbsp;map&nbsp;entry.&nbsp;&nbsp;Otherwise,&nbsp;the</span><br>
<span class="lineno">60</span><span class="comment" id="1396909">//&nbsp;Importer&nbsp;should&nbsp;load&nbsp;the&nbsp;package&nbsp;data&nbsp;for&nbsp;the&nbsp;given&nbsp;path&nbsp;into</span><br>
<span class="lineno"></span><span class="comment" id="1396974">//&nbsp;a&nbsp;new&nbsp;*Object&nbsp;(pkg),&nbsp;record&nbsp;pkg&nbsp;in&nbsp;the&nbsp;imports&nbsp;map,&nbsp;and&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="1397038">//&nbsp;return&nbsp;pkg.</span><br>
<span class="lineno"></span><span class="keyword" id="1397053">type</span>&nbsp;<span class="ident" id="1397058">Importer</span>&nbsp;<span class="keyword" id="1397067">func</span><span class="op" id="1397071">(</span><span class="ident" id="1397072">imports</span>&nbsp;<span class="keyword" id="1397080">map</span><span class="op" id="1397083">[</span><span class="builtintype" id="1397084">string</span><span class="op" id="1397090">]</span><span class="op" id="1397091">*</span><span class="ident" id="1397092">Object</span><span class="op" id="1397098">,</span>&nbsp;<span class="ident" id="1397100">path</span>&nbsp;<span class="builtintype" id="1397105">string</span><span class="op" id="1397111">)</span>&nbsp;<span class="op" id="1397113">(</span><span class="ident" id="1397114">pkg</span>&nbsp;<span class="op" id="1397118">*</span><span class="ident" id="1397119">Object</span><span class="op" id="1397125">,</span>&nbsp;<span class="ident" id="1397127">err</span>&nbsp;<span class="builtintype" id="1397131">error</span><span class="op" id="1397136">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="1397139">//&nbsp;NewPackage&nbsp;creates&nbsp;a&nbsp;new&nbsp;Package&nbsp;node&nbsp;from&nbsp;a&nbsp;set&nbsp;of&nbsp;File&nbsp;nodes.&nbsp;It&nbsp;resolves</span><br>
<span class="lineno"></span><span class="comment" id="1397218">//&nbsp;unresolved&nbsp;identifiers&nbsp;across&nbsp;files&nbsp;and&nbsp;updates&nbsp;each&nbsp;file&#39;s&nbsp;Unresolved&nbsp;list</span><br>
<span class="lineno"></span><span class="comment" id="1397297">//&nbsp;accordingly.&nbsp;If&nbsp;a&nbsp;non-nil&nbsp;importer&nbsp;and&nbsp;universe&nbsp;scope&nbsp;are&nbsp;provided,&nbsp;they&nbsp;are</span><br>
<span class="lineno"></span><span class="comment" id="1397377">//&nbsp;used&nbsp;to&nbsp;resolve&nbsp;identifiers&nbsp;not&nbsp;declared&nbsp;in&nbsp;any&nbsp;of&nbsp;the&nbsp;package&nbsp;files.&nbsp;Any</span><br>
<span class="lineno"></span><span class="comment" id="1397454">//&nbsp;remaining&nbsp;unresolved&nbsp;identifiers&nbsp;are&nbsp;reported&nbsp;as&nbsp;undeclared.&nbsp;If&nbsp;the&nbsp;files</span><br>
<span class="lineno">70</span><span class="comment" id="1397531">//&nbsp;belong&nbsp;to&nbsp;different&nbsp;packages,&nbsp;one&nbsp;package&nbsp;name&nbsp;is&nbsp;selected&nbsp;and&nbsp;files&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="1397608">//&nbsp;different&nbsp;package&nbsp;names&nbsp;are&nbsp;reported&nbsp;and&nbsp;then&nbsp;ignored.</span><br>
<span class="lineno"></span><span class="comment" id="1397666">//&nbsp;The&nbsp;result&nbsp;is&nbsp;a&nbsp;package&nbsp;node&nbsp;and&nbsp;a&nbsp;scanner.ErrorList&nbsp;if&nbsp;there&nbsp;were&nbsp;errors.</span><br>
<span class="lineno"></span><span class="comment" id="1397744">//</span><br>
<span class="lineno"></span><span class="keyword" id="1397747">func</span>&nbsp;<span class="ident" id="1397752">NewPackage</span><span class="op" id="1397762">(</span><span class="ident" id="1397763">fset</span>&nbsp;<span class="op" id="1397768">*</span><span class="ident" id="1397769">token</span><span class="op" id="1397774">.</span><span class="ident" id="1397775">FileSet</span><span class="op" id="1397782">,</span>&nbsp;<span class="ident" id="1397784">files</span>&nbsp;<span class="keyword" id="1397790">map</span><span class="op" id="1397793">[</span><span class="builtintype" id="1397794">string</span><span class="op" id="1397800">]</span><span class="op" id="1397801">*</span><span class="ident" id="1397802">File</span><span class="op" id="1397806">,</span>&nbsp;<span class="ident" id="1397808">importer</span>&nbsp;<span class="ident" id="1397817">Importer</span><span class="op" id="1397825">,</span>&nbsp;<span class="ident" id="1397827">universe</span>&nbsp;<span class="op" id="1397836">*</span><span class="ident" id="1397837">Scope</span><span class="op" id="1397842">)</span>&nbsp;<span class="op" id="1397844">(</span><span class="op" id="1397845">*</span><span class="ident" id="1397846">Package</span><span class="op" id="1397853">,</span>&nbsp;<span class="builtintype" id="1397855">error</span><span class="op" id="1397860">)</span>&nbsp;<span class="op" id="1397862">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1397865">var</span>&nbsp;<span class="ident" id="1397869">p</span>&nbsp;<span class="ident" id="1397871">pkgBuilder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1397883">p</span><span class="op" id="1397884">.</span><span class="ident" id="1397885">fset</span>&nbsp;<span class="op" id="1397890">=</span>&nbsp;<span class="ident" id="1397892">fset</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1397899">//&nbsp;complete&nbsp;package&nbsp;scope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1397926">pkgName</span>&nbsp;<span class="op" id="1397934">:=</span>&nbsp;<span class="string" id="1397937">&#34;&#34;</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1397941">pkgScope</span>&nbsp;<span class="op" id="1397950">:=</span>&nbsp;<span class="ident" id="1397953">NewScope</span><span class="op" id="1397961">(</span><span class="ident" id="1397962">universe</span><span class="op" id="1397970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1397973">for</span>&nbsp;<span class="ident" id="1397977">_</span><span class="op" id="1397978">,</span>&nbsp;<span class="ident" id="1397980">file</span>&nbsp;<span class="op" id="1397985">:=</span>&nbsp;<span class="keyword" id="1397988">range</span>&nbsp;<span class="ident" id="1397994">files</span>&nbsp;<span class="op" id="1398000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1398004">//&nbsp;package&nbsp;names&nbsp;must&nbsp;match</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1398034">switch</span>&nbsp;<span class="ident" id="1398041">name</span>&nbsp;<span class="op" id="1398046">:=</span>&nbsp;<span class="ident" id="1398049">file</span><span class="op" id="1398053">.</span><span class="ident" id="1398054">Name</span><span class="op" id="1398058">.</span><span class="ident" id="1398059">Name</span><span class="op" id="1398063">;</span>&nbsp;<span class="op" id="1398065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1398069">case</span>&nbsp;<span class="ident" id="1398074">pkgName</span>&nbsp;<span class="op" id="1398082">==</span>&nbsp;<span class="string" id="1398085">&#34;&#34;</span><span class="op" id="1398087">:</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1398092">pkgName</span>&nbsp;<span class="op" id="1398100">=</span>&nbsp;<span class="ident" id="1398102">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1398109">case</span>&nbsp;<span class="ident" id="1398114">name</span>&nbsp;<span class="op" id="1398119">!=</span>&nbsp;<span class="ident" id="1398122">pkgName</span><span class="op" id="1398129">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1398134">p</span><span class="op" id="1398135">.</span><span class="ident" id="1398136">errorf</span><span class="op" id="1398142">(</span><span class="ident" id="1398143">file</span><span class="op" id="1398147">.</span><span class="ident" id="1398148">Package</span><span class="op" id="1398155">,</span>&nbsp;<span class="string" id="1398157">&#34;package&nbsp;%s;&nbsp;expected&nbsp;%s&#34;</span><span class="op" id="1398182">,</span>&nbsp;<span class="ident" id="1398184">name</span><span class="op" id="1398188">,</span>&nbsp;<span class="ident" id="1398190">pkgName</span><span class="op" id="1398197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1398202">continue</span>&nbsp;<span class="comment" id="1398211">//&nbsp;ignore&nbsp;this&nbsp;file</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1398233">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1398238">//&nbsp;collect&nbsp;top-level&nbsp;file&nbsp;objects&nbsp;in&nbsp;package&nbsp;scope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1398291">for</span>&nbsp;<span class="ident" id="1398295">_</span><span class="op" id="1398296">,</span>&nbsp;<span class="ident" id="1398298">obj</span>&nbsp;<span class="op" id="1398302">:=</span>&nbsp;<span class="keyword" id="1398305">range</span>&nbsp;<span class="ident" id="1398311">file</span><span class="op" id="1398315">.</span><span class="ident" id="1398316">Scope</span><span class="op" id="1398321">.</span><span class="ident" id="1398322">Objects</span>&nbsp;<span class="op" id="1398330">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1398335">p</span><span class="op" id="1398336">.</span><span class="ident" id="1398337">declare</span><span class="op" id="1398344">(</span><span class="ident" id="1398345">pkgScope</span><span class="op" id="1398353">,</span>&nbsp;<span class="ident" id="1398355">nil</span><span class="op" id="1398358">,</span>&nbsp;<span class="ident" id="1398360">obj</span><span class="op" id="1398363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1398367">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1398370">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1398374">//&nbsp;package&nbsp;global&nbsp;mapping&nbsp;of&nbsp;imported&nbsp;package&nbsp;ids&nbsp;to&nbsp;package&nbsp;objects</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1398444">imports</span>&nbsp;<span class="op" id="1398452">:=</span>&nbsp;<span class="builtinfunc" id="1398455">make</span><span class="op" id="1398459">(</span><span class="keyword" id="1398460">map</span><span class="op" id="1398463">[</span><span class="builtintype" id="1398464">string</span><span class="op" id="1398470">]</span><span class="op" id="1398471">*</span><span class="ident" id="1398472">Object</span><span class="op" id="1398478">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1398482">//&nbsp;complete&nbsp;file&nbsp;scopes&nbsp;with&nbsp;imports&nbsp;and&nbsp;resolve&nbsp;identifiers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1398544">for</span>&nbsp;<span class="ident" id="1398548">_</span><span class="op" id="1398549">,</span>&nbsp;<span class="ident" id="1398551">file</span>&nbsp;<span class="op" id="1398556">:=</span>&nbsp;<span class="keyword" id="1398559">range</span>&nbsp;<span class="ident" id="1398565">files</span>&nbsp;<span class="op" id="1398571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1398575">//&nbsp;ignore&nbsp;file&nbsp;if&nbsp;it&nbsp;belongs&nbsp;to&nbsp;a&nbsp;different&nbsp;package</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1398629">//&nbsp;(error&nbsp;has&nbsp;already&nbsp;been&nbsp;reported)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1398668">if</span>&nbsp;<span class="ident" id="1398671">file</span><span class="op" id="1398675">.</span><span class="ident" id="1398676">Name</span><span class="op" id="1398680">.</span><span class="ident" id="1398681">Name</span>&nbsp;<span class="op" id="1398686">!=</span>&nbsp;<span class="ident" id="1398689">pkgName</span>&nbsp;<span class="op" id="1398697">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1398702">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1398713">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1398718">//&nbsp;build&nbsp;file&nbsp;scope&nbsp;by&nbsp;processing&nbsp;all&nbsp;imports</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1398766">importErrors</span>&nbsp;<span class="op" id="1398779">:=</span>&nbsp;<span class="builtintype" id="1398782">false</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1398790">fileScope</span>&nbsp;<span class="op" id="1398800">:=</span>&nbsp;<span class="ident" id="1398803">NewScope</span><span class="op" id="1398811">(</span><span class="ident" id="1398812">pkgScope</span><span class="op" id="1398820">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1398824">for</span>&nbsp;<span class="ident" id="1398828">_</span><span class="op" id="1398829">,</span>&nbsp;<span class="ident" id="1398831">spec</span>&nbsp;<span class="op" id="1398836">:=</span>&nbsp;<span class="keyword" id="1398839">range</span>&nbsp;<span class="ident" id="1398845">file</span><span class="op" id="1398849">.</span><span class="ident" id="1398850">Imports</span>&nbsp;<span class="op" id="1398858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1398863">if</span>&nbsp;<span class="ident" id="1398866">importer</span>&nbsp;<span class="op" id="1398875">==</span>&nbsp;<span class="ident" id="1398878">nil</span>&nbsp;<span class="op" id="1398882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1398888">importErrors</span>&nbsp;<span class="op" id="1398901">=</span>&nbsp;<span class="builtintype" id="1398903">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1398912">continue</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1398924">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1398929">path</span><span class="op" id="1398933">,</span>&nbsp;<span class="ident" id="1398935">_</span>&nbsp;<span class="op" id="1398937">:=</span>&nbsp;<span class="ident" id="1398940">strconv</span><span class="op" id="1398947">.</span><span class="ident" id="1398948">Unquote</span><span class="op" id="1398955">(</span><span class="ident" id="1398956">spec</span><span class="op" id="1398960">.</span><span class="ident" id="1398961">Path</span><span class="op" id="1398965">.</span><span class="ident" id="1398966">Value</span><span class="op" id="1398971">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1398976">pkg</span><span class="op" id="1398979">,</span>&nbsp;<span class="ident" id="1398981">err</span>&nbsp;<span class="op" id="1398985">:=</span>&nbsp;<span class="ident" id="1398988">importer</span><span class="op" id="1398996">(</span><span class="ident" id="1398997">imports</span><span class="op" id="1399004">,</span>&nbsp;<span class="ident" id="1399006">path</span><span class="op" id="1399010">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1399015">if</span>&nbsp;<span class="ident" id="1399018">err</span>&nbsp;<span class="op" id="1399022">!=</span>&nbsp;<span class="ident" id="1399025">nil</span>&nbsp;<span class="op" id="1399029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1399035">p</span><span class="op" id="1399036">.</span><span class="ident" id="1399037">errorf</span><span class="op" id="1399043">(</span><span class="ident" id="1399044">spec</span><span class="op" id="1399048">.</span><span class="ident" id="1399049">Path</span><span class="op" id="1399053">.</span><span class="ident" id="1399054">Pos</span><span class="op" id="1399057">(</span><span class="op" id="1399058">)</span><span class="op" id="1399059">,</span>&nbsp;<span class="string" id="1399061">&#34;could&nbsp;not&nbsp;import&nbsp;%s&nbsp;(%s)&#34;</span><span class="op" id="1399087">,</span>&nbsp;<span class="ident" id="1399089">path</span><span class="op" id="1399093">,</span>&nbsp;<span class="ident" id="1399095">err</span><span class="op" id="1399098">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1399104">importErrors</span>&nbsp;<span class="op" id="1399117">=</span>&nbsp;<span class="builtintype" id="1399119">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1399128">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1399140">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1399145">//&nbsp;TODO(gri)&nbsp;If&nbsp;a&nbsp;local&nbsp;package&nbsp;name&nbsp;!=&nbsp;&#34;.&#34;&nbsp;is&nbsp;provided,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1399205">//&nbsp;global&nbsp;identifier&nbsp;resolution&nbsp;could&nbsp;proceed&nbsp;even&nbsp;if&nbsp;the</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1399266">//&nbsp;import&nbsp;failed.&nbsp;Consider&nbsp;adjusting&nbsp;the&nbsp;logic&nbsp;here&nbsp;a&nbsp;bit.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1399329">//&nbsp;local&nbsp;name&nbsp;overrides&nbsp;imported&nbsp;package&nbsp;name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1399378">name</span>&nbsp;<span class="op" id="1399383">:=</span>&nbsp;<span class="ident" id="1399386">pkg</span><span class="op" id="1399389">.</span><span class="ident" id="1399390">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1399398">if</span>&nbsp;<span class="ident" id="1399401">spec</span><span class="op" id="1399405">.</span><span class="ident" id="1399406">Name</span>&nbsp;<span class="op" id="1399411">!=</span>&nbsp;<span class="ident" id="1399414">nil</span>&nbsp;<span class="op" id="1399418">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1399424">name</span>&nbsp;<span class="op" id="1399429">=</span>&nbsp;<span class="ident" id="1399431">spec</span><span class="op" id="1399435">.</span><span class="ident" id="1399436">Name</span><span class="op" id="1399440">.</span><span class="ident" id="1399441">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1399449">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1399455">//&nbsp;add&nbsp;import&nbsp;to&nbsp;file&nbsp;scope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1399486">if</span>&nbsp;<span class="ident" id="1399489">name</span>&nbsp;<span class="op" id="1399494">==</span>&nbsp;<span class="string" id="1399497">&#34;.&#34;</span>&nbsp;<span class="op" id="1399501">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1399507">//&nbsp;merge&nbsp;imported&nbsp;scope&nbsp;with&nbsp;file&nbsp;scope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1399551">for</span>&nbsp;<span class="ident" id="1399555">_</span><span class="op" id="1399556">,</span>&nbsp;<span class="ident" id="1399558">obj</span>&nbsp;<span class="op" id="1399562">:=</span>&nbsp;<span class="keyword" id="1399565">range</span>&nbsp;<span class="ident" id="1399571">pkg</span><span class="op" id="1399574">.</span><span class="ident" id="1399575">Data</span><span class="op" id="1399579">.</span><span class="op" id="1399580">(</span><span class="op" id="1399581">*</span><span class="ident" id="1399582">Scope</span><span class="op" id="1399587">)</span><span class="op" id="1399588">.</span><span class="ident" id="1399589">Objects</span>&nbsp;<span class="op" id="1399597">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1399604">p</span><span class="op" id="1399605">.</span><span class="ident" id="1399606">declare</span><span class="op" id="1399613">(</span><span class="ident" id="1399614">fileScope</span><span class="op" id="1399623">,</span>&nbsp;<span class="ident" id="1399625">pkgScope</span><span class="op" id="1399633">,</span>&nbsp;<span class="ident" id="1399635">obj</span><span class="op" id="1399638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1399644">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1399649">}</span>&nbsp;<span class="keyword" id="1399651">else</span>&nbsp;<span class="keyword" id="1399656">if</span>&nbsp;<span class="ident" id="1399659">name</span>&nbsp;<span class="op" id="1399664">!=</span>&nbsp;<span class="string" id="1399667">&#34;_&#34;</span>&nbsp;<span class="op" id="1399671">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1399677">//&nbsp;declare&nbsp;imported&nbsp;package&nbsp;object&nbsp;in&nbsp;file&nbsp;scope</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1399730">//&nbsp;(do&nbsp;not&nbsp;re-use&nbsp;pkg&nbsp;in&nbsp;the&nbsp;file&nbsp;scope&nbsp;but&nbsp;create</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1399785">//&nbsp;a&nbsp;new&nbsp;object&nbsp;instead;&nbsp;the&nbsp;Decl&nbsp;field&nbsp;is&nbsp;different</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1399842">//&nbsp;for&nbsp;different&nbsp;files)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1399870">obj</span>&nbsp;<span class="op" id="1399874">:=</span>&nbsp;<span class="ident" id="1399877">NewObj</span><span class="op" id="1399883">(</span><span class="ident" id="1399884">Pkg</span><span class="op" id="1399887">,</span>&nbsp;<span class="ident" id="1399889">name</span><span class="op" id="1399893">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1399899">obj</span><span class="op" id="1399902">.</span><span class="ident" id="1399903">Decl</span>&nbsp;<span class="op" id="1399908">=</span>&nbsp;<span class="ident" id="1399910">spec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1399919">obj</span><span class="op" id="1399922">.</span><span class="ident" id="1399923">Data</span>&nbsp;<span class="op" id="1399928">=</span>&nbsp;<span class="ident" id="1399930">pkg</span><span class="op" id="1399933">.</span><span class="ident" id="1399934">Data</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1399943">p</span><span class="op" id="1399944">.</span><span class="ident" id="1399945">declare</span><span class="op" id="1399952">(</span><span class="ident" id="1399953">fileScope</span><span class="op" id="1399962">,</span>&nbsp;<span class="ident" id="1399964">pkgScope</span><span class="op" id="1399972">,</span>&nbsp;<span class="ident" id="1399974">obj</span><span class="op" id="1399977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1399982">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1399986">}</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1399991">//&nbsp;resolve&nbsp;identifiers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1400016">if</span>&nbsp;<span class="ident" id="1400019">importErrors</span>&nbsp;<span class="op" id="1400032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1400037">//&nbsp;don&#39;t&nbsp;use&nbsp;the&nbsp;universe&nbsp;scope&nbsp;without&nbsp;correct&nbsp;imports</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1400096">//&nbsp;(objects&nbsp;in&nbsp;the&nbsp;universe&nbsp;may&nbsp;be&nbsp;shadowed&nbsp;by&nbsp;imports;</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1400155">//&nbsp;with&nbsp;missing&nbsp;imports,&nbsp;identifiers&nbsp;might&nbsp;get&nbsp;resolved</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1400214">//&nbsp;incorrectly&nbsp;to&nbsp;universe&nbsp;objects)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1400253">pkgScope</span><span class="op" id="1400261">.</span><span class="ident" id="1400262">Outer</span>&nbsp;<span class="op" id="1400268">=</span>&nbsp;<span class="ident" id="1400270">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1400276">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1400280">i</span>&nbsp;<span class="op" id="1400282">:=</span>&nbsp;<span class="num" id="1400285">0</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1400289">for</span>&nbsp;<span class="ident" id="1400293">_</span><span class="op" id="1400294">,</span>&nbsp;<span class="ident" id="1400296">ident</span>&nbsp;<span class="op" id="1400302">:=</span>&nbsp;<span class="keyword" id="1400305">range</span>&nbsp;<span class="ident" id="1400311">file</span><span class="op" id="1400315">.</span><span class="ident" id="1400316">Unresolved</span>&nbsp;<span class="op" id="1400327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1400332">if</span>&nbsp;<span class="op" id="1400335">!</span><span class="ident" id="1400336">resolve</span><span class="op" id="1400343">(</span><span class="ident" id="1400344">fileScope</span><span class="op" id="1400353">,</span>&nbsp;<span class="ident" id="1400355">ident</span><span class="op" id="1400360">)</span>&nbsp;<span class="op" id="1400362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1400368">p</span><span class="op" id="1400369">.</span><span class="ident" id="1400370">errorf</span><span class="op" id="1400376">(</span><span class="ident" id="1400377">ident</span><span class="op" id="1400382">.</span><span class="ident" id="1400383">Pos</span><span class="op" id="1400386">(</span><span class="op" id="1400387">)</span><span class="op" id="1400388">,</span>&nbsp;<span class="string" id="1400390">&#34;undeclared&nbsp;name:&nbsp;%s&#34;</span><span class="op" id="1400411">,</span>&nbsp;<span class="ident" id="1400413">ident</span><span class="op" id="1400418">.</span><span class="ident" id="1400419">Name</span><span class="op" id="1400423">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1400429">file</span><span class="op" id="1400433">.</span><span class="ident" id="1400434">Unresolved</span><span class="op" id="1400444">[</span><span class="ident" id="1400445">i</span><span class="op" id="1400446">]</span>&nbsp;<span class="op" id="1400448">=</span>&nbsp;<span class="ident" id="1400450">ident</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1400460">i</span><span class="op" id="1400461">++</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1400467">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1400472">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1400476">file</span><span class="op" id="1400480">.</span><span class="ident" id="1400481">Unresolved</span>&nbsp;<span class="op" id="1400492">=</span>&nbsp;<span class="ident" id="1400494">file</span><span class="op" id="1400498">.</span><span class="ident" id="1400499">Unresolved</span><span class="op" id="1400509">[</span><span class="num" id="1400510">0</span><span class="op" id="1400511">:</span><span class="ident" id="1400512">i</span><span class="op" id="1400513">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1400517">pkgScope</span><span class="op" id="1400525">.</span><span class="ident" id="1400526">Outer</span>&nbsp;<span class="op" id="1400532">=</span>&nbsp;<span class="ident" id="1400534">universe</span>&nbsp;<span class="comment" id="1400543">//&nbsp;reset&nbsp;universe&nbsp;scope</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1400568">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1400572">p</span><span class="op" id="1400573">.</span><span class="ident" id="1400574">errors</span><span class="op" id="1400580">.</span><span class="ident" id="1400581">Sort</span><span class="op" id="1400585">(</span><span class="op" id="1400586">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1400589">return</span>&nbsp;<span class="op" id="1400596">&amp;</span><span class="ident" id="1400597">Package</span><span class="op" id="1400604">{</span><span class="ident" id="1400605">pkgName</span><span class="op" id="1400612">,</span>&nbsp;<span class="ident" id="1400614">pkgScope</span><span class="op" id="1400622">,</span>&nbsp;<span class="ident" id="1400624">imports</span><span class="op" id="1400631">,</span>&nbsp;<span class="ident" id="1400633">files</span><span class="op" id="1400638">}</span><span class="op" id="1400639">,</span>&nbsp;<span class="ident" id="1400641">p</span><span class="op" id="1400642">.</span><span class="ident" id="1400643">errors</span><span class="op" id="1400649">.</span><span class="ident" id="1400650">Err</span><span class="op" id="1400653">(</span><span class="op" id="1400654">)</span><br>
<span class="lineno"></span><span class="op" id="1400656">}</span>
</div>
</body>
</html>
