<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword">package</span>&nbsp;<span class="ident">template</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">import</span>&nbsp;<span class="op">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;fmt&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;unicode/utf8&#34;</span><br>
<span class="lineno"></span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;htmlNospaceEscaper&nbsp;escapes&nbsp;for&nbsp;inclusion&nbsp;in&nbsp;unquoted&nbsp;attribute&nbsp;values.</span><br>
<span class="lineno">15</span><span class="keyword">func</span>&nbsp;<span class="ident">htmlNospaceEscaper</span><span class="op">(</span><span class="ident">args</span>&nbsp;<span class="op">...</span><span class="keyword">interface</span><span class="op">{</span><span class="op">}</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span><span class="op">,</span>&nbsp;<span class="ident">t</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">stringify</span><span class="op">(</span><span class="ident">args</span><span class="op">...</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">t</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">contentTypeHTML</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">htmlReplacer</span><span class="op">(</span><span class="ident">stripTags</span><span class="op">(</span><span class="ident">s</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">htmlNospaceNormReplacementTable</span><span class="op">,</span>&nbsp;<span class="ident">false</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">htmlReplacer</span><span class="op">(</span><span class="ident">s</span><span class="op">,</span>&nbsp;<span class="ident">htmlNospaceReplacementTable</span><span class="op">,</span>&nbsp;<span class="ident">false</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;attrEscaper&nbsp;escapes&nbsp;for&nbsp;inclusion&nbsp;in&nbsp;quoted&nbsp;attribute&nbsp;values.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">attrEscaper</span><span class="op">(</span><span class="ident">args</span>&nbsp;<span class="op">...</span><span class="keyword">interface</span><span class="op">{</span><span class="op">}</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span><span class="op">,</span>&nbsp;<span class="ident">t</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">stringify</span><span class="op">(</span><span class="ident">args</span><span class="op">...</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">t</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">contentTypeHTML</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">htmlReplacer</span><span class="op">(</span><span class="ident">stripTags</span><span class="op">(</span><span class="ident">s</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">htmlNormReplacementTable</span><span class="op">,</span>&nbsp;<span class="ident">true</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">htmlReplacer</span><span class="op">(</span><span class="ident">s</span><span class="op">,</span>&nbsp;<span class="ident">htmlReplacementTable</span><span class="op">,</span>&nbsp;<span class="ident">true</span><span class="op">)</span><br>
<span class="lineno">30</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;rcdataEscaper&nbsp;escapes&nbsp;for&nbsp;inclusion&nbsp;in&nbsp;an&nbsp;RCDATA&nbsp;element&nbsp;body.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">rcdataEscaper</span><span class="op">(</span><span class="ident">args</span>&nbsp;<span class="op">...</span><span class="keyword">interface</span><span class="op">{</span><span class="op">}</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span><span class="op">,</span>&nbsp;<span class="ident">t</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">stringify</span><span class="op">(</span><span class="ident">args</span><span class="op">...</span><span class="op">)</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">t</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">contentTypeHTML</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">htmlReplacer</span><span class="op">(</span><span class="ident">s</span><span class="op">,</span>&nbsp;<span class="ident">htmlNormReplacementTable</span><span class="op">,</span>&nbsp;<span class="ident">true</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">htmlReplacer</span><span class="op">(</span><span class="ident">s</span><span class="op">,</span>&nbsp;<span class="ident">htmlReplacementTable</span><span class="op">,</span>&nbsp;<span class="ident">true</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;htmlEscaper&nbsp;escapes&nbsp;for&nbsp;inclusion&nbsp;in&nbsp;HTML&nbsp;text.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">htmlEscaper</span><span class="op">(</span><span class="ident">args</span>&nbsp;<span class="op">...</span><span class="keyword">interface</span><span class="op">{</span><span class="op">}</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span><span class="op">,</span>&nbsp;<span class="ident">t</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">stringify</span><span class="op">(</span><span class="ident">args</span><span class="op">...</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">t</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">contentTypeHTML</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">htmlReplacer</span><span class="op">(</span><span class="ident">s</span><span class="op">,</span>&nbsp;<span class="ident">htmlReplacementTable</span><span class="op">,</span>&nbsp;<span class="ident">true</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment">//&nbsp;htmlReplacementTable&nbsp;contains&nbsp;the&nbsp;runes&nbsp;that&nbsp;need&nbsp;to&nbsp;be&nbsp;escaped</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;inside&nbsp;a&nbsp;quoted&nbsp;attribute&nbsp;value&nbsp;or&nbsp;in&nbsp;a&nbsp;text&nbsp;node.</span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">htmlReplacementTable</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">string</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;http://www.w3.org/TR/html5/syntax.html#attribute-value-(unquoted)-state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;U+0000&nbsp;NULL&nbsp;Parse&nbsp;error.&nbsp;Append&nbsp;a&nbsp;U+FFFD&nbsp;REPLACEMENT</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;CHARACTER&nbsp;character&nbsp;to&nbsp;the&nbsp;current&nbsp;attribute&#39;s&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;and&nbsp;similarly</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;http://www.w3.org/TR/html5/syntax.html#before-attribute-value-state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">&#34;\uFFFD&#34;</span><span class="op">,</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#39;&#34;&#39;</span><span class="op">:</span>&nbsp;&nbsp;<span class="string">&#34;&amp;#34;&#34;</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#39;&amp;&#39;</span><span class="op">:</span>&nbsp;&nbsp;<span class="string">&#34;&amp;amp;&#34;</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#39;\&#39;&#39;</span><span class="op">:</span>&nbsp;<span class="string">&#34;&amp;#39;&#34;</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#39;+&#39;</span><span class="op">:</span>&nbsp;&nbsp;<span class="string">&#34;&amp;#43;&#34;</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#39;&lt;&#39;</span><span class="op">:</span>&nbsp;&nbsp;<span class="string">&#34;&amp;lt;&#34;</span><span class="op">,</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#39;&gt;&#39;</span><span class="op">:</span>&nbsp;&nbsp;<span class="string">&#34;&amp;gt;&#34;</span><span class="op">,</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;htmlNormReplacementTable&nbsp;is&nbsp;like&nbsp;htmlReplacementTable&nbsp;but&nbsp;without&nbsp;&#39;&amp;&#39;&nbsp;to</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;avoid&nbsp;over-encoding&nbsp;existing&nbsp;entities.</span><br>
<span class="lineno">70</span><span class="keyword">var</span>&nbsp;<span class="ident">htmlNormReplacementTable</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">string</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">&#34;\uFFFD&#34;</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#39;&#34;&#39;</span><span class="op">:</span>&nbsp;&nbsp;<span class="string">&#34;&amp;#34;&#34;</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#39;\&#39;&#39;</span><span class="op">:</span>&nbsp;<span class="string">&#34;&amp;#39;&#34;</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#39;+&#39;</span><span class="op">:</span>&nbsp;&nbsp;<span class="string">&#34;&amp;#43;&#34;</span><span class="op">,</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#39;&lt;&#39;</span><span class="op">:</span>&nbsp;&nbsp;<span class="string">&#34;&amp;lt;&#34;</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#39;&gt;&#39;</span><span class="op">:</span>&nbsp;&nbsp;<span class="string">&#34;&amp;gt;&#34;</span><span class="op">,</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;htmlNospaceReplacementTable&nbsp;contains&nbsp;the&nbsp;runes&nbsp;that&nbsp;need&nbsp;to&nbsp;be&nbsp;escaped</span><br>
<span class="lineno">80</span><span class="comment">//&nbsp;inside&nbsp;an&nbsp;unquoted&nbsp;attribute&nbsp;value.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;The&nbsp;set&nbsp;of&nbsp;runes&nbsp;escaped&nbsp;is&nbsp;the&nbsp;union&nbsp;of&nbsp;the&nbsp;HTML&nbsp;specials&nbsp;and</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;those&nbsp;determined&nbsp;by&nbsp;running&nbsp;the&nbsp;JS&nbsp;below&nbsp;in&nbsp;browsers:</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&lt;div&nbsp;id=d&gt;&lt;/div&gt;</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&lt;script&gt;(function&nbsp;()&nbsp;{</span><br>
<span class="lineno">85</span><span class="comment">//&nbsp;var&nbsp;a&nbsp;=&nbsp;[],&nbsp;d&nbsp;=&nbsp;document.getElementById(&#34;d&#34;),&nbsp;i,&nbsp;c,&nbsp;s;</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;for&nbsp;(i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;0x10000;&nbsp;++i)&nbsp;{</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&nbsp;&nbsp;c&nbsp;=&nbsp;String.fromCharCode(i);</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&nbsp;&nbsp;d.innerHTML&nbsp;=&nbsp;&#34;&lt;span&nbsp;title=&#34;&nbsp;+&nbsp;c&nbsp;+&nbsp;&#34;lt&#34;&nbsp;+&nbsp;c&nbsp;+&nbsp;&#34;&gt;&lt;/span&gt;&#34;</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;&nbsp;&nbsp;s&nbsp;=&nbsp;d.getElementsByTagName(&#34;SPAN&#34;)[0];</span><br>
<span class="lineno">90</span><span class="comment">//&nbsp;&nbsp;&nbsp;if&nbsp;(!s&nbsp;||&nbsp;s.title&nbsp;!==&nbsp;c&nbsp;+&nbsp;&#34;lt&#34;&nbsp;+&nbsp;c)&nbsp;{&nbsp;a.push(i.toString(16));&nbsp;}</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;}</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;document.write(a.join(&#34;,&nbsp;&#34;));</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;})()&lt;/script&gt;</span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">htmlNospaceReplacementTable</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">string</span><span class="op">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">&#34;&amp;#xfffd;&#34;</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#39;\t&#39;</span><span class="op">:</span>&nbsp;<span class="string">&#34;&amp;#9;&#34;</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#39;\n&#39;</span><span class="op">:</span>&nbsp;<span class="string">&#34;&amp;#10;&#34;</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#39;\v&#39;</span><span class="op">:</span>&nbsp;<span class="string">&#34;&amp;#11;&#34;</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#39;\f&#39;</span><span class="op">:</span>&nbsp;<span class="string">&#34;&amp;#12;&#34;</span><span class="op">,</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#39;\r&#39;</span><span class="op">:</span>&nbsp;<span class="string">&#34;&amp;#13;&#34;</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#39;&nbsp;&#39;</span><span class="op">:</span>&nbsp;&nbsp;<span class="string">&#34;&amp;#32;&#34;</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#39;&#34;&#39;</span><span class="op">:</span>&nbsp;&nbsp;<span class="string">&#34;&amp;#34;&#34;</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#39;&amp;&#39;</span><span class="op">:</span>&nbsp;&nbsp;<span class="string">&#34;&amp;amp;&#34;</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#39;\&#39;&#39;</span><span class="op">:</span>&nbsp;<span class="string">&#34;&amp;#39;&#34;</span><span class="op">,</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#39;+&#39;</span><span class="op">:</span>&nbsp;&nbsp;<span class="string">&#34;&amp;#43;&#34;</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#39;&lt;&#39;</span><span class="op">:</span>&nbsp;&nbsp;<span class="string">&#34;&amp;lt;&#34;</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#39;=&#39;</span><span class="op">:</span>&nbsp;&nbsp;<span class="string">&#34;&amp;#61;&#34;</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#39;&gt;&#39;</span><span class="op">:</span>&nbsp;&nbsp;<span class="string">&#34;&amp;gt;&#34;</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;A&nbsp;parse&nbsp;error&nbsp;in&nbsp;the&nbsp;attribute&nbsp;value&nbsp;(unquoted)&nbsp;and</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;before&nbsp;attribute&nbsp;value&nbsp;states.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Treated&nbsp;as&nbsp;a&nbsp;quoting&nbsp;character&nbsp;by&nbsp;IE.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#39;`&#39;</span><span class="op">:</span>&nbsp;<span class="string">&#34;&amp;#96;&#34;</span><span class="op">,</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span><span class="comment">//&nbsp;htmlNospaceNormReplacementTable&nbsp;is&nbsp;like&nbsp;htmlNospaceReplacementTable&nbsp;but</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;without&nbsp;&#39;&amp;&#39;&nbsp;to&nbsp;avoid&nbsp;over-encoding&nbsp;existing&nbsp;entities.</span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">htmlNospaceNormReplacementTable</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">string</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num">0</span><span class="op">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">&#34;&amp;#xfffd;&#34;</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#39;\t&#39;</span><span class="op">:</span>&nbsp;<span class="string">&#34;&amp;#9;&#34;</span><span class="op">,</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#39;\n&#39;</span><span class="op">:</span>&nbsp;<span class="string">&#34;&amp;#10;&#34;</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#39;\v&#39;</span><span class="op">:</span>&nbsp;<span class="string">&#34;&amp;#11;&#34;</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#39;\f&#39;</span><span class="op">:</span>&nbsp;<span class="string">&#34;&amp;#12;&#34;</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#39;\r&#39;</span><span class="op">:</span>&nbsp;<span class="string">&#34;&amp;#13;&#34;</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#39;&nbsp;&#39;</span><span class="op">:</span>&nbsp;&nbsp;<span class="string">&#34;&amp;#32;&#34;</span><span class="op">,</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#39;&#34;&#39;</span><span class="op">:</span>&nbsp;&nbsp;<span class="string">&#34;&amp;#34;&#34;</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#39;\&#39;&#39;</span><span class="op">:</span>&nbsp;<span class="string">&#34;&amp;#39;&#34;</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#39;+&#39;</span><span class="op">:</span>&nbsp;&nbsp;<span class="string">&#34;&amp;#43;&#34;</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#39;&lt;&#39;</span><span class="op">:</span>&nbsp;&nbsp;<span class="string">&#34;&amp;lt;&#34;</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#39;=&#39;</span><span class="op">:</span>&nbsp;&nbsp;<span class="string">&#34;&amp;#61;&#34;</span><span class="op">,</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#39;&gt;&#39;</span><span class="op">:</span>&nbsp;&nbsp;<span class="string">&#34;&amp;gt;&#34;</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;A&nbsp;parse&nbsp;error&nbsp;in&nbsp;the&nbsp;attribute&nbsp;value&nbsp;(unquoted)&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;before&nbsp;attribute&nbsp;value&nbsp;states.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Treated&nbsp;as&nbsp;a&nbsp;quoting&nbsp;character&nbsp;by&nbsp;IE.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#39;`&#39;</span><span class="op">:</span>&nbsp;<span class="string">&#34;&amp;#96;&#34;</span><span class="op">,</span><br>
<span class="lineno">135</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;htmlReplacer&nbsp;returns&nbsp;s&nbsp;with&nbsp;runes&nbsp;replaced&nbsp;according&nbsp;to&nbsp;replacementTable</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;and&nbsp;when&nbsp;badRunes&nbsp;is&nbsp;true,&nbsp;certain&nbsp;bad&nbsp;runes&nbsp;are&nbsp;allowed&nbsp;through&nbsp;unescaped.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">htmlReplacer</span><span class="op">(</span><span class="ident">s</span>&nbsp;<span class="builtintype">string</span><span class="op">,</span>&nbsp;<span class="ident">replacementTable</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">string</span><span class="op">,</span>&nbsp;<span class="ident">badRunes</span>&nbsp;<span class="builtintype">bool</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">written</span><span class="op">,</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">bytes</span><span class="op">.</span><span class="ident">Buffer</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span><span class="op">,</span>&nbsp;<span class="ident">r</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">s</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtintype">int</span><span class="op">(</span><span class="ident">r</span><span class="op">)</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">replacementTable</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">repl</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">replacementTable</span><span class="op">[</span><span class="ident">r</span><span class="op">]</span><span class="op">;</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">repl</span><span class="op">)</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span><span class="op">.</span><span class="ident">WriteString</span><span class="op">(</span><span class="ident">s</span><span class="op">[</span><span class="ident">written</span><span class="op">:</span><span class="ident">i</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span><span class="op">.</span><span class="ident">WriteString</span><span class="op">(</span><span class="ident">repl</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Valid&nbsp;as&nbsp;long&nbsp;as&nbsp;replacementTable&nbsp;doesn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;include&nbsp;anything&nbsp;above&nbsp;0x7f.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">written</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">utf8</span><span class="op">.</span><span class="ident">RuneLen</span><span class="op">(</span><span class="ident">r</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="keyword">if</span>&nbsp;<span class="ident">badRunes</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;No-op.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;IE&nbsp;does&nbsp;not&nbsp;allow&nbsp;these&nbsp;ranges&nbsp;in&nbsp;unquoted&nbsp;attrs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="keyword">if</span>&nbsp;<span class="num">0xfdd0</span>&nbsp;<span class="op">&lt;=</span>&nbsp;<span class="ident">r</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">r</span>&nbsp;<span class="op">&lt;=</span>&nbsp;<span class="num">0xfdef</span>&nbsp;<span class="op">||</span>&nbsp;<span class="num">0xfff0</span>&nbsp;<span class="op">&lt;=</span>&nbsp;<span class="ident">r</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">r</span>&nbsp;<span class="op">&lt;=</span>&nbsp;<span class="num">0xffff</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">fmt</span><span class="op">.</span><span class="ident">Fprintf</span><span class="op">(</span><span class="ident">b</span><span class="op">,</span>&nbsp;<span class="string">&#34;%s&amp;#x%x;&#34;</span><span class="op">,</span>&nbsp;<span class="ident">s</span><span class="op">[</span><span class="ident">written</span><span class="op">:</span><span class="ident">i</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">r</span><span class="op">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">written</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">utf8</span><span class="op">.</span><span class="ident">RuneLen</span><span class="op">(</span><span class="ident">r</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">written</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">s</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span><span class="op">.</span><span class="ident">WriteString</span><span class="op">(</span><span class="ident">s</span><span class="op">[</span><span class="ident">written</span><span class="op">:</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">String</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">165</span><span class="comment">//&nbsp;stripTags&nbsp;takes&nbsp;a&nbsp;snippet&nbsp;of&nbsp;HTML&nbsp;and&nbsp;returns&nbsp;only&nbsp;the&nbsp;text&nbsp;content.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;For&nbsp;example,&nbsp;`&lt;b&gt;&amp;iexcl;Hi!&lt;/b&gt;&nbsp;&lt;script&gt;...&lt;/script&gt;`&nbsp;-&gt;&nbsp;`&amp;iexcl;Hi!&nbsp;`.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">stripTags</span><span class="op">(</span><span class="ident">html</span>&nbsp;<span class="builtintype">string</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">b</span>&nbsp;<span class="ident">bytes</span><span class="op">.</span><span class="ident">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span><span class="op">,</span>&nbsp;<span class="ident">c</span><span class="op">,</span>&nbsp;<span class="ident">i</span><span class="op">,</span>&nbsp;<span class="ident">allText</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="builtintype">byte</span><span class="op">(</span><span class="ident">html</span><span class="op">)</span><span class="op">,</span>&nbsp;<span class="ident">context</span><span class="op">{</span><span class="op">}</span><span class="op">,</span>&nbsp;<span class="num">0</span><span class="op">,</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Using&nbsp;the&nbsp;transition&nbsp;funcs&nbsp;helps&nbsp;us&nbsp;avoid&nbsp;mangling</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;`&lt;div&nbsp;title=&#34;1&gt;2&#34;&gt;`&nbsp;or&nbsp;`I&nbsp;&lt;3&nbsp;Ponies!`.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">s</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">delim</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">delimNone</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">st</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">state</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Use&nbsp;RCDATA&nbsp;instead&nbsp;of&nbsp;parsing&nbsp;into&nbsp;JS&nbsp;or&nbsp;CSS&nbsp;styles.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">element</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">elementNone</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="op">!</span><span class="ident">isInTag</span><span class="op">(</span><span class="ident">st</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">st</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">stateRCDATA</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">d</span><span class="op">,</span>&nbsp;<span class="ident">nread</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">transitionFunc</span><span class="op">[</span><span class="ident">st</span><span class="op">]</span><span class="op">(</span><span class="ident">c</span><span class="op">,</span>&nbsp;<span class="ident">s</span><span class="op">[</span><span class="ident">i</span><span class="op">:</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i1</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">nread</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">state</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">stateText</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">state</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">stateRCDATA</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Emit&nbsp;text&nbsp;up&nbsp;to&nbsp;the&nbsp;start&nbsp;of&nbsp;the&nbsp;tag&nbsp;or&nbsp;comment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">j</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">i1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">d</span><span class="op">.</span><span class="ident">state</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">state</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">j1</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="op">-</span>&nbsp;<span class="num">1</span><span class="op">;</span>&nbsp;<span class="ident">j1</span>&nbsp;<span class="op">&gt;=</span>&nbsp;<span class="ident">i</span><span class="op">;</span>&nbsp;<span class="ident">j1</span><span class="op">--</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">s</span><span class="op">[</span><span class="ident">j1</span><span class="op">]</span>&nbsp;<span class="op">==</span>&nbsp;<span class="string">&#39;&lt;&#39;</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">j</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">j1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span><span class="op">.</span><span class="ident">Write</span><span class="op">(</span><span class="ident">s</span><span class="op">[</span><span class="ident">i</span><span class="op">:</span><span class="ident">j</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">allText</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">false</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">c</span><span class="op">,</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">d</span><span class="op">,</span>&nbsp;<span class="ident">i1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i1</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">bytes</span><span class="op">.</span><span class="ident">IndexAny</span><span class="op">(</span><span class="ident">s</span><span class="op">[</span><span class="ident">i</span><span class="op">:</span><span class="op">]</span><span class="op">,</span>&nbsp;<span class="ident">delimEnds</span><span class="op">[</span><span class="ident">c</span><span class="op">.</span><span class="ident">delim</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">i1</span>&nbsp;<span class="op">&lt;</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">delim</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">delimSpaceOrTagEnd</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Consume&nbsp;any&nbsp;quote.</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">i1</span><span class="op">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">c</span><span class="op">,</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">context</span><span class="op">{</span><span class="ident">state</span><span class="op">:</span>&nbsp;<span class="ident">stateTag</span><span class="op">,</span>&nbsp;<span class="ident">element</span><span class="op">:</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">element</span><span class="op">}</span><span class="op">,</span>&nbsp;<span class="ident">i1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">allText</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">html</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="keyword">if</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">state</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">stateText</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">c</span><span class="op">.</span><span class="ident">state</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">stateRCDATA</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">b</span><span class="op">.</span><span class="ident">Write</span><span class="op">(</span><span class="ident">s</span><span class="op">[</span><span class="ident">i</span><span class="op">:</span><span class="op">]</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">b</span><span class="op">.</span><span class="ident">String</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">215</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;htmlNameFilter&nbsp;accepts&nbsp;valid&nbsp;parts&nbsp;of&nbsp;an&nbsp;HTML&nbsp;attribute&nbsp;or&nbsp;tag&nbsp;name&nbsp;or</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;a&nbsp;known-safe&nbsp;HTML&nbsp;attribute.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">htmlNameFilter</span><span class="op">(</span><span class="ident">args</span>&nbsp;<span class="op">...</span><span class="keyword">interface</span><span class="op">{</span><span class="op">}</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span><span class="op">,</span>&nbsp;<span class="ident">t</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">stringify</span><span class="op">(</span><span class="ident">args</span><span class="op">...</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">t</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">contentTypeHTMLAttr</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="builtinfunc">len</span><span class="op">(</span><span class="ident">s</span><span class="op">)</span>&nbsp;<span class="op">==</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Avoid&nbsp;violation&nbsp;of&nbsp;structure&nbsp;preservation.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&lt;input&nbsp;checked&nbsp;{{.K}}={{.V}}&gt;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Without&nbsp;this,&nbsp;if&nbsp;.K&nbsp;is&nbsp;empty&nbsp;then&nbsp;.V&nbsp;is&nbsp;the&nbsp;value&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;checked,&nbsp;but&nbsp;otherwise&nbsp;.V&nbsp;is&nbsp;the&nbsp;value&nbsp;of&nbsp;the&nbsp;attribute</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;named&nbsp;.K.</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">filterFailsafe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">strings</span><span class="op">.</span><span class="ident">ToLower</span><span class="op">(</span><span class="ident">s</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">t</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">attrType</span><span class="op">(</span><span class="ident">s</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">t</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">contentTypePlain</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;TODO:&nbsp;Split&nbsp;attr&nbsp;and&nbsp;element&nbsp;name&nbsp;part&nbsp;filters&nbsp;so&nbsp;we&nbsp;can&nbsp;whitelist</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;attributes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">filterFailsafe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">r</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">s</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#39;0&#39;</span>&nbsp;<span class="op">&lt;=</span>&nbsp;<span class="ident">r</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">r</span>&nbsp;<span class="op">&lt;=</span>&nbsp;<span class="string">&#39;9&#39;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#39;a&#39;</span>&nbsp;<span class="op">&lt;=</span>&nbsp;<span class="ident">r</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">r</span>&nbsp;<span class="op">&lt;=</span>&nbsp;<span class="string">&#39;z&#39;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">default</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">filterFailsafe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">s</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;commentEscaper&nbsp;returns&nbsp;the&nbsp;empty&nbsp;string&nbsp;regardless&nbsp;of&nbsp;input.</span><br>
<span class="lineno">250</span><span class="comment">//&nbsp;Comment&nbsp;content&nbsp;does&nbsp;not&nbsp;correspond&nbsp;to&nbsp;any&nbsp;parsed&nbsp;structure&nbsp;or</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;human-readable&nbsp;content,&nbsp;so&nbsp;the&nbsp;simplest&nbsp;and&nbsp;most&nbsp;secure&nbsp;policy&nbsp;is&nbsp;to&nbsp;drop</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;content&nbsp;interpolated&nbsp;into&nbsp;comments.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;This&nbsp;approach&nbsp;is&nbsp;equally&nbsp;valid&nbsp;whether&nbsp;or&nbsp;not&nbsp;static&nbsp;comment&nbsp;content&nbsp;is</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;removed&nbsp;from&nbsp;the&nbsp;template.</span><br>
<span class="lineno">255</span><span class="keyword">func</span>&nbsp;<span class="ident">commentEscaper</span><span class="op">(</span><span class="ident">args</span>&nbsp;<span class="op">...</span><span class="keyword">interface</span><span class="op">{</span><span class="op">}</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="string">&#34;&#34;</span><br>
<span class="lineno"></span><span class="op">}</span>
</div>
</body>
</html>
