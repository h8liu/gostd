<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>mime/multipart</h2>
<ul>
<li><a href="/gostd/mime/multipart/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/mime/multipart/formdata.go.html">formdata.go</a></li>
<li><a href="/gostd/mime/multipart/formdata_test.go.html">formdata_test.go</a></li>
<li><a href="/gostd/mime/multipart/multipart.go.html" class="current">multipart.go</a></li>
<li><a href="/gostd/mime/multipart/multipart_test.go.html">multipart_test.go</a></li>
<li><a href="/gostd/mime/multipart/quotedprintable.go.html">quotedprintable.go</a></li>
<li><a href="/gostd/mime/multipart/quotedprintable_test.go.html">quotedprintable_test.go</a></li>
<li><a href="/gostd/mime/multipart/writer.go.html">writer.go</a></li>
<li><a href="/gostd/mime/multipart/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3664649">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3664704">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3664758">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><span class="comment" id="3664808">//</span><br>
<span class="lineno">5</span><br>
<span class="lineno"></span><span class="comment" id="3664812">/*<br>
<span class="lineno"></span>Package&nbsp;multipart&nbsp;implements&nbsp;MIME&nbsp;multipart&nbsp;parsing,&nbsp;as&nbsp;defined&nbsp;in&nbsp;RFC<br>
<span class="lineno"></span>2046.<br>
<span class="lineno"></span><br>
<span class="lineno">10</span>The&nbsp;implementation&nbsp;is&nbsp;sufficient&nbsp;for&nbsp;HTTP&nbsp;(RFC&nbsp;2388)&nbsp;and&nbsp;the&nbsp;multipart<br>
<span class="lineno"></span>bodies&nbsp;generated&nbsp;by&nbsp;popular&nbsp;browsers.<br>
<span class="lineno"></span>*/</span><br>
<span class="lineno"></span><span class="keyword" id="3665005">package</span>&nbsp;<span class="ident" id="3665013">multipart</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="3665024">import</span>&nbsp;<span class="op" id="3665031">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3665034">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3665043">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3665052">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3665059">&#34;io&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3665065">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3665078">&#34;mime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3665086">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span><span class="op" id="3665102">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="3665105">var</span>&nbsp;<span class="ident" id="3665109">emptyParams</span>&nbsp;<span class="op" id="3665121">=</span>&nbsp;<span class="builtinfunc" id="3665123">make</span><span class="op" id="3665127">(</span><span class="keyword" id="3665128">map</span><span class="op" id="3665131">[</span><span class="builtintype" id="3665132">string</span><span class="op" id="3665138">]</span><span class="builtintype" id="3665139">string</span><span class="op" id="3665145">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3665148">//&nbsp;A&nbsp;Part&nbsp;represents&nbsp;a&nbsp;single&nbsp;part&nbsp;in&nbsp;a&nbsp;multipart&nbsp;body.</span><br>
<span class="lineno"></span><span class="keyword" id="3665204">type</span>&nbsp;<span class="ident" id="3665209">Part</span>&nbsp;<span class="keyword" id="3665214">struct</span>&nbsp;<span class="op" id="3665221">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3665224">//&nbsp;The&nbsp;headers&nbsp;of&nbsp;the&nbsp;body,&nbsp;if&nbsp;any,&nbsp;with&nbsp;the&nbsp;keys&nbsp;canonicalized</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3665289">//&nbsp;in&nbsp;the&nbsp;same&nbsp;fashion&nbsp;that&nbsp;the&nbsp;Go&nbsp;http.Request&nbsp;headers&nbsp;are.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3665351">//&nbsp;For&nbsp;example,&nbsp;&#34;foo-bar&#34;&nbsp;changes&nbsp;case&nbsp;to&nbsp;&#34;Foo-Bar&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3665404">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3665408">//&nbsp;As&nbsp;a&nbsp;special&nbsp;case,&nbsp;if&nbsp;the&nbsp;&#34;Content-Transfer-Encoding&#34;&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3665473">//&nbsp;has&nbsp;a&nbsp;value&nbsp;of&nbsp;&#34;quoted-printable&#34;,&nbsp;that&nbsp;header&nbsp;is&nbsp;instead</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3665535">//&nbsp;hidden&nbsp;from&nbsp;this&nbsp;map&nbsp;and&nbsp;the&nbsp;body&nbsp;is&nbsp;transparently&nbsp;decoded</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3665598">//&nbsp;during&nbsp;Read&nbsp;calls.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3665621">Header</span>&nbsp;<span class="ident" id="3665628">textproto</span><span class="op" id="3665637">.</span><span class="ident" id="3665638">MIMEHeader</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3665651">buffer</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3665661">*</span><span class="ident" id="3665662">bytes</span><span class="op" id="3665667">.</span><span class="ident" id="3665668">Buffer</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3665676">mr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3665686">*</span><span class="ident" id="3665687">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3665695">bytesRead</span>&nbsp;<span class="builtintype" id="3665705">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3665711">disposition</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3665729">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3665737">dispositionParams</span>&nbsp;<span class="keyword" id="3665755">map</span><span class="op" id="3665758">[</span><span class="builtintype" id="3665759">string</span><span class="op" id="3665765">]</span><span class="builtintype" id="3665766">string</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3665775">//&nbsp;r&nbsp;is&nbsp;either&nbsp;a&nbsp;reader&nbsp;directly&nbsp;reading&nbsp;from&nbsp;mr,&nbsp;or&nbsp;it&#39;s&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3665836">//&nbsp;wrapper&nbsp;around&nbsp;such&nbsp;a&nbsp;reader,&nbsp;decoding&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3665883">//&nbsp;Content-Transfer-Encoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3665913">r</span>&nbsp;<span class="ident" id="3665915">io</span><span class="op" id="3665917">.</span><span class="ident" id="3665918">Reader</span><br>
<span class="lineno">50</span><span class="op" id="3665925">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3665928">//&nbsp;FormName&nbsp;returns&nbsp;the&nbsp;name&nbsp;parameter&nbsp;if&nbsp;p&nbsp;has&nbsp;a&nbsp;Content-Disposition</span><br>
<span class="lineno"></span><span class="comment" id="3665998">//&nbsp;of&nbsp;type&nbsp;&#34;form-data&#34;.&nbsp;&nbsp;Otherwise&nbsp;it&nbsp;returns&nbsp;the&nbsp;empty&nbsp;string.</span><br>
<span class="lineno"></span><span class="keyword" id="3666062">func</span>&nbsp;<span class="op" id="3666067">(</span><span class="ident" id="3666068">p</span>&nbsp;<span class="op" id="3666070">*</span><span class="ident" id="3666071">Part</span><span class="op" id="3666075">)</span>&nbsp;<span class="ident" id="3666077">FormName</span><span class="op" id="3666085">(</span><span class="op" id="3666086">)</span>&nbsp;<span class="builtintype" id="3666088">string</span>&nbsp;<span class="op" id="3666095">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3666098">//&nbsp;See&nbsp;http://tools.ietf.org/html/rfc2183&nbsp;section&nbsp;2&nbsp;for&nbsp;EBNF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3666160">//&nbsp;of&nbsp;Content-Disposition&nbsp;value&nbsp;format.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3666201">if</span>&nbsp;<span class="ident" id="3666204">p</span><span class="op" id="3666205">.</span><span class="ident" id="3666206">dispositionParams</span>&nbsp;<span class="op" id="3666224">==</span>&nbsp;<span class="ident" id="3666227">nil</span>&nbsp;<span class="op" id="3666231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3666235">p</span><span class="op" id="3666236">.</span><span class="ident" id="3666237">parseContentDisposition</span><span class="op" id="3666260">(</span><span class="op" id="3666261">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3666264">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3666267">if</span>&nbsp;<span class="ident" id="3666270">p</span><span class="op" id="3666271">.</span><span class="ident" id="3666272">disposition</span>&nbsp;<span class="op" id="3666284">!=</span>&nbsp;<span class="string" id="3666287">&#34;form-data&#34;</span>&nbsp;<span class="op" id="3666299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3666303">return</span>&nbsp;<span class="string" id="3666310">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3666314">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3666317">return</span>&nbsp;<span class="ident" id="3666324">p</span><span class="op" id="3666325">.</span><span class="ident" id="3666326">dispositionParams</span><span class="op" id="3666343">[</span><span class="string" id="3666344">&#34;name&#34;</span><span class="op" id="3666350">]</span><br>
<span class="lineno"></span><span class="op" id="3666352">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="comment" id="3666355">//&nbsp;FileName&nbsp;returns&nbsp;the&nbsp;filename&nbsp;parameter&nbsp;of&nbsp;the&nbsp;Part&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="3666412">//&nbsp;Content-Disposition&nbsp;header.</span><br>
<span class="lineno"></span><span class="keyword" id="3666443">func</span>&nbsp;<span class="op" id="3666448">(</span><span class="ident" id="3666449">p</span>&nbsp;<span class="op" id="3666451">*</span><span class="ident" id="3666452">Part</span><span class="op" id="3666456">)</span>&nbsp;<span class="ident" id="3666458">FileName</span><span class="op" id="3666466">(</span><span class="op" id="3666467">)</span>&nbsp;<span class="builtintype" id="3666469">string</span>&nbsp;<span class="op" id="3666476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3666479">if</span>&nbsp;<span class="ident" id="3666482">p</span><span class="op" id="3666483">.</span><span class="ident" id="3666484">dispositionParams</span>&nbsp;<span class="op" id="3666502">==</span>&nbsp;<span class="ident" id="3666505">nil</span>&nbsp;<span class="op" id="3666509">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3666513">p</span><span class="op" id="3666514">.</span><span class="ident" id="3666515">parseContentDisposition</span><span class="op" id="3666538">(</span><span class="op" id="3666539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3666542">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3666545">return</span>&nbsp;<span class="ident" id="3666552">p</span><span class="op" id="3666553">.</span><span class="ident" id="3666554">dispositionParams</span><span class="op" id="3666571">[</span><span class="string" id="3666572">&#34;filename&#34;</span><span class="op" id="3666582">]</span><br>
<span class="lineno"></span><span class="op" id="3666584">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">75</span><span class="keyword" id="3666587">func</span>&nbsp;<span class="op" id="3666592">(</span><span class="ident" id="3666593">p</span>&nbsp;<span class="op" id="3666595">*</span><span class="ident" id="3666596">Part</span><span class="op" id="3666600">)</span>&nbsp;<span class="ident" id="3666602">parseContentDisposition</span><span class="op" id="3666625">(</span><span class="op" id="3666626">)</span>&nbsp;<span class="op" id="3666628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3666631">v</span>&nbsp;<span class="op" id="3666633">:=</span>&nbsp;<span class="ident" id="3666636">p</span><span class="op" id="3666637">.</span><span class="ident" id="3666638">Header</span><span class="op" id="3666644">.</span><span class="ident" id="3666645">Get</span><span class="op" id="3666648">(</span><span class="string" id="3666649">&#34;Content-Disposition&#34;</span><span class="op" id="3666670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3666673">var</span>&nbsp;<span class="ident" id="3666677">err</span>&nbsp;<span class="builtintype" id="3666681">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3666688">p</span><span class="op" id="3666689">.</span><span class="ident" id="3666690">disposition</span><span class="op" id="3666701">,</span>&nbsp;<span class="ident" id="3666703">p</span><span class="op" id="3666704">.</span><span class="ident" id="3666705">dispositionParams</span><span class="op" id="3666722">,</span>&nbsp;<span class="ident" id="3666724">err</span>&nbsp;<span class="op" id="3666728">=</span>&nbsp;<span class="ident" id="3666730">mime</span><span class="op" id="3666734">.</span><span class="ident" id="3666735">ParseMediaType</span><span class="op" id="3666749">(</span><span class="ident" id="3666750">v</span><span class="op" id="3666751">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3666754">if</span>&nbsp;<span class="ident" id="3666757">err</span>&nbsp;<span class="op" id="3666761">!=</span>&nbsp;<span class="ident" id="3666764">nil</span>&nbsp;<span class="op" id="3666768">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3666772">p</span><span class="op" id="3666773">.</span><span class="ident" id="3666774">dispositionParams</span>&nbsp;<span class="op" id="3666792">=</span>&nbsp;<span class="ident" id="3666794">emptyParams</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3666807">}</span><br>
<span class="lineno"></span><span class="op" id="3666809">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3666812">//&nbsp;NewReader&nbsp;creates&nbsp;a&nbsp;new&nbsp;multipart&nbsp;Reader&nbsp;reading&nbsp;from&nbsp;r&nbsp;using&nbsp;the</span><br>
<span class="lineno">85</span><span class="comment" id="3666881">//&nbsp;given&nbsp;MIME&nbsp;boundary.</span><br>
<span class="lineno"></span><span class="comment" id="3666905">//</span><br>
<span class="lineno"></span><span class="comment" id="3666908">//&nbsp;The&nbsp;boundary&nbsp;is&nbsp;usually&nbsp;obtained&nbsp;from&nbsp;the&nbsp;&#34;boundary&#34;&nbsp;parameter&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="3666977">//&nbsp;the&nbsp;message&#39;s&nbsp;&#34;Content-Type&#34;&nbsp;header.&nbsp;Use&nbsp;mime.ParseMediaType&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3667044">//&nbsp;parse&nbsp;such&nbsp;headers.</span><br>
<span class="lineno">90</span><span class="keyword" id="3667067">func</span>&nbsp;<span class="ident" id="3667072">NewReader</span><span class="op" id="3667081">(</span><span class="ident" id="3667082">r</span>&nbsp;<span class="ident" id="3667084">io</span><span class="op" id="3667086">.</span><span class="ident" id="3667087">Reader</span><span class="op" id="3667093">,</span>&nbsp;<span class="ident" id="3667095">boundary</span>&nbsp;<span class="builtintype" id="3667104">string</span><span class="op" id="3667110">)</span>&nbsp;<span class="op" id="3667112">*</span><span class="ident" id="3667113">Reader</span>&nbsp;<span class="op" id="3667120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3667123">b</span>&nbsp;<span class="op" id="3667125">:=</span>&nbsp;<span class="op" id="3667128">[</span><span class="op" id="3667129">]</span><span class="builtintype" id="3667130">byte</span><span class="op" id="3667134">(</span><span class="string" id="3667135">&#34;\r\n--&#34;</span>&nbsp;<span class="op" id="3667144">+</span>&nbsp;<span class="ident" id="3667146">boundary</span>&nbsp;<span class="op" id="3667155">+</span>&nbsp;<span class="string" id="3667157">&#34;--&#34;</span><span class="op" id="3667161">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3667164">return</span>&nbsp;<span class="op" id="3667171">&amp;</span><span class="ident" id="3667172">Reader</span><span class="op" id="3667178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3667182">bufReader</span><span class="op" id="3667191">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3667200">bufio</span><span class="op" id="3667205">.</span><span class="ident" id="3667206">NewReader</span><span class="op" id="3667215">(</span><span class="ident" id="3667216">r</span><span class="op" id="3667217">)</span><span class="op" id="3667218">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3667222">nl</span><span class="op" id="3667224">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3667240">b</span><span class="op" id="3667241">[</span><span class="op" id="3667242">:</span><span class="num" id="3667243">2</span><span class="op" id="3667244">]</span><span class="op" id="3667245">,</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3667249">nlDashBoundary</span><span class="op" id="3667263">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3667267">b</span><span class="op" id="3667268">[</span><span class="op" id="3667269">:</span><span class="builtinfunc" id="3667270">len</span><span class="op" id="3667273">(</span><span class="ident" id="3667274">b</span><span class="op" id="3667275">)</span><span class="op" id="3667276">-</span><span class="num" id="3667277">2</span><span class="op" id="3667278">]</span><span class="op" id="3667279">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3667283">dashBoundaryDash</span><span class="op" id="3667299">:</span>&nbsp;<span class="ident" id="3667301">b</span><span class="op" id="3667302">[</span><span class="num" id="3667303">2</span><span class="op" id="3667304">:</span><span class="op" id="3667305">]</span><span class="op" id="3667306">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3667310">dashBoundary</span><span class="op" id="3667322">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3667328">b</span><span class="op" id="3667329">[</span><span class="num" id="3667330">2</span>&nbsp;<span class="op" id="3667332">:</span>&nbsp;<span class="builtinfunc" id="3667334">len</span><span class="op" id="3667337">(</span><span class="ident" id="3667338">b</span><span class="op" id="3667339">)</span><span class="op" id="3667340">-</span><span class="num" id="3667341">2</span><span class="op" id="3667342">]</span><span class="op" id="3667343">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3667346">}</span><br>
<span class="lineno"></span><span class="op" id="3667348">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword" id="3667351">func</span>&nbsp;<span class="ident" id="3667356">newPart</span><span class="op" id="3667363">(</span><span class="ident" id="3667364">mr</span>&nbsp;<span class="op" id="3667367">*</span><span class="ident" id="3667368">Reader</span><span class="op" id="3667374">)</span>&nbsp;<span class="op" id="3667376">(</span><span class="op" id="3667377">*</span><span class="ident" id="3667378">Part</span><span class="op" id="3667382">,</span>&nbsp;<span class="builtintype" id="3667384">error</span><span class="op" id="3667389">)</span>&nbsp;<span class="op" id="3667391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3667394">bp</span>&nbsp;<span class="op" id="3667397">:=</span>&nbsp;<span class="op" id="3667400">&amp;</span><span class="ident" id="3667401">Part</span><span class="op" id="3667405">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3667409">Header</span><span class="op" id="3667415">:</span>&nbsp;<span class="builtinfunc" id="3667417">make</span><span class="op" id="3667421">(</span><span class="keyword" id="3667422">map</span><span class="op" id="3667425">[</span><span class="builtintype" id="3667426">string</span><span class="op" id="3667432">]</span><span class="op" id="3667433">[</span><span class="op" id="3667434">]</span><span class="builtintype" id="3667435">string</span><span class="op" id="3667441">)</span><span class="op" id="3667442">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3667446">mr</span><span class="op" id="3667448">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3667454">mr</span><span class="op" id="3667456">,</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3667460">buffer</span><span class="op" id="3667466">:</span>&nbsp;<span class="builtinfunc" id="3667468">new</span><span class="op" id="3667471">(</span><span class="ident" id="3667472">bytes</span><span class="op" id="3667477">.</span><span class="ident" id="3667478">Buffer</span><span class="op" id="3667484">)</span><span class="op" id="3667485">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3667488">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3667491">if</span>&nbsp;<span class="ident" id="3667494">err</span>&nbsp;<span class="op" id="3667498">:=</span>&nbsp;<span class="ident" id="3667501">bp</span><span class="op" id="3667503">.</span><span class="ident" id="3667504">populateHeaders</span><span class="op" id="3667519">(</span><span class="op" id="3667520">)</span><span class="op" id="3667521">;</span>&nbsp;<span class="ident" id="3667523">err</span>&nbsp;<span class="op" id="3667527">!=</span>&nbsp;<span class="ident" id="3667530">nil</span>&nbsp;<span class="op" id="3667534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3667538">return</span>&nbsp;<span class="ident" id="3667545">nil</span><span class="op" id="3667548">,</span>&nbsp;<span class="ident" id="3667550">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3667555">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3667558">bp</span><span class="op" id="3667560">.</span><span class="ident" id="3667561">r</span>&nbsp;<span class="op" id="3667563">=</span>&nbsp;<span class="ident" id="3667565">partReader</span><span class="op" id="3667575">{</span><span class="ident" id="3667576">bp</span><span class="op" id="3667578">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3667581">const</span>&nbsp;<span class="ident" id="3667587">cte</span>&nbsp;<span class="op" id="3667591">=</span>&nbsp;<span class="string" id="3667593">&#34;Content-Transfer-Encoding&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3667622">if</span>&nbsp;<span class="ident" id="3667625">bp</span><span class="op" id="3667627">.</span><span class="ident" id="3667628">Header</span><span class="op" id="3667634">.</span><span class="ident" id="3667635">Get</span><span class="op" id="3667638">(</span><span class="ident" id="3667639">cte</span><span class="op" id="3667642">)</span>&nbsp;<span class="op" id="3667644">==</span>&nbsp;<span class="string" id="3667647">&#34;quoted-printable&#34;</span>&nbsp;<span class="op" id="3667666">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3667670">bp</span><span class="op" id="3667672">.</span><span class="ident" id="3667673">Header</span><span class="op" id="3667679">.</span><span class="ident" id="3667680">Del</span><span class="op" id="3667683">(</span><span class="ident" id="3667684">cte</span><span class="op" id="3667687">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3667691">bp</span><span class="op" id="3667693">.</span><span class="ident" id="3667694">r</span>&nbsp;<span class="op" id="3667696">=</span>&nbsp;<span class="ident" id="3667698">newQuotedPrintableReader</span><span class="op" id="3667722">(</span><span class="ident" id="3667723">bp</span><span class="op" id="3667725">.</span><span class="ident" id="3667726">r</span><span class="op" id="3667727">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3667730">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3667733">return</span>&nbsp;<span class="ident" id="3667740">bp</span><span class="op" id="3667742">,</span>&nbsp;<span class="ident" id="3667744">nil</span><br>
<span class="lineno"></span><span class="op" id="3667748">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3667751">func</span>&nbsp;<span class="op" id="3667756">(</span><span class="ident" id="3667757">bp</span>&nbsp;<span class="op" id="3667760">*</span><span class="ident" id="3667761">Part</span><span class="op" id="3667765">)</span>&nbsp;<span class="ident" id="3667767">populateHeaders</span><span class="op" id="3667782">(</span><span class="op" id="3667783">)</span>&nbsp;<span class="builtintype" id="3667785">error</span>&nbsp;<span class="op" id="3667791">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3667794">r</span>&nbsp;<span class="op" id="3667796">:=</span>&nbsp;<span class="ident" id="3667799">textproto</span><span class="op" id="3667808">.</span><span class="ident" id="3667809">NewReader</span><span class="op" id="3667818">(</span><span class="ident" id="3667819">bp</span><span class="op" id="3667821">.</span><span class="ident" id="3667822">mr</span><span class="op" id="3667824">.</span><span class="ident" id="3667825">bufReader</span><span class="op" id="3667834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3667837">header</span><span class="op" id="3667843">,</span>&nbsp;<span class="ident" id="3667845">err</span>&nbsp;<span class="op" id="3667849">:=</span>&nbsp;<span class="ident" id="3667852">r</span><span class="op" id="3667853">.</span><span class="ident" id="3667854">ReadMIMEHeader</span><span class="op" id="3667868">(</span><span class="op" id="3667869">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3667872">if</span>&nbsp;<span class="ident" id="3667875">err</span>&nbsp;<span class="op" id="3667879">==</span>&nbsp;<span class="ident" id="3667882">nil</span>&nbsp;<span class="op" id="3667886">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3667890">bp</span><span class="op" id="3667892">.</span><span class="ident" id="3667893">Header</span>&nbsp;<span class="op" id="3667900">=</span>&nbsp;<span class="ident" id="3667902">header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3667910">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3667913">return</span>&nbsp;<span class="ident" id="3667920">err</span><br>
<span class="lineno"></span><span class="op" id="3667924">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3667927">//&nbsp;Read&nbsp;reads&nbsp;the&nbsp;body&nbsp;of&nbsp;a&nbsp;part,&nbsp;after&nbsp;its&nbsp;headers&nbsp;and&nbsp;before&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3667994">//&nbsp;next&nbsp;part&nbsp;(if&nbsp;any)&nbsp;begins.</span><br>
<span class="lineno">130</span><span class="keyword" id="3668024">func</span>&nbsp;<span class="op" id="3668029">(</span><span class="ident" id="3668030">p</span>&nbsp;<span class="op" id="3668032">*</span><span class="ident" id="3668033">Part</span><span class="op" id="3668037">)</span>&nbsp;<span class="ident" id="3668039">Read</span><span class="op" id="3668043">(</span><span class="ident" id="3668044">d</span>&nbsp;<span class="op" id="3668046">[</span><span class="op" id="3668047">]</span><span class="builtintype" id="3668048">byte</span><span class="op" id="3668052">)</span>&nbsp;<span class="op" id="3668054">(</span><span class="ident" id="3668055">n</span>&nbsp;<span class="builtintype" id="3668057">int</span><span class="op" id="3668060">,</span>&nbsp;<span class="ident" id="3668062">err</span>&nbsp;<span class="builtintype" id="3668066">error</span><span class="op" id="3668071">)</span>&nbsp;<span class="op" id="3668073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3668076">return</span>&nbsp;<span class="ident" id="3668083">p</span><span class="op" id="3668084">.</span><span class="ident" id="3668085">r</span><span class="op" id="3668086">.</span><span class="ident" id="3668087">Read</span><span class="op" id="3668091">(</span><span class="ident" id="3668092">d</span><span class="op" id="3668093">)</span><br>
<span class="lineno"></span><span class="op" id="3668095">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3668098">//&nbsp;partReader&nbsp;implements&nbsp;io.Reader&nbsp;by&nbsp;reading&nbsp;raw&nbsp;bytes&nbsp;directly&nbsp;from&nbsp;the</span><br>
<span class="lineno">135</span><span class="comment" id="3668172">//&nbsp;wrapped&nbsp;*Part,&nbsp;without&nbsp;doing&nbsp;any&nbsp;Transfer-Encoding&nbsp;decoding.</span><br>
<span class="lineno"></span><span class="keyword" id="3668236">type</span>&nbsp;<span class="ident" id="3668241">partReader</span>&nbsp;<span class="keyword" id="3668252">struct</span>&nbsp;<span class="op" id="3668259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3668262">p</span>&nbsp;<span class="op" id="3668264">*</span><span class="ident" id="3668265">Part</span><br>
<span class="lineno"></span><span class="op" id="3668270">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="keyword" id="3668273">func</span>&nbsp;<span class="op" id="3668278">(</span><span class="ident" id="3668279">pr</span>&nbsp;<span class="ident" id="3668282">partReader</span><span class="op" id="3668292">)</span>&nbsp;<span class="ident" id="3668294">Read</span><span class="op" id="3668298">(</span><span class="ident" id="3668299">d</span>&nbsp;<span class="op" id="3668301">[</span><span class="op" id="3668302">]</span><span class="builtintype" id="3668303">byte</span><span class="op" id="3668307">)</span>&nbsp;<span class="op" id="3668309">(</span><span class="ident" id="3668310">n</span>&nbsp;<span class="builtintype" id="3668312">int</span><span class="op" id="3668315">,</span>&nbsp;<span class="ident" id="3668317">err</span>&nbsp;<span class="builtintype" id="3668321">error</span><span class="op" id="3668326">)</span>&nbsp;<span class="op" id="3668328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3668331">p</span>&nbsp;<span class="op" id="3668333">:=</span>&nbsp;<span class="ident" id="3668336">pr</span><span class="op" id="3668338">.</span><span class="ident" id="3668339">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3668342">defer</span>&nbsp;<span class="keyword" id="3668348">func</span><span class="op" id="3668352">(</span><span class="op" id="3668353">)</span>&nbsp;<span class="op" id="3668355">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3668359">p</span><span class="op" id="3668360">.</span><span class="ident" id="3668361">bytesRead</span>&nbsp;<span class="op" id="3668371">+=</span>&nbsp;<span class="ident" id="3668374">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3668377">}</span><span class="op" id="3668378">(</span><span class="op" id="3668379">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3668382">if</span>&nbsp;<span class="ident" id="3668385">p</span><span class="op" id="3668386">.</span><span class="ident" id="3668387">buffer</span><span class="op" id="3668393">.</span><span class="ident" id="3668394">Len</span><span class="op" id="3668397">(</span><span class="op" id="3668398">)</span>&nbsp;<span class="op" id="3668400">&gt;=</span>&nbsp;<span class="builtinfunc" id="3668403">len</span><span class="op" id="3668406">(</span><span class="ident" id="3668407">d</span><span class="op" id="3668408">)</span>&nbsp;<span class="op" id="3668410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3668414">//&nbsp;Internal&nbsp;buffer&nbsp;of&nbsp;unconsumed&nbsp;data&nbsp;is&nbsp;large&nbsp;enough&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3668474">//&nbsp;the&nbsp;read&nbsp;request.&nbsp;&nbsp;No&nbsp;need&nbsp;to&nbsp;parse&nbsp;more&nbsp;at&nbsp;the&nbsp;moment.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3668535">return</span>&nbsp;<span class="ident" id="3668542">p</span><span class="op" id="3668543">.</span><span class="ident" id="3668544">buffer</span><span class="op" id="3668550">.</span><span class="ident" id="3668551">Read</span><span class="op" id="3668555">(</span><span class="ident" id="3668556">d</span><span class="op" id="3668557">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3668560">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3668563">peek</span><span class="op" id="3668567">,</span>&nbsp;<span class="ident" id="3668569">err</span>&nbsp;<span class="op" id="3668573">:=</span>&nbsp;<span class="ident" id="3668576">p</span><span class="op" id="3668577">.</span><span class="ident" id="3668578">mr</span><span class="op" id="3668580">.</span><span class="ident" id="3668581">bufReader</span><span class="op" id="3668590">.</span><span class="ident" id="3668591">Peek</span><span class="op" id="3668595">(</span><span class="num" id="3668596">4096</span><span class="op" id="3668600">)</span>&nbsp;<span class="comment" id="3668602">//&nbsp;TODO(bradfitz):&nbsp;add&nbsp;buffer&nbsp;size&nbsp;accessor</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3668648">//&nbsp;Look&nbsp;for&nbsp;an&nbsp;immediate&nbsp;empty&nbsp;part&nbsp;without&nbsp;a&nbsp;leading&nbsp;\r\n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3668708">//&nbsp;before&nbsp;the&nbsp;boundary&nbsp;separator.&nbsp;&nbsp;Some&nbsp;MIME&nbsp;code&nbsp;makes&nbsp;empty</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3668771">//&nbsp;parts&nbsp;like&nbsp;this.&nbsp;Most&nbsp;browsers,&nbsp;however,&nbsp;write&nbsp;the&nbsp;\r\n</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3668831">//&nbsp;before&nbsp;the&nbsp;subsequent&nbsp;boundary&nbsp;even&nbsp;for&nbsp;empty&nbsp;parts&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3668891">//&nbsp;won&#39;t&nbsp;hit&nbsp;this&nbsp;path.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3668916">if</span>&nbsp;<span class="ident" id="3668919">p</span><span class="op" id="3668920">.</span><span class="ident" id="3668921">bytesRead</span>&nbsp;<span class="op" id="3668931">==</span>&nbsp;<span class="num" id="3668934">0</span>&nbsp;<span class="op" id="3668936">&amp;&amp;</span>&nbsp;<span class="ident" id="3668939">p</span><span class="op" id="3668940">.</span><span class="ident" id="3668941">mr</span><span class="op" id="3668943">.</span><span class="ident" id="3668944">peekBufferIsEmptyPart</span><span class="op" id="3668965">(</span><span class="ident" id="3668966">peek</span><span class="op" id="3668970">)</span>&nbsp;<span class="op" id="3668972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3668976">return</span>&nbsp;<span class="num" id="3668983">0</span><span class="op" id="3668984">,</span>&nbsp;<span class="ident" id="3668986">io</span><span class="op" id="3668988">.</span><span class="ident" id="3668989">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3668994">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3668997">unexpectedEOF</span>&nbsp;<span class="op" id="3669011">:=</span>&nbsp;<span class="ident" id="3669014">err</span>&nbsp;<span class="op" id="3669018">==</span>&nbsp;<span class="ident" id="3669021">io</span><span class="op" id="3669023">.</span><span class="ident" id="3669024">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3669029">if</span>&nbsp;<span class="ident" id="3669032">err</span>&nbsp;<span class="op" id="3669036">!=</span>&nbsp;<span class="ident" id="3669039">nil</span>&nbsp;<span class="op" id="3669043">&amp;&amp;</span>&nbsp;<span class="op" id="3669046">!</span><span class="ident" id="3669047">unexpectedEOF</span>&nbsp;<span class="op" id="3669061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3669065">return</span>&nbsp;<span class="num" id="3669072">0</span><span class="op" id="3669073">,</span>&nbsp;<span class="ident" id="3669075">fmt</span><span class="op" id="3669078">.</span><span class="ident" id="3669079">Errorf</span><span class="op" id="3669085">(</span><span class="string" id="3669086">&#34;multipart:&nbsp;Part&nbsp;Read:&nbsp;%v&#34;</span><span class="op" id="3669112">,</span>&nbsp;<span class="ident" id="3669114">err</span><span class="op" id="3669117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3669120">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3669123">if</span>&nbsp;<span class="ident" id="3669126">peek</span>&nbsp;<span class="op" id="3669131">==</span>&nbsp;<span class="ident" id="3669134">nil</span>&nbsp;<span class="op" id="3669138">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3669142">panic</span><span class="op" id="3669147">(</span><span class="string" id="3669148">&#34;nil&nbsp;peek&nbsp;buf&#34;</span><span class="op" id="3669162">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3669165">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3669169">//&nbsp;Search&nbsp;the&nbsp;peek&nbsp;buffer&nbsp;for&nbsp;&#34;\r\n--boundary&#34;.&nbsp;If&nbsp;found,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3669228">//&nbsp;consume&nbsp;everything&nbsp;up&nbsp;to&nbsp;the&nbsp;boundary.&nbsp;If&nbsp;not,&nbsp;consume&nbsp;only</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3669292">//&nbsp;as&nbsp;much&nbsp;of&nbsp;the&nbsp;peek&nbsp;buffer&nbsp;as&nbsp;cannot&nbsp;hold&nbsp;the&nbsp;boundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3669351">//&nbsp;string.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3669363">nCopy</span>&nbsp;<span class="op" id="3669369">:=</span>&nbsp;<span class="num" id="3669372">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3669375">foundBoundary</span>&nbsp;<span class="op" id="3669389">:=</span>&nbsp;<span class="builtintype" id="3669392">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3669399">if</span>&nbsp;<span class="ident" id="3669402">idx</span>&nbsp;<span class="op" id="3669406">:=</span>&nbsp;<span class="ident" id="3669409">bytes</span><span class="op" id="3669414">.</span><span class="ident" id="3669415">Index</span><span class="op" id="3669420">(</span><span class="ident" id="3669421">peek</span><span class="op" id="3669425">,</span>&nbsp;<span class="ident" id="3669427">p</span><span class="op" id="3669428">.</span><span class="ident" id="3669429">mr</span><span class="op" id="3669431">.</span><span class="ident" id="3669432">nlDashBoundary</span><span class="op" id="3669446">)</span><span class="op" id="3669447">;</span>&nbsp;<span class="ident" id="3669449">idx</span>&nbsp;<span class="op" id="3669453">!=</span>&nbsp;<span class="op" id="3669456">-</span><span class="num" id="3669457">1</span>&nbsp;<span class="op" id="3669459">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3669463">nCopy</span>&nbsp;<span class="op" id="3669469">=</span>&nbsp;<span class="ident" id="3669471">idx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3669477">foundBoundary</span>&nbsp;<span class="op" id="3669491">=</span>&nbsp;<span class="builtintype" id="3669493">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3669499">}</span>&nbsp;<span class="keyword" id="3669501">else</span>&nbsp;<span class="keyword" id="3669506">if</span>&nbsp;<span class="ident" id="3669509">safeCount</span>&nbsp;<span class="op" id="3669519">:=</span>&nbsp;<span class="builtinfunc" id="3669522">len</span><span class="op" id="3669525">(</span><span class="ident" id="3669526">peek</span><span class="op" id="3669530">)</span>&nbsp;<span class="op" id="3669532">-</span>&nbsp;<span class="builtinfunc" id="3669534">len</span><span class="op" id="3669537">(</span><span class="ident" id="3669538">p</span><span class="op" id="3669539">.</span><span class="ident" id="3669540">mr</span><span class="op" id="3669542">.</span><span class="ident" id="3669543">nlDashBoundary</span><span class="op" id="3669557">)</span><span class="op" id="3669558">;</span>&nbsp;<span class="ident" id="3669560">safeCount</span>&nbsp;<span class="op" id="3669570">&gt;</span>&nbsp;<span class="num" id="3669572">0</span>&nbsp;<span class="op" id="3669574">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3669578">nCopy</span>&nbsp;<span class="op" id="3669584">=</span>&nbsp;<span class="ident" id="3669586">safeCount</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3669597">}</span>&nbsp;<span class="keyword" id="3669599">else</span>&nbsp;<span class="keyword" id="3669604">if</span>&nbsp;<span class="ident" id="3669607">unexpectedEOF</span>&nbsp;<span class="op" id="3669621">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3669625">//&nbsp;If&nbsp;we&#39;ve&nbsp;run&nbsp;out&nbsp;of&nbsp;peek&nbsp;buffer&nbsp;and&nbsp;the&nbsp;boundary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3669679">//&nbsp;wasn&#39;t&nbsp;found&nbsp;(and&nbsp;can&#39;t&nbsp;possibly&nbsp;fit),&nbsp;we&nbsp;must&nbsp;have</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3669736">//&nbsp;hit&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;file&nbsp;unexpectedly.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3669779">return</span>&nbsp;<span class="num" id="3669786">0</span><span class="op" id="3669787">,</span>&nbsp;<span class="ident" id="3669789">io</span><span class="op" id="3669791">.</span><span class="ident" id="3669792">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3669810">}</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3669813">if</span>&nbsp;<span class="ident" id="3669816">nCopy</span>&nbsp;<span class="op" id="3669822">&gt;</span>&nbsp;<span class="num" id="3669824">0</span>&nbsp;<span class="op" id="3669826">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3669830">if</span>&nbsp;<span class="ident" id="3669833">_</span><span class="op" id="3669834">,</span>&nbsp;<span class="ident" id="3669836">err</span>&nbsp;<span class="op" id="3669840">:=</span>&nbsp;<span class="ident" id="3669843">io</span><span class="op" id="3669845">.</span><span class="ident" id="3669846">CopyN</span><span class="op" id="3669851">(</span><span class="ident" id="3669852">p</span><span class="op" id="3669853">.</span><span class="ident" id="3669854">buffer</span><span class="op" id="3669860">,</span>&nbsp;<span class="ident" id="3669862">p</span><span class="op" id="3669863">.</span><span class="ident" id="3669864">mr</span><span class="op" id="3669866">.</span><span class="ident" id="3669867">bufReader</span><span class="op" id="3669876">,</span>&nbsp;<span class="ident" id="3669878">int64</span><span class="op" id="3669883">(</span><span class="ident" id="3669884">nCopy</span><span class="op" id="3669889">)</span><span class="op" id="3669890">)</span><span class="op" id="3669891">;</span>&nbsp;<span class="ident" id="3669893">err</span>&nbsp;<span class="op" id="3669897">!=</span>&nbsp;<span class="ident" id="3669900">nil</span>&nbsp;<span class="op" id="3669904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3669909">return</span>&nbsp;<span class="num" id="3669916">0</span><span class="op" id="3669917">,</span>&nbsp;<span class="ident" id="3669919">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3669925">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3669928">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3669931">n</span><span class="op" id="3669932">,</span>&nbsp;<span class="ident" id="3669934">err</span>&nbsp;<span class="op" id="3669938">=</span>&nbsp;<span class="ident" id="3669940">p</span><span class="op" id="3669941">.</span><span class="ident" id="3669942">buffer</span><span class="op" id="3669948">.</span><span class="ident" id="3669949">Read</span><span class="op" id="3669953">(</span><span class="ident" id="3669954">d</span><span class="op" id="3669955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3669958">if</span>&nbsp;<span class="ident" id="3669961">err</span>&nbsp;<span class="op" id="3669965">==</span>&nbsp;<span class="ident" id="3669968">io</span><span class="op" id="3669970">.</span><span class="ident" id="3669971">EOF</span>&nbsp;<span class="op" id="3669975">&amp;&amp;</span>&nbsp;<span class="op" id="3669978">!</span><span class="ident" id="3669979">foundBoundary</span>&nbsp;<span class="op" id="3669993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3669997">//&nbsp;If&nbsp;the&nbsp;boundary&nbsp;hasn&#39;t&nbsp;been&nbsp;reached&nbsp;there&#39;s&nbsp;more&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3670054">//&nbsp;read,&nbsp;so&nbsp;don&#39;t&nbsp;pass&nbsp;through&nbsp;an&nbsp;EOF&nbsp;from&nbsp;the&nbsp;buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3670110">err</span>&nbsp;<span class="op" id="3670114">=</span>&nbsp;<span class="ident" id="3670116">nil</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3670121">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3670124">return</span><br>
<span class="lineno"></span><span class="op" id="3670131">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3670134">func</span>&nbsp;<span class="op" id="3670139">(</span><span class="ident" id="3670140">p</span>&nbsp;<span class="op" id="3670142">*</span><span class="ident" id="3670143">Part</span><span class="op" id="3670147">)</span>&nbsp;<span class="ident" id="3670149">Close</span><span class="op" id="3670154">(</span><span class="op" id="3670155">)</span>&nbsp;<span class="builtintype" id="3670157">error</span>&nbsp;<span class="op" id="3670163">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3670166">io</span><span class="op" id="3670168">.</span><span class="ident" id="3670169">Copy</span><span class="op" id="3670173">(</span><span class="ident" id="3670174">ioutil</span><span class="op" id="3670180">.</span><span class="ident" id="3670181">Discard</span><span class="op" id="3670188">,</span>&nbsp;<span class="ident" id="3670190">p</span><span class="op" id="3670191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3670194">return</span>&nbsp;<span class="ident" id="3670201">nil</span><br>
<span class="lineno"></span><span class="op" id="3670205">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3670208">//&nbsp;Reader&nbsp;is&nbsp;an&nbsp;iterator&nbsp;over&nbsp;parts&nbsp;in&nbsp;a&nbsp;MIME&nbsp;multipart&nbsp;body.</span><br>
<span class="lineno">205</span><span class="comment" id="3670270">//&nbsp;Reader&#39;s&nbsp;underlying&nbsp;parser&nbsp;consumes&nbsp;its&nbsp;input&nbsp;as&nbsp;needed.&nbsp;&nbsp;Seeking</span><br>
<span class="lineno"></span><span class="comment" id="3670339">//&nbsp;isn&#39;t&nbsp;supported.</span><br>
<span class="lineno"></span><span class="keyword" id="3670359">type</span>&nbsp;<span class="ident" id="3670364">Reader</span>&nbsp;<span class="keyword" id="3670371">struct</span>&nbsp;<span class="op" id="3670378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3670381">bufReader</span>&nbsp;<span class="op" id="3670391">*</span><span class="ident" id="3670392">bufio</span><span class="op" id="3670397">.</span><span class="ident" id="3670398">Reader</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3670407">currentPart</span>&nbsp;<span class="op" id="3670419">*</span><span class="ident" id="3670420">Part</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3670426">partsRead</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3670438">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3670444">nl</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3670461">[</span><span class="op" id="3670462">]</span><span class="builtintype" id="3670463">byte</span>&nbsp;<span class="comment" id="3670468">//&nbsp;&#34;\r\n&#34;&nbsp;or&nbsp;&#34;\n&#34;&nbsp;(set&nbsp;after&nbsp;seeing&nbsp;first&nbsp;boundary&nbsp;line)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3670526">nlDashBoundary</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3670543">[</span><span class="op" id="3670544">]</span><span class="builtintype" id="3670545">byte</span>&nbsp;<span class="comment" id="3670550">//&nbsp;nl&nbsp;+&nbsp;&#34;--boundary&#34;</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3670572">dashBoundaryDash</span>&nbsp;<span class="op" id="3670589">[</span><span class="op" id="3670590">]</span><span class="builtintype" id="3670591">byte</span>&nbsp;<span class="comment" id="3670596">//&nbsp;&#34;--boundary--&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3670615">dashBoundary</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3670632">[</span><span class="op" id="3670633">]</span><span class="builtintype" id="3670634">byte</span>&nbsp;<span class="comment" id="3670639">//&nbsp;&#34;--boundary&#34;</span><br>
<span class="lineno"></span><span class="op" id="3670655">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3670658">//&nbsp;NextPart&nbsp;returns&nbsp;the&nbsp;next&nbsp;part&nbsp;in&nbsp;the&nbsp;multipart&nbsp;or&nbsp;an&nbsp;error.</span><br>
<span class="lineno">220</span><span class="comment" id="3670722">//&nbsp;When&nbsp;there&nbsp;are&nbsp;no&nbsp;more&nbsp;parts,&nbsp;the&nbsp;error&nbsp;io.EOF&nbsp;is&nbsp;returned.</span><br>
<span class="lineno"></span><span class="keyword" id="3670785">func</span>&nbsp;<span class="op" id="3670790">(</span><span class="ident" id="3670791">r</span>&nbsp;<span class="op" id="3670793">*</span><span class="ident" id="3670794">Reader</span><span class="op" id="3670800">)</span>&nbsp;<span class="ident" id="3670802">NextPart</span><span class="op" id="3670810">(</span><span class="op" id="3670811">)</span>&nbsp;<span class="op" id="3670813">(</span><span class="op" id="3670814">*</span><span class="ident" id="3670815">Part</span><span class="op" id="3670819">,</span>&nbsp;<span class="builtintype" id="3670821">error</span><span class="op" id="3670826">)</span>&nbsp;<span class="op" id="3670828">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3670831">if</span>&nbsp;<span class="ident" id="3670834">r</span><span class="op" id="3670835">.</span><span class="ident" id="3670836">currentPart</span>&nbsp;<span class="op" id="3670848">!=</span>&nbsp;<span class="ident" id="3670851">nil</span>&nbsp;<span class="op" id="3670855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3670859">r</span><span class="op" id="3670860">.</span><span class="ident" id="3670861">currentPart</span><span class="op" id="3670872">.</span><span class="ident" id="3670873">Close</span><span class="op" id="3670878">(</span><span class="op" id="3670879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3670882">}</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3670886">expectNewPart</span>&nbsp;<span class="op" id="3670900">:=</span>&nbsp;<span class="builtintype" id="3670903">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3670910">for</span>&nbsp;<span class="op" id="3670914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3670918">line</span><span class="op" id="3670922">,</span>&nbsp;<span class="ident" id="3670924">err</span>&nbsp;<span class="op" id="3670928">:=</span>&nbsp;<span class="ident" id="3670931">r</span><span class="op" id="3670932">.</span><span class="ident" id="3670933">bufReader</span><span class="op" id="3670942">.</span><span class="ident" id="3670943">ReadSlice</span><span class="op" id="3670952">(</span><span class="string" id="3670953">&#39;\n&#39;</span><span class="op" id="3670957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3670961">if</span>&nbsp;<span class="ident" id="3670964">err</span>&nbsp;<span class="op" id="3670968">==</span>&nbsp;<span class="ident" id="3670971">io</span><span class="op" id="3670973">.</span><span class="ident" id="3670974">EOF</span>&nbsp;<span class="op" id="3670978">&amp;&amp;</span>&nbsp;<span class="ident" id="3670981">r</span><span class="op" id="3670982">.</span><span class="ident" id="3670983">isFinalBoundary</span><span class="op" id="3670998">(</span><span class="ident" id="3670999">line</span><span class="op" id="3671003">)</span>&nbsp;<span class="op" id="3671005">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3671010">//&nbsp;If&nbsp;the&nbsp;buffer&nbsp;ends&nbsp;in&nbsp;&#34;--boundary--&#34;&nbsp;without&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3671065">//&nbsp;trailing&nbsp;&#34;\r\n&#34;,&nbsp;ReadSlice&nbsp;will&nbsp;return&nbsp;an&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3671119">//&nbsp;(since&nbsp;it&#39;s&nbsp;missing&nbsp;the&nbsp;&#39;\n&#39;),&nbsp;but&nbsp;this&nbsp;is&nbsp;a&nbsp;valid</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3671176">//&nbsp;multipart&nbsp;EOF&nbsp;so&nbsp;we&nbsp;need&nbsp;to&nbsp;return&nbsp;io.EOF&nbsp;instead&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3671235">//&nbsp;a&nbsp;fmt-wrapped&nbsp;one.</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3671260">return</span>&nbsp;<span class="ident" id="3671267">nil</span><span class="op" id="3671270">,</span>&nbsp;<span class="ident" id="3671272">io</span><span class="op" id="3671274">.</span><span class="ident" id="3671275">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3671281">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3671285">if</span>&nbsp;<span class="ident" id="3671288">err</span>&nbsp;<span class="op" id="3671292">!=</span>&nbsp;<span class="ident" id="3671295">nil</span>&nbsp;<span class="op" id="3671299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3671304">return</span>&nbsp;<span class="ident" id="3671311">nil</span><span class="op" id="3671314">,</span>&nbsp;<span class="ident" id="3671316">fmt</span><span class="op" id="3671319">.</span><span class="ident" id="3671320">Errorf</span><span class="op" id="3671326">(</span><span class="string" id="3671327">&#34;multipart:&nbsp;NextPart:&nbsp;%v&#34;</span><span class="op" id="3671352">,</span>&nbsp;<span class="ident" id="3671354">err</span><span class="op" id="3671357">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3671361">}</span><br>
<span class="lineno">240</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3671366">if</span>&nbsp;<span class="ident" id="3671369">r</span><span class="op" id="3671370">.</span><span class="ident" id="3671371">isBoundaryDelimiterLine</span><span class="op" id="3671394">(</span><span class="ident" id="3671395">line</span><span class="op" id="3671399">)</span>&nbsp;<span class="op" id="3671401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3671406">r</span><span class="op" id="3671407">.</span><span class="ident" id="3671408">partsRead</span><span class="op" id="3671417">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3671423">bp</span><span class="op" id="3671425">,</span>&nbsp;<span class="ident" id="3671427">err</span>&nbsp;<span class="op" id="3671431">:=</span>&nbsp;<span class="ident" id="3671434">newPart</span><span class="op" id="3671441">(</span><span class="ident" id="3671442">r</span><span class="op" id="3671443">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3671448">if</span>&nbsp;<span class="ident" id="3671451">err</span>&nbsp;<span class="op" id="3671455">!=</span>&nbsp;<span class="ident" id="3671458">nil</span>&nbsp;<span class="op" id="3671462">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3671468">return</span>&nbsp;<span class="ident" id="3671475">nil</span><span class="op" id="3671478">,</span>&nbsp;<span class="ident" id="3671480">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3671487">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3671492">r</span><span class="op" id="3671493">.</span><span class="ident" id="3671494">currentPart</span>&nbsp;<span class="op" id="3671506">=</span>&nbsp;<span class="ident" id="3671508">bp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3671514">return</span>&nbsp;<span class="ident" id="3671521">bp</span><span class="op" id="3671523">,</span>&nbsp;<span class="ident" id="3671525">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3671531">}</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3671536">if</span>&nbsp;<span class="ident" id="3671539">r</span><span class="op" id="3671540">.</span><span class="ident" id="3671541">isFinalBoundary</span><span class="op" id="3671556">(</span><span class="ident" id="3671557">line</span><span class="op" id="3671561">)</span>&nbsp;<span class="op" id="3671563">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3671568">//&nbsp;Expected&nbsp;EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3671587">return</span>&nbsp;<span class="ident" id="3671594">nil</span><span class="op" id="3671597">,</span>&nbsp;<span class="ident" id="3671599">io</span><span class="op" id="3671601">.</span><span class="ident" id="3671602">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3671608">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3671613">if</span>&nbsp;<span class="ident" id="3671616">expectNewPart</span>&nbsp;<span class="op" id="3671630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3671635">return</span>&nbsp;<span class="ident" id="3671642">nil</span><span class="op" id="3671645">,</span>&nbsp;<span class="ident" id="3671647">fmt</span><span class="op" id="3671650">.</span><span class="ident" id="3671651">Errorf</span><span class="op" id="3671657">(</span><span class="string" id="3671658">&#34;multipart:&nbsp;expecting&nbsp;a&nbsp;new&nbsp;Part;&nbsp;got&nbsp;line&nbsp;%q&#34;</span><span class="op" id="3671704">,</span>&nbsp;<span class="builtintype" id="3671706">string</span><span class="op" id="3671712">(</span><span class="ident" id="3671713">line</span><span class="op" id="3671717">)</span><span class="op" id="3671718">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3671722">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3671727">if</span>&nbsp;<span class="ident" id="3671730">r</span><span class="op" id="3671731">.</span><span class="ident" id="3671732">partsRead</span>&nbsp;<span class="op" id="3671742">==</span>&nbsp;<span class="num" id="3671745">0</span>&nbsp;<span class="op" id="3671747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3671752">//&nbsp;skip&nbsp;line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3671768">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3671779">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3671784">//&nbsp;Consume&nbsp;the&nbsp;&#34;\n&#34;&nbsp;or&nbsp;&#34;\r\n&#34;&nbsp;separator&nbsp;between&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3671838">//&nbsp;body&nbsp;of&nbsp;the&nbsp;previous&nbsp;part&nbsp;and&nbsp;the&nbsp;boundary&nbsp;line&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3671894">//&nbsp;now&nbsp;expect&nbsp;will&nbsp;follow.&nbsp;(either&nbsp;a&nbsp;new&nbsp;part&nbsp;or&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3671949">//&nbsp;end&nbsp;boundary)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3671968">if</span>&nbsp;<span class="ident" id="3671971">bytes</span><span class="op" id="3671976">.</span><span class="ident" id="3671977">Equal</span><span class="op" id="3671982">(</span><span class="ident" id="3671983">line</span><span class="op" id="3671987">,</span>&nbsp;<span class="ident" id="3671989">r</span><span class="op" id="3671990">.</span><span class="ident" id="3671991">nl</span><span class="op" id="3671993">)</span>&nbsp;<span class="op" id="3671995">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3672000">expectNewPart</span>&nbsp;<span class="op" id="3672014">=</span>&nbsp;<span class="builtintype" id="3672016">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3672024">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3672035">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3672040">return</span>&nbsp;<span class="ident" id="3672047">nil</span><span class="op" id="3672050">,</span>&nbsp;<span class="ident" id="3672052">fmt</span><span class="op" id="3672055">.</span><span class="ident" id="3672056">Errorf</span><span class="op" id="3672062">(</span><span class="string" id="3672063">&#34;multipart:&nbsp;unexpected&nbsp;line&nbsp;in&nbsp;Next():&nbsp;%q&#34;</span><span class="op" id="3672105">,</span>&nbsp;<span class="ident" id="3672107">line</span><span class="op" id="3672111">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3672114">}</span><br>
<span class="lineno"></span><span class="op" id="3672116">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3672119">//&nbsp;isFinalBoundary&nbsp;reports&nbsp;whether&nbsp;line&nbsp;is&nbsp;the&nbsp;final&nbsp;boundary&nbsp;line</span><br>
<span class="lineno"></span><span class="comment" id="3672186">//&nbsp;indicating&nbsp;that&nbsp;all&nbsp;parts&nbsp;are&nbsp;over.</span><br>
<span class="lineno">280</span><span class="comment" id="3672225">//&nbsp;It&nbsp;matches&nbsp;`^--boundary--[&nbsp;\t]*(\r\n)?$`</span><br>
<span class="lineno"></span><span class="keyword" id="3672269">func</span>&nbsp;<span class="op" id="3672274">(</span><span class="ident" id="3672275">mr</span>&nbsp;<span class="op" id="3672278">*</span><span class="ident" id="3672279">Reader</span><span class="op" id="3672285">)</span>&nbsp;<span class="ident" id="3672287">isFinalBoundary</span><span class="op" id="3672302">(</span><span class="ident" id="3672303">line</span>&nbsp;<span class="op" id="3672308">[</span><span class="op" id="3672309">]</span><span class="builtintype" id="3672310">byte</span><span class="op" id="3672314">)</span>&nbsp;<span class="builtintype" id="3672316">bool</span>&nbsp;<span class="op" id="3672321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3672324">if</span>&nbsp;<span class="op" id="3672327">!</span><span class="ident" id="3672328">bytes</span><span class="op" id="3672333">.</span><span class="ident" id="3672334">HasPrefix</span><span class="op" id="3672343">(</span><span class="ident" id="3672344">line</span><span class="op" id="3672348">,</span>&nbsp;<span class="ident" id="3672350">mr</span><span class="op" id="3672352">.</span><span class="ident" id="3672353">dashBoundaryDash</span><span class="op" id="3672369">)</span>&nbsp;<span class="op" id="3672371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3672375">return</span>&nbsp;<span class="builtintype" id="3672382">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3672389">}</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3672392">rest</span>&nbsp;<span class="op" id="3672397">:=</span>&nbsp;<span class="ident" id="3672400">line</span><span class="op" id="3672404">[</span><span class="builtinfunc" id="3672405">len</span><span class="op" id="3672408">(</span><span class="ident" id="3672409">mr</span><span class="op" id="3672411">.</span><span class="ident" id="3672412">dashBoundaryDash</span><span class="op" id="3672428">)</span><span class="op" id="3672429">:</span><span class="op" id="3672430">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3672433">rest</span>&nbsp;<span class="op" id="3672438">=</span>&nbsp;<span class="ident" id="3672440">skipLWSPChar</span><span class="op" id="3672452">(</span><span class="ident" id="3672453">rest</span><span class="op" id="3672457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3672460">return</span>&nbsp;<span class="builtinfunc" id="3672467">len</span><span class="op" id="3672470">(</span><span class="ident" id="3672471">rest</span><span class="op" id="3672475">)</span>&nbsp;<span class="op" id="3672477">==</span>&nbsp;<span class="num" id="3672480">0</span>&nbsp;<span class="op" id="3672482">||</span>&nbsp;<span class="ident" id="3672485">bytes</span><span class="op" id="3672490">.</span><span class="ident" id="3672491">Equal</span><span class="op" id="3672496">(</span><span class="ident" id="3672497">rest</span><span class="op" id="3672501">,</span>&nbsp;<span class="ident" id="3672503">mr</span><span class="op" id="3672505">.</span><span class="ident" id="3672506">nl</span><span class="op" id="3672508">)</span><br>
<span class="lineno"></span><span class="op" id="3672510">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">290</span><span class="keyword" id="3672513">func</span>&nbsp;<span class="op" id="3672518">(</span><span class="ident" id="3672519">mr</span>&nbsp;<span class="op" id="3672522">*</span><span class="ident" id="3672523">Reader</span><span class="op" id="3672529">)</span>&nbsp;<span class="ident" id="3672531">isBoundaryDelimiterLine</span><span class="op" id="3672554">(</span><span class="ident" id="3672555">line</span>&nbsp;<span class="op" id="3672560">[</span><span class="op" id="3672561">]</span><span class="builtintype" id="3672562">byte</span><span class="op" id="3672566">)</span>&nbsp;<span class="op" id="3672568">(</span><span class="ident" id="3672569">ret</span>&nbsp;<span class="builtintype" id="3672573">bool</span><span class="op" id="3672577">)</span>&nbsp;<span class="op" id="3672579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3672582">//&nbsp;http://tools.ietf.org/html/rfc2046#section-5.1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3672633">//&nbsp;&nbsp;&nbsp;The&nbsp;boundary&nbsp;delimiter&nbsp;line&nbsp;is&nbsp;then&nbsp;defined&nbsp;as&nbsp;a&nbsp;line</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3672693">//&nbsp;&nbsp;&nbsp;consisting&nbsp;entirely&nbsp;of&nbsp;two&nbsp;hyphen&nbsp;characters&nbsp;(&#34;-&#34;,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3672750">//&nbsp;&nbsp;&nbsp;decimal&nbsp;value&nbsp;45)&nbsp;followed&nbsp;by&nbsp;the&nbsp;boundary&nbsp;parameter</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3672809">//&nbsp;&nbsp;&nbsp;value&nbsp;from&nbsp;the&nbsp;Content-Type&nbsp;header&nbsp;field,&nbsp;optional&nbsp;linear</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3672873">//&nbsp;&nbsp;&nbsp;whitespace,&nbsp;and&nbsp;a&nbsp;terminating&nbsp;CRLF.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3672915">if</span>&nbsp;<span class="op" id="3672918">!</span><span class="ident" id="3672919">bytes</span><span class="op" id="3672924">.</span><span class="ident" id="3672925">HasPrefix</span><span class="op" id="3672934">(</span><span class="ident" id="3672935">line</span><span class="op" id="3672939">,</span>&nbsp;<span class="ident" id="3672941">mr</span><span class="op" id="3672943">.</span><span class="ident" id="3672944">dashBoundary</span><span class="op" id="3672956">)</span>&nbsp;<span class="op" id="3672958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3672962">return</span>&nbsp;<span class="builtintype" id="3672969">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3672976">}</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3672979">rest</span>&nbsp;<span class="op" id="3672984">:=</span>&nbsp;<span class="ident" id="3672987">line</span><span class="op" id="3672991">[</span><span class="builtinfunc" id="3672992">len</span><span class="op" id="3672995">(</span><span class="ident" id="3672996">mr</span><span class="op" id="3672998">.</span><span class="ident" id="3672999">dashBoundary</span><span class="op" id="3673011">)</span><span class="op" id="3673012">:</span><span class="op" id="3673013">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3673016">rest</span>&nbsp;<span class="op" id="3673021">=</span>&nbsp;<span class="ident" id="3673023">skipLWSPChar</span><span class="op" id="3673035">(</span><span class="ident" id="3673036">rest</span><span class="op" id="3673040">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3673044">//&nbsp;On&nbsp;the&nbsp;first&nbsp;part,&nbsp;see&nbsp;our&nbsp;lines&nbsp;are&nbsp;ending&nbsp;in&nbsp;\n&nbsp;instead&nbsp;of&nbsp;\r\n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3673114">//&nbsp;and&nbsp;switch&nbsp;into&nbsp;that&nbsp;mode&nbsp;if&nbsp;so.&nbsp;&nbsp;This&nbsp;is&nbsp;a&nbsp;violation&nbsp;of&nbsp;the&nbsp;spec,</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3673185">//&nbsp;but&nbsp;occurs&nbsp;in&nbsp;practice.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3673213">if</span>&nbsp;<span class="ident" id="3673216">mr</span><span class="op" id="3673218">.</span><span class="ident" id="3673219">partsRead</span>&nbsp;<span class="op" id="3673229">==</span>&nbsp;<span class="num" id="3673232">0</span>&nbsp;<span class="op" id="3673234">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3673237">len</span><span class="op" id="3673240">(</span><span class="ident" id="3673241">rest</span><span class="op" id="3673245">)</span>&nbsp;<span class="op" id="3673247">==</span>&nbsp;<span class="num" id="3673250">1</span>&nbsp;<span class="op" id="3673252">&amp;&amp;</span>&nbsp;<span class="ident" id="3673255">rest</span><span class="op" id="3673259">[</span><span class="num" id="3673260">0</span><span class="op" id="3673261">]</span>&nbsp;<span class="op" id="3673263">==</span>&nbsp;<span class="string" id="3673266">&#39;\n&#39;</span>&nbsp;<span class="op" id="3673271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3673275">mr</span><span class="op" id="3673277">.</span><span class="ident" id="3673278">nl</span>&nbsp;<span class="op" id="3673281">=</span>&nbsp;<span class="ident" id="3673283">mr</span><span class="op" id="3673285">.</span><span class="ident" id="3673286">nl</span><span class="op" id="3673288">[</span><span class="num" id="3673289">1</span><span class="op" id="3673290">:</span><span class="op" id="3673291">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3673295">mr</span><span class="op" id="3673297">.</span><span class="ident" id="3673298">nlDashBoundary</span>&nbsp;<span class="op" id="3673313">=</span>&nbsp;<span class="ident" id="3673315">mr</span><span class="op" id="3673317">.</span><span class="ident" id="3673318">nlDashBoundary</span><span class="op" id="3673332">[</span><span class="num" id="3673333">1</span><span class="op" id="3673334">:</span><span class="op" id="3673335">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3673338">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3673341">return</span>&nbsp;<span class="ident" id="3673348">bytes</span><span class="op" id="3673353">.</span><span class="ident" id="3673354">Equal</span><span class="op" id="3673359">(</span><span class="ident" id="3673360">rest</span><span class="op" id="3673364">,</span>&nbsp;<span class="ident" id="3673366">mr</span><span class="op" id="3673368">.</span><span class="ident" id="3673369">nl</span><span class="op" id="3673371">)</span><br>
<span class="lineno"></span><span class="op" id="3673373">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3673376">//&nbsp;peekBufferIsEmptyPart&nbsp;reports&nbsp;whether&nbsp;the&nbsp;provided&nbsp;peek-ahead</span><br>
<span class="lineno"></span><span class="comment" id="3673441">//&nbsp;buffer&nbsp;represents&nbsp;an&nbsp;empty&nbsp;part.&nbsp;It&nbsp;is&nbsp;called&nbsp;only&nbsp;if&nbsp;we&#39;ve&nbsp;not</span><br>
<span class="lineno">315</span><span class="comment" id="3673508">//&nbsp;already&nbsp;read&nbsp;any&nbsp;bytes&nbsp;in&nbsp;this&nbsp;part&nbsp;and&nbsp;checks&nbsp;for&nbsp;the&nbsp;case&nbsp;of&nbsp;MIME</span><br>
<span class="lineno"></span><span class="comment" id="3673579">//&nbsp;software&nbsp;not&nbsp;writing&nbsp;the&nbsp;\r\n&nbsp;on&nbsp;empty&nbsp;parts.&nbsp;Some&nbsp;does,&nbsp;some</span><br>
<span class="lineno"></span><span class="comment" id="3673644">//&nbsp;doesn&#39;t.</span><br>
<span class="lineno"></span><span class="comment" id="3673656">//</span><br>
<span class="lineno"></span><span class="comment" id="3673659">//&nbsp;This&nbsp;checks&nbsp;that&nbsp;what&nbsp;follows&nbsp;the&nbsp;&#34;--boundary&#34;&nbsp;is&nbsp;actually&nbsp;the&nbsp;end</span><br>
<span class="lineno">320</span><span class="comment" id="3673729">//&nbsp;(&#34;--boundary--&#34;&nbsp;with&nbsp;optional&nbsp;whitespace)&nbsp;or&nbsp;optional&nbsp;whitespace</span><br>
<span class="lineno"></span><span class="comment" id="3673797">//&nbsp;and&nbsp;then&nbsp;a&nbsp;newline,&nbsp;so&nbsp;we&nbsp;don&#39;t&nbsp;catch&nbsp;&#34;--boundaryFAKE&#34;,&nbsp;in&nbsp;which</span><br>
<span class="lineno"></span><span class="comment" id="3673865">//&nbsp;case&nbsp;the&nbsp;whole&nbsp;line&nbsp;is&nbsp;part&nbsp;of&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="3673909">func</span>&nbsp;<span class="op" id="3673914">(</span><span class="ident" id="3673915">mr</span>&nbsp;<span class="op" id="3673918">*</span><span class="ident" id="3673919">Reader</span><span class="op" id="3673925">)</span>&nbsp;<span class="ident" id="3673927">peekBufferIsEmptyPart</span><span class="op" id="3673948">(</span><span class="ident" id="3673949">peek</span>&nbsp;<span class="op" id="3673954">[</span><span class="op" id="3673955">]</span><span class="builtintype" id="3673956">byte</span><span class="op" id="3673960">)</span>&nbsp;<span class="builtintype" id="3673962">bool</span>&nbsp;<span class="op" id="3673967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3673970">//&nbsp;End&nbsp;of&nbsp;parts&nbsp;case.</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3673993">//&nbsp;Test&nbsp;whether&nbsp;peek&nbsp;matches&nbsp;`^--boundary--[&nbsp;\t]*(?:\r\n|$)`</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3674055">if</span>&nbsp;<span class="ident" id="3674058">bytes</span><span class="op" id="3674063">.</span><span class="ident" id="3674064">HasPrefix</span><span class="op" id="3674073">(</span><span class="ident" id="3674074">peek</span><span class="op" id="3674078">,</span>&nbsp;<span class="ident" id="3674080">mr</span><span class="op" id="3674082">.</span><span class="ident" id="3674083">dashBoundaryDash</span><span class="op" id="3674099">)</span>&nbsp;<span class="op" id="3674101">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3674105">rest</span>&nbsp;<span class="op" id="3674110">:=</span>&nbsp;<span class="ident" id="3674113">peek</span><span class="op" id="3674117">[</span><span class="builtinfunc" id="3674118">len</span><span class="op" id="3674121">(</span><span class="ident" id="3674122">mr</span><span class="op" id="3674124">.</span><span class="ident" id="3674125">dashBoundaryDash</span><span class="op" id="3674141">)</span><span class="op" id="3674142">:</span><span class="op" id="3674143">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3674147">rest</span>&nbsp;<span class="op" id="3674152">=</span>&nbsp;<span class="ident" id="3674154">skipLWSPChar</span><span class="op" id="3674166">(</span><span class="ident" id="3674167">rest</span><span class="op" id="3674171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3674175">return</span>&nbsp;<span class="ident" id="3674182">bytes</span><span class="op" id="3674187">.</span><span class="ident" id="3674188">HasPrefix</span><span class="op" id="3674197">(</span><span class="ident" id="3674198">rest</span><span class="op" id="3674202">,</span>&nbsp;<span class="ident" id="3674204">mr</span><span class="op" id="3674206">.</span><span class="ident" id="3674207">nl</span><span class="op" id="3674209">)</span>&nbsp;<span class="op" id="3674211">||</span>&nbsp;<span class="builtinfunc" id="3674214">len</span><span class="op" id="3674217">(</span><span class="ident" id="3674218">rest</span><span class="op" id="3674222">)</span>&nbsp;<span class="op" id="3674224">==</span>&nbsp;<span class="num" id="3674227">0</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3674230">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3674233">if</span>&nbsp;<span class="op" id="3674236">!</span><span class="ident" id="3674237">bytes</span><span class="op" id="3674242">.</span><span class="ident" id="3674243">HasPrefix</span><span class="op" id="3674252">(</span><span class="ident" id="3674253">peek</span><span class="op" id="3674257">,</span>&nbsp;<span class="ident" id="3674259">mr</span><span class="op" id="3674261">.</span><span class="ident" id="3674262">dashBoundary</span><span class="op" id="3674274">)</span>&nbsp;<span class="op" id="3674276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3674280">return</span>&nbsp;<span class="builtintype" id="3674287">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3674294">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3674297">//&nbsp;Test&nbsp;whether&nbsp;rest&nbsp;matches&nbsp;`^[&nbsp;\t]*\r\n`)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3674342">rest</span>&nbsp;<span class="op" id="3674347">:=</span>&nbsp;<span class="ident" id="3674350">peek</span><span class="op" id="3674354">[</span><span class="builtinfunc" id="3674355">len</span><span class="op" id="3674358">(</span><span class="ident" id="3674359">mr</span><span class="op" id="3674361">.</span><span class="ident" id="3674362">dashBoundary</span><span class="op" id="3674374">)</span><span class="op" id="3674375">:</span><span class="op" id="3674376">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3674379">rest</span>&nbsp;<span class="op" id="3674384">=</span>&nbsp;<span class="ident" id="3674386">skipLWSPChar</span><span class="op" id="3674398">(</span><span class="ident" id="3674399">rest</span><span class="op" id="3674403">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3674406">return</span>&nbsp;<span class="ident" id="3674413">bytes</span><span class="op" id="3674418">.</span><span class="ident" id="3674419">HasPrefix</span><span class="op" id="3674428">(</span><span class="ident" id="3674429">rest</span><span class="op" id="3674433">,</span>&nbsp;<span class="ident" id="3674435">mr</span><span class="op" id="3674437">.</span><span class="ident" id="3674438">nl</span><span class="op" id="3674440">)</span><br>
<span class="lineno"></span><span class="op" id="3674442">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">340</span><span class="comment" id="3674445">//&nbsp;skipLWSPChar&nbsp;returns&nbsp;b&nbsp;with&nbsp;leading&nbsp;spaces&nbsp;and&nbsp;tabs&nbsp;removed.</span><br>
<span class="lineno"></span><span class="comment" id="3674509">//&nbsp;RFC&nbsp;822&nbsp;defines:</span><br>
<span class="lineno"></span><span class="comment" id="3674529">//&nbsp;&nbsp;&nbsp;&nbsp;LWSP-char&nbsp;=&nbsp;SPACE&nbsp;/&nbsp;HTAB</span><br>
<span class="lineno"></span><span class="keyword" id="3674560">func</span>&nbsp;<span class="ident" id="3674565">skipLWSPChar</span><span class="op" id="3674577">(</span><span class="ident" id="3674578">b</span>&nbsp;<span class="op" id="3674580">[</span><span class="op" id="3674581">]</span><span class="builtintype" id="3674582">byte</span><span class="op" id="3674586">)</span>&nbsp;<span class="op" id="3674588">[</span><span class="op" id="3674589">]</span><span class="builtintype" id="3674590">byte</span>&nbsp;<span class="op" id="3674595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3674598">for</span>&nbsp;<span class="builtinfunc" id="3674602">len</span><span class="op" id="3674605">(</span><span class="ident" id="3674606">b</span><span class="op" id="3674607">)</span>&nbsp;<span class="op" id="3674609">&gt;</span>&nbsp;<span class="num" id="3674611">0</span>&nbsp;<span class="op" id="3674613">&amp;&amp;</span>&nbsp;<span class="op" id="3674616">(</span><span class="ident" id="3674617">b</span><span class="op" id="3674618">[</span><span class="num" id="3674619">0</span><span class="op" id="3674620">]</span>&nbsp;<span class="op" id="3674622">==</span>&nbsp;<span class="string" id="3674625">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="3674629">||</span>&nbsp;<span class="ident" id="3674632">b</span><span class="op" id="3674633">[</span><span class="num" id="3674634">0</span><span class="op" id="3674635">]</span>&nbsp;<span class="op" id="3674637">==</span>&nbsp;<span class="string" id="3674640">&#39;\t&#39;</span><span class="op" id="3674644">)</span>&nbsp;<span class="op" id="3674646">{</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3674650">b</span>&nbsp;<span class="op" id="3674652">=</span>&nbsp;<span class="ident" id="3674654">b</span><span class="op" id="3674655">[</span><span class="num" id="3674656">1</span><span class="op" id="3674657">:</span><span class="op" id="3674658">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3674661">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3674664">return</span>&nbsp;<span class="ident" id="3674671">b</span><br>
<span class="lineno"></span><span class="op" id="3674673">}</span>
</div>
</body>
</html>
