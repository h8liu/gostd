<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>image/gif</h2>
<ul>
<li><a href="/gostd/image/gif/reader.go.html">reader.go</a></li>
<li><a href="/gostd/image/gif/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/image/gif/writer.go.html">writer.go</a></li>
<li><a href="/gostd/image/gif/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5617914">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5617969">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5618023">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="5618074">package</span>&nbsp;<span class="ident" id="5618082">gif</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5618087">import</span>&nbsp;<span class="op" id="5618094">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5618097">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5618106">&#34;compress/lzw&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5618122">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5618132">&#34;image&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5618141">&#34;image/color&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5618156">&#34;image/color/palette&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5618179">&#34;image/draw&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5618193">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="5618198">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5618201">//&nbsp;Graphic&nbsp;control&nbsp;extension&nbsp;fields.</span><br>
<span class="lineno"></span><span class="keyword" id="5618238">const</span>&nbsp;<span class="op" id="5618244">(</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5618247">gcLabel</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5618259">=</span>&nbsp;<span class="num" id="5618261">0xF9</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5618267">gcBlockSize</span>&nbsp;<span class="op" id="5618279">=</span>&nbsp;<span class="num" id="5618281">0x04</span><br>
<span class="lineno"></span><span class="op" id="5618286">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5618289">var</span>&nbsp;<span class="ident" id="5618293">log2Lookup</span>&nbsp;<span class="op" id="5618304">=</span>&nbsp;<span class="op" id="5618306">[</span><span class="num" id="5618307">8</span><span class="op" id="5618308">]</span><span class="builtintype" id="5618309">int</span><span class="op" id="5618312">{</span><span class="num" id="5618313">2</span><span class="op" id="5618314">,</span>&nbsp;<span class="num" id="5618316">4</span><span class="op" id="5618317">,</span>&nbsp;<span class="num" id="5618319">8</span><span class="op" id="5618320">,</span>&nbsp;<span class="num" id="5618322">16</span><span class="op" id="5618324">,</span>&nbsp;<span class="num" id="5618326">32</span><span class="op" id="5618328">,</span>&nbsp;<span class="num" id="5618330">64</span><span class="op" id="5618332">,</span>&nbsp;<span class="num" id="5618334">128</span><span class="op" id="5618337">,</span>&nbsp;<span class="num" id="5618339">256</span><span class="op" id="5618342">}</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="5618345">func</span>&nbsp;<span class="ident" id="5618350">log2</span><span class="op" id="5618354">(</span><span class="ident" id="5618355">x</span>&nbsp;<span class="builtintype" id="5618357">int</span><span class="op" id="5618360">)</span>&nbsp;<span class="builtintype" id="5618362">int</span>&nbsp;<span class="op" id="5618366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5618369">for</span>&nbsp;<span class="ident" id="5618373">i</span><span class="op" id="5618374">,</span>&nbsp;<span class="ident" id="5618376">v</span>&nbsp;<span class="op" id="5618378">:=</span>&nbsp;<span class="keyword" id="5618381">range</span>&nbsp;<span class="ident" id="5618387">log2Lookup</span>&nbsp;<span class="op" id="5618398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5618402">if</span>&nbsp;<span class="ident" id="5618405">x</span>&nbsp;<span class="op" id="5618407">&lt;=</span>&nbsp;<span class="ident" id="5618410">v</span>&nbsp;<span class="op" id="5618412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5618417">return</span>&nbsp;<span class="ident" id="5618424">i</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5618428">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5618431">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5618434">return</span>&nbsp;<span class="op" id="5618441">-</span><span class="num" id="5618442">1</span><br>
<span class="lineno"></span><span class="op" id="5618444">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="comment" id="5618447">//&nbsp;Little-endian.</span><br>
<span class="lineno"></span><span class="keyword" id="5618465">func</span>&nbsp;<span class="ident" id="5618470">writeUint16</span><span class="op" id="5618481">(</span><span class="ident" id="5618482">b</span>&nbsp;<span class="op" id="5618484">[</span><span class="op" id="5618485">]</span><span class="builtintype" id="5618486">uint8</span><span class="op" id="5618491">,</span>&nbsp;<span class="ident" id="5618493">u</span>&nbsp;<span class="builtintype" id="5618495">uint16</span><span class="op" id="5618501">)</span>&nbsp;<span class="op" id="5618503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5618506">b</span><span class="op" id="5618507">[</span><span class="num" id="5618508">0</span><span class="op" id="5618509">]</span>&nbsp;<span class="op" id="5618511">=</span>&nbsp;<span class="builtintype" id="5618513">uint8</span><span class="op" id="5618518">(</span><span class="ident" id="5618519">u</span><span class="op" id="5618520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5618523">b</span><span class="op" id="5618524">[</span><span class="num" id="5618525">1</span><span class="op" id="5618526">]</span>&nbsp;<span class="op" id="5618528">=</span>&nbsp;<span class="builtintype" id="5618530">uint8</span><span class="op" id="5618535">(</span><span class="ident" id="5618536">u</span>&nbsp;<span class="op" id="5618538">&gt;&gt;</span>&nbsp;<span class="num" id="5618541">8</span><span class="op" id="5618542">)</span><br>
<span class="lineno"></span><span class="op" id="5618544">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="comment" id="5618547">//&nbsp;writer&nbsp;is&nbsp;a&nbsp;buffered&nbsp;writer.</span><br>
<span class="lineno"></span><span class="keyword" id="5618579">type</span>&nbsp;<span class="ident" id="5618584">writer</span>&nbsp;<span class="keyword" id="5618591">interface</span>&nbsp;<span class="op" id="5618601">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5618604">Flush</span><span class="op" id="5618609">(</span><span class="op" id="5618610">)</span>&nbsp;<span class="builtintype" id="5618612">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5618619">io</span><span class="op" id="5618621">.</span><span class="ident" id="5618622">Writer</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5618630">io</span><span class="op" id="5618632">.</span><span class="ident" id="5618633">ByteWriter</span><br>
<span class="lineno"></span><span class="op" id="5618644">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5618647">//&nbsp;encoder&nbsp;encodes&nbsp;an&nbsp;image&nbsp;to&nbsp;the&nbsp;GIF&nbsp;format.</span><br>
<span class="lineno"></span><span class="keyword" id="5618694">type</span>&nbsp;<span class="ident" id="5618699">encoder</span>&nbsp;<span class="keyword" id="5618707">struct</span>&nbsp;<span class="op" id="5618714">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5618717">//&nbsp;w&nbsp;is&nbsp;the&nbsp;writer&nbsp;to&nbsp;write&nbsp;to.&nbsp;err&nbsp;is&nbsp;the&nbsp;first&nbsp;error&nbsp;encountered&nbsp;during</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5618792">//&nbsp;writing.&nbsp;All&nbsp;attempted&nbsp;writes&nbsp;after&nbsp;the&nbsp;first&nbsp;error&nbsp;become&nbsp;no-ops.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5618863">w</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5618867">writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5618875">err</span>&nbsp;<span class="builtintype" id="5618879">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5618886">//&nbsp;g&nbsp;is&nbsp;a&nbsp;reference&nbsp;to&nbsp;the&nbsp;data&nbsp;that&nbsp;is&nbsp;being&nbsp;encoded.</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5618942">g</span>&nbsp;<span class="op" id="5618944">*</span><span class="ident" id="5618945">GIF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5618950">//&nbsp;buf&nbsp;is&nbsp;a&nbsp;scratch&nbsp;buffer.&nbsp;It&nbsp;must&nbsp;be&nbsp;at&nbsp;least&nbsp;768&nbsp;so&nbsp;we&nbsp;can&nbsp;write&nbsp;the&nbsp;color&nbsp;map.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5619034">buf</span>&nbsp;<span class="op" id="5619038">[</span><span class="num" id="5619039">1024</span><span class="op" id="5619043">]</span><span class="builtintype" id="5619044">byte</span><br>
<span class="lineno"></span><span class="op" id="5619049">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="5619052">//&nbsp;blockWriter&nbsp;writes&nbsp;the&nbsp;block&nbsp;structure&nbsp;of&nbsp;GIF&nbsp;image&nbsp;data,&nbsp;which</span><br>
<span class="lineno"></span><span class="comment" id="5619119">//&nbsp;comprises&nbsp;(n,&nbsp;(n&nbsp;bytes))&nbsp;blocks,&nbsp;with&nbsp;1&nbsp;&lt;=&nbsp;n&nbsp;&lt;=&nbsp;255.&nbsp;It&nbsp;is&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5619185">//&nbsp;writer&nbsp;given&nbsp;to&nbsp;the&nbsp;LZW&nbsp;encoder,&nbsp;which&nbsp;is&nbsp;thus&nbsp;immune&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5619249">//&nbsp;blocking.</span><br>
<span class="lineno"></span><span class="keyword" id="5619262">type</span>&nbsp;<span class="ident" id="5619267">blockWriter</span>&nbsp;<span class="keyword" id="5619279">struct</span>&nbsp;<span class="op" id="5619286">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5619289">e</span>&nbsp;<span class="op" id="5619291">*</span><span class="ident" id="5619292">encoder</span><br>
<span class="lineno"></span><span class="op" id="5619300">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5619303">func</span>&nbsp;<span class="op" id="5619308">(</span><span class="ident" id="5619309">b</span>&nbsp;<span class="ident" id="5619311">blockWriter</span><span class="op" id="5619322">)</span>&nbsp;<span class="ident" id="5619324">Write</span><span class="op" id="5619329">(</span><span class="ident" id="5619330">data</span>&nbsp;<span class="op" id="5619335">[</span><span class="op" id="5619336">]</span><span class="builtintype" id="5619337">byte</span><span class="op" id="5619341">)</span>&nbsp;<span class="op" id="5619343">(</span><span class="builtintype" id="5619344">int</span><span class="op" id="5619347">,</span>&nbsp;<span class="builtintype" id="5619349">error</span><span class="op" id="5619354">)</span>&nbsp;<span class="op" id="5619356">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5619359">if</span>&nbsp;<span class="ident" id="5619362">b</span><span class="op" id="5619363">.</span><span class="ident" id="5619364">e</span><span class="op" id="5619365">.</span><span class="ident" id="5619366">err</span>&nbsp;<span class="op" id="5619370">!=</span>&nbsp;<span class="ident" id="5619373">nil</span>&nbsp;<span class="op" id="5619377">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5619381">return</span>&nbsp;<span class="num" id="5619388">0</span><span class="op" id="5619389">,</span>&nbsp;<span class="ident" id="5619391">b</span><span class="op" id="5619392">.</span><span class="ident" id="5619393">e</span><span class="op" id="5619394">.</span><span class="ident" id="5619395">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5619400">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5619403">if</span>&nbsp;<span class="builtinfunc" id="5619406">len</span><span class="op" id="5619409">(</span><span class="ident" id="5619410">data</span><span class="op" id="5619414">)</span>&nbsp;<span class="op" id="5619416">==</span>&nbsp;<span class="num" id="5619419">0</span>&nbsp;<span class="op" id="5619421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5619425">return</span>&nbsp;<span class="num" id="5619432">0</span><span class="op" id="5619433">,</span>&nbsp;<span class="ident" id="5619435">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5619440">}</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5619443">total</span>&nbsp;<span class="op" id="5619449">:=</span>&nbsp;<span class="num" id="5619452">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5619455">for</span>&nbsp;<span class="ident" id="5619459">total</span>&nbsp;<span class="op" id="5619465">&lt;</span>&nbsp;<span class="builtinfunc" id="5619467">len</span><span class="op" id="5619470">(</span><span class="ident" id="5619471">data</span><span class="op" id="5619475">)</span>&nbsp;<span class="op" id="5619477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5619481">n</span>&nbsp;<span class="op" id="5619483">:=</span>&nbsp;<span class="builtinfunc" id="5619486">copy</span><span class="op" id="5619490">(</span><span class="ident" id="5619491">b</span><span class="op" id="5619492">.</span><span class="ident" id="5619493">e</span><span class="op" id="5619494">.</span><span class="ident" id="5619495">buf</span><span class="op" id="5619498">[</span><span class="num" id="5619499">1</span><span class="op" id="5619500">:</span><span class="num" id="5619501">256</span><span class="op" id="5619504">]</span><span class="op" id="5619505">,</span>&nbsp;<span class="ident" id="5619507">data</span><span class="op" id="5619511">[</span><span class="ident" id="5619512">total</span><span class="op" id="5619517">:</span><span class="op" id="5619518">]</span><span class="op" id="5619519">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5619523">total</span>&nbsp;<span class="op" id="5619529">+=</span>&nbsp;<span class="ident" id="5619532">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5619536">b</span><span class="op" id="5619537">.</span><span class="ident" id="5619538">e</span><span class="op" id="5619539">.</span><span class="ident" id="5619540">buf</span><span class="op" id="5619543">[</span><span class="num" id="5619544">0</span><span class="op" id="5619545">]</span>&nbsp;<span class="op" id="5619547">=</span>&nbsp;<span class="builtintype" id="5619549">uint8</span><span class="op" id="5619554">(</span><span class="ident" id="5619555">n</span><span class="op" id="5619556">)</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5619561">n</span><span class="op" id="5619562">,</span>&nbsp;<span class="ident" id="5619564">b</span><span class="op" id="5619565">.</span><span class="ident" id="5619566">e</span><span class="op" id="5619567">.</span><span class="ident" id="5619568">err</span>&nbsp;<span class="op" id="5619572">=</span>&nbsp;<span class="ident" id="5619574">b</span><span class="op" id="5619575">.</span><span class="ident" id="5619576">e</span><span class="op" id="5619577">.</span><span class="ident" id="5619578">w</span><span class="op" id="5619579">.</span><span class="ident" id="5619580">Write</span><span class="op" id="5619585">(</span><span class="ident" id="5619586">b</span><span class="op" id="5619587">.</span><span class="ident" id="5619588">e</span><span class="op" id="5619589">.</span><span class="ident" id="5619590">buf</span><span class="op" id="5619593">[</span><span class="op" id="5619594">:</span><span class="ident" id="5619595">n</span><span class="op" id="5619596">+</span><span class="num" id="5619597">1</span><span class="op" id="5619598">]</span><span class="op" id="5619599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5619603">if</span>&nbsp;<span class="ident" id="5619606">b</span><span class="op" id="5619607">.</span><span class="ident" id="5619608">e</span><span class="op" id="5619609">.</span><span class="ident" id="5619610">err</span>&nbsp;<span class="op" id="5619614">!=</span>&nbsp;<span class="ident" id="5619617">nil</span>&nbsp;<span class="op" id="5619621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5619626">return</span>&nbsp;<span class="num" id="5619633">0</span><span class="op" id="5619634">,</span>&nbsp;<span class="ident" id="5619636">b</span><span class="op" id="5619637">.</span><span class="ident" id="5619638">e</span><span class="op" id="5619639">.</span><span class="ident" id="5619640">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5619646">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5619649">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5619652">return</span>&nbsp;<span class="ident" id="5619659">total</span><span class="op" id="5619664">,</span>&nbsp;<span class="ident" id="5619666">b</span><span class="op" id="5619667">.</span><span class="ident" id="5619668">e</span><span class="op" id="5619669">.</span><span class="ident" id="5619670">err</span><br>
<span class="lineno"></span><span class="op" id="5619674">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5619677">func</span>&nbsp;<span class="op" id="5619682">(</span><span class="ident" id="5619683">e</span>&nbsp;<span class="op" id="5619685">*</span><span class="ident" id="5619686">encoder</span><span class="op" id="5619693">)</span>&nbsp;<span class="ident" id="5619695">flush</span><span class="op" id="5619700">(</span><span class="op" id="5619701">)</span>&nbsp;<span class="op" id="5619703">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5619706">if</span>&nbsp;<span class="ident" id="5619709">e</span><span class="op" id="5619710">.</span><span class="ident" id="5619711">err</span>&nbsp;<span class="op" id="5619715">!=</span>&nbsp;<span class="ident" id="5619718">nil</span>&nbsp;<span class="op" id="5619722">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5619726">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5619734">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5619737">e</span><span class="op" id="5619738">.</span><span class="ident" id="5619739">err</span>&nbsp;<span class="op" id="5619743">=</span>&nbsp;<span class="ident" id="5619745">e</span><span class="op" id="5619746">.</span><span class="ident" id="5619747">w</span><span class="op" id="5619748">.</span><span class="ident" id="5619749">Flush</span><span class="op" id="5619754">(</span><span class="op" id="5619755">)</span><br>
<span class="lineno"></span><span class="op" id="5619757">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="keyword" id="5619760">func</span>&nbsp;<span class="op" id="5619765">(</span><span class="ident" id="5619766">e</span>&nbsp;<span class="op" id="5619768">*</span><span class="ident" id="5619769">encoder</span><span class="op" id="5619776">)</span>&nbsp;<span class="ident" id="5619778">write</span><span class="op" id="5619783">(</span><span class="ident" id="5619784">p</span>&nbsp;<span class="op" id="5619786">[</span><span class="op" id="5619787">]</span><span class="builtintype" id="5619788">byte</span><span class="op" id="5619792">)</span>&nbsp;<span class="op" id="5619794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5619797">if</span>&nbsp;<span class="ident" id="5619800">e</span><span class="op" id="5619801">.</span><span class="ident" id="5619802">err</span>&nbsp;<span class="op" id="5619806">!=</span>&nbsp;<span class="ident" id="5619809">nil</span>&nbsp;<span class="op" id="5619813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5619817">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5619825">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5619828">_</span><span class="op" id="5619829">,</span>&nbsp;<span class="ident" id="5619831">e</span><span class="op" id="5619832">.</span><span class="ident" id="5619833">err</span>&nbsp;<span class="op" id="5619837">=</span>&nbsp;<span class="ident" id="5619839">e</span><span class="op" id="5619840">.</span><span class="ident" id="5619841">w</span><span class="op" id="5619842">.</span><span class="ident" id="5619843">Write</span><span class="op" id="5619848">(</span><span class="ident" id="5619849">p</span><span class="op" id="5619850">)</span><br>
<span class="lineno"></span><span class="op" id="5619852">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5619855">func</span>&nbsp;<span class="op" id="5619860">(</span><span class="ident" id="5619861">e</span>&nbsp;<span class="op" id="5619863">*</span><span class="ident" id="5619864">encoder</span><span class="op" id="5619871">)</span>&nbsp;<span class="ident" id="5619873">writeByte</span><span class="op" id="5619882">(</span><span class="ident" id="5619883">b</span>&nbsp;<span class="builtintype" id="5619885">byte</span><span class="op" id="5619889">)</span>&nbsp;<span class="op" id="5619891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5619894">if</span>&nbsp;<span class="ident" id="5619897">e</span><span class="op" id="5619898">.</span><span class="ident" id="5619899">err</span>&nbsp;<span class="op" id="5619903">!=</span>&nbsp;<span class="ident" id="5619906">nil</span>&nbsp;<span class="op" id="5619910">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5619914">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5619922">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5619925">e</span><span class="op" id="5619926">.</span><span class="ident" id="5619927">err</span>&nbsp;<span class="op" id="5619931">=</span>&nbsp;<span class="ident" id="5619933">e</span><span class="op" id="5619934">.</span><span class="ident" id="5619935">w</span><span class="op" id="5619936">.</span><span class="ident" id="5619937">WriteByte</span><span class="op" id="5619946">(</span><span class="ident" id="5619947">b</span><span class="op" id="5619948">)</span><br>
<span class="lineno"></span><span class="op" id="5619950">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span><span class="keyword" id="5619953">func</span>&nbsp;<span class="op" id="5619958">(</span><span class="ident" id="5619959">e</span>&nbsp;<span class="op" id="5619961">*</span><span class="ident" id="5619962">encoder</span><span class="op" id="5619969">)</span>&nbsp;<span class="ident" id="5619971">writeHeader</span><span class="op" id="5619982">(</span><span class="op" id="5619983">)</span>&nbsp;<span class="op" id="5619985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5619988">if</span>&nbsp;<span class="ident" id="5619991">e</span><span class="op" id="5619992">.</span><span class="ident" id="5619993">err</span>&nbsp;<span class="op" id="5619997">!=</span>&nbsp;<span class="ident" id="5620000">nil</span>&nbsp;<span class="op" id="5620004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5620008">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5620016">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5620019">_</span><span class="op" id="5620020">,</span>&nbsp;<span class="ident" id="5620022">e</span><span class="op" id="5620023">.</span><span class="ident" id="5620024">err</span>&nbsp;<span class="op" id="5620028">=</span>&nbsp;<span class="ident" id="5620030">io</span><span class="op" id="5620032">.</span><span class="ident" id="5620033">WriteString</span><span class="op" id="5620044">(</span><span class="ident" id="5620045">e</span><span class="op" id="5620046">.</span><span class="ident" id="5620047">w</span><span class="op" id="5620048">,</span>&nbsp;<span class="string" id="5620050">&#34;GIF89a&#34;</span><span class="op" id="5620058">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5620061">if</span>&nbsp;<span class="ident" id="5620064">e</span><span class="op" id="5620065">.</span><span class="ident" id="5620066">err</span>&nbsp;<span class="op" id="5620070">!=</span>&nbsp;<span class="ident" id="5620073">nil</span>&nbsp;<span class="op" id="5620077">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5620081">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5620089">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5620093">pm</span>&nbsp;<span class="op" id="5620096">:=</span>&nbsp;<span class="ident" id="5620099">e</span><span class="op" id="5620100">.</span><span class="ident" id="5620101">g</span><span class="op" id="5620102">.</span><span class="ident" id="5620103">Image</span><span class="op" id="5620108">[</span><span class="num" id="5620109">0</span><span class="op" id="5620110">]</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5620113">//&nbsp;Logical&nbsp;screen&nbsp;width&nbsp;and&nbsp;height.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5620150">writeUint16</span><span class="op" id="5620161">(</span><span class="ident" id="5620162">e</span><span class="op" id="5620163">.</span><span class="ident" id="5620164">buf</span><span class="op" id="5620167">[</span><span class="num" id="5620168">0</span><span class="op" id="5620169">:</span><span class="num" id="5620170">2</span><span class="op" id="5620171">]</span><span class="op" id="5620172">,</span>&nbsp;<span class="builtintype" id="5620174">uint16</span><span class="op" id="5620180">(</span><span class="ident" id="5620181">pm</span><span class="op" id="5620183">.</span><span class="ident" id="5620184">Bounds</span><span class="op" id="5620190">(</span><span class="op" id="5620191">)</span><span class="op" id="5620192">.</span><span class="ident" id="5620193">Dx</span><span class="op" id="5620195">(</span><span class="op" id="5620196">)</span><span class="op" id="5620197">)</span><span class="op" id="5620198">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5620201">writeUint16</span><span class="op" id="5620212">(</span><span class="ident" id="5620213">e</span><span class="op" id="5620214">.</span><span class="ident" id="5620215">buf</span><span class="op" id="5620218">[</span><span class="num" id="5620219">2</span><span class="op" id="5620220">:</span><span class="num" id="5620221">4</span><span class="op" id="5620222">]</span><span class="op" id="5620223">,</span>&nbsp;<span class="builtintype" id="5620225">uint16</span><span class="op" id="5620231">(</span><span class="ident" id="5620232">pm</span><span class="op" id="5620234">.</span><span class="ident" id="5620235">Bounds</span><span class="op" id="5620241">(</span><span class="op" id="5620242">)</span><span class="op" id="5620243">.</span><span class="ident" id="5620244">Dy</span><span class="op" id="5620246">(</span><span class="op" id="5620247">)</span><span class="op" id="5620248">)</span><span class="op" id="5620249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5620252">e</span><span class="op" id="5620253">.</span><span class="ident" id="5620254">write</span><span class="op" id="5620259">(</span><span class="ident" id="5620260">e</span><span class="op" id="5620261">.</span><span class="ident" id="5620262">buf</span><span class="op" id="5620265">[</span><span class="op" id="5620266">:</span><span class="num" id="5620267">4</span><span class="op" id="5620268">]</span><span class="op" id="5620269">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5620273">//&nbsp;All&nbsp;frames&nbsp;have&nbsp;a&nbsp;local&nbsp;color&nbsp;table,&nbsp;so&nbsp;a&nbsp;global&nbsp;color&nbsp;table</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5620338">//&nbsp;is&nbsp;not&nbsp;needed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5620357">e</span><span class="op" id="5620358">.</span><span class="ident" id="5620359">buf</span><span class="op" id="5620362">[</span><span class="num" id="5620363">0</span><span class="op" id="5620364">]</span>&nbsp;<span class="op" id="5620366">=</span>&nbsp;<span class="num" id="5620368">0x00</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5620374">e</span><span class="op" id="5620375">.</span><span class="ident" id="5620376">buf</span><span class="op" id="5620379">[</span><span class="num" id="5620380">1</span><span class="op" id="5620381">]</span>&nbsp;<span class="op" id="5620383">=</span>&nbsp;<span class="num" id="5620385">0x00</span>&nbsp;<span class="comment" id="5620390">//&nbsp;Background&nbsp;Color&nbsp;Index.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5620418">e</span><span class="op" id="5620419">.</span><span class="ident" id="5620420">buf</span><span class="op" id="5620423">[</span><span class="num" id="5620424">2</span><span class="op" id="5620425">]</span>&nbsp;<span class="op" id="5620427">=</span>&nbsp;<span class="num" id="5620429">0x00</span>&nbsp;<span class="comment" id="5620434">//&nbsp;Pixel&nbsp;Aspect&nbsp;Ratio.</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5620458">e</span><span class="op" id="5620459">.</span><span class="ident" id="5620460">write</span><span class="op" id="5620465">(</span><span class="ident" id="5620466">e</span><span class="op" id="5620467">.</span><span class="ident" id="5620468">buf</span><span class="op" id="5620471">[</span><span class="op" id="5620472">:</span><span class="num" id="5620473">3</span><span class="op" id="5620474">]</span><span class="op" id="5620475">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5620479">//&nbsp;Add&nbsp;animation&nbsp;info&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5620516">if</span>&nbsp;<span class="builtinfunc" id="5620519">len</span><span class="op" id="5620522">(</span><span class="ident" id="5620523">e</span><span class="op" id="5620524">.</span><span class="ident" id="5620525">g</span><span class="op" id="5620526">.</span><span class="ident" id="5620527">Image</span><span class="op" id="5620532">)</span>&nbsp;<span class="op" id="5620534">&gt;</span>&nbsp;<span class="num" id="5620536">1</span>&nbsp;<span class="op" id="5620538">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5620542">e</span><span class="op" id="5620543">.</span><span class="ident" id="5620544">buf</span><span class="op" id="5620547">[</span><span class="num" id="5620548">0</span><span class="op" id="5620549">]</span>&nbsp;<span class="op" id="5620551">=</span>&nbsp;<span class="num" id="5620553">0x21</span>&nbsp;<span class="comment" id="5620558">//&nbsp;Extension&nbsp;Introducer.</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5620585">e</span><span class="op" id="5620586">.</span><span class="ident" id="5620587">buf</span><span class="op" id="5620590">[</span><span class="num" id="5620591">1</span><span class="op" id="5620592">]</span>&nbsp;<span class="op" id="5620594">=</span>&nbsp;<span class="num" id="5620596">0xff</span>&nbsp;<span class="comment" id="5620601">//&nbsp;Application&nbsp;Label.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5620625">e</span><span class="op" id="5620626">.</span><span class="ident" id="5620627">buf</span><span class="op" id="5620630">[</span><span class="num" id="5620631">2</span><span class="op" id="5620632">]</span>&nbsp;<span class="op" id="5620634">=</span>&nbsp;<span class="num" id="5620636">0x0b</span>&nbsp;<span class="comment" id="5620641">//&nbsp;Block&nbsp;Size.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5620658">e</span><span class="op" id="5620659">.</span><span class="ident" id="5620660">write</span><span class="op" id="5620665">(</span><span class="ident" id="5620666">e</span><span class="op" id="5620667">.</span><span class="ident" id="5620668">buf</span><span class="op" id="5620671">[</span><span class="op" id="5620672">:</span><span class="num" id="5620673">3</span><span class="op" id="5620674">]</span><span class="op" id="5620675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5620679">_</span><span class="op" id="5620680">,</span>&nbsp;<span class="ident" id="5620682">e</span><span class="op" id="5620683">.</span><span class="ident" id="5620684">err</span>&nbsp;<span class="op" id="5620688">=</span>&nbsp;<span class="ident" id="5620690">io</span><span class="op" id="5620692">.</span><span class="ident" id="5620693">WriteString</span><span class="op" id="5620704">(</span><span class="ident" id="5620705">e</span><span class="op" id="5620706">.</span><span class="ident" id="5620707">w</span><span class="op" id="5620708">,</span>&nbsp;<span class="string" id="5620710">&#34;NETSCAPE2.0&#34;</span><span class="op" id="5620723">)</span>&nbsp;<span class="comment" id="5620725">//&nbsp;Application&nbsp;Identifier.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5620754">if</span>&nbsp;<span class="ident" id="5620757">e</span><span class="op" id="5620758">.</span><span class="ident" id="5620759">err</span>&nbsp;<span class="op" id="5620763">!=</span>&nbsp;<span class="ident" id="5620766">nil</span>&nbsp;<span class="op" id="5620770">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5620775">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5620784">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5620788">e</span><span class="op" id="5620789">.</span><span class="ident" id="5620790">buf</span><span class="op" id="5620793">[</span><span class="num" id="5620794">0</span><span class="op" id="5620795">]</span>&nbsp;<span class="op" id="5620797">=</span>&nbsp;<span class="num" id="5620799">0x03</span>&nbsp;<span class="comment" id="5620804">//&nbsp;Block&nbsp;Size.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5620821">e</span><span class="op" id="5620822">.</span><span class="ident" id="5620823">buf</span><span class="op" id="5620826">[</span><span class="num" id="5620827">1</span><span class="op" id="5620828">]</span>&nbsp;<span class="op" id="5620830">=</span>&nbsp;<span class="num" id="5620832">0x01</span>&nbsp;<span class="comment" id="5620837">//&nbsp;Sub-block&nbsp;Index.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5620859">writeUint16</span><span class="op" id="5620870">(</span><span class="ident" id="5620871">e</span><span class="op" id="5620872">.</span><span class="ident" id="5620873">buf</span><span class="op" id="5620876">[</span><span class="num" id="5620877">2</span><span class="op" id="5620878">:</span><span class="num" id="5620879">4</span><span class="op" id="5620880">]</span><span class="op" id="5620881">,</span>&nbsp;<span class="builtintype" id="5620883">uint16</span><span class="op" id="5620889">(</span><span class="ident" id="5620890">e</span><span class="op" id="5620891">.</span><span class="ident" id="5620892">g</span><span class="op" id="5620893">.</span><span class="ident" id="5620894">LoopCount</span><span class="op" id="5620903">)</span><span class="op" id="5620904">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5620908">e</span><span class="op" id="5620909">.</span><span class="ident" id="5620910">buf</span><span class="op" id="5620913">[</span><span class="num" id="5620914">4</span><span class="op" id="5620915">]</span>&nbsp;<span class="op" id="5620917">=</span>&nbsp;<span class="num" id="5620919">0x00</span>&nbsp;<span class="comment" id="5620924">//&nbsp;Block&nbsp;Terminator.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5620947">e</span><span class="op" id="5620948">.</span><span class="ident" id="5620949">write</span><span class="op" id="5620954">(</span><span class="ident" id="5620955">e</span><span class="op" id="5620956">.</span><span class="ident" id="5620957">buf</span><span class="op" id="5620960">[</span><span class="op" id="5620961">:</span><span class="num" id="5620962">5</span><span class="op" id="5620963">]</span><span class="op" id="5620964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5620967">}</span><br>
<span class="lineno"></span><span class="op" id="5620969">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span><span class="keyword" id="5620972">func</span>&nbsp;<span class="op" id="5620977">(</span><span class="ident" id="5620978">e</span>&nbsp;<span class="op" id="5620980">*</span><span class="ident" id="5620981">encoder</span><span class="op" id="5620988">)</span>&nbsp;<span class="ident" id="5620990">writeColorTable</span><span class="op" id="5621005">(</span><span class="ident" id="5621006">p</span>&nbsp;<span class="ident" id="5621008">color</span><span class="op" id="5621013">.</span><span class="ident" id="5621014">Palette</span><span class="op" id="5621021">,</span>&nbsp;<span class="ident" id="5621023">size</span>&nbsp;<span class="builtintype" id="5621028">int</span><span class="op" id="5621031">)</span>&nbsp;<span class="op" id="5621033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5621036">if</span>&nbsp;<span class="ident" id="5621039">e</span><span class="op" id="5621040">.</span><span class="ident" id="5621041">err</span>&nbsp;<span class="op" id="5621045">!=</span>&nbsp;<span class="ident" id="5621048">nil</span>&nbsp;<span class="op" id="5621052">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5621056">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5621064">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5621068">for</span>&nbsp;<span class="ident" id="5621072">i</span>&nbsp;<span class="op" id="5621074">:=</span>&nbsp;<span class="num" id="5621077">0</span><span class="op" id="5621078">;</span>&nbsp;<span class="ident" id="5621080">i</span>&nbsp;<span class="op" id="5621082">&lt;</span>&nbsp;<span class="ident" id="5621084">log2Lookup</span><span class="op" id="5621094">[</span><span class="ident" id="5621095">size</span><span class="op" id="5621099">]</span><span class="op" id="5621100">;</span>&nbsp;<span class="ident" id="5621102">i</span><span class="op" id="5621103">++</span>&nbsp;<span class="op" id="5621106">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5621110">if</span>&nbsp;<span class="ident" id="5621113">i</span>&nbsp;<span class="op" id="5621115">&lt;</span>&nbsp;<span class="builtinfunc" id="5621117">len</span><span class="op" id="5621120">(</span><span class="ident" id="5621121">p</span><span class="op" id="5621122">)</span>&nbsp;<span class="op" id="5621124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5621129">r</span><span class="op" id="5621130">,</span>&nbsp;<span class="ident" id="5621132">g</span><span class="op" id="5621133">,</span>&nbsp;<span class="ident" id="5621135">b</span><span class="op" id="5621136">,</span>&nbsp;<span class="ident" id="5621138">_</span>&nbsp;<span class="op" id="5621140">:=</span>&nbsp;<span class="ident" id="5621143">p</span><span class="op" id="5621144">[</span><span class="ident" id="5621145">i</span><span class="op" id="5621146">]</span><span class="op" id="5621147">.</span><span class="ident" id="5621148">RGBA</span><span class="op" id="5621152">(</span><span class="op" id="5621153">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5621158">e</span><span class="op" id="5621159">.</span><span class="ident" id="5621160">buf</span><span class="op" id="5621163">[</span><span class="num" id="5621164">3</span><span class="op" id="5621165">*</span><span class="ident" id="5621166">i</span><span class="op" id="5621167">+</span><span class="num" id="5621168">0</span><span class="op" id="5621169">]</span>&nbsp;<span class="op" id="5621171">=</span>&nbsp;<span class="builtintype" id="5621173">uint8</span><span class="op" id="5621178">(</span><span class="ident" id="5621179">r</span>&nbsp;<span class="op" id="5621181">&gt;&gt;</span>&nbsp;<span class="num" id="5621184">8</span><span class="op" id="5621185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5621190">e</span><span class="op" id="5621191">.</span><span class="ident" id="5621192">buf</span><span class="op" id="5621195">[</span><span class="num" id="5621196">3</span><span class="op" id="5621197">*</span><span class="ident" id="5621198">i</span><span class="op" id="5621199">+</span><span class="num" id="5621200">1</span><span class="op" id="5621201">]</span>&nbsp;<span class="op" id="5621203">=</span>&nbsp;<span class="builtintype" id="5621205">uint8</span><span class="op" id="5621210">(</span><span class="ident" id="5621211">g</span>&nbsp;<span class="op" id="5621213">&gt;&gt;</span>&nbsp;<span class="num" id="5621216">8</span><span class="op" id="5621217">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5621222">e</span><span class="op" id="5621223">.</span><span class="ident" id="5621224">buf</span><span class="op" id="5621227">[</span><span class="num" id="5621228">3</span><span class="op" id="5621229">*</span><span class="ident" id="5621230">i</span><span class="op" id="5621231">+</span><span class="num" id="5621232">2</span><span class="op" id="5621233">]</span>&nbsp;<span class="op" id="5621235">=</span>&nbsp;<span class="builtintype" id="5621237">uint8</span><span class="op" id="5621242">(</span><span class="ident" id="5621243">b</span>&nbsp;<span class="op" id="5621245">&gt;&gt;</span>&nbsp;<span class="num" id="5621248">8</span><span class="op" id="5621249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5621253">}</span>&nbsp;<span class="keyword" id="5621255">else</span>&nbsp;<span class="op" id="5621260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5621265">//&nbsp;Pad&nbsp;with&nbsp;black.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5621287">e</span><span class="op" id="5621288">.</span><span class="ident" id="5621289">buf</span><span class="op" id="5621292">[</span><span class="num" id="5621293">3</span><span class="op" id="5621294">*</span><span class="ident" id="5621295">i</span><span class="op" id="5621296">+</span><span class="num" id="5621297">0</span><span class="op" id="5621298">]</span>&nbsp;<span class="op" id="5621300">=</span>&nbsp;<span class="num" id="5621302">0x00</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5621310">e</span><span class="op" id="5621311">.</span><span class="ident" id="5621312">buf</span><span class="op" id="5621315">[</span><span class="num" id="5621316">3</span><span class="op" id="5621317">*</span><span class="ident" id="5621318">i</span><span class="op" id="5621319">+</span><span class="num" id="5621320">1</span><span class="op" id="5621321">]</span>&nbsp;<span class="op" id="5621323">=</span>&nbsp;<span class="num" id="5621325">0x00</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5621333">e</span><span class="op" id="5621334">.</span><span class="ident" id="5621335">buf</span><span class="op" id="5621338">[</span><span class="num" id="5621339">3</span><span class="op" id="5621340">*</span><span class="ident" id="5621341">i</span><span class="op" id="5621342">+</span><span class="num" id="5621343">2</span><span class="op" id="5621344">]</span>&nbsp;<span class="op" id="5621346">=</span>&nbsp;<span class="num" id="5621348">0x00</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5621355">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5621358">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5621361">e</span><span class="op" id="5621362">.</span><span class="ident" id="5621363">write</span><span class="op" id="5621368">(</span><span class="ident" id="5621369">e</span><span class="op" id="5621370">.</span><span class="ident" id="5621371">buf</span><span class="op" id="5621374">[</span><span class="op" id="5621375">:</span><span class="num" id="5621376">3</span><span class="op" id="5621377">*</span><span class="ident" id="5621378">log2Lookup</span><span class="op" id="5621388">[</span><span class="ident" id="5621389">size</span><span class="op" id="5621393">]</span><span class="op" id="5621394">]</span><span class="op" id="5621395">)</span><br>
<span class="lineno"></span><span class="op" id="5621397">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span><span class="keyword" id="5621400">func</span>&nbsp;<span class="op" id="5621405">(</span><span class="ident" id="5621406">e</span>&nbsp;<span class="op" id="5621408">*</span><span class="ident" id="5621409">encoder</span><span class="op" id="5621416">)</span>&nbsp;<span class="ident" id="5621418">writeImageBlock</span><span class="op" id="5621433">(</span><span class="ident" id="5621434">pm</span>&nbsp;<span class="op" id="5621437">*</span><span class="ident" id="5621438">image</span><span class="op" id="5621443">.</span><span class="ident" id="5621444">Paletted</span><span class="op" id="5621452">,</span>&nbsp;<span class="ident" id="5621454">delay</span>&nbsp;<span class="builtintype" id="5621460">int</span><span class="op" id="5621463">)</span>&nbsp;<span class="op" id="5621465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5621468">if</span>&nbsp;<span class="ident" id="5621471">e</span><span class="op" id="5621472">.</span><span class="ident" id="5621473">err</span>&nbsp;<span class="op" id="5621477">!=</span>&nbsp;<span class="ident" id="5621480">nil</span>&nbsp;<span class="op" id="5621484">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5621488">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5621496">}</span><br>
<span class="lineno">175</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5621500">if</span>&nbsp;<span class="builtinfunc" id="5621503">len</span><span class="op" id="5621506">(</span><span class="ident" id="5621507">pm</span><span class="op" id="5621509">.</span><span class="ident" id="5621510">Palette</span><span class="op" id="5621517">)</span>&nbsp;<span class="op" id="5621519">==</span>&nbsp;<span class="num" id="5621522">0</span>&nbsp;<span class="op" id="5621524">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5621528">e</span><span class="op" id="5621529">.</span><span class="ident" id="5621530">err</span>&nbsp;<span class="op" id="5621534">=</span>&nbsp;<span class="ident" id="5621536">errors</span><span class="op" id="5621542">.</span><span class="ident" id="5621543">New</span><span class="op" id="5621546">(</span><span class="string" id="5621547">&#34;gif:&nbsp;cannot&nbsp;encode&nbsp;image&nbsp;block&nbsp;with&nbsp;empty&nbsp;palette&#34;</span><span class="op" id="5621598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5621602">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5621610">}</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5621614">b</span>&nbsp;<span class="op" id="5621616">:=</span>&nbsp;<span class="ident" id="5621619">pm</span><span class="op" id="5621621">.</span><span class="ident" id="5621622">Bounds</span><span class="op" id="5621628">(</span><span class="op" id="5621629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5621632">if</span>&nbsp;<span class="ident" id="5621635">b</span><span class="op" id="5621636">.</span><span class="ident" id="5621637">Dx</span><span class="op" id="5621639">(</span><span class="op" id="5621640">)</span>&nbsp;<span class="op" id="5621642">&gt;=</span>&nbsp;<span class="num" id="5621645">1</span><span class="op" id="5621646">&lt;&lt;</span><span class="num" id="5621648">16</span>&nbsp;<span class="op" id="5621651">||</span>&nbsp;<span class="ident" id="5621654">b</span><span class="op" id="5621655">.</span><span class="ident" id="5621656">Dy</span><span class="op" id="5621658">(</span><span class="op" id="5621659">)</span>&nbsp;<span class="op" id="5621661">&gt;=</span>&nbsp;<span class="num" id="5621664">1</span><span class="op" id="5621665">&lt;&lt;</span><span class="num" id="5621667">16</span>&nbsp;<span class="op" id="5621670">||</span>&nbsp;<span class="ident" id="5621673">b</span><span class="op" id="5621674">.</span><span class="ident" id="5621675">Min</span><span class="op" id="5621678">.</span><span class="ident" id="5621679">X</span>&nbsp;<span class="op" id="5621681">&lt;</span>&nbsp;<span class="num" id="5621683">0</span>&nbsp;<span class="op" id="5621685">||</span>&nbsp;<span class="ident" id="5621688">b</span><span class="op" id="5621689">.</span><span class="ident" id="5621690">Min</span><span class="op" id="5621693">.</span><span class="ident" id="5621694">X</span>&nbsp;<span class="op" id="5621696">&gt;=</span>&nbsp;<span class="num" id="5621699">1</span><span class="op" id="5621700">&lt;&lt;</span><span class="num" id="5621702">16</span>&nbsp;<span class="op" id="5621705">||</span>&nbsp;<span class="ident" id="5621708">b</span><span class="op" id="5621709">.</span><span class="ident" id="5621710">Min</span><span class="op" id="5621713">.</span><span class="ident" id="5621714">Y</span>&nbsp;<span class="op" id="5621716">&lt;</span>&nbsp;<span class="num" id="5621718">0</span>&nbsp;<span class="op" id="5621720">||</span>&nbsp;<span class="ident" id="5621723">b</span><span class="op" id="5621724">.</span><span class="ident" id="5621725">Min</span><span class="op" id="5621728">.</span><span class="ident" id="5621729">Y</span>&nbsp;<span class="op" id="5621731">&gt;=</span>&nbsp;<span class="num" id="5621734">1</span><span class="op" id="5621735">&lt;&lt;</span><span class="num" id="5621737">16</span>&nbsp;<span class="op" id="5621740">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5621744">e</span><span class="op" id="5621745">.</span><span class="ident" id="5621746">err</span>&nbsp;<span class="op" id="5621750">=</span>&nbsp;<span class="ident" id="5621752">errors</span><span class="op" id="5621758">.</span><span class="ident" id="5621759">New</span><span class="op" id="5621762">(</span><span class="string" id="5621763">&#34;gif:&nbsp;image&nbsp;block&nbsp;is&nbsp;too&nbsp;large&nbsp;to&nbsp;encode&#34;</span><span class="op" id="5621804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5621808">return</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5621816">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5621820">transparentIndex</span>&nbsp;<span class="op" id="5621837">:=</span>&nbsp;<span class="op" id="5621840">-</span><span class="num" id="5621841">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5621844">for</span>&nbsp;<span class="ident" id="5621848">i</span><span class="op" id="5621849">,</span>&nbsp;<span class="ident" id="5621851">c</span>&nbsp;<span class="op" id="5621853">:=</span>&nbsp;<span class="keyword" id="5621856">range</span>&nbsp;<span class="ident" id="5621862">pm</span><span class="op" id="5621864">.</span><span class="ident" id="5621865">Palette</span>&nbsp;<span class="op" id="5621873">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5621877">if</span>&nbsp;<span class="ident" id="5621880">_</span><span class="op" id="5621881">,</span>&nbsp;<span class="ident" id="5621883">_</span><span class="op" id="5621884">,</span>&nbsp;<span class="ident" id="5621886">_</span><span class="op" id="5621887">,</span>&nbsp;<span class="ident" id="5621889">a</span>&nbsp;<span class="op" id="5621891">:=</span>&nbsp;<span class="ident" id="5621894">c</span><span class="op" id="5621895">.</span><span class="ident" id="5621896">RGBA</span><span class="op" id="5621900">(</span><span class="op" id="5621901">)</span><span class="op" id="5621902">;</span>&nbsp;<span class="ident" id="5621904">a</span>&nbsp;<span class="op" id="5621906">==</span>&nbsp;<span class="num" id="5621909">0</span>&nbsp;<span class="op" id="5621911">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5621916">transparentIndex</span>&nbsp;<span class="op" id="5621933">=</span>&nbsp;<span class="ident" id="5621935">i</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5621940">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5621948">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5621951">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5621955">if</span>&nbsp;<span class="ident" id="5621958">delay</span>&nbsp;<span class="op" id="5621964">&gt;</span>&nbsp;<span class="num" id="5621966">0</span>&nbsp;<span class="op" id="5621968">||</span>&nbsp;<span class="ident" id="5621971">transparentIndex</span>&nbsp;<span class="op" id="5621988">!=</span>&nbsp;<span class="op" id="5621991">-</span><span class="num" id="5621992">1</span>&nbsp;<span class="op" id="5621994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5621998">e</span><span class="op" id="5621999">.</span><span class="ident" id="5622000">buf</span><span class="op" id="5622003">[</span><span class="num" id="5622004">0</span><span class="op" id="5622005">]</span>&nbsp;<span class="op" id="5622007">=</span>&nbsp;<span class="ident" id="5622009">sExtension</span>&nbsp;&nbsp;<span class="comment" id="5622021">//&nbsp;Extension&nbsp;Introducer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5622048">e</span><span class="op" id="5622049">.</span><span class="ident" id="5622050">buf</span><span class="op" id="5622053">[</span><span class="num" id="5622054">1</span><span class="op" id="5622055">]</span>&nbsp;<span class="op" id="5622057">=</span>&nbsp;<span class="ident" id="5622059">gcLabel</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5622071">//&nbsp;Graphic&nbsp;Control&nbsp;Label.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5622099">e</span><span class="op" id="5622100">.</span><span class="ident" id="5622101">buf</span><span class="op" id="5622104">[</span><span class="num" id="5622105">2</span><span class="op" id="5622106">]</span>&nbsp;<span class="op" id="5622108">=</span>&nbsp;<span class="ident" id="5622110">gcBlockSize</span>&nbsp;<span class="comment" id="5622122">//&nbsp;Block&nbsp;Size.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5622139">if</span>&nbsp;<span class="ident" id="5622142">transparentIndex</span>&nbsp;<span class="op" id="5622159">!=</span>&nbsp;<span class="op" id="5622162">-</span><span class="num" id="5622163">1</span>&nbsp;<span class="op" id="5622165">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5622170">e</span><span class="op" id="5622171">.</span><span class="ident" id="5622172">buf</span><span class="op" id="5622175">[</span><span class="num" id="5622176">3</span><span class="op" id="5622177">]</span>&nbsp;<span class="op" id="5622179">=</span>&nbsp;<span class="num" id="5622181">0x01</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5622188">}</span>&nbsp;<span class="keyword" id="5622190">else</span>&nbsp;<span class="op" id="5622195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5622200">e</span><span class="op" id="5622201">.</span><span class="ident" id="5622202">buf</span><span class="op" id="5622205">[</span><span class="num" id="5622206">3</span><span class="op" id="5622207">]</span>&nbsp;<span class="op" id="5622209">=</span>&nbsp;<span class="num" id="5622211">0x00</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5622218">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5622222">writeUint16</span><span class="op" id="5622233">(</span><span class="ident" id="5622234">e</span><span class="op" id="5622235">.</span><span class="ident" id="5622236">buf</span><span class="op" id="5622239">[</span><span class="num" id="5622240">4</span><span class="op" id="5622241">:</span><span class="num" id="5622242">6</span><span class="op" id="5622243">]</span><span class="op" id="5622244">,</span>&nbsp;<span class="builtintype" id="5622246">uint16</span><span class="op" id="5622252">(</span><span class="ident" id="5622253">delay</span><span class="op" id="5622258">)</span><span class="op" id="5622259">)</span>&nbsp;<span class="comment" id="5622261">//&nbsp;Delay&nbsp;Time&nbsp;(1/100ths&nbsp;of&nbsp;a&nbsp;second)</span><br>
<span class="lineno">205</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5622301">//&nbsp;Transparent&nbsp;color&nbsp;index.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5622331">if</span>&nbsp;<span class="ident" id="5622334">transparentIndex</span>&nbsp;<span class="op" id="5622351">!=</span>&nbsp;<span class="op" id="5622354">-</span><span class="num" id="5622355">1</span>&nbsp;<span class="op" id="5622357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5622362">e</span><span class="op" id="5622363">.</span><span class="ident" id="5622364">buf</span><span class="op" id="5622367">[</span><span class="num" id="5622368">6</span><span class="op" id="5622369">]</span>&nbsp;<span class="op" id="5622371">=</span>&nbsp;<span class="builtintype" id="5622373">uint8</span><span class="op" id="5622378">(</span><span class="ident" id="5622379">transparentIndex</span><span class="op" id="5622395">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5622399">}</span>&nbsp;<span class="keyword" id="5622401">else</span>&nbsp;<span class="op" id="5622406">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5622411">e</span><span class="op" id="5622412">.</span><span class="ident" id="5622413">buf</span><span class="op" id="5622416">[</span><span class="num" id="5622417">6</span><span class="op" id="5622418">]</span>&nbsp;<span class="op" id="5622420">=</span>&nbsp;<span class="num" id="5622422">0x00</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5622429">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5622433">e</span><span class="op" id="5622434">.</span><span class="ident" id="5622435">buf</span><span class="op" id="5622438">[</span><span class="num" id="5622439">7</span><span class="op" id="5622440">]</span>&nbsp;<span class="op" id="5622442">=</span>&nbsp;<span class="num" id="5622444">0x00</span>&nbsp;<span class="comment" id="5622449">//&nbsp;Block&nbsp;Terminator.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5622472">e</span><span class="op" id="5622473">.</span><span class="ident" id="5622474">write</span><span class="op" id="5622479">(</span><span class="ident" id="5622480">e</span><span class="op" id="5622481">.</span><span class="ident" id="5622482">buf</span><span class="op" id="5622485">[</span><span class="op" id="5622486">:</span><span class="num" id="5622487">8</span><span class="op" id="5622488">]</span><span class="op" id="5622489">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5622492">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5622495">e</span><span class="op" id="5622496">.</span><span class="ident" id="5622497">buf</span><span class="op" id="5622500">[</span><span class="num" id="5622501">0</span><span class="op" id="5622502">]</span>&nbsp;<span class="op" id="5622504">=</span>&nbsp;<span class="ident" id="5622506">sImageDescriptor</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5622524">writeUint16</span><span class="op" id="5622535">(</span><span class="ident" id="5622536">e</span><span class="op" id="5622537">.</span><span class="ident" id="5622538">buf</span><span class="op" id="5622541">[</span><span class="num" id="5622542">1</span><span class="op" id="5622543">:</span><span class="num" id="5622544">3</span><span class="op" id="5622545">]</span><span class="op" id="5622546">,</span>&nbsp;<span class="builtintype" id="5622548">uint16</span><span class="op" id="5622554">(</span><span class="ident" id="5622555">b</span><span class="op" id="5622556">.</span><span class="ident" id="5622557">Min</span><span class="op" id="5622560">.</span><span class="ident" id="5622561">X</span><span class="op" id="5622562">)</span><span class="op" id="5622563">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5622566">writeUint16</span><span class="op" id="5622577">(</span><span class="ident" id="5622578">e</span><span class="op" id="5622579">.</span><span class="ident" id="5622580">buf</span><span class="op" id="5622583">[</span><span class="num" id="5622584">3</span><span class="op" id="5622585">:</span><span class="num" id="5622586">5</span><span class="op" id="5622587">]</span><span class="op" id="5622588">,</span>&nbsp;<span class="builtintype" id="5622590">uint16</span><span class="op" id="5622596">(</span><span class="ident" id="5622597">b</span><span class="op" id="5622598">.</span><span class="ident" id="5622599">Min</span><span class="op" id="5622602">.</span><span class="ident" id="5622603">Y</span><span class="op" id="5622604">)</span><span class="op" id="5622605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5622608">writeUint16</span><span class="op" id="5622619">(</span><span class="ident" id="5622620">e</span><span class="op" id="5622621">.</span><span class="ident" id="5622622">buf</span><span class="op" id="5622625">[</span><span class="num" id="5622626">5</span><span class="op" id="5622627">:</span><span class="num" id="5622628">7</span><span class="op" id="5622629">]</span><span class="op" id="5622630">,</span>&nbsp;<span class="builtintype" id="5622632">uint16</span><span class="op" id="5622638">(</span><span class="ident" id="5622639">b</span><span class="op" id="5622640">.</span><span class="ident" id="5622641">Dx</span><span class="op" id="5622643">(</span><span class="op" id="5622644">)</span><span class="op" id="5622645">)</span><span class="op" id="5622646">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5622649">writeUint16</span><span class="op" id="5622660">(</span><span class="ident" id="5622661">e</span><span class="op" id="5622662">.</span><span class="ident" id="5622663">buf</span><span class="op" id="5622666">[</span><span class="num" id="5622667">7</span><span class="op" id="5622668">:</span><span class="num" id="5622669">9</span><span class="op" id="5622670">]</span><span class="op" id="5622671">,</span>&nbsp;<span class="builtintype" id="5622673">uint16</span><span class="op" id="5622679">(</span><span class="ident" id="5622680">b</span><span class="op" id="5622681">.</span><span class="ident" id="5622682">Dy</span><span class="op" id="5622684">(</span><span class="op" id="5622685">)</span><span class="op" id="5622686">)</span><span class="op" id="5622687">)</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5622690">e</span><span class="op" id="5622691">.</span><span class="ident" id="5622692">write</span><span class="op" id="5622697">(</span><span class="ident" id="5622698">e</span><span class="op" id="5622699">.</span><span class="ident" id="5622700">buf</span><span class="op" id="5622703">[</span><span class="op" id="5622704">:</span><span class="num" id="5622705">9</span><span class="op" id="5622706">]</span><span class="op" id="5622707">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5622711">paddedSize</span>&nbsp;<span class="op" id="5622722">:=</span>&nbsp;<span class="ident" id="5622725">log2</span><span class="op" id="5622729">(</span><span class="builtinfunc" id="5622730">len</span><span class="op" id="5622733">(</span><span class="ident" id="5622734">pm</span><span class="op" id="5622736">.</span><span class="ident" id="5622737">Palette</span><span class="op" id="5622744">)</span><span class="op" id="5622745">)</span>&nbsp;<span class="comment" id="5622747">//&nbsp;Size&nbsp;of&nbsp;Local&nbsp;Color&nbsp;Table:&nbsp;2^(1+n).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5622787">//&nbsp;Interlacing&nbsp;is&nbsp;not&nbsp;supported.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5622821">e</span><span class="op" id="5622822">.</span><span class="ident" id="5622823">writeByte</span><span class="op" id="5622832">(</span><span class="num" id="5622833">0x80</span>&nbsp;<span class="op" id="5622838">|</span>&nbsp;<span class="builtintype" id="5622840">uint8</span><span class="op" id="5622845">(</span><span class="ident" id="5622846">paddedSize</span><span class="op" id="5622856">)</span><span class="op" id="5622857">)</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5622861">//&nbsp;Local&nbsp;Color&nbsp;Table.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5622884">e</span><span class="op" id="5622885">.</span><span class="ident" id="5622886">writeColorTable</span><span class="op" id="5622901">(</span><span class="ident" id="5622902">pm</span><span class="op" id="5622904">.</span><span class="ident" id="5622905">Palette</span><span class="op" id="5622912">,</span>&nbsp;<span class="ident" id="5622914">paddedSize</span><span class="op" id="5622924">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5622928">litWidth</span>&nbsp;<span class="op" id="5622937">:=</span>&nbsp;<span class="ident" id="5622940">paddedSize</span>&nbsp;<span class="op" id="5622951">+</span>&nbsp;<span class="num" id="5622953">1</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5622956">if</span>&nbsp;<span class="ident" id="5622959">litWidth</span>&nbsp;<span class="op" id="5622968">&lt;</span>&nbsp;<span class="num" id="5622970">2</span>&nbsp;<span class="op" id="5622972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5622976">litWidth</span>&nbsp;<span class="op" id="5622985">=</span>&nbsp;<span class="num" id="5622987">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5622990">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5622993">e</span><span class="op" id="5622994">.</span><span class="ident" id="5622995">writeByte</span><span class="op" id="5623004">(</span><span class="builtintype" id="5623005">uint8</span><span class="op" id="5623010">(</span><span class="ident" id="5623011">litWidth</span><span class="op" id="5623019">)</span><span class="op" id="5623020">)</span>&nbsp;<span class="comment" id="5623022">//&nbsp;LZW&nbsp;Minimum&nbsp;Code&nbsp;Size.</span><br>
<span class="lineno"></span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5623050">lzww</span>&nbsp;<span class="op" id="5623055">:=</span>&nbsp;<span class="ident" id="5623058">lzw</span><span class="op" id="5623061">.</span><span class="ident" id="5623062">NewWriter</span><span class="op" id="5623071">(</span><span class="ident" id="5623072">blockWriter</span><span class="op" id="5623083">{</span><span class="ident" id="5623084">e</span><span class="op" id="5623085">:</span>&nbsp;<span class="ident" id="5623087">e</span><span class="op" id="5623088">}</span><span class="op" id="5623089">,</span>&nbsp;<span class="ident" id="5623091">lzw</span><span class="op" id="5623094">.</span><span class="ident" id="5623095">LSB</span><span class="op" id="5623098">,</span>&nbsp;<span class="ident" id="5623100">litWidth</span><span class="op" id="5623108">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5623111">if</span>&nbsp;<span class="ident" id="5623114">dx</span>&nbsp;<span class="op" id="5623117">:=</span>&nbsp;<span class="ident" id="5623120">b</span><span class="op" id="5623121">.</span><span class="ident" id="5623122">Dx</span><span class="op" id="5623124">(</span><span class="op" id="5623125">)</span><span class="op" id="5623126">;</span>&nbsp;<span class="ident" id="5623128">dx</span>&nbsp;<span class="op" id="5623131">==</span>&nbsp;<span class="ident" id="5623134">pm</span><span class="op" id="5623136">.</span><span class="ident" id="5623137">Stride</span>&nbsp;<span class="op" id="5623144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5623148">_</span><span class="op" id="5623149">,</span>&nbsp;<span class="ident" id="5623151">e</span><span class="op" id="5623152">.</span><span class="ident" id="5623153">err</span>&nbsp;<span class="op" id="5623157">=</span>&nbsp;<span class="ident" id="5623159">lzww</span><span class="op" id="5623163">.</span><span class="ident" id="5623164">Write</span><span class="op" id="5623169">(</span><span class="ident" id="5623170">pm</span><span class="op" id="5623172">.</span><span class="ident" id="5623173">Pix</span><span class="op" id="5623176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5623180">if</span>&nbsp;<span class="ident" id="5623183">e</span><span class="op" id="5623184">.</span><span class="ident" id="5623185">err</span>&nbsp;<span class="op" id="5623189">!=</span>&nbsp;<span class="ident" id="5623192">nil</span>&nbsp;<span class="op" id="5623196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5623201">lzww</span><span class="op" id="5623205">.</span><span class="ident" id="5623206">Close</span><span class="op" id="5623211">(</span><span class="op" id="5623212">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5623217">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5623226">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5623229">}</span>&nbsp;<span class="keyword" id="5623231">else</span>&nbsp;<span class="op" id="5623236">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5623240">for</span>&nbsp;<span class="ident" id="5623244">i</span><span class="op" id="5623245">,</span>&nbsp;<span class="ident" id="5623247">y</span>&nbsp;<span class="op" id="5623249">:=</span>&nbsp;<span class="num" id="5623252">0</span><span class="op" id="5623253">,</span>&nbsp;<span class="ident" id="5623255">b</span><span class="op" id="5623256">.</span><span class="ident" id="5623257">Min</span><span class="op" id="5623260">.</span><span class="ident" id="5623261">Y</span><span class="op" id="5623262">;</span>&nbsp;<span class="ident" id="5623264">y</span>&nbsp;<span class="op" id="5623266">&lt;</span>&nbsp;<span class="ident" id="5623268">b</span><span class="op" id="5623269">.</span><span class="ident" id="5623270">Max</span><span class="op" id="5623273">.</span><span class="ident" id="5623274">Y</span><span class="op" id="5623275">;</span>&nbsp;<span class="ident" id="5623277">i</span><span class="op" id="5623278">,</span>&nbsp;<span class="ident" id="5623280">y</span>&nbsp;<span class="op" id="5623282">=</span>&nbsp;<span class="ident" id="5623284">i</span><span class="op" id="5623285">+</span><span class="ident" id="5623286">pm</span><span class="op" id="5623288">.</span><span class="ident" id="5623289">Stride</span><span class="op" id="5623295">,</span>&nbsp;<span class="ident" id="5623297">y</span><span class="op" id="5623298">+</span><span class="num" id="5623299">1</span>&nbsp;<span class="op" id="5623301">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5623306">_</span><span class="op" id="5623307">,</span>&nbsp;<span class="ident" id="5623309">e</span><span class="op" id="5623310">.</span><span class="ident" id="5623311">err</span>&nbsp;<span class="op" id="5623315">=</span>&nbsp;<span class="ident" id="5623317">lzww</span><span class="op" id="5623321">.</span><span class="ident" id="5623322">Write</span><span class="op" id="5623327">(</span><span class="ident" id="5623328">pm</span><span class="op" id="5623330">.</span><span class="ident" id="5623331">Pix</span><span class="op" id="5623334">[</span><span class="ident" id="5623335">i</span>&nbsp;<span class="op" id="5623337">:</span>&nbsp;<span class="ident" id="5623339">i</span><span class="op" id="5623340">+</span><span class="ident" id="5623341">dx</span><span class="op" id="5623343">]</span><span class="op" id="5623344">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5623349">if</span>&nbsp;<span class="ident" id="5623352">e</span><span class="op" id="5623353">.</span><span class="ident" id="5623354">err</span>&nbsp;<span class="op" id="5623358">!=</span>&nbsp;<span class="ident" id="5623361">nil</span>&nbsp;<span class="op" id="5623365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5623371">lzww</span><span class="op" id="5623375">.</span><span class="ident" id="5623376">Close</span><span class="op" id="5623381">(</span><span class="op" id="5623382">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5623388">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5623398">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5623402">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5623405">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5623408">lzww</span><span class="op" id="5623412">.</span><span class="ident" id="5623413">Close</span><span class="op" id="5623418">(</span><span class="op" id="5623419">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5623422">e</span><span class="op" id="5623423">.</span><span class="ident" id="5623424">writeByte</span><span class="op" id="5623433">(</span><span class="num" id="5623434">0x00</span><span class="op" id="5623438">)</span>&nbsp;<span class="comment" id="5623440">//&nbsp;Block&nbsp;Terminator.</span><br>
<span class="lineno"></span><span class="op" id="5623461">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span><span class="comment" id="5623464">//&nbsp;Options&nbsp;are&nbsp;the&nbsp;encoding&nbsp;parameters.</span><br>
<span class="lineno"></span><span class="keyword" id="5623504">type</span>&nbsp;<span class="ident" id="5623509">Options</span>&nbsp;<span class="keyword" id="5623517">struct</span>&nbsp;<span class="op" id="5623524">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5623527">//&nbsp;NumColors&nbsp;is&nbsp;the&nbsp;maximum&nbsp;number&nbsp;of&nbsp;colors&nbsp;used&nbsp;in&nbsp;the&nbsp;image.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5623592">//&nbsp;It&nbsp;ranges&nbsp;from&nbsp;1&nbsp;to&nbsp;256.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5623621">NumColors</span>&nbsp;<span class="builtintype" id="5623631">int</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5623637">//&nbsp;Quantizer&nbsp;is&nbsp;used&nbsp;to&nbsp;produce&nbsp;a&nbsp;palette&nbsp;with&nbsp;size&nbsp;NumColors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5623701">//&nbsp;palette.Plan9&nbsp;is&nbsp;used&nbsp;in&nbsp;place&nbsp;of&nbsp;a&nbsp;nil&nbsp;Quantizer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5623756">Quantizer</span>&nbsp;<span class="ident" id="5623766">draw</span><span class="op" id="5623770">.</span><span class="ident" id="5623771">Quantizer</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5623783">//&nbsp;Drawer&nbsp;is&nbsp;used&nbsp;to&nbsp;convert&nbsp;the&nbsp;source&nbsp;image&nbsp;to&nbsp;the&nbsp;desired&nbsp;palette.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5623854">//&nbsp;draw.FloydSteinberg&nbsp;is&nbsp;used&nbsp;in&nbsp;place&nbsp;of&nbsp;a&nbsp;nil&nbsp;Drawer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5623912">Drawer</span>&nbsp;<span class="ident" id="5623919">draw</span><span class="op" id="5623923">.</span><span class="ident" id="5623924">Drawer</span><br>
<span class="lineno"></span><span class="op" id="5623931">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">270</span><span class="comment" id="5623934">//&nbsp;EncodeAll&nbsp;writes&nbsp;the&nbsp;images&nbsp;in&nbsp;g&nbsp;to&nbsp;w&nbsp;in&nbsp;GIF&nbsp;format&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5623998">//&nbsp;given&nbsp;loop&nbsp;count&nbsp;and&nbsp;delay&nbsp;between&nbsp;frames.</span><br>
<span class="lineno"></span><span class="keyword" id="5624044">func</span>&nbsp;<span class="ident" id="5624049">EncodeAll</span><span class="op" id="5624058">(</span><span class="ident" id="5624059">w</span>&nbsp;<span class="ident" id="5624061">io</span><span class="op" id="5624063">.</span><span class="ident" id="5624064">Writer</span><span class="op" id="5624070">,</span>&nbsp;<span class="ident" id="5624072">g</span>&nbsp;<span class="op" id="5624074">*</span><span class="ident" id="5624075">GIF</span><span class="op" id="5624078">)</span>&nbsp;<span class="builtintype" id="5624080">error</span>&nbsp;<span class="op" id="5624086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5624089">if</span>&nbsp;<span class="builtinfunc" id="5624092">len</span><span class="op" id="5624095">(</span><span class="ident" id="5624096">g</span><span class="op" id="5624097">.</span><span class="ident" id="5624098">Image</span><span class="op" id="5624103">)</span>&nbsp;<span class="op" id="5624105">==</span>&nbsp;<span class="num" id="5624108">0</span>&nbsp;<span class="op" id="5624110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5624114">return</span>&nbsp;<span class="ident" id="5624121">errors</span><span class="op" id="5624127">.</span><span class="ident" id="5624128">New</span><span class="op" id="5624131">(</span><span class="string" id="5624132">&#34;gif:&nbsp;must&nbsp;provide&nbsp;at&nbsp;least&nbsp;one&nbsp;image&#34;</span><span class="op" id="5624170">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5624173">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5624177">if</span>&nbsp;<span class="builtinfunc" id="5624180">len</span><span class="op" id="5624183">(</span><span class="ident" id="5624184">g</span><span class="op" id="5624185">.</span><span class="ident" id="5624186">Image</span><span class="op" id="5624191">)</span>&nbsp;<span class="op" id="5624193">!=</span>&nbsp;<span class="builtinfunc" id="5624196">len</span><span class="op" id="5624199">(</span><span class="ident" id="5624200">g</span><span class="op" id="5624201">.</span><span class="ident" id="5624202">Delay</span><span class="op" id="5624207">)</span>&nbsp;<span class="op" id="5624209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5624213">return</span>&nbsp;<span class="ident" id="5624220">errors</span><span class="op" id="5624226">.</span><span class="ident" id="5624227">New</span><span class="op" id="5624230">(</span><span class="string" id="5624231">&#34;gif:&nbsp;mismatched&nbsp;image&nbsp;and&nbsp;delay&nbsp;lengths&#34;</span><span class="op" id="5624272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5624275">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5624278">if</span>&nbsp;<span class="ident" id="5624281">g</span><span class="op" id="5624282">.</span><span class="ident" id="5624283">LoopCount</span>&nbsp;<span class="op" id="5624293">&lt;</span>&nbsp;<span class="num" id="5624295">0</span>&nbsp;<span class="op" id="5624297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5624301">g</span><span class="op" id="5624302">.</span><span class="ident" id="5624303">LoopCount</span>&nbsp;<span class="op" id="5624313">=</span>&nbsp;<span class="num" id="5624315">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5624318">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5624322">e</span>&nbsp;<span class="op" id="5624324">:=</span>&nbsp;<span class="ident" id="5624327">encoder</span><span class="op" id="5624334">{</span><span class="ident" id="5624335">g</span><span class="op" id="5624336">:</span>&nbsp;<span class="ident" id="5624338">g</span><span class="op" id="5624339">}</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5624342">if</span>&nbsp;<span class="ident" id="5624345">ww</span><span class="op" id="5624347">,</span>&nbsp;<span class="ident" id="5624349">ok</span>&nbsp;<span class="op" id="5624352">:=</span>&nbsp;<span class="ident" id="5624355">w</span><span class="op" id="5624356">.</span><span class="op" id="5624357">(</span><span class="ident" id="5624358">writer</span><span class="op" id="5624364">)</span><span class="op" id="5624365">;</span>&nbsp;<span class="ident" id="5624367">ok</span>&nbsp;<span class="op" id="5624370">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5624374">e</span><span class="op" id="5624375">.</span><span class="ident" id="5624376">w</span>&nbsp;<span class="op" id="5624378">=</span>&nbsp;<span class="ident" id="5624380">ww</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5624384">}</span>&nbsp;<span class="keyword" id="5624386">else</span>&nbsp;<span class="op" id="5624391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5624395">e</span><span class="op" id="5624396">.</span><span class="ident" id="5624397">w</span>&nbsp;<span class="op" id="5624399">=</span>&nbsp;<span class="ident" id="5624401">bufio</span><span class="op" id="5624406">.</span><span class="ident" id="5624407">NewWriter</span><span class="op" id="5624416">(</span><span class="ident" id="5624417">w</span><span class="op" id="5624418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5624421">}</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5624425">e</span><span class="op" id="5624426">.</span><span class="ident" id="5624427">writeHeader</span><span class="op" id="5624438">(</span><span class="op" id="5624439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5624442">for</span>&nbsp;<span class="ident" id="5624446">i</span><span class="op" id="5624447">,</span>&nbsp;<span class="ident" id="5624449">pm</span>&nbsp;<span class="op" id="5624452">:=</span>&nbsp;<span class="keyword" id="5624455">range</span>&nbsp;<span class="ident" id="5624461">g</span><span class="op" id="5624462">.</span><span class="ident" id="5624463">Image</span>&nbsp;<span class="op" id="5624469">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5624473">e</span><span class="op" id="5624474">.</span><span class="ident" id="5624475">writeImageBlock</span><span class="op" id="5624490">(</span><span class="ident" id="5624491">pm</span><span class="op" id="5624493">,</span>&nbsp;<span class="ident" id="5624495">g</span><span class="op" id="5624496">.</span><span class="ident" id="5624497">Delay</span><span class="op" id="5624502">[</span><span class="ident" id="5624503">i</span><span class="op" id="5624504">]</span><span class="op" id="5624505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5624508">}</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5624511">e</span><span class="op" id="5624512">.</span><span class="ident" id="5624513">writeByte</span><span class="op" id="5624522">(</span><span class="ident" id="5624523">sTrailer</span><span class="op" id="5624531">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5624534">e</span><span class="op" id="5624535">.</span><span class="ident" id="5624536">flush</span><span class="op" id="5624541">(</span><span class="op" id="5624542">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5624545">return</span>&nbsp;<span class="ident" id="5624552">e</span><span class="op" id="5624553">.</span><span class="ident" id="5624554">err</span><br>
<span class="lineno"></span><span class="op" id="5624558">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span><span class="comment" id="5624561">//&nbsp;Encode&nbsp;writes&nbsp;the&nbsp;Image&nbsp;m&nbsp;to&nbsp;w&nbsp;in&nbsp;GIF&nbsp;format.</span><br>
<span class="lineno"></span><span class="keyword" id="5624610">func</span>&nbsp;<span class="ident" id="5624615">Encode</span><span class="op" id="5624621">(</span><span class="ident" id="5624622">w</span>&nbsp;<span class="ident" id="5624624">io</span><span class="op" id="5624626">.</span><span class="ident" id="5624627">Writer</span><span class="op" id="5624633">,</span>&nbsp;<span class="ident" id="5624635">m</span>&nbsp;<span class="ident" id="5624637">image</span><span class="op" id="5624642">.</span><span class="ident" id="5624643">Image</span><span class="op" id="5624648">,</span>&nbsp;<span class="ident" id="5624650">o</span>&nbsp;<span class="op" id="5624652">*</span><span class="ident" id="5624653">Options</span><span class="op" id="5624660">)</span>&nbsp;<span class="builtintype" id="5624662">error</span>&nbsp;<span class="op" id="5624668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5624671">//&nbsp;Check&nbsp;for&nbsp;bounds&nbsp;and&nbsp;size&nbsp;restrictions.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5624715">b</span>&nbsp;<span class="op" id="5624717">:=</span>&nbsp;<span class="ident" id="5624720">m</span><span class="op" id="5624721">.</span><span class="ident" id="5624722">Bounds</span><span class="op" id="5624728">(</span><span class="op" id="5624729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5624732">if</span>&nbsp;<span class="ident" id="5624735">b</span><span class="op" id="5624736">.</span><span class="ident" id="5624737">Dx</span><span class="op" id="5624739">(</span><span class="op" id="5624740">)</span>&nbsp;<span class="op" id="5624742">&gt;=</span>&nbsp;<span class="num" id="5624745">1</span><span class="op" id="5624746">&lt;&lt;</span><span class="num" id="5624748">16</span>&nbsp;<span class="op" id="5624751">||</span>&nbsp;<span class="ident" id="5624754">b</span><span class="op" id="5624755">.</span><span class="ident" id="5624756">Dy</span><span class="op" id="5624758">(</span><span class="op" id="5624759">)</span>&nbsp;<span class="op" id="5624761">&gt;=</span>&nbsp;<span class="num" id="5624764">1</span><span class="op" id="5624765">&lt;&lt;</span><span class="num" id="5624767">16</span>&nbsp;<span class="op" id="5624770">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5624774">return</span>&nbsp;<span class="ident" id="5624781">errors</span><span class="op" id="5624787">.</span><span class="ident" id="5624788">New</span><span class="op" id="5624791">(</span><span class="string" id="5624792">&#34;gif:&nbsp;image&nbsp;is&nbsp;too&nbsp;large&nbsp;to&nbsp;encode&#34;</span><span class="op" id="5624827">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5624830">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5624834">opts</span>&nbsp;<span class="op" id="5624839">:=</span>&nbsp;<span class="ident" id="5624842">Options</span><span class="op" id="5624849">{</span><span class="op" id="5624850">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5624853">if</span>&nbsp;<span class="ident" id="5624856">o</span>&nbsp;<span class="op" id="5624858">!=</span>&nbsp;<span class="ident" id="5624861">nil</span>&nbsp;<span class="op" id="5624865">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5624869">opts</span>&nbsp;<span class="op" id="5624874">=</span>&nbsp;<span class="op" id="5624876">*</span><span class="ident" id="5624877">o</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5624880">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5624883">if</span>&nbsp;<span class="ident" id="5624886">opts</span><span class="op" id="5624890">.</span><span class="ident" id="5624891">NumColors</span>&nbsp;<span class="op" id="5624901">&lt;</span>&nbsp;<span class="num" id="5624903">1</span>&nbsp;<span class="op" id="5624905">||</span>&nbsp;<span class="num" id="5624908">256</span>&nbsp;<span class="op" id="5624912">&lt;</span>&nbsp;<span class="ident" id="5624914">opts</span><span class="op" id="5624918">.</span><span class="ident" id="5624919">NumColors</span>&nbsp;<span class="op" id="5624929">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5624933">opts</span><span class="op" id="5624937">.</span><span class="ident" id="5624938">NumColors</span>&nbsp;<span class="op" id="5624948">=</span>&nbsp;<span class="num" id="5624950">256</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5624955">}</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5624958">if</span>&nbsp;<span class="ident" id="5624961">opts</span><span class="op" id="5624965">.</span><span class="ident" id="5624966">Drawer</span>&nbsp;<span class="op" id="5624973">==</span>&nbsp;<span class="ident" id="5624976">nil</span>&nbsp;<span class="op" id="5624980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5624984">opts</span><span class="op" id="5624988">.</span><span class="ident" id="5624989">Drawer</span>&nbsp;<span class="op" id="5624996">=</span>&nbsp;<span class="ident" id="5624998">draw</span><span class="op" id="5625002">.</span><span class="ident" id="5625003">FloydSteinberg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5625019">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5625023">pm</span><span class="op" id="5625025">,</span>&nbsp;<span class="ident" id="5625027">ok</span>&nbsp;<span class="op" id="5625030">:=</span>&nbsp;<span class="ident" id="5625033">m</span><span class="op" id="5625034">.</span><span class="op" id="5625035">(</span><span class="op" id="5625036">*</span><span class="ident" id="5625037">image</span><span class="op" id="5625042">.</span><span class="ident" id="5625043">Paletted</span><span class="op" id="5625051">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5625054">if</span>&nbsp;<span class="op" id="5625057">!</span><span class="ident" id="5625058">ok</span>&nbsp;<span class="op" id="5625061">||</span>&nbsp;<span class="builtinfunc" id="5625064">len</span><span class="op" id="5625067">(</span><span class="ident" id="5625068">pm</span><span class="op" id="5625070">.</span><span class="ident" id="5625071">Palette</span><span class="op" id="5625078">)</span>&nbsp;<span class="op" id="5625080">&gt;</span>&nbsp;<span class="ident" id="5625082">opts</span><span class="op" id="5625086">.</span><span class="ident" id="5625087">NumColors</span>&nbsp;<span class="op" id="5625097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5625101">//&nbsp;TODO:&nbsp;Pick&nbsp;a&nbsp;better&nbsp;sub-sample&nbsp;of&nbsp;the&nbsp;Plan&nbsp;9&nbsp;palette.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5625160">pm</span>&nbsp;<span class="op" id="5625163">=</span>&nbsp;<span class="ident" id="5625165">image</span><span class="op" id="5625170">.</span><span class="ident" id="5625171">NewPaletted</span><span class="op" id="5625182">(</span><span class="ident" id="5625183">b</span><span class="op" id="5625184">,</span>&nbsp;<span class="ident" id="5625186">palette</span><span class="op" id="5625193">.</span><span class="ident" id="5625194">Plan9</span><span class="op" id="5625199">[</span><span class="op" id="5625200">:</span><span class="ident" id="5625201">opts</span><span class="op" id="5625205">.</span><span class="ident" id="5625206">NumColors</span><span class="op" id="5625215">]</span><span class="op" id="5625216">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5625220">if</span>&nbsp;<span class="ident" id="5625223">opts</span><span class="op" id="5625227">.</span><span class="ident" id="5625228">Quantizer</span>&nbsp;<span class="op" id="5625238">!=</span>&nbsp;<span class="ident" id="5625241">nil</span>&nbsp;<span class="op" id="5625245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5625250">pm</span><span class="op" id="5625252">.</span><span class="ident" id="5625253">Palette</span>&nbsp;<span class="op" id="5625261">=</span>&nbsp;<span class="ident" id="5625263">opts</span><span class="op" id="5625267">.</span><span class="ident" id="5625268">Quantizer</span><span class="op" id="5625277">.</span><span class="ident" id="5625278">Quantize</span><span class="op" id="5625286">(</span><span class="builtinfunc" id="5625287">make</span><span class="op" id="5625291">(</span><span class="ident" id="5625292">color</span><span class="op" id="5625297">.</span><span class="ident" id="5625298">Palette</span><span class="op" id="5625305">,</span>&nbsp;<span class="num" id="5625307">0</span><span class="op" id="5625308">,</span>&nbsp;<span class="ident" id="5625310">opts</span><span class="op" id="5625314">.</span><span class="ident" id="5625315">NumColors</span><span class="op" id="5625324">)</span><span class="op" id="5625325">,</span>&nbsp;<span class="ident" id="5625327">m</span><span class="op" id="5625328">)</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5625332">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5625336">opts</span><span class="op" id="5625340">.</span><span class="ident" id="5625341">Drawer</span><span class="op" id="5625347">.</span><span class="ident" id="5625348">Draw</span><span class="op" id="5625352">(</span><span class="ident" id="5625353">pm</span><span class="op" id="5625355">,</span>&nbsp;<span class="ident" id="5625357">b</span><span class="op" id="5625358">,</span>&nbsp;<span class="ident" id="5625360">m</span><span class="op" id="5625361">,</span>&nbsp;<span class="ident" id="5625363">image</span><span class="op" id="5625368">.</span><span class="ident" id="5625369">ZP</span><span class="op" id="5625371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5625374">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5625378">return</span>&nbsp;<span class="ident" id="5625385">EncodeAll</span><span class="op" id="5625394">(</span><span class="ident" id="5625395">w</span><span class="op" id="5625396">,</span>&nbsp;<span class="op" id="5625398">&amp;</span><span class="ident" id="5625399">GIF</span><span class="op" id="5625402">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5625406">Image</span><span class="op" id="5625411">:</span>&nbsp;<span class="op" id="5625413">[</span><span class="op" id="5625414">]</span><span class="op" id="5625415">*</span><span class="ident" id="5625416">image</span><span class="op" id="5625421">.</span><span class="ident" id="5625422">Paletted</span><span class="op" id="5625430">{</span><span class="ident" id="5625431">pm</span><span class="op" id="5625433">}</span><span class="op" id="5625434">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5625438">Delay</span><span class="op" id="5625443">:</span>&nbsp;<span class="op" id="5625445">[</span><span class="op" id="5625446">]</span><span class="builtintype" id="5625447">int</span><span class="op" id="5625450">{</span><span class="num" id="5625451">0</span><span class="op" id="5625452">}</span><span class="op" id="5625453">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5625456">}</span><span class="op" id="5625457">)</span><br>
<span class="lineno"></span><span class="op" id="5625459">}</span>
</div>
</body>
</html>
