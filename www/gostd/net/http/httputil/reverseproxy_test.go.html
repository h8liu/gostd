<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/httputil</h2>
<ul>
<li><a href="/gostd/net/http/httputil/dump.go.html">dump.go</a></li>
<li><a href="/gostd/net/http/httputil/dump_test.go.html">dump_test.go</a></li>
<li><a href="/gostd/net/http/httputil/httputil.go.html">httputil.go</a></li>
<li><a href="/gostd/net/http/httputil/persist.go.html">persist.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy.go.html">reverseproxy.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy_test.go.html" class="current">reverseproxy_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6578007">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6578062">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6578116">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="6578167">//&nbsp;Reverse&nbsp;proxy&nbsp;tests.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6578192">package</span>&nbsp;<span class="ident" id="6578200">httputil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6578210">import</span>&nbsp;<span class="op" id="6578217">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6578220">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6578233">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6578245">&#34;net/http/httptest&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6578266">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6578277">&#34;strings&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6578288">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6578299">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="6578306">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6578309">const</span>&nbsp;<span class="ident" id="6578315">fakeHopHeader</span>&nbsp;<span class="op" id="6578329">=</span>&nbsp;<span class="string" id="6578331">&#34;X-Fake-Hop-Header-For-Test&#34;</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="6578361">func</span>&nbsp;<span class="ident" id="6578366">init</span><span class="op" id="6578370">(</span><span class="op" id="6578371">)</span>&nbsp;<span class="op" id="6578373">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6578376">hopHeaders</span>&nbsp;<span class="op" id="6578387">=</span>&nbsp;<span class="builtinfunc" id="6578389">append</span><span class="op" id="6578395">(</span><span class="ident" id="6578396">hopHeaders</span><span class="op" id="6578406">,</span>&nbsp;<span class="ident" id="6578408">fakeHopHeader</span><span class="op" id="6578421">)</span><br>
<span class="lineno"></span><span class="op" id="6578423">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="6578426">func</span>&nbsp;<span class="ident" id="6578431">TestReverseProxy</span><span class="op" id="6578447">(</span><span class="ident" id="6578448">t</span>&nbsp;<span class="op" id="6578450">*</span><span class="ident" id="6578451">testing</span><span class="op" id="6578458">.</span><span class="ident" id="6578459">T</span><span class="op" id="6578460">)</span>&nbsp;<span class="op" id="6578462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6578465">const</span>&nbsp;<span class="ident" id="6578471">backendResponse</span>&nbsp;<span class="op" id="6578487">=</span>&nbsp;<span class="string" id="6578489">&#34;I&nbsp;am&nbsp;the&nbsp;backend&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6578509">const</span>&nbsp;<span class="ident" id="6578515">backendStatus</span>&nbsp;<span class="op" id="6578529">=</span>&nbsp;<span class="num" id="6578531">404</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6578536">backend</span>&nbsp;<span class="op" id="6578544">:=</span>&nbsp;<span class="ident" id="6578547">httptest</span><span class="op" id="6578555">.</span><span class="ident" id="6578556">NewServer</span><span class="op" id="6578565">(</span><span class="ident" id="6578566">http</span><span class="op" id="6578570">.</span><span class="ident" id="6578571">HandlerFunc</span><span class="op" id="6578582">(</span><span class="keyword" id="6578583">func</span><span class="op" id="6578587">(</span><span class="ident" id="6578588">w</span>&nbsp;<span class="ident" id="6578590">http</span><span class="op" id="6578594">.</span><span class="ident" id="6578595">ResponseWriter</span><span class="op" id="6578609">,</span>&nbsp;<span class="ident" id="6578611">r</span>&nbsp;<span class="op" id="6578613">*</span><span class="ident" id="6578614">http</span><span class="op" id="6578618">.</span><span class="ident" id="6578619">Request</span><span class="op" id="6578626">)</span>&nbsp;<span class="op" id="6578628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6578632">if</span>&nbsp;<span class="builtinfunc" id="6578635">len</span><span class="op" id="6578638">(</span><span class="ident" id="6578639">r</span><span class="op" id="6578640">.</span><span class="ident" id="6578641">TransferEncoding</span><span class="op" id="6578657">)</span>&nbsp;<span class="op" id="6578659">&gt;</span>&nbsp;<span class="num" id="6578661">0</span>&nbsp;<span class="op" id="6578663">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6578668">t</span><span class="op" id="6578669">.</span><span class="ident" id="6578670">Errorf</span><span class="op" id="6578676">(</span><span class="string" id="6578677">&#34;backend&nbsp;got&nbsp;unexpected&nbsp;TransferEncoding:&nbsp;%v&#34;</span><span class="op" id="6578722">,</span>&nbsp;<span class="ident" id="6578724">r</span><span class="op" id="6578725">.</span><span class="ident" id="6578726">TransferEncoding</span><span class="op" id="6578742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6578746">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6578750">if</span>&nbsp;<span class="ident" id="6578753">r</span><span class="op" id="6578754">.</span><span class="ident" id="6578755">Header</span><span class="op" id="6578761">.</span><span class="ident" id="6578762">Get</span><span class="op" id="6578765">(</span><span class="string" id="6578766">&#34;X-Forwarded-For&#34;</span><span class="op" id="6578783">)</span>&nbsp;<span class="op" id="6578785">==</span>&nbsp;<span class="string" id="6578788">&#34;&#34;</span>&nbsp;<span class="op" id="6578791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6578796">t</span><span class="op" id="6578797">.</span><span class="ident" id="6578798">Errorf</span><span class="op" id="6578804">(</span><span class="string" id="6578805">&#34;didn&#39;t&nbsp;get&nbsp;X-Forwarded-For&nbsp;header&#34;</span><span class="op" id="6578840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6578844">}</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6578848">if</span>&nbsp;<span class="ident" id="6578851">c</span>&nbsp;<span class="op" id="6578853">:=</span>&nbsp;<span class="ident" id="6578856">r</span><span class="op" id="6578857">.</span><span class="ident" id="6578858">Header</span><span class="op" id="6578864">.</span><span class="ident" id="6578865">Get</span><span class="op" id="6578868">(</span><span class="string" id="6578869">&#34;Connection&#34;</span><span class="op" id="6578881">)</span><span class="op" id="6578882">;</span>&nbsp;<span class="ident" id="6578884">c</span>&nbsp;<span class="op" id="6578886">!=</span>&nbsp;<span class="string" id="6578889">&#34;&#34;</span>&nbsp;<span class="op" id="6578892">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6578897">t</span><span class="op" id="6578898">.</span><span class="ident" id="6578899">Errorf</span><span class="op" id="6578905">(</span><span class="string" id="6578906">&#34;handler&nbsp;got&nbsp;Connection&nbsp;header&nbsp;value&nbsp;%q&#34;</span><span class="op" id="6578946">,</span>&nbsp;<span class="ident" id="6578948">c</span><span class="op" id="6578949">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6578953">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6578957">if</span>&nbsp;<span class="ident" id="6578960">c</span>&nbsp;<span class="op" id="6578962">:=</span>&nbsp;<span class="ident" id="6578965">r</span><span class="op" id="6578966">.</span><span class="ident" id="6578967">Header</span><span class="op" id="6578973">.</span><span class="ident" id="6578974">Get</span><span class="op" id="6578977">(</span><span class="string" id="6578978">&#34;Upgrade&#34;</span><span class="op" id="6578987">)</span><span class="op" id="6578988">;</span>&nbsp;<span class="ident" id="6578990">c</span>&nbsp;<span class="op" id="6578992">!=</span>&nbsp;<span class="string" id="6578995">&#34;&#34;</span>&nbsp;<span class="op" id="6578998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6579003">t</span><span class="op" id="6579004">.</span><span class="ident" id="6579005">Errorf</span><span class="op" id="6579011">(</span><span class="string" id="6579012">&#34;handler&nbsp;got&nbsp;Upgrade&nbsp;header&nbsp;value&nbsp;%q&#34;</span><span class="op" id="6579049">,</span>&nbsp;<span class="ident" id="6579051">c</span><span class="op" id="6579052">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6579056">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6579060">if</span>&nbsp;<span class="ident" id="6579063">g</span><span class="op" id="6579064">,</span>&nbsp;<span class="ident" id="6579066">e</span>&nbsp;<span class="op" id="6579068">:=</span>&nbsp;<span class="ident" id="6579071">r</span><span class="op" id="6579072">.</span><span class="ident" id="6579073">Host</span><span class="op" id="6579077">,</span>&nbsp;<span class="string" id="6579079">&#34;some-name&#34;</span><span class="op" id="6579090">;</span>&nbsp;<span class="ident" id="6579092">g</span>&nbsp;<span class="op" id="6579094">!=</span>&nbsp;<span class="ident" id="6579097">e</span>&nbsp;<span class="op" id="6579099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6579104">t</span><span class="op" id="6579105">.</span><span class="ident" id="6579106">Errorf</span><span class="op" id="6579112">(</span><span class="string" id="6579113">&#34;backend&nbsp;got&nbsp;Host&nbsp;header&nbsp;%q,&nbsp;want&nbsp;%q&#34;</span><span class="op" id="6579150">,</span>&nbsp;<span class="ident" id="6579152">g</span><span class="op" id="6579153">,</span>&nbsp;<span class="ident" id="6579155">e</span><span class="op" id="6579156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6579160">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6579164">w</span><span class="op" id="6579165">.</span><span class="ident" id="6579166">Header</span><span class="op" id="6579172">(</span><span class="op" id="6579173">)</span><span class="op" id="6579174">.</span><span class="ident" id="6579175">Set</span><span class="op" id="6579178">(</span><span class="string" id="6579179">&#34;X-Foo&#34;</span><span class="op" id="6579186">,</span>&nbsp;<span class="string" id="6579188">&#34;bar&#34;</span><span class="op" id="6579193">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6579197">w</span><span class="op" id="6579198">.</span><span class="ident" id="6579199">Header</span><span class="op" id="6579205">(</span><span class="op" id="6579206">)</span><span class="op" id="6579207">.</span><span class="ident" id="6579208">Set</span><span class="op" id="6579211">(</span><span class="string" id="6579212">&#34;Upgrade&#34;</span><span class="op" id="6579221">,</span>&nbsp;<span class="string" id="6579223">&#34;foo&#34;</span><span class="op" id="6579228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6579232">w</span><span class="op" id="6579233">.</span><span class="ident" id="6579234">Header</span><span class="op" id="6579240">(</span><span class="op" id="6579241">)</span><span class="op" id="6579242">.</span><span class="ident" id="6579243">Set</span><span class="op" id="6579246">(</span><span class="ident" id="6579247">fakeHopHeader</span><span class="op" id="6579260">,</span>&nbsp;<span class="string" id="6579262">&#34;foo&#34;</span><span class="op" id="6579267">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6579271">w</span><span class="op" id="6579272">.</span><span class="ident" id="6579273">Header</span><span class="op" id="6579279">(</span><span class="op" id="6579280">)</span><span class="op" id="6579281">.</span><span class="ident" id="6579282">Add</span><span class="op" id="6579285">(</span><span class="string" id="6579286">&#34;X-Multi-Value&#34;</span><span class="op" id="6579301">,</span>&nbsp;<span class="string" id="6579303">&#34;foo&#34;</span><span class="op" id="6579308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6579312">w</span><span class="op" id="6579313">.</span><span class="ident" id="6579314">Header</span><span class="op" id="6579320">(</span><span class="op" id="6579321">)</span><span class="op" id="6579322">.</span><span class="ident" id="6579323">Add</span><span class="op" id="6579326">(</span><span class="string" id="6579327">&#34;X-Multi-Value&#34;</span><span class="op" id="6579342">,</span>&nbsp;<span class="string" id="6579344">&#34;bar&#34;</span><span class="op" id="6579349">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6579353">http</span><span class="op" id="6579357">.</span><span class="ident" id="6579358">SetCookie</span><span class="op" id="6579367">(</span><span class="ident" id="6579368">w</span><span class="op" id="6579369">,</span>&nbsp;<span class="op" id="6579371">&amp;</span><span class="ident" id="6579372">http</span><span class="op" id="6579376">.</span><span class="ident" id="6579377">Cookie</span><span class="op" id="6579383">{</span><span class="ident" id="6579384">Name</span><span class="op" id="6579388">:</span>&nbsp;<span class="string" id="6579390">&#34;flavor&#34;</span><span class="op" id="6579398">,</span>&nbsp;<span class="ident" id="6579400">Value</span><span class="op" id="6579405">:</span>&nbsp;<span class="string" id="6579407">&#34;chocolateChip&#34;</span><span class="op" id="6579422">}</span><span class="op" id="6579423">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6579427">w</span><span class="op" id="6579428">.</span><span class="ident" id="6579429">WriteHeader</span><span class="op" id="6579440">(</span><span class="ident" id="6579441">backendStatus</span><span class="op" id="6579454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6579458">w</span><span class="op" id="6579459">.</span><span class="ident" id="6579460">Write</span><span class="op" id="6579465">(</span><span class="op" id="6579466">[</span><span class="op" id="6579467">]</span><span class="builtintype" id="6579468">byte</span><span class="op" id="6579472">(</span><span class="ident" id="6579473">backendResponse</span><span class="op" id="6579488">)</span><span class="op" id="6579489">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6579492">}</span><span class="op" id="6579493">)</span><span class="op" id="6579494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6579497">defer</span>&nbsp;<span class="ident" id="6579503">backend</span><span class="op" id="6579510">.</span><span class="ident" id="6579511">Close</span><span class="op" id="6579516">(</span><span class="op" id="6579517">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6579520">backendURL</span><span class="op" id="6579530">,</span>&nbsp;<span class="ident" id="6579532">err</span>&nbsp;<span class="op" id="6579536">:=</span>&nbsp;<span class="ident" id="6579539">url</span><span class="op" id="6579542">.</span><span class="ident" id="6579543">Parse</span><span class="op" id="6579548">(</span><span class="ident" id="6579549">backend</span><span class="op" id="6579556">.</span><span class="ident" id="6579557">URL</span><span class="op" id="6579560">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6579563">if</span>&nbsp;<span class="ident" id="6579566">err</span>&nbsp;<span class="op" id="6579570">!=</span>&nbsp;<span class="builtintype" id="6579573">nil</span>&nbsp;<span class="op" id="6579577">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6579581">t</span><span class="op" id="6579582">.</span><span class="ident" id="6579583">Fatal</span><span class="op" id="6579588">(</span><span class="ident" id="6579589">err</span><span class="op" id="6579592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6579595">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6579598">proxyHandler</span>&nbsp;<span class="op" id="6579611">:=</span>&nbsp;<span class="ident" id="6579614">NewSingleHostReverseProxy</span><span class="op" id="6579639">(</span><span class="ident" id="6579640">backendURL</span><span class="op" id="6579650">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6579653">frontend</span>&nbsp;<span class="op" id="6579662">:=</span>&nbsp;<span class="ident" id="6579665">httptest</span><span class="op" id="6579673">.</span><span class="ident" id="6579674">NewServer</span><span class="op" id="6579683">(</span><span class="ident" id="6579684">proxyHandler</span><span class="op" id="6579696">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6579699">defer</span>&nbsp;<span class="ident" id="6579705">frontend</span><span class="op" id="6579713">.</span><span class="ident" id="6579714">Close</span><span class="op" id="6579719">(</span><span class="op" id="6579720">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6579724">getReq</span><span class="op" id="6579730">,</span>&nbsp;<span class="ident" id="6579732">_</span>&nbsp;<span class="op" id="6579734">:=</span>&nbsp;<span class="ident" id="6579737">http</span><span class="op" id="6579741">.</span><span class="ident" id="6579742">NewRequest</span><span class="op" id="6579752">(</span><span class="string" id="6579753">&#34;GET&#34;</span><span class="op" id="6579758">,</span>&nbsp;<span class="ident" id="6579760">frontend</span><span class="op" id="6579768">.</span><span class="ident" id="6579769">URL</span><span class="op" id="6579772">,</span>&nbsp;<span class="builtintype" id="6579774">nil</span><span class="op" id="6579777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6579780">getReq</span><span class="op" id="6579786">.</span><span class="ident" id="6579787">Host</span>&nbsp;<span class="op" id="6579792">=</span>&nbsp;<span class="string" id="6579794">&#34;some-name&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6579807">getReq</span><span class="op" id="6579813">.</span><span class="ident" id="6579814">Header</span><span class="op" id="6579820">.</span><span class="ident" id="6579821">Set</span><span class="op" id="6579824">(</span><span class="string" id="6579825">&#34;Connection&#34;</span><span class="op" id="6579837">,</span>&nbsp;<span class="string" id="6579839">&#34;close&#34;</span><span class="op" id="6579846">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6579849">getReq</span><span class="op" id="6579855">.</span><span class="ident" id="6579856">Header</span><span class="op" id="6579862">.</span><span class="ident" id="6579863">Set</span><span class="op" id="6579866">(</span><span class="string" id="6579867">&#34;Upgrade&#34;</span><span class="op" id="6579876">,</span>&nbsp;<span class="string" id="6579878">&#34;foo&#34;</span><span class="op" id="6579883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6579886">getReq</span><span class="op" id="6579892">.</span><span class="ident" id="6579893">Close</span>&nbsp;<span class="op" id="6579899">=</span>&nbsp;<span class="builtintype" id="6579901">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6579907">res</span><span class="op" id="6579910">,</span>&nbsp;<span class="ident" id="6579912">err</span>&nbsp;<span class="op" id="6579916">:=</span>&nbsp;<span class="ident" id="6579919">http</span><span class="op" id="6579923">.</span><span class="ident" id="6579924">DefaultClient</span><span class="op" id="6579937">.</span><span class="ident" id="6579938">Do</span><span class="op" id="6579940">(</span><span class="ident" id="6579941">getReq</span><span class="op" id="6579947">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6579950">if</span>&nbsp;<span class="ident" id="6579953">err</span>&nbsp;<span class="op" id="6579957">!=</span>&nbsp;<span class="builtintype" id="6579960">nil</span>&nbsp;<span class="op" id="6579964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6579968">t</span><span class="op" id="6579969">.</span><span class="ident" id="6579970">Fatalf</span><span class="op" id="6579976">(</span><span class="string" id="6579977">&#34;Get:&nbsp;%v&#34;</span><span class="op" id="6579986">,</span>&nbsp;<span class="ident" id="6579988">err</span><span class="op" id="6579991">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6579994">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6579997">if</span>&nbsp;<span class="ident" id="6580000">g</span><span class="op" id="6580001">,</span>&nbsp;<span class="ident" id="6580003">e</span>&nbsp;<span class="op" id="6580005">:=</span>&nbsp;<span class="ident" id="6580008">res</span><span class="op" id="6580011">.</span><span class="ident" id="6580012">StatusCode</span><span class="op" id="6580022">,</span>&nbsp;<span class="ident" id="6580024">backendStatus</span><span class="op" id="6580037">;</span>&nbsp;<span class="ident" id="6580039">g</span>&nbsp;<span class="op" id="6580041">!=</span>&nbsp;<span class="ident" id="6580044">e</span>&nbsp;<span class="op" id="6580046">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6580050">t</span><span class="op" id="6580051">.</span><span class="ident" id="6580052">Errorf</span><span class="op" id="6580058">(</span><span class="string" id="6580059">&#34;got&nbsp;res.StatusCode&nbsp;%d;&nbsp;expected&nbsp;%d&#34;</span><span class="op" id="6580095">,</span>&nbsp;<span class="ident" id="6580097">g</span><span class="op" id="6580098">,</span>&nbsp;<span class="ident" id="6580100">e</span><span class="op" id="6580101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6580104">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6580107">if</span>&nbsp;<span class="ident" id="6580110">g</span><span class="op" id="6580111">,</span>&nbsp;<span class="ident" id="6580113">e</span>&nbsp;<span class="op" id="6580115">:=</span>&nbsp;<span class="ident" id="6580118">res</span><span class="op" id="6580121">.</span><span class="ident" id="6580122">Header</span><span class="op" id="6580128">.</span><span class="ident" id="6580129">Get</span><span class="op" id="6580132">(</span><span class="string" id="6580133">&#34;X-Foo&#34;</span><span class="op" id="6580140">)</span><span class="op" id="6580141">,</span>&nbsp;<span class="string" id="6580143">&#34;bar&#34;</span><span class="op" id="6580148">;</span>&nbsp;<span class="ident" id="6580150">g</span>&nbsp;<span class="op" id="6580152">!=</span>&nbsp;<span class="ident" id="6580155">e</span>&nbsp;<span class="op" id="6580157">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6580161">t</span><span class="op" id="6580162">.</span><span class="ident" id="6580163">Errorf</span><span class="op" id="6580169">(</span><span class="string" id="6580170">&#34;got&nbsp;X-Foo&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="6580197">,</span>&nbsp;<span class="ident" id="6580199">g</span><span class="op" id="6580200">,</span>&nbsp;<span class="ident" id="6580202">e</span><span class="op" id="6580203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6580206">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6580209">if</span>&nbsp;<span class="ident" id="6580212">c</span>&nbsp;<span class="op" id="6580214">:=</span>&nbsp;<span class="ident" id="6580217">res</span><span class="op" id="6580220">.</span><span class="ident" id="6580221">Header</span><span class="op" id="6580227">.</span><span class="ident" id="6580228">Get</span><span class="op" id="6580231">(</span><span class="ident" id="6580232">fakeHopHeader</span><span class="op" id="6580245">)</span><span class="op" id="6580246">;</span>&nbsp;<span class="ident" id="6580248">c</span>&nbsp;<span class="op" id="6580250">!=</span>&nbsp;<span class="string" id="6580253">&#34;&#34;</span>&nbsp;<span class="op" id="6580256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6580260">t</span><span class="op" id="6580261">.</span><span class="ident" id="6580262">Errorf</span><span class="op" id="6580268">(</span><span class="string" id="6580269">&#34;got&nbsp;%s&nbsp;header&nbsp;value&nbsp;%q&#34;</span><span class="op" id="6580293">,</span>&nbsp;<span class="ident" id="6580295">fakeHopHeader</span><span class="op" id="6580308">,</span>&nbsp;<span class="ident" id="6580310">c</span><span class="op" id="6580311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6580314">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6580317">if</span>&nbsp;<span class="ident" id="6580320">g</span><span class="op" id="6580321">,</span>&nbsp;<span class="ident" id="6580323">e</span>&nbsp;<span class="op" id="6580325">:=</span>&nbsp;<span class="builtinfunc" id="6580328">len</span><span class="op" id="6580331">(</span><span class="ident" id="6580332">res</span><span class="op" id="6580335">.</span><span class="ident" id="6580336">Header</span><span class="op" id="6580342">[</span><span class="string" id="6580343">&#34;X-Multi-Value&#34;</span><span class="op" id="6580358">]</span><span class="op" id="6580359">)</span><span class="op" id="6580360">,</span>&nbsp;<span class="num" id="6580362">2</span><span class="op" id="6580363">;</span>&nbsp;<span class="ident" id="6580365">g</span>&nbsp;<span class="op" id="6580367">!=</span>&nbsp;<span class="ident" id="6580370">e</span>&nbsp;<span class="op" id="6580372">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6580376">t</span><span class="op" id="6580377">.</span><span class="ident" id="6580378">Errorf</span><span class="op" id="6580384">(</span><span class="string" id="6580385">&#34;got&nbsp;%d&nbsp;X-Multi-Value&nbsp;header&nbsp;values;&nbsp;expected&nbsp;%d&#34;</span><span class="op" id="6580434">,</span>&nbsp;<span class="ident" id="6580436">g</span><span class="op" id="6580437">,</span>&nbsp;<span class="ident" id="6580439">e</span><span class="op" id="6580440">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6580443">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6580446">if</span>&nbsp;<span class="ident" id="6580449">g</span><span class="op" id="6580450">,</span>&nbsp;<span class="ident" id="6580452">e</span>&nbsp;<span class="op" id="6580454">:=</span>&nbsp;<span class="builtinfunc" id="6580457">len</span><span class="op" id="6580460">(</span><span class="ident" id="6580461">res</span><span class="op" id="6580464">.</span><span class="ident" id="6580465">Header</span><span class="op" id="6580471">[</span><span class="string" id="6580472">&#34;Set-Cookie&#34;</span><span class="op" id="6580484">]</span><span class="op" id="6580485">)</span><span class="op" id="6580486">,</span>&nbsp;<span class="num" id="6580488">1</span><span class="op" id="6580489">;</span>&nbsp;<span class="ident" id="6580491">g</span>&nbsp;<span class="op" id="6580493">!=</span>&nbsp;<span class="ident" id="6580496">e</span>&nbsp;<span class="op" id="6580498">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6580502">t</span><span class="op" id="6580503">.</span><span class="ident" id="6580504">Fatalf</span><span class="op" id="6580510">(</span><span class="string" id="6580511">&#34;got&nbsp;%d&nbsp;SetCookies,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="6580539">,</span>&nbsp;<span class="ident" id="6580541">g</span><span class="op" id="6580542">,</span>&nbsp;<span class="ident" id="6580544">e</span><span class="op" id="6580545">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6580548">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6580551">if</span>&nbsp;<span class="ident" id="6580554">cookie</span>&nbsp;<span class="op" id="6580561">:=</span>&nbsp;<span class="ident" id="6580564">res</span><span class="op" id="6580567">.</span><span class="ident" id="6580568">Cookies</span><span class="op" id="6580575">(</span><span class="op" id="6580576">)</span><span class="op" id="6580577">[</span><span class="num" id="6580578">0</span><span class="op" id="6580579">]</span><span class="op" id="6580580">;</span>&nbsp;<span class="ident" id="6580582">cookie</span><span class="op" id="6580588">.</span><span class="ident" id="6580589">Name</span>&nbsp;<span class="op" id="6580594">!=</span>&nbsp;<span class="string" id="6580597">&#34;flavor&#34;</span>&nbsp;<span class="op" id="6580606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6580610">t</span><span class="op" id="6580611">.</span><span class="ident" id="6580612">Errorf</span><span class="op" id="6580618">(</span><span class="string" id="6580619">&#34;unexpected&nbsp;cookie&nbsp;%q&#34;</span><span class="op" id="6580641">,</span>&nbsp;<span class="ident" id="6580643">cookie</span><span class="op" id="6580649">.</span><span class="ident" id="6580650">Name</span><span class="op" id="6580654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6580657">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6580660">bodyBytes</span><span class="op" id="6580669">,</span>&nbsp;<span class="ident" id="6580671">_</span>&nbsp;<span class="op" id="6580673">:=</span>&nbsp;<span class="ident" id="6580676">ioutil</span><span class="op" id="6580682">.</span><span class="ident" id="6580683">ReadAll</span><span class="op" id="6580690">(</span><span class="ident" id="6580691">res</span><span class="op" id="6580694">.</span><span class="ident" id="6580695">Body</span><span class="op" id="6580699">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6580702">if</span>&nbsp;<span class="ident" id="6580705">g</span><span class="op" id="6580706">,</span>&nbsp;<span class="ident" id="6580708">e</span>&nbsp;<span class="op" id="6580710">:=</span>&nbsp;<span class="builtintype" id="6580713">string</span><span class="op" id="6580719">(</span><span class="ident" id="6580720">bodyBytes</span><span class="op" id="6580729">)</span><span class="op" id="6580730">,</span>&nbsp;<span class="ident" id="6580732">backendResponse</span><span class="op" id="6580747">;</span>&nbsp;<span class="ident" id="6580749">g</span>&nbsp;<span class="op" id="6580751">!=</span>&nbsp;<span class="ident" id="6580754">e</span>&nbsp;<span class="op" id="6580756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6580760">t</span><span class="op" id="6580761">.</span><span class="ident" id="6580762">Errorf</span><span class="op" id="6580768">(</span><span class="string" id="6580769">&#34;got&nbsp;body&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="6580795">,</span>&nbsp;<span class="ident" id="6580797">g</span><span class="op" id="6580798">,</span>&nbsp;<span class="ident" id="6580800">e</span><span class="op" id="6580801">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6580804">}</span><br>
<span class="lineno"></span><span class="op" id="6580806">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="keyword" id="6580809">func</span>&nbsp;<span class="ident" id="6580814">TestXForwardedFor</span><span class="op" id="6580831">(</span><span class="ident" id="6580832">t</span>&nbsp;<span class="op" id="6580834">*</span><span class="ident" id="6580835">testing</span><span class="op" id="6580842">.</span><span class="ident" id="6580843">T</span><span class="op" id="6580844">)</span>&nbsp;<span class="op" id="6580846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6580849">const</span>&nbsp;<span class="ident" id="6580855">prevForwardedFor</span>&nbsp;<span class="op" id="6580872">=</span>&nbsp;<span class="string" id="6580874">&#34;client&nbsp;ip&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6580887">const</span>&nbsp;<span class="ident" id="6580893">backendResponse</span>&nbsp;<span class="op" id="6580909">=</span>&nbsp;<span class="string" id="6580911">&#34;I&nbsp;am&nbsp;the&nbsp;backend&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6580931">const</span>&nbsp;<span class="ident" id="6580937">backendStatus</span>&nbsp;<span class="op" id="6580951">=</span>&nbsp;<span class="num" id="6580953">404</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6580958">backend</span>&nbsp;<span class="op" id="6580966">:=</span>&nbsp;<span class="ident" id="6580969">httptest</span><span class="op" id="6580977">.</span><span class="ident" id="6580978">NewServer</span><span class="op" id="6580987">(</span><span class="ident" id="6580988">http</span><span class="op" id="6580992">.</span><span class="ident" id="6580993">HandlerFunc</span><span class="op" id="6581004">(</span><span class="keyword" id="6581005">func</span><span class="op" id="6581009">(</span><span class="ident" id="6581010">w</span>&nbsp;<span class="ident" id="6581012">http</span><span class="op" id="6581016">.</span><span class="ident" id="6581017">ResponseWriter</span><span class="op" id="6581031">,</span>&nbsp;<span class="ident" id="6581033">r</span>&nbsp;<span class="op" id="6581035">*</span><span class="ident" id="6581036">http</span><span class="op" id="6581040">.</span><span class="ident" id="6581041">Request</span><span class="op" id="6581048">)</span>&nbsp;<span class="op" id="6581050">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6581054">if</span>&nbsp;<span class="ident" id="6581057">r</span><span class="op" id="6581058">.</span><span class="ident" id="6581059">Header</span><span class="op" id="6581065">.</span><span class="ident" id="6581066">Get</span><span class="op" id="6581069">(</span><span class="string" id="6581070">&#34;X-Forwarded-For&#34;</span><span class="op" id="6581087">)</span>&nbsp;<span class="op" id="6581089">==</span>&nbsp;<span class="string" id="6581092">&#34;&#34;</span>&nbsp;<span class="op" id="6581095">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6581100">t</span><span class="op" id="6581101">.</span><span class="ident" id="6581102">Errorf</span><span class="op" id="6581108">(</span><span class="string" id="6581109">&#34;didn&#39;t&nbsp;get&nbsp;X-Forwarded-For&nbsp;header&#34;</span><span class="op" id="6581144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6581148">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6581152">if</span>&nbsp;<span class="op" id="6581155">!</span><span class="ident" id="6581156">strings</span><span class="op" id="6581163">.</span><span class="ident" id="6581164">Contains</span><span class="op" id="6581172">(</span><span class="ident" id="6581173">r</span><span class="op" id="6581174">.</span><span class="ident" id="6581175">Header</span><span class="op" id="6581181">.</span><span class="ident" id="6581182">Get</span><span class="op" id="6581185">(</span><span class="string" id="6581186">&#34;X-Forwarded-For&#34;</span><span class="op" id="6581203">)</span><span class="op" id="6581204">,</span>&nbsp;<span class="ident" id="6581206">prevForwardedFor</span><span class="op" id="6581222">)</span>&nbsp;<span class="op" id="6581224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6581229">t</span><span class="op" id="6581230">.</span><span class="ident" id="6581231">Errorf</span><span class="op" id="6581237">(</span><span class="string" id="6581238">&#34;X-Forwarded-For&nbsp;didn&#39;t&nbsp;contain&nbsp;prior&nbsp;data&#34;</span><span class="op" id="6581281">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6581285">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6581289">w</span><span class="op" id="6581290">.</span><span class="ident" id="6581291">WriteHeader</span><span class="op" id="6581302">(</span><span class="ident" id="6581303">backendStatus</span><span class="op" id="6581316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6581320">w</span><span class="op" id="6581321">.</span><span class="ident" id="6581322">Write</span><span class="op" id="6581327">(</span><span class="op" id="6581328">[</span><span class="op" id="6581329">]</span><span class="builtintype" id="6581330">byte</span><span class="op" id="6581334">(</span><span class="ident" id="6581335">backendResponse</span><span class="op" id="6581350">)</span><span class="op" id="6581351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6581354">}</span><span class="op" id="6581355">)</span><span class="op" id="6581356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6581359">defer</span>&nbsp;<span class="ident" id="6581365">backend</span><span class="op" id="6581372">.</span><span class="ident" id="6581373">Close</span><span class="op" id="6581378">(</span><span class="op" id="6581379">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6581382">backendURL</span><span class="op" id="6581392">,</span>&nbsp;<span class="ident" id="6581394">err</span>&nbsp;<span class="op" id="6581398">:=</span>&nbsp;<span class="ident" id="6581401">url</span><span class="op" id="6581404">.</span><span class="ident" id="6581405">Parse</span><span class="op" id="6581410">(</span><span class="ident" id="6581411">backend</span><span class="op" id="6581418">.</span><span class="ident" id="6581419">URL</span><span class="op" id="6581422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6581425">if</span>&nbsp;<span class="ident" id="6581428">err</span>&nbsp;<span class="op" id="6581432">!=</span>&nbsp;<span class="builtintype" id="6581435">nil</span>&nbsp;<span class="op" id="6581439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6581443">t</span><span class="op" id="6581444">.</span><span class="ident" id="6581445">Fatal</span><span class="op" id="6581450">(</span><span class="ident" id="6581451">err</span><span class="op" id="6581454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6581457">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6581460">proxyHandler</span>&nbsp;<span class="op" id="6581473">:=</span>&nbsp;<span class="ident" id="6581476">NewSingleHostReverseProxy</span><span class="op" id="6581501">(</span><span class="ident" id="6581502">backendURL</span><span class="op" id="6581512">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6581515">frontend</span>&nbsp;<span class="op" id="6581524">:=</span>&nbsp;<span class="ident" id="6581527">httptest</span><span class="op" id="6581535">.</span><span class="ident" id="6581536">NewServer</span><span class="op" id="6581545">(</span><span class="ident" id="6581546">proxyHandler</span><span class="op" id="6581558">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6581561">defer</span>&nbsp;<span class="ident" id="6581567">frontend</span><span class="op" id="6581575">.</span><span class="ident" id="6581576">Close</span><span class="op" id="6581581">(</span><span class="op" id="6581582">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6581586">getReq</span><span class="op" id="6581592">,</span>&nbsp;<span class="ident" id="6581594">_</span>&nbsp;<span class="op" id="6581596">:=</span>&nbsp;<span class="ident" id="6581599">http</span><span class="op" id="6581603">.</span><span class="ident" id="6581604">NewRequest</span><span class="op" id="6581614">(</span><span class="string" id="6581615">&#34;GET&#34;</span><span class="op" id="6581620">,</span>&nbsp;<span class="ident" id="6581622">frontend</span><span class="op" id="6581630">.</span><span class="ident" id="6581631">URL</span><span class="op" id="6581634">,</span>&nbsp;<span class="builtintype" id="6581636">nil</span><span class="op" id="6581639">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6581642">getReq</span><span class="op" id="6581648">.</span><span class="ident" id="6581649">Host</span>&nbsp;<span class="op" id="6581654">=</span>&nbsp;<span class="string" id="6581656">&#34;some-name&#34;</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6581669">getReq</span><span class="op" id="6581675">.</span><span class="ident" id="6581676">Header</span><span class="op" id="6581682">.</span><span class="ident" id="6581683">Set</span><span class="op" id="6581686">(</span><span class="string" id="6581687">&#34;Connection&#34;</span><span class="op" id="6581699">,</span>&nbsp;<span class="string" id="6581701">&#34;close&#34;</span><span class="op" id="6581708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6581711">getReq</span><span class="op" id="6581717">.</span><span class="ident" id="6581718">Header</span><span class="op" id="6581724">.</span><span class="ident" id="6581725">Set</span><span class="op" id="6581728">(</span><span class="string" id="6581729">&#34;X-Forwarded-For&#34;</span><span class="op" id="6581746">,</span>&nbsp;<span class="ident" id="6581748">prevForwardedFor</span><span class="op" id="6581764">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6581767">getReq</span><span class="op" id="6581773">.</span><span class="ident" id="6581774">Close</span>&nbsp;<span class="op" id="6581780">=</span>&nbsp;<span class="builtintype" id="6581782">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6581788">res</span><span class="op" id="6581791">,</span>&nbsp;<span class="ident" id="6581793">err</span>&nbsp;<span class="op" id="6581797">:=</span>&nbsp;<span class="ident" id="6581800">http</span><span class="op" id="6581804">.</span><span class="ident" id="6581805">DefaultClient</span><span class="op" id="6581818">.</span><span class="ident" id="6581819">Do</span><span class="op" id="6581821">(</span><span class="ident" id="6581822">getReq</span><span class="op" id="6581828">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6581831">if</span>&nbsp;<span class="ident" id="6581834">err</span>&nbsp;<span class="op" id="6581838">!=</span>&nbsp;<span class="builtintype" id="6581841">nil</span>&nbsp;<span class="op" id="6581845">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6581849">t</span><span class="op" id="6581850">.</span><span class="ident" id="6581851">Fatalf</span><span class="op" id="6581857">(</span><span class="string" id="6581858">&#34;Get:&nbsp;%v&#34;</span><span class="op" id="6581867">,</span>&nbsp;<span class="ident" id="6581869">err</span><span class="op" id="6581872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6581875">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6581878">if</span>&nbsp;<span class="ident" id="6581881">g</span><span class="op" id="6581882">,</span>&nbsp;<span class="ident" id="6581884">e</span>&nbsp;<span class="op" id="6581886">:=</span>&nbsp;<span class="ident" id="6581889">res</span><span class="op" id="6581892">.</span><span class="ident" id="6581893">StatusCode</span><span class="op" id="6581903">,</span>&nbsp;<span class="ident" id="6581905">backendStatus</span><span class="op" id="6581918">;</span>&nbsp;<span class="ident" id="6581920">g</span>&nbsp;<span class="op" id="6581922">!=</span>&nbsp;<span class="ident" id="6581925">e</span>&nbsp;<span class="op" id="6581927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6581931">t</span><span class="op" id="6581932">.</span><span class="ident" id="6581933">Errorf</span><span class="op" id="6581939">(</span><span class="string" id="6581940">&#34;got&nbsp;res.StatusCode&nbsp;%d;&nbsp;expected&nbsp;%d&#34;</span><span class="op" id="6581976">,</span>&nbsp;<span class="ident" id="6581978">g</span><span class="op" id="6581979">,</span>&nbsp;<span class="ident" id="6581981">e</span><span class="op" id="6581982">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6581985">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6581988">bodyBytes</span><span class="op" id="6581997">,</span>&nbsp;<span class="ident" id="6581999">_</span>&nbsp;<span class="op" id="6582001">:=</span>&nbsp;<span class="ident" id="6582004">ioutil</span><span class="op" id="6582010">.</span><span class="ident" id="6582011">ReadAll</span><span class="op" id="6582018">(</span><span class="ident" id="6582019">res</span><span class="op" id="6582022">.</span><span class="ident" id="6582023">Body</span><span class="op" id="6582027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6582030">if</span>&nbsp;<span class="ident" id="6582033">g</span><span class="op" id="6582034">,</span>&nbsp;<span class="ident" id="6582036">e</span>&nbsp;<span class="op" id="6582038">:=</span>&nbsp;<span class="builtintype" id="6582041">string</span><span class="op" id="6582047">(</span><span class="ident" id="6582048">bodyBytes</span><span class="op" id="6582057">)</span><span class="op" id="6582058">,</span>&nbsp;<span class="ident" id="6582060">backendResponse</span><span class="op" id="6582075">;</span>&nbsp;<span class="ident" id="6582077">g</span>&nbsp;<span class="op" id="6582079">!=</span>&nbsp;<span class="ident" id="6582082">e</span>&nbsp;<span class="op" id="6582084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6582088">t</span><span class="op" id="6582089">.</span><span class="ident" id="6582090">Errorf</span><span class="op" id="6582096">(</span><span class="string" id="6582097">&#34;got&nbsp;body&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="6582123">,</span>&nbsp;<span class="ident" id="6582125">g</span><span class="op" id="6582126">,</span>&nbsp;<span class="ident" id="6582128">e</span><span class="op" id="6582129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6582132">}</span><br>
<span class="lineno"></span><span class="op" id="6582134">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span><span class="keyword" id="6582137">var</span>&nbsp;<span class="ident" id="6582141">proxyQueryTests</span>&nbsp;<span class="op" id="6582157">=</span>&nbsp;<span class="op" id="6582159">[</span><span class="op" id="6582160">]</span><span class="keyword" id="6582161">struct</span>&nbsp;<span class="op" id="6582168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6582171">baseSuffix</span>&nbsp;<span class="builtintype" id="6582182">string</span>&nbsp;<span class="comment" id="6582189">//&nbsp;suffix&nbsp;to&nbsp;add&nbsp;to&nbsp;backend&nbsp;URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6582222">reqSuffix</span>&nbsp;&nbsp;<span class="builtintype" id="6582233">string</span>&nbsp;<span class="comment" id="6582240">//&nbsp;suffix&nbsp;to&nbsp;add&nbsp;to&nbsp;frontend&#39;s&nbsp;request&nbsp;URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6582284">want</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6582295">string</span>&nbsp;<span class="comment" id="6582302">//&nbsp;what&nbsp;backend&nbsp;should&nbsp;see&nbsp;for&nbsp;final&nbsp;request&nbsp;URL&nbsp;(without&nbsp;?)</span><br>
<span class="lineno">140</span><span class="op" id="6582363">}</span><span class="op" id="6582364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6582367">{</span><span class="string" id="6582368">&#34;&#34;</span><span class="op" id="6582370">,</span>&nbsp;<span class="string" id="6582372">&#34;&#34;</span><span class="op" id="6582374">,</span>&nbsp;<span class="string" id="6582376">&#34;&#34;</span><span class="op" id="6582378">}</span><span class="op" id="6582379">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6582382">{</span><span class="string" id="6582383">&#34;?sta=tic&#34;</span><span class="op" id="6582393">,</span>&nbsp;<span class="string" id="6582395">&#34;?us=er&#34;</span><span class="op" id="6582403">,</span>&nbsp;<span class="string" id="6582405">&#34;sta=tic&amp;us=er&#34;</span><span class="op" id="6582420">}</span><span class="op" id="6582421">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6582424">{</span><span class="string" id="6582425">&#34;&#34;</span><span class="op" id="6582427">,</span>&nbsp;<span class="string" id="6582429">&#34;?us=er&#34;</span><span class="op" id="6582437">,</span>&nbsp;<span class="string" id="6582439">&#34;us=er&#34;</span><span class="op" id="6582446">}</span><span class="op" id="6582447">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6582450">{</span><span class="string" id="6582451">&#34;?sta=tic&#34;</span><span class="op" id="6582461">,</span>&nbsp;<span class="string" id="6582463">&#34;&#34;</span><span class="op" id="6582465">,</span>&nbsp;<span class="string" id="6582467">&#34;sta=tic&#34;</span><span class="op" id="6582476">}</span><span class="op" id="6582477">,</span><br>
<span class="lineno">145</span><span class="op" id="6582479">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6582482">func</span>&nbsp;<span class="ident" id="6582487">TestReverseProxyQuery</span><span class="op" id="6582508">(</span><span class="ident" id="6582509">t</span>&nbsp;<span class="op" id="6582511">*</span><span class="ident" id="6582512">testing</span><span class="op" id="6582519">.</span><span class="ident" id="6582520">T</span><span class="op" id="6582521">)</span>&nbsp;<span class="op" id="6582523">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6582526">backend</span>&nbsp;<span class="op" id="6582534">:=</span>&nbsp;<span class="ident" id="6582537">httptest</span><span class="op" id="6582545">.</span><span class="ident" id="6582546">NewServer</span><span class="op" id="6582555">(</span><span class="ident" id="6582556">http</span><span class="op" id="6582560">.</span><span class="ident" id="6582561">HandlerFunc</span><span class="op" id="6582572">(</span><span class="keyword" id="6582573">func</span><span class="op" id="6582577">(</span><span class="ident" id="6582578">w</span>&nbsp;<span class="ident" id="6582580">http</span><span class="op" id="6582584">.</span><span class="ident" id="6582585">ResponseWriter</span><span class="op" id="6582599">,</span>&nbsp;<span class="ident" id="6582601">r</span>&nbsp;<span class="op" id="6582603">*</span><span class="ident" id="6582604">http</span><span class="op" id="6582608">.</span><span class="ident" id="6582609">Request</span><span class="op" id="6582616">)</span>&nbsp;<span class="op" id="6582618">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6582622">w</span><span class="op" id="6582623">.</span><span class="ident" id="6582624">Header</span><span class="op" id="6582630">(</span><span class="op" id="6582631">)</span><span class="op" id="6582632">.</span><span class="ident" id="6582633">Set</span><span class="op" id="6582636">(</span><span class="string" id="6582637">&#34;X-Got-Query&#34;</span><span class="op" id="6582650">,</span>&nbsp;<span class="ident" id="6582652">r</span><span class="op" id="6582653">.</span><span class="ident" id="6582654">URL</span><span class="op" id="6582657">.</span><span class="ident" id="6582658">RawQuery</span><span class="op" id="6582666">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6582670">w</span><span class="op" id="6582671">.</span><span class="ident" id="6582672">Write</span><span class="op" id="6582677">(</span><span class="op" id="6582678">[</span><span class="op" id="6582679">]</span><span class="builtintype" id="6582680">byte</span><span class="op" id="6582684">(</span><span class="string" id="6582685">&#34;hi&#34;</span><span class="op" id="6582689">)</span><span class="op" id="6582690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6582693">}</span><span class="op" id="6582694">)</span><span class="op" id="6582695">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6582698">defer</span>&nbsp;<span class="ident" id="6582704">backend</span><span class="op" id="6582711">.</span><span class="ident" id="6582712">Close</span><span class="op" id="6582717">(</span><span class="op" id="6582718">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6582722">for</span>&nbsp;<span class="ident" id="6582726">i</span><span class="op" id="6582727">,</span>&nbsp;<span class="ident" id="6582729">tt</span>&nbsp;<span class="op" id="6582732">:=</span>&nbsp;<span class="keyword" id="6582735">range</span>&nbsp;<span class="ident" id="6582741">proxyQueryTests</span>&nbsp;<span class="op" id="6582757">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6582761">backendURL</span><span class="op" id="6582771">,</span>&nbsp;<span class="ident" id="6582773">err</span>&nbsp;<span class="op" id="6582777">:=</span>&nbsp;<span class="ident" id="6582780">url</span><span class="op" id="6582783">.</span><span class="ident" id="6582784">Parse</span><span class="op" id="6582789">(</span><span class="ident" id="6582790">backend</span><span class="op" id="6582797">.</span><span class="ident" id="6582798">URL</span>&nbsp;<span class="op" id="6582802">+</span>&nbsp;<span class="ident" id="6582804">tt</span><span class="op" id="6582806">.</span><span class="ident" id="6582807">baseSuffix</span><span class="op" id="6582817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6582821">if</span>&nbsp;<span class="ident" id="6582824">err</span>&nbsp;<span class="op" id="6582828">!=</span>&nbsp;<span class="builtintype" id="6582831">nil</span>&nbsp;<span class="op" id="6582835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6582840">t</span><span class="op" id="6582841">.</span><span class="ident" id="6582842">Fatal</span><span class="op" id="6582847">(</span><span class="ident" id="6582848">err</span><span class="op" id="6582851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6582855">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6582859">frontend</span>&nbsp;<span class="op" id="6582868">:=</span>&nbsp;<span class="ident" id="6582871">httptest</span><span class="op" id="6582879">.</span><span class="ident" id="6582880">NewServer</span><span class="op" id="6582889">(</span><span class="ident" id="6582890">NewSingleHostReverseProxy</span><span class="op" id="6582915">(</span><span class="ident" id="6582916">backendURL</span><span class="op" id="6582926">)</span><span class="op" id="6582927">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6582931">req</span><span class="op" id="6582934">,</span>&nbsp;<span class="ident" id="6582936">_</span>&nbsp;<span class="op" id="6582938">:=</span>&nbsp;<span class="ident" id="6582941">http</span><span class="op" id="6582945">.</span><span class="ident" id="6582946">NewRequest</span><span class="op" id="6582956">(</span><span class="string" id="6582957">&#34;GET&#34;</span><span class="op" id="6582962">,</span>&nbsp;<span class="ident" id="6582964">frontend</span><span class="op" id="6582972">.</span><span class="ident" id="6582973">URL</span><span class="op" id="6582976">+</span><span class="ident" id="6582977">tt</span><span class="op" id="6582979">.</span><span class="ident" id="6582980">reqSuffix</span><span class="op" id="6582989">,</span>&nbsp;<span class="builtintype" id="6582991">nil</span><span class="op" id="6582994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6582998">req</span><span class="op" id="6583001">.</span><span class="ident" id="6583002">Close</span>&nbsp;<span class="op" id="6583008">=</span>&nbsp;<span class="builtintype" id="6583010">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6583017">res</span><span class="op" id="6583020">,</span>&nbsp;<span class="ident" id="6583022">err</span>&nbsp;<span class="op" id="6583026">:=</span>&nbsp;<span class="ident" id="6583029">http</span><span class="op" id="6583033">.</span><span class="ident" id="6583034">DefaultClient</span><span class="op" id="6583047">.</span><span class="ident" id="6583048">Do</span><span class="op" id="6583050">(</span><span class="ident" id="6583051">req</span><span class="op" id="6583054">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6583058">if</span>&nbsp;<span class="ident" id="6583061">err</span>&nbsp;<span class="op" id="6583065">!=</span>&nbsp;<span class="builtintype" id="6583068">nil</span>&nbsp;<span class="op" id="6583072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6583077">t</span><span class="op" id="6583078">.</span><span class="ident" id="6583079">Fatalf</span><span class="op" id="6583085">(</span><span class="string" id="6583086">&#34;%d.&nbsp;Get:&nbsp;%v&#34;</span><span class="op" id="6583099">,</span>&nbsp;<span class="ident" id="6583101">i</span><span class="op" id="6583102">,</span>&nbsp;<span class="ident" id="6583104">err</span><span class="op" id="6583107">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6583111">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6583115">if</span>&nbsp;<span class="ident" id="6583118">g</span><span class="op" id="6583119">,</span>&nbsp;<span class="ident" id="6583121">e</span>&nbsp;<span class="op" id="6583123">:=</span>&nbsp;<span class="ident" id="6583126">res</span><span class="op" id="6583129">.</span><span class="ident" id="6583130">Header</span><span class="op" id="6583136">.</span><span class="ident" id="6583137">Get</span><span class="op" id="6583140">(</span><span class="string" id="6583141">&#34;X-Got-Query&#34;</span><span class="op" id="6583154">)</span><span class="op" id="6583155">,</span>&nbsp;<span class="ident" id="6583157">tt</span><span class="op" id="6583159">.</span><span class="ident" id="6583160">want</span><span class="op" id="6583164">;</span>&nbsp;<span class="ident" id="6583166">g</span>&nbsp;<span class="op" id="6583168">!=</span>&nbsp;<span class="ident" id="6583171">e</span>&nbsp;<span class="op" id="6583173">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6583178">t</span><span class="op" id="6583179">.</span><span class="ident" id="6583180">Errorf</span><span class="op" id="6583186">(</span><span class="string" id="6583187">&#34;%d.&nbsp;got&nbsp;query&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="6583218">,</span>&nbsp;<span class="ident" id="6583220">i</span><span class="op" id="6583221">,</span>&nbsp;<span class="ident" id="6583223">g</span><span class="op" id="6583224">,</span>&nbsp;<span class="ident" id="6583226">e</span><span class="op" id="6583227">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6583231">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6583235">res</span><span class="op" id="6583238">.</span><span class="ident" id="6583239">Body</span><span class="op" id="6583243">.</span><span class="ident" id="6583244">Close</span><span class="op" id="6583249">(</span><span class="op" id="6583250">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6583254">frontend</span><span class="op" id="6583262">.</span><span class="ident" id="6583263">Close</span><span class="op" id="6583268">(</span><span class="op" id="6583269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6583272">}</span><br>
<span class="lineno"></span><span class="op" id="6583274">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6583277">func</span>&nbsp;<span class="ident" id="6583282">TestReverseProxyFlushInterval</span><span class="op" id="6583311">(</span><span class="ident" id="6583312">t</span>&nbsp;<span class="op" id="6583314">*</span><span class="ident" id="6583315">testing</span><span class="op" id="6583322">.</span><span class="ident" id="6583323">T</span><span class="op" id="6583324">)</span>&nbsp;<span class="op" id="6583326">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6583329">const</span>&nbsp;<span class="ident" id="6583335">expected</span>&nbsp;<span class="op" id="6583344">=</span>&nbsp;<span class="string" id="6583346">&#34;hi&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6583352">backend</span>&nbsp;<span class="op" id="6583360">:=</span>&nbsp;<span class="ident" id="6583363">httptest</span><span class="op" id="6583371">.</span><span class="ident" id="6583372">NewServer</span><span class="op" id="6583381">(</span><span class="ident" id="6583382">http</span><span class="op" id="6583386">.</span><span class="ident" id="6583387">HandlerFunc</span><span class="op" id="6583398">(</span><span class="keyword" id="6583399">func</span><span class="op" id="6583403">(</span><span class="ident" id="6583404">w</span>&nbsp;<span class="ident" id="6583406">http</span><span class="op" id="6583410">.</span><span class="ident" id="6583411">ResponseWriter</span><span class="op" id="6583425">,</span>&nbsp;<span class="ident" id="6583427">r</span>&nbsp;<span class="op" id="6583429">*</span><span class="ident" id="6583430">http</span><span class="op" id="6583434">.</span><span class="ident" id="6583435">Request</span><span class="op" id="6583442">)</span>&nbsp;<span class="op" id="6583444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6583448">w</span><span class="op" id="6583449">.</span><span class="ident" id="6583450">Write</span><span class="op" id="6583455">(</span><span class="op" id="6583456">[</span><span class="op" id="6583457">]</span><span class="builtintype" id="6583458">byte</span><span class="op" id="6583462">(</span><span class="ident" id="6583463">expected</span><span class="op" id="6583471">)</span><span class="op" id="6583472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6583475">}</span><span class="op" id="6583476">)</span><span class="op" id="6583477">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6583480">defer</span>&nbsp;<span class="ident" id="6583486">backend</span><span class="op" id="6583493">.</span><span class="ident" id="6583494">Close</span><span class="op" id="6583499">(</span><span class="op" id="6583500">)</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6583504">backendURL</span><span class="op" id="6583514">,</span>&nbsp;<span class="ident" id="6583516">err</span>&nbsp;<span class="op" id="6583520">:=</span>&nbsp;<span class="ident" id="6583523">url</span><span class="op" id="6583526">.</span><span class="ident" id="6583527">Parse</span><span class="op" id="6583532">(</span><span class="ident" id="6583533">backend</span><span class="op" id="6583540">.</span><span class="ident" id="6583541">URL</span><span class="op" id="6583544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6583547">if</span>&nbsp;<span class="ident" id="6583550">err</span>&nbsp;<span class="op" id="6583554">!=</span>&nbsp;<span class="builtintype" id="6583557">nil</span>&nbsp;<span class="op" id="6583561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6583565">t</span><span class="op" id="6583566">.</span><span class="ident" id="6583567">Fatal</span><span class="op" id="6583572">(</span><span class="ident" id="6583573">err</span><span class="op" id="6583576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6583579">}</span><br>
<span class="lineno">185</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6583583">proxyHandler</span>&nbsp;<span class="op" id="6583596">:=</span>&nbsp;<span class="ident" id="6583599">NewSingleHostReverseProxy</span><span class="op" id="6583624">(</span><span class="ident" id="6583625">backendURL</span><span class="op" id="6583635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6583638">proxyHandler</span><span class="op" id="6583650">.</span><span class="ident" id="6583651">FlushInterval</span>&nbsp;<span class="op" id="6583665">=</span>&nbsp;<span class="ident" id="6583667">time</span><span class="op" id="6583671">.</span><span class="ident" id="6583672">Microsecond</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6583686">done</span>&nbsp;<span class="op" id="6583691">:=</span>&nbsp;<span class="builtinfunc" id="6583694">make</span><span class="op" id="6583698">(</span><span class="keyword" id="6583699">chan</span>&nbsp;<span class="builtintype" id="6583704">bool</span><span class="op" id="6583708">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6583711">onExitFlushLoop</span>&nbsp;<span class="op" id="6583727">=</span>&nbsp;<span class="keyword" id="6583729">func</span><span class="op" id="6583733">(</span><span class="op" id="6583734">)</span>&nbsp;<span class="op" id="6583736">{</span>&nbsp;<span class="ident" id="6583738">done</span>&nbsp;<span class="op" id="6583743">&lt;-</span>&nbsp;<span class="builtintype" id="6583746">true</span>&nbsp;<span class="op" id="6583751">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6583754">defer</span>&nbsp;<span class="keyword" id="6583760">func</span><span class="op" id="6583764">(</span><span class="op" id="6583765">)</span>&nbsp;<span class="op" id="6583767">{</span>&nbsp;<span class="ident" id="6583769">onExitFlushLoop</span>&nbsp;<span class="op" id="6583785">=</span>&nbsp;<span class="builtintype" id="6583787">nil</span>&nbsp;<span class="op" id="6583791">}</span><span class="op" id="6583792">(</span><span class="op" id="6583793">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6583797">frontend</span>&nbsp;<span class="op" id="6583806">:=</span>&nbsp;<span class="ident" id="6583809">httptest</span><span class="op" id="6583817">.</span><span class="ident" id="6583818">NewServer</span><span class="op" id="6583827">(</span><span class="ident" id="6583828">proxyHandler</span><span class="op" id="6583840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6583843">defer</span>&nbsp;<span class="ident" id="6583849">frontend</span><span class="op" id="6583857">.</span><span class="ident" id="6583858">Close</span><span class="op" id="6583863">(</span><span class="op" id="6583864">)</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6583868">req</span><span class="op" id="6583871">,</span>&nbsp;<span class="ident" id="6583873">_</span>&nbsp;<span class="op" id="6583875">:=</span>&nbsp;<span class="ident" id="6583878">http</span><span class="op" id="6583882">.</span><span class="ident" id="6583883">NewRequest</span><span class="op" id="6583893">(</span><span class="string" id="6583894">&#34;GET&#34;</span><span class="op" id="6583899">,</span>&nbsp;<span class="ident" id="6583901">frontend</span><span class="op" id="6583909">.</span><span class="ident" id="6583910">URL</span><span class="op" id="6583913">,</span>&nbsp;<span class="builtintype" id="6583915">nil</span><span class="op" id="6583918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6583921">req</span><span class="op" id="6583924">.</span><span class="ident" id="6583925">Close</span>&nbsp;<span class="op" id="6583931">=</span>&nbsp;<span class="builtintype" id="6583933">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6583939">res</span><span class="op" id="6583942">,</span>&nbsp;<span class="ident" id="6583944">err</span>&nbsp;<span class="op" id="6583948">:=</span>&nbsp;<span class="ident" id="6583951">http</span><span class="op" id="6583955">.</span><span class="ident" id="6583956">DefaultClient</span><span class="op" id="6583969">.</span><span class="ident" id="6583970">Do</span><span class="op" id="6583972">(</span><span class="ident" id="6583973">req</span><span class="op" id="6583976">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6583979">if</span>&nbsp;<span class="ident" id="6583982">err</span>&nbsp;<span class="op" id="6583986">!=</span>&nbsp;<span class="builtintype" id="6583989">nil</span>&nbsp;<span class="op" id="6583993">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6583997">t</span><span class="op" id="6583998">.</span><span class="ident" id="6583999">Fatalf</span><span class="op" id="6584005">(</span><span class="string" id="6584006">&#34;Get:&nbsp;%v&#34;</span><span class="op" id="6584015">,</span>&nbsp;<span class="ident" id="6584017">err</span><span class="op" id="6584020">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6584023">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6584026">defer</span>&nbsp;<span class="ident" id="6584032">res</span><span class="op" id="6584035">.</span><span class="ident" id="6584036">Body</span><span class="op" id="6584040">.</span><span class="ident" id="6584041">Close</span><span class="op" id="6584046">(</span><span class="op" id="6584047">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6584050">if</span>&nbsp;<span class="ident" id="6584053">bodyBytes</span><span class="op" id="6584062">,</span>&nbsp;<span class="ident" id="6584064">_</span>&nbsp;<span class="op" id="6584066">:=</span>&nbsp;<span class="ident" id="6584069">ioutil</span><span class="op" id="6584075">.</span><span class="ident" id="6584076">ReadAll</span><span class="op" id="6584083">(</span><span class="ident" id="6584084">res</span><span class="op" id="6584087">.</span><span class="ident" id="6584088">Body</span><span class="op" id="6584092">)</span><span class="op" id="6584093">;</span>&nbsp;<span class="builtintype" id="6584095">string</span><span class="op" id="6584101">(</span><span class="ident" id="6584102">bodyBytes</span><span class="op" id="6584111">)</span>&nbsp;<span class="op" id="6584113">!=</span>&nbsp;<span class="ident" id="6584116">expected</span>&nbsp;<span class="op" id="6584125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6584129">t</span><span class="op" id="6584130">.</span><span class="ident" id="6584131">Errorf</span><span class="op" id="6584137">(</span><span class="string" id="6584138">&#34;got&nbsp;body&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="6584164">,</span>&nbsp;<span class="ident" id="6584166">bodyBytes</span><span class="op" id="6584175">,</span>&nbsp;<span class="ident" id="6584177">expected</span><span class="op" id="6584185">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6584188">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6584192">select</span>&nbsp;<span class="op" id="6584199">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6584202">case</span>&nbsp;<span class="op" id="6584207">&lt;-</span><span class="ident" id="6584209">done</span><span class="op" id="6584213">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6584217">//&nbsp;OK</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6584224">case</span>&nbsp;<span class="op" id="6584229">&lt;-</span><span class="ident" id="6584231">time</span><span class="op" id="6584235">.</span><span class="ident" id="6584236">After</span><span class="op" id="6584241">(</span><span class="num" id="6584242">5</span>&nbsp;<span class="op" id="6584244">*</span>&nbsp;<span class="ident" id="6584246">time</span><span class="op" id="6584250">.</span><span class="ident" id="6584251">Second</span><span class="op" id="6584257">)</span><span class="op" id="6584258">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6584262">t</span><span class="op" id="6584263">.</span><span class="ident" id="6584264">Error</span><span class="op" id="6584269">(</span><span class="string" id="6584270">&#34;maxLatencyWriter&nbsp;flushLoop()&nbsp;never&nbsp;exited&#34;</span><span class="op" id="6584313">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6584316">}</span><br>
<span class="lineno"></span><span class="op" id="6584318">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
