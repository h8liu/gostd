<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>go/format</h2>
<ul>
<li><a href="/gostd/go/format/format.go.html">format.go</a></li>
<li><a href="/gostd/go/format/format_test.go.html">format_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4218447">//&nbsp;Copyright&nbsp;2012&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4218502">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4218556">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4218607">//&nbsp;Package&nbsp;format&nbsp;implements&nbsp;standard&nbsp;formatting&nbsp;of&nbsp;Go&nbsp;source.</span><br>
<span class="lineno"></span><span class="keyword" id="4218670">package</span>&nbsp;<span class="ident" id="4218678">format</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4218686">import</span>&nbsp;<span class="op" id="4218693">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4218696">&#34;bytes&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4218705">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4218712">&#34;go/ast&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4218722">&#34;go/parser&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4218735">&#34;go/printer&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4218749">&#34;go/token&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4218761">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4218767">&#34;strings&#34;</span><br>
<span class="lineno"></span><span class="op" id="4218777">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4218780">var</span>&nbsp;<span class="ident" id="4218784">config</span>&nbsp;<span class="op" id="4218791">=</span>&nbsp;<span class="ident" id="4218793">printer</span><span class="op" id="4218800">.</span><span class="ident" id="4218801">Config</span><span class="op" id="4218807">{</span><span class="ident" id="4218808">Mode</span><span class="op" id="4218812">:</span>&nbsp;<span class="ident" id="4218814">printer</span><span class="op" id="4218821">.</span><span class="ident" id="4218822">UseSpaces</span>&nbsp;<span class="op" id="4218832">|</span>&nbsp;<span class="ident" id="4218834">printer</span><span class="op" id="4218841">.</span><span class="ident" id="4218842">TabIndent</span><span class="op" id="4218851">,</span>&nbsp;<span class="ident" id="4218853">Tabwidth</span><span class="op" id="4218861">:</span>&nbsp;<span class="num" id="4218863">8</span><span class="op" id="4218864">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="4218867">const</span>&nbsp;<span class="ident" id="4218873">parserMode</span>&nbsp;<span class="op" id="4218884">=</span>&nbsp;<span class="ident" id="4218886">parser</span><span class="op" id="4218892">.</span><span class="ident" id="4218893">ParseComments</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4218908">//&nbsp;Node&nbsp;formats&nbsp;node&nbsp;in&nbsp;canonical&nbsp;gofmt&nbsp;style&nbsp;and&nbsp;writes&nbsp;the&nbsp;result&nbsp;to&nbsp;dst.</span><br>
<span class="lineno"></span><span class="comment" id="4218984">//</span><br>
<span class="lineno">25</span><span class="comment" id="4218987">//&nbsp;The&nbsp;node&nbsp;type&nbsp;must&nbsp;be&nbsp;*ast.File,&nbsp;*printer.CommentedNode,&nbsp;[]ast.Decl,</span><br>
<span class="lineno"></span><span class="comment" id="4219059">//&nbsp;[]ast.Stmt,&nbsp;or&nbsp;assignment-compatible&nbsp;to&nbsp;ast.Expr,&nbsp;ast.Decl,&nbsp;ast.Spec,</span><br>
<span class="lineno"></span><span class="comment" id="4219132">//&nbsp;or&nbsp;ast.Stmt.&nbsp;Node&nbsp;does&nbsp;not&nbsp;modify&nbsp;node.&nbsp;Imports&nbsp;are&nbsp;not&nbsp;sorted&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="4219202">//&nbsp;nodes&nbsp;representing&nbsp;partial&nbsp;source&nbsp;files&nbsp;(i.e.,&nbsp;if&nbsp;the&nbsp;node&nbsp;is&nbsp;not&nbsp;an</span><br>
<span class="lineno"></span><span class="comment" id="4219274">//&nbsp;*ast.File&nbsp;or&nbsp;a&nbsp;*printer.CommentedNode&nbsp;not&nbsp;wrapping&nbsp;an&nbsp;*ast.File).</span><br>
<span class="lineno">30</span><span class="comment" id="4219343">//</span><br>
<span class="lineno"></span><span class="comment" id="4219346">//&nbsp;The&nbsp;function&nbsp;may&nbsp;return&nbsp;early&nbsp;(before&nbsp;the&nbsp;entire&nbsp;result&nbsp;is&nbsp;written)</span><br>
<span class="lineno"></span><span class="comment" id="4219417">//&nbsp;and&nbsp;return&nbsp;a&nbsp;formatting&nbsp;error,&nbsp;for&nbsp;instance&nbsp;due&nbsp;to&nbsp;an&nbsp;incorrect&nbsp;AST.</span><br>
<span class="lineno"></span><span class="comment" id="4219489">//</span><br>
<span class="lineno"></span><span class="keyword" id="4219492">func</span>&nbsp;<span class="ident" id="4219497">Node</span><span class="op" id="4219501">(</span><span class="ident" id="4219502">dst</span>&nbsp;<span class="ident" id="4219506">io</span><span class="op" id="4219508">.</span><span class="ident" id="4219509">Writer</span><span class="op" id="4219515">,</span>&nbsp;<span class="ident" id="4219517">fset</span>&nbsp;<span class="op" id="4219522">*</span><span class="ident" id="4219523">token</span><span class="op" id="4219528">.</span><span class="ident" id="4219529">FileSet</span><span class="op" id="4219536">,</span>&nbsp;<span class="ident" id="4219538">node</span>&nbsp;<span class="keyword" id="4219543">interface</span><span class="op" id="4219552">{</span><span class="op" id="4219553">}</span><span class="op" id="4219554">)</span>&nbsp;<span class="builtintype" id="4219556">error</span>&nbsp;<span class="op" id="4219562">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4219565">//&nbsp;Determine&nbsp;if&nbsp;we&nbsp;have&nbsp;a&nbsp;complete&nbsp;source&nbsp;file&nbsp;(file&nbsp;!=&nbsp;nil).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4219628">var</span>&nbsp;<span class="ident" id="4219632">file</span>&nbsp;<span class="op" id="4219637">*</span><span class="ident" id="4219638">ast</span><span class="op" id="4219641">.</span><span class="ident" id="4219642">File</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4219648">var</span>&nbsp;<span class="ident" id="4219652">cnode</span>&nbsp;<span class="op" id="4219658">*</span><span class="ident" id="4219659">printer</span><span class="op" id="4219666">.</span><span class="ident" id="4219667">CommentedNode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4219682">switch</span>&nbsp;<span class="ident" id="4219689">n</span>&nbsp;<span class="op" id="4219691">:=</span>&nbsp;<span class="ident" id="4219694">node</span><span class="op" id="4219698">.</span><span class="op" id="4219699">(</span><span class="keyword" id="4219700">type</span><span class="op" id="4219704">)</span>&nbsp;<span class="op" id="4219706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4219709">case</span>&nbsp;<span class="op" id="4219714">*</span><span class="ident" id="4219715">ast</span><span class="op" id="4219718">.</span><span class="ident" id="4219719">File</span><span class="op" id="4219723">:</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4219727">file</span>&nbsp;<span class="op" id="4219732">=</span>&nbsp;<span class="ident" id="4219734">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4219737">case</span>&nbsp;<span class="op" id="4219742">*</span><span class="ident" id="4219743">printer</span><span class="op" id="4219750">.</span><span class="ident" id="4219751">CommentedNode</span><span class="op" id="4219764">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4219768">if</span>&nbsp;<span class="ident" id="4219771">f</span><span class="op" id="4219772">,</span>&nbsp;<span class="ident" id="4219774">ok</span>&nbsp;<span class="op" id="4219777">:=</span>&nbsp;<span class="ident" id="4219780">n</span><span class="op" id="4219781">.</span><span class="ident" id="4219782">Node</span><span class="op" id="4219786">.</span><span class="op" id="4219787">(</span><span class="op" id="4219788">*</span><span class="ident" id="4219789">ast</span><span class="op" id="4219792">.</span><span class="ident" id="4219793">File</span><span class="op" id="4219797">)</span><span class="op" id="4219798">;</span>&nbsp;<span class="ident" id="4219800">ok</span>&nbsp;<span class="op" id="4219803">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4219808">file</span>&nbsp;<span class="op" id="4219813">=</span>&nbsp;<span class="ident" id="4219815">f</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4219820">cnode</span>&nbsp;<span class="op" id="4219826">=</span>&nbsp;<span class="ident" id="4219828">n</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4219832">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4219835">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4219839">//&nbsp;Sort&nbsp;imports&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4219870">if</span>&nbsp;<span class="ident" id="4219873">file</span>&nbsp;<span class="op" id="4219878">!=</span>&nbsp;<span class="ident" id="4219881">nil</span>&nbsp;<span class="op" id="4219885">&amp;&amp;</span>&nbsp;<span class="ident" id="4219888">hasUnsortedImports</span><span class="op" id="4219906">(</span><span class="ident" id="4219907">file</span><span class="op" id="4219911">)</span>&nbsp;<span class="op" id="4219913">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4219917">//&nbsp;Make&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;AST&nbsp;because&nbsp;ast.SortImports&nbsp;is&nbsp;destructive.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4219985">//&nbsp;TODO(gri)&nbsp;Do&nbsp;this&nbsp;more&nbsp;efficiently.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4220026">var</span>&nbsp;<span class="ident" id="4220030">buf</span>&nbsp;<span class="ident" id="4220034">bytes</span><span class="op" id="4220039">.</span><span class="ident" id="4220040">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4220049">err</span>&nbsp;<span class="op" id="4220053">:=</span>&nbsp;<span class="ident" id="4220056">config</span><span class="op" id="4220062">.</span><span class="ident" id="4220063">Fprint</span><span class="op" id="4220069">(</span><span class="op" id="4220070">&amp;</span><span class="ident" id="4220071">buf</span><span class="op" id="4220074">,</span>&nbsp;<span class="ident" id="4220076">fset</span><span class="op" id="4220080">,</span>&nbsp;<span class="ident" id="4220082">file</span><span class="op" id="4220086">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4220090">if</span>&nbsp;<span class="ident" id="4220093">err</span>&nbsp;<span class="op" id="4220097">!=</span>&nbsp;<span class="ident" id="4220100">nil</span>&nbsp;<span class="op" id="4220104">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4220109">return</span>&nbsp;<span class="ident" id="4220116">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4220122">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4220126">file</span><span class="op" id="4220130">,</span>&nbsp;<span class="ident" id="4220132">err</span>&nbsp;<span class="op" id="4220136">=</span>&nbsp;<span class="ident" id="4220138">parser</span><span class="op" id="4220144">.</span><span class="ident" id="4220145">ParseFile</span><span class="op" id="4220154">(</span><span class="ident" id="4220155">fset</span><span class="op" id="4220159">,</span>&nbsp;<span class="string" id="4220161">&#34;&#34;</span><span class="op" id="4220163">,</span>&nbsp;<span class="ident" id="4220165">buf</span><span class="op" id="4220168">.</span><span class="ident" id="4220169">Bytes</span><span class="op" id="4220174">(</span><span class="op" id="4220175">)</span><span class="op" id="4220176">,</span>&nbsp;<span class="ident" id="4220178">parserMode</span><span class="op" id="4220188">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4220192">if</span>&nbsp;<span class="ident" id="4220195">err</span>&nbsp;<span class="op" id="4220199">!=</span>&nbsp;<span class="ident" id="4220202">nil</span>&nbsp;<span class="op" id="4220206">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4220211">//&nbsp;We&nbsp;should&nbsp;never&nbsp;get&nbsp;here.&nbsp;If&nbsp;we&nbsp;do,&nbsp;provide&nbsp;good&nbsp;diagnostic.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4220278">return</span>&nbsp;<span class="ident" id="4220285">fmt</span><span class="op" id="4220288">.</span><span class="ident" id="4220289">Errorf</span><span class="op" id="4220295">(</span><span class="string" id="4220296">&#34;format.Node&nbsp;internal&nbsp;error&nbsp;(%s)&#34;</span><span class="op" id="4220329">,</span>&nbsp;<span class="ident" id="4220331">err</span><span class="op" id="4220334">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4220338">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4220342">ast</span><span class="op" id="4220345">.</span><span class="ident" id="4220346">SortImports</span><span class="op" id="4220357">(</span><span class="ident" id="4220358">fset</span><span class="op" id="4220362">,</span>&nbsp;<span class="ident" id="4220364">file</span><span class="op" id="4220368">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4220373">//&nbsp;Use&nbsp;new&nbsp;file&nbsp;with&nbsp;sorted&nbsp;imports.</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4220412">node</span>&nbsp;<span class="op" id="4220417">=</span>&nbsp;<span class="ident" id="4220419">file</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4220426">if</span>&nbsp;<span class="ident" id="4220429">cnode</span>&nbsp;<span class="op" id="4220435">!=</span>&nbsp;<span class="ident" id="4220438">nil</span>&nbsp;<span class="op" id="4220442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4220447">node</span>&nbsp;<span class="op" id="4220452">=</span>&nbsp;<span class="op" id="4220454">&amp;</span><span class="ident" id="4220455">printer</span><span class="op" id="4220462">.</span><span class="ident" id="4220463">CommentedNode</span><span class="op" id="4220476">{</span><span class="ident" id="4220477">Node</span><span class="op" id="4220481">:</span>&nbsp;<span class="ident" id="4220483">file</span><span class="op" id="4220487">,</span>&nbsp;<span class="ident" id="4220489">Comments</span><span class="op" id="4220497">:</span>&nbsp;<span class="ident" id="4220499">cnode</span><span class="op" id="4220504">.</span><span class="ident" id="4220505">Comments</span><span class="op" id="4220513">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4220517">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4220520">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4220524">return</span>&nbsp;<span class="ident" id="4220531">config</span><span class="op" id="4220537">.</span><span class="ident" id="4220538">Fprint</span><span class="op" id="4220544">(</span><span class="ident" id="4220545">dst</span><span class="op" id="4220548">,</span>&nbsp;<span class="ident" id="4220550">fset</span><span class="op" id="4220554">,</span>&nbsp;<span class="ident" id="4220556">node</span><span class="op" id="4220560">)</span><br>
<span class="lineno"></span><span class="op" id="4220562">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4220565">//&nbsp;Source&nbsp;formats&nbsp;src&nbsp;in&nbsp;canonical&nbsp;gofmt&nbsp;style&nbsp;and&nbsp;returns&nbsp;the&nbsp;result</span><br>
<span class="lineno">75</span><span class="comment" id="4220635">//&nbsp;or&nbsp;an&nbsp;(I/O&nbsp;or&nbsp;syntax)&nbsp;error.&nbsp;src&nbsp;is&nbsp;expected&nbsp;to&nbsp;be&nbsp;a&nbsp;syntactically</span><br>
<span class="lineno"></span><span class="comment" id="4220705">//&nbsp;correct&nbsp;Go&nbsp;source&nbsp;file,&nbsp;or&nbsp;a&nbsp;list&nbsp;of&nbsp;Go&nbsp;declarations&nbsp;or&nbsp;statements.</span><br>
<span class="lineno"></span><span class="comment" id="4220776">//</span><br>
<span class="lineno"></span><span class="comment" id="4220779">//&nbsp;If&nbsp;src&nbsp;is&nbsp;a&nbsp;partial&nbsp;source&nbsp;file,&nbsp;the&nbsp;leading&nbsp;and&nbsp;trailing&nbsp;space&nbsp;of&nbsp;src</span><br>
<span class="lineno"></span><span class="comment" id="4220853">//&nbsp;is&nbsp;applied&nbsp;to&nbsp;the&nbsp;result&nbsp;(such&nbsp;that&nbsp;it&nbsp;has&nbsp;the&nbsp;same&nbsp;leading&nbsp;and&nbsp;trailing</span><br>
<span class="lineno">80</span><span class="comment" id="4220929">//&nbsp;space&nbsp;as&nbsp;src),&nbsp;and&nbsp;the&nbsp;result&nbsp;is&nbsp;indented&nbsp;by&nbsp;the&nbsp;same&nbsp;amount&nbsp;as&nbsp;the&nbsp;first</span><br>
<span class="lineno"></span><span class="comment" id="4221006">//&nbsp;line&nbsp;of&nbsp;src&nbsp;containing&nbsp;code.&nbsp;Imports&nbsp;are&nbsp;not&nbsp;sorted&nbsp;for&nbsp;partial&nbsp;source&nbsp;files.</span><br>
<span class="lineno"></span><span class="comment" id="4221087">//</span><br>
<span class="lineno"></span><span class="keyword" id="4221090">func</span>&nbsp;<span class="ident" id="4221095">Source</span><span class="op" id="4221101">(</span><span class="ident" id="4221102">src</span>&nbsp;<span class="op" id="4221106">[</span><span class="op" id="4221107">]</span><span class="builtintype" id="4221108">byte</span><span class="op" id="4221112">)</span>&nbsp;<span class="op" id="4221114">(</span><span class="op" id="4221115">[</span><span class="op" id="4221116">]</span><span class="builtintype" id="4221117">byte</span><span class="op" id="4221121">,</span>&nbsp;<span class="builtintype" id="4221123">error</span><span class="op" id="4221128">)</span>&nbsp;<span class="op" id="4221130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4221133">fset</span>&nbsp;<span class="op" id="4221138">:=</span>&nbsp;<span class="ident" id="4221141">token</span><span class="op" id="4221146">.</span><span class="ident" id="4221147">NewFileSet</span><span class="op" id="4221157">(</span><span class="op" id="4221158">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4221161">file</span><span class="op" id="4221165">,</span>&nbsp;<span class="ident" id="4221167">sourceAdj</span><span class="op" id="4221176">,</span>&nbsp;<span class="ident" id="4221178">indentAdj</span><span class="op" id="4221187">,</span>&nbsp;<span class="ident" id="4221189">err</span>&nbsp;<span class="op" id="4221193">:=</span>&nbsp;<span class="ident" id="4221196">parse</span><span class="op" id="4221201">(</span><span class="ident" id="4221202">fset</span><span class="op" id="4221206">,</span>&nbsp;<span class="string" id="4221208">&#34;&#34;</span><span class="op" id="4221210">,</span>&nbsp;<span class="ident" id="4221212">src</span><span class="op" id="4221215">,</span>&nbsp;<span class="builtintype" id="4221217">true</span><span class="op" id="4221221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4221224">if</span>&nbsp;<span class="ident" id="4221227">err</span>&nbsp;<span class="op" id="4221231">!=</span>&nbsp;<span class="ident" id="4221234">nil</span>&nbsp;<span class="op" id="4221238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4221242">return</span>&nbsp;<span class="ident" id="4221249">nil</span><span class="op" id="4221252">,</span>&nbsp;<span class="ident" id="4221254">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4221259">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4221263">if</span>&nbsp;<span class="ident" id="4221266">sourceAdj</span>&nbsp;<span class="op" id="4221276">==</span>&nbsp;<span class="ident" id="4221279">nil</span>&nbsp;<span class="op" id="4221283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4221287">//&nbsp;Complete&nbsp;source&nbsp;file.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4221314">//&nbsp;TODO(gri)&nbsp;consider&nbsp;doing&nbsp;this&nbsp;always.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4221357">ast</span><span class="op" id="4221360">.</span><span class="ident" id="4221361">SortImports</span><span class="op" id="4221372">(</span><span class="ident" id="4221373">fset</span><span class="op" id="4221377">,</span>&nbsp;<span class="ident" id="4221379">file</span><span class="op" id="4221383">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4221386">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4221390">return</span>&nbsp;<span class="ident" id="4221397">format</span><span class="op" id="4221403">(</span><span class="ident" id="4221404">fset</span><span class="op" id="4221408">,</span>&nbsp;<span class="ident" id="4221410">file</span><span class="op" id="4221414">,</span>&nbsp;<span class="ident" id="4221416">sourceAdj</span><span class="op" id="4221425">,</span>&nbsp;<span class="ident" id="4221427">indentAdj</span><span class="op" id="4221436">,</span>&nbsp;<span class="ident" id="4221438">src</span><span class="op" id="4221441">,</span>&nbsp;<span class="ident" id="4221443">config</span><span class="op" id="4221449">)</span><br>
<span class="lineno"></span><span class="op" id="4221451">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4221454">func</span>&nbsp;<span class="ident" id="4221459">hasUnsortedImports</span><span class="op" id="4221477">(</span><span class="ident" id="4221478">file</span>&nbsp;<span class="op" id="4221483">*</span><span class="ident" id="4221484">ast</span><span class="op" id="4221487">.</span><span class="ident" id="4221488">File</span><span class="op" id="4221492">)</span>&nbsp;<span class="builtintype" id="4221494">bool</span>&nbsp;<span class="op" id="4221499">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4221502">for</span>&nbsp;<span class="ident" id="4221506">_</span><span class="op" id="4221507">,</span>&nbsp;<span class="ident" id="4221509">d</span>&nbsp;<span class="op" id="4221511">:=</span>&nbsp;<span class="keyword" id="4221514">range</span>&nbsp;<span class="ident" id="4221520">file</span><span class="op" id="4221524">.</span><span class="ident" id="4221525">Decls</span>&nbsp;<span class="op" id="4221531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4221535">d</span><span class="op" id="4221536">,</span>&nbsp;<span class="ident" id="4221538">ok</span>&nbsp;<span class="op" id="4221541">:=</span>&nbsp;<span class="ident" id="4221544">d</span><span class="op" id="4221545">.</span><span class="op" id="4221546">(</span><span class="op" id="4221547">*</span><span class="ident" id="4221548">ast</span><span class="op" id="4221551">.</span><span class="ident" id="4221552">GenDecl</span><span class="op" id="4221559">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4221563">if</span>&nbsp;<span class="op" id="4221566">!</span><span class="ident" id="4221567">ok</span>&nbsp;<span class="op" id="4221570">||</span>&nbsp;<span class="ident" id="4221573">d</span><span class="op" id="4221574">.</span><span class="ident" id="4221575">Tok</span>&nbsp;<span class="op" id="4221579">!=</span>&nbsp;<span class="ident" id="4221582">token</span><span class="op" id="4221587">.</span><span class="ident" id="4221588">IMPORT</span>&nbsp;<span class="op" id="4221595">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4221600">//&nbsp;Not&nbsp;an&nbsp;import&nbsp;declaration,&nbsp;so&nbsp;we&#39;re&nbsp;done.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4221648">//&nbsp;Imports&nbsp;are&nbsp;always&nbsp;first.</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4221680">return</span>&nbsp;<span class="builtintype" id="4221687">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4221695">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4221699">if</span>&nbsp;<span class="ident" id="4221702">d</span><span class="op" id="4221703">.</span><span class="ident" id="4221704">Lparen</span><span class="op" id="4221710">.</span><span class="ident" id="4221711">IsValid</span><span class="op" id="4221718">(</span><span class="op" id="4221719">)</span>&nbsp;<span class="op" id="4221721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4221726">//&nbsp;For&nbsp;now&nbsp;assume&nbsp;all&nbsp;grouped&nbsp;imports&nbsp;are&nbsp;unsorted.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4221781">//&nbsp;TODO(gri)&nbsp;Should&nbsp;check&nbsp;if&nbsp;they&nbsp;are&nbsp;sorted&nbsp;already.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4221838">return</span>&nbsp;<span class="builtintype" id="4221845">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4221852">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4221856">//&nbsp;Ungrouped&nbsp;imports&nbsp;are&nbsp;sorted&nbsp;by&nbsp;default.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4221901">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4221904">return</span>&nbsp;<span class="builtintype" id="4221911">false</span><br>
<span class="lineno">115</span><span class="op" id="4221917">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4221920">//&nbsp;----------------------------------------------------------------------------</span><br>
<span class="lineno"></span><span class="comment" id="4222000">//&nbsp;Support&nbsp;functions</span><br>
<span class="lineno"></span><span class="comment" id="4222021">//</span><br>
<span class="lineno">120</span><span class="comment" id="4222024">//&nbsp;The&nbsp;functions&nbsp;parse,&nbsp;format,&nbsp;and&nbsp;isSpace&nbsp;below&nbsp;are&nbsp;identical&nbsp;to&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4222095">//&nbsp;respective&nbsp;functions&nbsp;in&nbsp;cmd/gofmt/gofmt.go&nbsp;-&nbsp;keep&nbsp;them&nbsp;in&nbsp;sync!</span><br>
<span class="lineno"></span><span class="comment" id="4222162">//</span><br>
<span class="lineno"></span><span class="comment" id="4222165">//&nbsp;TODO(gri)&nbsp;Factor&nbsp;out&nbsp;this&nbsp;functionality,&nbsp;eventually.</span><br>
<span class="lineno"></span><br>
<span class="lineno">125</span><span class="comment" id="4222222">//&nbsp;parse&nbsp;parses&nbsp;src,&nbsp;which&nbsp;was&nbsp;read&nbsp;from&nbsp;the&nbsp;named&nbsp;file,</span><br>
<span class="lineno"></span><span class="comment" id="4222279">//&nbsp;as&nbsp;a&nbsp;Go&nbsp;source&nbsp;file,&nbsp;declaration,&nbsp;or&nbsp;statement&nbsp;list.</span><br>
<span class="lineno"></span><span class="keyword" id="4222335">func</span>&nbsp;<span class="ident" id="4222340">parse</span><span class="op" id="4222345">(</span><span class="ident" id="4222346">fset</span>&nbsp;<span class="op" id="4222351">*</span><span class="ident" id="4222352">token</span><span class="op" id="4222357">.</span><span class="ident" id="4222358">FileSet</span><span class="op" id="4222365">,</span>&nbsp;<span class="ident" id="4222367">filename</span>&nbsp;<span class="builtintype" id="4222376">string</span><span class="op" id="4222382">,</span>&nbsp;<span class="ident" id="4222384">src</span>&nbsp;<span class="op" id="4222388">[</span><span class="op" id="4222389">]</span><span class="builtintype" id="4222390">byte</span><span class="op" id="4222394">,</span>&nbsp;<span class="ident" id="4222396">fragmentOk</span>&nbsp;<span class="builtintype" id="4222407">bool</span><span class="op" id="4222411">)</span>&nbsp;<span class="op" id="4222413">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4222416">file</span>&nbsp;<span class="op" id="4222421">*</span><span class="ident" id="4222422">ast</span><span class="op" id="4222425">.</span><span class="ident" id="4222426">File</span><span class="op" id="4222430">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4222433">sourceAdj</span>&nbsp;<span class="keyword" id="4222443">func</span><span class="op" id="4222447">(</span><span class="ident" id="4222448">src</span>&nbsp;<span class="op" id="4222452">[</span><span class="op" id="4222453">]</span><span class="builtintype" id="4222454">byte</span><span class="op" id="4222458">,</span>&nbsp;<span class="ident" id="4222460">indent</span>&nbsp;<span class="builtintype" id="4222467">int</span><span class="op" id="4222470">)</span>&nbsp;<span class="op" id="4222472">[</span><span class="op" id="4222473">]</span><span class="builtintype" id="4222474">byte</span><span class="op" id="4222478">,</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4222481">indentAdj</span>&nbsp;<span class="builtintype" id="4222491">int</span><span class="op" id="4222494">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4222497">err</span>&nbsp;<span class="builtintype" id="4222501">error</span><span class="op" id="4222506">,</span><br>
<span class="lineno"></span><span class="op" id="4222508">)</span>&nbsp;<span class="op" id="4222510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4222513">//&nbsp;Try&nbsp;as&nbsp;whole&nbsp;source&nbsp;file.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4222543">file</span><span class="op" id="4222547">,</span>&nbsp;<span class="ident" id="4222549">err</span>&nbsp;<span class="op" id="4222553">=</span>&nbsp;<span class="ident" id="4222555">parser</span><span class="op" id="4222561">.</span><span class="ident" id="4222562">ParseFile</span><span class="op" id="4222571">(</span><span class="ident" id="4222572">fset</span><span class="op" id="4222576">,</span>&nbsp;<span class="ident" id="4222578">filename</span><span class="op" id="4222586">,</span>&nbsp;<span class="ident" id="4222588">src</span><span class="op" id="4222591">,</span>&nbsp;<span class="ident" id="4222593">parserMode</span><span class="op" id="4222603">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4222606">//&nbsp;If&nbsp;there&#39;s&nbsp;no&nbsp;error,&nbsp;return.&nbsp;&nbsp;If&nbsp;the&nbsp;error&nbsp;is&nbsp;that&nbsp;the&nbsp;source&nbsp;file&nbsp;didn&#39;t&nbsp;begin&nbsp;with&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4222697">//&nbsp;package&nbsp;line&nbsp;and&nbsp;source&nbsp;fragments&nbsp;are&nbsp;ok,&nbsp;fall&nbsp;through&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4222759">//&nbsp;try&nbsp;as&nbsp;a&nbsp;source&nbsp;fragment.&nbsp;&nbsp;Stop&nbsp;and&nbsp;return&nbsp;on&nbsp;any&nbsp;other&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4222826">if</span>&nbsp;<span class="ident" id="4222829">err</span>&nbsp;<span class="op" id="4222833">==</span>&nbsp;<span class="ident" id="4222836">nil</span>&nbsp;<span class="op" id="4222840">||</span>&nbsp;<span class="op" id="4222843">!</span><span class="ident" id="4222844">fragmentOk</span>&nbsp;<span class="op" id="4222855">||</span>&nbsp;<span class="op" id="4222858">!</span><span class="ident" id="4222859">strings</span><span class="op" id="4222866">.</span><span class="ident" id="4222867">Contains</span><span class="op" id="4222875">(</span><span class="ident" id="4222876">err</span><span class="op" id="4222879">.</span><span class="ident" id="4222880">Error</span><span class="op" id="4222885">(</span><span class="op" id="4222886">)</span><span class="op" id="4222887">,</span>&nbsp;<span class="string" id="4222889">&#34;expected&nbsp;&#39;package&#39;&#34;</span><span class="op" id="4222909">)</span>&nbsp;<span class="op" id="4222911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4222915">return</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4222923">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4222927">//&nbsp;If&nbsp;this&nbsp;is&nbsp;a&nbsp;declaration&nbsp;list,&nbsp;make&nbsp;it&nbsp;a&nbsp;source&nbsp;file</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4222984">//&nbsp;by&nbsp;inserting&nbsp;a&nbsp;package&nbsp;clause.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4223019">//&nbsp;Insert&nbsp;using&nbsp;a&nbsp;;,&nbsp;not&nbsp;a&nbsp;newline,&nbsp;so&nbsp;that&nbsp;the&nbsp;line&nbsp;numbers</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4223081">//&nbsp;in&nbsp;psrc&nbsp;match&nbsp;the&nbsp;ones&nbsp;in&nbsp;src.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4223116">psrc</span>&nbsp;<span class="op" id="4223121">:=</span>&nbsp;<span class="builtinfunc" id="4223124">append</span><span class="op" id="4223130">(</span><span class="op" id="4223131">[</span><span class="op" id="4223132">]</span><span class="builtintype" id="4223133">byte</span><span class="op" id="4223137">(</span><span class="string" id="4223138">&#34;package&nbsp;p;&#34;</span><span class="op" id="4223150">)</span><span class="op" id="4223151">,</span>&nbsp;<span class="ident" id="4223153">src</span><span class="op" id="4223156">...</span><span class="op" id="4223159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4223162">file</span><span class="op" id="4223166">,</span>&nbsp;<span class="ident" id="4223168">err</span>&nbsp;<span class="op" id="4223172">=</span>&nbsp;<span class="ident" id="4223174">parser</span><span class="op" id="4223180">.</span><span class="ident" id="4223181">ParseFile</span><span class="op" id="4223190">(</span><span class="ident" id="4223191">fset</span><span class="op" id="4223195">,</span>&nbsp;<span class="ident" id="4223197">filename</span><span class="op" id="4223205">,</span>&nbsp;<span class="ident" id="4223207">psrc</span><span class="op" id="4223211">,</span>&nbsp;<span class="ident" id="4223213">parserMode</span><span class="op" id="4223223">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4223226">if</span>&nbsp;<span class="ident" id="4223229">err</span>&nbsp;<span class="op" id="4223233">==</span>&nbsp;<span class="ident" id="4223236">nil</span>&nbsp;<span class="op" id="4223240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4223244">sourceAdj</span>&nbsp;<span class="op" id="4223254">=</span>&nbsp;<span class="keyword" id="4223256">func</span><span class="op" id="4223260">(</span><span class="ident" id="4223261">src</span>&nbsp;<span class="op" id="4223265">[</span><span class="op" id="4223266">]</span><span class="builtintype" id="4223267">byte</span><span class="op" id="4223271">,</span>&nbsp;<span class="ident" id="4223273">indent</span>&nbsp;<span class="builtintype" id="4223280">int</span><span class="op" id="4223283">)</span>&nbsp;<span class="op" id="4223285">[</span><span class="op" id="4223286">]</span><span class="builtintype" id="4223287">byte</span>&nbsp;<span class="op" id="4223292">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4223297">//&nbsp;Remove&nbsp;the&nbsp;package&nbsp;clause.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4223330">//&nbsp;Gofmt&nbsp;has&nbsp;turned&nbsp;the&nbsp;;&nbsp;into&nbsp;a&nbsp;\n.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4223370">src</span>&nbsp;<span class="op" id="4223374">=</span>&nbsp;<span class="ident" id="4223376">src</span><span class="op" id="4223379">[</span><span class="ident" id="4223380">indent</span><span class="op" id="4223386">+</span><span class="builtinfunc" id="4223387">len</span><span class="op" id="4223390">(</span><span class="string" id="4223391">&#34;package&nbsp;p\n&#34;</span><span class="op" id="4223404">)</span><span class="op" id="4223405">:</span><span class="op" id="4223406">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4223411">return</span>&nbsp;<span class="ident" id="4223418">bytes</span><span class="op" id="4223423">.</span><span class="ident" id="4223424">TrimSpace</span><span class="op" id="4223433">(</span><span class="ident" id="4223434">src</span><span class="op" id="4223437">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4223441">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4223445">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4223453">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4223456">//&nbsp;If&nbsp;the&nbsp;error&nbsp;is&nbsp;that&nbsp;the&nbsp;source&nbsp;file&nbsp;didn&#39;t&nbsp;begin&nbsp;with&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4223517">//&nbsp;declaration,&nbsp;fall&nbsp;through&nbsp;to&nbsp;try&nbsp;as&nbsp;a&nbsp;statement&nbsp;list.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4223575">//&nbsp;Stop&nbsp;and&nbsp;return&nbsp;on&nbsp;any&nbsp;other&nbsp;error.</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4223615">if</span>&nbsp;<span class="op" id="4223618">!</span><span class="ident" id="4223619">strings</span><span class="op" id="4223626">.</span><span class="ident" id="4223627">Contains</span><span class="op" id="4223635">(</span><span class="ident" id="4223636">err</span><span class="op" id="4223639">.</span><span class="ident" id="4223640">Error</span><span class="op" id="4223645">(</span><span class="op" id="4223646">)</span><span class="op" id="4223647">,</span>&nbsp;<span class="string" id="4223649">&#34;expected&nbsp;declaration&#34;</span><span class="op" id="4223671">)</span>&nbsp;<span class="op" id="4223673">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4223677">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4223685">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4223689">//&nbsp;If&nbsp;this&nbsp;is&nbsp;a&nbsp;statement&nbsp;list,&nbsp;make&nbsp;it&nbsp;a&nbsp;source&nbsp;file</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4223744">//&nbsp;by&nbsp;inserting&nbsp;a&nbsp;package&nbsp;clause&nbsp;and&nbsp;turning&nbsp;the&nbsp;list</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4223799">//&nbsp;into&nbsp;a&nbsp;function&nbsp;body.&nbsp;&nbsp;This&nbsp;handles&nbsp;expressions&nbsp;too.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4223856">//&nbsp;Insert&nbsp;using&nbsp;a&nbsp;;,&nbsp;not&nbsp;a&nbsp;newline,&nbsp;so&nbsp;that&nbsp;the&nbsp;line&nbsp;numbers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4223918">//&nbsp;in&nbsp;fsrc&nbsp;match&nbsp;the&nbsp;ones&nbsp;in&nbsp;src.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4223953">fsrc</span>&nbsp;<span class="op" id="4223958">:=</span>&nbsp;<span class="builtinfunc" id="4223961">append</span><span class="op" id="4223967">(</span><span class="builtinfunc" id="4223968">append</span><span class="op" id="4223974">(</span><span class="op" id="4223975">[</span><span class="op" id="4223976">]</span><span class="builtintype" id="4223977">byte</span><span class="op" id="4223981">(</span><span class="string" id="4223982">&#34;package&nbsp;p;&nbsp;func&nbsp;_()&nbsp;{&#34;</span><span class="op" id="4224005">)</span><span class="op" id="4224006">,</span>&nbsp;<span class="ident" id="4224008">src</span><span class="op" id="4224011">...</span><span class="op" id="4224014">)</span><span class="op" id="4224015">,</span>&nbsp;<span class="string" id="4224017">&#39;\n&#39;</span><span class="op" id="4224021">,</span>&nbsp;<span class="string" id="4224023">&#39;}&#39;</span><span class="op" id="4224026">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4224029">file</span><span class="op" id="4224033">,</span>&nbsp;<span class="ident" id="4224035">err</span>&nbsp;<span class="op" id="4224039">=</span>&nbsp;<span class="ident" id="4224041">parser</span><span class="op" id="4224047">.</span><span class="ident" id="4224048">ParseFile</span><span class="op" id="4224057">(</span><span class="ident" id="4224058">fset</span><span class="op" id="4224062">,</span>&nbsp;<span class="ident" id="4224064">filename</span><span class="op" id="4224072">,</span>&nbsp;<span class="ident" id="4224074">fsrc</span><span class="op" id="4224078">,</span>&nbsp;<span class="ident" id="4224080">parserMode</span><span class="op" id="4224090">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4224093">if</span>&nbsp;<span class="ident" id="4224096">err</span>&nbsp;<span class="op" id="4224100">==</span>&nbsp;<span class="ident" id="4224103">nil</span>&nbsp;<span class="op" id="4224107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4224111">sourceAdj</span>&nbsp;<span class="op" id="4224121">=</span>&nbsp;<span class="keyword" id="4224123">func</span><span class="op" id="4224127">(</span><span class="ident" id="4224128">src</span>&nbsp;<span class="op" id="4224132">[</span><span class="op" id="4224133">]</span><span class="builtintype" id="4224134">byte</span><span class="op" id="4224138">,</span>&nbsp;<span class="ident" id="4224140">indent</span>&nbsp;<span class="builtintype" id="4224147">int</span><span class="op" id="4224150">)</span>&nbsp;<span class="op" id="4224152">[</span><span class="op" id="4224153">]</span><span class="builtintype" id="4224154">byte</span>&nbsp;<span class="op" id="4224159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4224164">//&nbsp;Cap&nbsp;adjusted&nbsp;indent&nbsp;to&nbsp;zero.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4224199">if</span>&nbsp;<span class="ident" id="4224202">indent</span>&nbsp;<span class="op" id="4224209">&lt;</span>&nbsp;<span class="num" id="4224211">0</span>&nbsp;<span class="op" id="4224213">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4224219">indent</span>&nbsp;<span class="op" id="4224226">=</span>&nbsp;<span class="num" id="4224228">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4224233">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4224238">//&nbsp;Remove&nbsp;the&nbsp;wrapping.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4224265">//&nbsp;Gofmt&nbsp;has&nbsp;turned&nbsp;the&nbsp;;&nbsp;into&nbsp;a&nbsp;\n\n.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4224307">//&nbsp;There&nbsp;will&nbsp;be&nbsp;two&nbsp;non-blank&nbsp;lines&nbsp;with&nbsp;indent,&nbsp;hence&nbsp;2*indent.</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4224376">src</span>&nbsp;<span class="op" id="4224380">=</span>&nbsp;<span class="ident" id="4224382">src</span><span class="op" id="4224385">[</span><span class="num" id="4224386">2</span><span class="op" id="4224387">*</span><span class="ident" id="4224388">indent</span><span class="op" id="4224394">+</span><span class="builtinfunc" id="4224395">len</span><span class="op" id="4224398">(</span><span class="string" id="4224399">&#34;package&nbsp;p\n\nfunc&nbsp;_()&nbsp;{&#34;</span><span class="op" id="4224424">)</span><span class="op" id="4224425">:</span><span class="op" id="4224426">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4224431">src</span>&nbsp;<span class="op" id="4224435">=</span>&nbsp;<span class="ident" id="4224437">src</span><span class="op" id="4224440">[</span><span class="op" id="4224441">:</span><span class="builtinfunc" id="4224442">len</span><span class="op" id="4224445">(</span><span class="ident" id="4224446">src</span><span class="op" id="4224449">)</span><span class="op" id="4224450">-</span><span class="op" id="4224451">(</span><span class="ident" id="4224452">indent</span><span class="op" id="4224458">+</span><span class="builtinfunc" id="4224459">len</span><span class="op" id="4224462">(</span><span class="string" id="4224463">&#34;\n}\n&#34;</span><span class="op" id="4224470">)</span><span class="op" id="4224471">)</span><span class="op" id="4224472">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4224477">return</span>&nbsp;<span class="ident" id="4224484">bytes</span><span class="op" id="4224489">.</span><span class="ident" id="4224490">TrimSpace</span><span class="op" id="4224499">(</span><span class="ident" id="4224500">src</span><span class="op" id="4224503">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4224507">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4224511">//&nbsp;Gofmt&nbsp;has&nbsp;also&nbsp;indented&nbsp;the&nbsp;function&nbsp;body&nbsp;one&nbsp;level.</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4224569">//&nbsp;Adjust&nbsp;that&nbsp;with&nbsp;indentAdj.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4224602">indentAdj</span>&nbsp;<span class="op" id="4224612">=</span>&nbsp;<span class="op" id="4224614">-</span><span class="num" id="4224615">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4224618">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4224622">//&nbsp;Succeeded,&nbsp;or&nbsp;out&nbsp;of&nbsp;options.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4224656">return</span><br>
<span class="lineno"></span><span class="op" id="4224663">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4224666">//&nbsp;format&nbsp;formats&nbsp;the&nbsp;given&nbsp;package&nbsp;file&nbsp;originally&nbsp;obtained&nbsp;from&nbsp;src</span><br>
<span class="lineno"></span><span class="comment" id="4224736">//&nbsp;and&nbsp;adjusts&nbsp;the&nbsp;result&nbsp;based&nbsp;on&nbsp;the&nbsp;original&nbsp;source&nbsp;via&nbsp;sourceAdj</span><br>
<span class="lineno">195</span><span class="comment" id="4224805">//&nbsp;and&nbsp;indentAdj.</span><br>
<span class="lineno"></span><span class="keyword" id="4224823">func</span>&nbsp;<span class="ident" id="4224828">format</span><span class="op" id="4224834">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4224837">fset</span>&nbsp;<span class="op" id="4224842">*</span><span class="ident" id="4224843">token</span><span class="op" id="4224848">.</span><span class="ident" id="4224849">FileSet</span><span class="op" id="4224856">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4224859">file</span>&nbsp;<span class="op" id="4224864">*</span><span class="ident" id="4224865">ast</span><span class="op" id="4224868">.</span><span class="ident" id="4224869">File</span><span class="op" id="4224873">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4224876">sourceAdj</span>&nbsp;<span class="keyword" id="4224886">func</span><span class="op" id="4224890">(</span><span class="ident" id="4224891">src</span>&nbsp;<span class="op" id="4224895">[</span><span class="op" id="4224896">]</span><span class="builtintype" id="4224897">byte</span><span class="op" id="4224901">,</span>&nbsp;<span class="ident" id="4224903">indent</span>&nbsp;<span class="builtintype" id="4224910">int</span><span class="op" id="4224913">)</span>&nbsp;<span class="op" id="4224915">[</span><span class="op" id="4224916">]</span><span class="builtintype" id="4224917">byte</span><span class="op" id="4224921">,</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4224924">indentAdj</span>&nbsp;<span class="builtintype" id="4224934">int</span><span class="op" id="4224937">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4224940">src</span>&nbsp;<span class="op" id="4224944">[</span><span class="op" id="4224945">]</span><span class="builtintype" id="4224946">byte</span><span class="op" id="4224950">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4224953">cfg</span>&nbsp;<span class="ident" id="4224957">printer</span><span class="op" id="4224964">.</span><span class="ident" id="4224965">Config</span><span class="op" id="4224971">,</span><br>
<span class="lineno"></span><span class="op" id="4224973">)</span>&nbsp;<span class="op" id="4224975">(</span><span class="op" id="4224976">[</span><span class="op" id="4224977">]</span><span class="builtintype" id="4224978">byte</span><span class="op" id="4224982">,</span>&nbsp;<span class="builtintype" id="4224984">error</span><span class="op" id="4224989">)</span>&nbsp;<span class="op" id="4224991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4224994">if</span>&nbsp;<span class="ident" id="4224997">sourceAdj</span>&nbsp;<span class="op" id="4225007">==</span>&nbsp;<span class="ident" id="4225010">nil</span>&nbsp;<span class="op" id="4225014">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4225018">//&nbsp;Complete&nbsp;source&nbsp;file.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4225045">var</span>&nbsp;<span class="ident" id="4225049">buf</span>&nbsp;<span class="ident" id="4225053">bytes</span><span class="op" id="4225058">.</span><span class="ident" id="4225059">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4225068">err</span>&nbsp;<span class="op" id="4225072">:=</span>&nbsp;<span class="ident" id="4225075">cfg</span><span class="op" id="4225078">.</span><span class="ident" id="4225079">Fprint</span><span class="op" id="4225085">(</span><span class="op" id="4225086">&amp;</span><span class="ident" id="4225087">buf</span><span class="op" id="4225090">,</span>&nbsp;<span class="ident" id="4225092">fset</span><span class="op" id="4225096">,</span>&nbsp;<span class="ident" id="4225098">file</span><span class="op" id="4225102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4225106">if</span>&nbsp;<span class="ident" id="4225109">err</span>&nbsp;<span class="op" id="4225113">!=</span>&nbsp;<span class="ident" id="4225116">nil</span>&nbsp;<span class="op" id="4225120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4225125">return</span>&nbsp;<span class="ident" id="4225132">nil</span><span class="op" id="4225135">,</span>&nbsp;<span class="ident" id="4225137">err</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4225143">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4225147">return</span>&nbsp;<span class="ident" id="4225154">buf</span><span class="op" id="4225157">.</span><span class="ident" id="4225158">Bytes</span><span class="op" id="4225163">(</span><span class="op" id="4225164">)</span><span class="op" id="4225165">,</span>&nbsp;<span class="ident" id="4225167">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4225172">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4225176">//&nbsp;Partial&nbsp;source&nbsp;file.</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4225201">//&nbsp;Determine&nbsp;and&nbsp;prepend&nbsp;leading&nbsp;space.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4225242">i</span><span class="op" id="4225243">,</span>&nbsp;<span class="ident" id="4225245">j</span>&nbsp;<span class="op" id="4225247">:=</span>&nbsp;<span class="num" id="4225250">0</span><span class="op" id="4225251">,</span>&nbsp;<span class="num" id="4225253">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4225256">for</span>&nbsp;<span class="ident" id="4225260">j</span>&nbsp;<span class="op" id="4225262">&lt;</span>&nbsp;<span class="builtinfunc" id="4225264">len</span><span class="op" id="4225267">(</span><span class="ident" id="4225268">src</span><span class="op" id="4225271">)</span>&nbsp;<span class="op" id="4225273">&amp;&amp;</span>&nbsp;<span class="ident" id="4225276">isSpace</span><span class="op" id="4225283">(</span><span class="ident" id="4225284">src</span><span class="op" id="4225287">[</span><span class="ident" id="4225288">j</span><span class="op" id="4225289">]</span><span class="op" id="4225290">)</span>&nbsp;<span class="op" id="4225292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4225296">if</span>&nbsp;<span class="ident" id="4225299">src</span><span class="op" id="4225302">[</span><span class="ident" id="4225303">j</span><span class="op" id="4225304">]</span>&nbsp;<span class="op" id="4225306">==</span>&nbsp;<span class="string" id="4225309">&#39;\n&#39;</span>&nbsp;<span class="op" id="4225314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4225319">i</span>&nbsp;<span class="op" id="4225321">=</span>&nbsp;<span class="ident" id="4225323">j</span>&nbsp;<span class="op" id="4225325">+</span>&nbsp;<span class="num" id="4225327">1</span>&nbsp;<span class="comment" id="4225329">//&nbsp;byte&nbsp;offset&nbsp;of&nbsp;last&nbsp;line&nbsp;in&nbsp;leading&nbsp;space</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4225376">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4225380">j</span><span class="op" id="4225381">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4225385">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4225388">var</span>&nbsp;<span class="ident" id="4225392">res</span>&nbsp;<span class="op" id="4225396">[</span><span class="op" id="4225397">]</span><span class="builtintype" id="4225398">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4225404">res</span>&nbsp;<span class="op" id="4225408">=</span>&nbsp;<span class="builtinfunc" id="4225410">append</span><span class="op" id="4225416">(</span><span class="ident" id="4225417">res</span><span class="op" id="4225420">,</span>&nbsp;<span class="ident" id="4225422">src</span><span class="op" id="4225425">[</span><span class="op" id="4225426">:</span><span class="ident" id="4225427">i</span><span class="op" id="4225428">]</span><span class="op" id="4225429">...</span><span class="op" id="4225432">)</span><br>
<span class="lineno">225</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4225436">//&nbsp;Determine&nbsp;and&nbsp;prepend&nbsp;indentation&nbsp;of&nbsp;first&nbsp;code&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4225494">//&nbsp;Spaces&nbsp;are&nbsp;ignored&nbsp;unless&nbsp;there&nbsp;are&nbsp;no&nbsp;tabs,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4225543">//&nbsp;in&nbsp;which&nbsp;case&nbsp;spaces&nbsp;count&nbsp;as&nbsp;one&nbsp;tab.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4225586">indent</span>&nbsp;<span class="op" id="4225593">:=</span>&nbsp;<span class="num" id="4225596">0</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4225599">hasSpace</span>&nbsp;<span class="op" id="4225608">:=</span>&nbsp;<span class="builtintype" id="4225611">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4225618">for</span>&nbsp;<span class="ident" id="4225622">_</span><span class="op" id="4225623">,</span>&nbsp;<span class="ident" id="4225625">b</span>&nbsp;<span class="op" id="4225627">:=</span>&nbsp;<span class="keyword" id="4225630">range</span>&nbsp;<span class="ident" id="4225636">src</span><span class="op" id="4225639">[</span><span class="ident" id="4225640">i</span><span class="op" id="4225641">:</span><span class="ident" id="4225642">j</span><span class="op" id="4225643">]</span>&nbsp;<span class="op" id="4225645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4225649">switch</span>&nbsp;<span class="ident" id="4225656">b</span>&nbsp;<span class="op" id="4225658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4225662">case</span>&nbsp;<span class="string" id="4225667">&#39;&nbsp;&#39;</span><span class="op" id="4225670">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4225675">hasSpace</span>&nbsp;<span class="op" id="4225684">=</span>&nbsp;<span class="builtintype" id="4225686">true</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4225693">case</span>&nbsp;<span class="string" id="4225698">&#39;\t&#39;</span><span class="op" id="4225702">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4225707">indent</span><span class="op" id="4225713">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4225718">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4225721">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4225724">if</span>&nbsp;<span class="ident" id="4225727">indent</span>&nbsp;<span class="op" id="4225734">==</span>&nbsp;<span class="num" id="4225737">0</span>&nbsp;<span class="op" id="4225739">&amp;&amp;</span>&nbsp;<span class="ident" id="4225742">hasSpace</span>&nbsp;<span class="op" id="4225751">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4225755">indent</span>&nbsp;<span class="op" id="4225762">=</span>&nbsp;<span class="num" id="4225764">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4225767">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4225770">for</span>&nbsp;<span class="ident" id="4225774">i</span>&nbsp;<span class="op" id="4225776">:=</span>&nbsp;<span class="num" id="4225779">0</span><span class="op" id="4225780">;</span>&nbsp;<span class="ident" id="4225782">i</span>&nbsp;<span class="op" id="4225784">&lt;</span>&nbsp;<span class="ident" id="4225786">indent</span><span class="op" id="4225792">;</span>&nbsp;<span class="ident" id="4225794">i</span><span class="op" id="4225795">++</span>&nbsp;<span class="op" id="4225798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4225802">res</span>&nbsp;<span class="op" id="4225806">=</span>&nbsp;<span class="builtinfunc" id="4225808">append</span><span class="op" id="4225814">(</span><span class="ident" id="4225815">res</span><span class="op" id="4225818">,</span>&nbsp;<span class="string" id="4225820">&#39;\t&#39;</span><span class="op" id="4225824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4225827">}</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4225831">//&nbsp;Format&nbsp;the&nbsp;source.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4225854">//&nbsp;Write&nbsp;it&nbsp;without&nbsp;any&nbsp;leading&nbsp;and&nbsp;trailing&nbsp;space.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4225907">cfg</span><span class="op" id="4225910">.</span><span class="ident" id="4225911">Indent</span>&nbsp;<span class="op" id="4225918">=</span>&nbsp;<span class="ident" id="4225920">indent</span>&nbsp;<span class="op" id="4225927">+</span>&nbsp;<span class="ident" id="4225929">indentAdj</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4225940">var</span>&nbsp;<span class="ident" id="4225944">buf</span>&nbsp;<span class="ident" id="4225948">bytes</span><span class="op" id="4225953">.</span><span class="ident" id="4225954">Buffer</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4225962">err</span>&nbsp;<span class="op" id="4225966">:=</span>&nbsp;<span class="ident" id="4225969">cfg</span><span class="op" id="4225972">.</span><span class="ident" id="4225973">Fprint</span><span class="op" id="4225979">(</span><span class="op" id="4225980">&amp;</span><span class="ident" id="4225981">buf</span><span class="op" id="4225984">,</span>&nbsp;<span class="ident" id="4225986">fset</span><span class="op" id="4225990">,</span>&nbsp;<span class="ident" id="4225992">file</span><span class="op" id="4225996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4225999">if</span>&nbsp;<span class="ident" id="4226002">err</span>&nbsp;<span class="op" id="4226006">!=</span>&nbsp;<span class="ident" id="4226009">nil</span>&nbsp;<span class="op" id="4226013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4226017">return</span>&nbsp;<span class="ident" id="4226024">nil</span><span class="op" id="4226027">,</span>&nbsp;<span class="ident" id="4226029">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4226034">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4226037">res</span>&nbsp;<span class="op" id="4226041">=</span>&nbsp;<span class="builtinfunc" id="4226043">append</span><span class="op" id="4226049">(</span><span class="ident" id="4226050">res</span><span class="op" id="4226053">,</span>&nbsp;<span class="ident" id="4226055">sourceAdj</span><span class="op" id="4226064">(</span><span class="ident" id="4226065">buf</span><span class="op" id="4226068">.</span><span class="ident" id="4226069">Bytes</span><span class="op" id="4226074">(</span><span class="op" id="4226075">)</span><span class="op" id="4226076">,</span>&nbsp;<span class="ident" id="4226078">cfg</span><span class="op" id="4226081">.</span><span class="ident" id="4226082">Indent</span><span class="op" id="4226088">)</span><span class="op" id="4226089">...</span><span class="op" id="4226092">)</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4226096">//&nbsp;Determine&nbsp;and&nbsp;append&nbsp;trailing&nbsp;space.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4226137">i</span>&nbsp;<span class="op" id="4226139">=</span>&nbsp;<span class="builtinfunc" id="4226141">len</span><span class="op" id="4226144">(</span><span class="ident" id="4226145">src</span><span class="op" id="4226148">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4226151">for</span>&nbsp;<span class="ident" id="4226155">i</span>&nbsp;<span class="op" id="4226157">&gt;</span>&nbsp;<span class="num" id="4226159">0</span>&nbsp;<span class="op" id="4226161">&amp;&amp;</span>&nbsp;<span class="ident" id="4226164">isSpace</span><span class="op" id="4226171">(</span><span class="ident" id="4226172">src</span><span class="op" id="4226175">[</span><span class="ident" id="4226176">i</span><span class="op" id="4226177">-</span><span class="num" id="4226178">1</span><span class="op" id="4226179">]</span><span class="op" id="4226180">)</span>&nbsp;<span class="op" id="4226182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4226186">i</span><span class="op" id="4226187">--</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4226191">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4226194">return</span>&nbsp;<span class="builtinfunc" id="4226201">append</span><span class="op" id="4226207">(</span><span class="ident" id="4226208">res</span><span class="op" id="4226211">,</span>&nbsp;<span class="ident" id="4226213">src</span><span class="op" id="4226216">[</span><span class="ident" id="4226217">i</span><span class="op" id="4226218">:</span><span class="op" id="4226219">]</span><span class="op" id="4226220">...</span><span class="op" id="4226223">)</span><span class="op" id="4226224">,</span>&nbsp;<span class="ident" id="4226226">nil</span><br>
<span class="lineno"></span><span class="op" id="4226230">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4226233">func</span>&nbsp;<span class="ident" id="4226238">isSpace</span><span class="op" id="4226245">(</span><span class="ident" id="4226246">b</span>&nbsp;<span class="builtintype" id="4226248">byte</span><span class="op" id="4226252">)</span>&nbsp;<span class="builtintype" id="4226254">bool</span>&nbsp;<span class="op" id="4226259">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4226262">return</span>&nbsp;<span class="ident" id="4226269">b</span>&nbsp;<span class="op" id="4226271">==</span>&nbsp;<span class="string" id="4226274">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="4226278">||</span>&nbsp;<span class="ident" id="4226281">b</span>&nbsp;<span class="op" id="4226283">==</span>&nbsp;<span class="string" id="4226286">&#39;\t&#39;</span>&nbsp;<span class="op" id="4226291">||</span>&nbsp;<span class="ident" id="4226294">b</span>&nbsp;<span class="op" id="4226296">==</span>&nbsp;<span class="string" id="4226299">&#39;\n&#39;</span>&nbsp;<span class="op" id="4226304">||</span>&nbsp;<span class="ident" id="4226307">b</span>&nbsp;<span class="op" id="4226309">==</span>&nbsp;<span class="string" id="4226312">&#39;\r&#39;</span><br>
<span class="lineno"></span><span class="op" id="4226317">}</span>
</div>
</body>
</html>
