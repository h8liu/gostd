<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/tls</h2>
<ul>
<li><a href="/gostd/crypto/tls/alert.go.html">alert.go</a></li>
<li><a href="/gostd/crypto/tls/cipher_suites.go.html">cipher_suites.go</a></li>
<li><a href="/gostd/crypto/tls/common.go.html">common.go</a></li>
<li><a href="/gostd/crypto/tls/conn.go.html">conn.go</a></li>
<li><a href="/gostd/crypto/tls/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/crypto/tls/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client.go.html">handshake_client.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client_test.go.html">handshake_client_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages.go.html">handshake_messages.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages_test.go.html">handshake_messages_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server.go.html" class="current">handshake_server.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server_test.go.html">handshake_server_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_test.go.html">handshake_test.go</a></li>
<li><a href="/gostd/crypto/tls/key_agreement.go.html">key_agreement.go</a></li>
<li><a href="/gostd/crypto/tls/prf.go.html">prf.go</a></li>
<li><a href="/gostd/crypto/tls/prf_test.go.html">prf_test.go</a></li>
<li><a href="/gostd/crypto/tls/ticket.go.html">ticket.go</a></li>
<li><a href="/gostd/crypto/tls/tls.go.html">tls.go</a></li>
<li><a href="/gostd/crypto/tls/tls_test.go.html">tls_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4268519">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4268574">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4268628">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4268679">package</span>&nbsp;<span class="ident" id="4268687">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4268692">import</span>&nbsp;<span class="op" id="4268699">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4268702">&#34;crypto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4268712">&#34;crypto/ecdsa&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4268728">&#34;crypto/rsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4268742">&#34;crypto/subtle&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4268759">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4268774">&#34;encoding/asn1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4268791">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4268801">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="4268808">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="4268813">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4268816">//&nbsp;serverHandshakeState&nbsp;contains&nbsp;details&nbsp;of&nbsp;a&nbsp;server&nbsp;handshake&nbsp;in&nbsp;progress.</span><br>
<span class="lineno">20</span><span class="comment" id="4268892">//&nbsp;It&#39;s&nbsp;discarded&nbsp;once&nbsp;the&nbsp;handshake&nbsp;has&nbsp;completed.</span><br>
<span class="lineno"></span><span class="keyword" id="4268944">type</span>&nbsp;<span class="ident" id="4268949">serverHandshakeState</span>&nbsp;<span class="keyword" id="4268970">struct</span>&nbsp;<span class="op" id="4268977">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4268980">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4268996">*</span><span class="ident" id="4268997">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4269003">clientHello</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4269019">*</span><span class="ident" id="4269020">clientHelloMsg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4269036">hello</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4269052">*</span><span class="ident" id="4269053">serverHelloMsg</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4269069">suite</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4269085">*</span><span class="ident" id="4269086">cipherSuite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4269099">ellipticOk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4269115">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4269121">ecdsaOk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4269137">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4269143">sessionState</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4269159">*</span><span class="ident" id="4269160">sessionState</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4269174">finishedHash</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4269190">finishedHash</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4269204">masterSecret</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4269220">[</span><span class="op" id="4269221">]</span><span class="builtintype" id="4269222">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4269228">certsFromClient</span>&nbsp;<span class="op" id="4269244">[</span><span class="op" id="4269245">]</span><span class="op" id="4269246">[</span><span class="op" id="4269247">]</span><span class="builtintype" id="4269248">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4269254">cert</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4269270">*</span><span class="ident" id="4269271">Certificate</span><br>
<span class="lineno"></span><span class="op" id="4269283">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="comment" id="4269286">//&nbsp;serverHandshake&nbsp;performs&nbsp;a&nbsp;TLS&nbsp;handshake&nbsp;as&nbsp;a&nbsp;server.</span><br>
<span class="lineno"></span><span class="keyword" id="4269343">func</span>&nbsp;<span class="op" id="4269348">(</span><span class="ident" id="4269349">c</span>&nbsp;<span class="op" id="4269351">*</span><span class="ident" id="4269352">Conn</span><span class="op" id="4269356">)</span>&nbsp;<span class="ident" id="4269358">serverHandshake</span><span class="op" id="4269373">(</span><span class="op" id="4269374">)</span>&nbsp;<span class="builtintype" id="4269376">error</span>&nbsp;<span class="op" id="4269382">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4269385">config</span>&nbsp;<span class="op" id="4269392">:=</span>&nbsp;<span class="ident" id="4269395">c</span><span class="op" id="4269396">.</span><span class="ident" id="4269397">config</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4269406">//&nbsp;If&nbsp;this&nbsp;is&nbsp;the&nbsp;first&nbsp;server&nbsp;handshake,&nbsp;we&nbsp;generate&nbsp;a&nbsp;random&nbsp;key&nbsp;to</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4269477">//&nbsp;encrypt&nbsp;the&nbsp;tickets&nbsp;with.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4269507">config</span><span class="op" id="4269513">.</span><span class="ident" id="4269514">serverInitOnce</span><span class="op" id="4269528">.</span><span class="ident" id="4269529">Do</span><span class="op" id="4269531">(</span><span class="ident" id="4269532">config</span><span class="op" id="4269538">.</span><span class="ident" id="4269539">serverInit</span><span class="op" id="4269549">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4269553">hs</span>&nbsp;<span class="op" id="4269556">:=</span>&nbsp;<span class="ident" id="4269559">serverHandshakeState</span><span class="op" id="4269579">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4269583">c</span><span class="op" id="4269584">:</span>&nbsp;<span class="ident" id="4269586">c</span><span class="op" id="4269587">,</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4269590">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4269593">isResume</span><span class="op" id="4269601">,</span>&nbsp;<span class="ident" id="4269603">err</span>&nbsp;<span class="op" id="4269607">:=</span>&nbsp;<span class="ident" id="4269610">hs</span><span class="op" id="4269612">.</span><span class="ident" id="4269613">readClientHello</span><span class="op" id="4269628">(</span><span class="op" id="4269629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4269632">if</span>&nbsp;<span class="ident" id="4269635">err</span>&nbsp;<span class="op" id="4269639">!=</span>&nbsp;<span class="builtintype" id="4269642">nil</span>&nbsp;<span class="op" id="4269646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4269650">return</span>&nbsp;<span class="ident" id="4269657">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4269662">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4269666">//&nbsp;For&nbsp;an&nbsp;overview&nbsp;of&nbsp;TLS&nbsp;handshaking,&nbsp;see&nbsp;https://tools.ietf.org/html/rfc5246#section-7.3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4269758">if</span>&nbsp;<span class="ident" id="4269761">isResume</span>&nbsp;<span class="op" id="4269770">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4269774">//&nbsp;The&nbsp;client&nbsp;has&nbsp;included&nbsp;a&nbsp;session&nbsp;ticket&nbsp;and&nbsp;so&nbsp;we&nbsp;do&nbsp;an&nbsp;abbreviated&nbsp;handshake.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4269859">if</span>&nbsp;<span class="ident" id="4269862">err</span>&nbsp;<span class="op" id="4269866">:=</span>&nbsp;<span class="ident" id="4269869">hs</span><span class="op" id="4269871">.</span><span class="ident" id="4269872">doResumeHandshake</span><span class="op" id="4269889">(</span><span class="op" id="4269890">)</span><span class="op" id="4269891">;</span>&nbsp;<span class="ident" id="4269893">err</span>&nbsp;<span class="op" id="4269897">!=</span>&nbsp;<span class="builtintype" id="4269900">nil</span>&nbsp;<span class="op" id="4269904">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4269909">return</span>&nbsp;<span class="ident" id="4269916">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4269922">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4269926">if</span>&nbsp;<span class="ident" id="4269929">err</span>&nbsp;<span class="op" id="4269933">:=</span>&nbsp;<span class="ident" id="4269936">hs</span><span class="op" id="4269938">.</span><span class="ident" id="4269939">establishKeys</span><span class="op" id="4269952">(</span><span class="op" id="4269953">)</span><span class="op" id="4269954">;</span>&nbsp;<span class="ident" id="4269956">err</span>&nbsp;<span class="op" id="4269960">!=</span>&nbsp;<span class="builtintype" id="4269963">nil</span>&nbsp;<span class="op" id="4269967">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4269972">return</span>&nbsp;<span class="ident" id="4269979">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4269985">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4269989">if</span>&nbsp;<span class="ident" id="4269992">err</span>&nbsp;<span class="op" id="4269996">:=</span>&nbsp;<span class="ident" id="4269999">hs</span><span class="op" id="4270001">.</span><span class="ident" id="4270002">sendFinished</span><span class="op" id="4270014">(</span><span class="ident" id="4270015">c</span><span class="op" id="4270016">.</span><span class="ident" id="4270017">firstFinished</span><span class="op" id="4270030">[</span><span class="op" id="4270031">:</span><span class="op" id="4270032">]</span><span class="op" id="4270033">)</span><span class="op" id="4270034">;</span>&nbsp;<span class="ident" id="4270036">err</span>&nbsp;<span class="op" id="4270040">!=</span>&nbsp;<span class="builtintype" id="4270043">nil</span>&nbsp;<span class="op" id="4270047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4270052">return</span>&nbsp;<span class="ident" id="4270059">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4270065">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4270069">if</span>&nbsp;<span class="ident" id="4270072">err</span>&nbsp;<span class="op" id="4270076">:=</span>&nbsp;<span class="ident" id="4270079">hs</span><span class="op" id="4270081">.</span><span class="ident" id="4270082">readFinished</span><span class="op" id="4270094">(</span><span class="builtintype" id="4270095">nil</span><span class="op" id="4270098">)</span><span class="op" id="4270099">;</span>&nbsp;<span class="ident" id="4270101">err</span>&nbsp;<span class="op" id="4270105">!=</span>&nbsp;<span class="builtintype" id="4270108">nil</span>&nbsp;<span class="op" id="4270112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4270117">return</span>&nbsp;<span class="ident" id="4270124">err</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4270130">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4270134">c</span><span class="op" id="4270135">.</span><span class="ident" id="4270136">didResume</span>&nbsp;<span class="op" id="4270146">=</span>&nbsp;<span class="builtintype" id="4270148">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4270154">}</span>&nbsp;<span class="keyword" id="4270156">else</span>&nbsp;<span class="op" id="4270161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4270165">//&nbsp;The&nbsp;client&nbsp;didn&#39;t&nbsp;include&nbsp;a&nbsp;session&nbsp;ticket,&nbsp;or&nbsp;it&nbsp;wasn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4270227">//&nbsp;valid&nbsp;so&nbsp;we&nbsp;do&nbsp;a&nbsp;full&nbsp;handshake.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4270265">if</span>&nbsp;<span class="ident" id="4270268">err</span>&nbsp;<span class="op" id="4270272">:=</span>&nbsp;<span class="ident" id="4270275">hs</span><span class="op" id="4270277">.</span><span class="ident" id="4270278">doFullHandshake</span><span class="op" id="4270293">(</span><span class="op" id="4270294">)</span><span class="op" id="4270295">;</span>&nbsp;<span class="ident" id="4270297">err</span>&nbsp;<span class="op" id="4270301">!=</span>&nbsp;<span class="builtintype" id="4270304">nil</span>&nbsp;<span class="op" id="4270308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4270313">return</span>&nbsp;<span class="ident" id="4270320">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4270326">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4270330">if</span>&nbsp;<span class="ident" id="4270333">err</span>&nbsp;<span class="op" id="4270337">:=</span>&nbsp;<span class="ident" id="4270340">hs</span><span class="op" id="4270342">.</span><span class="ident" id="4270343">establishKeys</span><span class="op" id="4270356">(</span><span class="op" id="4270357">)</span><span class="op" id="4270358">;</span>&nbsp;<span class="ident" id="4270360">err</span>&nbsp;<span class="op" id="4270364">!=</span>&nbsp;<span class="builtintype" id="4270367">nil</span>&nbsp;<span class="op" id="4270371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4270376">return</span>&nbsp;<span class="ident" id="4270383">err</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4270389">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4270393">if</span>&nbsp;<span class="ident" id="4270396">err</span>&nbsp;<span class="op" id="4270400">:=</span>&nbsp;<span class="ident" id="4270403">hs</span><span class="op" id="4270405">.</span><span class="ident" id="4270406">readFinished</span><span class="op" id="4270418">(</span><span class="ident" id="4270419">c</span><span class="op" id="4270420">.</span><span class="ident" id="4270421">firstFinished</span><span class="op" id="4270434">[</span><span class="op" id="4270435">:</span><span class="op" id="4270436">]</span><span class="op" id="4270437">)</span><span class="op" id="4270438">;</span>&nbsp;<span class="ident" id="4270440">err</span>&nbsp;<span class="op" id="4270444">!=</span>&nbsp;<span class="builtintype" id="4270447">nil</span>&nbsp;<span class="op" id="4270451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4270456">return</span>&nbsp;<span class="ident" id="4270463">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4270469">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4270473">if</span>&nbsp;<span class="ident" id="4270476">err</span>&nbsp;<span class="op" id="4270480">:=</span>&nbsp;<span class="ident" id="4270483">hs</span><span class="op" id="4270485">.</span><span class="ident" id="4270486">sendSessionTicket</span><span class="op" id="4270503">(</span><span class="op" id="4270504">)</span><span class="op" id="4270505">;</span>&nbsp;<span class="ident" id="4270507">err</span>&nbsp;<span class="op" id="4270511">!=</span>&nbsp;<span class="builtintype" id="4270514">nil</span>&nbsp;<span class="op" id="4270518">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4270523">return</span>&nbsp;<span class="ident" id="4270530">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4270536">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4270540">if</span>&nbsp;<span class="ident" id="4270543">err</span>&nbsp;<span class="op" id="4270547">:=</span>&nbsp;<span class="ident" id="4270550">hs</span><span class="op" id="4270552">.</span><span class="ident" id="4270553">sendFinished</span><span class="op" id="4270565">(</span><span class="builtintype" id="4270566">nil</span><span class="op" id="4270569">)</span><span class="op" id="4270570">;</span>&nbsp;<span class="ident" id="4270572">err</span>&nbsp;<span class="op" id="4270576">!=</span>&nbsp;<span class="builtintype" id="4270579">nil</span>&nbsp;<span class="op" id="4270583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4270588">return</span>&nbsp;<span class="ident" id="4270595">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4270601">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4270604">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4270607">c</span><span class="op" id="4270608">.</span><span class="ident" id="4270609">handshakeComplete</span>&nbsp;<span class="op" id="4270627">=</span>&nbsp;<span class="builtintype" id="4270629">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4270636">return</span>&nbsp;<span class="builtintype" id="4270643">nil</span><br>
<span class="lineno"></span><span class="op" id="4270647">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="comment" id="4270650">//&nbsp;readClientHello&nbsp;reads&nbsp;a&nbsp;ClientHello&nbsp;message&nbsp;from&nbsp;the&nbsp;client&nbsp;and&nbsp;decides</span><br>
<span class="lineno"></span><span class="comment" id="4270725">//&nbsp;whether&nbsp;we&nbsp;will&nbsp;perform&nbsp;session&nbsp;resumption.</span><br>
<span class="lineno"></span><span class="keyword" id="4270772">func</span>&nbsp;<span class="op" id="4270777">(</span><span class="ident" id="4270778">hs</span>&nbsp;<span class="op" id="4270781">*</span><span class="ident" id="4270782">serverHandshakeState</span><span class="op" id="4270802">)</span>&nbsp;<span class="ident" id="4270804">readClientHello</span><span class="op" id="4270819">(</span><span class="op" id="4270820">)</span>&nbsp;<span class="op" id="4270822">(</span><span class="ident" id="4270823">isResume</span>&nbsp;<span class="builtintype" id="4270832">bool</span><span class="op" id="4270836">,</span>&nbsp;<span class="ident" id="4270838">err</span>&nbsp;<span class="builtintype" id="4270842">error</span><span class="op" id="4270847">)</span>&nbsp;<span class="op" id="4270849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4270852">config</span>&nbsp;<span class="op" id="4270859">:=</span>&nbsp;<span class="ident" id="4270862">hs</span><span class="op" id="4270864">.</span><span class="ident" id="4270865">c</span><span class="op" id="4270866">.</span><span class="ident" id="4270867">config</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4270875">c</span>&nbsp;<span class="op" id="4270877">:=</span>&nbsp;<span class="ident" id="4270880">hs</span><span class="op" id="4270882">.</span><span class="ident" id="4270883">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4270887">msg</span><span class="op" id="4270890">,</span>&nbsp;<span class="ident" id="4270892">err</span>&nbsp;<span class="op" id="4270896">:=</span>&nbsp;<span class="ident" id="4270899">c</span><span class="op" id="4270900">.</span><span class="ident" id="4270901">readHandshake</span><span class="op" id="4270914">(</span><span class="op" id="4270915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4270918">if</span>&nbsp;<span class="ident" id="4270921">err</span>&nbsp;<span class="op" id="4270925">!=</span>&nbsp;<span class="builtintype" id="4270928">nil</span>&nbsp;<span class="op" id="4270932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4270936">return</span>&nbsp;<span class="builtintype" id="4270943">false</span><span class="op" id="4270948">,</span>&nbsp;<span class="ident" id="4270950">err</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4270955">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4270958">var</span>&nbsp;<span class="ident" id="4270962">ok</span>&nbsp;<span class="builtintype" id="4270965">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4270971">hs</span><span class="op" id="4270973">.</span><span class="ident" id="4270974">clientHello</span><span class="op" id="4270985">,</span>&nbsp;<span class="ident" id="4270987">ok</span>&nbsp;<span class="op" id="4270990">=</span>&nbsp;<span class="ident" id="4270992">msg</span><span class="op" id="4270995">.</span><span class="op" id="4270996">(</span><span class="op" id="4270997">*</span><span class="ident" id="4270998">clientHelloMsg</span><span class="op" id="4271012">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4271015">if</span>&nbsp;<span class="op" id="4271018">!</span><span class="ident" id="4271019">ok</span>&nbsp;<span class="op" id="4271022">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4271026">c</span><span class="op" id="4271027">.</span><span class="ident" id="4271028">sendAlert</span><span class="op" id="4271037">(</span><span class="ident" id="4271038">alertUnexpectedMessage</span><span class="op" id="4271060">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4271064">return</span>&nbsp;<span class="builtintype" id="4271071">false</span><span class="op" id="4271076">,</span>&nbsp;<span class="ident" id="4271078">unexpectedMessageError</span><span class="op" id="4271100">(</span><span class="ident" id="4271101">hs</span><span class="op" id="4271103">.</span><span class="ident" id="4271104">clientHello</span><span class="op" id="4271115">,</span>&nbsp;<span class="ident" id="4271117">msg</span><span class="op" id="4271120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4271123">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4271126">c</span><span class="op" id="4271127">.</span><span class="ident" id="4271128">vers</span><span class="op" id="4271132">,</span>&nbsp;<span class="ident" id="4271134">ok</span>&nbsp;<span class="op" id="4271137">=</span>&nbsp;<span class="ident" id="4271139">config</span><span class="op" id="4271145">.</span><span class="ident" id="4271146">mutualVersion</span><span class="op" id="4271159">(</span><span class="ident" id="4271160">hs</span><span class="op" id="4271162">.</span><span class="ident" id="4271163">clientHello</span><span class="op" id="4271174">.</span><span class="ident" id="4271175">vers</span><span class="op" id="4271179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4271182">if</span>&nbsp;<span class="op" id="4271185">!</span><span class="ident" id="4271186">ok</span>&nbsp;<span class="op" id="4271189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4271193">c</span><span class="op" id="4271194">.</span><span class="ident" id="4271195">sendAlert</span><span class="op" id="4271204">(</span><span class="ident" id="4271205">alertProtocolVersion</span><span class="op" id="4271225">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4271229">return</span>&nbsp;<span class="builtintype" id="4271236">false</span><span class="op" id="4271241">,</span>&nbsp;<span class="ident" id="4271243">fmt</span><span class="op" id="4271246">.</span><span class="ident" id="4271247">Errorf</span><span class="op" id="4271253">(</span><span class="string" id="4271254">&#34;tls:&nbsp;client&nbsp;offered&nbsp;an&nbsp;unsupported,&nbsp;maximum&nbsp;protocol&nbsp;version&nbsp;of&nbsp;%x&#34;</span><span class="op" id="4271322">,</span>&nbsp;<span class="ident" id="4271324">hs</span><span class="op" id="4271326">.</span><span class="ident" id="4271327">clientHello</span><span class="op" id="4271338">.</span><span class="ident" id="4271339">vers</span><span class="op" id="4271343">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4271346">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4271349">c</span><span class="op" id="4271350">.</span><span class="ident" id="4271351">haveVers</span>&nbsp;<span class="op" id="4271360">=</span>&nbsp;<span class="builtintype" id="4271362">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4271369">hs</span><span class="op" id="4271371">.</span><span class="ident" id="4271372">finishedHash</span>&nbsp;<span class="op" id="4271385">=</span>&nbsp;<span class="ident" id="4271387">newFinishedHash</span><span class="op" id="4271402">(</span><span class="ident" id="4271403">c</span><span class="op" id="4271404">.</span><span class="ident" id="4271405">vers</span><span class="op" id="4271409">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4271412">hs</span><span class="op" id="4271414">.</span><span class="ident" id="4271415">finishedHash</span><span class="op" id="4271427">.</span><span class="ident" id="4271428">Write</span><span class="op" id="4271433">(</span><span class="ident" id="4271434">hs</span><span class="op" id="4271436">.</span><span class="ident" id="4271437">clientHello</span><span class="op" id="4271448">.</span><span class="ident" id="4271449">marshal</span><span class="op" id="4271456">(</span><span class="op" id="4271457">)</span><span class="op" id="4271458">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4271462">hs</span><span class="op" id="4271464">.</span><span class="ident" id="4271465">hello</span>&nbsp;<span class="op" id="4271471">=</span>&nbsp;<span class="builtinfunc" id="4271473">new</span><span class="op" id="4271476">(</span><span class="ident" id="4271477">serverHelloMsg</span><span class="op" id="4271491">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4271495">supportedCurve</span>&nbsp;<span class="op" id="4271510">:=</span>&nbsp;<span class="builtintype" id="4271513">false</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4271520">preferredCurves</span>&nbsp;<span class="op" id="4271536">:=</span>&nbsp;<span class="ident" id="4271539">config</span><span class="op" id="4271545">.</span><span class="ident" id="4271546">curvePreferences</span><span class="op" id="4271562">(</span><span class="op" id="4271563">)</span><br>
<span class="lineno"></span><span class="ident" id="4271565">Curves</span><span class="op" id="4271571">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4271574">for</span>&nbsp;<span class="ident" id="4271578">_</span><span class="op" id="4271579">,</span>&nbsp;<span class="ident" id="4271581">curve</span>&nbsp;<span class="op" id="4271587">:=</span>&nbsp;<span class="keyword" id="4271590">range</span>&nbsp;<span class="ident" id="4271596">hs</span><span class="op" id="4271598">.</span><span class="ident" id="4271599">clientHello</span><span class="op" id="4271610">.</span><span class="ident" id="4271611">supportedCurves</span>&nbsp;<span class="op" id="4271627">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4271631">for</span>&nbsp;<span class="ident" id="4271635">_</span><span class="op" id="4271636">,</span>&nbsp;<span class="ident" id="4271638">supported</span>&nbsp;<span class="op" id="4271648">:=</span>&nbsp;<span class="keyword" id="4271651">range</span>&nbsp;<span class="ident" id="4271657">preferredCurves</span>&nbsp;<span class="op" id="4271673">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4271678">if</span>&nbsp;<span class="ident" id="4271681">supported</span>&nbsp;<span class="op" id="4271691">==</span>&nbsp;<span class="ident" id="4271694">curve</span>&nbsp;<span class="op" id="4271700">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4271706">supportedCurve</span>&nbsp;<span class="op" id="4271721">=</span>&nbsp;<span class="builtintype" id="4271723">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4271732">break</span>&nbsp;<span class="ident" id="4271738">Curves</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4271748">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4271752">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4271755">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4271759">supportedPointFormat</span>&nbsp;<span class="op" id="4271780">:=</span>&nbsp;<span class="builtintype" id="4271783">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4271790">for</span>&nbsp;<span class="ident" id="4271794">_</span><span class="op" id="4271795">,</span>&nbsp;<span class="ident" id="4271797">pointFormat</span>&nbsp;<span class="op" id="4271809">:=</span>&nbsp;<span class="keyword" id="4271812">range</span>&nbsp;<span class="ident" id="4271818">hs</span><span class="op" id="4271820">.</span><span class="ident" id="4271821">clientHello</span><span class="op" id="4271832">.</span><span class="ident" id="4271833">supportedPoints</span>&nbsp;<span class="op" id="4271849">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4271853">if</span>&nbsp;<span class="ident" id="4271856">pointFormat</span>&nbsp;<span class="op" id="4271868">==</span>&nbsp;<span class="ident" id="4271871">pointFormatUncompressed</span>&nbsp;<span class="op" id="4271895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4271900">supportedPointFormat</span>&nbsp;<span class="op" id="4271921">=</span>&nbsp;<span class="builtintype" id="4271923">true</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4271931">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4271939">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4271942">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4271945">hs</span><span class="op" id="4271947">.</span><span class="ident" id="4271948">ellipticOk</span>&nbsp;<span class="op" id="4271959">=</span>&nbsp;<span class="ident" id="4271961">supportedCurve</span>&nbsp;<span class="op" id="4271976">&amp;&amp;</span>&nbsp;<span class="ident" id="4271979">supportedPointFormat</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4272002">foundCompression</span>&nbsp;<span class="op" id="4272019">:=</span>&nbsp;<span class="builtintype" id="4272022">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4272029">//&nbsp;We&nbsp;only&nbsp;support&nbsp;null&nbsp;compression,&nbsp;so&nbsp;check&nbsp;that&nbsp;the&nbsp;client&nbsp;offered&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4272104">for</span>&nbsp;<span class="ident" id="4272108">_</span><span class="op" id="4272109">,</span>&nbsp;<span class="ident" id="4272111">compression</span>&nbsp;<span class="op" id="4272123">:=</span>&nbsp;<span class="keyword" id="4272126">range</span>&nbsp;<span class="ident" id="4272132">hs</span><span class="op" id="4272134">.</span><span class="ident" id="4272135">clientHello</span><span class="op" id="4272146">.</span><span class="ident" id="4272147">compressionMethods</span>&nbsp;<span class="op" id="4272166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4272170">if</span>&nbsp;<span class="ident" id="4272173">compression</span>&nbsp;<span class="op" id="4272185">==</span>&nbsp;<span class="ident" id="4272188">compressionNone</span>&nbsp;<span class="op" id="4272204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4272209">foundCompression</span>&nbsp;<span class="op" id="4272226">=</span>&nbsp;<span class="builtintype" id="4272228">true</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4272236">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4272244">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4272247">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4272251">if</span>&nbsp;<span class="op" id="4272254">!</span><span class="ident" id="4272255">foundCompression</span>&nbsp;<span class="op" id="4272272">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4272276">c</span><span class="op" id="4272277">.</span><span class="ident" id="4272278">sendAlert</span><span class="op" id="4272287">(</span><span class="ident" id="4272288">alertHandshakeFailure</span><span class="op" id="4272309">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4272313">return</span>&nbsp;<span class="builtintype" id="4272320">false</span><span class="op" id="4272325">,</span>&nbsp;<span class="ident" id="4272327">errors</span><span class="op" id="4272333">.</span><span class="ident" id="4272334">New</span><span class="op" id="4272337">(</span><span class="string" id="4272338">&#34;tls:&nbsp;client&nbsp;does&nbsp;not&nbsp;support&nbsp;uncompressed&nbsp;connections&#34;</span><span class="op" id="4272393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4272396">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4272400">hs</span><span class="op" id="4272402">.</span><span class="ident" id="4272403">hello</span><span class="op" id="4272408">.</span><span class="ident" id="4272409">vers</span>&nbsp;<span class="op" id="4272414">=</span>&nbsp;<span class="ident" id="4272416">c</span><span class="op" id="4272417">.</span><span class="ident" id="4272418">vers</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4272424">hs</span><span class="op" id="4272426">.</span><span class="ident" id="4272427">hello</span><span class="op" id="4272432">.</span><span class="ident" id="4272433">random</span>&nbsp;<span class="op" id="4272440">=</span>&nbsp;<span class="builtinfunc" id="4272442">make</span><span class="op" id="4272446">(</span><span class="op" id="4272447">[</span><span class="op" id="4272448">]</span><span class="builtintype" id="4272449">byte</span><span class="op" id="4272453">,</span>&nbsp;<span class="num" id="4272455">32</span><span class="op" id="4272457">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4272460">_</span><span class="op" id="4272461">,</span>&nbsp;<span class="ident" id="4272463">err</span>&nbsp;<span class="op" id="4272467">=</span>&nbsp;<span class="ident" id="4272469">io</span><span class="op" id="4272471">.</span><span class="ident" id="4272472">ReadFull</span><span class="op" id="4272480">(</span><span class="ident" id="4272481">config</span><span class="op" id="4272487">.</span><span class="ident" id="4272488">rand</span><span class="op" id="4272492">(</span><span class="op" id="4272493">)</span><span class="op" id="4272494">,</span>&nbsp;<span class="ident" id="4272496">hs</span><span class="op" id="4272498">.</span><span class="ident" id="4272499">hello</span><span class="op" id="4272504">.</span><span class="ident" id="4272505">random</span><span class="op" id="4272511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4272514">if</span>&nbsp;<span class="ident" id="4272517">err</span>&nbsp;<span class="op" id="4272521">!=</span>&nbsp;<span class="builtintype" id="4272524">nil</span>&nbsp;<span class="op" id="4272528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4272532">c</span><span class="op" id="4272533">.</span><span class="ident" id="4272534">sendAlert</span><span class="op" id="4272543">(</span><span class="ident" id="4272544">alertInternalError</span><span class="op" id="4272562">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4272566">return</span>&nbsp;<span class="builtintype" id="4272573">false</span><span class="op" id="4272578">,</span>&nbsp;<span class="ident" id="4272580">err</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4272585">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4272588">hs</span><span class="op" id="4272590">.</span><span class="ident" id="4272591">hello</span><span class="op" id="4272596">.</span><span class="ident" id="4272597">secureRenegotiation</span>&nbsp;<span class="op" id="4272617">=</span>&nbsp;<span class="ident" id="4272619">hs</span><span class="op" id="4272621">.</span><span class="ident" id="4272622">clientHello</span><span class="op" id="4272633">.</span><span class="ident" id="4272634">secureRenegotiation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4272655">hs</span><span class="op" id="4272657">.</span><span class="ident" id="4272658">hello</span><span class="op" id="4272663">.</span><span class="ident" id="4272664">compressionMethod</span>&nbsp;<span class="op" id="4272682">=</span>&nbsp;<span class="ident" id="4272684">compressionNone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4272701">if</span>&nbsp;<span class="builtinfunc" id="4272704">len</span><span class="op" id="4272707">(</span><span class="ident" id="4272708">hs</span><span class="op" id="4272710">.</span><span class="ident" id="4272711">clientHello</span><span class="op" id="4272722">.</span><span class="ident" id="4272723">serverName</span><span class="op" id="4272733">)</span>&nbsp;<span class="op" id="4272735">&gt;</span>&nbsp;<span class="num" id="4272737">0</span>&nbsp;<span class="op" id="4272739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4272743">c</span><span class="op" id="4272744">.</span><span class="ident" id="4272745">serverName</span>&nbsp;<span class="op" id="4272756">=</span>&nbsp;<span class="ident" id="4272758">hs</span><span class="op" id="4272760">.</span><span class="ident" id="4272761">clientHello</span><span class="op" id="4272772">.</span><span class="ident" id="4272773">serverName</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4272785">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4272789">if</span>&nbsp;<span class="builtinfunc" id="4272792">len</span><span class="op" id="4272795">(</span><span class="ident" id="4272796">hs</span><span class="op" id="4272798">.</span><span class="ident" id="4272799">clientHello</span><span class="op" id="4272810">.</span><span class="ident" id="4272811">alpnProtocols</span><span class="op" id="4272824">)</span>&nbsp;<span class="op" id="4272826">&gt;</span>&nbsp;<span class="num" id="4272828">0</span>&nbsp;<span class="op" id="4272830">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4272834">if</span>&nbsp;<span class="ident" id="4272837">selectedProto</span><span class="op" id="4272850">,</span>&nbsp;<span class="ident" id="4272852">fallback</span>&nbsp;<span class="op" id="4272861">:=</span>&nbsp;<span class="ident" id="4272864">mutualProtocol</span><span class="op" id="4272878">(</span><span class="ident" id="4272879">hs</span><span class="op" id="4272881">.</span><span class="ident" id="4272882">clientHello</span><span class="op" id="4272893">.</span><span class="ident" id="4272894">alpnProtocols</span><span class="op" id="4272907">,</span>&nbsp;<span class="ident" id="4272909">c</span><span class="op" id="4272910">.</span><span class="ident" id="4272911">config</span><span class="op" id="4272917">.</span><span class="ident" id="4272918">NextProtos</span><span class="op" id="4272928">)</span><span class="op" id="4272929">;</span>&nbsp;<span class="op" id="4272931">!</span><span class="ident" id="4272932">fallback</span>&nbsp;<span class="op" id="4272941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4272946">hs</span><span class="op" id="4272948">.</span><span class="ident" id="4272949">hello</span><span class="op" id="4272954">.</span><span class="ident" id="4272955">alpnProtocol</span>&nbsp;<span class="op" id="4272968">=</span>&nbsp;<span class="ident" id="4272970">selectedProto</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4272987">c</span><span class="op" id="4272988">.</span><span class="ident" id="4272989">clientProtocol</span>&nbsp;<span class="op" id="4273004">=</span>&nbsp;<span class="ident" id="4273006">selectedProto</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4273022">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4273025">}</span>&nbsp;<span class="keyword" id="4273027">else</span>&nbsp;<span class="op" id="4273032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4273036">//&nbsp;Although&nbsp;sending&nbsp;an&nbsp;empty&nbsp;NPN&nbsp;extension&nbsp;is&nbsp;reasonable,&nbsp;Firefox&nbsp;has</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4273108">//&nbsp;had&nbsp;a&nbsp;bug&nbsp;around&nbsp;this.&nbsp;Best&nbsp;to&nbsp;send&nbsp;nothing&nbsp;at&nbsp;all&nbsp;if</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4273167">//&nbsp;config.NextProtos&nbsp;is&nbsp;empty.&nbsp;See</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4273204">//&nbsp;https://code.google.com/p/go/issues/detail?id=5445.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4273261">if</span>&nbsp;<span class="ident" id="4273264">hs</span><span class="op" id="4273266">.</span><span class="ident" id="4273267">clientHello</span><span class="op" id="4273278">.</span><span class="ident" id="4273279">nextProtoNeg</span>&nbsp;<span class="op" id="4273292">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="4273295">len</span><span class="op" id="4273298">(</span><span class="ident" id="4273299">config</span><span class="op" id="4273305">.</span><span class="ident" id="4273306">NextProtos</span><span class="op" id="4273316">)</span>&nbsp;<span class="op" id="4273318">&gt;</span>&nbsp;<span class="num" id="4273320">0</span>&nbsp;<span class="op" id="4273322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4273327">hs</span><span class="op" id="4273329">.</span><span class="ident" id="4273330">hello</span><span class="op" id="4273335">.</span><span class="ident" id="4273336">nextProtoNeg</span>&nbsp;<span class="op" id="4273349">=</span>&nbsp;<span class="builtintype" id="4273351">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4273359">hs</span><span class="op" id="4273361">.</span><span class="ident" id="4273362">hello</span><span class="op" id="4273367">.</span><span class="ident" id="4273368">nextProtos</span>&nbsp;<span class="op" id="4273379">=</span>&nbsp;<span class="ident" id="4273381">config</span><span class="op" id="4273387">.</span><span class="ident" id="4273388">NextProtos</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4273401">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4273404">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4273408">if</span>&nbsp;<span class="builtinfunc" id="4273411">len</span><span class="op" id="4273414">(</span><span class="ident" id="4273415">config</span><span class="op" id="4273421">.</span><span class="ident" id="4273422">Certificates</span><span class="op" id="4273434">)</span>&nbsp;<span class="op" id="4273436">==</span>&nbsp;<span class="num" id="4273439">0</span>&nbsp;<span class="op" id="4273441">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4273445">c</span><span class="op" id="4273446">.</span><span class="ident" id="4273447">sendAlert</span><span class="op" id="4273456">(</span><span class="ident" id="4273457">alertInternalError</span><span class="op" id="4273475">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4273479">return</span>&nbsp;<span class="builtintype" id="4273486">false</span><span class="op" id="4273491">,</span>&nbsp;<span class="ident" id="4273493">errors</span><span class="op" id="4273499">.</span><span class="ident" id="4273500">New</span><span class="op" id="4273503">(</span><span class="string" id="4273504">&#34;tls:&nbsp;no&nbsp;certificates&nbsp;configured&#34;</span><span class="op" id="4273537">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4273540">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4273543">hs</span><span class="op" id="4273545">.</span><span class="ident" id="4273546">cert</span>&nbsp;<span class="op" id="4273551">=</span>&nbsp;<span class="op" id="4273553">&amp;</span><span class="ident" id="4273554">config</span><span class="op" id="4273560">.</span><span class="ident" id="4273561">Certificates</span><span class="op" id="4273573">[</span><span class="num" id="4273574">0</span><span class="op" id="4273575">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4273578">if</span>&nbsp;<span class="builtinfunc" id="4273581">len</span><span class="op" id="4273584">(</span><span class="ident" id="4273585">hs</span><span class="op" id="4273587">.</span><span class="ident" id="4273588">clientHello</span><span class="op" id="4273599">.</span><span class="ident" id="4273600">serverName</span><span class="op" id="4273610">)</span>&nbsp;<span class="op" id="4273612">&gt;</span>&nbsp;<span class="num" id="4273614">0</span>&nbsp;<span class="op" id="4273616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4273620">chi</span>&nbsp;<span class="op" id="4273624">:=</span>&nbsp;<span class="op" id="4273627">&amp;</span><span class="ident" id="4273628">ClientHelloInfo</span><span class="op" id="4273643">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4273648">CipherSuites</span><span class="op" id="4273660">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4273665">hs</span><span class="op" id="4273667">.</span><span class="ident" id="4273668">clientHello</span><span class="op" id="4273679">.</span><span class="ident" id="4273680">cipherSuites</span><span class="op" id="4273692">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4273697">ServerName</span><span class="op" id="4273707">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4273714">hs</span><span class="op" id="4273716">.</span><span class="ident" id="4273717">clientHello</span><span class="op" id="4273728">.</span><span class="ident" id="4273729">serverName</span><span class="op" id="4273739">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4273744">SupportedCurves</span><span class="op" id="4273759">:</span>&nbsp;<span class="ident" id="4273761">hs</span><span class="op" id="4273763">.</span><span class="ident" id="4273764">clientHello</span><span class="op" id="4273775">.</span><span class="ident" id="4273776">supportedCurves</span><span class="op" id="4273791">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4273796">SupportedPoints</span><span class="op" id="4273811">:</span>&nbsp;<span class="ident" id="4273813">hs</span><span class="op" id="4273815">.</span><span class="ident" id="4273816">clientHello</span><span class="op" id="4273827">.</span><span class="ident" id="4273828">supportedPoints</span><span class="op" id="4273843">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4273847">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4273851">if</span>&nbsp;<span class="ident" id="4273854">hs</span><span class="op" id="4273856">.</span><span class="ident" id="4273857">cert</span><span class="op" id="4273861">,</span>&nbsp;<span class="ident" id="4273863">err</span>&nbsp;<span class="op" id="4273867">=</span>&nbsp;<span class="ident" id="4273869">config</span><span class="op" id="4273875">.</span><span class="ident" id="4273876">getCertificate</span><span class="op" id="4273890">(</span><span class="ident" id="4273891">chi</span><span class="op" id="4273894">)</span><span class="op" id="4273895">;</span>&nbsp;<span class="ident" id="4273897">err</span>&nbsp;<span class="op" id="4273901">!=</span>&nbsp;<span class="builtintype" id="4273904">nil</span>&nbsp;<span class="op" id="4273908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4273913">c</span><span class="op" id="4273914">.</span><span class="ident" id="4273915">sendAlert</span><span class="op" id="4273924">(</span><span class="ident" id="4273925">alertInternalError</span><span class="op" id="4273943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4273948">return</span>&nbsp;<span class="builtintype" id="4273955">false</span><span class="op" id="4273960">,</span>&nbsp;<span class="ident" id="4273962">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4273968">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4273971">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4273975">_</span><span class="op" id="4273976">,</span>&nbsp;<span class="ident" id="4273978">hs</span><span class="op" id="4273980">.</span><span class="ident" id="4273981">ecdsaOk</span>&nbsp;<span class="op" id="4273989">=</span>&nbsp;<span class="ident" id="4273991">hs</span><span class="op" id="4273993">.</span><span class="ident" id="4273994">cert</span><span class="op" id="4273998">.</span><span class="ident" id="4273999">PrivateKey</span><span class="op" id="4274009">.</span><span class="op" id="4274010">(</span><span class="op" id="4274011">*</span><span class="ident" id="4274012">ecdsa</span><span class="op" id="4274017">.</span><span class="ident" id="4274018">PrivateKey</span><span class="op" id="4274028">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4274032">if</span>&nbsp;<span class="ident" id="4274035">hs</span><span class="op" id="4274037">.</span><span class="ident" id="4274038">checkForResumption</span><span class="op" id="4274056">(</span><span class="op" id="4274057">)</span>&nbsp;<span class="op" id="4274059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4274063">return</span>&nbsp;<span class="builtintype" id="4274070">true</span><span class="op" id="4274074">,</span>&nbsp;<span class="builtintype" id="4274076">nil</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4274081">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4274085">var</span>&nbsp;<span class="ident" id="4274089">preferenceList</span><span class="op" id="4274103">,</span>&nbsp;<span class="ident" id="4274105">supportedList</span>&nbsp;<span class="op" id="4274119">[</span><span class="op" id="4274120">]</span><span class="builtintype" id="4274121">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4274129">if</span>&nbsp;<span class="ident" id="4274132">c</span><span class="op" id="4274133">.</span><span class="ident" id="4274134">config</span><span class="op" id="4274140">.</span><span class="ident" id="4274141">PreferServerCipherSuites</span>&nbsp;<span class="op" id="4274166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4274170">preferenceList</span>&nbsp;<span class="op" id="4274185">=</span>&nbsp;<span class="ident" id="4274187">c</span><span class="op" id="4274188">.</span><span class="ident" id="4274189">config</span><span class="op" id="4274195">.</span><span class="ident" id="4274196">cipherSuites</span><span class="op" id="4274208">(</span><span class="op" id="4274209">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4274213">supportedList</span>&nbsp;<span class="op" id="4274227">=</span>&nbsp;<span class="ident" id="4274229">hs</span><span class="op" id="4274231">.</span><span class="ident" id="4274232">clientHello</span><span class="op" id="4274243">.</span><span class="ident" id="4274244">cipherSuites</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4274258">}</span>&nbsp;<span class="keyword" id="4274260">else</span>&nbsp;<span class="op" id="4274265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4274269">preferenceList</span>&nbsp;<span class="op" id="4274284">=</span>&nbsp;<span class="ident" id="4274286">hs</span><span class="op" id="4274288">.</span><span class="ident" id="4274289">clientHello</span><span class="op" id="4274300">.</span><span class="ident" id="4274301">cipherSuites</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4274316">supportedList</span>&nbsp;<span class="op" id="4274330">=</span>&nbsp;<span class="ident" id="4274332">c</span><span class="op" id="4274333">.</span><span class="ident" id="4274334">config</span><span class="op" id="4274340">.</span><span class="ident" id="4274341">cipherSuites</span><span class="op" id="4274353">(</span><span class="op" id="4274354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4274357">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4274361">for</span>&nbsp;<span class="ident" id="4274365">_</span><span class="op" id="4274366">,</span>&nbsp;<span class="ident" id="4274368">id</span>&nbsp;<span class="op" id="4274371">:=</span>&nbsp;<span class="keyword" id="4274374">range</span>&nbsp;<span class="ident" id="4274380">preferenceList</span>&nbsp;<span class="op" id="4274395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4274399">if</span>&nbsp;<span class="ident" id="4274402">hs</span><span class="op" id="4274404">.</span><span class="ident" id="4274405">suite</span>&nbsp;<span class="op" id="4274411">=</span>&nbsp;<span class="ident" id="4274413">c</span><span class="op" id="4274414">.</span><span class="ident" id="4274415">tryCipherSuite</span><span class="op" id="4274429">(</span><span class="ident" id="4274430">id</span><span class="op" id="4274432">,</span>&nbsp;<span class="ident" id="4274434">supportedList</span><span class="op" id="4274447">,</span>&nbsp;<span class="ident" id="4274449">c</span><span class="op" id="4274450">.</span><span class="ident" id="4274451">vers</span><span class="op" id="4274455">,</span>&nbsp;<span class="ident" id="4274457">hs</span><span class="op" id="4274459">.</span><span class="ident" id="4274460">ellipticOk</span><span class="op" id="4274470">,</span>&nbsp;<span class="ident" id="4274472">hs</span><span class="op" id="4274474">.</span><span class="ident" id="4274475">ecdsaOk</span><span class="op" id="4274482">)</span><span class="op" id="4274483">;</span>&nbsp;<span class="ident" id="4274485">hs</span><span class="op" id="4274487">.</span><span class="ident" id="4274488">suite</span>&nbsp;<span class="op" id="4274494">!=</span>&nbsp;<span class="builtintype" id="4274497">nil</span>&nbsp;<span class="op" id="4274501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4274506">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4274514">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4274517">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4274521">if</span>&nbsp;<span class="ident" id="4274524">hs</span><span class="op" id="4274526">.</span><span class="ident" id="4274527">suite</span>&nbsp;<span class="op" id="4274533">==</span>&nbsp;<span class="builtintype" id="4274536">nil</span>&nbsp;<span class="op" id="4274540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4274544">c</span><span class="op" id="4274545">.</span><span class="ident" id="4274546">sendAlert</span><span class="op" id="4274555">(</span><span class="ident" id="4274556">alertHandshakeFailure</span><span class="op" id="4274577">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4274581">return</span>&nbsp;<span class="builtintype" id="4274588">false</span><span class="op" id="4274593">,</span>&nbsp;<span class="ident" id="4274595">errors</span><span class="op" id="4274601">.</span><span class="ident" id="4274602">New</span><span class="op" id="4274605">(</span><span class="string" id="4274606">&#34;tls:&nbsp;no&nbsp;cipher&nbsp;suite&nbsp;supported&nbsp;by&nbsp;both&nbsp;client&nbsp;and&nbsp;server&#34;</span><span class="op" id="4274664">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4274667">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4274671">//&nbsp;See&nbsp;https://tools.ietf.org/html/draft-ietf-tls-downgrade-scsv-00.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4274741">for</span>&nbsp;<span class="ident" id="4274745">_</span><span class="op" id="4274746">,</span>&nbsp;<span class="ident" id="4274748">id</span>&nbsp;<span class="op" id="4274751">:=</span>&nbsp;<span class="keyword" id="4274754">range</span>&nbsp;<span class="ident" id="4274760">hs</span><span class="op" id="4274762">.</span><span class="ident" id="4274763">clientHello</span><span class="op" id="4274774">.</span><span class="ident" id="4274775">cipherSuites</span>&nbsp;<span class="op" id="4274788">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4274792">if</span>&nbsp;<span class="ident" id="4274795">id</span>&nbsp;<span class="op" id="4274798">==</span>&nbsp;<span class="ident" id="4274801">TLS_FALLBACK_SCSV</span>&nbsp;<span class="op" id="4274819">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4274824">//&nbsp;The&nbsp;client&nbsp;is&nbsp;doing&nbsp;a&nbsp;fallback&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4274873">if</span>&nbsp;<span class="ident" id="4274876">hs</span><span class="op" id="4274878">.</span><span class="ident" id="4274879">clientHello</span><span class="op" id="4274890">.</span><span class="ident" id="4274891">vers</span>&nbsp;<span class="op" id="4274896">&lt;</span>&nbsp;<span class="ident" id="4274898">c</span><span class="op" id="4274899">.</span><span class="ident" id="4274900">config</span><span class="op" id="4274906">.</span><span class="ident" id="4274907">MaxVersion</span>&nbsp;<span class="op" id="4274918">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4274924">c</span><span class="op" id="4274925">.</span><span class="ident" id="4274926">sendAlert</span><span class="op" id="4274935">(</span><span class="ident" id="4274936">alertInappropriateFallback</span><span class="op" id="4274962">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4274968">return</span>&nbsp;<span class="builtintype" id="4274975">false</span><span class="op" id="4274980">,</span>&nbsp;<span class="ident" id="4274982">errors</span><span class="op" id="4274988">.</span><span class="ident" id="4274989">New</span><span class="op" id="4274992">(</span><span class="string" id="4274993">&#34;tls:&nbsp;client&nbsp;using&nbsp;inppropriate&nbsp;protocol&nbsp;fallback&#34;</span><span class="op" id="4275043">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4275048">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4275053">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4275061">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4275064">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4275068">return</span>&nbsp;<span class="builtintype" id="4275075">false</span><span class="op" id="4275080">,</span>&nbsp;<span class="builtintype" id="4275082">nil</span><br>
<span class="lineno">240</span><span class="op" id="4275086">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4275089">//&nbsp;checkForResumption&nbsp;returns&nbsp;true&nbsp;if&nbsp;we&nbsp;should&nbsp;perform&nbsp;resumption&nbsp;on&nbsp;this&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="4275176">func</span>&nbsp;<span class="op" id="4275181">(</span><span class="ident" id="4275182">hs</span>&nbsp;<span class="op" id="4275185">*</span><span class="ident" id="4275186">serverHandshakeState</span><span class="op" id="4275206">)</span>&nbsp;<span class="ident" id="4275208">checkForResumption</span><span class="op" id="4275226">(</span><span class="op" id="4275227">)</span>&nbsp;<span class="builtintype" id="4275229">bool</span>&nbsp;<span class="op" id="4275234">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4275237">c</span>&nbsp;<span class="op" id="4275239">:=</span>&nbsp;<span class="ident" id="4275242">hs</span><span class="op" id="4275244">.</span><span class="ident" id="4275245">c</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4275249">if</span>&nbsp;<span class="ident" id="4275252">c</span><span class="op" id="4275253">.</span><span class="ident" id="4275254">config</span><span class="op" id="4275260">.</span><span class="ident" id="4275261">SessionTicketsDisabled</span>&nbsp;<span class="op" id="4275284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4275288">return</span>&nbsp;<span class="builtintype" id="4275295">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4275302">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4275306">var</span>&nbsp;<span class="ident" id="4275310">ok</span>&nbsp;<span class="builtintype" id="4275313">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4275319">if</span>&nbsp;<span class="ident" id="4275322">hs</span><span class="op" id="4275324">.</span><span class="ident" id="4275325">sessionState</span><span class="op" id="4275337">,</span>&nbsp;<span class="ident" id="4275339">ok</span>&nbsp;<span class="op" id="4275342">=</span>&nbsp;<span class="ident" id="4275344">c</span><span class="op" id="4275345">.</span><span class="ident" id="4275346">decryptTicket</span><span class="op" id="4275359">(</span><span class="ident" id="4275360">hs</span><span class="op" id="4275362">.</span><span class="ident" id="4275363">clientHello</span><span class="op" id="4275374">.</span><span class="ident" id="4275375">sessionTicket</span><span class="op" id="4275388">)</span><span class="op" id="4275389">;</span>&nbsp;<span class="op" id="4275391">!</span><span class="ident" id="4275392">ok</span>&nbsp;<span class="op" id="4275395">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4275399">return</span>&nbsp;<span class="builtintype" id="4275406">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4275413">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4275417">if</span>&nbsp;<span class="ident" id="4275420">hs</span><span class="op" id="4275422">.</span><span class="ident" id="4275423">sessionState</span><span class="op" id="4275435">.</span><span class="ident" id="4275436">vers</span>&nbsp;<span class="op" id="4275441">&gt;</span>&nbsp;<span class="ident" id="4275443">hs</span><span class="op" id="4275445">.</span><span class="ident" id="4275446">clientHello</span><span class="op" id="4275457">.</span><span class="ident" id="4275458">vers</span>&nbsp;<span class="op" id="4275463">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4275467">return</span>&nbsp;<span class="builtintype" id="4275474">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4275481">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4275484">if</span>&nbsp;<span class="ident" id="4275487">vers</span><span class="op" id="4275491">,</span>&nbsp;<span class="ident" id="4275493">ok</span>&nbsp;<span class="op" id="4275496">:=</span>&nbsp;<span class="ident" id="4275499">c</span><span class="op" id="4275500">.</span><span class="ident" id="4275501">config</span><span class="op" id="4275507">.</span><span class="ident" id="4275508">mutualVersion</span><span class="op" id="4275521">(</span><span class="ident" id="4275522">hs</span><span class="op" id="4275524">.</span><span class="ident" id="4275525">sessionState</span><span class="op" id="4275537">.</span><span class="ident" id="4275538">vers</span><span class="op" id="4275542">)</span><span class="op" id="4275543">;</span>&nbsp;<span class="op" id="4275545">!</span><span class="ident" id="4275546">ok</span>&nbsp;<span class="op" id="4275549">||</span>&nbsp;<span class="ident" id="4275552">vers</span>&nbsp;<span class="op" id="4275557">!=</span>&nbsp;<span class="ident" id="4275560">hs</span><span class="op" id="4275562">.</span><span class="ident" id="4275563">sessionState</span><span class="op" id="4275575">.</span><span class="ident" id="4275576">vers</span>&nbsp;<span class="op" id="4275581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4275585">return</span>&nbsp;<span class="builtintype" id="4275592">false</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4275599">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4275603">cipherSuiteOk</span>&nbsp;<span class="op" id="4275617">:=</span>&nbsp;<span class="builtintype" id="4275620">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4275627">//&nbsp;Check&nbsp;that&nbsp;the&nbsp;client&nbsp;is&nbsp;still&nbsp;offering&nbsp;the&nbsp;ciphersuite&nbsp;in&nbsp;the&nbsp;session.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4275703">for</span>&nbsp;<span class="ident" id="4275707">_</span><span class="op" id="4275708">,</span>&nbsp;<span class="ident" id="4275710">id</span>&nbsp;<span class="op" id="4275713">:=</span>&nbsp;<span class="keyword" id="4275716">range</span>&nbsp;<span class="ident" id="4275722">hs</span><span class="op" id="4275724">.</span><span class="ident" id="4275725">clientHello</span><span class="op" id="4275736">.</span><span class="ident" id="4275737">cipherSuites</span>&nbsp;<span class="op" id="4275750">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4275754">if</span>&nbsp;<span class="ident" id="4275757">id</span>&nbsp;<span class="op" id="4275760">==</span>&nbsp;<span class="ident" id="4275763">hs</span><span class="op" id="4275765">.</span><span class="ident" id="4275766">sessionState</span><span class="op" id="4275778">.</span><span class="ident" id="4275779">cipherSuite</span>&nbsp;<span class="op" id="4275791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4275796">cipherSuiteOk</span>&nbsp;<span class="op" id="4275810">=</span>&nbsp;<span class="builtintype" id="4275812">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4275820">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4275828">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4275831">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4275834">if</span>&nbsp;<span class="op" id="4275837">!</span><span class="ident" id="4275838">cipherSuiteOk</span>&nbsp;<span class="op" id="4275852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4275856">return</span>&nbsp;<span class="builtintype" id="4275863">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4275870">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4275874">//&nbsp;Check&nbsp;that&nbsp;we&nbsp;also&nbsp;support&nbsp;the&nbsp;ciphersuite&nbsp;from&nbsp;the&nbsp;session.</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4275939">hs</span><span class="op" id="4275941">.</span><span class="ident" id="4275942">suite</span>&nbsp;<span class="op" id="4275948">=</span>&nbsp;<span class="ident" id="4275950">c</span><span class="op" id="4275951">.</span><span class="ident" id="4275952">tryCipherSuite</span><span class="op" id="4275966">(</span><span class="ident" id="4275967">hs</span><span class="op" id="4275969">.</span><span class="ident" id="4275970">sessionState</span><span class="op" id="4275982">.</span><span class="ident" id="4275983">cipherSuite</span><span class="op" id="4275994">,</span>&nbsp;<span class="ident" id="4275996">c</span><span class="op" id="4275997">.</span><span class="ident" id="4275998">config</span><span class="op" id="4276004">.</span><span class="ident" id="4276005">cipherSuites</span><span class="op" id="4276017">(</span><span class="op" id="4276018">)</span><span class="op" id="4276019">,</span>&nbsp;<span class="ident" id="4276021">hs</span><span class="op" id="4276023">.</span><span class="ident" id="4276024">sessionState</span><span class="op" id="4276036">.</span><span class="ident" id="4276037">vers</span><span class="op" id="4276041">,</span>&nbsp;<span class="ident" id="4276043">hs</span><span class="op" id="4276045">.</span><span class="ident" id="4276046">ellipticOk</span><span class="op" id="4276056">,</span>&nbsp;<span class="ident" id="4276058">hs</span><span class="op" id="4276060">.</span><span class="ident" id="4276061">ecdsaOk</span><span class="op" id="4276068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4276071">if</span>&nbsp;<span class="ident" id="4276074">hs</span><span class="op" id="4276076">.</span><span class="ident" id="4276077">suite</span>&nbsp;<span class="op" id="4276083">==</span>&nbsp;<span class="builtintype" id="4276086">nil</span>&nbsp;<span class="op" id="4276090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4276094">return</span>&nbsp;<span class="builtintype" id="4276101">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4276108">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4276112">sessionHasClientCerts</span>&nbsp;<span class="op" id="4276134">:=</span>&nbsp;<span class="builtinfunc" id="4276137">len</span><span class="op" id="4276140">(</span><span class="ident" id="4276141">hs</span><span class="op" id="4276143">.</span><span class="ident" id="4276144">sessionState</span><span class="op" id="4276156">.</span><span class="ident" id="4276157">certificates</span><span class="op" id="4276169">)</span>&nbsp;<span class="op" id="4276171">!=</span>&nbsp;<span class="num" id="4276174">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4276177">needClientCerts</span>&nbsp;<span class="op" id="4276193">:=</span>&nbsp;<span class="ident" id="4276196">c</span><span class="op" id="4276197">.</span><span class="ident" id="4276198">config</span><span class="op" id="4276204">.</span><span class="ident" id="4276205">ClientAuth</span>&nbsp;<span class="op" id="4276216">==</span>&nbsp;<span class="ident" id="4276219">RequireAnyClientCert</span>&nbsp;<span class="op" id="4276240">||</span>&nbsp;<span class="ident" id="4276243">c</span><span class="op" id="4276244">.</span><span class="ident" id="4276245">config</span><span class="op" id="4276251">.</span><span class="ident" id="4276252">ClientAuth</span>&nbsp;<span class="op" id="4276263">==</span>&nbsp;<span class="ident" id="4276266">RequireAndVerifyClientCert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4276294">if</span>&nbsp;<span class="ident" id="4276297">needClientCerts</span>&nbsp;<span class="op" id="4276313">&amp;&amp;</span>&nbsp;<span class="op" id="4276316">!</span><span class="ident" id="4276317">sessionHasClientCerts</span>&nbsp;<span class="op" id="4276339">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4276343">return</span>&nbsp;<span class="builtintype" id="4276350">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4276357">}</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4276360">if</span>&nbsp;<span class="ident" id="4276363">sessionHasClientCerts</span>&nbsp;<span class="op" id="4276385">&amp;&amp;</span>&nbsp;<span class="ident" id="4276388">c</span><span class="op" id="4276389">.</span><span class="ident" id="4276390">config</span><span class="op" id="4276396">.</span><span class="ident" id="4276397">ClientAuth</span>&nbsp;<span class="op" id="4276408">==</span>&nbsp;<span class="ident" id="4276411">NoClientCert</span>&nbsp;<span class="op" id="4276424">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4276428">return</span>&nbsp;<span class="builtintype" id="4276435">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4276442">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4276446">return</span>&nbsp;<span class="builtintype" id="4276453">true</span><br>
<span class="lineno">290</span><span class="op" id="4276458">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4276461">func</span>&nbsp;<span class="op" id="4276466">(</span><span class="ident" id="4276467">hs</span>&nbsp;<span class="op" id="4276470">*</span><span class="ident" id="4276471">serverHandshakeState</span><span class="op" id="4276491">)</span>&nbsp;<span class="ident" id="4276493">doResumeHandshake</span><span class="op" id="4276510">(</span><span class="op" id="4276511">)</span>&nbsp;<span class="builtintype" id="4276513">error</span>&nbsp;<span class="op" id="4276519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4276522">c</span>&nbsp;<span class="op" id="4276524">:=</span>&nbsp;<span class="ident" id="4276527">hs</span><span class="op" id="4276529">.</span><span class="ident" id="4276530">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4276534">hs</span><span class="op" id="4276536">.</span><span class="ident" id="4276537">hello</span><span class="op" id="4276542">.</span><span class="ident" id="4276543">cipherSuite</span>&nbsp;<span class="op" id="4276555">=</span>&nbsp;<span class="ident" id="4276557">hs</span><span class="op" id="4276559">.</span><span class="ident" id="4276560">suite</span><span class="op" id="4276565">.</span><span class="ident" id="4276566">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4276570">//&nbsp;We&nbsp;echo&nbsp;the&nbsp;client&#39;s&nbsp;session&nbsp;ID&nbsp;in&nbsp;the&nbsp;ServerHello&nbsp;to&nbsp;let&nbsp;it&nbsp;know</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4276640">//&nbsp;that&nbsp;we&#39;re&nbsp;doing&nbsp;a&nbsp;resumption.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4276675">hs</span><span class="op" id="4276677">.</span><span class="ident" id="4276678">hello</span><span class="op" id="4276683">.</span><span class="ident" id="4276684">sessionId</span>&nbsp;<span class="op" id="4276694">=</span>&nbsp;<span class="ident" id="4276696">hs</span><span class="op" id="4276698">.</span><span class="ident" id="4276699">clientHello</span><span class="op" id="4276710">.</span><span class="ident" id="4276711">sessionId</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4276722">hs</span><span class="op" id="4276724">.</span><span class="ident" id="4276725">finishedHash</span><span class="op" id="4276737">.</span><span class="ident" id="4276738">Write</span><span class="op" id="4276743">(</span><span class="ident" id="4276744">hs</span><span class="op" id="4276746">.</span><span class="ident" id="4276747">hello</span><span class="op" id="4276752">.</span><span class="ident" id="4276753">marshal</span><span class="op" id="4276760">(</span><span class="op" id="4276761">)</span><span class="op" id="4276762">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4276765">c</span><span class="op" id="4276766">.</span><span class="ident" id="4276767">writeRecord</span><span class="op" id="4276778">(</span><span class="ident" id="4276779">recordTypeHandshake</span><span class="op" id="4276798">,</span>&nbsp;<span class="ident" id="4276800">hs</span><span class="op" id="4276802">.</span><span class="ident" id="4276803">hello</span><span class="op" id="4276808">.</span><span class="ident" id="4276809">marshal</span><span class="op" id="4276816">(</span><span class="op" id="4276817">)</span><span class="op" id="4276818">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4276822">if</span>&nbsp;<span class="builtinfunc" id="4276825">len</span><span class="op" id="4276828">(</span><span class="ident" id="4276829">hs</span><span class="op" id="4276831">.</span><span class="ident" id="4276832">sessionState</span><span class="op" id="4276844">.</span><span class="ident" id="4276845">certificates</span><span class="op" id="4276857">)</span>&nbsp;<span class="op" id="4276859">&gt;</span>&nbsp;<span class="num" id="4276861">0</span>&nbsp;<span class="op" id="4276863">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4276867">if</span>&nbsp;<span class="ident" id="4276870">_</span><span class="op" id="4276871">,</span>&nbsp;<span class="ident" id="4276873">err</span>&nbsp;<span class="op" id="4276877">:=</span>&nbsp;<span class="ident" id="4276880">hs</span><span class="op" id="4276882">.</span><span class="ident" id="4276883">processCertsFromClient</span><span class="op" id="4276905">(</span><span class="ident" id="4276906">hs</span><span class="op" id="4276908">.</span><span class="ident" id="4276909">sessionState</span><span class="op" id="4276921">.</span><span class="ident" id="4276922">certificates</span><span class="op" id="4276934">)</span><span class="op" id="4276935">;</span>&nbsp;<span class="ident" id="4276937">err</span>&nbsp;<span class="op" id="4276941">!=</span>&nbsp;<span class="builtintype" id="4276944">nil</span>&nbsp;<span class="op" id="4276948">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4276953">return</span>&nbsp;<span class="ident" id="4276960">err</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4276966">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4276969">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4276973">hs</span><span class="op" id="4276975">.</span><span class="ident" id="4276976">masterSecret</span>&nbsp;<span class="op" id="4276989">=</span>&nbsp;<span class="ident" id="4276991">hs</span><span class="op" id="4276993">.</span><span class="ident" id="4276994">sessionState</span><span class="op" id="4277006">.</span><span class="ident" id="4277007">masterSecret</span><br>
<span class="lineno"></span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4277022">return</span>&nbsp;<span class="builtintype" id="4277029">nil</span><br>
<span class="lineno"></span><span class="op" id="4277033">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4277036">func</span>&nbsp;<span class="op" id="4277041">(</span><span class="ident" id="4277042">hs</span>&nbsp;<span class="op" id="4277045">*</span><span class="ident" id="4277046">serverHandshakeState</span><span class="op" id="4277066">)</span>&nbsp;<span class="ident" id="4277068">doFullHandshake</span><span class="op" id="4277083">(</span><span class="op" id="4277084">)</span>&nbsp;<span class="builtintype" id="4277086">error</span>&nbsp;<span class="op" id="4277092">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4277095">config</span>&nbsp;<span class="op" id="4277102">:=</span>&nbsp;<span class="ident" id="4277105">hs</span><span class="op" id="4277107">.</span><span class="ident" id="4277108">c</span><span class="op" id="4277109">.</span><span class="ident" id="4277110">config</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4277118">c</span>&nbsp;<span class="op" id="4277120">:=</span>&nbsp;<span class="ident" id="4277123">hs</span><span class="op" id="4277125">.</span><span class="ident" id="4277126">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4277130">if</span>&nbsp;<span class="ident" id="4277133">hs</span><span class="op" id="4277135">.</span><span class="ident" id="4277136">clientHello</span><span class="op" id="4277147">.</span><span class="ident" id="4277148">ocspStapling</span>&nbsp;<span class="op" id="4277161">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="4277164">len</span><span class="op" id="4277167">(</span><span class="ident" id="4277168">hs</span><span class="op" id="4277170">.</span><span class="ident" id="4277171">cert</span><span class="op" id="4277175">.</span><span class="ident" id="4277176">OCSPStaple</span><span class="op" id="4277186">)</span>&nbsp;<span class="op" id="4277188">&gt;</span>&nbsp;<span class="num" id="4277190">0</span>&nbsp;<span class="op" id="4277192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4277196">hs</span><span class="op" id="4277198">.</span><span class="ident" id="4277199">hello</span><span class="op" id="4277204">.</span><span class="ident" id="4277205">ocspStapling</span>&nbsp;<span class="op" id="4277218">=</span>&nbsp;<span class="builtintype" id="4277220">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4277226">}</span><br>
<span class="lineno">320</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4277230">hs</span><span class="op" id="4277232">.</span><span class="ident" id="4277233">hello</span><span class="op" id="4277238">.</span><span class="ident" id="4277239">ticketSupported</span>&nbsp;<span class="op" id="4277255">=</span>&nbsp;<span class="ident" id="4277257">hs</span><span class="op" id="4277259">.</span><span class="ident" id="4277260">clientHello</span><span class="op" id="4277271">.</span><span class="ident" id="4277272">ticketSupported</span>&nbsp;<span class="op" id="4277288">&amp;&amp;</span>&nbsp;<span class="op" id="4277291">!</span><span class="ident" id="4277292">config</span><span class="op" id="4277298">.</span><span class="ident" id="4277299">SessionTicketsDisabled</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4277323">hs</span><span class="op" id="4277325">.</span><span class="ident" id="4277326">hello</span><span class="op" id="4277331">.</span><span class="ident" id="4277332">cipherSuite</span>&nbsp;<span class="op" id="4277344">=</span>&nbsp;<span class="ident" id="4277346">hs</span><span class="op" id="4277348">.</span><span class="ident" id="4277349">suite</span><span class="op" id="4277354">.</span><span class="ident" id="4277355">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4277359">hs</span><span class="op" id="4277361">.</span><span class="ident" id="4277362">finishedHash</span><span class="op" id="4277374">.</span><span class="ident" id="4277375">Write</span><span class="op" id="4277380">(</span><span class="ident" id="4277381">hs</span><span class="op" id="4277383">.</span><span class="ident" id="4277384">hello</span><span class="op" id="4277389">.</span><span class="ident" id="4277390">marshal</span><span class="op" id="4277397">(</span><span class="op" id="4277398">)</span><span class="op" id="4277399">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4277402">c</span><span class="op" id="4277403">.</span><span class="ident" id="4277404">writeRecord</span><span class="op" id="4277415">(</span><span class="ident" id="4277416">recordTypeHandshake</span><span class="op" id="4277435">,</span>&nbsp;<span class="ident" id="4277437">hs</span><span class="op" id="4277439">.</span><span class="ident" id="4277440">hello</span><span class="op" id="4277445">.</span><span class="ident" id="4277446">marshal</span><span class="op" id="4277453">(</span><span class="op" id="4277454">)</span><span class="op" id="4277455">)</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4277459">certMsg</span>&nbsp;<span class="op" id="4277467">:=</span>&nbsp;<span class="builtinfunc" id="4277470">new</span><span class="op" id="4277473">(</span><span class="ident" id="4277474">certificateMsg</span><span class="op" id="4277488">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4277491">certMsg</span><span class="op" id="4277498">.</span><span class="ident" id="4277499">certificates</span>&nbsp;<span class="op" id="4277512">=</span>&nbsp;<span class="ident" id="4277514">hs</span><span class="op" id="4277516">.</span><span class="ident" id="4277517">cert</span><span class="op" id="4277521">.</span><span class="ident" id="4277522">Certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4277535">hs</span><span class="op" id="4277537">.</span><span class="ident" id="4277538">finishedHash</span><span class="op" id="4277550">.</span><span class="ident" id="4277551">Write</span><span class="op" id="4277556">(</span><span class="ident" id="4277557">certMsg</span><span class="op" id="4277564">.</span><span class="ident" id="4277565">marshal</span><span class="op" id="4277572">(</span><span class="op" id="4277573">)</span><span class="op" id="4277574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4277577">c</span><span class="op" id="4277578">.</span><span class="ident" id="4277579">writeRecord</span><span class="op" id="4277590">(</span><span class="ident" id="4277591">recordTypeHandshake</span><span class="op" id="4277610">,</span>&nbsp;<span class="ident" id="4277612">certMsg</span><span class="op" id="4277619">.</span><span class="ident" id="4277620">marshal</span><span class="op" id="4277627">(</span><span class="op" id="4277628">)</span><span class="op" id="4277629">)</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4277633">if</span>&nbsp;<span class="ident" id="4277636">hs</span><span class="op" id="4277638">.</span><span class="ident" id="4277639">hello</span><span class="op" id="4277644">.</span><span class="ident" id="4277645">ocspStapling</span>&nbsp;<span class="op" id="4277658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4277662">certStatus</span>&nbsp;<span class="op" id="4277673">:=</span>&nbsp;<span class="builtinfunc" id="4277676">new</span><span class="op" id="4277679">(</span><span class="ident" id="4277680">certificateStatusMsg</span><span class="op" id="4277700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4277704">certStatus</span><span class="op" id="4277714">.</span><span class="ident" id="4277715">statusType</span>&nbsp;<span class="op" id="4277726">=</span>&nbsp;<span class="ident" id="4277728">statusTypeOCSP</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4277745">certStatus</span><span class="op" id="4277755">.</span><span class="ident" id="4277756">response</span>&nbsp;<span class="op" id="4277765">=</span>&nbsp;<span class="ident" id="4277767">hs</span><span class="op" id="4277769">.</span><span class="ident" id="4277770">cert</span><span class="op" id="4277774">.</span><span class="ident" id="4277775">OCSPStaple</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4277788">hs</span><span class="op" id="4277790">.</span><span class="ident" id="4277791">finishedHash</span><span class="op" id="4277803">.</span><span class="ident" id="4277804">Write</span><span class="op" id="4277809">(</span><span class="ident" id="4277810">certStatus</span><span class="op" id="4277820">.</span><span class="ident" id="4277821">marshal</span><span class="op" id="4277828">(</span><span class="op" id="4277829">)</span><span class="op" id="4277830">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4277834">c</span><span class="op" id="4277835">.</span><span class="ident" id="4277836">writeRecord</span><span class="op" id="4277847">(</span><span class="ident" id="4277848">recordTypeHandshake</span><span class="op" id="4277867">,</span>&nbsp;<span class="ident" id="4277869">certStatus</span><span class="op" id="4277879">.</span><span class="ident" id="4277880">marshal</span><span class="op" id="4277887">(</span><span class="op" id="4277888">)</span><span class="op" id="4277889">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4277892">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4277896">keyAgreement</span>&nbsp;<span class="op" id="4277909">:=</span>&nbsp;<span class="ident" id="4277912">hs</span><span class="op" id="4277914">.</span><span class="ident" id="4277915">suite</span><span class="op" id="4277920">.</span><span class="ident" id="4277921">ka</span><span class="op" id="4277923">(</span><span class="ident" id="4277924">c</span><span class="op" id="4277925">.</span><span class="ident" id="4277926">vers</span><span class="op" id="4277930">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4277933">skx</span><span class="op" id="4277936">,</span>&nbsp;<span class="ident" id="4277938">err</span>&nbsp;<span class="op" id="4277942">:=</span>&nbsp;<span class="ident" id="4277945">keyAgreement</span><span class="op" id="4277957">.</span><span class="ident" id="4277958">generateServerKeyExchange</span><span class="op" id="4277983">(</span><span class="ident" id="4277984">config</span><span class="op" id="4277990">,</span>&nbsp;<span class="ident" id="4277992">hs</span><span class="op" id="4277994">.</span><span class="ident" id="4277995">cert</span><span class="op" id="4277999">,</span>&nbsp;<span class="ident" id="4278001">hs</span><span class="op" id="4278003">.</span><span class="ident" id="4278004">clientHello</span><span class="op" id="4278015">,</span>&nbsp;<span class="ident" id="4278017">hs</span><span class="op" id="4278019">.</span><span class="ident" id="4278020">hello</span><span class="op" id="4278025">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4278028">if</span>&nbsp;<span class="ident" id="4278031">err</span>&nbsp;<span class="op" id="4278035">!=</span>&nbsp;<span class="builtintype" id="4278038">nil</span>&nbsp;<span class="op" id="4278042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4278046">c</span><span class="op" id="4278047">.</span><span class="ident" id="4278048">sendAlert</span><span class="op" id="4278057">(</span><span class="ident" id="4278058">alertHandshakeFailure</span><span class="op" id="4278079">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4278083">return</span>&nbsp;<span class="ident" id="4278090">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4278095">}</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4278098">if</span>&nbsp;<span class="ident" id="4278101">skx</span>&nbsp;<span class="op" id="4278105">!=</span>&nbsp;<span class="builtintype" id="4278108">nil</span>&nbsp;<span class="op" id="4278112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4278116">hs</span><span class="op" id="4278118">.</span><span class="ident" id="4278119">finishedHash</span><span class="op" id="4278131">.</span><span class="ident" id="4278132">Write</span><span class="op" id="4278137">(</span><span class="ident" id="4278138">skx</span><span class="op" id="4278141">.</span><span class="ident" id="4278142">marshal</span><span class="op" id="4278149">(</span><span class="op" id="4278150">)</span><span class="op" id="4278151">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4278155">c</span><span class="op" id="4278156">.</span><span class="ident" id="4278157">writeRecord</span><span class="op" id="4278168">(</span><span class="ident" id="4278169">recordTypeHandshake</span><span class="op" id="4278188">,</span>&nbsp;<span class="ident" id="4278190">skx</span><span class="op" id="4278193">.</span><span class="ident" id="4278194">marshal</span><span class="op" id="4278201">(</span><span class="op" id="4278202">)</span><span class="op" id="4278203">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4278206">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4278210">if</span>&nbsp;<span class="ident" id="4278213">config</span><span class="op" id="4278219">.</span><span class="ident" id="4278220">ClientAuth</span>&nbsp;<span class="op" id="4278231">&gt;=</span>&nbsp;<span class="ident" id="4278234">RequestClientCert</span>&nbsp;<span class="op" id="4278252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4278256">//&nbsp;Request&nbsp;a&nbsp;client&nbsp;certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4278290">certReq</span>&nbsp;<span class="op" id="4278298">:=</span>&nbsp;<span class="builtinfunc" id="4278301">new</span><span class="op" id="4278304">(</span><span class="ident" id="4278305">certificateRequestMsg</span><span class="op" id="4278326">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4278330">certReq</span><span class="op" id="4278337">.</span><span class="ident" id="4278338">certificateTypes</span>&nbsp;<span class="op" id="4278355">=</span>&nbsp;<span class="op" id="4278357">[</span><span class="op" id="4278358">]</span><span class="builtintype" id="4278359">byte</span><span class="op" id="4278363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4278368">byte</span><span class="op" id="4278372">(</span><span class="ident" id="4278373">certTypeRSASign</span><span class="op" id="4278388">)</span><span class="op" id="4278389">,</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4278394">byte</span><span class="op" id="4278398">(</span><span class="ident" id="4278399">certTypeECDSASign</span><span class="op" id="4278416">)</span><span class="op" id="4278417">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4278421">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4278425">if</span>&nbsp;<span class="ident" id="4278428">c</span><span class="op" id="4278429">.</span><span class="ident" id="4278430">vers</span>&nbsp;<span class="op" id="4278435">&gt;=</span>&nbsp;<span class="ident" id="4278438">VersionTLS12</span>&nbsp;<span class="op" id="4278451">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4278456">certReq</span><span class="op" id="4278463">.</span><span class="ident" id="4278464">hasSignatureAndHash</span>&nbsp;<span class="op" id="4278484">=</span>&nbsp;<span class="builtintype" id="4278486">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4278494">certReq</span><span class="op" id="4278501">.</span><span class="ident" id="4278502">signatureAndHashes</span>&nbsp;<span class="op" id="4278521">=</span>&nbsp;<span class="ident" id="4278523">supportedClientCertSignatureAlgorithms</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4278564">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4278569">//&nbsp;An&nbsp;empty&nbsp;list&nbsp;of&nbsp;certificateAuthorities&nbsp;signals&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4278625">//&nbsp;the&nbsp;client&nbsp;that&nbsp;it&nbsp;may&nbsp;send&nbsp;any&nbsp;certificate&nbsp;in&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4278686">//&nbsp;to&nbsp;our&nbsp;request.&nbsp;When&nbsp;we&nbsp;know&nbsp;the&nbsp;CAs&nbsp;we&nbsp;trust,&nbsp;then</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4278743">//&nbsp;we&nbsp;can&nbsp;send&nbsp;them&nbsp;down,&nbsp;so&nbsp;that&nbsp;the&nbsp;client&nbsp;can&nbsp;choose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4278801">//&nbsp;an&nbsp;appropriate&nbsp;certificate&nbsp;to&nbsp;give&nbsp;to&nbsp;us.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4278848">if</span>&nbsp;<span class="ident" id="4278851">config</span><span class="op" id="4278857">.</span><span class="ident" id="4278858">ClientCAs</span>&nbsp;<span class="op" id="4278868">!=</span>&nbsp;<span class="builtintype" id="4278871">nil</span>&nbsp;<span class="op" id="4278875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4278880">certReq</span><span class="op" id="4278887">.</span><span class="ident" id="4278888">certificateAuthorities</span>&nbsp;<span class="op" id="4278911">=</span>&nbsp;<span class="ident" id="4278913">config</span><span class="op" id="4278919">.</span><span class="ident" id="4278920">ClientCAs</span><span class="op" id="4278929">.</span><span class="ident" id="4278930">Subjects</span><span class="op" id="4278938">(</span><span class="op" id="4278939">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4278943">}</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4278947">hs</span><span class="op" id="4278949">.</span><span class="ident" id="4278950">finishedHash</span><span class="op" id="4278962">.</span><span class="ident" id="4278963">Write</span><span class="op" id="4278968">(</span><span class="ident" id="4278969">certReq</span><span class="op" id="4278976">.</span><span class="ident" id="4278977">marshal</span><span class="op" id="4278984">(</span><span class="op" id="4278985">)</span><span class="op" id="4278986">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4278990">c</span><span class="op" id="4278991">.</span><span class="ident" id="4278992">writeRecord</span><span class="op" id="4279003">(</span><span class="ident" id="4279004">recordTypeHandshake</span><span class="op" id="4279023">,</span>&nbsp;<span class="ident" id="4279025">certReq</span><span class="op" id="4279032">.</span><span class="ident" id="4279033">marshal</span><span class="op" id="4279040">(</span><span class="op" id="4279041">)</span><span class="op" id="4279042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4279045">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4279049">helloDone</span>&nbsp;<span class="op" id="4279059">:=</span>&nbsp;<span class="builtinfunc" id="4279062">new</span><span class="op" id="4279065">(</span><span class="ident" id="4279066">serverHelloDoneMsg</span><span class="op" id="4279084">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4279087">hs</span><span class="op" id="4279089">.</span><span class="ident" id="4279090">finishedHash</span><span class="op" id="4279102">.</span><span class="ident" id="4279103">Write</span><span class="op" id="4279108">(</span><span class="ident" id="4279109">helloDone</span><span class="op" id="4279118">.</span><span class="ident" id="4279119">marshal</span><span class="op" id="4279126">(</span><span class="op" id="4279127">)</span><span class="op" id="4279128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4279131">c</span><span class="op" id="4279132">.</span><span class="ident" id="4279133">writeRecord</span><span class="op" id="4279144">(</span><span class="ident" id="4279145">recordTypeHandshake</span><span class="op" id="4279164">,</span>&nbsp;<span class="ident" id="4279166">helloDone</span><span class="op" id="4279175">.</span><span class="ident" id="4279176">marshal</span><span class="op" id="4279183">(</span><span class="op" id="4279184">)</span><span class="op" id="4279185">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4279189">var</span>&nbsp;<span class="ident" id="4279193">pub</span>&nbsp;<span class="ident" id="4279197">crypto</span><span class="op" id="4279203">.</span><span class="ident" id="4279204">PublicKey</span>&nbsp;<span class="comment" id="4279214">//&nbsp;public&nbsp;key&nbsp;for&nbsp;client&nbsp;auth,&nbsp;if&nbsp;any</span><br>
<span class="lineno"></span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4279254">msg</span><span class="op" id="4279257">,</span>&nbsp;<span class="ident" id="4279259">err</span>&nbsp;<span class="op" id="4279263">:=</span>&nbsp;<span class="ident" id="4279266">c</span><span class="op" id="4279267">.</span><span class="ident" id="4279268">readHandshake</span><span class="op" id="4279281">(</span><span class="op" id="4279282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4279285">if</span>&nbsp;<span class="ident" id="4279288">err</span>&nbsp;<span class="op" id="4279292">!=</span>&nbsp;<span class="builtintype" id="4279295">nil</span>&nbsp;<span class="op" id="4279299">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4279303">return</span>&nbsp;<span class="ident" id="4279310">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4279315">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4279319">var</span>&nbsp;<span class="ident" id="4279323">ok</span>&nbsp;<span class="builtintype" id="4279326">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4279332">//&nbsp;If&nbsp;we&nbsp;requested&nbsp;a&nbsp;client&nbsp;certificate,&nbsp;then&nbsp;the&nbsp;client&nbsp;must&nbsp;send&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4279402">//&nbsp;certificate&nbsp;message,&nbsp;even&nbsp;if&nbsp;it&#39;s&nbsp;empty.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4279447">if</span>&nbsp;<span class="ident" id="4279450">config</span><span class="op" id="4279456">.</span><span class="ident" id="4279457">ClientAuth</span>&nbsp;<span class="op" id="4279468">&gt;=</span>&nbsp;<span class="ident" id="4279471">RequestClientCert</span>&nbsp;<span class="op" id="4279489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4279493">if</span>&nbsp;<span class="ident" id="4279496">certMsg</span><span class="op" id="4279503">,</span>&nbsp;<span class="ident" id="4279505">ok</span>&nbsp;<span class="op" id="4279508">=</span>&nbsp;<span class="ident" id="4279510">msg</span><span class="op" id="4279513">.</span><span class="op" id="4279514">(</span><span class="op" id="4279515">*</span><span class="ident" id="4279516">certificateMsg</span><span class="op" id="4279530">)</span><span class="op" id="4279531">;</span>&nbsp;<span class="op" id="4279533">!</span><span class="ident" id="4279534">ok</span>&nbsp;<span class="op" id="4279537">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4279542">c</span><span class="op" id="4279543">.</span><span class="ident" id="4279544">sendAlert</span><span class="op" id="4279553">(</span><span class="ident" id="4279554">alertUnexpectedMessage</span><span class="op" id="4279576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4279581">return</span>&nbsp;<span class="ident" id="4279588">unexpectedMessageError</span><span class="op" id="4279610">(</span><span class="ident" id="4279611">certMsg</span><span class="op" id="4279618">,</span>&nbsp;<span class="ident" id="4279620">msg</span><span class="op" id="4279623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4279627">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4279631">hs</span><span class="op" id="4279633">.</span><span class="ident" id="4279634">finishedHash</span><span class="op" id="4279646">.</span><span class="ident" id="4279647">Write</span><span class="op" id="4279652">(</span><span class="ident" id="4279653">certMsg</span><span class="op" id="4279660">.</span><span class="ident" id="4279661">marshal</span><span class="op" id="4279668">(</span><span class="op" id="4279669">)</span><span class="op" id="4279670">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4279675">if</span>&nbsp;<span class="builtinfunc" id="4279678">len</span><span class="op" id="4279681">(</span><span class="ident" id="4279682">certMsg</span><span class="op" id="4279689">.</span><span class="ident" id="4279690">certificates</span><span class="op" id="4279702">)</span>&nbsp;<span class="op" id="4279704">==</span>&nbsp;<span class="num" id="4279707">0</span>&nbsp;<span class="op" id="4279709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4279714">//&nbsp;The&nbsp;client&nbsp;didn&#39;t&nbsp;actually&nbsp;send&nbsp;a&nbsp;certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4279766">switch</span>&nbsp;<span class="ident" id="4279773">config</span><span class="op" id="4279779">.</span><span class="ident" id="4279780">ClientAuth</span>&nbsp;<span class="op" id="4279791">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4279796">case</span>&nbsp;<span class="ident" id="4279801">RequireAnyClientCert</span><span class="op" id="4279821">,</span>&nbsp;<span class="ident" id="4279823">RequireAndVerifyClientCert</span><span class="op" id="4279849">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4279855">c</span><span class="op" id="4279856">.</span><span class="ident" id="4279857">sendAlert</span><span class="op" id="4279866">(</span><span class="ident" id="4279867">alertBadCertificate</span><span class="op" id="4279886">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4279892">return</span>&nbsp;<span class="ident" id="4279899">errors</span><span class="op" id="4279905">.</span><span class="ident" id="4279906">New</span><span class="op" id="4279909">(</span><span class="string" id="4279910">&#34;tls:&nbsp;client&nbsp;didn&#39;t&nbsp;provide&nbsp;a&nbsp;certificate&#34;</span><span class="op" id="4279952">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4279957">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4279961">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4279966">pub</span><span class="op" id="4279969">,</span>&nbsp;<span class="ident" id="4279971">err</span>&nbsp;<span class="op" id="4279975">=</span>&nbsp;<span class="ident" id="4279977">hs</span><span class="op" id="4279979">.</span><span class="ident" id="4279980">processCertsFromClient</span><span class="op" id="4280002">(</span><span class="ident" id="4280003">certMsg</span><span class="op" id="4280010">.</span><span class="ident" id="4280011">certificates</span><span class="op" id="4280023">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4280027">if</span>&nbsp;<span class="ident" id="4280030">err</span>&nbsp;<span class="op" id="4280034">!=</span>&nbsp;<span class="builtintype" id="4280037">nil</span>&nbsp;<span class="op" id="4280041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4280046">return</span>&nbsp;<span class="ident" id="4280053">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4280059">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4280064">msg</span><span class="op" id="4280067">,</span>&nbsp;<span class="ident" id="4280069">err</span>&nbsp;<span class="op" id="4280073">=</span>&nbsp;<span class="ident" id="4280075">c</span><span class="op" id="4280076">.</span><span class="ident" id="4280077">readHandshake</span><span class="op" id="4280090">(</span><span class="op" id="4280091">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4280095">if</span>&nbsp;<span class="ident" id="4280098">err</span>&nbsp;<span class="op" id="4280102">!=</span>&nbsp;<span class="builtintype" id="4280105">nil</span>&nbsp;<span class="op" id="4280109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4280114">return</span>&nbsp;<span class="ident" id="4280121">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4280127">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4280130">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4280134">//&nbsp;Get&nbsp;client&nbsp;key&nbsp;exchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4280162">ckx</span><span class="op" id="4280165">,</span>&nbsp;<span class="ident" id="4280167">ok</span>&nbsp;<span class="op" id="4280170">:=</span>&nbsp;<span class="ident" id="4280173">msg</span><span class="op" id="4280176">.</span><span class="op" id="4280177">(</span><span class="op" id="4280178">*</span><span class="ident" id="4280179">clientKeyExchangeMsg</span><span class="op" id="4280199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4280202">if</span>&nbsp;<span class="op" id="4280205">!</span><span class="ident" id="4280206">ok</span>&nbsp;<span class="op" id="4280209">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4280213">c</span><span class="op" id="4280214">.</span><span class="ident" id="4280215">sendAlert</span><span class="op" id="4280224">(</span><span class="ident" id="4280225">alertUnexpectedMessage</span><span class="op" id="4280247">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4280251">return</span>&nbsp;<span class="ident" id="4280258">unexpectedMessageError</span><span class="op" id="4280280">(</span><span class="ident" id="4280281">ckx</span><span class="op" id="4280284">,</span>&nbsp;<span class="ident" id="4280286">msg</span><span class="op" id="4280289">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4280292">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4280295">hs</span><span class="op" id="4280297">.</span><span class="ident" id="4280298">finishedHash</span><span class="op" id="4280310">.</span><span class="ident" id="4280311">Write</span><span class="op" id="4280316">(</span><span class="ident" id="4280317">ckx</span><span class="op" id="4280320">.</span><span class="ident" id="4280321">marshal</span><span class="op" id="4280328">(</span><span class="op" id="4280329">)</span><span class="op" id="4280330">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4280334">//&nbsp;If&nbsp;we&nbsp;received&nbsp;a&nbsp;client&nbsp;cert&nbsp;in&nbsp;response&nbsp;to&nbsp;our&nbsp;certificate&nbsp;request&nbsp;message,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4280415">//&nbsp;the&nbsp;client&nbsp;will&nbsp;send&nbsp;us&nbsp;a&nbsp;certificateVerifyMsg&nbsp;immediately&nbsp;after&nbsp;the</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4280488">//&nbsp;clientKeyExchangeMsg.&nbsp;&nbsp;This&nbsp;message&nbsp;is&nbsp;a&nbsp;digest&nbsp;of&nbsp;all&nbsp;preceding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4280557">//&nbsp;handshake-layer&nbsp;messages&nbsp;that&nbsp;is&nbsp;signed&nbsp;using&nbsp;the&nbsp;private&nbsp;key&nbsp;corresponding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4280637">//&nbsp;to&nbsp;the&nbsp;client&#39;s&nbsp;certificate.&nbsp;This&nbsp;allows&nbsp;us&nbsp;to&nbsp;verify&nbsp;that&nbsp;the&nbsp;client&nbsp;is&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4280717">//&nbsp;possession&nbsp;of&nbsp;the&nbsp;private&nbsp;key&nbsp;of&nbsp;the&nbsp;certificate.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4280771">if</span>&nbsp;<span class="builtinfunc" id="4280774">len</span><span class="op" id="4280777">(</span><span class="ident" id="4280778">c</span><span class="op" id="4280779">.</span><span class="ident" id="4280780">peerCertificates</span><span class="op" id="4280796">)</span>&nbsp;<span class="op" id="4280798">&gt;</span>&nbsp;<span class="num" id="4280800">0</span>&nbsp;<span class="op" id="4280802">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4280806">msg</span><span class="op" id="4280809">,</span>&nbsp;<span class="ident" id="4280811">err</span>&nbsp;<span class="op" id="4280815">=</span>&nbsp;<span class="ident" id="4280817">c</span><span class="op" id="4280818">.</span><span class="ident" id="4280819">readHandshake</span><span class="op" id="4280832">(</span><span class="op" id="4280833">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4280837">if</span>&nbsp;<span class="ident" id="4280840">err</span>&nbsp;<span class="op" id="4280844">!=</span>&nbsp;<span class="builtintype" id="4280847">nil</span>&nbsp;<span class="op" id="4280851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4280856">return</span>&nbsp;<span class="ident" id="4280863">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4280869">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4280873">certVerify</span><span class="op" id="4280883">,</span>&nbsp;<span class="ident" id="4280885">ok</span>&nbsp;<span class="op" id="4280888">:=</span>&nbsp;<span class="ident" id="4280891">msg</span><span class="op" id="4280894">.</span><span class="op" id="4280895">(</span><span class="op" id="4280896">*</span><span class="ident" id="4280897">certificateVerifyMsg</span><span class="op" id="4280917">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4280921">if</span>&nbsp;<span class="op" id="4280924">!</span><span class="ident" id="4280925">ok</span>&nbsp;<span class="op" id="4280928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4280933">c</span><span class="op" id="4280934">.</span><span class="ident" id="4280935">sendAlert</span><span class="op" id="4280944">(</span><span class="ident" id="4280945">alertUnexpectedMessage</span><span class="op" id="4280967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4280972">return</span>&nbsp;<span class="ident" id="4280979">unexpectedMessageError</span><span class="op" id="4281001">(</span><span class="ident" id="4281002">certVerify</span><span class="op" id="4281012">,</span>&nbsp;<span class="ident" id="4281014">msg</span><span class="op" id="4281017">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4281021">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4281026">switch</span>&nbsp;<span class="ident" id="4281033">key</span>&nbsp;<span class="op" id="4281037">:=</span>&nbsp;<span class="ident" id="4281040">pub</span><span class="op" id="4281043">.</span><span class="op" id="4281044">(</span><span class="keyword" id="4281045">type</span><span class="op" id="4281049">)</span>&nbsp;<span class="op" id="4281051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4281055">case</span>&nbsp;<span class="op" id="4281060">*</span><span class="ident" id="4281061">ecdsa</span><span class="op" id="4281066">.</span><span class="ident" id="4281067">PublicKey</span><span class="op" id="4281076">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4281081">ecdsaSig</span>&nbsp;<span class="op" id="4281090">:=</span>&nbsp;<span class="builtinfunc" id="4281093">new</span><span class="op" id="4281096">(</span><span class="ident" id="4281097">ecdsaSignature</span><span class="op" id="4281111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4281116">if</span>&nbsp;<span class="ident" id="4281119">_</span><span class="op" id="4281120">,</span>&nbsp;<span class="ident" id="4281122">err</span>&nbsp;<span class="op" id="4281126">=</span>&nbsp;<span class="ident" id="4281128">asn1</span><span class="op" id="4281132">.</span><span class="ident" id="4281133">Unmarshal</span><span class="op" id="4281142">(</span><span class="ident" id="4281143">certVerify</span><span class="op" id="4281153">.</span><span class="ident" id="4281154">signature</span><span class="op" id="4281163">,</span>&nbsp;<span class="ident" id="4281165">ecdsaSig</span><span class="op" id="4281173">)</span><span class="op" id="4281174">;</span>&nbsp;<span class="ident" id="4281176">err</span>&nbsp;<span class="op" id="4281180">!=</span>&nbsp;<span class="builtintype" id="4281183">nil</span>&nbsp;<span class="op" id="4281187">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4281193">break</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4281202">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4281207">if</span>&nbsp;<span class="ident" id="4281210">ecdsaSig</span><span class="op" id="4281218">.</span><span class="ident" id="4281219">R</span><span class="op" id="4281220">.</span><span class="ident" id="4281221">Sign</span><span class="op" id="4281225">(</span><span class="op" id="4281226">)</span>&nbsp;<span class="op" id="4281228">&lt;=</span>&nbsp;<span class="num" id="4281231">0</span>&nbsp;<span class="op" id="4281233">||</span>&nbsp;<span class="ident" id="4281236">ecdsaSig</span><span class="op" id="4281244">.</span><span class="ident" id="4281245">S</span><span class="op" id="4281246">.</span><span class="ident" id="4281247">Sign</span><span class="op" id="4281251">(</span><span class="op" id="4281252">)</span>&nbsp;<span class="op" id="4281254">&lt;=</span>&nbsp;<span class="num" id="4281257">0</span>&nbsp;<span class="op" id="4281259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4281265">err</span>&nbsp;<span class="op" id="4281269">=</span>&nbsp;<span class="ident" id="4281271">errors</span><span class="op" id="4281277">.</span><span class="ident" id="4281278">New</span><span class="op" id="4281281">(</span><span class="string" id="4281282">&#34;ECDSA&nbsp;signature&nbsp;contained&nbsp;zero&nbsp;or&nbsp;negative&nbsp;values&#34;</span><span class="op" id="4281333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4281339">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4281348">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4281353">digest</span><span class="op" id="4281359">,</span>&nbsp;<span class="ident" id="4281361">_</span><span class="op" id="4281362">,</span>&nbsp;<span class="ident" id="4281364">_</span>&nbsp;<span class="op" id="4281366">:=</span>&nbsp;<span class="ident" id="4281369">hs</span><span class="op" id="4281371">.</span><span class="ident" id="4281372">finishedHash</span><span class="op" id="4281384">.</span><span class="ident" id="4281385">hashForClientCertificate</span><span class="op" id="4281409">(</span><span class="ident" id="4281410">signatureECDSA</span><span class="op" id="4281424">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4281429">if</span>&nbsp;<span class="op" id="4281432">!</span><span class="ident" id="4281433">ecdsa</span><span class="op" id="4281438">.</span><span class="ident" id="4281439">Verify</span><span class="op" id="4281445">(</span><span class="ident" id="4281446">key</span><span class="op" id="4281449">,</span>&nbsp;<span class="ident" id="4281451">digest</span><span class="op" id="4281457">,</span>&nbsp;<span class="ident" id="4281459">ecdsaSig</span><span class="op" id="4281467">.</span><span class="ident" id="4281468">R</span><span class="op" id="4281469">,</span>&nbsp;<span class="ident" id="4281471">ecdsaSig</span><span class="op" id="4281479">.</span><span class="ident" id="4281480">S</span><span class="op" id="4281481">)</span>&nbsp;<span class="op" id="4281483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4281489">err</span>&nbsp;<span class="op" id="4281493">=</span>&nbsp;<span class="ident" id="4281495">errors</span><span class="op" id="4281501">.</span><span class="ident" id="4281502">New</span><span class="op" id="4281505">(</span><span class="string" id="4281506">&#34;ECDSA&nbsp;verification&nbsp;failure&#34;</span><span class="op" id="4281534">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4281540">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4281549">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4281553">case</span>&nbsp;<span class="op" id="4281558">*</span><span class="ident" id="4281559">rsa</span><span class="op" id="4281562">.</span><span class="ident" id="4281563">PublicKey</span><span class="op" id="4281572">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4281577">digest</span><span class="op" id="4281583">,</span>&nbsp;<span class="ident" id="4281585">hashFunc</span><span class="op" id="4281593">,</span>&nbsp;<span class="ident" id="4281595">_</span>&nbsp;<span class="op" id="4281597">:=</span>&nbsp;<span class="ident" id="4281600">hs</span><span class="op" id="4281602">.</span><span class="ident" id="4281603">finishedHash</span><span class="op" id="4281615">.</span><span class="ident" id="4281616">hashForClientCertificate</span><span class="op" id="4281640">(</span><span class="ident" id="4281641">signatureRSA</span><span class="op" id="4281653">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4281658">err</span>&nbsp;<span class="op" id="4281662">=</span>&nbsp;<span class="ident" id="4281664">rsa</span><span class="op" id="4281667">.</span><span class="ident" id="4281668">VerifyPKCS1v15</span><span class="op" id="4281682">(</span><span class="ident" id="4281683">key</span><span class="op" id="4281686">,</span>&nbsp;<span class="ident" id="4281688">hashFunc</span><span class="op" id="4281696">,</span>&nbsp;<span class="ident" id="4281698">digest</span><span class="op" id="4281704">,</span>&nbsp;<span class="ident" id="4281706">certVerify</span><span class="op" id="4281716">.</span><span class="ident" id="4281717">signature</span><span class="op" id="4281726">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4281730">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4281734">if</span>&nbsp;<span class="ident" id="4281737">err</span>&nbsp;<span class="op" id="4281741">!=</span>&nbsp;<span class="builtintype" id="4281744">nil</span>&nbsp;<span class="op" id="4281748">{</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4281753">c</span><span class="op" id="4281754">.</span><span class="ident" id="4281755">sendAlert</span><span class="op" id="4281764">(</span><span class="ident" id="4281765">alertBadCertificate</span><span class="op" id="4281784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4281789">return</span>&nbsp;<span class="ident" id="4281796">errors</span><span class="op" id="4281802">.</span><span class="ident" id="4281803">New</span><span class="op" id="4281806">(</span><span class="string" id="4281807">&#34;could&nbsp;not&nbsp;validate&nbsp;signature&nbsp;of&nbsp;connection&nbsp;nonces:&nbsp;&#34;</span>&nbsp;<span class="op" id="4281861">+</span>&nbsp;<span class="ident" id="4281863">err</span><span class="op" id="4281866">.</span><span class="ident" id="4281867">Error</span><span class="op" id="4281872">(</span><span class="op" id="4281873">)</span><span class="op" id="4281874">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4281878">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4281883">hs</span><span class="op" id="4281885">.</span><span class="ident" id="4281886">finishedHash</span><span class="op" id="4281898">.</span><span class="ident" id="4281899">Write</span><span class="op" id="4281904">(</span><span class="ident" id="4281905">certVerify</span><span class="op" id="4281915">.</span><span class="ident" id="4281916">marshal</span><span class="op" id="4281923">(</span><span class="op" id="4281924">)</span><span class="op" id="4281925">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4281928">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4281932">preMasterSecret</span><span class="op" id="4281947">,</span>&nbsp;<span class="ident" id="4281949">err</span>&nbsp;<span class="op" id="4281953">:=</span>&nbsp;<span class="ident" id="4281956">keyAgreement</span><span class="op" id="4281968">.</span><span class="ident" id="4281969">processClientKeyExchange</span><span class="op" id="4281993">(</span><span class="ident" id="4281994">config</span><span class="op" id="4282000">,</span>&nbsp;<span class="ident" id="4282002">hs</span><span class="op" id="4282004">.</span><span class="ident" id="4282005">cert</span><span class="op" id="4282009">,</span>&nbsp;<span class="ident" id="4282011">ckx</span><span class="op" id="4282014">,</span>&nbsp;<span class="ident" id="4282016">c</span><span class="op" id="4282017">.</span><span class="ident" id="4282018">vers</span><span class="op" id="4282022">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4282025">if</span>&nbsp;<span class="ident" id="4282028">err</span>&nbsp;<span class="op" id="4282032">!=</span>&nbsp;<span class="builtintype" id="4282035">nil</span>&nbsp;<span class="op" id="4282039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4282043">c</span><span class="op" id="4282044">.</span><span class="ident" id="4282045">sendAlert</span><span class="op" id="4282054">(</span><span class="ident" id="4282055">alertHandshakeFailure</span><span class="op" id="4282076">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4282080">return</span>&nbsp;<span class="ident" id="4282087">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4282092">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4282095">hs</span><span class="op" id="4282097">.</span><span class="ident" id="4282098">masterSecret</span>&nbsp;<span class="op" id="4282111">=</span>&nbsp;<span class="ident" id="4282113">masterFromPreMasterSecret</span><span class="op" id="4282138">(</span><span class="ident" id="4282139">c</span><span class="op" id="4282140">.</span><span class="ident" id="4282141">vers</span><span class="op" id="4282145">,</span>&nbsp;<span class="ident" id="4282147">preMasterSecret</span><span class="op" id="4282162">,</span>&nbsp;<span class="ident" id="4282164">hs</span><span class="op" id="4282166">.</span><span class="ident" id="4282167">clientHello</span><span class="op" id="4282178">.</span><span class="ident" id="4282179">random</span><span class="op" id="4282185">,</span>&nbsp;<span class="ident" id="4282187">hs</span><span class="op" id="4282189">.</span><span class="ident" id="4282190">hello</span><span class="op" id="4282195">.</span><span class="ident" id="4282196">random</span><span class="op" id="4282202">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4282206">return</span>&nbsp;<span class="builtintype" id="4282213">nil</span><br>
<span class="lineno">475</span><span class="op" id="4282217">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4282220">func</span>&nbsp;<span class="op" id="4282225">(</span><span class="ident" id="4282226">hs</span>&nbsp;<span class="op" id="4282229">*</span><span class="ident" id="4282230">serverHandshakeState</span><span class="op" id="4282250">)</span>&nbsp;<span class="ident" id="4282252">establishKeys</span><span class="op" id="4282265">(</span><span class="op" id="4282266">)</span>&nbsp;<span class="builtintype" id="4282268">error</span>&nbsp;<span class="op" id="4282274">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4282277">c</span>&nbsp;<span class="op" id="4282279">:=</span>&nbsp;<span class="ident" id="4282282">hs</span><span class="op" id="4282284">.</span><span class="ident" id="4282285">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4282289">clientMAC</span><span class="op" id="4282298">,</span>&nbsp;<span class="ident" id="4282300">serverMAC</span><span class="op" id="4282309">,</span>&nbsp;<span class="ident" id="4282311">clientKey</span><span class="op" id="4282320">,</span>&nbsp;<span class="ident" id="4282322">serverKey</span><span class="op" id="4282331">,</span>&nbsp;<span class="ident" id="4282333">clientIV</span><span class="op" id="4282341">,</span>&nbsp;<span class="ident" id="4282343">serverIV</span>&nbsp;<span class="op" id="4282352">:=</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4282357">keysFromMasterSecret</span><span class="op" id="4282377">(</span><span class="ident" id="4282378">c</span><span class="op" id="4282379">.</span><span class="ident" id="4282380">vers</span><span class="op" id="4282384">,</span>&nbsp;<span class="ident" id="4282386">hs</span><span class="op" id="4282388">.</span><span class="ident" id="4282389">masterSecret</span><span class="op" id="4282401">,</span>&nbsp;<span class="ident" id="4282403">hs</span><span class="op" id="4282405">.</span><span class="ident" id="4282406">clientHello</span><span class="op" id="4282417">.</span><span class="ident" id="4282418">random</span><span class="op" id="4282424">,</span>&nbsp;<span class="ident" id="4282426">hs</span><span class="op" id="4282428">.</span><span class="ident" id="4282429">hello</span><span class="op" id="4282434">.</span><span class="ident" id="4282435">random</span><span class="op" id="4282441">,</span>&nbsp;<span class="ident" id="4282443">hs</span><span class="op" id="4282445">.</span><span class="ident" id="4282446">suite</span><span class="op" id="4282451">.</span><span class="ident" id="4282452">macLen</span><span class="op" id="4282458">,</span>&nbsp;<span class="ident" id="4282460">hs</span><span class="op" id="4282462">.</span><span class="ident" id="4282463">suite</span><span class="op" id="4282468">.</span><span class="ident" id="4282469">keyLen</span><span class="op" id="4282475">,</span>&nbsp;<span class="ident" id="4282477">hs</span><span class="op" id="4282479">.</span><span class="ident" id="4282480">suite</span><span class="op" id="4282485">.</span><span class="ident" id="4282486">ivLen</span><span class="op" id="4282491">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4282495">var</span>&nbsp;<span class="ident" id="4282499">clientCipher</span><span class="op" id="4282511">,</span>&nbsp;<span class="ident" id="4282513">serverCipher</span>&nbsp;<span class="keyword" id="4282526">interface</span><span class="op" id="4282535">{</span><span class="op" id="4282536">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4282539">var</span>&nbsp;<span class="ident" id="4282543">clientHash</span><span class="op" id="4282553">,</span>&nbsp;<span class="ident" id="4282555">serverHash</span>&nbsp;<span class="ident" id="4282566">macFunction</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4282580">if</span>&nbsp;<span class="ident" id="4282583">hs</span><span class="op" id="4282585">.</span><span class="ident" id="4282586">suite</span><span class="op" id="4282591">.</span><span class="ident" id="4282592">aead</span>&nbsp;<span class="op" id="4282597">==</span>&nbsp;<span class="builtintype" id="4282600">nil</span>&nbsp;<span class="op" id="4282604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4282608">clientCipher</span>&nbsp;<span class="op" id="4282621">=</span>&nbsp;<span class="ident" id="4282623">hs</span><span class="op" id="4282625">.</span><span class="ident" id="4282626">suite</span><span class="op" id="4282631">.</span><span class="ident" id="4282632">cipher</span><span class="op" id="4282638">(</span><span class="ident" id="4282639">clientKey</span><span class="op" id="4282648">,</span>&nbsp;<span class="ident" id="4282650">clientIV</span><span class="op" id="4282658">,</span>&nbsp;<span class="builtintype" id="4282660">true</span>&nbsp;<span class="comment" id="4282665">/*&nbsp;for&nbsp;reading&nbsp;*/</span><span class="op" id="4282682">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4282686">clientHash</span>&nbsp;<span class="op" id="4282697">=</span>&nbsp;<span class="ident" id="4282699">hs</span><span class="op" id="4282701">.</span><span class="ident" id="4282702">suite</span><span class="op" id="4282707">.</span><span class="ident" id="4282708">mac</span><span class="op" id="4282711">(</span><span class="ident" id="4282712">c</span><span class="op" id="4282713">.</span><span class="ident" id="4282714">vers</span><span class="op" id="4282718">,</span>&nbsp;<span class="ident" id="4282720">clientMAC</span><span class="op" id="4282729">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4282733">serverCipher</span>&nbsp;<span class="op" id="4282746">=</span>&nbsp;<span class="ident" id="4282748">hs</span><span class="op" id="4282750">.</span><span class="ident" id="4282751">suite</span><span class="op" id="4282756">.</span><span class="ident" id="4282757">cipher</span><span class="op" id="4282763">(</span><span class="ident" id="4282764">serverKey</span><span class="op" id="4282773">,</span>&nbsp;<span class="ident" id="4282775">serverIV</span><span class="op" id="4282783">,</span>&nbsp;<span class="builtintype" id="4282785">false</span>&nbsp;<span class="comment" id="4282791">/*&nbsp;not&nbsp;for&nbsp;reading&nbsp;*/</span><span class="op" id="4282812">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4282816">serverHash</span>&nbsp;<span class="op" id="4282827">=</span>&nbsp;<span class="ident" id="4282829">hs</span><span class="op" id="4282831">.</span><span class="ident" id="4282832">suite</span><span class="op" id="4282837">.</span><span class="ident" id="4282838">mac</span><span class="op" id="4282841">(</span><span class="ident" id="4282842">c</span><span class="op" id="4282843">.</span><span class="ident" id="4282844">vers</span><span class="op" id="4282848">,</span>&nbsp;<span class="ident" id="4282850">serverMAC</span><span class="op" id="4282859">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4282862">}</span>&nbsp;<span class="keyword" id="4282864">else</span>&nbsp;<span class="op" id="4282869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4282873">clientCipher</span>&nbsp;<span class="op" id="4282886">=</span>&nbsp;<span class="ident" id="4282888">hs</span><span class="op" id="4282890">.</span><span class="ident" id="4282891">suite</span><span class="op" id="4282896">.</span><span class="ident" id="4282897">aead</span><span class="op" id="4282901">(</span><span class="ident" id="4282902">clientKey</span><span class="op" id="4282911">,</span>&nbsp;<span class="ident" id="4282913">clientIV</span><span class="op" id="4282921">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4282925">serverCipher</span>&nbsp;<span class="op" id="4282938">=</span>&nbsp;<span class="ident" id="4282940">hs</span><span class="op" id="4282942">.</span><span class="ident" id="4282943">suite</span><span class="op" id="4282948">.</span><span class="ident" id="4282949">aead</span><span class="op" id="4282953">(</span><span class="ident" id="4282954">serverKey</span><span class="op" id="4282963">,</span>&nbsp;<span class="ident" id="4282965">serverIV</span><span class="op" id="4282973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4282976">}</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4282980">c</span><span class="op" id="4282981">.</span><span class="ident" id="4282982">in</span><span class="op" id="4282984">.</span><span class="ident" id="4282985">prepareCipherSpec</span><span class="op" id="4283002">(</span><span class="ident" id="4283003">c</span><span class="op" id="4283004">.</span><span class="ident" id="4283005">vers</span><span class="op" id="4283009">,</span>&nbsp;<span class="ident" id="4283011">clientCipher</span><span class="op" id="4283023">,</span>&nbsp;<span class="ident" id="4283025">clientHash</span><span class="op" id="4283035">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4283038">c</span><span class="op" id="4283039">.</span><span class="ident" id="4283040">out</span><span class="op" id="4283043">.</span><span class="ident" id="4283044">prepareCipherSpec</span><span class="op" id="4283061">(</span><span class="ident" id="4283062">c</span><span class="op" id="4283063">.</span><span class="ident" id="4283064">vers</span><span class="op" id="4283068">,</span>&nbsp;<span class="ident" id="4283070">serverCipher</span><span class="op" id="4283082">,</span>&nbsp;<span class="ident" id="4283084">serverHash</span><span class="op" id="4283094">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4283098">return</span>&nbsp;<span class="builtintype" id="4283105">nil</span><br>
<span class="lineno">500</span><span class="op" id="4283109">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4283112">func</span>&nbsp;<span class="op" id="4283117">(</span><span class="ident" id="4283118">hs</span>&nbsp;<span class="op" id="4283121">*</span><span class="ident" id="4283122">serverHandshakeState</span><span class="op" id="4283142">)</span>&nbsp;<span class="ident" id="4283144">readFinished</span><span class="op" id="4283156">(</span><span class="ident" id="4283157">out</span>&nbsp;<span class="op" id="4283161">[</span><span class="op" id="4283162">]</span><span class="builtintype" id="4283163">byte</span><span class="op" id="4283167">)</span>&nbsp;<span class="builtintype" id="4283169">error</span>&nbsp;<span class="op" id="4283175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4283178">c</span>&nbsp;<span class="op" id="4283180">:=</span>&nbsp;<span class="ident" id="4283183">hs</span><span class="op" id="4283185">.</span><span class="ident" id="4283186">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4283190">c</span><span class="op" id="4283191">.</span><span class="ident" id="4283192">readRecord</span><span class="op" id="4283202">(</span><span class="ident" id="4283203">recordTypeChangeCipherSpec</span><span class="op" id="4283229">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4283232">if</span>&nbsp;<span class="ident" id="4283235">err</span>&nbsp;<span class="op" id="4283239">:=</span>&nbsp;<span class="ident" id="4283242">c</span><span class="op" id="4283243">.</span><span class="ident" id="4283244">in</span><span class="op" id="4283246">.</span><span class="builtintype" id="4283247">error</span><span class="op" id="4283252">(</span><span class="op" id="4283253">)</span><span class="op" id="4283254">;</span>&nbsp;<span class="ident" id="4283256">err</span>&nbsp;<span class="op" id="4283260">!=</span>&nbsp;<span class="builtintype" id="4283263">nil</span>&nbsp;<span class="op" id="4283267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4283271">return</span>&nbsp;<span class="ident" id="4283278">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4283283">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4283287">if</span>&nbsp;<span class="ident" id="4283290">hs</span><span class="op" id="4283292">.</span><span class="ident" id="4283293">hello</span><span class="op" id="4283298">.</span><span class="ident" id="4283299">nextProtoNeg</span>&nbsp;<span class="op" id="4283312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4283316">msg</span><span class="op" id="4283319">,</span>&nbsp;<span class="ident" id="4283321">err</span>&nbsp;<span class="op" id="4283325">:=</span>&nbsp;<span class="ident" id="4283328">c</span><span class="op" id="4283329">.</span><span class="ident" id="4283330">readHandshake</span><span class="op" id="4283343">(</span><span class="op" id="4283344">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4283348">if</span>&nbsp;<span class="ident" id="4283351">err</span>&nbsp;<span class="op" id="4283355">!=</span>&nbsp;<span class="builtintype" id="4283358">nil</span>&nbsp;<span class="op" id="4283362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4283367">return</span>&nbsp;<span class="ident" id="4283374">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4283380">}</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4283384">nextProto</span><span class="op" id="4283393">,</span>&nbsp;<span class="ident" id="4283395">ok</span>&nbsp;<span class="op" id="4283398">:=</span>&nbsp;<span class="ident" id="4283401">msg</span><span class="op" id="4283404">.</span><span class="op" id="4283405">(</span><span class="op" id="4283406">*</span><span class="ident" id="4283407">nextProtoMsg</span><span class="op" id="4283419">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4283423">if</span>&nbsp;<span class="op" id="4283426">!</span><span class="ident" id="4283427">ok</span>&nbsp;<span class="op" id="4283430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4283435">c</span><span class="op" id="4283436">.</span><span class="ident" id="4283437">sendAlert</span><span class="op" id="4283446">(</span><span class="ident" id="4283447">alertUnexpectedMessage</span><span class="op" id="4283469">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4283474">return</span>&nbsp;<span class="ident" id="4283481">unexpectedMessageError</span><span class="op" id="4283503">(</span><span class="ident" id="4283504">nextProto</span><span class="op" id="4283513">,</span>&nbsp;<span class="ident" id="4283515">msg</span><span class="op" id="4283518">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4283522">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4283526">hs</span><span class="op" id="4283528">.</span><span class="ident" id="4283529">finishedHash</span><span class="op" id="4283541">.</span><span class="ident" id="4283542">Write</span><span class="op" id="4283547">(</span><span class="ident" id="4283548">nextProto</span><span class="op" id="4283557">.</span><span class="ident" id="4283558">marshal</span><span class="op" id="4283565">(</span><span class="op" id="4283566">)</span><span class="op" id="4283567">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4283571">c</span><span class="op" id="4283572">.</span><span class="ident" id="4283573">clientProtocol</span>&nbsp;<span class="op" id="4283588">=</span>&nbsp;<span class="ident" id="4283590">nextProto</span><span class="op" id="4283599">.</span><span class="ident" id="4283600">proto</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4283607">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4283611">msg</span><span class="op" id="4283614">,</span>&nbsp;<span class="ident" id="4283616">err</span>&nbsp;<span class="op" id="4283620">:=</span>&nbsp;<span class="ident" id="4283623">c</span><span class="op" id="4283624">.</span><span class="ident" id="4283625">readHandshake</span><span class="op" id="4283638">(</span><span class="op" id="4283639">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4283642">if</span>&nbsp;<span class="ident" id="4283645">err</span>&nbsp;<span class="op" id="4283649">!=</span>&nbsp;<span class="builtintype" id="4283652">nil</span>&nbsp;<span class="op" id="4283656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4283660">return</span>&nbsp;<span class="ident" id="4283667">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4283672">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4283675">clientFinished</span><span class="op" id="4283689">,</span>&nbsp;<span class="ident" id="4283691">ok</span>&nbsp;<span class="op" id="4283694">:=</span>&nbsp;<span class="ident" id="4283697">msg</span><span class="op" id="4283700">.</span><span class="op" id="4283701">(</span><span class="op" id="4283702">*</span><span class="ident" id="4283703">finishedMsg</span><span class="op" id="4283714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4283717">if</span>&nbsp;<span class="op" id="4283720">!</span><span class="ident" id="4283721">ok</span>&nbsp;<span class="op" id="4283724">{</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4283728">c</span><span class="op" id="4283729">.</span><span class="ident" id="4283730">sendAlert</span><span class="op" id="4283739">(</span><span class="ident" id="4283740">alertUnexpectedMessage</span><span class="op" id="4283762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4283766">return</span>&nbsp;<span class="ident" id="4283773">unexpectedMessageError</span><span class="op" id="4283795">(</span><span class="ident" id="4283796">clientFinished</span><span class="op" id="4283810">,</span>&nbsp;<span class="ident" id="4283812">msg</span><span class="op" id="4283815">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4283818">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4283822">verify</span>&nbsp;<span class="op" id="4283829">:=</span>&nbsp;<span class="ident" id="4283832">hs</span><span class="op" id="4283834">.</span><span class="ident" id="4283835">finishedHash</span><span class="op" id="4283847">.</span><span class="ident" id="4283848">clientSum</span><span class="op" id="4283857">(</span><span class="ident" id="4283858">hs</span><span class="op" id="4283860">.</span><span class="ident" id="4283861">masterSecret</span><span class="op" id="4283873">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4283876">if</span>&nbsp;<span class="builtinfunc" id="4283879">len</span><span class="op" id="4283882">(</span><span class="ident" id="4283883">verify</span><span class="op" id="4283889">)</span>&nbsp;<span class="op" id="4283891">!=</span>&nbsp;<span class="builtinfunc" id="4283894">len</span><span class="op" id="4283897">(</span><span class="ident" id="4283898">clientFinished</span><span class="op" id="4283912">.</span><span class="ident" id="4283913">verifyData</span><span class="op" id="4283923">)</span>&nbsp;<span class="op" id="4283925">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4283930">subtle</span><span class="op" id="4283936">.</span><span class="ident" id="4283937">ConstantTimeCompare</span><span class="op" id="4283956">(</span><span class="ident" id="4283957">verify</span><span class="op" id="4283963">,</span>&nbsp;<span class="ident" id="4283965">clientFinished</span><span class="op" id="4283979">.</span><span class="ident" id="4283980">verifyData</span><span class="op" id="4283990">)</span>&nbsp;<span class="op" id="4283992">!=</span>&nbsp;<span class="num" id="4283995">1</span>&nbsp;<span class="op" id="4283997">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4284001">c</span><span class="op" id="4284002">.</span><span class="ident" id="4284003">sendAlert</span><span class="op" id="4284012">(</span><span class="ident" id="4284013">alertHandshakeFailure</span><span class="op" id="4284034">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4284038">return</span>&nbsp;<span class="ident" id="4284045">errors</span><span class="op" id="4284051">.</span><span class="ident" id="4284052">New</span><span class="op" id="4284055">(</span><span class="string" id="4284056">&#34;tls:&nbsp;client&#39;s&nbsp;Finished&nbsp;message&nbsp;is&nbsp;incorrect&#34;</span><span class="op" id="4284101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4284104">}</span><br>
<span class="lineno">540</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4284108">hs</span><span class="op" id="4284110">.</span><span class="ident" id="4284111">finishedHash</span><span class="op" id="4284123">.</span><span class="ident" id="4284124">Write</span><span class="op" id="4284129">(</span><span class="ident" id="4284130">clientFinished</span><span class="op" id="4284144">.</span><span class="ident" id="4284145">marshal</span><span class="op" id="4284152">(</span><span class="op" id="4284153">)</span><span class="op" id="4284154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4284157">copy</span><span class="op" id="4284161">(</span><span class="ident" id="4284162">out</span><span class="op" id="4284165">,</span>&nbsp;<span class="ident" id="4284167">verify</span><span class="op" id="4284173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4284176">return</span>&nbsp;<span class="builtintype" id="4284183">nil</span><br>
<span class="lineno"></span><span class="op" id="4284187">}</span><br>
<span class="lineno">545</span><br>
<span class="lineno"></span><span class="keyword" id="4284190">func</span>&nbsp;<span class="op" id="4284195">(</span><span class="ident" id="4284196">hs</span>&nbsp;<span class="op" id="4284199">*</span><span class="ident" id="4284200">serverHandshakeState</span><span class="op" id="4284220">)</span>&nbsp;<span class="ident" id="4284222">sendSessionTicket</span><span class="op" id="4284239">(</span><span class="op" id="4284240">)</span>&nbsp;<span class="builtintype" id="4284242">error</span>&nbsp;<span class="op" id="4284248">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4284251">if</span>&nbsp;<span class="op" id="4284254">!</span><span class="ident" id="4284255">hs</span><span class="op" id="4284257">.</span><span class="ident" id="4284258">hello</span><span class="op" id="4284263">.</span><span class="ident" id="4284264">ticketSupported</span>&nbsp;<span class="op" id="4284280">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4284284">return</span>&nbsp;<span class="builtintype" id="4284291">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4284296">}</span><br>
<span class="lineno">550</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4284300">c</span>&nbsp;<span class="op" id="4284302">:=</span>&nbsp;<span class="ident" id="4284305">hs</span><span class="op" id="4284307">.</span><span class="ident" id="4284308">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4284311">m</span>&nbsp;<span class="op" id="4284313">:=</span>&nbsp;<span class="builtinfunc" id="4284316">new</span><span class="op" id="4284319">(</span><span class="ident" id="4284320">newSessionTicketMsg</span><span class="op" id="4284339">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4284343">var</span>&nbsp;<span class="ident" id="4284347">err</span>&nbsp;<span class="builtintype" id="4284351">error</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4284358">state</span>&nbsp;<span class="op" id="4284364">:=</span>&nbsp;<span class="ident" id="4284367">sessionState</span><span class="op" id="4284379">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4284383">vers</span><span class="op" id="4284387">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4284397">c</span><span class="op" id="4284398">.</span><span class="ident" id="4284399">vers</span><span class="op" id="4284403">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4284407">cipherSuite</span><span class="op" id="4284418">:</span>&nbsp;&nbsp;<span class="ident" id="4284421">hs</span><span class="op" id="4284423">.</span><span class="ident" id="4284424">suite</span><span class="op" id="4284429">.</span><span class="ident" id="4284430">id</span><span class="op" id="4284432">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4284436">masterSecret</span><span class="op" id="4284448">:</span>&nbsp;<span class="ident" id="4284450">hs</span><span class="op" id="4284452">.</span><span class="ident" id="4284453">masterSecret</span><span class="op" id="4284465">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4284469">certificates</span><span class="op" id="4284481">:</span>&nbsp;<span class="ident" id="4284483">hs</span><span class="op" id="4284485">.</span><span class="ident" id="4284486">certsFromClient</span><span class="op" id="4284501">,</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4284504">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4284507">m</span><span class="op" id="4284508">.</span><span class="ident" id="4284509">ticket</span><span class="op" id="4284515">,</span>&nbsp;<span class="ident" id="4284517">err</span>&nbsp;<span class="op" id="4284521">=</span>&nbsp;<span class="ident" id="4284523">c</span><span class="op" id="4284524">.</span><span class="ident" id="4284525">encryptTicket</span><span class="op" id="4284538">(</span><span class="op" id="4284539">&amp;</span><span class="ident" id="4284540">state</span><span class="op" id="4284545">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4284548">if</span>&nbsp;<span class="ident" id="4284551">err</span>&nbsp;<span class="op" id="4284555">!=</span>&nbsp;<span class="builtintype" id="4284558">nil</span>&nbsp;<span class="op" id="4284562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4284566">return</span>&nbsp;<span class="ident" id="4284573">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4284578">}</span><br>
<span class="lineno">565</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4284582">hs</span><span class="op" id="4284584">.</span><span class="ident" id="4284585">finishedHash</span><span class="op" id="4284597">.</span><span class="ident" id="4284598">Write</span><span class="op" id="4284603">(</span><span class="ident" id="4284604">m</span><span class="op" id="4284605">.</span><span class="ident" id="4284606">marshal</span><span class="op" id="4284613">(</span><span class="op" id="4284614">)</span><span class="op" id="4284615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4284618">c</span><span class="op" id="4284619">.</span><span class="ident" id="4284620">writeRecord</span><span class="op" id="4284631">(</span><span class="ident" id="4284632">recordTypeHandshake</span><span class="op" id="4284651">,</span>&nbsp;<span class="ident" id="4284653">m</span><span class="op" id="4284654">.</span><span class="ident" id="4284655">marshal</span><span class="op" id="4284662">(</span><span class="op" id="4284663">)</span><span class="op" id="4284664">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4284668">return</span>&nbsp;<span class="builtintype" id="4284675">nil</span><br>
<span class="lineno">570</span><span class="op" id="4284679">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4284682">func</span>&nbsp;<span class="op" id="4284687">(</span><span class="ident" id="4284688">hs</span>&nbsp;<span class="op" id="4284691">*</span><span class="ident" id="4284692">serverHandshakeState</span><span class="op" id="4284712">)</span>&nbsp;<span class="ident" id="4284714">sendFinished</span><span class="op" id="4284726">(</span><span class="ident" id="4284727">out</span>&nbsp;<span class="op" id="4284731">[</span><span class="op" id="4284732">]</span><span class="builtintype" id="4284733">byte</span><span class="op" id="4284737">)</span>&nbsp;<span class="builtintype" id="4284739">error</span>&nbsp;<span class="op" id="4284745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4284748">c</span>&nbsp;<span class="op" id="4284750">:=</span>&nbsp;<span class="ident" id="4284753">hs</span><span class="op" id="4284755">.</span><span class="ident" id="4284756">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4284760">c</span><span class="op" id="4284761">.</span><span class="ident" id="4284762">writeRecord</span><span class="op" id="4284773">(</span><span class="ident" id="4284774">recordTypeChangeCipherSpec</span><span class="op" id="4284800">,</span>&nbsp;<span class="op" id="4284802">[</span><span class="op" id="4284803">]</span><span class="builtintype" id="4284804">byte</span><span class="op" id="4284808">{</span><span class="num" id="4284809">1</span><span class="op" id="4284810">}</span><span class="op" id="4284811">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4284815">finished</span>&nbsp;<span class="op" id="4284824">:=</span>&nbsp;<span class="builtinfunc" id="4284827">new</span><span class="op" id="4284830">(</span><span class="ident" id="4284831">finishedMsg</span><span class="op" id="4284842">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4284845">finished</span><span class="op" id="4284853">.</span><span class="ident" id="4284854">verifyData</span>&nbsp;<span class="op" id="4284865">=</span>&nbsp;<span class="ident" id="4284867">hs</span><span class="op" id="4284869">.</span><span class="ident" id="4284870">finishedHash</span><span class="op" id="4284882">.</span><span class="ident" id="4284883">serverSum</span><span class="op" id="4284892">(</span><span class="ident" id="4284893">hs</span><span class="op" id="4284895">.</span><span class="ident" id="4284896">masterSecret</span><span class="op" id="4284908">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4284911">hs</span><span class="op" id="4284913">.</span><span class="ident" id="4284914">finishedHash</span><span class="op" id="4284926">.</span><span class="ident" id="4284927">Write</span><span class="op" id="4284932">(</span><span class="ident" id="4284933">finished</span><span class="op" id="4284941">.</span><span class="ident" id="4284942">marshal</span><span class="op" id="4284949">(</span><span class="op" id="4284950">)</span><span class="op" id="4284951">)</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4284954">c</span><span class="op" id="4284955">.</span><span class="ident" id="4284956">writeRecord</span><span class="op" id="4284967">(</span><span class="ident" id="4284968">recordTypeHandshake</span><span class="op" id="4284987">,</span>&nbsp;<span class="ident" id="4284989">finished</span><span class="op" id="4284997">.</span><span class="ident" id="4284998">marshal</span><span class="op" id="4285005">(</span><span class="op" id="4285006">)</span><span class="op" id="4285007">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4285011">c</span><span class="op" id="4285012">.</span><span class="ident" id="4285013">cipherSuite</span>&nbsp;<span class="op" id="4285025">=</span>&nbsp;<span class="ident" id="4285027">hs</span><span class="op" id="4285029">.</span><span class="ident" id="4285030">suite</span><span class="op" id="4285035">.</span><span class="ident" id="4285036">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4285040">copy</span><span class="op" id="4285044">(</span><span class="ident" id="4285045">out</span><span class="op" id="4285048">,</span>&nbsp;<span class="ident" id="4285050">finished</span><span class="op" id="4285058">.</span><span class="ident" id="4285059">verifyData</span><span class="op" id="4285069">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4285073">return</span>&nbsp;<span class="builtintype" id="4285080">nil</span><br>
<span class="lineno"></span><span class="op" id="4285084">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4285087">//&nbsp;processCertsFromClient&nbsp;takes&nbsp;a&nbsp;chain&nbsp;of&nbsp;client&nbsp;certificates&nbsp;either&nbsp;from&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4285164">//&nbsp;Certificates&nbsp;message&nbsp;or&nbsp;from&nbsp;a&nbsp;sessionState&nbsp;and&nbsp;verifies&nbsp;them.&nbsp;It&nbsp;returns</span><br>
<span class="lineno">590</span><span class="comment" id="4285241">//&nbsp;the&nbsp;public&nbsp;key&nbsp;of&nbsp;the&nbsp;leaf&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="keyword" id="4285284">func</span>&nbsp;<span class="op" id="4285289">(</span><span class="ident" id="4285290">hs</span>&nbsp;<span class="op" id="4285293">*</span><span class="ident" id="4285294">serverHandshakeState</span><span class="op" id="4285314">)</span>&nbsp;<span class="ident" id="4285316">processCertsFromClient</span><span class="op" id="4285338">(</span><span class="ident" id="4285339">certificates</span>&nbsp;<span class="op" id="4285352">[</span><span class="op" id="4285353">]</span><span class="op" id="4285354">[</span><span class="op" id="4285355">]</span><span class="builtintype" id="4285356">byte</span><span class="op" id="4285360">)</span>&nbsp;<span class="op" id="4285362">(</span><span class="ident" id="4285363">crypto</span><span class="op" id="4285369">.</span><span class="ident" id="4285370">PublicKey</span><span class="op" id="4285379">,</span>&nbsp;<span class="builtintype" id="4285381">error</span><span class="op" id="4285386">)</span>&nbsp;<span class="op" id="4285388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4285391">c</span>&nbsp;<span class="op" id="4285393">:=</span>&nbsp;<span class="ident" id="4285396">hs</span><span class="op" id="4285398">.</span><span class="ident" id="4285399">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4285403">hs</span><span class="op" id="4285405">.</span><span class="ident" id="4285406">certsFromClient</span>&nbsp;<span class="op" id="4285422">=</span>&nbsp;<span class="ident" id="4285424">certificates</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4285438">certs</span>&nbsp;<span class="op" id="4285444">:=</span>&nbsp;<span class="builtinfunc" id="4285447">make</span><span class="op" id="4285451">(</span><span class="op" id="4285452">[</span><span class="op" id="4285453">]</span><span class="op" id="4285454">*</span><span class="ident" id="4285455">x509</span><span class="op" id="4285459">.</span><span class="ident" id="4285460">Certificate</span><span class="op" id="4285471">,</span>&nbsp;<span class="builtinfunc" id="4285473">len</span><span class="op" id="4285476">(</span><span class="ident" id="4285477">certificates</span><span class="op" id="4285489">)</span><span class="op" id="4285490">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4285493">var</span>&nbsp;<span class="ident" id="4285497">err</span>&nbsp;<span class="builtintype" id="4285501">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4285508">for</span>&nbsp;<span class="ident" id="4285512">i</span><span class="op" id="4285513">,</span>&nbsp;<span class="ident" id="4285515">asn1Data</span>&nbsp;<span class="op" id="4285524">:=</span>&nbsp;<span class="keyword" id="4285527">range</span>&nbsp;<span class="ident" id="4285533">certificates</span>&nbsp;<span class="op" id="4285546">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4285550">if</span>&nbsp;<span class="ident" id="4285553">certs</span><span class="op" id="4285558">[</span><span class="ident" id="4285559">i</span><span class="op" id="4285560">]</span><span class="op" id="4285561">,</span>&nbsp;<span class="ident" id="4285563">err</span>&nbsp;<span class="op" id="4285567">=</span>&nbsp;<span class="ident" id="4285569">x509</span><span class="op" id="4285573">.</span><span class="ident" id="4285574">ParseCertificate</span><span class="op" id="4285590">(</span><span class="ident" id="4285591">asn1Data</span><span class="op" id="4285599">)</span><span class="op" id="4285600">;</span>&nbsp;<span class="ident" id="4285602">err</span>&nbsp;<span class="op" id="4285606">!=</span>&nbsp;<span class="builtintype" id="4285609">nil</span>&nbsp;<span class="op" id="4285613">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4285618">c</span><span class="op" id="4285619">.</span><span class="ident" id="4285620">sendAlert</span><span class="op" id="4285629">(</span><span class="ident" id="4285630">alertBadCertificate</span><span class="op" id="4285649">)</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4285654">return</span>&nbsp;<span class="builtintype" id="4285661">nil</span><span class="op" id="4285664">,</span>&nbsp;<span class="ident" id="4285666">errors</span><span class="op" id="4285672">.</span><span class="ident" id="4285673">New</span><span class="op" id="4285676">(</span><span class="string" id="4285677">&#34;tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;client&nbsp;certificate:&nbsp;&#34;</span>&nbsp;<span class="op" id="4285721">+</span>&nbsp;<span class="ident" id="4285723">err</span><span class="op" id="4285726">.</span><span class="ident" id="4285727">Error</span><span class="op" id="4285732">(</span><span class="op" id="4285733">)</span><span class="op" id="4285734">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4285738">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4285741">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4285745">if</span>&nbsp;<span class="ident" id="4285748">c</span><span class="op" id="4285749">.</span><span class="ident" id="4285750">config</span><span class="op" id="4285756">.</span><span class="ident" id="4285757">ClientAuth</span>&nbsp;<span class="op" id="4285768">&gt;=</span>&nbsp;<span class="ident" id="4285771">VerifyClientCertIfGiven</span>&nbsp;<span class="op" id="4285795">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="4285798">len</span><span class="op" id="4285801">(</span><span class="ident" id="4285802">certs</span><span class="op" id="4285807">)</span>&nbsp;<span class="op" id="4285809">&gt;</span>&nbsp;<span class="num" id="4285811">0</span>&nbsp;<span class="op" id="4285813">{</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4285817">opts</span>&nbsp;<span class="op" id="4285822">:=</span>&nbsp;<span class="ident" id="4285825">x509</span><span class="op" id="4285829">.</span><span class="ident" id="4285830">VerifyOptions</span><span class="op" id="4285843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4285848">Roots</span><span class="op" id="4285853">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4285863">c</span><span class="op" id="4285864">.</span><span class="ident" id="4285865">config</span><span class="op" id="4285871">.</span><span class="ident" id="4285872">ClientCAs</span><span class="op" id="4285881">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4285886">CurrentTime</span><span class="op" id="4285897">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4285901">c</span><span class="op" id="4285902">.</span><span class="ident" id="4285903">config</span><span class="op" id="4285909">.</span><span class="ident" id="4285910">time</span><span class="op" id="4285914">(</span><span class="op" id="4285915">)</span><span class="op" id="4285916">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4285921">Intermediates</span><span class="op" id="4285934">:</span>&nbsp;<span class="ident" id="4285936">x509</span><span class="op" id="4285940">.</span><span class="ident" id="4285941">NewCertPool</span><span class="op" id="4285952">(</span><span class="op" id="4285953">)</span><span class="op" id="4285954">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4285959">KeyUsages</span><span class="op" id="4285968">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4285974">[</span><span class="op" id="4285975">]</span><span class="ident" id="4285976">x509</span><span class="op" id="4285980">.</span><span class="ident" id="4285981">ExtKeyUsage</span><span class="op" id="4285992">{</span><span class="ident" id="4285993">x509</span><span class="op" id="4285997">.</span><span class="ident" id="4285998">ExtKeyUsageClientAuth</span><span class="op" id="4286019">}</span><span class="op" id="4286020">,</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4286024">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4286029">for</span>&nbsp;<span class="ident" id="4286033">_</span><span class="op" id="4286034">,</span>&nbsp;<span class="ident" id="4286036">cert</span>&nbsp;<span class="op" id="4286041">:=</span>&nbsp;<span class="keyword" id="4286044">range</span>&nbsp;<span class="ident" id="4286050">certs</span><span class="op" id="4286055">[</span><span class="num" id="4286056">1</span><span class="op" id="4286057">:</span><span class="op" id="4286058">]</span>&nbsp;<span class="op" id="4286060">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4286065">opts</span><span class="op" id="4286069">.</span><span class="ident" id="4286070">Intermediates</span><span class="op" id="4286083">.</span><span class="ident" id="4286084">AddCert</span><span class="op" id="4286091">(</span><span class="ident" id="4286092">cert</span><span class="op" id="4286096">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4286100">}</span><br>
<span class="lineno">615</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4286105">chains</span><span class="op" id="4286111">,</span>&nbsp;<span class="ident" id="4286113">err</span>&nbsp;<span class="op" id="4286117">:=</span>&nbsp;<span class="ident" id="4286120">certs</span><span class="op" id="4286125">[</span><span class="num" id="4286126">0</span><span class="op" id="4286127">]</span><span class="op" id="4286128">.</span><span class="ident" id="4286129">Verify</span><span class="op" id="4286135">(</span><span class="ident" id="4286136">opts</span><span class="op" id="4286140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4286144">if</span>&nbsp;<span class="ident" id="4286147">err</span>&nbsp;<span class="op" id="4286151">!=</span>&nbsp;<span class="builtintype" id="4286154">nil</span>&nbsp;<span class="op" id="4286158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4286163">c</span><span class="op" id="4286164">.</span><span class="ident" id="4286165">sendAlert</span><span class="op" id="4286174">(</span><span class="ident" id="4286175">alertBadCertificate</span><span class="op" id="4286194">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4286199">return</span>&nbsp;<span class="builtintype" id="4286206">nil</span><span class="op" id="4286209">,</span>&nbsp;<span class="ident" id="4286211">errors</span><span class="op" id="4286217">.</span><span class="ident" id="4286218">New</span><span class="op" id="4286221">(</span><span class="string" id="4286222">&#34;tls:&nbsp;failed&nbsp;to&nbsp;verify&nbsp;client&#39;s&nbsp;certificate:&nbsp;&#34;</span>&nbsp;<span class="op" id="4286269">+</span>&nbsp;<span class="ident" id="4286271">err</span><span class="op" id="4286274">.</span><span class="ident" id="4286275">Error</span><span class="op" id="4286280">(</span><span class="op" id="4286281">)</span><span class="op" id="4286282">)</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4286286">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4286291">ok</span>&nbsp;<span class="op" id="4286294">:=</span>&nbsp;<span class="builtintype" id="4286297">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4286305">for</span>&nbsp;<span class="ident" id="4286309">_</span><span class="op" id="4286310">,</span>&nbsp;<span class="ident" id="4286312">ku</span>&nbsp;<span class="op" id="4286315">:=</span>&nbsp;<span class="keyword" id="4286318">range</span>&nbsp;<span class="ident" id="4286324">certs</span><span class="op" id="4286329">[</span><span class="num" id="4286330">0</span><span class="op" id="4286331">]</span><span class="op" id="4286332">.</span><span class="ident" id="4286333">ExtKeyUsage</span>&nbsp;<span class="op" id="4286345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4286350">if</span>&nbsp;<span class="ident" id="4286353">ku</span>&nbsp;<span class="op" id="4286356">==</span>&nbsp;<span class="ident" id="4286359">x509</span><span class="op" id="4286363">.</span><span class="ident" id="4286364">ExtKeyUsageClientAuth</span>&nbsp;<span class="op" id="4286386">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4286392">ok</span>&nbsp;<span class="op" id="4286395">=</span>&nbsp;<span class="builtintype" id="4286397">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4286406">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4286415">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4286419">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4286423">if</span>&nbsp;<span class="op" id="4286426">!</span><span class="ident" id="4286427">ok</span>&nbsp;<span class="op" id="4286430">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4286435">c</span><span class="op" id="4286436">.</span><span class="ident" id="4286437">sendAlert</span><span class="op" id="4286446">(</span><span class="ident" id="4286447">alertHandshakeFailure</span><span class="op" id="4286468">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4286473">return</span>&nbsp;<span class="builtintype" id="4286480">nil</span><span class="op" id="4286483">,</span>&nbsp;<span class="ident" id="4286485">errors</span><span class="op" id="4286491">.</span><span class="ident" id="4286492">New</span><span class="op" id="4286495">(</span><span class="string" id="4286496">&#34;tls:&nbsp;client&#39;s&nbsp;certificate&#39;s&nbsp;extended&nbsp;key&nbsp;usage&nbsp;doesn&#39;t&nbsp;permit&nbsp;it&nbsp;to&nbsp;be&nbsp;used&nbsp;for&nbsp;client&nbsp;authentication&#34;</span><span class="op" id="4286599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4286603">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4286608">c</span><span class="op" id="4286609">.</span><span class="ident" id="4286610">verifiedChains</span>&nbsp;<span class="op" id="4286625">=</span>&nbsp;<span class="ident" id="4286627">chains</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4286635">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4286639">if</span>&nbsp;<span class="builtinfunc" id="4286642">len</span><span class="op" id="4286645">(</span><span class="ident" id="4286646">certs</span><span class="op" id="4286651">)</span>&nbsp;<span class="op" id="4286653">&gt;</span>&nbsp;<span class="num" id="4286655">0</span>&nbsp;<span class="op" id="4286657">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4286661">var</span>&nbsp;<span class="ident" id="4286665">pub</span>&nbsp;<span class="ident" id="4286669">crypto</span><span class="op" id="4286675">.</span><span class="ident" id="4286676">PublicKey</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4286688">switch</span>&nbsp;<span class="ident" id="4286695">key</span>&nbsp;<span class="op" id="4286699">:=</span>&nbsp;<span class="ident" id="4286702">certs</span><span class="op" id="4286707">[</span><span class="num" id="4286708">0</span><span class="op" id="4286709">]</span><span class="op" id="4286710">.</span><span class="ident" id="4286711">PublicKey</span><span class="op" id="4286720">.</span><span class="op" id="4286721">(</span><span class="keyword" id="4286722">type</span><span class="op" id="4286726">)</span>&nbsp;<span class="op" id="4286728">{</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4286732">case</span>&nbsp;<span class="op" id="4286737">*</span><span class="ident" id="4286738">ecdsa</span><span class="op" id="4286743">.</span><span class="ident" id="4286744">PublicKey</span><span class="op" id="4286753">,</span>&nbsp;<span class="op" id="4286755">*</span><span class="ident" id="4286756">rsa</span><span class="op" id="4286759">.</span><span class="ident" id="4286760">PublicKey</span><span class="op" id="4286769">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4286774">pub</span>&nbsp;<span class="op" id="4286778">=</span>&nbsp;<span class="ident" id="4286780">key</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4286786">default</span><span class="op" id="4286793">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4286798">c</span><span class="op" id="4286799">.</span><span class="ident" id="4286800">sendAlert</span><span class="op" id="4286809">(</span><span class="ident" id="4286810">alertUnsupportedCertificate</span><span class="op" id="4286837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4286842">return</span>&nbsp;<span class="builtintype" id="4286849">nil</span><span class="op" id="4286852">,</span>&nbsp;<span class="ident" id="4286854">fmt</span><span class="op" id="4286857">.</span><span class="ident" id="4286858">Errorf</span><span class="op" id="4286864">(</span><span class="string" id="4286865">&#34;tls:&nbsp;client&#39;s&nbsp;certificate&nbsp;contains&nbsp;an&nbsp;unsupported&nbsp;public&nbsp;key&nbsp;of&nbsp;type&nbsp;%T&#34;</span><span class="op" id="4286938">,</span>&nbsp;<span class="ident" id="4286940">certs</span><span class="op" id="4286945">[</span><span class="num" id="4286946">0</span><span class="op" id="4286947">]</span><span class="op" id="4286948">.</span><span class="ident" id="4286949">PublicKey</span><span class="op" id="4286958">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4286962">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4286966">c</span><span class="op" id="4286967">.</span><span class="ident" id="4286968">peerCertificates</span>&nbsp;<span class="op" id="4286985">=</span>&nbsp;<span class="ident" id="4286987">certs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4286995">return</span>&nbsp;<span class="ident" id="4287002">pub</span><span class="op" id="4287005">,</span>&nbsp;<span class="builtintype" id="4287007">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4287012">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4287016">return</span>&nbsp;<span class="builtintype" id="4287023">nil</span><span class="op" id="4287026">,</span>&nbsp;<span class="builtintype" id="4287028">nil</span><br>
<span class="lineno"></span><span class="op" id="4287032">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4287035">//&nbsp;tryCipherSuite&nbsp;returns&nbsp;a&nbsp;cipherSuite&nbsp;with&nbsp;the&nbsp;given&nbsp;id&nbsp;if&nbsp;that&nbsp;cipher&nbsp;suite</span><br>
<span class="lineno"></span><span class="comment" id="4287114">//&nbsp;is&nbsp;acceptable&nbsp;to&nbsp;use.</span><br>
<span class="lineno">655</span><span class="keyword" id="4287139">func</span>&nbsp;<span class="op" id="4287144">(</span><span class="ident" id="4287145">c</span>&nbsp;<span class="op" id="4287147">*</span><span class="ident" id="4287148">Conn</span><span class="op" id="4287152">)</span>&nbsp;<span class="ident" id="4287154">tryCipherSuite</span><span class="op" id="4287168">(</span><span class="ident" id="4287169">id</span>&nbsp;<span class="builtintype" id="4287172">uint16</span><span class="op" id="4287178">,</span>&nbsp;<span class="ident" id="4287180">supportedCipherSuites</span>&nbsp;<span class="op" id="4287202">[</span><span class="op" id="4287203">]</span><span class="builtintype" id="4287204">uint16</span><span class="op" id="4287210">,</span>&nbsp;<span class="ident" id="4287212">version</span>&nbsp;<span class="builtintype" id="4287220">uint16</span><span class="op" id="4287226">,</span>&nbsp;<span class="ident" id="4287228">ellipticOk</span><span class="op" id="4287238">,</span>&nbsp;<span class="ident" id="4287240">ecdsaOk</span>&nbsp;<span class="builtintype" id="4287248">bool</span><span class="op" id="4287252">)</span>&nbsp;<span class="op" id="4287254">*</span><span class="ident" id="4287255">cipherSuite</span>&nbsp;<span class="op" id="4287267">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4287270">for</span>&nbsp;<span class="ident" id="4287274">_</span><span class="op" id="4287275">,</span>&nbsp;<span class="ident" id="4287277">supported</span>&nbsp;<span class="op" id="4287287">:=</span>&nbsp;<span class="keyword" id="4287290">range</span>&nbsp;<span class="ident" id="4287296">supportedCipherSuites</span>&nbsp;<span class="op" id="4287318">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4287322">if</span>&nbsp;<span class="ident" id="4287325">id</span>&nbsp;<span class="op" id="4287328">==</span>&nbsp;<span class="ident" id="4287331">supported</span>&nbsp;<span class="op" id="4287341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4287346">var</span>&nbsp;<span class="ident" id="4287350">candidate</span>&nbsp;<span class="op" id="4287360">*</span><span class="ident" id="4287361">cipherSuite</span><br>
<span class="lineno"></span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4287377">for</span>&nbsp;<span class="ident" id="4287381">_</span><span class="op" id="4287382">,</span>&nbsp;<span class="ident" id="4287384">s</span>&nbsp;<span class="op" id="4287386">:=</span>&nbsp;<span class="keyword" id="4287389">range</span>&nbsp;<span class="ident" id="4287395">cipherSuites</span>&nbsp;<span class="op" id="4287408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4287414">if</span>&nbsp;<span class="ident" id="4287417">s</span><span class="op" id="4287418">.</span><span class="ident" id="4287419">id</span>&nbsp;<span class="op" id="4287422">==</span>&nbsp;<span class="ident" id="4287425">id</span>&nbsp;<span class="op" id="4287428">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4287435">candidate</span>&nbsp;<span class="op" id="4287445">=</span>&nbsp;<span class="ident" id="4287447">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4287454">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4287464">}</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4287469">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4287474">if</span>&nbsp;<span class="ident" id="4287477">candidate</span>&nbsp;<span class="op" id="4287487">==</span>&nbsp;<span class="builtintype" id="4287490">nil</span>&nbsp;<span class="op" id="4287494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4287500">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4287512">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4287517">//&nbsp;Don&#39;t&nbsp;select&nbsp;a&nbsp;ciphersuite&nbsp;which&nbsp;we&nbsp;can&#39;t</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4287565">//&nbsp;support&nbsp;for&nbsp;this&nbsp;client.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4287596">if</span>&nbsp;<span class="op" id="4287599">(</span><span class="ident" id="4287600">candidate</span><span class="op" id="4287609">.</span><span class="ident" id="4287610">flags</span><span class="op" id="4287615">&amp;</span><span class="ident" id="4287616">suiteECDHE</span>&nbsp;<span class="op" id="4287627">!=</span>&nbsp;<span class="num" id="4287630">0</span><span class="op" id="4287631">)</span>&nbsp;<span class="op" id="4287633">&amp;&amp;</span>&nbsp;<span class="op" id="4287636">!</span><span class="ident" id="4287637">ellipticOk</span>&nbsp;<span class="op" id="4287648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4287654">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4287666">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4287671">if</span>&nbsp;<span class="op" id="4287674">(</span><span class="ident" id="4287675">candidate</span><span class="op" id="4287684">.</span><span class="ident" id="4287685">flags</span><span class="op" id="4287690">&amp;</span><span class="ident" id="4287691">suiteECDSA</span>&nbsp;<span class="op" id="4287702">!=</span>&nbsp;<span class="num" id="4287705">0</span><span class="op" id="4287706">)</span>&nbsp;<span class="op" id="4287708">!=</span>&nbsp;<span class="ident" id="4287711">ecdsaOk</span>&nbsp;<span class="op" id="4287719">{</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4287725">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4287737">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4287742">if</span>&nbsp;<span class="ident" id="4287745">version</span>&nbsp;<span class="op" id="4287753">&lt;</span>&nbsp;<span class="ident" id="4287755">VersionTLS12</span>&nbsp;<span class="op" id="4287768">&amp;&amp;</span>&nbsp;<span class="ident" id="4287771">candidate</span><span class="op" id="4287780">.</span><span class="ident" id="4287781">flags</span><span class="op" id="4287786">&amp;</span><span class="ident" id="4287787">suiteTLS12</span>&nbsp;<span class="op" id="4287798">!=</span>&nbsp;<span class="num" id="4287801">0</span>&nbsp;<span class="op" id="4287803">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4287809">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4287821">}</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4287826">return</span>&nbsp;<span class="ident" id="4287833">candidate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4287845">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4287848">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4287852">return</span>&nbsp;<span class="builtintype" id="4287859">nil</span><br>
<span class="lineno">685</span><span class="op" id="4287863">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
