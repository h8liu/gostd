<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http</h2>
<ul>
<li><a href="/gostd/net/http/client.go.html">client.go</a></li>
<li><a href="/gostd/net/http/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/http/cookie.go.html">cookie.go</a></li>
<li><a href="/gostd/net/http/cookie_test.go.html">cookie_test.go</a></li>
<li><a href="/gostd/net/http/doc.go.html">doc.go</a></li>
<li><a href="/gostd/net/http/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/http/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/net/http/filetransport.go.html">filetransport.go</a></li>
<li><a href="/gostd/net/http/filetransport_test.go.html">filetransport_test.go</a></li>
<li><a href="/gostd/net/http/fs.go.html">fs.go</a></li>
<li><a href="/gostd/net/http/fs_test.go.html">fs_test.go</a></li>
<li><a href="/gostd/net/http/header.go.html" class="current">header.go</a></li>
<li><a href="/gostd/net/http/header_test.go.html">header_test.go</a></li>
<li><a href="/gostd/net/http/jar.go.html">jar.go</a></li>
<li><a href="/gostd/net/http/lex.go.html">lex.go</a></li>
<li><a href="/gostd/net/http/lex_test.go.html">lex_test.go</a></li>
<li><a href="/gostd/net/http/main_test.go.html">main_test.go</a></li>
<li><a href="/gostd/net/http/npn_test.go.html">npn_test.go</a></li>
<li><a href="/gostd/net/http/proxy_test.go.html">proxy_test.go</a></li>
<li><a href="/gostd/net/http/range_test.go.html">range_test.go</a></li>
<li><a href="/gostd/net/http/readrequest_test.go.html">readrequest_test.go</a></li>
<li><a href="/gostd/net/http/request.go.html">request.go</a></li>
<li><a href="/gostd/net/http/request_test.go.html">request_test.go</a></li>
<li><a href="/gostd/net/http/requestwrite_test.go.html">requestwrite_test.go</a></li>
<li><a href="/gostd/net/http/response.go.html">response.go</a></li>
<li><a href="/gostd/net/http/response_test.go.html">response_test.go</a></li>
<li><a href="/gostd/net/http/responsewrite_test.go.html">responsewrite_test.go</a></li>
<li><a href="/gostd/net/http/serve_test.go.html">serve_test.go</a></li>
<li><a href="/gostd/net/http/server.go.html">server.go</a></li>
<li><a href="/gostd/net/http/sniff.go.html">sniff.go</a></li>
<li><a href="/gostd/net/http/sniff_test.go.html">sniff_test.go</a></li>
<li><a href="/gostd/net/http/status.go.html">status.go</a></li>
<li><a href="/gostd/net/http/transfer.go.html">transfer.go</a></li>
<li><a href="/gostd/net/http/transfer_test.go.html">transfer_test.go</a></li>
<li><a href="/gostd/net/http/transport.go.html">transport.go</a></li>
<li><a href="/gostd/net/http/transport_test.go.html">transport_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="2969805">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="2969861">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="2969915">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="2969966">package</span>&nbsp;<span class="ident" id="2969974">http</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2969980">import</span>&nbsp;<span class="op" id="2969987">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2969990">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2969996">&#34;net/textproto&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2970013">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2970021">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2970032">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="2970040">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="2970047">)</span><br>
<span class="lineno">15</span><br>
<span class="lineno"></span><span class="keyword" id="2970050">var</span>&nbsp;<span class="ident" id="2970054">raceEnabled</span>&nbsp;<span class="op" id="2970066">=</span>&nbsp;<span class="builtintype" id="2970068">false</span>&nbsp;<span class="comment" id="2970074">//&nbsp;set&nbsp;by&nbsp;race.go</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2970093">//&nbsp;A&nbsp;Header&nbsp;represents&nbsp;the&nbsp;key-value&nbsp;pairs&nbsp;in&nbsp;an&nbsp;HTTP&nbsp;header.</span><br>
<span class="lineno"></span><span class="keyword" id="2970155">type</span>&nbsp;<span class="ident" id="2970160">Header</span>&nbsp;<span class="keyword" id="2970167">map</span><span class="op" id="2970170">[</span><span class="builtintype" id="2970171">string</span><span class="op" id="2970177">]</span><span class="op" id="2970178">[</span><span class="op" id="2970179">]</span><span class="builtintype" id="2970180">string</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="comment" id="2970188">//&nbsp;Add&nbsp;adds&nbsp;the&nbsp;key,&nbsp;value&nbsp;pair&nbsp;to&nbsp;the&nbsp;header.</span><br>
<span class="lineno"></span><span class="comment" id="2970235">//&nbsp;It&nbsp;appends&nbsp;to&nbsp;any&nbsp;existing&nbsp;values&nbsp;associated&nbsp;with&nbsp;key.</span><br>
<span class="lineno"></span><span class="keyword" id="2970293">func</span>&nbsp;<span class="op" id="2970298">(</span><span class="ident" id="2970299">h</span>&nbsp;<span class="ident" id="2970301">Header</span><span class="op" id="2970307">)</span>&nbsp;<span class="ident" id="2970309">Add</span><span class="op" id="2970312">(</span><span class="ident" id="2970313">key</span><span class="op" id="2970316">,</span>&nbsp;<span class="ident" id="2970318">value</span>&nbsp;<span class="builtintype" id="2970324">string</span><span class="op" id="2970330">)</span>&nbsp;<span class="op" id="2970332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2970335">textproto</span><span class="op" id="2970344">.</span><span class="ident" id="2970345">MIMEHeader</span><span class="op" id="2970355">(</span><span class="ident" id="2970356">h</span><span class="op" id="2970357">)</span><span class="op" id="2970358">.</span><span class="ident" id="2970359">Add</span><span class="op" id="2970362">(</span><span class="ident" id="2970363">key</span><span class="op" id="2970366">,</span>&nbsp;<span class="ident" id="2970368">value</span><span class="op" id="2970373">)</span><br>
<span class="lineno">25</span><span class="op" id="2970375">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2970378">//&nbsp;Set&nbsp;sets&nbsp;the&nbsp;header&nbsp;entries&nbsp;associated&nbsp;with&nbsp;key&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="2970432">//&nbsp;the&nbsp;single&nbsp;element&nbsp;value.&nbsp;&nbsp;It&nbsp;replaces&nbsp;any&nbsp;existing</span><br>
<span class="lineno"></span><span class="comment" id="2970487">//&nbsp;values&nbsp;associated&nbsp;with&nbsp;key.</span><br>
<span class="lineno">30</span><span class="keyword" id="2970518">func</span>&nbsp;<span class="op" id="2970523">(</span><span class="ident" id="2970524">h</span>&nbsp;<span class="ident" id="2970526">Header</span><span class="op" id="2970532">)</span>&nbsp;<span class="ident" id="2970534">Set</span><span class="op" id="2970537">(</span><span class="ident" id="2970538">key</span><span class="op" id="2970541">,</span>&nbsp;<span class="ident" id="2970543">value</span>&nbsp;<span class="builtintype" id="2970549">string</span><span class="op" id="2970555">)</span>&nbsp;<span class="op" id="2970557">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2970560">textproto</span><span class="op" id="2970569">.</span><span class="ident" id="2970570">MIMEHeader</span><span class="op" id="2970580">(</span><span class="ident" id="2970581">h</span><span class="op" id="2970582">)</span><span class="op" id="2970583">.</span><span class="ident" id="2970584">Set</span><span class="op" id="2970587">(</span><span class="ident" id="2970588">key</span><span class="op" id="2970591">,</span>&nbsp;<span class="ident" id="2970593">value</span><span class="op" id="2970598">)</span><br>
<span class="lineno"></span><span class="op" id="2970600">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2970603">//&nbsp;Get&nbsp;gets&nbsp;the&nbsp;first&nbsp;value&nbsp;associated&nbsp;with&nbsp;the&nbsp;given&nbsp;key.</span><br>
<span class="lineno">35</span><span class="comment" id="2970662">//&nbsp;If&nbsp;there&nbsp;are&nbsp;no&nbsp;values&nbsp;associated&nbsp;with&nbsp;the&nbsp;key,&nbsp;Get&nbsp;returns&nbsp;&#34;&#34;.</span><br>
<span class="lineno"></span><span class="comment" id="2970729">//&nbsp;To&nbsp;access&nbsp;multiple&nbsp;values&nbsp;of&nbsp;a&nbsp;key,&nbsp;access&nbsp;the&nbsp;map&nbsp;directly</span><br>
<span class="lineno"></span><span class="comment" id="2970792">//&nbsp;with&nbsp;CanonicalHeaderKey.</span><br>
<span class="lineno"></span><span class="keyword" id="2970820">func</span>&nbsp;<span class="op" id="2970825">(</span><span class="ident" id="2970826">h</span>&nbsp;<span class="ident" id="2970828">Header</span><span class="op" id="2970834">)</span>&nbsp;<span class="ident" id="2970836">Get</span><span class="op" id="2970839">(</span><span class="ident" id="2970840">key</span>&nbsp;<span class="builtintype" id="2970844">string</span><span class="op" id="2970850">)</span>&nbsp;<span class="builtintype" id="2970852">string</span>&nbsp;<span class="op" id="2970859">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2970862">return</span>&nbsp;<span class="ident" id="2970869">textproto</span><span class="op" id="2970878">.</span><span class="ident" id="2970879">MIMEHeader</span><span class="op" id="2970889">(</span><span class="ident" id="2970890">h</span><span class="op" id="2970891">)</span><span class="op" id="2970892">.</span><span class="ident" id="2970893">Get</span><span class="op" id="2970896">(</span><span class="ident" id="2970897">key</span><span class="op" id="2970900">)</span><br>
<span class="lineno">40</span><span class="op" id="2970902">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2970905">//&nbsp;get&nbsp;is&nbsp;like&nbsp;Get,&nbsp;but&nbsp;key&nbsp;must&nbsp;already&nbsp;be&nbsp;in&nbsp;CanonicalHeaderKey&nbsp;form.</span><br>
<span class="lineno"></span><span class="keyword" id="2970977">func</span>&nbsp;<span class="op" id="2970982">(</span><span class="ident" id="2970983">h</span>&nbsp;<span class="ident" id="2970985">Header</span><span class="op" id="2970991">)</span>&nbsp;<span class="ident" id="2970993">get</span><span class="op" id="2970996">(</span><span class="ident" id="2970997">key</span>&nbsp;<span class="builtintype" id="2971001">string</span><span class="op" id="2971007">)</span>&nbsp;<span class="builtintype" id="2971009">string</span>&nbsp;<span class="op" id="2971016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2971019">if</span>&nbsp;<span class="ident" id="2971022">v</span>&nbsp;<span class="op" id="2971024">:=</span>&nbsp;<span class="ident" id="2971027">h</span><span class="op" id="2971028">[</span><span class="ident" id="2971029">key</span><span class="op" id="2971032">]</span><span class="op" id="2971033">;</span>&nbsp;<span class="builtinfunc" id="2971035">len</span><span class="op" id="2971038">(</span><span class="ident" id="2971039">v</span><span class="op" id="2971040">)</span>&nbsp;<span class="op" id="2971042">&gt;</span>&nbsp;<span class="num" id="2971044">0</span>&nbsp;<span class="op" id="2971046">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2971050">return</span>&nbsp;<span class="ident" id="2971057">v</span><span class="op" id="2971058">[</span><span class="num" id="2971059">0</span><span class="op" id="2971060">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2971063">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2971066">return</span>&nbsp;<span class="string" id="2971073">&#34;&#34;</span><br>
<span class="lineno"></span><span class="op" id="2971076">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="2971079">//&nbsp;Del&nbsp;deletes&nbsp;the&nbsp;values&nbsp;associated&nbsp;with&nbsp;key.</span><br>
<span class="lineno"></span><span class="keyword" id="2971126">func</span>&nbsp;<span class="op" id="2971131">(</span><span class="ident" id="2971132">h</span>&nbsp;<span class="ident" id="2971134">Header</span><span class="op" id="2971140">)</span>&nbsp;<span class="ident" id="2971142">Del</span><span class="op" id="2971145">(</span><span class="ident" id="2971146">key</span>&nbsp;<span class="builtintype" id="2971150">string</span><span class="op" id="2971156">)</span>&nbsp;<span class="op" id="2971158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2971161">textproto</span><span class="op" id="2971170">.</span><span class="ident" id="2971171">MIMEHeader</span><span class="op" id="2971181">(</span><span class="ident" id="2971182">h</span><span class="op" id="2971183">)</span><span class="op" id="2971184">.</span><span class="ident" id="2971185">Del</span><span class="op" id="2971188">(</span><span class="ident" id="2971189">key</span><span class="op" id="2971192">)</span><br>
<span class="lineno"></span><span class="op" id="2971194">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="2971197">//&nbsp;Write&nbsp;writes&nbsp;a&nbsp;header&nbsp;in&nbsp;wire&nbsp;format.</span><br>
<span class="lineno"></span><span class="keyword" id="2971238">func</span>&nbsp;<span class="op" id="2971243">(</span><span class="ident" id="2971244">h</span>&nbsp;<span class="ident" id="2971246">Header</span><span class="op" id="2971252">)</span>&nbsp;<span class="ident" id="2971254">Write</span><span class="op" id="2971259">(</span><span class="ident" id="2971260">w</span>&nbsp;<span class="ident" id="2971262">io</span><span class="op" id="2971264">.</span><span class="ident" id="2971265">Writer</span><span class="op" id="2971271">)</span>&nbsp;<span class="builtintype" id="2971273">error</span>&nbsp;<span class="op" id="2971279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2971282">return</span>&nbsp;<span class="ident" id="2971289">h</span><span class="op" id="2971290">.</span><span class="ident" id="2971291">WriteSubset</span><span class="op" id="2971302">(</span><span class="ident" id="2971303">w</span><span class="op" id="2971304">,</span>&nbsp;<span class="builtintype" id="2971306">nil</span><span class="op" id="2971309">)</span><br>
<span class="lineno"></span><span class="op" id="2971311">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="2971314">func</span>&nbsp;<span class="op" id="2971319">(</span><span class="ident" id="2971320">h</span>&nbsp;<span class="ident" id="2971322">Header</span><span class="op" id="2971328">)</span>&nbsp;<span class="ident" id="2971330">clone</span><span class="op" id="2971335">(</span><span class="op" id="2971336">)</span>&nbsp;<span class="ident" id="2971338">Header</span>&nbsp;<span class="op" id="2971345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2971348">h2</span>&nbsp;<span class="op" id="2971351">:=</span>&nbsp;<span class="builtinfunc" id="2971354">make</span><span class="op" id="2971358">(</span><span class="ident" id="2971359">Header</span><span class="op" id="2971365">,</span>&nbsp;<span class="builtinfunc" id="2971367">len</span><span class="op" id="2971370">(</span><span class="ident" id="2971371">h</span><span class="op" id="2971372">)</span><span class="op" id="2971373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2971376">for</span>&nbsp;<span class="ident" id="2971380">k</span><span class="op" id="2971381">,</span>&nbsp;<span class="ident" id="2971383">vv</span>&nbsp;<span class="op" id="2971386">:=</span>&nbsp;<span class="keyword" id="2971389">range</span>&nbsp;<span class="ident" id="2971395">h</span>&nbsp;<span class="op" id="2971397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2971401">vv2</span>&nbsp;<span class="op" id="2971405">:=</span>&nbsp;<span class="builtinfunc" id="2971408">make</span><span class="op" id="2971412">(</span><span class="op" id="2971413">[</span><span class="op" id="2971414">]</span><span class="builtintype" id="2971415">string</span><span class="op" id="2971421">,</span>&nbsp;<span class="builtinfunc" id="2971423">len</span><span class="op" id="2971426">(</span><span class="ident" id="2971427">vv</span><span class="op" id="2971429">)</span><span class="op" id="2971430">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="2971434">copy</span><span class="op" id="2971438">(</span><span class="ident" id="2971439">vv2</span><span class="op" id="2971442">,</span>&nbsp;<span class="ident" id="2971444">vv</span><span class="op" id="2971446">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2971450">h2</span><span class="op" id="2971452">[</span><span class="ident" id="2971453">k</span><span class="op" id="2971454">]</span>&nbsp;<span class="op" id="2971456">=</span>&nbsp;<span class="ident" id="2971458">vv2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2971463">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2971466">return</span>&nbsp;<span class="ident" id="2971473">h2</span><br>
<span class="lineno"></span><span class="op" id="2971476">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="keyword" id="2971479">var</span>&nbsp;<span class="ident" id="2971483">timeFormats</span>&nbsp;<span class="op" id="2971495">=</span>&nbsp;<span class="op" id="2971497">[</span><span class="op" id="2971498">]</span><span class="builtintype" id="2971499">string</span><span class="op" id="2971505">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2971508">TimeFormat</span><span class="op" id="2971518">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2971521">time</span><span class="op" id="2971525">.</span><span class="ident" id="2971526">RFC850</span><span class="op" id="2971532">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2971535">time</span><span class="op" id="2971539">.</span><span class="ident" id="2971540">ANSIC</span><span class="op" id="2971545">,</span><br>
<span class="lineno"></span><span class="op" id="2971547">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="comment" id="2971550">//&nbsp;ParseTime&nbsp;parses&nbsp;a&nbsp;time&nbsp;header&nbsp;(such&nbsp;as&nbsp;the&nbsp;Date:&nbsp;header),</span><br>
<span class="lineno"></span><span class="comment" id="2971612">//&nbsp;trying&nbsp;each&nbsp;of&nbsp;the&nbsp;three&nbsp;formats&nbsp;allowed&nbsp;by&nbsp;HTTP/1.1:</span><br>
<span class="lineno"></span><span class="comment" id="2971669">//&nbsp;TimeFormat,&nbsp;time.RFC850,&nbsp;and&nbsp;time.ANSIC.</span><br>
<span class="lineno"></span><span class="keyword" id="2971713">func</span>&nbsp;<span class="ident" id="2971718">ParseTime</span><span class="op" id="2971727">(</span><span class="ident" id="2971728">text</span>&nbsp;<span class="builtintype" id="2971733">string</span><span class="op" id="2971739">)</span>&nbsp;<span class="op" id="2971741">(</span><span class="ident" id="2971742">t</span>&nbsp;<span class="ident" id="2971744">time</span><span class="op" id="2971748">.</span><span class="ident" id="2971749">Time</span><span class="op" id="2971753">,</span>&nbsp;<span class="ident" id="2971755">err</span>&nbsp;<span class="builtintype" id="2971759">error</span><span class="op" id="2971764">)</span>&nbsp;<span class="op" id="2971766">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2971769">for</span>&nbsp;<span class="ident" id="2971773">_</span><span class="op" id="2971774">,</span>&nbsp;<span class="ident" id="2971776">layout</span>&nbsp;<span class="op" id="2971783">:=</span>&nbsp;<span class="keyword" id="2971786">range</span>&nbsp;<span class="ident" id="2971792">timeFormats</span>&nbsp;<span class="op" id="2971804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2971808">t</span><span class="op" id="2971809">,</span>&nbsp;<span class="ident" id="2971811">err</span>&nbsp;<span class="op" id="2971815">=</span>&nbsp;<span class="ident" id="2971817">time</span><span class="op" id="2971821">.</span><span class="ident" id="2971822">Parse</span><span class="op" id="2971827">(</span><span class="ident" id="2971828">layout</span><span class="op" id="2971834">,</span>&nbsp;<span class="ident" id="2971836">text</span><span class="op" id="2971840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2971844">if</span>&nbsp;<span class="ident" id="2971847">err</span>&nbsp;<span class="op" id="2971851">==</span>&nbsp;<span class="builtintype" id="2971854">nil</span>&nbsp;<span class="op" id="2971858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2971863">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2971872">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2971875">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2971878">return</span><br>
<span class="lineno"></span><span class="op" id="2971885">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2971888">var</span>&nbsp;<span class="ident" id="2971892">headerNewlineToSpace</span>&nbsp;<span class="op" id="2971913">=</span>&nbsp;<span class="ident" id="2971915">strings</span><span class="op" id="2971922">.</span><span class="ident" id="2971923">NewReplacer</span><span class="op" id="2971934">(</span><span class="string" id="2971935">&#34;\n&#34;</span><span class="op" id="2971939">,</span>&nbsp;<span class="string" id="2971941">&#34;&nbsp;&#34;</span><span class="op" id="2971944">,</span>&nbsp;<span class="string" id="2971946">&#34;\r&#34;</span><span class="op" id="2971950">,</span>&nbsp;<span class="string" id="2971952">&#34;&nbsp;&#34;</span><span class="op" id="2971955">)</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="keyword" id="2971958">type</span>&nbsp;<span class="ident" id="2971963">writeStringer</span>&nbsp;<span class="keyword" id="2971977">interface</span>&nbsp;<span class="op" id="2971987">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2971990">WriteString</span><span class="op" id="2972001">(</span><span class="builtintype" id="2972002">string</span><span class="op" id="2972008">)</span>&nbsp;<span class="op" id="2972010">(</span><span class="builtintype" id="2972011">int</span><span class="op" id="2972014">,</span>&nbsp;<span class="builtintype" id="2972016">error</span><span class="op" id="2972021">)</span><br>
<span class="lineno"></span><span class="op" id="2972023">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="comment" id="2972026">//&nbsp;stringWriter&nbsp;implements&nbsp;WriteString&nbsp;on&nbsp;a&nbsp;Writer.</span><br>
<span class="lineno"></span><span class="keyword" id="2972078">type</span>&nbsp;<span class="ident" id="2972083">stringWriter</span>&nbsp;<span class="keyword" id="2972096">struct</span>&nbsp;<span class="op" id="2972103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2972106">w</span>&nbsp;<span class="ident" id="2972108">io</span><span class="op" id="2972110">.</span><span class="ident" id="2972111">Writer</span><br>
<span class="lineno"></span><span class="op" id="2972118">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="keyword" id="2972121">func</span>&nbsp;<span class="op" id="2972126">(</span><span class="ident" id="2972127">w</span>&nbsp;<span class="ident" id="2972129">stringWriter</span><span class="op" id="2972141">)</span>&nbsp;<span class="ident" id="2972143">WriteString</span><span class="op" id="2972154">(</span><span class="ident" id="2972155">s</span>&nbsp;<span class="builtintype" id="2972157">string</span><span class="op" id="2972163">)</span>&nbsp;<span class="op" id="2972165">(</span><span class="ident" id="2972166">n</span>&nbsp;<span class="builtintype" id="2972168">int</span><span class="op" id="2972171">,</span>&nbsp;<span class="ident" id="2972173">err</span>&nbsp;<span class="builtintype" id="2972177">error</span><span class="op" id="2972182">)</span>&nbsp;<span class="op" id="2972184">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2972187">return</span>&nbsp;<span class="ident" id="2972194">w</span><span class="op" id="2972195">.</span><span class="ident" id="2972196">w</span><span class="op" id="2972197">.</span><span class="ident" id="2972198">Write</span><span class="op" id="2972203">(</span><span class="op" id="2972204">[</span><span class="op" id="2972205">]</span><span class="builtintype" id="2972206">byte</span><span class="op" id="2972210">(</span><span class="ident" id="2972211">s</span><span class="op" id="2972212">)</span><span class="op" id="2972213">)</span><br>
<span class="lineno"></span><span class="op" id="2972215">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2972218">type</span>&nbsp;<span class="ident" id="2972223">keyValues</span>&nbsp;<span class="keyword" id="2972233">struct</span>&nbsp;<span class="op" id="2972240">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2972243">key</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="2972250">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2972258">values</span>&nbsp;<span class="op" id="2972265">[</span><span class="op" id="2972266">]</span><span class="builtintype" id="2972267">string</span><br>
<span class="lineno"></span><span class="op" id="2972274">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2972277">//&nbsp;A&nbsp;headerSorter&nbsp;implements&nbsp;sort.Interface&nbsp;by&nbsp;sorting&nbsp;a&nbsp;[]keyValues</span><br>
<span class="lineno">110</span><span class="comment" id="2972346">//&nbsp;by&nbsp;key.&nbsp;It&#39;s&nbsp;used&nbsp;as&nbsp;a&nbsp;pointer,&nbsp;so&nbsp;it&nbsp;can&nbsp;fit&nbsp;in&nbsp;a&nbsp;sort.Interface</span><br>
<span class="lineno"></span><span class="comment" id="2972415">//&nbsp;interface&nbsp;value&nbsp;without&nbsp;allocation.</span><br>
<span class="lineno"></span><span class="keyword" id="2972454">type</span>&nbsp;<span class="ident" id="2972459">headerSorter</span>&nbsp;<span class="keyword" id="2972472">struct</span>&nbsp;<span class="op" id="2972479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2972482">kvs</span>&nbsp;<span class="op" id="2972486">[</span><span class="op" id="2972487">]</span><span class="ident" id="2972488">keyValues</span><br>
<span class="lineno"></span><span class="op" id="2972498">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span><span class="keyword" id="2972501">func</span>&nbsp;<span class="op" id="2972506">(</span><span class="ident" id="2972507">s</span>&nbsp;<span class="op" id="2972509">*</span><span class="ident" id="2972510">headerSorter</span><span class="op" id="2972522">)</span>&nbsp;<span class="ident" id="2972524">Len</span><span class="op" id="2972527">(</span><span class="op" id="2972528">)</span>&nbsp;<span class="builtintype" id="2972530">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2972544">{</span>&nbsp;<span class="keyword" id="2972546">return</span>&nbsp;<span class="builtinfunc" id="2972553">len</span><span class="op" id="2972556">(</span><span class="ident" id="2972557">s</span><span class="op" id="2972558">.</span><span class="ident" id="2972559">kvs</span><span class="op" id="2972562">)</span>&nbsp;<span class="op" id="2972564">}</span><br>
<span class="lineno"></span><span class="keyword" id="2972566">func</span>&nbsp;<span class="op" id="2972571">(</span><span class="ident" id="2972572">s</span>&nbsp;<span class="op" id="2972574">*</span><span class="ident" id="2972575">headerSorter</span><span class="op" id="2972587">)</span>&nbsp;<span class="ident" id="2972589">Swap</span><span class="op" id="2972593">(</span><span class="ident" id="2972594">i</span><span class="op" id="2972595">,</span>&nbsp;<span class="ident" id="2972597">j</span>&nbsp;<span class="builtintype" id="2972599">int</span><span class="op" id="2972602">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2972609">{</span>&nbsp;<span class="ident" id="2972611">s</span><span class="op" id="2972612">.</span><span class="ident" id="2972613">kvs</span><span class="op" id="2972616">[</span><span class="ident" id="2972617">i</span><span class="op" id="2972618">]</span><span class="op" id="2972619">,</span>&nbsp;<span class="ident" id="2972621">s</span><span class="op" id="2972622">.</span><span class="ident" id="2972623">kvs</span><span class="op" id="2972626">[</span><span class="ident" id="2972627">j</span><span class="op" id="2972628">]</span>&nbsp;<span class="op" id="2972630">=</span>&nbsp;<span class="ident" id="2972632">s</span><span class="op" id="2972633">.</span><span class="ident" id="2972634">kvs</span><span class="op" id="2972637">[</span><span class="ident" id="2972638">j</span><span class="op" id="2972639">]</span><span class="op" id="2972640">,</span>&nbsp;<span class="ident" id="2972642">s</span><span class="op" id="2972643">.</span><span class="ident" id="2972644">kvs</span><span class="op" id="2972647">[</span><span class="ident" id="2972648">i</span><span class="op" id="2972649">]</span>&nbsp;<span class="op" id="2972651">}</span><br>
<span class="lineno"></span><span class="keyword" id="2972653">func</span>&nbsp;<span class="op" id="2972658">(</span><span class="ident" id="2972659">s</span>&nbsp;<span class="op" id="2972661">*</span><span class="ident" id="2972662">headerSorter</span><span class="op" id="2972674">)</span>&nbsp;<span class="ident" id="2972676">Less</span><span class="op" id="2972680">(</span><span class="ident" id="2972681">i</span><span class="op" id="2972682">,</span>&nbsp;<span class="ident" id="2972684">j</span>&nbsp;<span class="builtintype" id="2972686">int</span><span class="op" id="2972689">)</span>&nbsp;<span class="builtintype" id="2972691">bool</span>&nbsp;<span class="op" id="2972696">{</span>&nbsp;<span class="keyword" id="2972698">return</span>&nbsp;<span class="ident" id="2972705">s</span><span class="op" id="2972706">.</span><span class="ident" id="2972707">kvs</span><span class="op" id="2972710">[</span><span class="ident" id="2972711">i</span><span class="op" id="2972712">]</span><span class="op" id="2972713">.</span><span class="ident" id="2972714">key</span>&nbsp;<span class="op" id="2972718">&lt;</span>&nbsp;<span class="ident" id="2972720">s</span><span class="op" id="2972721">.</span><span class="ident" id="2972722">kvs</span><span class="op" id="2972725">[</span><span class="ident" id="2972726">j</span><span class="op" id="2972727">]</span><span class="op" id="2972728">.</span><span class="ident" id="2972729">key</span>&nbsp;<span class="op" id="2972733">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span><span class="keyword" id="2972736">var</span>&nbsp;<span class="ident" id="2972740">headerSorterPool</span>&nbsp;<span class="op" id="2972757">=</span>&nbsp;<span class="ident" id="2972759">sync</span><span class="op" id="2972763">.</span><span class="ident" id="2972764">Pool</span><span class="op" id="2972768">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2972771">New</span><span class="op" id="2972774">:</span>&nbsp;<span class="keyword" id="2972776">func</span><span class="op" id="2972780">(</span><span class="op" id="2972781">)</span>&nbsp;<span class="keyword" id="2972783">interface</span><span class="op" id="2972792">{</span><span class="op" id="2972793">}</span>&nbsp;<span class="op" id="2972795">{</span>&nbsp;<span class="keyword" id="2972797">return</span>&nbsp;<span class="builtinfunc" id="2972804">new</span><span class="op" id="2972807">(</span><span class="ident" id="2972808">headerSorter</span><span class="op" id="2972820">)</span>&nbsp;<span class="op" id="2972822">}</span><span class="op" id="2972823">,</span><br>
<span class="lineno"></span><span class="op" id="2972825">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2972828">//&nbsp;sortedKeyValues&nbsp;returns&nbsp;h&#39;s&nbsp;keys&nbsp;sorted&nbsp;in&nbsp;the&nbsp;returned&nbsp;kvs</span><br>
<span class="lineno">125</span><span class="comment" id="2972891">//&nbsp;slice.&nbsp;The&nbsp;headerSorter&nbsp;used&nbsp;to&nbsp;sort&nbsp;is&nbsp;also&nbsp;returned,&nbsp;for&nbsp;possible</span><br>
<span class="lineno"></span><span class="comment" id="2972962">//&nbsp;return&nbsp;to&nbsp;headerSorterCache.</span><br>
<span class="lineno"></span><span class="keyword" id="2972994">func</span>&nbsp;<span class="op" id="2972999">(</span><span class="ident" id="2973000">h</span>&nbsp;<span class="ident" id="2973002">Header</span><span class="op" id="2973008">)</span>&nbsp;<span class="ident" id="2973010">sortedKeyValues</span><span class="op" id="2973025">(</span><span class="ident" id="2973026">exclude</span>&nbsp;<span class="keyword" id="2973034">map</span><span class="op" id="2973037">[</span><span class="builtintype" id="2973038">string</span><span class="op" id="2973044">]</span><span class="builtintype" id="2973045">bool</span><span class="op" id="2973049">)</span>&nbsp;<span class="op" id="2973051">(</span><span class="ident" id="2973052">kvs</span>&nbsp;<span class="op" id="2973056">[</span><span class="op" id="2973057">]</span><span class="ident" id="2973058">keyValues</span><span class="op" id="2973067">,</span>&nbsp;<span class="ident" id="2973069">hs</span>&nbsp;<span class="op" id="2973072">*</span><span class="ident" id="2973073">headerSorter</span><span class="op" id="2973085">)</span>&nbsp;<span class="op" id="2973087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2973090">hs</span>&nbsp;<span class="op" id="2973093">=</span>&nbsp;<span class="ident" id="2973095">headerSorterPool</span><span class="op" id="2973111">.</span><span class="ident" id="2973112">Get</span><span class="op" id="2973115">(</span><span class="op" id="2973116">)</span><span class="op" id="2973117">.</span><span class="op" id="2973118">(</span><span class="op" id="2973119">*</span><span class="ident" id="2973120">headerSorter</span><span class="op" id="2973132">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2973135">if</span>&nbsp;<span class="builtinfunc" id="2973138">cap</span><span class="op" id="2973141">(</span><span class="ident" id="2973142">hs</span><span class="op" id="2973144">.</span><span class="ident" id="2973145">kvs</span><span class="op" id="2973148">)</span>&nbsp;<span class="op" id="2973150">&lt;</span>&nbsp;<span class="builtinfunc" id="2973152">len</span><span class="op" id="2973155">(</span><span class="ident" id="2973156">h</span><span class="op" id="2973157">)</span>&nbsp;<span class="op" id="2973159">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2973163">hs</span><span class="op" id="2973165">.</span><span class="ident" id="2973166">kvs</span>&nbsp;<span class="op" id="2973170">=</span>&nbsp;<span class="builtinfunc" id="2973172">make</span><span class="op" id="2973176">(</span><span class="op" id="2973177">[</span><span class="op" id="2973178">]</span><span class="ident" id="2973179">keyValues</span><span class="op" id="2973188">,</span>&nbsp;<span class="num" id="2973190">0</span><span class="op" id="2973191">,</span>&nbsp;<span class="builtinfunc" id="2973193">len</span><span class="op" id="2973196">(</span><span class="ident" id="2973197">h</span><span class="op" id="2973198">)</span><span class="op" id="2973199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2973202">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2973205">kvs</span>&nbsp;<span class="op" id="2973209">=</span>&nbsp;<span class="ident" id="2973211">hs</span><span class="op" id="2973213">.</span><span class="ident" id="2973214">kvs</span><span class="op" id="2973217">[</span><span class="op" id="2973218">:</span><span class="num" id="2973219">0</span><span class="op" id="2973220">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2973223">for</span>&nbsp;<span class="ident" id="2973227">k</span><span class="op" id="2973228">,</span>&nbsp;<span class="ident" id="2973230">vv</span>&nbsp;<span class="op" id="2973233">:=</span>&nbsp;<span class="keyword" id="2973236">range</span>&nbsp;<span class="ident" id="2973242">h</span>&nbsp;<span class="op" id="2973244">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2973248">if</span>&nbsp;<span class="op" id="2973251">!</span><span class="ident" id="2973252">exclude</span><span class="op" id="2973259">[</span><span class="ident" id="2973260">k</span><span class="op" id="2973261">]</span>&nbsp;<span class="op" id="2973263">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2973268">kvs</span>&nbsp;<span class="op" id="2973272">=</span>&nbsp;<span class="builtinfunc" id="2973274">append</span><span class="op" id="2973280">(</span><span class="ident" id="2973281">kvs</span><span class="op" id="2973284">,</span>&nbsp;<span class="ident" id="2973286">keyValues</span><span class="op" id="2973295">{</span><span class="ident" id="2973296">k</span><span class="op" id="2973297">,</span>&nbsp;<span class="ident" id="2973299">vv</span><span class="op" id="2973301">}</span><span class="op" id="2973302">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2973306">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2973309">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2973312">hs</span><span class="op" id="2973314">.</span><span class="ident" id="2973315">kvs</span>&nbsp;<span class="op" id="2973319">=</span>&nbsp;<span class="ident" id="2973321">kvs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2973326">sort</span><span class="op" id="2973330">.</span><span class="ident" id="2973331">Sort</span><span class="op" id="2973335">(</span><span class="ident" id="2973336">hs</span><span class="op" id="2973338">)</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2973341">return</span>&nbsp;<span class="ident" id="2973348">kvs</span><span class="op" id="2973351">,</span>&nbsp;<span class="ident" id="2973353">hs</span><br>
<span class="lineno"></span><span class="op" id="2973356">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2973359">//&nbsp;WriteSubset&nbsp;writes&nbsp;a&nbsp;header&nbsp;in&nbsp;wire&nbsp;format.</span><br>
<span class="lineno"></span><span class="comment" id="2973406">//&nbsp;If&nbsp;exclude&nbsp;is&nbsp;not&nbsp;nil,&nbsp;keys&nbsp;where&nbsp;exclude[key]&nbsp;==&nbsp;true&nbsp;are&nbsp;not&nbsp;written.</span><br>
<span class="lineno">145</span><span class="keyword" id="2973481">func</span>&nbsp;<span class="op" id="2973486">(</span><span class="ident" id="2973487">h</span>&nbsp;<span class="ident" id="2973489">Header</span><span class="op" id="2973495">)</span>&nbsp;<span class="ident" id="2973497">WriteSubset</span><span class="op" id="2973508">(</span><span class="ident" id="2973509">w</span>&nbsp;<span class="ident" id="2973511">io</span><span class="op" id="2973513">.</span><span class="ident" id="2973514">Writer</span><span class="op" id="2973520">,</span>&nbsp;<span class="ident" id="2973522">exclude</span>&nbsp;<span class="keyword" id="2973530">map</span><span class="op" id="2973533">[</span><span class="builtintype" id="2973534">string</span><span class="op" id="2973540">]</span><span class="builtintype" id="2973541">bool</span><span class="op" id="2973545">)</span>&nbsp;<span class="builtintype" id="2973547">error</span>&nbsp;<span class="op" id="2973553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2973556">ws</span><span class="op" id="2973558">,</span>&nbsp;<span class="ident" id="2973560">ok</span>&nbsp;<span class="op" id="2973563">:=</span>&nbsp;<span class="ident" id="2973566">w</span><span class="op" id="2973567">.</span><span class="op" id="2973568">(</span><span class="ident" id="2973569">writeStringer</span><span class="op" id="2973582">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2973585">if</span>&nbsp;<span class="op" id="2973588">!</span><span class="ident" id="2973589">ok</span>&nbsp;<span class="op" id="2973592">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2973596">ws</span>&nbsp;<span class="op" id="2973599">=</span>&nbsp;<span class="ident" id="2973601">stringWriter</span><span class="op" id="2973613">{</span><span class="ident" id="2973614">w</span><span class="op" id="2973615">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2973618">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2973621">kvs</span><span class="op" id="2973624">,</span>&nbsp;<span class="ident" id="2973626">sorter</span>&nbsp;<span class="op" id="2973633">:=</span>&nbsp;<span class="ident" id="2973636">h</span><span class="op" id="2973637">.</span><span class="ident" id="2973638">sortedKeyValues</span><span class="op" id="2973653">(</span><span class="ident" id="2973654">exclude</span><span class="op" id="2973661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2973664">for</span>&nbsp;<span class="ident" id="2973668">_</span><span class="op" id="2973669">,</span>&nbsp;<span class="ident" id="2973671">kv</span>&nbsp;<span class="op" id="2973674">:=</span>&nbsp;<span class="keyword" id="2973677">range</span>&nbsp;<span class="ident" id="2973683">kvs</span>&nbsp;<span class="op" id="2973687">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2973691">for</span>&nbsp;<span class="ident" id="2973695">_</span><span class="op" id="2973696">,</span>&nbsp;<span class="ident" id="2973698">v</span>&nbsp;<span class="op" id="2973700">:=</span>&nbsp;<span class="keyword" id="2973703">range</span>&nbsp;<span class="ident" id="2973709">kv</span><span class="op" id="2973711">.</span><span class="ident" id="2973712">values</span>&nbsp;<span class="op" id="2973719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2973724">v</span>&nbsp;<span class="op" id="2973726">=</span>&nbsp;<span class="ident" id="2973728">headerNewlineToSpace</span><span class="op" id="2973748">.</span><span class="ident" id="2973749">Replace</span><span class="op" id="2973756">(</span><span class="ident" id="2973757">v</span><span class="op" id="2973758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2973763">v</span>&nbsp;<span class="op" id="2973765">=</span>&nbsp;<span class="ident" id="2973767">textproto</span><span class="op" id="2973776">.</span><span class="ident" id="2973777">TrimString</span><span class="op" id="2973787">(</span><span class="ident" id="2973788">v</span><span class="op" id="2973789">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2973794">for</span>&nbsp;<span class="ident" id="2973798">_</span><span class="op" id="2973799">,</span>&nbsp;<span class="ident" id="2973801">s</span>&nbsp;<span class="op" id="2973803">:=</span>&nbsp;<span class="keyword" id="2973806">range</span>&nbsp;<span class="op" id="2973812">[</span><span class="op" id="2973813">]</span><span class="builtintype" id="2973814">string</span><span class="op" id="2973820">{</span><span class="ident" id="2973821">kv</span><span class="op" id="2973823">.</span><span class="ident" id="2973824">key</span><span class="op" id="2973827">,</span>&nbsp;<span class="string" id="2973829">&#34;:&nbsp;&#34;</span><span class="op" id="2973833">,</span>&nbsp;<span class="ident" id="2973835">v</span><span class="op" id="2973836">,</span>&nbsp;<span class="string" id="2973838">&#34;\r\n&#34;</span><span class="op" id="2973844">}</span>&nbsp;<span class="op" id="2973846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2973852">if</span>&nbsp;<span class="ident" id="2973855">_</span><span class="op" id="2973856">,</span>&nbsp;<span class="ident" id="2973858">err</span>&nbsp;<span class="op" id="2973862">:=</span>&nbsp;<span class="ident" id="2973865">ws</span><span class="op" id="2973867">.</span><span class="ident" id="2973868">WriteString</span><span class="op" id="2973879">(</span><span class="ident" id="2973880">s</span><span class="op" id="2973881">)</span><span class="op" id="2973882">;</span>&nbsp;<span class="ident" id="2973884">err</span>&nbsp;<span class="op" id="2973888">!=</span>&nbsp;<span class="builtintype" id="2973891">nil</span>&nbsp;<span class="op" id="2973895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2973902">return</span>&nbsp;<span class="ident" id="2973909">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2973917">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2973922">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2973926">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2973929">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="2973932">headerSorterPool</span><span class="op" id="2973948">.</span><span class="ident" id="2973949">Put</span><span class="op" id="2973952">(</span><span class="ident" id="2973953">sorter</span><span class="op" id="2973959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2973962">return</span>&nbsp;<span class="builtintype" id="2973969">nil</span><br>
<span class="lineno"></span><span class="op" id="2973973">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="comment" id="2973976">//&nbsp;CanonicalHeaderKey&nbsp;returns&nbsp;the&nbsp;canonical&nbsp;format&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="2974034">//&nbsp;header&nbsp;key&nbsp;s.&nbsp;&nbsp;The&nbsp;canonicalization&nbsp;converts&nbsp;the&nbsp;first</span><br>
<span class="lineno"></span><span class="comment" id="2974092">//&nbsp;letter&nbsp;and&nbsp;any&nbsp;letter&nbsp;following&nbsp;a&nbsp;hyphen&nbsp;to&nbsp;upper&nbsp;case;</span><br>
<span class="lineno"></span><span class="comment" id="2974151">//&nbsp;the&nbsp;rest&nbsp;are&nbsp;converted&nbsp;to&nbsp;lowercase.&nbsp;&nbsp;For&nbsp;example,&nbsp;the</span><br>
<span class="lineno">170</span><span class="comment" id="2974209">//&nbsp;canonical&nbsp;key&nbsp;for&nbsp;&#34;accept-encoding&#34;&nbsp;is&nbsp;&#34;Accept-Encoding&#34;.</span><br>
<span class="lineno"></span><span class="keyword" id="2974270">func</span>&nbsp;<span class="ident" id="2974275">CanonicalHeaderKey</span><span class="op" id="2974293">(</span><span class="ident" id="2974294">s</span>&nbsp;<span class="builtintype" id="2974296">string</span><span class="op" id="2974302">)</span>&nbsp;<span class="builtintype" id="2974304">string</span>&nbsp;<span class="op" id="2974311">{</span>&nbsp;<span class="keyword" id="2974313">return</span>&nbsp;<span class="ident" id="2974320">textproto</span><span class="op" id="2974329">.</span><span class="ident" id="2974330">CanonicalMIMEHeaderKey</span><span class="op" id="2974352">(</span><span class="ident" id="2974353">s</span><span class="op" id="2974354">)</span>&nbsp;<span class="op" id="2974356">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="2974359">//&nbsp;hasToken&nbsp;reports&nbsp;whether&nbsp;token&nbsp;appears&nbsp;with&nbsp;v,&nbsp;ASCII</span><br>
<span class="lineno"></span><span class="comment" id="2974415">//&nbsp;case-insensitive,&nbsp;with&nbsp;space&nbsp;or&nbsp;comma&nbsp;boundaries.</span><br>
<span class="lineno">175</span><span class="comment" id="2974468">//&nbsp;token&nbsp;must&nbsp;be&nbsp;all&nbsp;lowercase.</span><br>
<span class="lineno"></span><span class="comment" id="2974500">//&nbsp;v&nbsp;may&nbsp;contain&nbsp;mixed&nbsp;cased.</span><br>
<span class="lineno"></span><span class="keyword" id="2974530">func</span>&nbsp;<span class="ident" id="2974535">hasToken</span><span class="op" id="2974543">(</span><span class="ident" id="2974544">v</span><span class="op" id="2974545">,</span>&nbsp;<span class="ident" id="2974547">token</span>&nbsp;<span class="builtintype" id="2974553">string</span><span class="op" id="2974559">)</span>&nbsp;<span class="builtintype" id="2974561">bool</span>&nbsp;<span class="op" id="2974566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2974569">if</span>&nbsp;<span class="builtinfunc" id="2974572">len</span><span class="op" id="2974575">(</span><span class="ident" id="2974576">token</span><span class="op" id="2974581">)</span>&nbsp;<span class="op" id="2974583">&gt;</span>&nbsp;<span class="builtinfunc" id="2974585">len</span><span class="op" id="2974588">(</span><span class="ident" id="2974589">v</span><span class="op" id="2974590">)</span>&nbsp;<span class="op" id="2974592">||</span>&nbsp;<span class="ident" id="2974595">token</span>&nbsp;<span class="op" id="2974601">==</span>&nbsp;<span class="string" id="2974604">&#34;&#34;</span>&nbsp;<span class="op" id="2974607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2974611">return</span>&nbsp;<span class="builtintype" id="2974618">false</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2974625">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2974628">if</span>&nbsp;<span class="ident" id="2974631">v</span>&nbsp;<span class="op" id="2974633">==</span>&nbsp;<span class="ident" id="2974636">token</span>&nbsp;<span class="op" id="2974642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2974646">return</span>&nbsp;<span class="builtintype" id="2974653">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2974659">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2974662">for</span>&nbsp;<span class="ident" id="2974666">sp</span>&nbsp;<span class="op" id="2974669">:=</span>&nbsp;<span class="num" id="2974672">0</span><span class="op" id="2974673">;</span>&nbsp;<span class="ident" id="2974675">sp</span>&nbsp;<span class="op" id="2974678">&lt;=</span>&nbsp;<span class="builtinfunc" id="2974681">len</span><span class="op" id="2974684">(</span><span class="ident" id="2974685">v</span><span class="op" id="2974686">)</span><span class="op" id="2974687">-</span><span class="builtinfunc" id="2974688">len</span><span class="op" id="2974691">(</span><span class="ident" id="2974692">token</span><span class="op" id="2974697">)</span><span class="op" id="2974698">;</span>&nbsp;<span class="ident" id="2974700">sp</span><span class="op" id="2974702">++</span>&nbsp;<span class="op" id="2974705">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2974709">//&nbsp;Check&nbsp;that&nbsp;first&nbsp;character&nbsp;is&nbsp;good.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2974750">//&nbsp;The&nbsp;token&nbsp;is&nbsp;ASCII,&nbsp;so&nbsp;checking&nbsp;only&nbsp;a&nbsp;single&nbsp;byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2974806">//&nbsp;is&nbsp;sufficient.&nbsp;&nbsp;We&nbsp;skip&nbsp;this&nbsp;potential&nbsp;starting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2974859">//&nbsp;position&nbsp;if&nbsp;both&nbsp;the&nbsp;first&nbsp;byte&nbsp;and&nbsp;its&nbsp;potential</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2974914">//&nbsp;ASCII&nbsp;uppercase&nbsp;equivalent&nbsp;(b|0x20)&nbsp;don&#39;t&nbsp;match.</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2974968">//&nbsp;False&nbsp;positives&nbsp;(&#39;^&#39;&nbsp;=&gt;&nbsp;&#39;~&#39;)&nbsp;are&nbsp;caught&nbsp;by&nbsp;EqualFold.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2975027">if</span>&nbsp;<span class="ident" id="2975030">b</span>&nbsp;<span class="op" id="2975032">:=</span>&nbsp;<span class="ident" id="2975035">v</span><span class="op" id="2975036">[</span><span class="ident" id="2975037">sp</span><span class="op" id="2975039">]</span><span class="op" id="2975040">;</span>&nbsp;<span class="ident" id="2975042">b</span>&nbsp;<span class="op" id="2975044">!=</span>&nbsp;<span class="ident" id="2975047">token</span><span class="op" id="2975052">[</span><span class="num" id="2975053">0</span><span class="op" id="2975054">]</span>&nbsp;<span class="op" id="2975056">&amp;&amp;</span>&nbsp;<span class="ident" id="2975059">b</span><span class="op" id="2975060">|</span><span class="num" id="2975061">0x20</span>&nbsp;<span class="op" id="2975066">!=</span>&nbsp;<span class="ident" id="2975069">token</span><span class="op" id="2975074">[</span><span class="num" id="2975075">0</span><span class="op" id="2975076">]</span>&nbsp;<span class="op" id="2975078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2975083">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2975094">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2975098">//&nbsp;Check&nbsp;that&nbsp;start&nbsp;pos&nbsp;is&nbsp;on&nbsp;a&nbsp;valid&nbsp;token&nbsp;boundary.</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2975154">if</span>&nbsp;<span class="ident" id="2975157">sp</span>&nbsp;<span class="op" id="2975160">&gt;</span>&nbsp;<span class="num" id="2975162">0</span>&nbsp;<span class="op" id="2975164">&amp;&amp;</span>&nbsp;<span class="op" id="2975167">!</span><span class="ident" id="2975168">isTokenBoundary</span><span class="op" id="2975183">(</span><span class="ident" id="2975184">v</span><span class="op" id="2975185">[</span><span class="ident" id="2975186">sp</span><span class="op" id="2975188">-</span><span class="num" id="2975189">1</span><span class="op" id="2975190">]</span><span class="op" id="2975191">)</span>&nbsp;<span class="op" id="2975193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2975198">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2975209">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="2975213">//&nbsp;Check&nbsp;that&nbsp;end&nbsp;pos&nbsp;is&nbsp;on&nbsp;a&nbsp;valid&nbsp;token&nbsp;boundary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2975267">if</span>&nbsp;<span class="ident" id="2975270">endPos</span>&nbsp;<span class="op" id="2975277">:=</span>&nbsp;<span class="ident" id="2975280">sp</span>&nbsp;<span class="op" id="2975283">+</span>&nbsp;<span class="builtinfunc" id="2975285">len</span><span class="op" id="2975288">(</span><span class="ident" id="2975289">token</span><span class="op" id="2975294">)</span><span class="op" id="2975295">;</span>&nbsp;<span class="ident" id="2975297">endPos</span>&nbsp;<span class="op" id="2975304">!=</span>&nbsp;<span class="builtinfunc" id="2975307">len</span><span class="op" id="2975310">(</span><span class="ident" id="2975311">v</span><span class="op" id="2975312">)</span>&nbsp;<span class="op" id="2975314">&amp;&amp;</span>&nbsp;<span class="op" id="2975317">!</span><span class="ident" id="2975318">isTokenBoundary</span><span class="op" id="2975333">(</span><span class="ident" id="2975334">v</span><span class="op" id="2975335">[</span><span class="ident" id="2975336">endPos</span><span class="op" id="2975342">]</span><span class="op" id="2975343">)</span>&nbsp;<span class="op" id="2975345">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2975350">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2975361">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2975365">if</span>&nbsp;<span class="ident" id="2975368">strings</span><span class="op" id="2975375">.</span><span class="ident" id="2975376">EqualFold</span><span class="op" id="2975385">(</span><span class="ident" id="2975386">v</span><span class="op" id="2975387">[</span><span class="ident" id="2975388">sp</span><span class="op" id="2975390">:</span><span class="ident" id="2975391">sp</span><span class="op" id="2975393">+</span><span class="builtinfunc" id="2975394">len</span><span class="op" id="2975397">(</span><span class="ident" id="2975398">token</span><span class="op" id="2975403">)</span><span class="op" id="2975404">]</span><span class="op" id="2975405">,</span>&nbsp;<span class="ident" id="2975407">token</span><span class="op" id="2975412">)</span>&nbsp;<span class="op" id="2975414">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2975419">return</span>&nbsp;<span class="builtintype" id="2975426">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2975433">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="2975436">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2975439">return</span>&nbsp;<span class="builtintype" id="2975446">false</span><br>
<span class="lineno"></span><span class="op" id="2975452">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="2975455">func</span>&nbsp;<span class="ident" id="2975460">isTokenBoundary</span><span class="op" id="2975475">(</span><span class="ident" id="2975476">b</span>&nbsp;<span class="builtintype" id="2975478">byte</span><span class="op" id="2975482">)</span>&nbsp;<span class="builtintype" id="2975484">bool</span>&nbsp;<span class="op" id="2975489">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="2975492">return</span>&nbsp;<span class="ident" id="2975499">b</span>&nbsp;<span class="op" id="2975501">==</span>&nbsp;<span class="string" id="2975504">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="2975508">||</span>&nbsp;<span class="ident" id="2975511">b</span>&nbsp;<span class="op" id="2975513">==</span>&nbsp;<span class="string" id="2975516">&#39;,&#39;</span>&nbsp;<span class="op" id="2975520">||</span>&nbsp;<span class="ident" id="2975523">b</span>&nbsp;<span class="op" id="2975525">==</span>&nbsp;<span class="string" id="2975528">&#39;\t&#39;</span><br>
<span class="lineno"></span><span class="op" id="2975533">}</span>
</div>
</body>
</html>
