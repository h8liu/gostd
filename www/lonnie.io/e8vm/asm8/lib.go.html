<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="keyword">package</span>&nbsp;<span class="ident">asm8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">import</span>&nbsp;<span class="op">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;lonnie.io/e8vm/link8&#34;</span><br>
<span class="lineno">5</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;PkgObj&nbsp;is&nbsp;a&nbsp;package&nbsp;object.</span><br>
<span class="lineno"></span><span class="keyword">type</span>&nbsp;<span class="ident">lib</span>&nbsp;<span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">*</span><span class="ident">link8</span><span class="op">.</span><span class="ident">Package</span><br>
<span class="lineno">10</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">requires</span>&nbsp;<span class="keyword">map</span><span class="op">[</span><span class="builtintype">uint32</span><span class="op">]</span><span class="op">*</span><span class="ident">lib</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">symbols</span>&nbsp;&nbsp;<span class="keyword">map</span><span class="op">[</span><span class="builtintype">string</span><span class="op">]</span><span class="op">*</span><span class="ident">symbol</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="comment">//&nbsp;NewPkgObj&nbsp;creates&nbsp;a&nbsp;new&nbsp;package&nbsp;compile&nbsp;object</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">newLib</span><span class="op">(</span><span class="ident">p</span>&nbsp;<span class="builtintype">string</span><span class="op">)</span>&nbsp;<span class="op">*</span><span class="ident">lib</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ret</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">new</span><span class="op">(</span><span class="ident">lib</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ret</span><span class="op">.</span><span class="ident">Package</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">link8</span><span class="op">.</span><span class="ident">NewPackage</span><span class="op">(</span><span class="ident">p</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ret</span><span class="op">.</span><span class="ident">requires</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="keyword">map</span><span class="op">[</span><span class="builtintype">uint32</span><span class="op">]</span><span class="op">*</span><span class="ident">lib</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ret</span><span class="op">.</span><span class="ident">symbols</span>&nbsp;<span class="op">=</span>&nbsp;<span class="builtinfunc">make</span><span class="op">(</span><span class="keyword">map</span><span class="op">[</span><span class="builtintype">string</span><span class="op">]</span><span class="op">*</span><span class="ident">symbol</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">id</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">ret</span><span class="op">.</span><span class="ident">Require</span><span class="op">(</span><span class="ident">ret</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">id</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="num">0</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="string">&#34;bug&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">ret</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Require&nbsp;imports&nbsp;a&nbsp;package&nbsp;in&nbsp;and&nbsp;grants&nbsp;the&nbsp;package</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;a&nbsp;import&nbsp;index.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">p</span>&nbsp;<span class="op">*</span><span class="ident">lib</span><span class="op">)</span>&nbsp;<span class="ident">Require</span><span class="op">(</span><span class="ident">req</span>&nbsp;<span class="op">*</span><span class="ident">lib</span><span class="op">)</span>&nbsp;<span class="builtintype">uint32</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ret</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">p</span><span class="op">.</span><span class="ident">Package</span><span class="op">.</span><span class="ident">Require</span><span class="op">(</span><span class="ident">req</span><span class="op">.</span><span class="ident">Package</span><span class="op">)</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">found</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">p</span><span class="op">.</span><span class="ident">requires</span><span class="op">[</span><span class="ident">ret</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">found</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">p</span><span class="op">.</span><span class="ident">requires</span><span class="op">[</span><span class="ident">ret</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">req</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">ret</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;PkgIndex&nbsp;returns&nbsp;the&nbsp;package&nbsp;import&nbsp;index,&nbsp;consistent&nbsp;with</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;the&nbsp;underlying&nbsp;link8.Package.</span><br>
<span class="lineno">45</span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">p</span>&nbsp;<span class="op">*</span><span class="ident">lib</span><span class="op">)</span>&nbsp;<span class="ident">LibIndex</span><span class="op">(</span><span class="ident">path</span>&nbsp;<span class="builtintype">string</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="op">*</span><span class="ident">lib</span><span class="op">,</span>&nbsp;<span class="builtintype">uint32</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">pkg</span><span class="op">,</span>&nbsp;<span class="ident">index</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">p</span><span class="op">.</span><span class="ident">Package</span><span class="op">.</span><span class="ident">PkgIndex</span><span class="op">(</span><span class="ident">path</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">pkg</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ret</span><span class="op">,</span>&nbsp;<span class="ident">found</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">p</span><span class="op">.</span><span class="ident">requires</span><span class="op">[</span><span class="ident">index</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">found</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="string">&#34;bug&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">ret</span><span class="op">,</span>&nbsp;<span class="ident">index</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Declare&nbsp;declares&nbsp;a&nbsp;symbol&nbsp;inside&nbsp;the&nbsp;package.&nbsp;&nbsp;If&nbsp;the&nbsp;symbol&nbsp;is&nbsp;a&nbsp;function</span><br>
<span class="lineno">60</span><span class="comment">//&nbsp;or&nbsp;variable,&nbsp;it&nbsp;is&nbsp;also&nbsp;declared&nbsp;as&nbsp;an&nbsp;object&nbsp;file&nbsp;symbol&nbsp;in&nbsp;the&nbsp;underlying</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;link8.Package,&nbsp;and&nbsp;it&nbsp;returns&nbsp;the&nbsp;index.&nbsp;&nbsp;If&nbsp;the&nbsp;symbol&nbsp;is&nbsp;a&nbsp;constant,&nbsp;it</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;returns&nbsp;0&nbsp;after&nbsp;the&nbsp;declaration.&nbsp;Other&nbsp;types&nbsp;will&nbsp;panic.&nbsp;Redeclaration&nbsp;will</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;panic.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">p</span>&nbsp;<span class="op">*</span><span class="ident">lib</span><span class="op">)</span>&nbsp;<span class="ident">Declare</span><span class="op">(</span><span class="ident">s</span>&nbsp;<span class="op">*</span><span class="ident">symbol</span><span class="op">)</span>&nbsp;<span class="builtintype">uint32</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">found</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">p</span><span class="op">.</span><span class="ident">symbols</span><span class="op">[</span><span class="ident">s</span><span class="op">.</span><span class="ident">Name</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">found</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="string">&#34;redeclare&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">p</span><span class="op">.</span><span class="ident">symbols</span><span class="op">[</span><span class="ident">s</span><span class="op">.</span><span class="ident">Name</span><span class="op">]</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">s</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">s</span><span class="op">.</span><span class="ident">Type</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">SymConst</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">SymFunc</span><span class="op">:</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">p</span><span class="op">.</span><span class="ident">Package</span><span class="op">.</span><span class="ident">Declare</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">link8</span><span class="op">.</span><span class="ident">Symbol</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Name</span><span class="op">:</span>&nbsp;<span class="ident">s</span><span class="op">.</span><span class="ident">Name</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Type</span><span class="op">:</span>&nbsp;<span class="ident">link8</span><span class="op">.</span><span class="ident">SymFunc</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">SymVar</span><span class="op">:</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">p</span><span class="op">.</span><span class="ident">Package</span><span class="op">.</span><span class="ident">Declare</span><span class="op">(</span><span class="op">&amp;</span><span class="ident">link8</span><span class="op">.</span><span class="ident">Symbol</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Name</span><span class="op">:</span>&nbsp;<span class="ident">s</span><span class="op">.</span><span class="ident">Name</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">Type</span><span class="op">:</span>&nbsp;<span class="ident">link8</span><span class="op">.</span><span class="ident">SymVar</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">default</span><span class="op">:</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="string">&#34;declare&nbsp;with&nbsp;invalid&nbsp;sym&nbsp;type&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Query&nbsp;returns&nbsp;the&nbsp;symbol&nbsp;declared&nbsp;by&nbsp;name&nbsp;and&nbsp;its&nbsp;symbol&nbsp;index</span><br>
<span class="lineno">90</span><span class="comment">//&nbsp;if&nbsp;the&nbsp;symbol&nbsp;is&nbsp;a&nbsp;function&nbsp;or&nbsp;variable.&nbsp;It&nbsp;returns&nbsp;nil,&nbsp;0&nbsp;when</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;the&nbsp;symbol&nbsp;of&nbsp;name&nbsp;is&nbsp;not&nbsp;found.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="op">(</span><span class="ident">p</span>&nbsp;<span class="op">*</span><span class="ident">lib</span><span class="op">)</span>&nbsp;<span class="ident">Query</span><span class="op">(</span><span class="ident">name</span>&nbsp;<span class="builtintype">string</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="op">*</span><span class="ident">symbol</span><span class="op">,</span>&nbsp;<span class="builtintype">uint32</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ret</span><span class="op">,</span>&nbsp;<span class="ident">found</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">p</span><span class="op">.</span><span class="ident">symbols</span><span class="op">[</span><span class="ident">name</span><span class="op">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">found</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">nil</span><span class="op">,</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">ret</span><span class="op">.</span><span class="ident">Type</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">SymConst</span><span class="op">:</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">ret</span><span class="op">,</span>&nbsp;<span class="num">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="ident">SymFunc</span><span class="op">,</span>&nbsp;<span class="ident">SymVar</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">s</span><span class="op">,</span>&nbsp;<span class="ident">index</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">p</span><span class="op">.</span><span class="ident">Package</span><span class="op">.</span><span class="ident">Query</span><span class="op">(</span><span class="ident">name</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">s</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="string">&#34;symbol&nbsp;missing&#34;</span><span class="op">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">ret</span><span class="op">,</span>&nbsp;<span class="ident">index</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">default</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="string">&#34;bug&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">110</span><span class="op">}</span>
</div>
</body>
</html>
