<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="7413650">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7413705">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7413759">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="7413810">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;netbsd&nbsp;openbsd&nbsp;solaris</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7413875">package</span>&nbsp;<span class="ident" id="7413883">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7413888">import</span>&nbsp;<span class="op" id="7413895">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7413898">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7413904">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7413917">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7413923">&#34;path&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7413931">&#34;reflect&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7413942">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7413953">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="7413960">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7413963">var</span>&nbsp;<span class="ident" id="7413967">dnsTransportFallbackTests</span>&nbsp;<span class="op" id="7413993">=</span>&nbsp;<span class="op" id="7413995">[</span><span class="op" id="7413996">]</span><span class="keyword" id="7413997">struct</span>&nbsp;<span class="op" id="7414004">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7414007">server</span>&nbsp;&nbsp;<span class="builtintype" id="7414015">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7414023">name</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7414031">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7414039">qtype</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7414047">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7414055">timeout</span>&nbsp;<span class="builtintype" id="7414063">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7414068">rcode</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7414076">int</span><br>
<span class="lineno">25</span><span class="op" id="7414080">}</span><span class="op" id="7414081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7414084">//&nbsp;Querying&nbsp;&#34;com.&#34;&nbsp;with&nbsp;qtype=255&nbsp;usually&nbsp;makes&nbsp;an&nbsp;answer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7414143">//&nbsp;which&nbsp;requires&nbsp;more&nbsp;than&nbsp;512&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7414183">{</span><span class="string" id="7414184">&#34;8.8.8.8:53&#34;</span><span class="op" id="7414196">,</span>&nbsp;<span class="string" id="7414198">&#34;com.&#34;</span><span class="op" id="7414204">,</span>&nbsp;<span class="ident" id="7414206">dnsTypeALL</span><span class="op" id="7414216">,</span>&nbsp;<span class="num" id="7414218">2</span><span class="op" id="7414219">,</span>&nbsp;<span class="ident" id="7414221">dnsRcodeSuccess</span><span class="op" id="7414236">}</span><span class="op" id="7414237">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7414240">{</span><span class="string" id="7414241">&#34;8.8.4.4:53&#34;</span><span class="op" id="7414253">,</span>&nbsp;<span class="string" id="7414255">&#34;com.&#34;</span><span class="op" id="7414261">,</span>&nbsp;<span class="ident" id="7414263">dnsTypeALL</span><span class="op" id="7414273">,</span>&nbsp;<span class="num" id="7414275">4</span><span class="op" id="7414276">,</span>&nbsp;<span class="ident" id="7414278">dnsRcodeSuccess</span><span class="op" id="7414293">}</span><span class="op" id="7414294">,</span><br>
<span class="lineno">30</span><span class="op" id="7414296">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7414299">func</span>&nbsp;<span class="ident" id="7414304">TestDNSTransportFallback</span><span class="op" id="7414328">(</span><span class="ident" id="7414329">t</span>&nbsp;<span class="op" id="7414331">*</span><span class="ident" id="7414332">testing</span><span class="op" id="7414339">.</span><span class="ident" id="7414340">T</span><span class="op" id="7414341">)</span>&nbsp;<span class="op" id="7414343">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7414346">if</span>&nbsp;<span class="ident" id="7414349">testing</span><span class="op" id="7414356">.</span><span class="ident" id="7414357">Short</span><span class="op" id="7414362">(</span><span class="op" id="7414363">)</span>&nbsp;<span class="op" id="7414365">||</span>&nbsp;<span class="op" id="7414368">!</span><span class="op" id="7414369">*</span><span class="ident" id="7414370">testExternal</span>&nbsp;<span class="op" id="7414383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7414387">t</span><span class="op" id="7414388">.</span><span class="ident" id="7414389">Skip</span><span class="op" id="7414393">(</span><span class="string" id="7414394">&#34;skipping&nbsp;test&nbsp;to&nbsp;avoid&nbsp;external&nbsp;network&#34;</span><span class="op" id="7414435">)</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7414438">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7414442">for</span>&nbsp;<span class="ident" id="7414446">_</span><span class="op" id="7414447">,</span>&nbsp;<span class="ident" id="7414449">tt</span>&nbsp;<span class="op" id="7414452">:=</span>&nbsp;<span class="keyword" id="7414455">range</span>&nbsp;<span class="ident" id="7414461">dnsTransportFallbackTests</span>&nbsp;<span class="op" id="7414487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7414491">timeout</span>&nbsp;<span class="op" id="7414499">:=</span>&nbsp;<span class="ident" id="7414502">time</span><span class="op" id="7414506">.</span><span class="ident" id="7414507">Duration</span><span class="op" id="7414515">(</span><span class="ident" id="7414516">tt</span><span class="op" id="7414518">.</span><span class="ident" id="7414519">timeout</span><span class="op" id="7414526">)</span>&nbsp;<span class="op" id="7414528">*</span>&nbsp;<span class="ident" id="7414530">time</span><span class="op" id="7414534">.</span><span class="ident" id="7414535">Second</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7414544">msg</span><span class="op" id="7414547">,</span>&nbsp;<span class="ident" id="7414549">err</span>&nbsp;<span class="op" id="7414553">:=</span>&nbsp;<span class="ident" id="7414556">exchange</span><span class="op" id="7414564">(</span><span class="ident" id="7414565">tt</span><span class="op" id="7414567">.</span><span class="ident" id="7414568">server</span><span class="op" id="7414574">,</span>&nbsp;<span class="ident" id="7414576">tt</span><span class="op" id="7414578">.</span><span class="ident" id="7414579">name</span><span class="op" id="7414583">,</span>&nbsp;<span class="ident" id="7414585">tt</span><span class="op" id="7414587">.</span><span class="ident" id="7414588">qtype</span><span class="op" id="7414593">,</span>&nbsp;<span class="ident" id="7414595">timeout</span><span class="op" id="7414602">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7414606">if</span>&nbsp;<span class="ident" id="7414609">err</span>&nbsp;<span class="op" id="7414613">!=</span>&nbsp;<span class="ident" id="7414616">nil</span>&nbsp;<span class="op" id="7414620">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7414625">t</span><span class="op" id="7414626">.</span><span class="ident" id="7414627">Error</span><span class="op" id="7414632">(</span><span class="ident" id="7414633">err</span><span class="op" id="7414636">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7414641">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7414652">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7414656">switch</span>&nbsp;<span class="ident" id="7414663">msg</span><span class="op" id="7414666">.</span><span class="ident" id="7414667">rcode</span>&nbsp;<span class="op" id="7414673">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7414677">case</span>&nbsp;<span class="ident" id="7414682">tt</span><span class="op" id="7414684">.</span><span class="ident" id="7414685">rcode</span><span class="op" id="7414690">,</span>&nbsp;<span class="ident" id="7414692">dnsRcodeServerFailure</span><span class="op" id="7414713">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7414717">default</span><span class="op" id="7414724">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7414729">t</span><span class="op" id="7414730">.</span><span class="ident" id="7414731">Errorf</span><span class="op" id="7414737">(</span><span class="string" id="7414738">&#34;got&nbsp;%v&nbsp;from&nbsp;%v;&nbsp;want&nbsp;%v&#34;</span><span class="op" id="7414763">,</span>&nbsp;<span class="ident" id="7414765">msg</span><span class="op" id="7414768">.</span><span class="ident" id="7414769">rcode</span><span class="op" id="7414774">,</span>&nbsp;<span class="ident" id="7414776">tt</span><span class="op" id="7414778">.</span><span class="ident" id="7414779">server</span><span class="op" id="7414785">,</span>&nbsp;<span class="ident" id="7414787">tt</span><span class="op" id="7414789">.</span><span class="ident" id="7414790">rcode</span><span class="op" id="7414795">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7414800">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7414811">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7414814">}</span><br>
<span class="lineno"></span><span class="op" id="7414816">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="7414819">//&nbsp;See&nbsp;RFC&nbsp;6761&nbsp;for&nbsp;further&nbsp;information&nbsp;about&nbsp;the&nbsp;reserved,&nbsp;pseudo</span><br>
<span class="lineno"></span><span class="comment" id="7414886">//&nbsp;domain&nbsp;names.</span><br>
<span class="lineno">55</span><span class="keyword" id="7414903">var</span>&nbsp;<span class="ident" id="7414907">specialDomainNameTests</span>&nbsp;<span class="op" id="7414930">=</span>&nbsp;<span class="op" id="7414932">[</span><span class="op" id="7414933">]</span><span class="keyword" id="7414934">struct</span>&nbsp;<span class="op" id="7414941">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7414944">name</span>&nbsp;&nbsp;<span class="builtintype" id="7414950">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7414958">qtype</span>&nbsp;<span class="builtintype" id="7414964">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7414972">rcode</span>&nbsp;<span class="builtintype" id="7414978">int</span><br>
<span class="lineno"></span><span class="op" id="7414982">}</span><span class="op" id="7414983">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7414986">//&nbsp;Name&nbsp;resoltion&nbsp;APIs&nbsp;and&nbsp;libraries&nbsp;should&nbsp;not&nbsp;recongnize&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7415050">//&nbsp;followings&nbsp;as&nbsp;special.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7415077">{</span><span class="string" id="7415078">&#34;1.0.168.192.in-addr.arpa.&#34;</span><span class="op" id="7415105">,</span>&nbsp;<span class="ident" id="7415107">dnsTypePTR</span><span class="op" id="7415117">,</span>&nbsp;<span class="ident" id="7415119">dnsRcodeNameError</span><span class="op" id="7415136">}</span><span class="op" id="7415137">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7415140">{</span><span class="string" id="7415141">&#34;test.&#34;</span><span class="op" id="7415148">,</span>&nbsp;<span class="ident" id="7415150">dnsTypeALL</span><span class="op" id="7415160">,</span>&nbsp;<span class="ident" id="7415162">dnsRcodeNameError</span><span class="op" id="7415179">}</span><span class="op" id="7415180">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7415183">{</span><span class="string" id="7415184">&#34;example.com.&#34;</span><span class="op" id="7415198">,</span>&nbsp;<span class="ident" id="7415200">dnsTypeALL</span><span class="op" id="7415210">,</span>&nbsp;<span class="ident" id="7415212">dnsRcodeSuccess</span><span class="op" id="7415227">}</span><span class="op" id="7415228">,</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7415232">//&nbsp;Name&nbsp;resoltion&nbsp;APIs&nbsp;and&nbsp;libraries&nbsp;should&nbsp;recongnize&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7415292">//&nbsp;followings&nbsp;as&nbsp;special&nbsp;and&nbsp;should&nbsp;not&nbsp;send&nbsp;any&nbsp;queries.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7415351">//&nbsp;Though,&nbsp;we&nbsp;test&nbsp;those&nbsp;names&nbsp;here&nbsp;for&nbsp;verifying&nbsp;nagative</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7415411">//&nbsp;answers&nbsp;at&nbsp;DNS&nbsp;query-response&nbsp;interaction&nbsp;level.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7415464">{</span><span class="string" id="7415465">&#34;localhost.&#34;</span><span class="op" id="7415477">,</span>&nbsp;<span class="ident" id="7415479">dnsTypeALL</span><span class="op" id="7415489">,</span>&nbsp;<span class="ident" id="7415491">dnsRcodeNameError</span><span class="op" id="7415508">}</span><span class="op" id="7415509">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7415512">{</span><span class="string" id="7415513">&#34;invalid.&#34;</span><span class="op" id="7415523">,</span>&nbsp;<span class="ident" id="7415525">dnsTypeALL</span><span class="op" id="7415535">,</span>&nbsp;<span class="ident" id="7415537">dnsRcodeNameError</span><span class="op" id="7415554">}</span><span class="op" id="7415555">,</span><br>
<span class="lineno"></span><span class="op" id="7415557">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7415560">func</span>&nbsp;<span class="ident" id="7415565">TestSpecialDomainName</span><span class="op" id="7415586">(</span><span class="ident" id="7415587">t</span>&nbsp;<span class="op" id="7415589">*</span><span class="ident" id="7415590">testing</span><span class="op" id="7415597">.</span><span class="ident" id="7415598">T</span><span class="op" id="7415599">)</span>&nbsp;<span class="op" id="7415601">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7415604">if</span>&nbsp;<span class="ident" id="7415607">testing</span><span class="op" id="7415614">.</span><span class="ident" id="7415615">Short</span><span class="op" id="7415620">(</span><span class="op" id="7415621">)</span>&nbsp;<span class="op" id="7415623">||</span>&nbsp;<span class="op" id="7415626">!</span><span class="op" id="7415627">*</span><span class="ident" id="7415628">testExternal</span>&nbsp;<span class="op" id="7415641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7415645">t</span><span class="op" id="7415646">.</span><span class="ident" id="7415647">Skip</span><span class="op" id="7415651">(</span><span class="string" id="7415652">&#34;skipping&nbsp;test&nbsp;to&nbsp;avoid&nbsp;external&nbsp;network&#34;</span><span class="op" id="7415693">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7415696">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7415700">server</span>&nbsp;<span class="op" id="7415707">:=</span>&nbsp;<span class="string" id="7415710">&#34;8.8.8.8:53&#34;</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7415724">for</span>&nbsp;<span class="ident" id="7415728">_</span><span class="op" id="7415729">,</span>&nbsp;<span class="ident" id="7415731">tt</span>&nbsp;<span class="op" id="7415734">:=</span>&nbsp;<span class="keyword" id="7415737">range</span>&nbsp;<span class="ident" id="7415743">specialDomainNameTests</span>&nbsp;<span class="op" id="7415766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7415770">msg</span><span class="op" id="7415773">,</span>&nbsp;<span class="ident" id="7415775">err</span>&nbsp;<span class="op" id="7415779">:=</span>&nbsp;<span class="ident" id="7415782">exchange</span><span class="op" id="7415790">(</span><span class="ident" id="7415791">server</span><span class="op" id="7415797">,</span>&nbsp;<span class="ident" id="7415799">tt</span><span class="op" id="7415801">.</span><span class="ident" id="7415802">name</span><span class="op" id="7415806">,</span>&nbsp;<span class="ident" id="7415808">tt</span><span class="op" id="7415810">.</span><span class="ident" id="7415811">qtype</span><span class="op" id="7415816">,</span>&nbsp;<span class="num" id="7415818">0</span><span class="op" id="7415819">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7415823">if</span>&nbsp;<span class="ident" id="7415826">err</span>&nbsp;<span class="op" id="7415830">!=</span>&nbsp;<span class="ident" id="7415833">nil</span>&nbsp;<span class="op" id="7415837">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7415842">t</span><span class="op" id="7415843">.</span><span class="ident" id="7415844">Error</span><span class="op" id="7415849">(</span><span class="ident" id="7415850">err</span><span class="op" id="7415853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7415858">continue</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7415869">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7415873">switch</span>&nbsp;<span class="ident" id="7415880">msg</span><span class="op" id="7415883">.</span><span class="ident" id="7415884">rcode</span>&nbsp;<span class="op" id="7415890">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7415894">case</span>&nbsp;<span class="ident" id="7415899">tt</span><span class="op" id="7415901">.</span><span class="ident" id="7415902">rcode</span><span class="op" id="7415907">,</span>&nbsp;<span class="ident" id="7415909">dnsRcodeServerFailure</span><span class="op" id="7415930">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7415934">default</span><span class="op" id="7415941">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7415946">t</span><span class="op" id="7415947">.</span><span class="ident" id="7415948">Errorf</span><span class="op" id="7415954">(</span><span class="string" id="7415955">&#34;got&nbsp;%v&nbsp;from&nbsp;%v;&nbsp;want&nbsp;%v&#34;</span><span class="op" id="7415980">,</span>&nbsp;<span class="ident" id="7415982">msg</span><span class="op" id="7415985">.</span><span class="ident" id="7415986">rcode</span><span class="op" id="7415991">,</span>&nbsp;<span class="ident" id="7415993">server</span><span class="op" id="7415999">,</span>&nbsp;<span class="ident" id="7416001">tt</span><span class="op" id="7416003">.</span><span class="ident" id="7416004">rcode</span><span class="op" id="7416009">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7416014">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7416025">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7416028">}</span><br>
<span class="lineno"></span><span class="op" id="7416030">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="keyword" id="7416033">type</span>&nbsp;<span class="ident" id="7416038">resolvConfTest</span>&nbsp;<span class="keyword" id="7416053">struct</span>&nbsp;<span class="op" id="7416060">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7416063">*</span><span class="ident" id="7416064">testing</span><span class="op" id="7416071">.</span><span class="ident" id="7416072">T</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7416075">dir</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7416083">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7416091">path</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7416099">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7416107">started</span>&nbsp;<span class="builtintype" id="7416115">bool</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7416121">quitc</span>&nbsp;&nbsp;&nbsp;<span class="keyword" id="7416129">chan</span>&nbsp;<span class="keyword" id="7416134">chan</span>&nbsp;<span class="keyword" id="7416139">struct</span><span class="op" id="7416145">{</span><span class="op" id="7416146">}</span><br>
<span class="lineno"></span><span class="op" id="7416148">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7416151">func</span>&nbsp;<span class="ident" id="7416156">newResolvConfTest</span><span class="op" id="7416173">(</span><span class="ident" id="7416174">t</span>&nbsp;<span class="op" id="7416176">*</span><span class="ident" id="7416177">testing</span><span class="op" id="7416184">.</span><span class="ident" id="7416185">T</span><span class="op" id="7416186">)</span>&nbsp;<span class="op" id="7416188">*</span><span class="ident" id="7416189">resolvConfTest</span>&nbsp;<span class="op" id="7416204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7416207">dir</span><span class="op" id="7416210">,</span>&nbsp;<span class="ident" id="7416212">err</span>&nbsp;<span class="op" id="7416216">:=</span>&nbsp;<span class="ident" id="7416219">ioutil</span><span class="op" id="7416225">.</span><span class="ident" id="7416226">TempDir</span><span class="op" id="7416233">(</span><span class="string" id="7416234">&#34;&#34;</span><span class="op" id="7416236">,</span>&nbsp;<span class="string" id="7416238">&#34;resolvConfTest&#34;</span><span class="op" id="7416254">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7416257">if</span>&nbsp;<span class="ident" id="7416260">err</span>&nbsp;<span class="op" id="7416264">!=</span>&nbsp;<span class="ident" id="7416267">nil</span>&nbsp;<span class="op" id="7416271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7416275">t</span><span class="op" id="7416276">.</span><span class="ident" id="7416277">Fatalf</span><span class="op" id="7416283">(</span><span class="string" id="7416284">&#34;could&nbsp;not&nbsp;create&nbsp;temp&nbsp;dir:&nbsp;%v&#34;</span><span class="op" id="7416315">,</span>&nbsp;<span class="ident" id="7416317">err</span><span class="op" id="7416320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7416323">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7416327">//&nbsp;Disable&nbsp;the&nbsp;default&nbsp;loadConfig</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7416362">onceLoadConfig</span><span class="op" id="7416376">.</span><span class="ident" id="7416377">Do</span><span class="op" id="7416379">(</span><span class="keyword" id="7416380">func</span><span class="op" id="7416384">(</span><span class="op" id="7416385">)</span>&nbsp;<span class="op" id="7416387">{</span><span class="op" id="7416388">}</span><span class="op" id="7416389">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7416393">r</span>&nbsp;<span class="op" id="7416395">:=</span>&nbsp;<span class="op" id="7416398">&amp;</span><span class="ident" id="7416399">resolvConfTest</span><span class="op" id="7416413">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7416417">T</span><span class="op" id="7416418">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="7416424">t</span><span class="op" id="7416425">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7416429">dir</span><span class="op" id="7416432">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="7416436">dir</span><span class="op" id="7416439">,</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7416443">path</span><span class="op" id="7416447">:</span>&nbsp;&nbsp;<span class="ident" id="7416450">path</span><span class="op" id="7416454">.</span><span class="ident" id="7416455">Join</span><span class="op" id="7416459">(</span><span class="ident" id="7416460">dir</span><span class="op" id="7416463">,</span>&nbsp;<span class="string" id="7416465">&#34;resolv.conf&#34;</span><span class="op" id="7416478">)</span><span class="op" id="7416479">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7416483">quitc</span><span class="op" id="7416488">:</span>&nbsp;<span class="builtinfunc" id="7416490">make</span><span class="op" id="7416494">(</span><span class="keyword" id="7416495">chan</span>&nbsp;<span class="keyword" id="7416500">chan</span>&nbsp;<span class="keyword" id="7416505">struct</span><span class="op" id="7416511">{</span><span class="op" id="7416512">}</span><span class="op" id="7416513">)</span><span class="op" id="7416514">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7416517">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7416521">return</span>&nbsp;<span class="ident" id="7416528">r</span><br>
<span class="lineno">120</span><span class="op" id="7416530">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7416533">func</span>&nbsp;<span class="op" id="7416538">(</span><span class="ident" id="7416539">r</span>&nbsp;<span class="op" id="7416541">*</span><span class="ident" id="7416542">resolvConfTest</span><span class="op" id="7416556">)</span>&nbsp;<span class="ident" id="7416558">Start</span><span class="op" id="7416563">(</span><span class="op" id="7416564">)</span>&nbsp;<span class="op" id="7416566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7416569">loadConfig</span><span class="op" id="7416579">(</span><span class="ident" id="7416580">r</span><span class="op" id="7416581">.</span><span class="ident" id="7416582">path</span><span class="op" id="7416586">,</span>&nbsp;<span class="num" id="7416588">100</span><span class="op" id="7416591">*</span><span class="ident" id="7416592">time</span><span class="op" id="7416596">.</span><span class="ident" id="7416597">Millisecond</span><span class="op" id="7416608">,</span>&nbsp;<span class="ident" id="7416610">r</span><span class="op" id="7416611">.</span><span class="ident" id="7416612">quitc</span><span class="op" id="7416617">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7416620">r</span><span class="op" id="7416621">.</span><span class="ident" id="7416622">started</span>&nbsp;<span class="op" id="7416630">=</span>&nbsp;<span class="ident" id="7416632">true</span><br>
<span class="lineno">125</span><span class="op" id="7416637">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7416640">func</span>&nbsp;<span class="op" id="7416645">(</span><span class="ident" id="7416646">r</span>&nbsp;<span class="op" id="7416648">*</span><span class="ident" id="7416649">resolvConfTest</span><span class="op" id="7416663">)</span>&nbsp;<span class="ident" id="7416665">SetConf</span><span class="op" id="7416672">(</span><span class="ident" id="7416673">s</span>&nbsp;<span class="builtintype" id="7416675">string</span><span class="op" id="7416681">)</span>&nbsp;<span class="op" id="7416683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7416686">//&nbsp;Make&nbsp;sure&nbsp;the&nbsp;file&nbsp;mtime&nbsp;will&nbsp;be&nbsp;different&nbsp;once&nbsp;we&#39;re&nbsp;done&nbsp;here,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7416755">//&nbsp;even&nbsp;on&nbsp;systems&nbsp;with&nbsp;coarse&nbsp;(1s)&nbsp;mtime&nbsp;resolution.</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7416810">time</span><span class="op" id="7416814">.</span><span class="ident" id="7416815">Sleep</span><span class="op" id="7416820">(</span><span class="ident" id="7416821">time</span><span class="op" id="7416825">.</span><span class="ident" id="7416826">Second</span><span class="op" id="7416832">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7416836">f</span><span class="op" id="7416837">,</span>&nbsp;<span class="ident" id="7416839">err</span>&nbsp;<span class="op" id="7416843">:=</span>&nbsp;<span class="ident" id="7416846">os</span><span class="op" id="7416848">.</span><span class="ident" id="7416849">OpenFile</span><span class="op" id="7416857">(</span><span class="ident" id="7416858">r</span><span class="op" id="7416859">.</span><span class="ident" id="7416860">path</span><span class="op" id="7416864">,</span>&nbsp;<span class="ident" id="7416866">os</span><span class="op" id="7416868">.</span><span class="ident" id="7416869">O_CREATE</span><span class="op" id="7416877">|</span><span class="ident" id="7416878">os</span><span class="op" id="7416880">.</span><span class="ident" id="7416881">O_TRUNC</span><span class="op" id="7416888">|</span><span class="ident" id="7416889">os</span><span class="op" id="7416891">.</span><span class="ident" id="7416892">O_WRONLY</span><span class="op" id="7416900">,</span>&nbsp;<span class="num" id="7416902">0600</span><span class="op" id="7416906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7416909">if</span>&nbsp;<span class="ident" id="7416912">err</span>&nbsp;<span class="op" id="7416916">!=</span>&nbsp;<span class="ident" id="7416919">nil</span>&nbsp;<span class="op" id="7416923">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7416927">r</span><span class="op" id="7416928">.</span><span class="ident" id="7416929">Fatalf</span><span class="op" id="7416935">(</span><span class="string" id="7416936">&#34;failed&nbsp;to&nbsp;create&nbsp;temp&nbsp;file&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="7416971">,</span>&nbsp;<span class="ident" id="7416973">r</span><span class="op" id="7416974">.</span><span class="ident" id="7416975">path</span><span class="op" id="7416979">,</span>&nbsp;<span class="ident" id="7416981">err</span><span class="op" id="7416984">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7416987">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7416990">if</span>&nbsp;<span class="ident" id="7416993">_</span><span class="op" id="7416994">,</span>&nbsp;<span class="ident" id="7416996">err</span>&nbsp;<span class="op" id="7417000">:=</span>&nbsp;<span class="ident" id="7417003">io</span><span class="op" id="7417005">.</span><span class="ident" id="7417006">WriteString</span><span class="op" id="7417017">(</span><span class="ident" id="7417018">f</span><span class="op" id="7417019">,</span>&nbsp;<span class="ident" id="7417021">s</span><span class="op" id="7417022">)</span><span class="op" id="7417023">;</span>&nbsp;<span class="ident" id="7417025">err</span>&nbsp;<span class="op" id="7417029">!=</span>&nbsp;<span class="ident" id="7417032">nil</span>&nbsp;<span class="op" id="7417036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7417040">f</span><span class="op" id="7417041">.</span><span class="ident" id="7417042">Close</span><span class="op" id="7417047">(</span><span class="op" id="7417048">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7417052">r</span><span class="op" id="7417053">.</span><span class="ident" id="7417054">Fatalf</span><span class="op" id="7417060">(</span><span class="string" id="7417061">&#34;failed&nbsp;to&nbsp;write&nbsp;temp&nbsp;file:&nbsp;%v&#34;</span><span class="op" id="7417092">,</span>&nbsp;<span class="ident" id="7417094">err</span><span class="op" id="7417097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7417100">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7417103">f</span><span class="op" id="7417104">.</span><span class="ident" id="7417105">Close</span><span class="op" id="7417110">(</span><span class="op" id="7417111">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7417115">if</span>&nbsp;<span class="ident" id="7417118">r</span><span class="op" id="7417119">.</span><span class="ident" id="7417120">started</span>&nbsp;<span class="op" id="7417128">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7417132">cfg</span><span class="op" id="7417135">.</span><span class="ident" id="7417136">ch</span>&nbsp;<span class="op" id="7417139">&lt;-</span>&nbsp;<span class="keyword" id="7417142">struct</span><span class="op" id="7417148">{</span><span class="op" id="7417149">}</span><span class="op" id="7417150">{</span><span class="op" id="7417151">}</span>&nbsp;<span class="comment" id="7417153">//&nbsp;fill&nbsp;buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7417170">cfg</span><span class="op" id="7417173">.</span><span class="ident" id="7417174">ch</span>&nbsp;<span class="op" id="7417177">&lt;-</span>&nbsp;<span class="keyword" id="7417180">struct</span><span class="op" id="7417186">{</span><span class="op" id="7417187">}</span><span class="op" id="7417188">{</span><span class="op" id="7417189">}</span>&nbsp;<span class="comment" id="7417191">//&nbsp;wait&nbsp;for&nbsp;reload&nbsp;to&nbsp;begin</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7417221">cfg</span><span class="op" id="7417224">.</span><span class="ident" id="7417225">ch</span>&nbsp;<span class="op" id="7417228">&lt;-</span>&nbsp;<span class="keyword" id="7417231">struct</span><span class="op" id="7417237">{</span><span class="op" id="7417238">}</span><span class="op" id="7417239">{</span><span class="op" id="7417240">}</span>&nbsp;<span class="comment" id="7417242">//&nbsp;wait&nbsp;for&nbsp;reload&nbsp;to&nbsp;complete</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7417274">}</span><br>
<span class="lineno"></span><span class="op" id="7417276">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7417279">func</span>&nbsp;<span class="op" id="7417284">(</span><span class="ident" id="7417285">r</span>&nbsp;<span class="op" id="7417287">*</span><span class="ident" id="7417288">resolvConfTest</span><span class="op" id="7417302">)</span>&nbsp;<span class="ident" id="7417304">WantServers</span><span class="op" id="7417315">(</span><span class="ident" id="7417316">want</span>&nbsp;<span class="op" id="7417321">[</span><span class="op" id="7417322">]</span><span class="builtintype" id="7417323">string</span><span class="op" id="7417329">)</span>&nbsp;<span class="op" id="7417331">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7417334">cfg</span><span class="op" id="7417337">.</span><span class="ident" id="7417338">mu</span><span class="op" id="7417340">.</span><span class="ident" id="7417341">RLock</span><span class="op" id="7417346">(</span><span class="op" id="7417347">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7417350">defer</span>&nbsp;<span class="ident" id="7417356">cfg</span><span class="op" id="7417359">.</span><span class="ident" id="7417360">mu</span><span class="op" id="7417362">.</span><span class="ident" id="7417363">RUnlock</span><span class="op" id="7417370">(</span><span class="op" id="7417371">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7417374">if</span>&nbsp;<span class="ident" id="7417377">got</span>&nbsp;<span class="op" id="7417381">:=</span>&nbsp;<span class="ident" id="7417384">cfg</span><span class="op" id="7417387">.</span><span class="ident" id="7417388">dnsConfig</span><span class="op" id="7417397">.</span><span class="ident" id="7417398">servers</span><span class="op" id="7417405">;</span>&nbsp;<span class="op" id="7417407">!</span><span class="ident" id="7417408">reflect</span><span class="op" id="7417415">.</span><span class="ident" id="7417416">DeepEqual</span><span class="op" id="7417425">(</span><span class="ident" id="7417426">got</span><span class="op" id="7417429">,</span>&nbsp;<span class="ident" id="7417431">want</span><span class="op" id="7417435">)</span>&nbsp;<span class="op" id="7417437">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7417441">r</span><span class="op" id="7417442">.</span><span class="ident" id="7417443">Fatalf</span><span class="op" id="7417449">(</span><span class="string" id="7417450">&#34;Unexpected&nbsp;dns&nbsp;server&nbsp;loaded,&nbsp;got&nbsp;%v&nbsp;want&nbsp;%v&#34;</span><span class="op" id="7417496">,</span>&nbsp;<span class="ident" id="7417498">got</span><span class="op" id="7417501">,</span>&nbsp;<span class="ident" id="7417503">want</span><span class="op" id="7417507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7417510">}</span><br>
<span class="lineno">155</span><span class="op" id="7417512">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7417515">func</span>&nbsp;<span class="op" id="7417520">(</span><span class="ident" id="7417521">r</span>&nbsp;<span class="op" id="7417523">*</span><span class="ident" id="7417524">resolvConfTest</span><span class="op" id="7417538">)</span>&nbsp;<span class="ident" id="7417540">Close</span><span class="op" id="7417545">(</span><span class="op" id="7417546">)</span>&nbsp;<span class="op" id="7417548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7417551">resp</span>&nbsp;<span class="op" id="7417556">:=</span>&nbsp;<span class="builtinfunc" id="7417559">make</span><span class="op" id="7417563">(</span><span class="keyword" id="7417564">chan</span>&nbsp;<span class="keyword" id="7417569">struct</span><span class="op" id="7417575">{</span><span class="op" id="7417576">}</span><span class="op" id="7417577">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7417580">r</span><span class="op" id="7417581">.</span><span class="ident" id="7417582">quitc</span>&nbsp;<span class="op" id="7417588">&lt;-</span>&nbsp;<span class="ident" id="7417591">resp</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7417597">&lt;-</span><span class="ident" id="7417599">resp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7417605">if</span>&nbsp;<span class="ident" id="7417608">err</span>&nbsp;<span class="op" id="7417612">:=</span>&nbsp;<span class="ident" id="7417615">os</span><span class="op" id="7417617">.</span><span class="ident" id="7417618">RemoveAll</span><span class="op" id="7417627">(</span><span class="ident" id="7417628">r</span><span class="op" id="7417629">.</span><span class="ident" id="7417630">dir</span><span class="op" id="7417633">)</span><span class="op" id="7417634">;</span>&nbsp;<span class="ident" id="7417636">err</span>&nbsp;<span class="op" id="7417640">!=</span>&nbsp;<span class="ident" id="7417643">nil</span>&nbsp;<span class="op" id="7417647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7417651">r</span><span class="op" id="7417652">.</span><span class="ident" id="7417653">Logf</span><span class="op" id="7417657">(</span><span class="string" id="7417658">&#34;failed&nbsp;to&nbsp;remove&nbsp;temp&nbsp;dir&nbsp;%s:&nbsp;%v&#34;</span><span class="op" id="7417692">,</span>&nbsp;<span class="ident" id="7417694">r</span><span class="op" id="7417695">.</span><span class="ident" id="7417696">dir</span><span class="op" id="7417699">,</span>&nbsp;<span class="ident" id="7417701">err</span><span class="op" id="7417704">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7417707">}</span><br>
<span class="lineno"></span><span class="op" id="7417709">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="keyword" id="7417712">func</span>&nbsp;<span class="ident" id="7417717">TestReloadResolvConfFail</span><span class="op" id="7417741">(</span><span class="ident" id="7417742">t</span>&nbsp;<span class="op" id="7417744">*</span><span class="ident" id="7417745">testing</span><span class="op" id="7417752">.</span><span class="ident" id="7417753">T</span><span class="op" id="7417754">)</span>&nbsp;<span class="op" id="7417756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7417759">if</span>&nbsp;<span class="ident" id="7417762">testing</span><span class="op" id="7417769">.</span><span class="ident" id="7417770">Short</span><span class="op" id="7417775">(</span><span class="op" id="7417776">)</span>&nbsp;<span class="op" id="7417778">||</span>&nbsp;<span class="op" id="7417781">!</span><span class="op" id="7417782">*</span><span class="ident" id="7417783">testExternal</span>&nbsp;<span class="op" id="7417796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7417800">t</span><span class="op" id="7417801">.</span><span class="ident" id="7417802">Skip</span><span class="op" id="7417806">(</span><span class="string" id="7417807">&#34;skipping&nbsp;test&nbsp;to&nbsp;avoid&nbsp;external&nbsp;network&#34;</span><span class="op" id="7417848">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7417851">}</span><br>
<span class="lineno">170</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7417855">r</span>&nbsp;<span class="op" id="7417857">:=</span>&nbsp;<span class="ident" id="7417860">newResolvConfTest</span><span class="op" id="7417877">(</span><span class="ident" id="7417878">t</span><span class="op" id="7417879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7417882">defer</span>&nbsp;<span class="ident" id="7417888">r</span><span class="op" id="7417889">.</span><span class="ident" id="7417890">Close</span><span class="op" id="7417895">(</span><span class="op" id="7417896">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7417900">//&nbsp;resolv.conf.tmp&nbsp;does&nbsp;not&nbsp;exist&nbsp;yet</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7417939">r</span><span class="op" id="7417940">.</span><span class="ident" id="7417941">Start</span><span class="op" id="7417946">(</span><span class="op" id="7417947">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7417950">if</span>&nbsp;<span class="ident" id="7417953">_</span><span class="op" id="7417954">,</span>&nbsp;<span class="ident" id="7417956">err</span>&nbsp;<span class="op" id="7417960">:=</span>&nbsp;<span class="ident" id="7417963">goLookupIP</span><span class="op" id="7417973">(</span><span class="string" id="7417974">&#34;golang.org&#34;</span><span class="op" id="7417986">)</span><span class="op" id="7417987">;</span>&nbsp;<span class="ident" id="7417989">err</span>&nbsp;<span class="op" id="7417993">==</span>&nbsp;<span class="ident" id="7417996">nil</span>&nbsp;<span class="op" id="7418000">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7418004">t</span><span class="op" id="7418005">.</span><span class="ident" id="7418006">Fatal</span><span class="op" id="7418011">(</span><span class="string" id="7418012">&#34;goLookupIP(missing)&nbsp;succeeded&#34;</span><span class="op" id="7418043">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7418046">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7418050">r</span><span class="op" id="7418051">.</span><span class="ident" id="7418052">SetConf</span><span class="op" id="7418059">(</span><span class="string" id="7418060">&#34;nameserver&nbsp;8.8.8.8&#34;</span><span class="op" id="7418080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7418083">if</span>&nbsp;<span class="ident" id="7418086">_</span><span class="op" id="7418087">,</span>&nbsp;<span class="ident" id="7418089">err</span>&nbsp;<span class="op" id="7418093">:=</span>&nbsp;<span class="ident" id="7418096">goLookupIP</span><span class="op" id="7418106">(</span><span class="string" id="7418107">&#34;golang.org&#34;</span><span class="op" id="7418119">)</span><span class="op" id="7418120">;</span>&nbsp;<span class="ident" id="7418122">err</span>&nbsp;<span class="op" id="7418126">!=</span>&nbsp;<span class="ident" id="7418129">nil</span>&nbsp;<span class="op" id="7418133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7418137">t</span><span class="op" id="7418138">.</span><span class="ident" id="7418139">Fatalf</span><span class="op" id="7418145">(</span><span class="string" id="7418146">&#34;goLookupIP(missing;&nbsp;good)&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7418184">,</span>&nbsp;<span class="ident" id="7418186">err</span><span class="op" id="7418189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7418192">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7418196">//&nbsp;Using&nbsp;a&nbsp;bad&nbsp;resolv.conf&nbsp;while&nbsp;we&nbsp;had&nbsp;a&nbsp;good</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7418244">//&nbsp;one&nbsp;before&nbsp;should&nbsp;not&nbsp;update&nbsp;the&nbsp;config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7418288">r</span><span class="op" id="7418289">.</span><span class="ident" id="7418290">SetConf</span><span class="op" id="7418297">(</span><span class="string" id="7418298">&#34;&#34;</span><span class="op" id="7418300">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7418303">if</span>&nbsp;<span class="ident" id="7418306">_</span><span class="op" id="7418307">,</span>&nbsp;<span class="ident" id="7418309">err</span>&nbsp;<span class="op" id="7418313">:=</span>&nbsp;<span class="ident" id="7418316">goLookupIP</span><span class="op" id="7418326">(</span><span class="string" id="7418327">&#34;golang.org&#34;</span><span class="op" id="7418339">)</span><span class="op" id="7418340">;</span>&nbsp;<span class="ident" id="7418342">err</span>&nbsp;<span class="op" id="7418346">!=</span>&nbsp;<span class="ident" id="7418349">nil</span>&nbsp;<span class="op" id="7418353">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7418357">t</span><span class="op" id="7418358">.</span><span class="ident" id="7418359">Fatalf</span><span class="op" id="7418365">(</span><span class="string" id="7418366">&#34;goLookupIP(missing;&nbsp;good;&nbsp;bad)&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7418409">,</span>&nbsp;<span class="ident" id="7418411">err</span><span class="op" id="7418414">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7418417">}</span><br>
<span class="lineno"></span><span class="op" id="7418419">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7418422">func</span>&nbsp;<span class="ident" id="7418427">TestReloadResolvConfChange</span><span class="op" id="7418453">(</span><span class="ident" id="7418454">t</span>&nbsp;<span class="op" id="7418456">*</span><span class="ident" id="7418457">testing</span><span class="op" id="7418464">.</span><span class="ident" id="7418465">T</span><span class="op" id="7418466">)</span>&nbsp;<span class="op" id="7418468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7418471">if</span>&nbsp;<span class="ident" id="7418474">testing</span><span class="op" id="7418481">.</span><span class="ident" id="7418482">Short</span><span class="op" id="7418487">(</span><span class="op" id="7418488">)</span>&nbsp;<span class="op" id="7418490">||</span>&nbsp;<span class="op" id="7418493">!</span><span class="op" id="7418494">*</span><span class="ident" id="7418495">testExternal</span>&nbsp;<span class="op" id="7418508">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7418512">t</span><span class="op" id="7418513">.</span><span class="ident" id="7418514">Skip</span><span class="op" id="7418518">(</span><span class="string" id="7418519">&#34;skipping&nbsp;test&nbsp;to&nbsp;avoid&nbsp;external&nbsp;network&#34;</span><span class="op" id="7418560">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7418563">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7418567">r</span>&nbsp;<span class="op" id="7418569">:=</span>&nbsp;<span class="ident" id="7418572">newResolvConfTest</span><span class="op" id="7418589">(</span><span class="ident" id="7418590">t</span><span class="op" id="7418591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7418594">defer</span>&nbsp;<span class="ident" id="7418600">r</span><span class="op" id="7418601">.</span><span class="ident" id="7418602">Close</span><span class="op" id="7418607">(</span><span class="op" id="7418608">)</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7418612">r</span><span class="op" id="7418613">.</span><span class="ident" id="7418614">SetConf</span><span class="op" id="7418621">(</span><span class="string" id="7418622">&#34;nameserver&nbsp;8.8.8.8&#34;</span><span class="op" id="7418642">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7418645">r</span><span class="op" id="7418646">.</span><span class="ident" id="7418647">Start</span><span class="op" id="7418652">(</span><span class="op" id="7418653">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7418657">if</span>&nbsp;<span class="ident" id="7418660">_</span><span class="op" id="7418661">,</span>&nbsp;<span class="ident" id="7418663">err</span>&nbsp;<span class="op" id="7418667">:=</span>&nbsp;<span class="ident" id="7418670">goLookupIP</span><span class="op" id="7418680">(</span><span class="string" id="7418681">&#34;golang.org&#34;</span><span class="op" id="7418693">)</span><span class="op" id="7418694">;</span>&nbsp;<span class="ident" id="7418696">err</span>&nbsp;<span class="op" id="7418700">!=</span>&nbsp;<span class="ident" id="7418703">nil</span>&nbsp;<span class="op" id="7418707">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7418711">t</span><span class="op" id="7418712">.</span><span class="ident" id="7418713">Fatalf</span><span class="op" id="7418719">(</span><span class="string" id="7418720">&#34;goLookupIP(good)&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7418749">,</span>&nbsp;<span class="ident" id="7418751">err</span><span class="op" id="7418754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7418757">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7418760">r</span><span class="op" id="7418761">.</span><span class="ident" id="7418762">WantServers</span><span class="op" id="7418773">(</span><span class="op" id="7418774">[</span><span class="op" id="7418775">]</span><span class="builtintype" id="7418776">string</span><span class="op" id="7418782">{</span><span class="string" id="7418783">&#34;8.8.8.8&#34;</span><span class="op" id="7418792">}</span><span class="op" id="7418793">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7418797">//&nbsp;Using&nbsp;a&nbsp;bad&nbsp;resolv.conf&nbsp;when&nbsp;we&nbsp;had&nbsp;a&nbsp;good&nbsp;one</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7418848">//&nbsp;before&nbsp;should&nbsp;not&nbsp;update&nbsp;the&nbsp;config</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7418888">r</span><span class="op" id="7418889">.</span><span class="ident" id="7418890">SetConf</span><span class="op" id="7418897">(</span><span class="string" id="7418898">&#34;&#34;</span><span class="op" id="7418900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7418903">if</span>&nbsp;<span class="ident" id="7418906">_</span><span class="op" id="7418907">,</span>&nbsp;<span class="ident" id="7418909">err</span>&nbsp;<span class="op" id="7418913">:=</span>&nbsp;<span class="ident" id="7418916">goLookupIP</span><span class="op" id="7418926">(</span><span class="string" id="7418927">&#34;golang.org&#34;</span><span class="op" id="7418939">)</span><span class="op" id="7418940">;</span>&nbsp;<span class="ident" id="7418942">err</span>&nbsp;<span class="op" id="7418946">!=</span>&nbsp;<span class="ident" id="7418949">nil</span>&nbsp;<span class="op" id="7418953">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7418957">t</span><span class="op" id="7418958">.</span><span class="ident" id="7418959">Fatalf</span><span class="op" id="7418965">(</span><span class="string" id="7418966">&#34;goLookupIP(good;&nbsp;bad)&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7419000">,</span>&nbsp;<span class="ident" id="7419002">err</span><span class="op" id="7419005">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7419008">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7419012">//&nbsp;A&nbsp;new&nbsp;good&nbsp;config&nbsp;should&nbsp;get&nbsp;picked&nbsp;up</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7419055">r</span><span class="op" id="7419056">.</span><span class="ident" id="7419057">SetConf</span><span class="op" id="7419064">(</span><span class="string" id="7419065">&#34;nameserver&nbsp;8.8.4.4&#34;</span><span class="op" id="7419085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7419088">r</span><span class="op" id="7419089">.</span><span class="ident" id="7419090">WantServers</span><span class="op" id="7419101">(</span><span class="op" id="7419102">[</span><span class="op" id="7419103">]</span><span class="builtintype" id="7419104">string</span><span class="op" id="7419110">{</span><span class="string" id="7419111">&#34;8.8.4.4&#34;</span><span class="op" id="7419120">}</span><span class="op" id="7419121">)</span><br>
<span class="lineno"></span><span class="op" id="7419123">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="keyword" id="7419126">func</span>&nbsp;<span class="ident" id="7419131">BenchmarkGoLookupIP</span><span class="op" id="7419150">(</span><span class="ident" id="7419151">b</span>&nbsp;<span class="op" id="7419153">*</span><span class="ident" id="7419154">testing</span><span class="op" id="7419161">.</span><span class="ident" id="7419162">B</span><span class="op" id="7419163">)</span>&nbsp;<span class="op" id="7419165">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7419168">for</span>&nbsp;<span class="ident" id="7419172">i</span>&nbsp;<span class="op" id="7419174">:=</span>&nbsp;<span class="num" id="7419177">0</span><span class="op" id="7419178">;</span>&nbsp;<span class="ident" id="7419180">i</span>&nbsp;<span class="op" id="7419182">&lt;</span>&nbsp;<span class="ident" id="7419184">b</span><span class="op" id="7419185">.</span><span class="ident" id="7419186">N</span><span class="op" id="7419187">;</span>&nbsp;<span class="ident" id="7419189">i</span><span class="op" id="7419190">++</span>&nbsp;<span class="op" id="7419193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7419197">goLookupIP</span><span class="op" id="7419207">(</span><span class="string" id="7419208">&#34;www.example.com&#34;</span><span class="op" id="7419225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7419228">}</span><br>
<span class="lineno">225</span><span class="op" id="7419230">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7419233">func</span>&nbsp;<span class="ident" id="7419238">BenchmarkGoLookupIPNoSuchHost</span><span class="op" id="7419267">(</span><span class="ident" id="7419268">b</span>&nbsp;<span class="op" id="7419270">*</span><span class="ident" id="7419271">testing</span><span class="op" id="7419278">.</span><span class="ident" id="7419279">B</span><span class="op" id="7419280">)</span>&nbsp;<span class="op" id="7419282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7419285">for</span>&nbsp;<span class="ident" id="7419289">i</span>&nbsp;<span class="op" id="7419291">:=</span>&nbsp;<span class="num" id="7419294">0</span><span class="op" id="7419295">;</span>&nbsp;<span class="ident" id="7419297">i</span>&nbsp;<span class="op" id="7419299">&lt;</span>&nbsp;<span class="ident" id="7419301">b</span><span class="op" id="7419302">.</span><span class="ident" id="7419303">N</span><span class="op" id="7419304">;</span>&nbsp;<span class="ident" id="7419306">i</span><span class="op" id="7419307">++</span>&nbsp;<span class="op" id="7419310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7419314">goLookupIP</span><span class="op" id="7419324">(</span><span class="string" id="7419325">&#34;some.nonexistent&#34;</span><span class="op" id="7419343">)</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7419346">}</span><br>
<span class="lineno"></span><span class="op" id="7419348">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7419351">func</span>&nbsp;<span class="ident" id="7419356">BenchmarkGoLookupIPWithBrokenNameServer</span><span class="op" id="7419395">(</span><span class="ident" id="7419396">b</span>&nbsp;<span class="op" id="7419398">*</span><span class="ident" id="7419399">testing</span><span class="op" id="7419406">.</span><span class="ident" id="7419407">B</span><span class="op" id="7419408">)</span>&nbsp;<span class="op" id="7419410">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7419413">onceLoadConfig</span><span class="op" id="7419427">.</span><span class="ident" id="7419428">Do</span><span class="op" id="7419430">(</span><span class="ident" id="7419431">loadDefaultConfig</span><span class="op" id="7419448">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7419451">if</span>&nbsp;<span class="ident" id="7419454">cfg</span><span class="op" id="7419457">.</span><span class="ident" id="7419458">dnserr</span>&nbsp;<span class="op" id="7419465">!=</span>&nbsp;<span class="ident" id="7419468">nil</span>&nbsp;<span class="op" id="7419472">||</span>&nbsp;<span class="ident" id="7419475">cfg</span><span class="op" id="7419478">.</span><span class="ident" id="7419479">dnsConfig</span>&nbsp;<span class="op" id="7419489">==</span>&nbsp;<span class="ident" id="7419492">nil</span>&nbsp;<span class="op" id="7419496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7419500">b</span><span class="op" id="7419501">.</span><span class="ident" id="7419502">Fatalf</span><span class="op" id="7419508">(</span><span class="string" id="7419509">&#34;loadConfig&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7419532">,</span>&nbsp;<span class="ident" id="7419534">cfg</span><span class="op" id="7419537">.</span><span class="ident" id="7419538">dnserr</span><span class="op" id="7419544">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7419547">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7419550">//&nbsp;This&nbsp;looks&nbsp;ugly&nbsp;but&nbsp;it&#39;s&nbsp;safe&nbsp;as&nbsp;long&nbsp;as&nbsp;benchmarks&nbsp;are&nbsp;run</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7419614">//&nbsp;sequentially&nbsp;in&nbsp;package&nbsp;testing.</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7419651">orig</span>&nbsp;<span class="op" id="7419656">:=</span>&nbsp;<span class="ident" id="7419659">cfg</span><span class="op" id="7419662">.</span><span class="ident" id="7419663">dnsConfig</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7419674">cfg</span><span class="op" id="7419677">.</span><span class="ident" id="7419678">dnsConfig</span><span class="op" id="7419687">.</span><span class="ident" id="7419688">servers</span>&nbsp;<span class="op" id="7419696">=</span>&nbsp;<span class="builtinfunc" id="7419698">append</span><span class="op" id="7419704">(</span><span class="op" id="7419705">[</span><span class="op" id="7419706">]</span><span class="builtintype" id="7419707">string</span><span class="op" id="7419713">{</span><span class="string" id="7419714">&#34;203.0.113.254&#34;</span><span class="op" id="7419729">}</span><span class="op" id="7419730">,</span>&nbsp;<span class="ident" id="7419732">cfg</span><span class="op" id="7419735">.</span><span class="ident" id="7419736">dnsConfig</span><span class="op" id="7419745">.</span><span class="ident" id="7419746">servers</span><span class="op" id="7419753">...</span><span class="op" id="7419756">)</span>&nbsp;<span class="comment" id="7419758">//&nbsp;use&nbsp;TEST-NET-3&nbsp;block,&nbsp;see&nbsp;RFC&nbsp;5737</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7419797">for</span>&nbsp;<span class="ident" id="7419801">i</span>&nbsp;<span class="op" id="7419803">:=</span>&nbsp;<span class="num" id="7419806">0</span><span class="op" id="7419807">;</span>&nbsp;<span class="ident" id="7419809">i</span>&nbsp;<span class="op" id="7419811">&lt;</span>&nbsp;<span class="ident" id="7419813">b</span><span class="op" id="7419814">.</span><span class="ident" id="7419815">N</span><span class="op" id="7419816">;</span>&nbsp;<span class="ident" id="7419818">i</span><span class="op" id="7419819">++</span>&nbsp;<span class="op" id="7419822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7419826">goLookupIP</span><span class="op" id="7419836">(</span><span class="string" id="7419837">&#34;www.example.com&#34;</span><span class="op" id="7419854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7419857">}</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7419860">cfg</span><span class="op" id="7419863">.</span><span class="ident" id="7419864">dnsConfig</span>&nbsp;<span class="op" id="7419874">=</span>&nbsp;<span class="ident" id="7419876">orig</span><br>
<span class="lineno"></span><span class="op" id="7419881">}</span>
</div>
</body>
</html>
