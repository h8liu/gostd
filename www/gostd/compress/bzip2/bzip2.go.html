<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>compress/bzip2</h2>
<ul>
<li><a href="/gostd/compress/bzip2/bit_reader.go.html">bit_reader.go</a></li>
<li><a href="/gostd/compress/bzip2/bzip2.go.html" class="current">bzip2.go</a></li>
<li><a href="/gostd/compress/bzip2/bzip2_test.go.html">bzip2_test.go</a></li>
<li><a href="/gostd/compress/bzip2/huffman.go.html">huffman.go</a></li>
<li><a href="/gostd/compress/bzip2/move_to_front.go.html">move_to_front.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5498788">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5498843">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5498897">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5498948">//&nbsp;Package&nbsp;bzip2&nbsp;implements&nbsp;bzip2&nbsp;decompression.</span><br>
<span class="lineno"></span><span class="keyword" id="5498997">package</span>&nbsp;<span class="ident" id="5499005">bzip2</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5499012">import</span>&nbsp;<span class="string" id="5499019">&#34;io&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="comment" id="5499025">//&nbsp;There&#39;s&nbsp;no&nbsp;RFC&nbsp;for&nbsp;bzip2.&nbsp;I&nbsp;used&nbsp;the&nbsp;Wikipedia&nbsp;page&nbsp;for&nbsp;reference&nbsp;and&nbsp;a&nbsp;lot</span><br>
<span class="lineno"></span><span class="comment" id="5499104">//&nbsp;of&nbsp;guessing:&nbsp;http://en.wikipedia.org/wiki/Bzip2</span><br>
<span class="lineno"></span><span class="comment" id="5499155">//&nbsp;The&nbsp;source&nbsp;code&nbsp;to&nbsp;pyflate&nbsp;was&nbsp;useful&nbsp;for&nbsp;debugging:</span><br>
<span class="lineno"></span><span class="comment" id="5499211">//&nbsp;http://www.paul.sladen.org/projects/pyflate</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="comment" id="5499259">//&nbsp;A&nbsp;StructuralError&nbsp;is&nbsp;returned&nbsp;when&nbsp;the&nbsp;bzip2&nbsp;data&nbsp;is&nbsp;found&nbsp;to&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="5499327">//&nbsp;syntactically&nbsp;invalid.</span><br>
<span class="lineno"></span><span class="keyword" id="5499353">type</span>&nbsp;<span class="ident" id="5499358">StructuralError</span>&nbsp;<span class="builtintype" id="5499374">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5499382">func</span>&nbsp;<span class="op" id="5499387">(</span><span class="ident" id="5499388">s</span>&nbsp;<span class="ident" id="5499390">StructuralError</span><span class="op" id="5499405">)</span>&nbsp;<span class="ident" id="5499407">Error</span><span class="op" id="5499412">(</span><span class="op" id="5499413">)</span>&nbsp;<span class="builtintype" id="5499415">string</span>&nbsp;<span class="op" id="5499422">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5499425">return</span>&nbsp;<span class="string" id="5499432">&#34;bzip2&nbsp;data&nbsp;invalid:&nbsp;&#34;</span>&nbsp;<span class="op" id="5499455">+</span>&nbsp;<span class="builtintype" id="5499457">string</span><span class="op" id="5499463">(</span><span class="ident" id="5499464">s</span><span class="op" id="5499465">)</span><br>
<span class="lineno"></span><span class="op" id="5499467">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5499470">//&nbsp;A&nbsp;reader&nbsp;decompresses&nbsp;bzip2&nbsp;compressed&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="5499518">type</span>&nbsp;<span class="ident" id="5499523">reader</span>&nbsp;<span class="keyword" id="5499530">struct</span>&nbsp;<span class="op" id="5499537">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5499540">br</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5499553">bitReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5499564">fileCRC</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5499577">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5499585">blockCRC</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5499598">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5499606">wantBlockCRC</span>&nbsp;<span class="builtintype" id="5499619">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5499627">setupDone</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5499640">bool</span>&nbsp;<span class="comment" id="5499645">//&nbsp;true&nbsp;if&nbsp;we&nbsp;have&nbsp;parsed&nbsp;the&nbsp;bzip2&nbsp;header.</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5499690">blockSize</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5499703">int</span>&nbsp;&nbsp;<span class="comment" id="5499708">//&nbsp;blockSize&nbsp;in&nbsp;bytes,&nbsp;i.e.&nbsp;900&nbsp;*&nbsp;1024.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5499749">eof</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5499762">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5499768">buf</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5499781">[</span><span class="op" id="5499782">]</span><span class="builtintype" id="5499783">byte</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5499791">//&nbsp;stores&nbsp;Burrows-Wheeler&nbsp;transformed&nbsp;data.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5499836">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5499849">[</span><span class="num" id="5499850">256</span><span class="op" id="5499853">]</span><span class="builtintype" id="5499854">uint</span>&nbsp;<span class="comment" id="5499859">//&nbsp;the&nbsp;`C&#39;&nbsp;array&nbsp;for&nbsp;the&nbsp;inverse&nbsp;BWT.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5499898">tt</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5499911">[</span><span class="op" id="5499912">]</span><span class="builtintype" id="5499913">uint32</span>&nbsp;&nbsp;<span class="comment" id="5499921">//&nbsp;mirrors&nbsp;the&nbsp;`tt&#39;&nbsp;array&nbsp;in&nbsp;the&nbsp;bzip2&nbsp;source&nbsp;and&nbsp;contains&nbsp;the&nbsp;P&nbsp;array&nbsp;in&nbsp;the&nbsp;upper&nbsp;24&nbsp;bits.</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5500015">tPos</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5500028">uint32</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5500038">//&nbsp;Index&nbsp;of&nbsp;the&nbsp;next&nbsp;output&nbsp;byte&nbsp;in&nbsp;tt.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5500080">preRLE</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5500092">[</span><span class="op" id="5500093">]</span><span class="builtintype" id="5500094">uint32</span>&nbsp;<span class="comment" id="5500101">//&nbsp;contains&nbsp;the&nbsp;RLE&nbsp;data&nbsp;still&nbsp;to&nbsp;be&nbsp;processed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5500150">preRLEUsed</span>&nbsp;&nbsp;<span class="builtintype" id="5500162">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5500171">//&nbsp;number&nbsp;of&nbsp;entries&nbsp;of&nbsp;preRLE&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5500209">lastByte</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5500221">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5500230">//&nbsp;the&nbsp;last&nbsp;byte&nbsp;value&nbsp;seen.</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5500260">byteRepeats</span>&nbsp;<span class="builtintype" id="5500272">uint</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5500281">//&nbsp;the&nbsp;number&nbsp;of&nbsp;repeats&nbsp;of&nbsp;lastByte&nbsp;seen.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5500325">repeats</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5500337">uint</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5500346">//&nbsp;the&nbsp;number&nbsp;of&nbsp;copies&nbsp;of&nbsp;lastByte&nbsp;to&nbsp;output.</span><br>
<span class="lineno"></span><span class="op" id="5500393">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5500396">//&nbsp;NewReader&nbsp;returns&nbsp;an&nbsp;io.Reader&nbsp;which&nbsp;decompresses&nbsp;bzip2&nbsp;data&nbsp;from&nbsp;r.</span><br>
<span class="lineno">45</span><span class="comment" id="5500468">//&nbsp;If&nbsp;r&nbsp;does&nbsp;not&nbsp;also&nbsp;implement&nbsp;io.ByteReader,</span><br>
<span class="lineno"></span><span class="comment" id="5500515">//&nbsp;the&nbsp;decompressor&nbsp;may&nbsp;read&nbsp;more&nbsp;data&nbsp;than&nbsp;necessary&nbsp;from&nbsp;r.</span><br>
<span class="lineno"></span><span class="keyword" id="5500577">func</span>&nbsp;<span class="ident" id="5500582">NewReader</span><span class="op" id="5500591">(</span><span class="ident" id="5500592">r</span>&nbsp;<span class="ident" id="5500594">io</span><span class="op" id="5500596">.</span><span class="ident" id="5500597">Reader</span><span class="op" id="5500603">)</span>&nbsp;<span class="ident" id="5500605">io</span><span class="op" id="5500607">.</span><span class="ident" id="5500608">Reader</span>&nbsp;<span class="op" id="5500615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5500618">bz2</span>&nbsp;<span class="op" id="5500622">:=</span>&nbsp;<span class="builtinfunc" id="5500625">new</span><span class="op" id="5500628">(</span><span class="ident" id="5500629">reader</span><span class="op" id="5500635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5500638">bz2</span><span class="op" id="5500641">.</span><span class="ident" id="5500642">br</span>&nbsp;<span class="op" id="5500645">=</span>&nbsp;<span class="ident" id="5500647">newBitReader</span><span class="op" id="5500659">(</span><span class="ident" id="5500660">r</span><span class="op" id="5500661">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5500664">return</span>&nbsp;<span class="ident" id="5500671">bz2</span><br>
<span class="lineno"></span><span class="op" id="5500675">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5500678">const</span>&nbsp;<span class="ident" id="5500684">bzip2FileMagic</span>&nbsp;<span class="op" id="5500699">=</span>&nbsp;<span class="num" id="5500701">0x425a</span>&nbsp;<span class="comment" id="5500708">//&nbsp;&#34;BZ&#34;</span><br>
<span class="lineno"></span><span class="keyword" id="5500716">const</span>&nbsp;<span class="ident" id="5500722">bzip2BlockMagic</span>&nbsp;<span class="op" id="5500738">=</span>&nbsp;<span class="num" id="5500740">0x314159265359</span><br>
<span class="lineno">55</span><span class="keyword" id="5500755">const</span>&nbsp;<span class="ident" id="5500761">bzip2FinalMagic</span>&nbsp;<span class="op" id="5500777">=</span>&nbsp;<span class="num" id="5500779">0x177245385090</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5500795">//&nbsp;setup&nbsp;parses&nbsp;the&nbsp;bzip2&nbsp;header.</span><br>
<span class="lineno"></span><span class="keyword" id="5500829">func</span>&nbsp;<span class="op" id="5500834">(</span><span class="ident" id="5500835">bz2</span>&nbsp;<span class="op" id="5500839">*</span><span class="ident" id="5500840">reader</span><span class="op" id="5500846">)</span>&nbsp;<span class="ident" id="5500848">setup</span><span class="op" id="5500853">(</span><span class="ident" id="5500854">needMagic</span>&nbsp;<span class="builtintype" id="5500864">bool</span><span class="op" id="5500868">)</span>&nbsp;<span class="builtintype" id="5500870">error</span>&nbsp;<span class="op" id="5500876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5500879">br</span>&nbsp;<span class="op" id="5500882">:=</span>&nbsp;<span class="op" id="5500885">&amp;</span><span class="ident" id="5500886">bz2</span><span class="op" id="5500889">.</span><span class="ident" id="5500890">br</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5500895">if</span>&nbsp;<span class="ident" id="5500898">needMagic</span>&nbsp;<span class="op" id="5500908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5500912">magic</span>&nbsp;<span class="op" id="5500918">:=</span>&nbsp;<span class="ident" id="5500921">br</span><span class="op" id="5500923">.</span><span class="ident" id="5500924">ReadBits</span><span class="op" id="5500932">(</span><span class="num" id="5500933">16</span><span class="op" id="5500935">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5500939">if</span>&nbsp;<span class="ident" id="5500942">magic</span>&nbsp;<span class="op" id="5500948">!=</span>&nbsp;<span class="ident" id="5500951">bzip2FileMagic</span>&nbsp;<span class="op" id="5500966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5500971">return</span>&nbsp;<span class="ident" id="5500978">StructuralError</span><span class="op" id="5500993">(</span><span class="string" id="5500994">&#34;bad&nbsp;magic&nbsp;value&#34;</span><span class="op" id="5501011">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5501015">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5501018">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5501022">t</span>&nbsp;<span class="op" id="5501024">:=</span>&nbsp;<span class="ident" id="5501027">br</span><span class="op" id="5501029">.</span><span class="ident" id="5501030">ReadBits</span><span class="op" id="5501038">(</span><span class="num" id="5501039">8</span><span class="op" id="5501040">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5501043">if</span>&nbsp;<span class="ident" id="5501046">t</span>&nbsp;<span class="op" id="5501048">!=</span>&nbsp;<span class="string" id="5501051">&#39;h&#39;</span>&nbsp;<span class="op" id="5501055">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5501059">return</span>&nbsp;<span class="ident" id="5501066">StructuralError</span><span class="op" id="5501081">(</span><span class="string" id="5501082">&#34;non-Huffman&nbsp;entropy&nbsp;encoding&#34;</span><span class="op" id="5501112">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5501115">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5501119">level</span>&nbsp;<span class="op" id="5501125">:=</span>&nbsp;<span class="ident" id="5501128">br</span><span class="op" id="5501130">.</span><span class="ident" id="5501131">ReadBits</span><span class="op" id="5501139">(</span><span class="num" id="5501140">8</span><span class="op" id="5501141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5501144">if</span>&nbsp;<span class="ident" id="5501147">level</span>&nbsp;<span class="op" id="5501153">&lt;</span>&nbsp;<span class="string" id="5501155">&#39;1&#39;</span>&nbsp;<span class="op" id="5501159">||</span>&nbsp;<span class="ident" id="5501162">level</span>&nbsp;<span class="op" id="5501168">&gt;</span>&nbsp;<span class="string" id="5501170">&#39;9&#39;</span>&nbsp;<span class="op" id="5501174">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5501178">return</span>&nbsp;<span class="ident" id="5501185">StructuralError</span><span class="op" id="5501200">(</span><span class="string" id="5501201">&#34;invalid&nbsp;compression&nbsp;level&#34;</span><span class="op" id="5501228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5501231">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5501235">bz2</span><span class="op" id="5501238">.</span><span class="ident" id="5501239">fileCRC</span>&nbsp;<span class="op" id="5501247">=</span>&nbsp;<span class="num" id="5501249">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5501252">bz2</span><span class="op" id="5501255">.</span><span class="ident" id="5501256">blockSize</span>&nbsp;<span class="op" id="5501266">=</span>&nbsp;<span class="num" id="5501268">100</span>&nbsp;<span class="op" id="5501272">*</span>&nbsp;<span class="num" id="5501274">1024</span>&nbsp;<span class="op" id="5501279">*</span>&nbsp;<span class="op" id="5501281">(</span><span class="builtintype" id="5501282">int</span><span class="op" id="5501285">(</span><span class="ident" id="5501286">level</span><span class="op" id="5501291">)</span>&nbsp;<span class="op" id="5501293">-</span>&nbsp;<span class="string" id="5501295">&#39;0&#39;</span><span class="op" id="5501298">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5501301">if</span>&nbsp;<span class="ident" id="5501304">bz2</span><span class="op" id="5501307">.</span><span class="ident" id="5501308">blockSize</span>&nbsp;<span class="op" id="5501318">&gt;</span>&nbsp;<span class="builtinfunc" id="5501320">len</span><span class="op" id="5501323">(</span><span class="ident" id="5501324">bz2</span><span class="op" id="5501327">.</span><span class="ident" id="5501328">tt</span><span class="op" id="5501330">)</span>&nbsp;<span class="op" id="5501332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5501336">bz2</span><span class="op" id="5501339">.</span><span class="ident" id="5501340">tt</span>&nbsp;<span class="op" id="5501343">=</span>&nbsp;<span class="builtinfunc" id="5501345">make</span><span class="op" id="5501349">(</span><span class="op" id="5501350">[</span><span class="op" id="5501351">]</span><span class="builtintype" id="5501352">uint32</span><span class="op" id="5501358">,</span>&nbsp;<span class="ident" id="5501360">bz2</span><span class="op" id="5501363">.</span><span class="ident" id="5501364">blockSize</span><span class="op" id="5501373">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5501376">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5501379">return</span>&nbsp;<span class="ident" id="5501386">nil</span><br>
<span class="lineno"></span><span class="op" id="5501390">}</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span><span class="keyword" id="5501393">func</span>&nbsp;<span class="op" id="5501398">(</span><span class="ident" id="5501399">bz2</span>&nbsp;<span class="op" id="5501403">*</span><span class="ident" id="5501404">reader</span><span class="op" id="5501410">)</span>&nbsp;<span class="ident" id="5501412">Read</span><span class="op" id="5501416">(</span><span class="ident" id="5501417">buf</span>&nbsp;<span class="op" id="5501421">[</span><span class="op" id="5501422">]</span><span class="builtintype" id="5501423">byte</span><span class="op" id="5501427">)</span>&nbsp;<span class="op" id="5501429">(</span><span class="ident" id="5501430">n</span>&nbsp;<span class="builtintype" id="5501432">int</span><span class="op" id="5501435">,</span>&nbsp;<span class="ident" id="5501437">err</span>&nbsp;<span class="builtintype" id="5501441">error</span><span class="op" id="5501446">)</span>&nbsp;<span class="op" id="5501448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5501451">if</span>&nbsp;<span class="ident" id="5501454">bz2</span><span class="op" id="5501457">.</span><span class="ident" id="5501458">eof</span>&nbsp;<span class="op" id="5501462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5501466">return</span>&nbsp;<span class="num" id="5501473">0</span><span class="op" id="5501474">,</span>&nbsp;<span class="ident" id="5501476">io</span><span class="op" id="5501478">.</span><span class="ident" id="5501479">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5501484">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5501488">if</span>&nbsp;<span class="op" id="5501491">!</span><span class="ident" id="5501492">bz2</span><span class="op" id="5501495">.</span><span class="ident" id="5501496">setupDone</span>&nbsp;<span class="op" id="5501506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5501510">err</span>&nbsp;<span class="op" id="5501514">=</span>&nbsp;<span class="ident" id="5501516">bz2</span><span class="op" id="5501519">.</span><span class="ident" id="5501520">setup</span><span class="op" id="5501525">(</span><span class="builtintype" id="5501526">true</span><span class="op" id="5501530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5501534">brErr</span>&nbsp;<span class="op" id="5501540">:=</span>&nbsp;<span class="ident" id="5501543">bz2</span><span class="op" id="5501546">.</span><span class="ident" id="5501547">br</span><span class="op" id="5501549">.</span><span class="ident" id="5501550">Err</span><span class="op" id="5501553">(</span><span class="op" id="5501554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5501558">if</span>&nbsp;<span class="ident" id="5501561">brErr</span>&nbsp;<span class="op" id="5501567">!=</span>&nbsp;<span class="ident" id="5501570">nil</span>&nbsp;<span class="op" id="5501574">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5501579">err</span>&nbsp;<span class="op" id="5501583">=</span>&nbsp;<span class="ident" id="5501585">brErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5501593">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5501597">if</span>&nbsp;<span class="ident" id="5501600">err</span>&nbsp;<span class="op" id="5501604">!=</span>&nbsp;<span class="ident" id="5501607">nil</span>&nbsp;<span class="op" id="5501611">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5501616">return</span>&nbsp;<span class="num" id="5501623">0</span><span class="op" id="5501624">,</span>&nbsp;<span class="ident" id="5501626">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5501632">}</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5501636">bz2</span><span class="op" id="5501639">.</span><span class="ident" id="5501640">setupDone</span>&nbsp;<span class="op" id="5501650">=</span>&nbsp;<span class="builtintype" id="5501652">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5501658">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5501662">n</span><span class="op" id="5501663">,</span>&nbsp;<span class="ident" id="5501665">err</span>&nbsp;<span class="op" id="5501669">=</span>&nbsp;<span class="ident" id="5501671">bz2</span><span class="op" id="5501674">.</span><span class="ident" id="5501675">read</span><span class="op" id="5501679">(</span><span class="ident" id="5501680">buf</span><span class="op" id="5501683">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5501686">brErr</span>&nbsp;<span class="op" id="5501692">:=</span>&nbsp;<span class="ident" id="5501695">bz2</span><span class="op" id="5501698">.</span><span class="ident" id="5501699">br</span><span class="op" id="5501701">.</span><span class="ident" id="5501702">Err</span><span class="op" id="5501705">(</span><span class="op" id="5501706">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5501709">if</span>&nbsp;<span class="ident" id="5501712">brErr</span>&nbsp;<span class="op" id="5501718">!=</span>&nbsp;<span class="ident" id="5501721">nil</span>&nbsp;<span class="op" id="5501725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5501729">err</span>&nbsp;<span class="op" id="5501733">=</span>&nbsp;<span class="ident" id="5501735">brErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5501742">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5501745">return</span><br>
<span class="lineno"></span><span class="op" id="5501752">}</span><br>
<span class="lineno">110</span><br>
<span class="lineno"></span><span class="keyword" id="5501755">func</span>&nbsp;<span class="op" id="5501760">(</span><span class="ident" id="5501761">bz2</span>&nbsp;<span class="op" id="5501765">*</span><span class="ident" id="5501766">reader</span><span class="op" id="5501772">)</span>&nbsp;<span class="ident" id="5501774">readFromBlock</span><span class="op" id="5501787">(</span><span class="ident" id="5501788">buf</span>&nbsp;<span class="op" id="5501792">[</span><span class="op" id="5501793">]</span><span class="builtintype" id="5501794">byte</span><span class="op" id="5501798">)</span>&nbsp;<span class="builtintype" id="5501800">int</span>&nbsp;<span class="op" id="5501804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5501807">//&nbsp;bzip2&nbsp;is&nbsp;a&nbsp;block&nbsp;based&nbsp;compressor,&nbsp;except&nbsp;that&nbsp;it&nbsp;has&nbsp;a&nbsp;run-length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5501878">//&nbsp;preprocessing&nbsp;step.&nbsp;The&nbsp;block&nbsp;based&nbsp;nature&nbsp;means&nbsp;that&nbsp;we&nbsp;can</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5501943">//&nbsp;preallocate&nbsp;fixed-size&nbsp;buffers&nbsp;and&nbsp;reuse&nbsp;them.&nbsp;However,&nbsp;the&nbsp;RLE</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5502011">//&nbsp;preprocessing&nbsp;would&nbsp;require&nbsp;allocating&nbsp;huge&nbsp;buffers&nbsp;to&nbsp;store&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5502080">//&nbsp;maximum&nbsp;expansion.&nbsp;Thus&nbsp;we&nbsp;process&nbsp;blocks&nbsp;all&nbsp;at&nbsp;once,&nbsp;except&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5502150">//&nbsp;the&nbsp;RLE&nbsp;which&nbsp;we&nbsp;decompress&nbsp;as&nbsp;required.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5502195">n</span>&nbsp;<span class="op" id="5502197">:=</span>&nbsp;<span class="num" id="5502200">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5502203">for</span>&nbsp;<span class="op" id="5502207">(</span><span class="ident" id="5502208">bz2</span><span class="op" id="5502211">.</span><span class="ident" id="5502212">repeats</span>&nbsp;<span class="op" id="5502220">&gt;</span>&nbsp;<span class="num" id="5502222">0</span>&nbsp;<span class="op" id="5502224">||</span>&nbsp;<span class="ident" id="5502227">bz2</span><span class="op" id="5502230">.</span><span class="ident" id="5502231">preRLEUsed</span>&nbsp;<span class="op" id="5502242">&lt;</span>&nbsp;<span class="builtinfunc" id="5502244">len</span><span class="op" id="5502247">(</span><span class="ident" id="5502248">bz2</span><span class="op" id="5502251">.</span><span class="ident" id="5502252">preRLE</span><span class="op" id="5502258">)</span><span class="op" id="5502259">)</span>&nbsp;<span class="op" id="5502261">&amp;&amp;</span>&nbsp;<span class="ident" id="5502264">n</span>&nbsp;<span class="op" id="5502266">&lt;</span>&nbsp;<span class="builtinfunc" id="5502268">len</span><span class="op" id="5502271">(</span><span class="ident" id="5502272">buf</span><span class="op" id="5502275">)</span>&nbsp;<span class="op" id="5502277">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5502281">//&nbsp;We&nbsp;have&nbsp;RLE&nbsp;data&nbsp;pending.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5502313">//&nbsp;The&nbsp;run-length&nbsp;encoding&nbsp;works&nbsp;like&nbsp;this:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5502359">//&nbsp;Any&nbsp;sequence&nbsp;of&nbsp;four&nbsp;equal&nbsp;bytes&nbsp;is&nbsp;followed&nbsp;by&nbsp;a&nbsp;length</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5502421">//&nbsp;byte&nbsp;which&nbsp;contains&nbsp;the&nbsp;number&nbsp;of&nbsp;repeats&nbsp;of&nbsp;that&nbsp;byte&nbsp;to</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5502484">//&nbsp;include.&nbsp;(The&nbsp;number&nbsp;of&nbsp;repeats&nbsp;can&nbsp;be&nbsp;zero.)&nbsp;Because&nbsp;we&nbsp;are</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5502550">//&nbsp;decompressing&nbsp;on-demand&nbsp;our&nbsp;state&nbsp;is&nbsp;kept&nbsp;in&nbsp;the&nbsp;reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5502611">//&nbsp;object.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5502625">if</span>&nbsp;<span class="ident" id="5502628">bz2</span><span class="op" id="5502631">.</span><span class="ident" id="5502632">repeats</span>&nbsp;<span class="op" id="5502640">&gt;</span>&nbsp;<span class="num" id="5502642">0</span>&nbsp;<span class="op" id="5502644">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5502649">buf</span><span class="op" id="5502652">[</span><span class="ident" id="5502653">n</span><span class="op" id="5502654">]</span>&nbsp;<span class="op" id="5502656">=</span>&nbsp;<span class="builtintype" id="5502658">byte</span><span class="op" id="5502662">(</span><span class="ident" id="5502663">bz2</span><span class="op" id="5502666">.</span><span class="ident" id="5502667">lastByte</span><span class="op" id="5502675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5502680">n</span><span class="op" id="5502681">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5502687">bz2</span><span class="op" id="5502690">.</span><span class="ident" id="5502691">repeats</span><span class="op" id="5502698">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5502704">if</span>&nbsp;<span class="ident" id="5502707">bz2</span><span class="op" id="5502710">.</span><span class="ident" id="5502711">repeats</span>&nbsp;<span class="op" id="5502719">==</span>&nbsp;<span class="num" id="5502722">0</span>&nbsp;<span class="op" id="5502724">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5502730">bz2</span><span class="op" id="5502733">.</span><span class="ident" id="5502734">lastByte</span>&nbsp;<span class="op" id="5502743">=</span>&nbsp;<span class="op" id="5502745">-</span><span class="num" id="5502746">1</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5502751">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5502756">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5502767">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5502772">bz2</span><span class="op" id="5502775">.</span><span class="ident" id="5502776">tPos</span>&nbsp;<span class="op" id="5502781">=</span>&nbsp;<span class="ident" id="5502783">bz2</span><span class="op" id="5502786">.</span><span class="ident" id="5502787">preRLE</span><span class="op" id="5502793">[</span><span class="ident" id="5502794">bz2</span><span class="op" id="5502797">.</span><span class="ident" id="5502798">tPos</span><span class="op" id="5502802">]</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5502806">b</span>&nbsp;<span class="op" id="5502808">:=</span>&nbsp;<span class="builtintype" id="5502811">byte</span><span class="op" id="5502815">(</span><span class="ident" id="5502816">bz2</span><span class="op" id="5502819">.</span><span class="ident" id="5502820">tPos</span><span class="op" id="5502824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5502828">bz2</span><span class="op" id="5502831">.</span><span class="ident" id="5502832">tPos</span>&nbsp;<span class="op" id="5502837">&gt;&gt;=</span>&nbsp;<span class="num" id="5502841">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5502845">bz2</span><span class="op" id="5502848">.</span><span class="ident" id="5502849">preRLEUsed</span><span class="op" id="5502859">++</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5502865">if</span>&nbsp;<span class="ident" id="5502868">bz2</span><span class="op" id="5502871">.</span><span class="ident" id="5502872">byteRepeats</span>&nbsp;<span class="op" id="5502884">==</span>&nbsp;<span class="num" id="5502887">3</span>&nbsp;<span class="op" id="5502889">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5502894">bz2</span><span class="op" id="5502897">.</span><span class="ident" id="5502898">repeats</span>&nbsp;<span class="op" id="5502906">=</span>&nbsp;<span class="builtintype" id="5502908">uint</span><span class="op" id="5502912">(</span><span class="ident" id="5502913">b</span><span class="op" id="5502914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5502919">bz2</span><span class="op" id="5502922">.</span><span class="ident" id="5502923">byteRepeats</span>&nbsp;<span class="op" id="5502935">=</span>&nbsp;<span class="num" id="5502937">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5502942">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5502953">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5502958">if</span>&nbsp;<span class="ident" id="5502961">bz2</span><span class="op" id="5502964">.</span><span class="ident" id="5502965">lastByte</span>&nbsp;<span class="op" id="5502974">==</span>&nbsp;<span class="builtintype" id="5502977">int</span><span class="op" id="5502980">(</span><span class="ident" id="5502981">b</span><span class="op" id="5502982">)</span>&nbsp;<span class="op" id="5502984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5502989">bz2</span><span class="op" id="5502992">.</span><span class="ident" id="5502993">byteRepeats</span><span class="op" id="5503004">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5503009">}</span>&nbsp;<span class="keyword" id="5503011">else</span>&nbsp;<span class="op" id="5503016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5503021">bz2</span><span class="op" id="5503024">.</span><span class="ident" id="5503025">byteRepeats</span>&nbsp;<span class="op" id="5503037">=</span>&nbsp;<span class="num" id="5503039">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5503043">}</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5503047">bz2</span><span class="op" id="5503050">.</span><span class="ident" id="5503051">lastByte</span>&nbsp;<span class="op" id="5503060">=</span>&nbsp;<span class="builtintype" id="5503062">int</span><span class="op" id="5503065">(</span><span class="ident" id="5503066">b</span><span class="op" id="5503067">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5503072">buf</span><span class="op" id="5503075">[</span><span class="ident" id="5503076">n</span><span class="op" id="5503077">]</span>&nbsp;<span class="op" id="5503079">=</span>&nbsp;<span class="ident" id="5503081">b</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5503085">n</span><span class="op" id="5503086">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5503090">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5503094">return</span>&nbsp;<span class="ident" id="5503101">n</span><br>
<span class="lineno"></span><span class="op" id="5503103">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5503106">func</span>&nbsp;<span class="op" id="5503111">(</span><span class="ident" id="5503112">bz2</span>&nbsp;<span class="op" id="5503116">*</span><span class="ident" id="5503117">reader</span><span class="op" id="5503123">)</span>&nbsp;<span class="ident" id="5503125">read</span><span class="op" id="5503129">(</span><span class="ident" id="5503130">buf</span>&nbsp;<span class="op" id="5503134">[</span><span class="op" id="5503135">]</span><span class="builtintype" id="5503136">byte</span><span class="op" id="5503140">)</span>&nbsp;<span class="op" id="5503142">(</span><span class="builtintype" id="5503143">int</span><span class="op" id="5503146">,</span>&nbsp;<span class="builtintype" id="5503148">error</span><span class="op" id="5503153">)</span>&nbsp;<span class="op" id="5503155">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5503158">for</span>&nbsp;<span class="op" id="5503162">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5503166">n</span>&nbsp;<span class="op" id="5503168">:=</span>&nbsp;<span class="ident" id="5503171">bz2</span><span class="op" id="5503174">.</span><span class="ident" id="5503175">readFromBlock</span><span class="op" id="5503188">(</span><span class="ident" id="5503189">buf</span><span class="op" id="5503192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5503196">if</span>&nbsp;<span class="ident" id="5503199">n</span>&nbsp;<span class="op" id="5503201">&gt;</span>&nbsp;<span class="num" id="5503203">0</span>&nbsp;<span class="op" id="5503205">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5503210">bz2</span><span class="op" id="5503213">.</span><span class="ident" id="5503214">blockCRC</span>&nbsp;<span class="op" id="5503223">=</span>&nbsp;<span class="ident" id="5503225">updateCRC</span><span class="op" id="5503234">(</span><span class="ident" id="5503235">bz2</span><span class="op" id="5503238">.</span><span class="ident" id="5503239">blockCRC</span><span class="op" id="5503247">,</span>&nbsp;<span class="ident" id="5503249">buf</span><span class="op" id="5503252">[</span><span class="op" id="5503253">:</span><span class="ident" id="5503254">n</span><span class="op" id="5503255">]</span><span class="op" id="5503256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5503261">return</span>&nbsp;<span class="ident" id="5503268">n</span><span class="op" id="5503269">,</span>&nbsp;<span class="ident" id="5503271">nil</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5503277">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5503282">//&nbsp;End&nbsp;of&nbsp;block.&nbsp;Check&nbsp;CRC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5503312">if</span>&nbsp;<span class="ident" id="5503315">bz2</span><span class="op" id="5503318">.</span><span class="ident" id="5503319">blockCRC</span>&nbsp;<span class="op" id="5503328">!=</span>&nbsp;<span class="ident" id="5503331">bz2</span><span class="op" id="5503334">.</span><span class="ident" id="5503335">wantBlockCRC</span>&nbsp;<span class="op" id="5503348">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5503353">bz2</span><span class="op" id="5503356">.</span><span class="ident" id="5503357">br</span><span class="op" id="5503359">.</span><span class="ident" id="5503360">err</span>&nbsp;<span class="op" id="5503364">=</span>&nbsp;<span class="ident" id="5503366">StructuralError</span><span class="op" id="5503381">(</span><span class="string" id="5503382">&#34;block&nbsp;checksum&nbsp;mismatch&#34;</span><span class="op" id="5503407">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5503412">return</span>&nbsp;<span class="num" id="5503419">0</span><span class="op" id="5503420">,</span>&nbsp;<span class="ident" id="5503422">bz2</span><span class="op" id="5503425">.</span><span class="ident" id="5503426">br</span><span class="op" id="5503428">.</span><span class="ident" id="5503429">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5503435">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5503440">//&nbsp;Find&nbsp;next&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5503462">br</span>&nbsp;<span class="op" id="5503465">:=</span>&nbsp;<span class="op" id="5503468">&amp;</span><span class="ident" id="5503469">bz2</span><span class="op" id="5503472">.</span><span class="ident" id="5503473">br</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5503478">switch</span>&nbsp;<span class="ident" id="5503485">br</span><span class="op" id="5503487">.</span><span class="ident" id="5503488">ReadBits64</span><span class="op" id="5503498">(</span><span class="num" id="5503499">48</span><span class="op" id="5503501">)</span>&nbsp;<span class="op" id="5503503">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5503507">default</span><span class="op" id="5503514">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5503519">return</span>&nbsp;<span class="num" id="5503526">0</span><span class="op" id="5503527">,</span>&nbsp;<span class="ident" id="5503529">StructuralError</span><span class="op" id="5503544">(</span><span class="string" id="5503545">&#34;bad&nbsp;magic&nbsp;value&nbsp;found&#34;</span><span class="op" id="5503568">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5503573">case</span>&nbsp;<span class="ident" id="5503578">bzip2BlockMagic</span><span class="op" id="5503593">:</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5503598">//&nbsp;Start&nbsp;of&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5503620">err</span>&nbsp;<span class="op" id="5503624">:=</span>&nbsp;<span class="ident" id="5503627">bz2</span><span class="op" id="5503630">.</span><span class="ident" id="5503631">readBlock</span><span class="op" id="5503640">(</span><span class="op" id="5503641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5503646">if</span>&nbsp;<span class="ident" id="5503649">err</span>&nbsp;<span class="op" id="5503653">!=</span>&nbsp;<span class="ident" id="5503656">nil</span>&nbsp;<span class="op" id="5503660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5503666">return</span>&nbsp;<span class="num" id="5503673">0</span><span class="op" id="5503674">,</span>&nbsp;<span class="ident" id="5503676">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5503683">}</span><br>
<span class="lineno">190</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5503688">case</span>&nbsp;<span class="ident" id="5503693">bzip2FinalMagic</span><span class="op" id="5503708">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5503713">//&nbsp;Check&nbsp;end-of-file&nbsp;CRC.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5503742">wantFileCRC</span>&nbsp;<span class="op" id="5503754">:=</span>&nbsp;<span class="builtintype" id="5503757">uint32</span><span class="op" id="5503763">(</span><span class="ident" id="5503764">br</span><span class="op" id="5503766">.</span><span class="ident" id="5503767">ReadBits64</span><span class="op" id="5503777">(</span><span class="num" id="5503778">32</span><span class="op" id="5503780">)</span><span class="op" id="5503781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5503786">if</span>&nbsp;<span class="ident" id="5503789">br</span><span class="op" id="5503791">.</span><span class="ident" id="5503792">err</span>&nbsp;<span class="op" id="5503796">!=</span>&nbsp;<span class="ident" id="5503799">nil</span>&nbsp;<span class="op" id="5503803">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5503809">return</span>&nbsp;<span class="num" id="5503816">0</span><span class="op" id="5503817">,</span>&nbsp;<span class="ident" id="5503819">br</span><span class="op" id="5503821">.</span><span class="ident" id="5503822">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5503829">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5503834">if</span>&nbsp;<span class="ident" id="5503837">bz2</span><span class="op" id="5503840">.</span><span class="ident" id="5503841">fileCRC</span>&nbsp;<span class="op" id="5503849">!=</span>&nbsp;<span class="ident" id="5503852">wantFileCRC</span>&nbsp;<span class="op" id="5503864">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5503870">br</span><span class="op" id="5503872">.</span><span class="ident" id="5503873">err</span>&nbsp;<span class="op" id="5503877">=</span>&nbsp;<span class="ident" id="5503879">StructuralError</span><span class="op" id="5503894">(</span><span class="string" id="5503895">&#34;file&nbsp;checksum&nbsp;mismatch&#34;</span><span class="op" id="5503919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5503925">return</span>&nbsp;<span class="num" id="5503932">0</span><span class="op" id="5503933">,</span>&nbsp;<span class="ident" id="5503935">br</span><span class="op" id="5503937">.</span><span class="ident" id="5503938">err</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5503945">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5503951">//&nbsp;Skip&nbsp;ahead&nbsp;to&nbsp;byte&nbsp;boundary.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5503986">//&nbsp;Is&nbsp;there&nbsp;a&nbsp;file&nbsp;concatenated&nbsp;to&nbsp;this&nbsp;one?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5504034">//&nbsp;It&nbsp;would&nbsp;start&nbsp;with&nbsp;BZ.</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5504064">if</span>&nbsp;<span class="ident" id="5504067">br</span><span class="op" id="5504069">.</span><span class="ident" id="5504070">bits</span><span class="op" id="5504074">%</span><span class="num" id="5504075">8</span>&nbsp;<span class="op" id="5504077">!=</span>&nbsp;<span class="num" id="5504080">0</span>&nbsp;<span class="op" id="5504082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5504088">br</span><span class="op" id="5504090">.</span><span class="ident" id="5504091">ReadBits</span><span class="op" id="5504099">(</span><span class="ident" id="5504100">br</span><span class="op" id="5504102">.</span><span class="ident" id="5504103">bits</span>&nbsp;<span class="op" id="5504108">%</span>&nbsp;<span class="num" id="5504110">8</span><span class="op" id="5504111">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5504116">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5504121">b</span><span class="op" id="5504122">,</span>&nbsp;<span class="ident" id="5504124">err</span>&nbsp;<span class="op" id="5504128">:=</span>&nbsp;<span class="ident" id="5504131">br</span><span class="op" id="5504133">.</span><span class="ident" id="5504134">r</span><span class="op" id="5504135">.</span><span class="ident" id="5504136">ReadByte</span><span class="op" id="5504144">(</span><span class="op" id="5504145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5504150">if</span>&nbsp;<span class="ident" id="5504153">err</span>&nbsp;<span class="op" id="5504157">==</span>&nbsp;<span class="ident" id="5504160">io</span><span class="op" id="5504162">.</span><span class="ident" id="5504163">EOF</span>&nbsp;<span class="op" id="5504167">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5504173">br</span><span class="op" id="5504175">.</span><span class="ident" id="5504176">err</span>&nbsp;<span class="op" id="5504180">=</span>&nbsp;<span class="ident" id="5504182">io</span><span class="op" id="5504184">.</span><span class="ident" id="5504185">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5504193">bz2</span><span class="op" id="5504196">.</span><span class="ident" id="5504197">eof</span>&nbsp;<span class="op" id="5504201">=</span>&nbsp;<span class="builtintype" id="5504203">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5504212">return</span>&nbsp;<span class="num" id="5504219">0</span><span class="op" id="5504220">,</span>&nbsp;<span class="ident" id="5504222">io</span><span class="op" id="5504224">.</span><span class="ident" id="5504225">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5504232">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5504237">if</span>&nbsp;<span class="ident" id="5504240">err</span>&nbsp;<span class="op" id="5504244">!=</span>&nbsp;<span class="ident" id="5504247">nil</span>&nbsp;<span class="op" id="5504251">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5504257">br</span><span class="op" id="5504259">.</span><span class="ident" id="5504260">err</span>&nbsp;<span class="op" id="5504264">=</span>&nbsp;<span class="ident" id="5504266">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5504274">return</span>&nbsp;<span class="num" id="5504281">0</span><span class="op" id="5504282">,</span>&nbsp;<span class="ident" id="5504284">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5504291">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5504296">z</span><span class="op" id="5504297">,</span>&nbsp;<span class="ident" id="5504299">err</span>&nbsp;<span class="op" id="5504303">:=</span>&nbsp;<span class="ident" id="5504306">br</span><span class="op" id="5504308">.</span><span class="ident" id="5504309">r</span><span class="op" id="5504310">.</span><span class="ident" id="5504311">ReadByte</span><span class="op" id="5504319">(</span><span class="op" id="5504320">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5504325">if</span>&nbsp;<span class="ident" id="5504328">err</span>&nbsp;<span class="op" id="5504332">!=</span>&nbsp;<span class="ident" id="5504335">nil</span>&nbsp;<span class="op" id="5504339">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5504345">if</span>&nbsp;<span class="ident" id="5504348">err</span>&nbsp;<span class="op" id="5504352">==</span>&nbsp;<span class="ident" id="5504355">io</span><span class="op" id="5504357">.</span><span class="ident" id="5504358">EOF</span>&nbsp;<span class="op" id="5504362">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5504369">err</span>&nbsp;<span class="op" id="5504373">=</span>&nbsp;<span class="ident" id="5504375">io</span><span class="op" id="5504377">.</span><span class="ident" id="5504378">ErrUnexpectedEOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5504399">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5504405">br</span><span class="op" id="5504407">.</span><span class="ident" id="5504408">err</span>&nbsp;<span class="op" id="5504412">=</span>&nbsp;<span class="ident" id="5504414">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5504422">return</span>&nbsp;<span class="num" id="5504429">0</span><span class="op" id="5504430">,</span>&nbsp;<span class="ident" id="5504432">err</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5504439">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5504444">if</span>&nbsp;<span class="ident" id="5504447">b</span>&nbsp;<span class="op" id="5504449">!=</span>&nbsp;<span class="string" id="5504452">&#39;B&#39;</span>&nbsp;<span class="op" id="5504456">||</span>&nbsp;<span class="ident" id="5504459">z</span>&nbsp;<span class="op" id="5504461">!=</span>&nbsp;<span class="string" id="5504464">&#39;Z&#39;</span>&nbsp;<span class="op" id="5504468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5504474">return</span>&nbsp;<span class="num" id="5504481">0</span><span class="op" id="5504482">,</span>&nbsp;<span class="ident" id="5504484">StructuralError</span><span class="op" id="5504499">(</span><span class="string" id="5504500">&#34;bad&nbsp;magic&nbsp;value&nbsp;in&nbsp;continuation&nbsp;file&#34;</span><span class="op" id="5504538">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5504543">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5504548">if</span>&nbsp;<span class="ident" id="5504551">err</span>&nbsp;<span class="op" id="5504555">:=</span>&nbsp;<span class="ident" id="5504558">bz2</span><span class="op" id="5504561">.</span><span class="ident" id="5504562">setup</span><span class="op" id="5504567">(</span><span class="builtintype" id="5504568">false</span><span class="op" id="5504573">)</span><span class="op" id="5504574">;</span>&nbsp;<span class="ident" id="5504576">err</span>&nbsp;<span class="op" id="5504580">!=</span>&nbsp;<span class="ident" id="5504583">nil</span>&nbsp;<span class="op" id="5504587">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5504593">return</span>&nbsp;<span class="num" id="5504600">0</span><span class="op" id="5504601">,</span>&nbsp;<span class="ident" id="5504603">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5504610">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5504614">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5504617">}</span><br>
<span class="lineno"></span><span class="op" id="5504619">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span><span class="comment" id="5504622">//&nbsp;readBlock&nbsp;reads&nbsp;a&nbsp;bzip2&nbsp;block.&nbsp;The&nbsp;magic&nbsp;number&nbsp;should&nbsp;already&nbsp;have&nbsp;been&nbsp;consumed.</span><br>
<span class="lineno"></span><span class="keyword" id="5504708">func</span>&nbsp;<span class="op" id="5504713">(</span><span class="ident" id="5504714">bz2</span>&nbsp;<span class="op" id="5504718">*</span><span class="ident" id="5504719">reader</span><span class="op" id="5504725">)</span>&nbsp;<span class="ident" id="5504727">readBlock</span><span class="op" id="5504736">(</span><span class="op" id="5504737">)</span>&nbsp;<span class="op" id="5504739">(</span><span class="ident" id="5504740">err</span>&nbsp;<span class="builtintype" id="5504744">error</span><span class="op" id="5504749">)</span>&nbsp;<span class="op" id="5504751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5504754">br</span>&nbsp;<span class="op" id="5504757">:=</span>&nbsp;<span class="op" id="5504760">&amp;</span><span class="ident" id="5504761">bz2</span><span class="op" id="5504764">.</span><span class="ident" id="5504765">br</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5504769">bz2</span><span class="op" id="5504772">.</span><span class="ident" id="5504773">wantBlockCRC</span>&nbsp;<span class="op" id="5504786">=</span>&nbsp;<span class="builtintype" id="5504788">uint32</span><span class="op" id="5504794">(</span><span class="ident" id="5504795">br</span><span class="op" id="5504797">.</span><span class="ident" id="5504798">ReadBits64</span><span class="op" id="5504808">(</span><span class="num" id="5504809">32</span><span class="op" id="5504811">)</span><span class="op" id="5504812">)</span>&nbsp;<span class="comment" id="5504814">//&nbsp;skip&nbsp;checksum.&nbsp;TODO:&nbsp;check&nbsp;it&nbsp;if&nbsp;we&nbsp;can&nbsp;figure&nbsp;out&nbsp;what&nbsp;it&nbsp;is.</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5504881">bz2</span><span class="op" id="5504884">.</span><span class="ident" id="5504885">blockCRC</span>&nbsp;<span class="op" id="5504894">=</span>&nbsp;<span class="num" id="5504896">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5504899">bz2</span><span class="op" id="5504902">.</span><span class="ident" id="5504903">fileCRC</span>&nbsp;<span class="op" id="5504911">=</span>&nbsp;<span class="op" id="5504913">(</span><span class="ident" id="5504914">bz2</span><span class="op" id="5504917">.</span><span class="ident" id="5504918">fileCRC</span><span class="op" id="5504925">&lt;&lt;</span><span class="num" id="5504927">1</span>&nbsp;<span class="op" id="5504929">|</span>&nbsp;<span class="ident" id="5504931">bz2</span><span class="op" id="5504934">.</span><span class="ident" id="5504935">fileCRC</span><span class="op" id="5504942">&gt;&gt;</span><span class="num" id="5504944">31</span><span class="op" id="5504946">)</span>&nbsp;<span class="op" id="5504948">^</span>&nbsp;<span class="ident" id="5504950">bz2</span><span class="op" id="5504953">.</span><span class="ident" id="5504954">wantBlockCRC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5504968">randomized</span>&nbsp;<span class="op" id="5504979">:=</span>&nbsp;<span class="ident" id="5504982">br</span><span class="op" id="5504984">.</span><span class="ident" id="5504985">ReadBits</span><span class="op" id="5504993">(</span><span class="num" id="5504994">1</span><span class="op" id="5504995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5504998">if</span>&nbsp;<span class="ident" id="5505001">randomized</span>&nbsp;<span class="op" id="5505012">!=</span>&nbsp;<span class="num" id="5505015">0</span>&nbsp;<span class="op" id="5505017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5505021">return</span>&nbsp;<span class="ident" id="5505028">StructuralError</span><span class="op" id="5505043">(</span><span class="string" id="5505044">&#34;deprecated&nbsp;randomized&nbsp;files&#34;</span><span class="op" id="5505073">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5505076">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5505079">origPtr</span>&nbsp;<span class="op" id="5505087">:=</span>&nbsp;<span class="builtintype" id="5505090">uint</span><span class="op" id="5505094">(</span><span class="ident" id="5505095">br</span><span class="op" id="5505097">.</span><span class="ident" id="5505098">ReadBits</span><span class="op" id="5505106">(</span><span class="num" id="5505107">24</span><span class="op" id="5505109">)</span><span class="op" id="5505110">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5505114">//&nbsp;If&nbsp;not&nbsp;every&nbsp;byte&nbsp;value&nbsp;is&nbsp;used&nbsp;in&nbsp;the&nbsp;block&nbsp;(i.e.,&nbsp;it&#39;s&nbsp;text)&nbsp;then</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5505186">//&nbsp;the&nbsp;symbol&nbsp;set&nbsp;is&nbsp;reduced.&nbsp;The&nbsp;symbols&nbsp;used&nbsp;are&nbsp;stored&nbsp;as&nbsp;a</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5505250">//&nbsp;two-level,&nbsp;16x16&nbsp;bitmap.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5505279">symbolRangeUsedBitmap</span>&nbsp;<span class="op" id="5505301">:=</span>&nbsp;<span class="ident" id="5505304">br</span><span class="op" id="5505306">.</span><span class="ident" id="5505307">ReadBits</span><span class="op" id="5505315">(</span><span class="num" id="5505316">16</span><span class="op" id="5505318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5505321">symbolPresent</span>&nbsp;<span class="op" id="5505335">:=</span>&nbsp;<span class="builtinfunc" id="5505338">make</span><span class="op" id="5505342">(</span><span class="op" id="5505343">[</span><span class="op" id="5505344">]</span><span class="builtintype" id="5505345">bool</span><span class="op" id="5505349">,</span>&nbsp;<span class="num" id="5505351">256</span><span class="op" id="5505354">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5505357">numSymbols</span>&nbsp;<span class="op" id="5505368">:=</span>&nbsp;<span class="num" id="5505371">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5505374">for</span>&nbsp;<span class="ident" id="5505378">symRange</span>&nbsp;<span class="op" id="5505387">:=</span>&nbsp;<span class="builtintype" id="5505390">uint</span><span class="op" id="5505394">(</span><span class="num" id="5505395">0</span><span class="op" id="5505396">)</span><span class="op" id="5505397">;</span>&nbsp;<span class="ident" id="5505399">symRange</span>&nbsp;<span class="op" id="5505408">&lt;</span>&nbsp;<span class="num" id="5505410">16</span><span class="op" id="5505412">;</span>&nbsp;<span class="ident" id="5505414">symRange</span><span class="op" id="5505422">++</span>&nbsp;<span class="op" id="5505425">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5505429">if</span>&nbsp;<span class="ident" id="5505432">symbolRangeUsedBitmap</span><span class="op" id="5505453">&amp;</span><span class="op" id="5505454">(</span><span class="num" id="5505455">1</span><span class="op" id="5505456">&lt;&lt;</span><span class="op" id="5505458">(</span><span class="num" id="5505459">15</span><span class="op" id="5505461">-</span><span class="ident" id="5505462">symRange</span><span class="op" id="5505470">)</span><span class="op" id="5505471">)</span>&nbsp;<span class="op" id="5505473">!=</span>&nbsp;<span class="num" id="5505476">0</span>&nbsp;<span class="op" id="5505478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5505483">bits</span>&nbsp;<span class="op" id="5505488">:=</span>&nbsp;<span class="ident" id="5505491">br</span><span class="op" id="5505493">.</span><span class="ident" id="5505494">ReadBits</span><span class="op" id="5505502">(</span><span class="num" id="5505503">16</span><span class="op" id="5505505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5505510">for</span>&nbsp;<span class="ident" id="5505514">symbol</span>&nbsp;<span class="op" id="5505521">:=</span>&nbsp;<span class="builtintype" id="5505524">uint</span><span class="op" id="5505528">(</span><span class="num" id="5505529">0</span><span class="op" id="5505530">)</span><span class="op" id="5505531">;</span>&nbsp;<span class="ident" id="5505533">symbol</span>&nbsp;<span class="op" id="5505540">&lt;</span>&nbsp;<span class="num" id="5505542">16</span><span class="op" id="5505544">;</span>&nbsp;<span class="ident" id="5505546">symbol</span><span class="op" id="5505552">++</span>&nbsp;<span class="op" id="5505555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5505561">if</span>&nbsp;<span class="ident" id="5505564">bits</span><span class="op" id="5505568">&amp;</span><span class="op" id="5505569">(</span><span class="num" id="5505570">1</span><span class="op" id="5505571">&lt;&lt;</span><span class="op" id="5505573">(</span><span class="num" id="5505574">15</span><span class="op" id="5505576">-</span><span class="ident" id="5505577">symbol</span><span class="op" id="5505583">)</span><span class="op" id="5505584">)</span>&nbsp;<span class="op" id="5505586">!=</span>&nbsp;<span class="num" id="5505589">0</span>&nbsp;<span class="op" id="5505591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5505598">symbolPresent</span><span class="op" id="5505611">[</span><span class="num" id="5505612">16</span><span class="op" id="5505614">*</span><span class="ident" id="5505615">symRange</span><span class="op" id="5505623">+</span><span class="ident" id="5505624">symbol</span><span class="op" id="5505630">]</span>&nbsp;<span class="op" id="5505632">=</span>&nbsp;<span class="builtintype" id="5505634">true</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5505644">numSymbols</span><span class="op" id="5505654">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5505661">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5505666">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5505670">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5505673">}</span><br>
<span class="lineno">265</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5505677">if</span>&nbsp;<span class="ident" id="5505680">numSymbols</span>&nbsp;<span class="op" id="5505691">==</span>&nbsp;<span class="num" id="5505694">0</span>&nbsp;<span class="op" id="5505696">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5505700">//&nbsp;There&nbsp;must&nbsp;be&nbsp;an&nbsp;EOF&nbsp;symbol.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5505734">return</span>&nbsp;<span class="ident" id="5505741">StructuralError</span><span class="op" id="5505756">(</span><span class="string" id="5505757">&#34;no&nbsp;symbols&nbsp;in&nbsp;input&#34;</span><span class="op" id="5505778">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5505781">}</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5505785">//&nbsp;A&nbsp;block&nbsp;uses&nbsp;between&nbsp;two&nbsp;and&nbsp;six&nbsp;different&nbsp;Huffman&nbsp;trees.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5505847">numHuffmanTrees</span>&nbsp;<span class="op" id="5505863">:=</span>&nbsp;<span class="ident" id="5505866">br</span><span class="op" id="5505868">.</span><span class="ident" id="5505869">ReadBits</span><span class="op" id="5505877">(</span><span class="num" id="5505878">3</span><span class="op" id="5505879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5505882">if</span>&nbsp;<span class="ident" id="5505885">numHuffmanTrees</span>&nbsp;<span class="op" id="5505901">&lt;</span>&nbsp;<span class="num" id="5505903">2</span>&nbsp;<span class="op" id="5505905">||</span>&nbsp;<span class="ident" id="5505908">numHuffmanTrees</span>&nbsp;<span class="op" id="5505924">&gt;</span>&nbsp;<span class="num" id="5505926">6</span>&nbsp;<span class="op" id="5505928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5505932">return</span>&nbsp;<span class="ident" id="5505939">StructuralError</span><span class="op" id="5505954">(</span><span class="string" id="5505955">&#34;invalid&nbsp;number&nbsp;of&nbsp;Huffman&nbsp;trees&#34;</span><span class="op" id="5505988">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5505991">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5505995">//&nbsp;The&nbsp;Huffman&nbsp;tree&nbsp;can&nbsp;switch&nbsp;every&nbsp;50&nbsp;symbols&nbsp;so&nbsp;there&#39;s&nbsp;a&nbsp;list&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5506065">//&nbsp;tree&nbsp;indexes&nbsp;telling&nbsp;us&nbsp;which&nbsp;tree&nbsp;to&nbsp;use&nbsp;for&nbsp;each&nbsp;50&nbsp;symbol&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5506137">numSelectors</span>&nbsp;<span class="op" id="5506150">:=</span>&nbsp;<span class="ident" id="5506153">br</span><span class="op" id="5506155">.</span><span class="ident" id="5506156">ReadBits</span><span class="op" id="5506164">(</span><span class="num" id="5506165">15</span><span class="op" id="5506167">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5506170">treeIndexes</span>&nbsp;<span class="op" id="5506182">:=</span>&nbsp;<span class="builtinfunc" id="5506185">make</span><span class="op" id="5506189">(</span><span class="op" id="5506190">[</span><span class="op" id="5506191">]</span><span class="builtintype" id="5506192">uint8</span><span class="op" id="5506197">,</span>&nbsp;<span class="ident" id="5506199">numSelectors</span><span class="op" id="5506211">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5506215">//&nbsp;The&nbsp;tree&nbsp;indexes&nbsp;are&nbsp;move-to-front&nbsp;transformed&nbsp;and&nbsp;stored&nbsp;as&nbsp;unary</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5506286">//&nbsp;numbers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5506299">mtfTreeDecoder</span>&nbsp;<span class="op" id="5506314">:=</span>&nbsp;<span class="ident" id="5506317">newMTFDecoderWithRange</span><span class="op" id="5506339">(</span><span class="ident" id="5506340">numHuffmanTrees</span><span class="op" id="5506355">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5506358">for</span>&nbsp;<span class="ident" id="5506362">i</span>&nbsp;<span class="op" id="5506364">:=</span>&nbsp;<span class="keyword" id="5506367">range</span>&nbsp;<span class="ident" id="5506373">treeIndexes</span>&nbsp;<span class="op" id="5506385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5506389">c</span>&nbsp;<span class="op" id="5506391">:=</span>&nbsp;<span class="num" id="5506394">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5506398">for</span>&nbsp;<span class="op" id="5506402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5506407">inc</span>&nbsp;<span class="op" id="5506411">:=</span>&nbsp;<span class="ident" id="5506414">br</span><span class="op" id="5506416">.</span><span class="ident" id="5506417">ReadBits</span><span class="op" id="5506425">(</span><span class="num" id="5506426">1</span><span class="op" id="5506427">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5506432">if</span>&nbsp;<span class="ident" id="5506435">inc</span>&nbsp;<span class="op" id="5506439">==</span>&nbsp;<span class="num" id="5506442">0</span>&nbsp;<span class="op" id="5506444">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5506450">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5506459">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5506464">c</span><span class="op" id="5506465">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5506470">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5506474">if</span>&nbsp;<span class="ident" id="5506477">c</span>&nbsp;<span class="op" id="5506479">&gt;=</span>&nbsp;<span class="ident" id="5506482">numHuffmanTrees</span>&nbsp;<span class="op" id="5506498">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5506503">return</span>&nbsp;<span class="ident" id="5506510">StructuralError</span><span class="op" id="5506525">(</span><span class="string" id="5506526">&#34;tree&nbsp;index&nbsp;too&nbsp;large&#34;</span><span class="op" id="5506548">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5506552">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5506556">treeIndexes</span><span class="op" id="5506567">[</span><span class="ident" id="5506568">i</span><span class="op" id="5506569">]</span>&nbsp;<span class="op" id="5506571">=</span>&nbsp;<span class="builtintype" id="5506573">uint8</span><span class="op" id="5506578">(</span><span class="ident" id="5506579">mtfTreeDecoder</span><span class="op" id="5506593">.</span><span class="ident" id="5506594">Decode</span><span class="op" id="5506600">(</span><span class="ident" id="5506601">c</span><span class="op" id="5506602">)</span><span class="op" id="5506603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5506606">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5506610">//&nbsp;The&nbsp;list&nbsp;of&nbsp;symbols&nbsp;for&nbsp;the&nbsp;move-to-front&nbsp;transform&nbsp;is&nbsp;taken&nbsp;from</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5506680">//&nbsp;the&nbsp;previously&nbsp;decoded&nbsp;symbol&nbsp;bitmap.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5506722">symbols</span>&nbsp;<span class="op" id="5506730">:=</span>&nbsp;<span class="builtinfunc" id="5506733">make</span><span class="op" id="5506737">(</span><span class="op" id="5506738">[</span><span class="op" id="5506739">]</span><span class="builtintype" id="5506740">byte</span><span class="op" id="5506744">,</span>&nbsp;<span class="ident" id="5506746">numSymbols</span><span class="op" id="5506756">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5506759">nextSymbol</span>&nbsp;<span class="op" id="5506770">:=</span>&nbsp;<span class="num" id="5506773">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5506776">for</span>&nbsp;<span class="ident" id="5506780">i</span>&nbsp;<span class="op" id="5506782">:=</span>&nbsp;<span class="num" id="5506785">0</span><span class="op" id="5506786">;</span>&nbsp;<span class="ident" id="5506788">i</span>&nbsp;<span class="op" id="5506790">&lt;</span>&nbsp;<span class="num" id="5506792">256</span><span class="op" id="5506795">;</span>&nbsp;<span class="ident" id="5506797">i</span><span class="op" id="5506798">++</span>&nbsp;<span class="op" id="5506801">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5506805">if</span>&nbsp;<span class="ident" id="5506808">symbolPresent</span><span class="op" id="5506821">[</span><span class="ident" id="5506822">i</span><span class="op" id="5506823">]</span>&nbsp;<span class="op" id="5506825">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5506830">symbols</span><span class="op" id="5506837">[</span><span class="ident" id="5506838">nextSymbol</span><span class="op" id="5506848">]</span>&nbsp;<span class="op" id="5506850">=</span>&nbsp;<span class="builtintype" id="5506852">byte</span><span class="op" id="5506856">(</span><span class="ident" id="5506857">i</span><span class="op" id="5506858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5506863">nextSymbol</span><span class="op" id="5506873">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5506878">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5506881">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5506884">mtf</span>&nbsp;<span class="op" id="5506888">:=</span>&nbsp;<span class="ident" id="5506891">newMTFDecoder</span><span class="op" id="5506904">(</span><span class="ident" id="5506905">symbols</span><span class="op" id="5506912">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5506916">numSymbols</span>&nbsp;<span class="op" id="5506927">+=</span>&nbsp;<span class="num" id="5506930">2</span>&nbsp;<span class="comment" id="5506932">//&nbsp;to&nbsp;account&nbsp;for&nbsp;RUNA&nbsp;and&nbsp;RUNB&nbsp;symbols</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5506973">huffmanTrees</span>&nbsp;<span class="op" id="5506986">:=</span>&nbsp;<span class="builtinfunc" id="5506989">make</span><span class="op" id="5506993">(</span><span class="op" id="5506994">[</span><span class="op" id="5506995">]</span><span class="ident" id="5506996">huffmanTree</span><span class="op" id="5507007">,</span>&nbsp;<span class="ident" id="5507009">numHuffmanTrees</span><span class="op" id="5507024">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5507028">//&nbsp;Now&nbsp;we&nbsp;decode&nbsp;the&nbsp;arrays&nbsp;of&nbsp;code-lengths&nbsp;for&nbsp;each&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5507088">lengths</span>&nbsp;<span class="op" id="5507096">:=</span>&nbsp;<span class="builtinfunc" id="5507099">make</span><span class="op" id="5507103">(</span><span class="op" id="5507104">[</span><span class="op" id="5507105">]</span><span class="builtintype" id="5507106">uint8</span><span class="op" id="5507111">,</span>&nbsp;<span class="ident" id="5507113">numSymbols</span><span class="op" id="5507123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5507126">for</span>&nbsp;<span class="ident" id="5507130">i</span>&nbsp;<span class="op" id="5507132">:=</span>&nbsp;<span class="keyword" id="5507135">range</span>&nbsp;<span class="ident" id="5507141">huffmanTrees</span>&nbsp;<span class="op" id="5507154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5507158">//&nbsp;The&nbsp;code&nbsp;lengths&nbsp;are&nbsp;delta&nbsp;encoded&nbsp;from&nbsp;a&nbsp;5-bit&nbsp;base&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5507223">length</span>&nbsp;<span class="op" id="5507230">:=</span>&nbsp;<span class="ident" id="5507233">br</span><span class="op" id="5507235">.</span><span class="ident" id="5507236">ReadBits</span><span class="op" id="5507244">(</span><span class="num" id="5507245">5</span><span class="op" id="5507246">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5507250">for</span>&nbsp;<span class="ident" id="5507254">j</span>&nbsp;<span class="op" id="5507256">:=</span>&nbsp;<span class="keyword" id="5507259">range</span>&nbsp;<span class="ident" id="5507265">lengths</span>&nbsp;<span class="op" id="5507273">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5507278">for</span>&nbsp;<span class="op" id="5507282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5507288">if</span>&nbsp;<span class="op" id="5507291">!</span><span class="ident" id="5507292">br</span><span class="op" id="5507294">.</span><span class="ident" id="5507295">ReadBit</span><span class="op" id="5507302">(</span><span class="op" id="5507303">)</span>&nbsp;<span class="op" id="5507305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5507312">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5507322">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5507328">if</span>&nbsp;<span class="ident" id="5507331">br</span><span class="op" id="5507333">.</span><span class="ident" id="5507334">ReadBit</span><span class="op" id="5507341">(</span><span class="op" id="5507342">)</span>&nbsp;<span class="op" id="5507344">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5507351">length</span><span class="op" id="5507357">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5507364">}</span>&nbsp;<span class="keyword" id="5507366">else</span>&nbsp;<span class="op" id="5507371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5507378">length</span><span class="op" id="5507384">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5507391">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5507396">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5507401">if</span>&nbsp;<span class="ident" id="5507404">length</span>&nbsp;<span class="op" id="5507411">&lt;</span>&nbsp;<span class="num" id="5507413">0</span>&nbsp;<span class="op" id="5507415">||</span>&nbsp;<span class="ident" id="5507418">length</span>&nbsp;<span class="op" id="5507425">&gt;</span>&nbsp;<span class="num" id="5507427">20</span>&nbsp;<span class="op" id="5507430">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5507436">return</span>&nbsp;<span class="ident" id="5507443">StructuralError</span><span class="op" id="5507458">(</span><span class="string" id="5507459">&#34;Huffman&nbsp;length&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="5507488">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5507493">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5507498">lengths</span><span class="op" id="5507505">[</span><span class="ident" id="5507506">j</span><span class="op" id="5507507">]</span>&nbsp;<span class="op" id="5507509">=</span>&nbsp;<span class="builtintype" id="5507511">uint8</span><span class="op" id="5507516">(</span><span class="ident" id="5507517">length</span><span class="op" id="5507523">)</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5507527">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5507531">huffmanTrees</span><span class="op" id="5507543">[</span><span class="ident" id="5507544">i</span><span class="op" id="5507545">]</span><span class="op" id="5507546">,</span>&nbsp;<span class="ident" id="5507548">err</span>&nbsp;<span class="op" id="5507552">=</span>&nbsp;<span class="ident" id="5507554">newHuffmanTree</span><span class="op" id="5507568">(</span><span class="ident" id="5507569">lengths</span><span class="op" id="5507576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5507580">if</span>&nbsp;<span class="ident" id="5507583">err</span>&nbsp;<span class="op" id="5507587">!=</span>&nbsp;<span class="ident" id="5507590">nil</span>&nbsp;<span class="op" id="5507594">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5507599">return</span>&nbsp;<span class="ident" id="5507606">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5507612">}</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5507615">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5507619">selectorIndex</span>&nbsp;<span class="op" id="5507633">:=</span>&nbsp;<span class="num" id="5507636">1</span>&nbsp;<span class="comment" id="5507638">//&nbsp;the&nbsp;next&nbsp;tree&nbsp;index&nbsp;to&nbsp;use</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5507669">if</span>&nbsp;<span class="builtinfunc" id="5507672">len</span><span class="op" id="5507675">(</span><span class="ident" id="5507676">treeIndexes</span><span class="op" id="5507687">)</span>&nbsp;<span class="op" id="5507689">==</span>&nbsp;<span class="num" id="5507692">0</span>&nbsp;<span class="op" id="5507694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5507698">return</span>&nbsp;<span class="ident" id="5507705">StructuralError</span><span class="op" id="5507720">(</span><span class="string" id="5507721">&#34;no&nbsp;tree&nbsp;selectors&nbsp;given&#34;</span><span class="op" id="5507746">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5507749">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5507752">if</span>&nbsp;<span class="builtintype" id="5507755">int</span><span class="op" id="5507758">(</span><span class="ident" id="5507759">treeIndexes</span><span class="op" id="5507770">[</span><span class="num" id="5507771">0</span><span class="op" id="5507772">]</span><span class="op" id="5507773">)</span>&nbsp;<span class="op" id="5507775">&gt;=</span>&nbsp;<span class="builtinfunc" id="5507778">len</span><span class="op" id="5507781">(</span><span class="ident" id="5507782">huffmanTrees</span><span class="op" id="5507794">)</span>&nbsp;<span class="op" id="5507796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5507800">return</span>&nbsp;<span class="ident" id="5507807">StructuralError</span><span class="op" id="5507822">(</span><span class="string" id="5507823">&#34;tree&nbsp;selector&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="5507851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5507854">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5507857">currentHuffmanTree</span>&nbsp;<span class="op" id="5507876">:=</span>&nbsp;<span class="ident" id="5507879">huffmanTrees</span><span class="op" id="5507891">[</span><span class="ident" id="5507892">treeIndexes</span><span class="op" id="5507903">[</span><span class="num" id="5507904">0</span><span class="op" id="5507905">]</span><span class="op" id="5507906">]</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5507909">bufIndex</span>&nbsp;<span class="op" id="5507918">:=</span>&nbsp;<span class="num" id="5507921">0</span>&nbsp;<span class="comment" id="5507923">//&nbsp;indexes&nbsp;bz2.buf,&nbsp;the&nbsp;output&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5507963">//&nbsp;The&nbsp;output&nbsp;of&nbsp;the&nbsp;move-to-front&nbsp;transform&nbsp;is&nbsp;run-length&nbsp;encoded&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5508035">//&nbsp;we&nbsp;merge&nbsp;the&nbsp;decoding&nbsp;into&nbsp;the&nbsp;Huffman&nbsp;parsing&nbsp;loop.&nbsp;These&nbsp;two</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5508102">//&nbsp;variables&nbsp;accumulate&nbsp;the&nbsp;repeat&nbsp;count.&nbsp;See&nbsp;the&nbsp;Wikipedia&nbsp;page&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5508172">//&nbsp;details.</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5508185">repeat</span>&nbsp;<span class="op" id="5508192">:=</span>&nbsp;<span class="num" id="5508195">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5508198">repeat_power</span>&nbsp;<span class="op" id="5508211">:=</span>&nbsp;<span class="num" id="5508214">0</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5508218">//&nbsp;The&nbsp;`C&#39;&nbsp;array&nbsp;(used&nbsp;by&nbsp;the&nbsp;inverse&nbsp;BWT)&nbsp;needs&nbsp;to&nbsp;be&nbsp;zero&nbsp;initialized.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5508292">for</span>&nbsp;<span class="ident" id="5508296">i</span>&nbsp;<span class="op" id="5508298">:=</span>&nbsp;<span class="keyword" id="5508301">range</span>&nbsp;<span class="ident" id="5508307">bz2</span><span class="op" id="5508310">.</span><span class="ident" id="5508311">c</span>&nbsp;<span class="op" id="5508313">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5508317">bz2</span><span class="op" id="5508320">.</span><span class="ident" id="5508321">c</span><span class="op" id="5508322">[</span><span class="ident" id="5508323">i</span><span class="op" id="5508324">]</span>&nbsp;<span class="op" id="5508326">=</span>&nbsp;<span class="num" id="5508328">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5508331">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5508335">decoded</span>&nbsp;<span class="op" id="5508343">:=</span>&nbsp;<span class="num" id="5508346">0</span>&nbsp;<span class="comment" id="5508348">//&nbsp;counts&nbsp;the&nbsp;number&nbsp;of&nbsp;symbols&nbsp;decoded&nbsp;by&nbsp;the&nbsp;current&nbsp;tree.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5508410">for</span>&nbsp;<span class="op" id="5508414">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5508418">if</span>&nbsp;<span class="ident" id="5508421">decoded</span>&nbsp;<span class="op" id="5508429">==</span>&nbsp;<span class="num" id="5508432">50</span>&nbsp;<span class="op" id="5508435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5508440">if</span>&nbsp;<span class="ident" id="5508443">selectorIndex</span>&nbsp;<span class="op" id="5508457">&gt;=</span>&nbsp;<span class="ident" id="5508460">numSelectors</span>&nbsp;<span class="op" id="5508473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5508479">return</span>&nbsp;<span class="ident" id="5508486">StructuralError</span><span class="op" id="5508501">(</span><span class="string" id="5508502">&#34;insufficient&nbsp;selector&nbsp;indices&nbsp;for&nbsp;number&nbsp;of&nbsp;symbols&#34;</span><span class="op" id="5508555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5508560">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5508565">if</span>&nbsp;<span class="builtintype" id="5508568">int</span><span class="op" id="5508571">(</span><span class="ident" id="5508572">treeIndexes</span><span class="op" id="5508583">[</span><span class="ident" id="5508584">selectorIndex</span><span class="op" id="5508597">]</span><span class="op" id="5508598">)</span>&nbsp;<span class="op" id="5508600">&gt;=</span>&nbsp;<span class="builtinfunc" id="5508603">len</span><span class="op" id="5508606">(</span><span class="ident" id="5508607">huffmanTrees</span><span class="op" id="5508619">)</span>&nbsp;<span class="op" id="5508621">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5508627">return</span>&nbsp;<span class="ident" id="5508634">StructuralError</span><span class="op" id="5508649">(</span><span class="string" id="5508650">&#34;tree&nbsp;selector&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="5508678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5508683">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5508688">currentHuffmanTree</span>&nbsp;<span class="op" id="5508707">=</span>&nbsp;<span class="ident" id="5508709">huffmanTrees</span><span class="op" id="5508721">[</span><span class="ident" id="5508722">treeIndexes</span><span class="op" id="5508733">[</span><span class="ident" id="5508734">selectorIndex</span><span class="op" id="5508747">]</span><span class="op" id="5508748">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5508753">selectorIndex</span><span class="op" id="5508766">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5508772">decoded</span>&nbsp;<span class="op" id="5508780">=</span>&nbsp;<span class="num" id="5508782">0</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5508786">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5508791">v</span>&nbsp;<span class="op" id="5508793">:=</span>&nbsp;<span class="ident" id="5508796">currentHuffmanTree</span><span class="op" id="5508814">.</span><span class="ident" id="5508815">Decode</span><span class="op" id="5508821">(</span><span class="ident" id="5508822">br</span><span class="op" id="5508824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5508828">decoded</span><span class="op" id="5508835">++</span><br>
<span class="lineno"></span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5508841">if</span>&nbsp;<span class="ident" id="5508844">v</span>&nbsp;<span class="op" id="5508846">&lt;</span>&nbsp;<span class="num" id="5508848">2</span>&nbsp;<span class="op" id="5508850">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5508855">//&nbsp;This&nbsp;is&nbsp;either&nbsp;the&nbsp;RUNA&nbsp;or&nbsp;RUNB&nbsp;symbol.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5508901">if</span>&nbsp;<span class="ident" id="5508904">repeat</span>&nbsp;<span class="op" id="5508911">==</span>&nbsp;<span class="num" id="5508914">0</span>&nbsp;<span class="op" id="5508916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5508922">repeat_power</span>&nbsp;<span class="op" id="5508935">=</span>&nbsp;<span class="num" id="5508937">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5508942">}</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5508947">repeat</span>&nbsp;<span class="op" id="5508954">+=</span>&nbsp;<span class="ident" id="5508957">repeat_power</span>&nbsp;<span class="op" id="5508970">&lt;&lt;</span>&nbsp;<span class="ident" id="5508973">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5508978">repeat_power</span>&nbsp;<span class="op" id="5508991">&lt;&lt;=</span>&nbsp;<span class="num" id="5508995">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5509001">//&nbsp;This&nbsp;limit&nbsp;of&nbsp;2&nbsp;million&nbsp;comes&nbsp;from&nbsp;the&nbsp;bzip2&nbsp;source</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5509059">//&nbsp;code.&nbsp;It&nbsp;prevents&nbsp;repeat&nbsp;from&nbsp;overflowing.</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5509108">if</span>&nbsp;<span class="ident" id="5509111">repeat</span>&nbsp;<span class="op" id="5509118">&gt;</span>&nbsp;<span class="num" id="5509120">2</span><span class="op" id="5509121">*</span><span class="num" id="5509122">1024</span><span class="op" id="5509126">*</span><span class="num" id="5509127">1024</span>&nbsp;<span class="op" id="5509132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5509138">return</span>&nbsp;<span class="ident" id="5509145">StructuralError</span><span class="op" id="5509160">(</span><span class="string" id="5509161">&#34;repeat&nbsp;count&nbsp;too&nbsp;large&#34;</span><span class="op" id="5509185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5509190">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5509195">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5509206">}</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5509211">if</span>&nbsp;<span class="ident" id="5509214">repeat</span>&nbsp;<span class="op" id="5509221">&gt;</span>&nbsp;<span class="num" id="5509223">0</span>&nbsp;<span class="op" id="5509225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5509230">//&nbsp;We&nbsp;have&nbsp;decoded&nbsp;a&nbsp;complete&nbsp;run-length&nbsp;so&nbsp;we&nbsp;need&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5509288">//&nbsp;replicate&nbsp;the&nbsp;last&nbsp;output&nbsp;symbol.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5509328">if</span>&nbsp;<span class="ident" id="5509331">repeat</span>&nbsp;<span class="op" id="5509338">&gt;</span>&nbsp;<span class="ident" id="5509340">bz2</span><span class="op" id="5509343">.</span><span class="ident" id="5509344">blockSize</span><span class="op" id="5509353">-</span><span class="ident" id="5509354">bufIndex</span>&nbsp;<span class="op" id="5509363">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5509369">return</span>&nbsp;<span class="ident" id="5509376">StructuralError</span><span class="op" id="5509391">(</span><span class="string" id="5509392">&#34;repeats&nbsp;past&nbsp;end&nbsp;of&nbsp;block&#34;</span><span class="op" id="5509419">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5509424">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5509429">for</span>&nbsp;<span class="ident" id="5509433">i</span>&nbsp;<span class="op" id="5509435">:=</span>&nbsp;<span class="num" id="5509438">0</span><span class="op" id="5509439">;</span>&nbsp;<span class="ident" id="5509441">i</span>&nbsp;<span class="op" id="5509443">&lt;</span>&nbsp;<span class="ident" id="5509445">repeat</span><span class="op" id="5509451">;</span>&nbsp;<span class="ident" id="5509453">i</span><span class="op" id="5509454">++</span>&nbsp;<span class="op" id="5509457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5509463">b</span>&nbsp;<span class="op" id="5509465">:=</span>&nbsp;<span class="builtintype" id="5509468">byte</span><span class="op" id="5509472">(</span><span class="ident" id="5509473">mtf</span><span class="op" id="5509476">.</span><span class="ident" id="5509477">First</span><span class="op" id="5509482">(</span><span class="op" id="5509483">)</span><span class="op" id="5509484">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5509490">bz2</span><span class="op" id="5509493">.</span><span class="ident" id="5509494">tt</span><span class="op" id="5509496">[</span><span class="ident" id="5509497">bufIndex</span><span class="op" id="5509505">]</span>&nbsp;<span class="op" id="5509507">=</span>&nbsp;<span class="builtintype" id="5509509">uint32</span><span class="op" id="5509515">(</span><span class="ident" id="5509516">b</span><span class="op" id="5509517">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5509523">bz2</span><span class="op" id="5509526">.</span><span class="ident" id="5509527">c</span><span class="op" id="5509528">[</span><span class="ident" id="5509529">b</span><span class="op" id="5509530">]</span><span class="op" id="5509531">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5509538">bufIndex</span><span class="op" id="5509546">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5509552">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5509557">repeat</span>&nbsp;<span class="op" id="5509564">=</span>&nbsp;<span class="num" id="5509566">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5509570">}</span><br>
<span class="lineno">410</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5509575">if</span>&nbsp;<span class="builtintype" id="5509578">int</span><span class="op" id="5509581">(</span><span class="ident" id="5509582">v</span><span class="op" id="5509583">)</span>&nbsp;<span class="op" id="5509585">==</span>&nbsp;<span class="ident" id="5509588">numSymbols</span><span class="op" id="5509598">-</span><span class="num" id="5509599">1</span>&nbsp;<span class="op" id="5509601">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5509606">//&nbsp;This&nbsp;is&nbsp;the&nbsp;EOF&nbsp;symbol.&nbsp;Because&nbsp;it&#39;s&nbsp;always&nbsp;at&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5509663">//&nbsp;end&nbsp;of&nbsp;the&nbsp;move-to-front&nbsp;list,&nbsp;and&nbsp;never&nbsp;gets&nbsp;moved</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5509721">//&nbsp;to&nbsp;the&nbsp;front,&nbsp;it&nbsp;has&nbsp;this&nbsp;unique&nbsp;value.</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5509767">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5509775">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5509780">//&nbsp;Since&nbsp;two&nbsp;metasymbols&nbsp;(RUNA&nbsp;and&nbsp;RUNB)&nbsp;have&nbsp;values&nbsp;0&nbsp;and&nbsp;1,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5509844">//&nbsp;one&nbsp;would&nbsp;expect&nbsp;|v-2|&nbsp;to&nbsp;be&nbsp;passed&nbsp;to&nbsp;the&nbsp;MTF&nbsp;decoder.</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5509905">//&nbsp;However,&nbsp;the&nbsp;front&nbsp;of&nbsp;the&nbsp;MTF&nbsp;list&nbsp;is&nbsp;never&nbsp;referenced&nbsp;as&nbsp;0,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5509971">//&nbsp;it&#39;s&nbsp;always&nbsp;referenced&nbsp;with&nbsp;a&nbsp;run-length&nbsp;of&nbsp;1.&nbsp;Thus&nbsp;0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5510030">//&nbsp;doesn&#39;t&nbsp;need&nbsp;to&nbsp;be&nbsp;encoded&nbsp;and&nbsp;we&nbsp;have&nbsp;|v-1|&nbsp;in&nbsp;the&nbsp;next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5510092">//&nbsp;line.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5510103">b</span>&nbsp;<span class="op" id="5510105">:=</span>&nbsp;<span class="builtintype" id="5510108">byte</span><span class="op" id="5510112">(</span><span class="ident" id="5510113">mtf</span><span class="op" id="5510116">.</span><span class="ident" id="5510117">Decode</span><span class="op" id="5510123">(</span><span class="builtintype" id="5510124">int</span><span class="op" id="5510127">(</span><span class="ident" id="5510128">v</span>&nbsp;<span class="op" id="5510130">-</span>&nbsp;<span class="num" id="5510132">1</span><span class="op" id="5510133">)</span><span class="op" id="5510134">)</span><span class="op" id="5510135">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5510139">if</span>&nbsp;<span class="ident" id="5510142">bufIndex</span>&nbsp;<span class="op" id="5510151">&gt;=</span>&nbsp;<span class="ident" id="5510154">bz2</span><span class="op" id="5510157">.</span><span class="ident" id="5510158">blockSize</span>&nbsp;<span class="op" id="5510168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5510173">return</span>&nbsp;<span class="ident" id="5510180">StructuralError</span><span class="op" id="5510195">(</span><span class="string" id="5510196">&#34;data&nbsp;exceeds&nbsp;block&nbsp;size&#34;</span><span class="op" id="5510221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5510225">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5510229">bz2</span><span class="op" id="5510232">.</span><span class="ident" id="5510233">tt</span><span class="op" id="5510235">[</span><span class="ident" id="5510236">bufIndex</span><span class="op" id="5510244">]</span>&nbsp;<span class="op" id="5510246">=</span>&nbsp;<span class="builtintype" id="5510248">uint32</span><span class="op" id="5510254">(</span><span class="ident" id="5510255">b</span><span class="op" id="5510256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5510260">bz2</span><span class="op" id="5510263">.</span><span class="ident" id="5510264">c</span><span class="op" id="5510265">[</span><span class="ident" id="5510266">b</span><span class="op" id="5510267">]</span><span class="op" id="5510268">++</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5510273">bufIndex</span><span class="op" id="5510281">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5510285">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5510289">if</span>&nbsp;<span class="ident" id="5510292">origPtr</span>&nbsp;<span class="op" id="5510300">&gt;=</span>&nbsp;<span class="builtintype" id="5510303">uint</span><span class="op" id="5510307">(</span><span class="ident" id="5510308">bufIndex</span><span class="op" id="5510316">)</span>&nbsp;<span class="op" id="5510318">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5510322">return</span>&nbsp;<span class="ident" id="5510329">StructuralError</span><span class="op" id="5510344">(</span><span class="string" id="5510345">&#34;origPtr&nbsp;out&nbsp;of&nbsp;bounds&#34;</span><span class="op" id="5510368">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5510371">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5510375">//&nbsp;We&nbsp;have&nbsp;completed&nbsp;the&nbsp;entropy&nbsp;decoding.&nbsp;Now&nbsp;we&nbsp;can&nbsp;perform&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5510442">//&nbsp;inverse&nbsp;BWT&nbsp;and&nbsp;setup&nbsp;the&nbsp;RLE&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5510484">bz2</span><span class="op" id="5510487">.</span><span class="ident" id="5510488">preRLE</span>&nbsp;<span class="op" id="5510495">=</span>&nbsp;<span class="ident" id="5510497">bz2</span><span class="op" id="5510500">.</span><span class="ident" id="5510501">tt</span><span class="op" id="5510503">[</span><span class="op" id="5510504">:</span><span class="ident" id="5510505">bufIndex</span><span class="op" id="5510513">]</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5510516">bz2</span><span class="op" id="5510519">.</span><span class="ident" id="5510520">preRLEUsed</span>&nbsp;<span class="op" id="5510531">=</span>&nbsp;<span class="num" id="5510533">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5510536">bz2</span><span class="op" id="5510539">.</span><span class="ident" id="5510540">tPos</span>&nbsp;<span class="op" id="5510545">=</span>&nbsp;<span class="ident" id="5510547">inverseBWT</span><span class="op" id="5510557">(</span><span class="ident" id="5510558">bz2</span><span class="op" id="5510561">.</span><span class="ident" id="5510562">preRLE</span><span class="op" id="5510568">,</span>&nbsp;<span class="ident" id="5510570">origPtr</span><span class="op" id="5510577">,</span>&nbsp;<span class="ident" id="5510579">bz2</span><span class="op" id="5510582">.</span><span class="ident" id="5510583">c</span><span class="op" id="5510584">[</span><span class="op" id="5510585">:</span><span class="op" id="5510586">]</span><span class="op" id="5510587">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5510590">bz2</span><span class="op" id="5510593">.</span><span class="ident" id="5510594">lastByte</span>&nbsp;<span class="op" id="5510603">=</span>&nbsp;<span class="op" id="5510605">-</span><span class="num" id="5510606">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5510609">bz2</span><span class="op" id="5510612">.</span><span class="ident" id="5510613">byteRepeats</span>&nbsp;<span class="op" id="5510625">=</span>&nbsp;<span class="num" id="5510627">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5510630">bz2</span><span class="op" id="5510633">.</span><span class="ident" id="5510634">repeats</span>&nbsp;<span class="op" id="5510642">=</span>&nbsp;<span class="num" id="5510644">0</span><br>
<span class="lineno">445</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5510648">return</span>&nbsp;<span class="ident" id="5510655">nil</span><br>
<span class="lineno"></span><span class="op" id="5510659">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5510662">//&nbsp;inverseBWT&nbsp;implements&nbsp;the&nbsp;inverse&nbsp;Burrows-Wheeler&nbsp;transform&nbsp;as&nbsp;described&nbsp;in</span><br>
<span class="lineno">450</span><span class="comment" id="5510741">//&nbsp;http://www.hpl.hp.com/techreports/Compaq-DEC/SRC-RR-124.pdf,&nbsp;section&nbsp;4.2.</span><br>
<span class="lineno"></span><span class="comment" id="5510818">//&nbsp;In&nbsp;that&nbsp;document,&nbsp;origPtr&nbsp;is&nbsp;called&nbsp;`I&#39;&nbsp;and&nbsp;c&nbsp;is&nbsp;the&nbsp;`C&#39;&nbsp;array&nbsp;after&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5510894">//&nbsp;first&nbsp;pass&nbsp;over&nbsp;the&nbsp;data.&nbsp;It&#39;s&nbsp;an&nbsp;argument&nbsp;here&nbsp;because&nbsp;we&nbsp;merge&nbsp;the&nbsp;first</span><br>
<span class="lineno"></span><span class="comment" id="5510972">//&nbsp;pass&nbsp;with&nbsp;the&nbsp;Huffman&nbsp;decoding.</span><br>
<span class="lineno"></span><span class="comment" id="5511007">//</span><br>
<span class="lineno">455</span><span class="comment" id="5511010">//&nbsp;This&nbsp;also&nbsp;implements&nbsp;the&nbsp;`single&nbsp;array&#39;&nbsp;method&nbsp;from&nbsp;the&nbsp;bzip2&nbsp;source&nbsp;code</span><br>
<span class="lineno"></span><span class="comment" id="5511087">//&nbsp;which&nbsp;leaves&nbsp;the&nbsp;output,&nbsp;still&nbsp;shuffled,&nbsp;in&nbsp;the&nbsp;bottom&nbsp;8&nbsp;bits&nbsp;of&nbsp;tt&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5511167">//&nbsp;index&nbsp;of&nbsp;the&nbsp;next&nbsp;byte&nbsp;in&nbsp;the&nbsp;top&nbsp;24-bits.&nbsp;The&nbsp;index&nbsp;of&nbsp;the&nbsp;first&nbsp;byte&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="5511244">//&nbsp;returned.</span><br>
<span class="lineno"></span><span class="keyword" id="5511257">func</span>&nbsp;<span class="ident" id="5511262">inverseBWT</span><span class="op" id="5511272">(</span><span class="ident" id="5511273">tt</span>&nbsp;<span class="op" id="5511276">[</span><span class="op" id="5511277">]</span><span class="builtintype" id="5511278">uint32</span><span class="op" id="5511284">,</span>&nbsp;<span class="ident" id="5511286">origPtr</span>&nbsp;<span class="builtintype" id="5511294">uint</span><span class="op" id="5511298">,</span>&nbsp;<span class="ident" id="5511300">c</span>&nbsp;<span class="op" id="5511302">[</span><span class="op" id="5511303">]</span><span class="builtintype" id="5511304">uint</span><span class="op" id="5511308">)</span>&nbsp;<span class="builtintype" id="5511310">uint32</span>&nbsp;<span class="op" id="5511317">{</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5511320">sum</span>&nbsp;<span class="op" id="5511324">:=</span>&nbsp;<span class="builtintype" id="5511327">uint</span><span class="op" id="5511331">(</span><span class="num" id="5511332">0</span><span class="op" id="5511333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5511336">for</span>&nbsp;<span class="ident" id="5511340">i</span>&nbsp;<span class="op" id="5511342">:=</span>&nbsp;<span class="num" id="5511345">0</span><span class="op" id="5511346">;</span>&nbsp;<span class="ident" id="5511348">i</span>&nbsp;<span class="op" id="5511350">&lt;</span>&nbsp;<span class="num" id="5511352">256</span><span class="op" id="5511355">;</span>&nbsp;<span class="ident" id="5511357">i</span><span class="op" id="5511358">++</span>&nbsp;<span class="op" id="5511361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5511365">sum</span>&nbsp;<span class="op" id="5511369">+=</span>&nbsp;<span class="ident" id="5511372">c</span><span class="op" id="5511373">[</span><span class="ident" id="5511374">i</span><span class="op" id="5511375">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5511379">c</span><span class="op" id="5511380">[</span><span class="ident" id="5511381">i</span><span class="op" id="5511382">]</span>&nbsp;<span class="op" id="5511384">=</span>&nbsp;<span class="ident" id="5511386">sum</span>&nbsp;<span class="op" id="5511390">-</span>&nbsp;<span class="ident" id="5511392">c</span><span class="op" id="5511393">[</span><span class="ident" id="5511394">i</span><span class="op" id="5511395">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5511398">}</span><br>
<span class="lineno">465</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5511402">for</span>&nbsp;<span class="ident" id="5511406">i</span>&nbsp;<span class="op" id="5511408">:=</span>&nbsp;<span class="keyword" id="5511411">range</span>&nbsp;<span class="ident" id="5511417">tt</span>&nbsp;<span class="op" id="5511420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5511424">b</span>&nbsp;<span class="op" id="5511426">:=</span>&nbsp;<span class="ident" id="5511429">tt</span><span class="op" id="5511431">[</span><span class="ident" id="5511432">i</span><span class="op" id="5511433">]</span>&nbsp;<span class="op" id="5511435">&amp;</span>&nbsp;<span class="num" id="5511437">0xff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5511444">tt</span><span class="op" id="5511446">[</span><span class="ident" id="5511447">c</span><span class="op" id="5511448">[</span><span class="ident" id="5511449">b</span><span class="op" id="5511450">]</span><span class="op" id="5511451">]</span>&nbsp;<span class="op" id="5511453">|=</span>&nbsp;<span class="builtintype" id="5511456">uint32</span><span class="op" id="5511462">(</span><span class="ident" id="5511463">i</span><span class="op" id="5511464">)</span>&nbsp;<span class="op" id="5511466">&lt;&lt;</span>&nbsp;<span class="num" id="5511469">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5511473">c</span><span class="op" id="5511474">[</span><span class="ident" id="5511475">b</span><span class="op" id="5511476">]</span><span class="op" id="5511477">++</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5511481">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5511485">return</span>&nbsp;<span class="ident" id="5511492">tt</span><span class="op" id="5511494">[</span><span class="ident" id="5511495">origPtr</span><span class="op" id="5511502">]</span>&nbsp;<span class="op" id="5511504">&gt;&gt;</span>&nbsp;<span class="num" id="5511507">8</span><br>
<span class="lineno"></span><span class="op" id="5511509">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">475</span><span class="comment" id="5511512">//&nbsp;This&nbsp;is&nbsp;a&nbsp;standard&nbsp;CRC32&nbsp;like&nbsp;in&nbsp;hash/crc32&nbsp;except&nbsp;that&nbsp;all&nbsp;the&nbsp;shifts&nbsp;are&nbsp;reversed,</span><br>
<span class="lineno"></span><span class="comment" id="5511600">//&nbsp;causing&nbsp;the&nbsp;bits&nbsp;in&nbsp;the&nbsp;input&nbsp;to&nbsp;be&nbsp;processed&nbsp;in&nbsp;the&nbsp;reverse&nbsp;of&nbsp;the&nbsp;usual&nbsp;order.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5511685">var</span>&nbsp;<span class="ident" id="5511689">crctab</span>&nbsp;<span class="op" id="5511696">[</span><span class="num" id="5511697">256</span><span class="op" id="5511700">]</span><span class="builtintype" id="5511701">uint32</span><br>
<span class="lineno"></span><br>
<span class="lineno">480</span><span class="keyword" id="5511709">func</span>&nbsp;<span class="ident" id="5511714">init</span><span class="op" id="5511718">(</span><span class="op" id="5511719">)</span>&nbsp;<span class="op" id="5511721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5511724">const</span>&nbsp;<span class="ident" id="5511730">poly</span>&nbsp;<span class="op" id="5511735">=</span>&nbsp;<span class="num" id="5511737">0x04C11DB7</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5511749">for</span>&nbsp;<span class="ident" id="5511753">i</span>&nbsp;<span class="op" id="5511755">:=</span>&nbsp;<span class="keyword" id="5511758">range</span>&nbsp;<span class="ident" id="5511764">crctab</span>&nbsp;<span class="op" id="5511771">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5511775">crc</span>&nbsp;<span class="op" id="5511779">:=</span>&nbsp;<span class="builtintype" id="5511782">uint32</span><span class="op" id="5511788">(</span><span class="ident" id="5511789">i</span><span class="op" id="5511790">)</span>&nbsp;<span class="op" id="5511792">&lt;&lt;</span>&nbsp;<span class="num" id="5511795">24</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5511800">for</span>&nbsp;<span class="ident" id="5511804">j</span>&nbsp;<span class="op" id="5511806">:=</span>&nbsp;<span class="num" id="5511809">0</span><span class="op" id="5511810">;</span>&nbsp;<span class="ident" id="5511812">j</span>&nbsp;<span class="op" id="5511814">&lt;</span>&nbsp;<span class="num" id="5511816">8</span><span class="op" id="5511817">;</span>&nbsp;<span class="ident" id="5511819">j</span><span class="op" id="5511820">++</span>&nbsp;<span class="op" id="5511823">{</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5511828">if</span>&nbsp;<span class="ident" id="5511831">crc</span><span class="op" id="5511834">&amp;</span><span class="num" id="5511835">0x80000000</span>&nbsp;<span class="op" id="5511846">!=</span>&nbsp;<span class="num" id="5511849">0</span>&nbsp;<span class="op" id="5511851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5511857">crc</span>&nbsp;<span class="op" id="5511861">=</span>&nbsp;<span class="op" id="5511863">(</span><span class="ident" id="5511864">crc</span>&nbsp;<span class="op" id="5511868">&lt;&lt;</span>&nbsp;<span class="num" id="5511871">1</span><span class="op" id="5511872">)</span>&nbsp;<span class="op" id="5511874">^</span>&nbsp;<span class="ident" id="5511876">poly</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5511884">}</span>&nbsp;<span class="keyword" id="5511886">else</span>&nbsp;<span class="op" id="5511891">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5511897">crc</span>&nbsp;<span class="op" id="5511901">&lt;&lt;=</span>&nbsp;<span class="num" id="5511905">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5511910">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5511914">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5511918">crctab</span><span class="op" id="5511924">[</span><span class="ident" id="5511925">i</span><span class="op" id="5511926">]</span>&nbsp;<span class="op" id="5511928">=</span>&nbsp;<span class="ident" id="5511930">crc</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5511935">}</span><br>
<span class="lineno"></span><span class="op" id="5511937">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">495</span><span class="comment" id="5511940">//&nbsp;updateCRC&nbsp;updates&nbsp;the&nbsp;crc&nbsp;value&nbsp;to&nbsp;incorporate&nbsp;the&nbsp;data&nbsp;in&nbsp;b.</span><br>
<span class="lineno"></span><span class="comment" id="5512005">//&nbsp;The&nbsp;initial&nbsp;value&nbsp;is&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="5512032">func</span>&nbsp;<span class="ident" id="5512037">updateCRC</span><span class="op" id="5512046">(</span><span class="ident" id="5512047">val</span>&nbsp;<span class="builtintype" id="5512051">uint32</span><span class="op" id="5512057">,</span>&nbsp;<span class="ident" id="5512059">b</span>&nbsp;<span class="op" id="5512061">[</span><span class="op" id="5512062">]</span><span class="builtintype" id="5512063">byte</span><span class="op" id="5512067">)</span>&nbsp;<span class="builtintype" id="5512069">uint32</span>&nbsp;<span class="op" id="5512076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5512079">crc</span>&nbsp;<span class="op" id="5512083">:=</span>&nbsp;<span class="op" id="5512086">^</span><span class="ident" id="5512087">val</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5512092">for</span>&nbsp;<span class="ident" id="5512096">_</span><span class="op" id="5512097">,</span>&nbsp;<span class="ident" id="5512099">v</span>&nbsp;<span class="op" id="5512101">:=</span>&nbsp;<span class="keyword" id="5512104">range</span>&nbsp;<span class="ident" id="5512110">b</span>&nbsp;<span class="op" id="5512112">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5512116">crc</span>&nbsp;<span class="op" id="5512120">=</span>&nbsp;<span class="ident" id="5512122">crctab</span><span class="op" id="5512128">[</span><span class="builtintype" id="5512129">byte</span><span class="op" id="5512133">(</span><span class="ident" id="5512134">crc</span><span class="op" id="5512137">&gt;&gt;</span><span class="num" id="5512139">24</span><span class="op" id="5512141">)</span><span class="op" id="5512142">^</span><span class="ident" id="5512143">v</span><span class="op" id="5512144">]</span>&nbsp;<span class="op" id="5512146">^</span>&nbsp;<span class="op" id="5512148">(</span><span class="ident" id="5512149">crc</span>&nbsp;<span class="op" id="5512153">&lt;&lt;</span>&nbsp;<span class="num" id="5512156">8</span><span class="op" id="5512157">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5512160">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5512163">return</span>&nbsp;<span class="op" id="5512170">^</span><span class="ident" id="5512171">crc</span><br>
<span class="lineno"></span><span class="op" id="5512175">}</span>
</div>
</body>
</html>
