<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="3859132">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3859187">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3859241">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3859292">package</span>&nbsp;<span class="ident" id="3859300">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3859305">import</span>&nbsp;<span class="op" id="3859312">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3859315">&#34;crypto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3859325">&#34;crypto/ecdsa&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3859341">&#34;crypto/rsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3859355">&#34;crypto/subtle&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3859372">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3859387">&#34;encoding/asn1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3859404">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3859414">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3859421">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="3859426">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3859429">//&nbsp;serverHandshakeState&nbsp;contains&nbsp;details&nbsp;of&nbsp;a&nbsp;server&nbsp;handshake&nbsp;in&nbsp;progress.</span><br>
<span class="lineno">20</span><span class="comment" id="3859505">//&nbsp;It&#39;s&nbsp;discarded&nbsp;once&nbsp;the&nbsp;handshake&nbsp;has&nbsp;completed.</span><br>
<span class="lineno"></span><span class="keyword" id="3859557">type</span>&nbsp;<span class="ident" id="3859562">serverHandshakeState</span>&nbsp;<span class="keyword" id="3859583">struct</span>&nbsp;<span class="op" id="3859590">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859593">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3859609">*</span><span class="ident" id="3859610">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859616">clientHello</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3859632">*</span><span class="ident" id="3859633">clientHelloMsg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859649">hello</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3859665">*</span><span class="ident" id="3859666">serverHelloMsg</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859682">suite</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3859698">*</span><span class="ident" id="3859699">cipherSuite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859712">ellipticOk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3859728">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859734">ecdsaOk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3859750">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859756">sessionState</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3859772">*</span><span class="ident" id="3859773">sessionState</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859787">finishedHash</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3859803">finishedHash</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859817">masterSecret</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3859833">[</span><span class="op" id="3859834">]</span><span class="builtintype" id="3859835">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859841">certsFromClient</span>&nbsp;<span class="op" id="3859857">[</span><span class="op" id="3859858">]</span><span class="op" id="3859859">[</span><span class="op" id="3859860">]</span><span class="builtintype" id="3859861">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859867">cert</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3859883">*</span><span class="ident" id="3859884">Certificate</span><br>
<span class="lineno"></span><span class="op" id="3859896">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="comment" id="3859899">//&nbsp;serverHandshake&nbsp;performs&nbsp;a&nbsp;TLS&nbsp;handshake&nbsp;as&nbsp;a&nbsp;server.</span><br>
<span class="lineno"></span><span class="keyword" id="3859956">func</span>&nbsp;<span class="op" id="3859961">(</span><span class="ident" id="3859962">c</span>&nbsp;<span class="op" id="3859964">*</span><span class="ident" id="3859965">Conn</span><span class="op" id="3859969">)</span>&nbsp;<span class="ident" id="3859971">serverHandshake</span><span class="op" id="3859986">(</span><span class="op" id="3859987">)</span>&nbsp;<span class="builtintype" id="3859989">error</span>&nbsp;<span class="op" id="3859995">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3859998">config</span>&nbsp;<span class="op" id="3860005">:=</span>&nbsp;<span class="ident" id="3860008">c</span><span class="op" id="3860009">.</span><span class="ident" id="3860010">config</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3860019">//&nbsp;If&nbsp;this&nbsp;is&nbsp;the&nbsp;first&nbsp;server&nbsp;handshake,&nbsp;we&nbsp;generate&nbsp;a&nbsp;random&nbsp;key&nbsp;to</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3860090">//&nbsp;encrypt&nbsp;the&nbsp;tickets&nbsp;with.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3860120">config</span><span class="op" id="3860126">.</span><span class="ident" id="3860127">serverInitOnce</span><span class="op" id="3860141">.</span><span class="ident" id="3860142">Do</span><span class="op" id="3860144">(</span><span class="ident" id="3860145">config</span><span class="op" id="3860151">.</span><span class="ident" id="3860152">serverInit</span><span class="op" id="3860162">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3860166">hs</span>&nbsp;<span class="op" id="3860169">:=</span>&nbsp;<span class="ident" id="3860172">serverHandshakeState</span><span class="op" id="3860192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3860196">c</span><span class="op" id="3860197">:</span>&nbsp;<span class="ident" id="3860199">c</span><span class="op" id="3860200">,</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3860203">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3860206">isResume</span><span class="op" id="3860214">,</span>&nbsp;<span class="ident" id="3860216">err</span>&nbsp;<span class="op" id="3860220">:=</span>&nbsp;<span class="ident" id="3860223">hs</span><span class="op" id="3860225">.</span><span class="ident" id="3860226">readClientHello</span><span class="op" id="3860241">(</span><span class="op" id="3860242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3860245">if</span>&nbsp;<span class="ident" id="3860248">err</span>&nbsp;<span class="op" id="3860252">!=</span>&nbsp;<span class="ident" id="3860255">nil</span>&nbsp;<span class="op" id="3860259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3860263">return</span>&nbsp;<span class="ident" id="3860270">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3860275">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3860279">//&nbsp;For&nbsp;an&nbsp;overview&nbsp;of&nbsp;TLS&nbsp;handshaking,&nbsp;see&nbsp;https://tools.ietf.org/html/rfc5246#section-7.3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3860371">if</span>&nbsp;<span class="ident" id="3860374">isResume</span>&nbsp;<span class="op" id="3860383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3860387">//&nbsp;The&nbsp;client&nbsp;has&nbsp;included&nbsp;a&nbsp;session&nbsp;ticket&nbsp;and&nbsp;so&nbsp;we&nbsp;do&nbsp;an&nbsp;abbreviated&nbsp;handshake.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3860472">if</span>&nbsp;<span class="ident" id="3860475">err</span>&nbsp;<span class="op" id="3860479">:=</span>&nbsp;<span class="ident" id="3860482">hs</span><span class="op" id="3860484">.</span><span class="ident" id="3860485">doResumeHandshake</span><span class="op" id="3860502">(</span><span class="op" id="3860503">)</span><span class="op" id="3860504">;</span>&nbsp;<span class="ident" id="3860506">err</span>&nbsp;<span class="op" id="3860510">!=</span>&nbsp;<span class="ident" id="3860513">nil</span>&nbsp;<span class="op" id="3860517">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3860522">return</span>&nbsp;<span class="ident" id="3860529">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3860535">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3860539">if</span>&nbsp;<span class="ident" id="3860542">err</span>&nbsp;<span class="op" id="3860546">:=</span>&nbsp;<span class="ident" id="3860549">hs</span><span class="op" id="3860551">.</span><span class="ident" id="3860552">establishKeys</span><span class="op" id="3860565">(</span><span class="op" id="3860566">)</span><span class="op" id="3860567">;</span>&nbsp;<span class="ident" id="3860569">err</span>&nbsp;<span class="op" id="3860573">!=</span>&nbsp;<span class="ident" id="3860576">nil</span>&nbsp;<span class="op" id="3860580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3860585">return</span>&nbsp;<span class="ident" id="3860592">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3860598">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3860602">if</span>&nbsp;<span class="ident" id="3860605">err</span>&nbsp;<span class="op" id="3860609">:=</span>&nbsp;<span class="ident" id="3860612">hs</span><span class="op" id="3860614">.</span><span class="ident" id="3860615">sendFinished</span><span class="op" id="3860627">(</span><span class="ident" id="3860628">c</span><span class="op" id="3860629">.</span><span class="ident" id="3860630">firstFinished</span><span class="op" id="3860643">[</span><span class="op" id="3860644">:</span><span class="op" id="3860645">]</span><span class="op" id="3860646">)</span><span class="op" id="3860647">;</span>&nbsp;<span class="ident" id="3860649">err</span>&nbsp;<span class="op" id="3860653">!=</span>&nbsp;<span class="ident" id="3860656">nil</span>&nbsp;<span class="op" id="3860660">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3860665">return</span>&nbsp;<span class="ident" id="3860672">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3860678">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3860682">if</span>&nbsp;<span class="ident" id="3860685">err</span>&nbsp;<span class="op" id="3860689">:=</span>&nbsp;<span class="ident" id="3860692">hs</span><span class="op" id="3860694">.</span><span class="ident" id="3860695">readFinished</span><span class="op" id="3860707">(</span><span class="ident" id="3860708">nil</span><span class="op" id="3860711">)</span><span class="op" id="3860712">;</span>&nbsp;<span class="ident" id="3860714">err</span>&nbsp;<span class="op" id="3860718">!=</span>&nbsp;<span class="ident" id="3860721">nil</span>&nbsp;<span class="op" id="3860725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3860730">return</span>&nbsp;<span class="ident" id="3860737">err</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3860743">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3860747">c</span><span class="op" id="3860748">.</span><span class="ident" id="3860749">didResume</span>&nbsp;<span class="op" id="3860759">=</span>&nbsp;<span class="builtintype" id="3860761">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3860767">}</span>&nbsp;<span class="keyword" id="3860769">else</span>&nbsp;<span class="op" id="3860774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3860778">//&nbsp;The&nbsp;client&nbsp;didn&#39;t&nbsp;include&nbsp;a&nbsp;session&nbsp;ticket,&nbsp;or&nbsp;it&nbsp;wasn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3860840">//&nbsp;valid&nbsp;so&nbsp;we&nbsp;do&nbsp;a&nbsp;full&nbsp;handshake.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3860878">if</span>&nbsp;<span class="ident" id="3860881">err</span>&nbsp;<span class="op" id="3860885">:=</span>&nbsp;<span class="ident" id="3860888">hs</span><span class="op" id="3860890">.</span><span class="ident" id="3860891">doFullHandshake</span><span class="op" id="3860906">(</span><span class="op" id="3860907">)</span><span class="op" id="3860908">;</span>&nbsp;<span class="ident" id="3860910">err</span>&nbsp;<span class="op" id="3860914">!=</span>&nbsp;<span class="ident" id="3860917">nil</span>&nbsp;<span class="op" id="3860921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3860926">return</span>&nbsp;<span class="ident" id="3860933">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3860939">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3860943">if</span>&nbsp;<span class="ident" id="3860946">err</span>&nbsp;<span class="op" id="3860950">:=</span>&nbsp;<span class="ident" id="3860953">hs</span><span class="op" id="3860955">.</span><span class="ident" id="3860956">establishKeys</span><span class="op" id="3860969">(</span><span class="op" id="3860970">)</span><span class="op" id="3860971">;</span>&nbsp;<span class="ident" id="3860973">err</span>&nbsp;<span class="op" id="3860977">!=</span>&nbsp;<span class="ident" id="3860980">nil</span>&nbsp;<span class="op" id="3860984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3860989">return</span>&nbsp;<span class="ident" id="3860996">err</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3861002">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3861006">if</span>&nbsp;<span class="ident" id="3861009">err</span>&nbsp;<span class="op" id="3861013">:=</span>&nbsp;<span class="ident" id="3861016">hs</span><span class="op" id="3861018">.</span><span class="ident" id="3861019">readFinished</span><span class="op" id="3861031">(</span><span class="ident" id="3861032">c</span><span class="op" id="3861033">.</span><span class="ident" id="3861034">firstFinished</span><span class="op" id="3861047">[</span><span class="op" id="3861048">:</span><span class="op" id="3861049">]</span><span class="op" id="3861050">)</span><span class="op" id="3861051">;</span>&nbsp;<span class="ident" id="3861053">err</span>&nbsp;<span class="op" id="3861057">!=</span>&nbsp;<span class="ident" id="3861060">nil</span>&nbsp;<span class="op" id="3861064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3861069">return</span>&nbsp;<span class="ident" id="3861076">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3861082">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3861086">if</span>&nbsp;<span class="ident" id="3861089">err</span>&nbsp;<span class="op" id="3861093">:=</span>&nbsp;<span class="ident" id="3861096">hs</span><span class="op" id="3861098">.</span><span class="ident" id="3861099">sendSessionTicket</span><span class="op" id="3861116">(</span><span class="op" id="3861117">)</span><span class="op" id="3861118">;</span>&nbsp;<span class="ident" id="3861120">err</span>&nbsp;<span class="op" id="3861124">!=</span>&nbsp;<span class="ident" id="3861127">nil</span>&nbsp;<span class="op" id="3861131">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3861136">return</span>&nbsp;<span class="ident" id="3861143">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3861149">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3861153">if</span>&nbsp;<span class="ident" id="3861156">err</span>&nbsp;<span class="op" id="3861160">:=</span>&nbsp;<span class="ident" id="3861163">hs</span><span class="op" id="3861165">.</span><span class="ident" id="3861166">sendFinished</span><span class="op" id="3861178">(</span><span class="ident" id="3861179">nil</span><span class="op" id="3861182">)</span><span class="op" id="3861183">;</span>&nbsp;<span class="ident" id="3861185">err</span>&nbsp;<span class="op" id="3861189">!=</span>&nbsp;<span class="ident" id="3861192">nil</span>&nbsp;<span class="op" id="3861196">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3861201">return</span>&nbsp;<span class="ident" id="3861208">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3861214">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3861217">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3861220">c</span><span class="op" id="3861221">.</span><span class="ident" id="3861222">handshakeComplete</span>&nbsp;<span class="op" id="3861240">=</span>&nbsp;<span class="builtintype" id="3861242">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3861249">return</span>&nbsp;<span class="ident" id="3861256">nil</span><br>
<span class="lineno"></span><span class="op" id="3861260">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="comment" id="3861263">//&nbsp;readClientHello&nbsp;reads&nbsp;a&nbsp;ClientHello&nbsp;message&nbsp;from&nbsp;the&nbsp;client&nbsp;and&nbsp;decides</span><br>
<span class="lineno"></span><span class="comment" id="3861338">//&nbsp;whether&nbsp;we&nbsp;will&nbsp;perform&nbsp;session&nbsp;resumption.</span><br>
<span class="lineno"></span><span class="keyword" id="3861385">func</span>&nbsp;<span class="op" id="3861390">(</span><span class="ident" id="3861391">hs</span>&nbsp;<span class="op" id="3861394">*</span><span class="ident" id="3861395">serverHandshakeState</span><span class="op" id="3861415">)</span>&nbsp;<span class="ident" id="3861417">readClientHello</span><span class="op" id="3861432">(</span><span class="op" id="3861433">)</span>&nbsp;<span class="op" id="3861435">(</span><span class="ident" id="3861436">isResume</span>&nbsp;<span class="builtintype" id="3861445">bool</span><span class="op" id="3861449">,</span>&nbsp;<span class="ident" id="3861451">err</span>&nbsp;<span class="builtintype" id="3861455">error</span><span class="op" id="3861460">)</span>&nbsp;<span class="op" id="3861462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3861465">config</span>&nbsp;<span class="op" id="3861472">:=</span>&nbsp;<span class="ident" id="3861475">hs</span><span class="op" id="3861477">.</span><span class="ident" id="3861478">c</span><span class="op" id="3861479">.</span><span class="ident" id="3861480">config</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3861488">c</span>&nbsp;<span class="op" id="3861490">:=</span>&nbsp;<span class="ident" id="3861493">hs</span><span class="op" id="3861495">.</span><span class="ident" id="3861496">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3861500">msg</span><span class="op" id="3861503">,</span>&nbsp;<span class="ident" id="3861505">err</span>&nbsp;<span class="op" id="3861509">:=</span>&nbsp;<span class="ident" id="3861512">c</span><span class="op" id="3861513">.</span><span class="ident" id="3861514">readHandshake</span><span class="op" id="3861527">(</span><span class="op" id="3861528">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3861531">if</span>&nbsp;<span class="ident" id="3861534">err</span>&nbsp;<span class="op" id="3861538">!=</span>&nbsp;<span class="ident" id="3861541">nil</span>&nbsp;<span class="op" id="3861545">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3861549">return</span>&nbsp;<span class="builtintype" id="3861556">false</span><span class="op" id="3861561">,</span>&nbsp;<span class="ident" id="3861563">err</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3861568">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3861571">var</span>&nbsp;<span class="ident" id="3861575">ok</span>&nbsp;<span class="builtintype" id="3861578">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3861584">hs</span><span class="op" id="3861586">.</span><span class="ident" id="3861587">clientHello</span><span class="op" id="3861598">,</span>&nbsp;<span class="ident" id="3861600">ok</span>&nbsp;<span class="op" id="3861603">=</span>&nbsp;<span class="ident" id="3861605">msg</span><span class="op" id="3861608">.</span><span class="op" id="3861609">(</span><span class="op" id="3861610">*</span><span class="ident" id="3861611">clientHelloMsg</span><span class="op" id="3861625">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3861628">if</span>&nbsp;<span class="op" id="3861631">!</span><span class="ident" id="3861632">ok</span>&nbsp;<span class="op" id="3861635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3861639">c</span><span class="op" id="3861640">.</span><span class="ident" id="3861641">sendAlert</span><span class="op" id="3861650">(</span><span class="ident" id="3861651">alertUnexpectedMessage</span><span class="op" id="3861673">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3861677">return</span>&nbsp;<span class="builtintype" id="3861684">false</span><span class="op" id="3861689">,</span>&nbsp;<span class="ident" id="3861691">unexpectedMessageError</span><span class="op" id="3861713">(</span><span class="ident" id="3861714">hs</span><span class="op" id="3861716">.</span><span class="ident" id="3861717">clientHello</span><span class="op" id="3861728">,</span>&nbsp;<span class="ident" id="3861730">msg</span><span class="op" id="3861733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3861736">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3861739">c</span><span class="op" id="3861740">.</span><span class="ident" id="3861741">vers</span><span class="op" id="3861745">,</span>&nbsp;<span class="ident" id="3861747">ok</span>&nbsp;<span class="op" id="3861750">=</span>&nbsp;<span class="ident" id="3861752">config</span><span class="op" id="3861758">.</span><span class="ident" id="3861759">mutualVersion</span><span class="op" id="3861772">(</span><span class="ident" id="3861773">hs</span><span class="op" id="3861775">.</span><span class="ident" id="3861776">clientHello</span><span class="op" id="3861787">.</span><span class="ident" id="3861788">vers</span><span class="op" id="3861792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3861795">if</span>&nbsp;<span class="op" id="3861798">!</span><span class="ident" id="3861799">ok</span>&nbsp;<span class="op" id="3861802">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3861806">c</span><span class="op" id="3861807">.</span><span class="ident" id="3861808">sendAlert</span><span class="op" id="3861817">(</span><span class="ident" id="3861818">alertProtocolVersion</span><span class="op" id="3861838">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3861842">return</span>&nbsp;<span class="builtintype" id="3861849">false</span><span class="op" id="3861854">,</span>&nbsp;<span class="ident" id="3861856">fmt</span><span class="op" id="3861859">.</span><span class="ident" id="3861860">Errorf</span><span class="op" id="3861866">(</span><span class="string" id="3861867">&#34;tls:&nbsp;client&nbsp;offered&nbsp;an&nbsp;unsupported,&nbsp;maximum&nbsp;protocol&nbsp;version&nbsp;of&nbsp;%x&#34;</span><span class="op" id="3861935">,</span>&nbsp;<span class="ident" id="3861937">hs</span><span class="op" id="3861939">.</span><span class="ident" id="3861940">clientHello</span><span class="op" id="3861951">.</span><span class="ident" id="3861952">vers</span><span class="op" id="3861956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3861959">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3861962">c</span><span class="op" id="3861963">.</span><span class="ident" id="3861964">haveVers</span>&nbsp;<span class="op" id="3861973">=</span>&nbsp;<span class="builtintype" id="3861975">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3861982">hs</span><span class="op" id="3861984">.</span><span class="ident" id="3861985">finishedHash</span>&nbsp;<span class="op" id="3861998">=</span>&nbsp;<span class="ident" id="3862000">newFinishedHash</span><span class="op" id="3862015">(</span><span class="ident" id="3862016">c</span><span class="op" id="3862017">.</span><span class="ident" id="3862018">vers</span><span class="op" id="3862022">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3862025">hs</span><span class="op" id="3862027">.</span><span class="ident" id="3862028">finishedHash</span><span class="op" id="3862040">.</span><span class="ident" id="3862041">Write</span><span class="op" id="3862046">(</span><span class="ident" id="3862047">hs</span><span class="op" id="3862049">.</span><span class="ident" id="3862050">clientHello</span><span class="op" id="3862061">.</span><span class="ident" id="3862062">marshal</span><span class="op" id="3862069">(</span><span class="op" id="3862070">)</span><span class="op" id="3862071">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3862075">hs</span><span class="op" id="3862077">.</span><span class="ident" id="3862078">hello</span>&nbsp;<span class="op" id="3862084">=</span>&nbsp;<span class="builtinfunc" id="3862086">new</span><span class="op" id="3862089">(</span><span class="ident" id="3862090">serverHelloMsg</span><span class="op" id="3862104">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3862108">supportedCurve</span>&nbsp;<span class="op" id="3862123">:=</span>&nbsp;<span class="builtintype" id="3862126">false</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3862133">preferredCurves</span>&nbsp;<span class="op" id="3862149">:=</span>&nbsp;<span class="ident" id="3862152">config</span><span class="op" id="3862158">.</span><span class="ident" id="3862159">curvePreferences</span><span class="op" id="3862175">(</span><span class="op" id="3862176">)</span><br>
<span class="lineno"></span><span class="ident" id="3862178">Curves</span><span class="op" id="3862184">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3862187">for</span>&nbsp;<span class="ident" id="3862191">_</span><span class="op" id="3862192">,</span>&nbsp;<span class="ident" id="3862194">curve</span>&nbsp;<span class="op" id="3862200">:=</span>&nbsp;<span class="keyword" id="3862203">range</span>&nbsp;<span class="ident" id="3862209">hs</span><span class="op" id="3862211">.</span><span class="ident" id="3862212">clientHello</span><span class="op" id="3862223">.</span><span class="ident" id="3862224">supportedCurves</span>&nbsp;<span class="op" id="3862240">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3862244">for</span>&nbsp;<span class="ident" id="3862248">_</span><span class="op" id="3862249">,</span>&nbsp;<span class="ident" id="3862251">supported</span>&nbsp;<span class="op" id="3862261">:=</span>&nbsp;<span class="keyword" id="3862264">range</span>&nbsp;<span class="ident" id="3862270">preferredCurves</span>&nbsp;<span class="op" id="3862286">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3862291">if</span>&nbsp;<span class="ident" id="3862294">supported</span>&nbsp;<span class="op" id="3862304">==</span>&nbsp;<span class="ident" id="3862307">curve</span>&nbsp;<span class="op" id="3862313">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3862319">supportedCurve</span>&nbsp;<span class="op" id="3862334">=</span>&nbsp;<span class="builtintype" id="3862336">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3862345">break</span>&nbsp;<span class="ident" id="3862351">Curves</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3862361">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3862365">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3862368">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3862372">supportedPointFormat</span>&nbsp;<span class="op" id="3862393">:=</span>&nbsp;<span class="builtintype" id="3862396">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3862403">for</span>&nbsp;<span class="ident" id="3862407">_</span><span class="op" id="3862408">,</span>&nbsp;<span class="ident" id="3862410">pointFormat</span>&nbsp;<span class="op" id="3862422">:=</span>&nbsp;<span class="keyword" id="3862425">range</span>&nbsp;<span class="ident" id="3862431">hs</span><span class="op" id="3862433">.</span><span class="ident" id="3862434">clientHello</span><span class="op" id="3862445">.</span><span class="ident" id="3862446">supportedPoints</span>&nbsp;<span class="op" id="3862462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3862466">if</span>&nbsp;<span class="ident" id="3862469">pointFormat</span>&nbsp;<span class="op" id="3862481">==</span>&nbsp;<span class="ident" id="3862484">pointFormatUncompressed</span>&nbsp;<span class="op" id="3862508">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3862513">supportedPointFormat</span>&nbsp;<span class="op" id="3862534">=</span>&nbsp;<span class="builtintype" id="3862536">true</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3862544">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3862552">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3862555">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3862558">hs</span><span class="op" id="3862560">.</span><span class="ident" id="3862561">ellipticOk</span>&nbsp;<span class="op" id="3862572">=</span>&nbsp;<span class="ident" id="3862574">supportedCurve</span>&nbsp;<span class="op" id="3862589">&amp;&amp;</span>&nbsp;<span class="ident" id="3862592">supportedPointFormat</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3862615">foundCompression</span>&nbsp;<span class="op" id="3862632">:=</span>&nbsp;<span class="builtintype" id="3862635">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3862642">//&nbsp;We&nbsp;only&nbsp;support&nbsp;null&nbsp;compression,&nbsp;so&nbsp;check&nbsp;that&nbsp;the&nbsp;client&nbsp;offered&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3862717">for</span>&nbsp;<span class="ident" id="3862721">_</span><span class="op" id="3862722">,</span>&nbsp;<span class="ident" id="3862724">compression</span>&nbsp;<span class="op" id="3862736">:=</span>&nbsp;<span class="keyword" id="3862739">range</span>&nbsp;<span class="ident" id="3862745">hs</span><span class="op" id="3862747">.</span><span class="ident" id="3862748">clientHello</span><span class="op" id="3862759">.</span><span class="ident" id="3862760">compressionMethods</span>&nbsp;<span class="op" id="3862779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3862783">if</span>&nbsp;<span class="ident" id="3862786">compression</span>&nbsp;<span class="op" id="3862798">==</span>&nbsp;<span class="ident" id="3862801">compressionNone</span>&nbsp;<span class="op" id="3862817">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3862822">foundCompression</span>&nbsp;<span class="op" id="3862839">=</span>&nbsp;<span class="builtintype" id="3862841">true</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3862849">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3862857">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3862860">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3862864">if</span>&nbsp;<span class="op" id="3862867">!</span><span class="ident" id="3862868">foundCompression</span>&nbsp;<span class="op" id="3862885">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3862889">c</span><span class="op" id="3862890">.</span><span class="ident" id="3862891">sendAlert</span><span class="op" id="3862900">(</span><span class="ident" id="3862901">alertHandshakeFailure</span><span class="op" id="3862922">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3862926">return</span>&nbsp;<span class="builtintype" id="3862933">false</span><span class="op" id="3862938">,</span>&nbsp;<span class="ident" id="3862940">errors</span><span class="op" id="3862946">.</span><span class="ident" id="3862947">New</span><span class="op" id="3862950">(</span><span class="string" id="3862951">&#34;tls:&nbsp;client&nbsp;does&nbsp;not&nbsp;support&nbsp;uncompressed&nbsp;connections&#34;</span><span class="op" id="3863006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3863009">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3863013">hs</span><span class="op" id="3863015">.</span><span class="ident" id="3863016">hello</span><span class="op" id="3863021">.</span><span class="ident" id="3863022">vers</span>&nbsp;<span class="op" id="3863027">=</span>&nbsp;<span class="ident" id="3863029">c</span><span class="op" id="3863030">.</span><span class="ident" id="3863031">vers</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3863037">hs</span><span class="op" id="3863039">.</span><span class="ident" id="3863040">hello</span><span class="op" id="3863045">.</span><span class="ident" id="3863046">random</span>&nbsp;<span class="op" id="3863053">=</span>&nbsp;<span class="builtinfunc" id="3863055">make</span><span class="op" id="3863059">(</span><span class="op" id="3863060">[</span><span class="op" id="3863061">]</span><span class="builtintype" id="3863062">byte</span><span class="op" id="3863066">,</span>&nbsp;<span class="num" id="3863068">32</span><span class="op" id="3863070">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3863073">_</span><span class="op" id="3863074">,</span>&nbsp;<span class="ident" id="3863076">err</span>&nbsp;<span class="op" id="3863080">=</span>&nbsp;<span class="ident" id="3863082">io</span><span class="op" id="3863084">.</span><span class="ident" id="3863085">ReadFull</span><span class="op" id="3863093">(</span><span class="ident" id="3863094">config</span><span class="op" id="3863100">.</span><span class="ident" id="3863101">rand</span><span class="op" id="3863105">(</span><span class="op" id="3863106">)</span><span class="op" id="3863107">,</span>&nbsp;<span class="ident" id="3863109">hs</span><span class="op" id="3863111">.</span><span class="ident" id="3863112">hello</span><span class="op" id="3863117">.</span><span class="ident" id="3863118">random</span><span class="op" id="3863124">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3863127">if</span>&nbsp;<span class="ident" id="3863130">err</span>&nbsp;<span class="op" id="3863134">!=</span>&nbsp;<span class="ident" id="3863137">nil</span>&nbsp;<span class="op" id="3863141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3863145">c</span><span class="op" id="3863146">.</span><span class="ident" id="3863147">sendAlert</span><span class="op" id="3863156">(</span><span class="ident" id="3863157">alertInternalError</span><span class="op" id="3863175">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3863179">return</span>&nbsp;<span class="builtintype" id="3863186">false</span><span class="op" id="3863191">,</span>&nbsp;<span class="ident" id="3863193">err</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3863198">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3863201">hs</span><span class="op" id="3863203">.</span><span class="ident" id="3863204">hello</span><span class="op" id="3863209">.</span><span class="ident" id="3863210">secureRenegotiation</span>&nbsp;<span class="op" id="3863230">=</span>&nbsp;<span class="ident" id="3863232">hs</span><span class="op" id="3863234">.</span><span class="ident" id="3863235">clientHello</span><span class="op" id="3863246">.</span><span class="ident" id="3863247">secureRenegotiation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3863268">hs</span><span class="op" id="3863270">.</span><span class="ident" id="3863271">hello</span><span class="op" id="3863276">.</span><span class="ident" id="3863277">compressionMethod</span>&nbsp;<span class="op" id="3863295">=</span>&nbsp;<span class="ident" id="3863297">compressionNone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3863314">if</span>&nbsp;<span class="builtinfunc" id="3863317">len</span><span class="op" id="3863320">(</span><span class="ident" id="3863321">hs</span><span class="op" id="3863323">.</span><span class="ident" id="3863324">clientHello</span><span class="op" id="3863335">.</span><span class="ident" id="3863336">serverName</span><span class="op" id="3863346">)</span>&nbsp;<span class="op" id="3863348">&gt;</span>&nbsp;<span class="num" id="3863350">0</span>&nbsp;<span class="op" id="3863352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3863356">c</span><span class="op" id="3863357">.</span><span class="ident" id="3863358">serverName</span>&nbsp;<span class="op" id="3863369">=</span>&nbsp;<span class="ident" id="3863371">hs</span><span class="op" id="3863373">.</span><span class="ident" id="3863374">clientHello</span><span class="op" id="3863385">.</span><span class="ident" id="3863386">serverName</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3863398">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3863402">if</span>&nbsp;<span class="builtinfunc" id="3863405">len</span><span class="op" id="3863408">(</span><span class="ident" id="3863409">hs</span><span class="op" id="3863411">.</span><span class="ident" id="3863412">clientHello</span><span class="op" id="3863423">.</span><span class="ident" id="3863424">alpnProtocols</span><span class="op" id="3863437">)</span>&nbsp;<span class="op" id="3863439">&gt;</span>&nbsp;<span class="num" id="3863441">0</span>&nbsp;<span class="op" id="3863443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3863447">if</span>&nbsp;<span class="ident" id="3863450">selectedProto</span><span class="op" id="3863463">,</span>&nbsp;<span class="ident" id="3863465">fallback</span>&nbsp;<span class="op" id="3863474">:=</span>&nbsp;<span class="ident" id="3863477">mutualProtocol</span><span class="op" id="3863491">(</span><span class="ident" id="3863492">hs</span><span class="op" id="3863494">.</span><span class="ident" id="3863495">clientHello</span><span class="op" id="3863506">.</span><span class="ident" id="3863507">alpnProtocols</span><span class="op" id="3863520">,</span>&nbsp;<span class="ident" id="3863522">c</span><span class="op" id="3863523">.</span><span class="ident" id="3863524">config</span><span class="op" id="3863530">.</span><span class="ident" id="3863531">NextProtos</span><span class="op" id="3863541">)</span><span class="op" id="3863542">;</span>&nbsp;<span class="op" id="3863544">!</span><span class="ident" id="3863545">fallback</span>&nbsp;<span class="op" id="3863554">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3863559">hs</span><span class="op" id="3863561">.</span><span class="ident" id="3863562">hello</span><span class="op" id="3863567">.</span><span class="ident" id="3863568">alpnProtocol</span>&nbsp;<span class="op" id="3863581">=</span>&nbsp;<span class="ident" id="3863583">selectedProto</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3863600">c</span><span class="op" id="3863601">.</span><span class="ident" id="3863602">clientProtocol</span>&nbsp;<span class="op" id="3863617">=</span>&nbsp;<span class="ident" id="3863619">selectedProto</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3863635">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3863638">}</span>&nbsp;<span class="keyword" id="3863640">else</span>&nbsp;<span class="op" id="3863645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3863649">//&nbsp;Although&nbsp;sending&nbsp;an&nbsp;empty&nbsp;NPN&nbsp;extension&nbsp;is&nbsp;reasonable,&nbsp;Firefox&nbsp;has</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3863721">//&nbsp;had&nbsp;a&nbsp;bug&nbsp;around&nbsp;this.&nbsp;Best&nbsp;to&nbsp;send&nbsp;nothing&nbsp;at&nbsp;all&nbsp;if</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3863780">//&nbsp;config.NextProtos&nbsp;is&nbsp;empty.&nbsp;See</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3863817">//&nbsp;https://code.google.com/p/go/issues/detail?id=5445.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3863874">if</span>&nbsp;<span class="ident" id="3863877">hs</span><span class="op" id="3863879">.</span><span class="ident" id="3863880">clientHello</span><span class="op" id="3863891">.</span><span class="ident" id="3863892">nextProtoNeg</span>&nbsp;<span class="op" id="3863905">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3863908">len</span><span class="op" id="3863911">(</span><span class="ident" id="3863912">config</span><span class="op" id="3863918">.</span><span class="ident" id="3863919">NextProtos</span><span class="op" id="3863929">)</span>&nbsp;<span class="op" id="3863931">&gt;</span>&nbsp;<span class="num" id="3863933">0</span>&nbsp;<span class="op" id="3863935">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3863940">hs</span><span class="op" id="3863942">.</span><span class="ident" id="3863943">hello</span><span class="op" id="3863948">.</span><span class="ident" id="3863949">nextProtoNeg</span>&nbsp;<span class="op" id="3863962">=</span>&nbsp;<span class="builtintype" id="3863964">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3863972">hs</span><span class="op" id="3863974">.</span><span class="ident" id="3863975">hello</span><span class="op" id="3863980">.</span><span class="ident" id="3863981">nextProtos</span>&nbsp;<span class="op" id="3863992">=</span>&nbsp;<span class="ident" id="3863994">config</span><span class="op" id="3864000">.</span><span class="ident" id="3864001">NextProtos</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3864014">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3864017">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3864021">if</span>&nbsp;<span class="builtinfunc" id="3864024">len</span><span class="op" id="3864027">(</span><span class="ident" id="3864028">config</span><span class="op" id="3864034">.</span><span class="ident" id="3864035">Certificates</span><span class="op" id="3864047">)</span>&nbsp;<span class="op" id="3864049">==</span>&nbsp;<span class="num" id="3864052">0</span>&nbsp;<span class="op" id="3864054">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3864058">c</span><span class="op" id="3864059">.</span><span class="ident" id="3864060">sendAlert</span><span class="op" id="3864069">(</span><span class="ident" id="3864070">alertInternalError</span><span class="op" id="3864088">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3864092">return</span>&nbsp;<span class="builtintype" id="3864099">false</span><span class="op" id="3864104">,</span>&nbsp;<span class="ident" id="3864106">errors</span><span class="op" id="3864112">.</span><span class="ident" id="3864113">New</span><span class="op" id="3864116">(</span><span class="string" id="3864117">&#34;tls:&nbsp;no&nbsp;certificates&nbsp;configured&#34;</span><span class="op" id="3864150">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3864153">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3864156">hs</span><span class="op" id="3864158">.</span><span class="ident" id="3864159">cert</span>&nbsp;<span class="op" id="3864164">=</span>&nbsp;<span class="op" id="3864166">&amp;</span><span class="ident" id="3864167">config</span><span class="op" id="3864173">.</span><span class="ident" id="3864174">Certificates</span><span class="op" id="3864186">[</span><span class="num" id="3864187">0</span><span class="op" id="3864188">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3864191">if</span>&nbsp;<span class="builtinfunc" id="3864194">len</span><span class="op" id="3864197">(</span><span class="ident" id="3864198">hs</span><span class="op" id="3864200">.</span><span class="ident" id="3864201">clientHello</span><span class="op" id="3864212">.</span><span class="ident" id="3864213">serverName</span><span class="op" id="3864223">)</span>&nbsp;<span class="op" id="3864225">&gt;</span>&nbsp;<span class="num" id="3864227">0</span>&nbsp;<span class="op" id="3864229">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3864233">chi</span>&nbsp;<span class="op" id="3864237">:=</span>&nbsp;<span class="op" id="3864240">&amp;</span><span class="ident" id="3864241">ClientHelloInfo</span><span class="op" id="3864256">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3864261">CipherSuites</span><span class="op" id="3864273">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3864278">hs</span><span class="op" id="3864280">.</span><span class="ident" id="3864281">clientHello</span><span class="op" id="3864292">.</span><span class="ident" id="3864293">cipherSuites</span><span class="op" id="3864305">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3864310">ServerName</span><span class="op" id="3864320">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3864327">hs</span><span class="op" id="3864329">.</span><span class="ident" id="3864330">clientHello</span><span class="op" id="3864341">.</span><span class="ident" id="3864342">serverName</span><span class="op" id="3864352">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3864357">SupportedCurves</span><span class="op" id="3864372">:</span>&nbsp;<span class="ident" id="3864374">hs</span><span class="op" id="3864376">.</span><span class="ident" id="3864377">clientHello</span><span class="op" id="3864388">.</span><span class="ident" id="3864389">supportedCurves</span><span class="op" id="3864404">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3864409">SupportedPoints</span><span class="op" id="3864424">:</span>&nbsp;<span class="ident" id="3864426">hs</span><span class="op" id="3864428">.</span><span class="ident" id="3864429">clientHello</span><span class="op" id="3864440">.</span><span class="ident" id="3864441">supportedPoints</span><span class="op" id="3864456">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3864460">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3864464">if</span>&nbsp;<span class="ident" id="3864467">hs</span><span class="op" id="3864469">.</span><span class="ident" id="3864470">cert</span><span class="op" id="3864474">,</span>&nbsp;<span class="ident" id="3864476">err</span>&nbsp;<span class="op" id="3864480">=</span>&nbsp;<span class="ident" id="3864482">config</span><span class="op" id="3864488">.</span><span class="ident" id="3864489">getCertificate</span><span class="op" id="3864503">(</span><span class="ident" id="3864504">chi</span><span class="op" id="3864507">)</span><span class="op" id="3864508">;</span>&nbsp;<span class="ident" id="3864510">err</span>&nbsp;<span class="op" id="3864514">!=</span>&nbsp;<span class="ident" id="3864517">nil</span>&nbsp;<span class="op" id="3864521">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3864526">c</span><span class="op" id="3864527">.</span><span class="ident" id="3864528">sendAlert</span><span class="op" id="3864537">(</span><span class="ident" id="3864538">alertInternalError</span><span class="op" id="3864556">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3864561">return</span>&nbsp;<span class="builtintype" id="3864568">false</span><span class="op" id="3864573">,</span>&nbsp;<span class="ident" id="3864575">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3864581">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3864584">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3864588">_</span><span class="op" id="3864589">,</span>&nbsp;<span class="ident" id="3864591">hs</span><span class="op" id="3864593">.</span><span class="ident" id="3864594">ecdsaOk</span>&nbsp;<span class="op" id="3864602">=</span>&nbsp;<span class="ident" id="3864604">hs</span><span class="op" id="3864606">.</span><span class="ident" id="3864607">cert</span><span class="op" id="3864611">.</span><span class="ident" id="3864612">PrivateKey</span><span class="op" id="3864622">.</span><span class="op" id="3864623">(</span><span class="op" id="3864624">*</span><span class="ident" id="3864625">ecdsa</span><span class="op" id="3864630">.</span><span class="ident" id="3864631">PrivateKey</span><span class="op" id="3864641">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3864645">if</span>&nbsp;<span class="ident" id="3864648">hs</span><span class="op" id="3864650">.</span><span class="ident" id="3864651">checkForResumption</span><span class="op" id="3864669">(</span><span class="op" id="3864670">)</span>&nbsp;<span class="op" id="3864672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3864676">return</span>&nbsp;<span class="builtintype" id="3864683">true</span><span class="op" id="3864687">,</span>&nbsp;<span class="ident" id="3864689">nil</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3864694">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3864698">var</span>&nbsp;<span class="ident" id="3864702">preferenceList</span><span class="op" id="3864716">,</span>&nbsp;<span class="ident" id="3864718">supportedList</span>&nbsp;<span class="op" id="3864732">[</span><span class="op" id="3864733">]</span><span class="builtintype" id="3864734">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3864742">if</span>&nbsp;<span class="ident" id="3864745">c</span><span class="op" id="3864746">.</span><span class="ident" id="3864747">config</span><span class="op" id="3864753">.</span><span class="ident" id="3864754">PreferServerCipherSuites</span>&nbsp;<span class="op" id="3864779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3864783">preferenceList</span>&nbsp;<span class="op" id="3864798">=</span>&nbsp;<span class="ident" id="3864800">c</span><span class="op" id="3864801">.</span><span class="ident" id="3864802">config</span><span class="op" id="3864808">.</span><span class="ident" id="3864809">cipherSuites</span><span class="op" id="3864821">(</span><span class="op" id="3864822">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3864826">supportedList</span>&nbsp;<span class="op" id="3864840">=</span>&nbsp;<span class="ident" id="3864842">hs</span><span class="op" id="3864844">.</span><span class="ident" id="3864845">clientHello</span><span class="op" id="3864856">.</span><span class="ident" id="3864857">cipherSuites</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3864871">}</span>&nbsp;<span class="keyword" id="3864873">else</span>&nbsp;<span class="op" id="3864878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3864882">preferenceList</span>&nbsp;<span class="op" id="3864897">=</span>&nbsp;<span class="ident" id="3864899">hs</span><span class="op" id="3864901">.</span><span class="ident" id="3864902">clientHello</span><span class="op" id="3864913">.</span><span class="ident" id="3864914">cipherSuites</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3864929">supportedList</span>&nbsp;<span class="op" id="3864943">=</span>&nbsp;<span class="ident" id="3864945">c</span><span class="op" id="3864946">.</span><span class="ident" id="3864947">config</span><span class="op" id="3864953">.</span><span class="ident" id="3864954">cipherSuites</span><span class="op" id="3864966">(</span><span class="op" id="3864967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3864970">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3864974">for</span>&nbsp;<span class="ident" id="3864978">_</span><span class="op" id="3864979">,</span>&nbsp;<span class="ident" id="3864981">id</span>&nbsp;<span class="op" id="3864984">:=</span>&nbsp;<span class="keyword" id="3864987">range</span>&nbsp;<span class="ident" id="3864993">preferenceList</span>&nbsp;<span class="op" id="3865008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3865012">if</span>&nbsp;<span class="ident" id="3865015">hs</span><span class="op" id="3865017">.</span><span class="ident" id="3865018">suite</span>&nbsp;<span class="op" id="3865024">=</span>&nbsp;<span class="ident" id="3865026">c</span><span class="op" id="3865027">.</span><span class="ident" id="3865028">tryCipherSuite</span><span class="op" id="3865042">(</span><span class="ident" id="3865043">id</span><span class="op" id="3865045">,</span>&nbsp;<span class="ident" id="3865047">supportedList</span><span class="op" id="3865060">,</span>&nbsp;<span class="ident" id="3865062">c</span><span class="op" id="3865063">.</span><span class="ident" id="3865064">vers</span><span class="op" id="3865068">,</span>&nbsp;<span class="ident" id="3865070">hs</span><span class="op" id="3865072">.</span><span class="ident" id="3865073">ellipticOk</span><span class="op" id="3865083">,</span>&nbsp;<span class="ident" id="3865085">hs</span><span class="op" id="3865087">.</span><span class="ident" id="3865088">ecdsaOk</span><span class="op" id="3865095">)</span><span class="op" id="3865096">;</span>&nbsp;<span class="ident" id="3865098">hs</span><span class="op" id="3865100">.</span><span class="ident" id="3865101">suite</span>&nbsp;<span class="op" id="3865107">!=</span>&nbsp;<span class="ident" id="3865110">nil</span>&nbsp;<span class="op" id="3865114">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3865119">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3865127">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3865130">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3865134">if</span>&nbsp;<span class="ident" id="3865137">hs</span><span class="op" id="3865139">.</span><span class="ident" id="3865140">suite</span>&nbsp;<span class="op" id="3865146">==</span>&nbsp;<span class="ident" id="3865149">nil</span>&nbsp;<span class="op" id="3865153">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3865157">c</span><span class="op" id="3865158">.</span><span class="ident" id="3865159">sendAlert</span><span class="op" id="3865168">(</span><span class="ident" id="3865169">alertHandshakeFailure</span><span class="op" id="3865190">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3865194">return</span>&nbsp;<span class="builtintype" id="3865201">false</span><span class="op" id="3865206">,</span>&nbsp;<span class="ident" id="3865208">errors</span><span class="op" id="3865214">.</span><span class="ident" id="3865215">New</span><span class="op" id="3865218">(</span><span class="string" id="3865219">&#34;tls:&nbsp;no&nbsp;cipher&nbsp;suite&nbsp;supported&nbsp;by&nbsp;both&nbsp;client&nbsp;and&nbsp;server&#34;</span><span class="op" id="3865277">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3865280">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3865284">//&nbsp;See&nbsp;https://tools.ietf.org/html/draft-ietf-tls-downgrade-scsv-00.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3865354">for</span>&nbsp;<span class="ident" id="3865358">_</span><span class="op" id="3865359">,</span>&nbsp;<span class="ident" id="3865361">id</span>&nbsp;<span class="op" id="3865364">:=</span>&nbsp;<span class="keyword" id="3865367">range</span>&nbsp;<span class="ident" id="3865373">hs</span><span class="op" id="3865375">.</span><span class="ident" id="3865376">clientHello</span><span class="op" id="3865387">.</span><span class="ident" id="3865388">cipherSuites</span>&nbsp;<span class="op" id="3865401">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3865405">if</span>&nbsp;<span class="ident" id="3865408">id</span>&nbsp;<span class="op" id="3865411">==</span>&nbsp;<span class="ident" id="3865414">TLS_FALLBACK_SCSV</span>&nbsp;<span class="op" id="3865432">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3865437">//&nbsp;The&nbsp;client&nbsp;is&nbsp;doing&nbsp;a&nbsp;fallback&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3865486">if</span>&nbsp;<span class="ident" id="3865489">hs</span><span class="op" id="3865491">.</span><span class="ident" id="3865492">clientHello</span><span class="op" id="3865503">.</span><span class="ident" id="3865504">vers</span>&nbsp;<span class="op" id="3865509">&lt;</span>&nbsp;<span class="ident" id="3865511">c</span><span class="op" id="3865512">.</span><span class="ident" id="3865513">config</span><span class="op" id="3865519">.</span><span class="ident" id="3865520">MaxVersion</span>&nbsp;<span class="op" id="3865531">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3865537">c</span><span class="op" id="3865538">.</span><span class="ident" id="3865539">sendAlert</span><span class="op" id="3865548">(</span><span class="ident" id="3865549">alertInappropriateFallback</span><span class="op" id="3865575">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3865581">return</span>&nbsp;<span class="builtintype" id="3865588">false</span><span class="op" id="3865593">,</span>&nbsp;<span class="ident" id="3865595">errors</span><span class="op" id="3865601">.</span><span class="ident" id="3865602">New</span><span class="op" id="3865605">(</span><span class="string" id="3865606">&#34;tls:&nbsp;client&nbsp;using&nbsp;inppropriate&nbsp;protocol&nbsp;fallback&#34;</span><span class="op" id="3865656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3865661">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3865666">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3865674">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3865677">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3865681">return</span>&nbsp;<span class="builtintype" id="3865688">false</span><span class="op" id="3865693">,</span>&nbsp;<span class="ident" id="3865695">nil</span><br>
<span class="lineno">240</span><span class="op" id="3865699">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3865702">//&nbsp;checkForResumption&nbsp;returns&nbsp;true&nbsp;if&nbsp;we&nbsp;should&nbsp;perform&nbsp;resumption&nbsp;on&nbsp;this&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3865789">func</span>&nbsp;<span class="op" id="3865794">(</span><span class="ident" id="3865795">hs</span>&nbsp;<span class="op" id="3865798">*</span><span class="ident" id="3865799">serverHandshakeState</span><span class="op" id="3865819">)</span>&nbsp;<span class="ident" id="3865821">checkForResumption</span><span class="op" id="3865839">(</span><span class="op" id="3865840">)</span>&nbsp;<span class="builtintype" id="3865842">bool</span>&nbsp;<span class="op" id="3865847">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3865850">c</span>&nbsp;<span class="op" id="3865852">:=</span>&nbsp;<span class="ident" id="3865855">hs</span><span class="op" id="3865857">.</span><span class="ident" id="3865858">c</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3865862">if</span>&nbsp;<span class="ident" id="3865865">c</span><span class="op" id="3865866">.</span><span class="ident" id="3865867">config</span><span class="op" id="3865873">.</span><span class="ident" id="3865874">SessionTicketsDisabled</span>&nbsp;<span class="op" id="3865897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3865901">return</span>&nbsp;<span class="builtintype" id="3865908">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3865915">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3865919">var</span>&nbsp;<span class="ident" id="3865923">ok</span>&nbsp;<span class="builtintype" id="3865926">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3865932">if</span>&nbsp;<span class="ident" id="3865935">hs</span><span class="op" id="3865937">.</span><span class="ident" id="3865938">sessionState</span><span class="op" id="3865950">,</span>&nbsp;<span class="ident" id="3865952">ok</span>&nbsp;<span class="op" id="3865955">=</span>&nbsp;<span class="ident" id="3865957">c</span><span class="op" id="3865958">.</span><span class="ident" id="3865959">decryptTicket</span><span class="op" id="3865972">(</span><span class="ident" id="3865973">hs</span><span class="op" id="3865975">.</span><span class="ident" id="3865976">clientHello</span><span class="op" id="3865987">.</span><span class="ident" id="3865988">sessionTicket</span><span class="op" id="3866001">)</span><span class="op" id="3866002">;</span>&nbsp;<span class="op" id="3866004">!</span><span class="ident" id="3866005">ok</span>&nbsp;<span class="op" id="3866008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3866012">return</span>&nbsp;<span class="builtintype" id="3866019">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3866026">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3866030">if</span>&nbsp;<span class="ident" id="3866033">hs</span><span class="op" id="3866035">.</span><span class="ident" id="3866036">sessionState</span><span class="op" id="3866048">.</span><span class="ident" id="3866049">vers</span>&nbsp;<span class="op" id="3866054">&gt;</span>&nbsp;<span class="ident" id="3866056">hs</span><span class="op" id="3866058">.</span><span class="ident" id="3866059">clientHello</span><span class="op" id="3866070">.</span><span class="ident" id="3866071">vers</span>&nbsp;<span class="op" id="3866076">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3866080">return</span>&nbsp;<span class="builtintype" id="3866087">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3866094">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3866097">if</span>&nbsp;<span class="ident" id="3866100">vers</span><span class="op" id="3866104">,</span>&nbsp;<span class="ident" id="3866106">ok</span>&nbsp;<span class="op" id="3866109">:=</span>&nbsp;<span class="ident" id="3866112">c</span><span class="op" id="3866113">.</span><span class="ident" id="3866114">config</span><span class="op" id="3866120">.</span><span class="ident" id="3866121">mutualVersion</span><span class="op" id="3866134">(</span><span class="ident" id="3866135">hs</span><span class="op" id="3866137">.</span><span class="ident" id="3866138">sessionState</span><span class="op" id="3866150">.</span><span class="ident" id="3866151">vers</span><span class="op" id="3866155">)</span><span class="op" id="3866156">;</span>&nbsp;<span class="op" id="3866158">!</span><span class="ident" id="3866159">ok</span>&nbsp;<span class="op" id="3866162">||</span>&nbsp;<span class="ident" id="3866165">vers</span>&nbsp;<span class="op" id="3866170">!=</span>&nbsp;<span class="ident" id="3866173">hs</span><span class="op" id="3866175">.</span><span class="ident" id="3866176">sessionState</span><span class="op" id="3866188">.</span><span class="ident" id="3866189">vers</span>&nbsp;<span class="op" id="3866194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3866198">return</span>&nbsp;<span class="builtintype" id="3866205">false</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3866212">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3866216">cipherSuiteOk</span>&nbsp;<span class="op" id="3866230">:=</span>&nbsp;<span class="builtintype" id="3866233">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3866240">//&nbsp;Check&nbsp;that&nbsp;the&nbsp;client&nbsp;is&nbsp;still&nbsp;offering&nbsp;the&nbsp;ciphersuite&nbsp;in&nbsp;the&nbsp;session.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3866316">for</span>&nbsp;<span class="ident" id="3866320">_</span><span class="op" id="3866321">,</span>&nbsp;<span class="ident" id="3866323">id</span>&nbsp;<span class="op" id="3866326">:=</span>&nbsp;<span class="keyword" id="3866329">range</span>&nbsp;<span class="ident" id="3866335">hs</span><span class="op" id="3866337">.</span><span class="ident" id="3866338">clientHello</span><span class="op" id="3866349">.</span><span class="ident" id="3866350">cipherSuites</span>&nbsp;<span class="op" id="3866363">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3866367">if</span>&nbsp;<span class="ident" id="3866370">id</span>&nbsp;<span class="op" id="3866373">==</span>&nbsp;<span class="ident" id="3866376">hs</span><span class="op" id="3866378">.</span><span class="ident" id="3866379">sessionState</span><span class="op" id="3866391">.</span><span class="ident" id="3866392">cipherSuite</span>&nbsp;<span class="op" id="3866404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3866409">cipherSuiteOk</span>&nbsp;<span class="op" id="3866423">=</span>&nbsp;<span class="builtintype" id="3866425">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3866433">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3866441">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3866444">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3866447">if</span>&nbsp;<span class="op" id="3866450">!</span><span class="ident" id="3866451">cipherSuiteOk</span>&nbsp;<span class="op" id="3866465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3866469">return</span>&nbsp;<span class="builtintype" id="3866476">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3866483">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3866487">//&nbsp;Check&nbsp;that&nbsp;we&nbsp;also&nbsp;support&nbsp;the&nbsp;ciphersuite&nbsp;from&nbsp;the&nbsp;session.</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3866552">hs</span><span class="op" id="3866554">.</span><span class="ident" id="3866555">suite</span>&nbsp;<span class="op" id="3866561">=</span>&nbsp;<span class="ident" id="3866563">c</span><span class="op" id="3866564">.</span><span class="ident" id="3866565">tryCipherSuite</span><span class="op" id="3866579">(</span><span class="ident" id="3866580">hs</span><span class="op" id="3866582">.</span><span class="ident" id="3866583">sessionState</span><span class="op" id="3866595">.</span><span class="ident" id="3866596">cipherSuite</span><span class="op" id="3866607">,</span>&nbsp;<span class="ident" id="3866609">c</span><span class="op" id="3866610">.</span><span class="ident" id="3866611">config</span><span class="op" id="3866617">.</span><span class="ident" id="3866618">cipherSuites</span><span class="op" id="3866630">(</span><span class="op" id="3866631">)</span><span class="op" id="3866632">,</span>&nbsp;<span class="ident" id="3866634">hs</span><span class="op" id="3866636">.</span><span class="ident" id="3866637">sessionState</span><span class="op" id="3866649">.</span><span class="ident" id="3866650">vers</span><span class="op" id="3866654">,</span>&nbsp;<span class="ident" id="3866656">hs</span><span class="op" id="3866658">.</span><span class="ident" id="3866659">ellipticOk</span><span class="op" id="3866669">,</span>&nbsp;<span class="ident" id="3866671">hs</span><span class="op" id="3866673">.</span><span class="ident" id="3866674">ecdsaOk</span><span class="op" id="3866681">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3866684">if</span>&nbsp;<span class="ident" id="3866687">hs</span><span class="op" id="3866689">.</span><span class="ident" id="3866690">suite</span>&nbsp;<span class="op" id="3866696">==</span>&nbsp;<span class="ident" id="3866699">nil</span>&nbsp;<span class="op" id="3866703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3866707">return</span>&nbsp;<span class="builtintype" id="3866714">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3866721">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3866725">sessionHasClientCerts</span>&nbsp;<span class="op" id="3866747">:=</span>&nbsp;<span class="builtinfunc" id="3866750">len</span><span class="op" id="3866753">(</span><span class="ident" id="3866754">hs</span><span class="op" id="3866756">.</span><span class="ident" id="3866757">sessionState</span><span class="op" id="3866769">.</span><span class="ident" id="3866770">certificates</span><span class="op" id="3866782">)</span>&nbsp;<span class="op" id="3866784">!=</span>&nbsp;<span class="num" id="3866787">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3866790">needClientCerts</span>&nbsp;<span class="op" id="3866806">:=</span>&nbsp;<span class="ident" id="3866809">c</span><span class="op" id="3866810">.</span><span class="ident" id="3866811">config</span><span class="op" id="3866817">.</span><span class="ident" id="3866818">ClientAuth</span>&nbsp;<span class="op" id="3866829">==</span>&nbsp;<span class="ident" id="3866832">RequireAnyClientCert</span>&nbsp;<span class="op" id="3866853">||</span>&nbsp;<span class="ident" id="3866856">c</span><span class="op" id="3866857">.</span><span class="ident" id="3866858">config</span><span class="op" id="3866864">.</span><span class="ident" id="3866865">ClientAuth</span>&nbsp;<span class="op" id="3866876">==</span>&nbsp;<span class="ident" id="3866879">RequireAndVerifyClientCert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3866907">if</span>&nbsp;<span class="ident" id="3866910">needClientCerts</span>&nbsp;<span class="op" id="3866926">&amp;&amp;</span>&nbsp;<span class="op" id="3866929">!</span><span class="ident" id="3866930">sessionHasClientCerts</span>&nbsp;<span class="op" id="3866952">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3866956">return</span>&nbsp;<span class="builtintype" id="3866963">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3866970">}</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3866973">if</span>&nbsp;<span class="ident" id="3866976">sessionHasClientCerts</span>&nbsp;<span class="op" id="3866998">&amp;&amp;</span>&nbsp;<span class="ident" id="3867001">c</span><span class="op" id="3867002">.</span><span class="ident" id="3867003">config</span><span class="op" id="3867009">.</span><span class="ident" id="3867010">ClientAuth</span>&nbsp;<span class="op" id="3867021">==</span>&nbsp;<span class="ident" id="3867024">NoClientCert</span>&nbsp;<span class="op" id="3867037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3867041">return</span>&nbsp;<span class="builtintype" id="3867048">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3867055">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3867059">return</span>&nbsp;<span class="builtintype" id="3867066">true</span><br>
<span class="lineno">290</span><span class="op" id="3867071">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3867074">func</span>&nbsp;<span class="op" id="3867079">(</span><span class="ident" id="3867080">hs</span>&nbsp;<span class="op" id="3867083">*</span><span class="ident" id="3867084">serverHandshakeState</span><span class="op" id="3867104">)</span>&nbsp;<span class="ident" id="3867106">doResumeHandshake</span><span class="op" id="3867123">(</span><span class="op" id="3867124">)</span>&nbsp;<span class="builtintype" id="3867126">error</span>&nbsp;<span class="op" id="3867132">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3867135">c</span>&nbsp;<span class="op" id="3867137">:=</span>&nbsp;<span class="ident" id="3867140">hs</span><span class="op" id="3867142">.</span><span class="ident" id="3867143">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3867147">hs</span><span class="op" id="3867149">.</span><span class="ident" id="3867150">hello</span><span class="op" id="3867155">.</span><span class="ident" id="3867156">cipherSuite</span>&nbsp;<span class="op" id="3867168">=</span>&nbsp;<span class="ident" id="3867170">hs</span><span class="op" id="3867172">.</span><span class="ident" id="3867173">suite</span><span class="op" id="3867178">.</span><span class="ident" id="3867179">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3867183">//&nbsp;We&nbsp;echo&nbsp;the&nbsp;client&#39;s&nbsp;session&nbsp;ID&nbsp;in&nbsp;the&nbsp;ServerHello&nbsp;to&nbsp;let&nbsp;it&nbsp;know</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3867253">//&nbsp;that&nbsp;we&#39;re&nbsp;doing&nbsp;a&nbsp;resumption.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3867288">hs</span><span class="op" id="3867290">.</span><span class="ident" id="3867291">hello</span><span class="op" id="3867296">.</span><span class="ident" id="3867297">sessionId</span>&nbsp;<span class="op" id="3867307">=</span>&nbsp;<span class="ident" id="3867309">hs</span><span class="op" id="3867311">.</span><span class="ident" id="3867312">clientHello</span><span class="op" id="3867323">.</span><span class="ident" id="3867324">sessionId</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3867335">hs</span><span class="op" id="3867337">.</span><span class="ident" id="3867338">finishedHash</span><span class="op" id="3867350">.</span><span class="ident" id="3867351">Write</span><span class="op" id="3867356">(</span><span class="ident" id="3867357">hs</span><span class="op" id="3867359">.</span><span class="ident" id="3867360">hello</span><span class="op" id="3867365">.</span><span class="ident" id="3867366">marshal</span><span class="op" id="3867373">(</span><span class="op" id="3867374">)</span><span class="op" id="3867375">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3867378">c</span><span class="op" id="3867379">.</span><span class="ident" id="3867380">writeRecord</span><span class="op" id="3867391">(</span><span class="ident" id="3867392">recordTypeHandshake</span><span class="op" id="3867411">,</span>&nbsp;<span class="ident" id="3867413">hs</span><span class="op" id="3867415">.</span><span class="ident" id="3867416">hello</span><span class="op" id="3867421">.</span><span class="ident" id="3867422">marshal</span><span class="op" id="3867429">(</span><span class="op" id="3867430">)</span><span class="op" id="3867431">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3867435">if</span>&nbsp;<span class="builtinfunc" id="3867438">len</span><span class="op" id="3867441">(</span><span class="ident" id="3867442">hs</span><span class="op" id="3867444">.</span><span class="ident" id="3867445">sessionState</span><span class="op" id="3867457">.</span><span class="ident" id="3867458">certificates</span><span class="op" id="3867470">)</span>&nbsp;<span class="op" id="3867472">&gt;</span>&nbsp;<span class="num" id="3867474">0</span>&nbsp;<span class="op" id="3867476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3867480">if</span>&nbsp;<span class="ident" id="3867483">_</span><span class="op" id="3867484">,</span>&nbsp;<span class="ident" id="3867486">err</span>&nbsp;<span class="op" id="3867490">:=</span>&nbsp;<span class="ident" id="3867493">hs</span><span class="op" id="3867495">.</span><span class="ident" id="3867496">processCertsFromClient</span><span class="op" id="3867518">(</span><span class="ident" id="3867519">hs</span><span class="op" id="3867521">.</span><span class="ident" id="3867522">sessionState</span><span class="op" id="3867534">.</span><span class="ident" id="3867535">certificates</span><span class="op" id="3867547">)</span><span class="op" id="3867548">;</span>&nbsp;<span class="ident" id="3867550">err</span>&nbsp;<span class="op" id="3867554">!=</span>&nbsp;<span class="ident" id="3867557">nil</span>&nbsp;<span class="op" id="3867561">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3867566">return</span>&nbsp;<span class="ident" id="3867573">err</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3867579">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3867582">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3867586">hs</span><span class="op" id="3867588">.</span><span class="ident" id="3867589">masterSecret</span>&nbsp;<span class="op" id="3867602">=</span>&nbsp;<span class="ident" id="3867604">hs</span><span class="op" id="3867606">.</span><span class="ident" id="3867607">sessionState</span><span class="op" id="3867619">.</span><span class="ident" id="3867620">masterSecret</span><br>
<span class="lineno"></span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3867635">return</span>&nbsp;<span class="ident" id="3867642">nil</span><br>
<span class="lineno"></span><span class="op" id="3867646">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3867649">func</span>&nbsp;<span class="op" id="3867654">(</span><span class="ident" id="3867655">hs</span>&nbsp;<span class="op" id="3867658">*</span><span class="ident" id="3867659">serverHandshakeState</span><span class="op" id="3867679">)</span>&nbsp;<span class="ident" id="3867681">doFullHandshake</span><span class="op" id="3867696">(</span><span class="op" id="3867697">)</span>&nbsp;<span class="builtintype" id="3867699">error</span>&nbsp;<span class="op" id="3867705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3867708">config</span>&nbsp;<span class="op" id="3867715">:=</span>&nbsp;<span class="ident" id="3867718">hs</span><span class="op" id="3867720">.</span><span class="ident" id="3867721">c</span><span class="op" id="3867722">.</span><span class="ident" id="3867723">config</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3867731">c</span>&nbsp;<span class="op" id="3867733">:=</span>&nbsp;<span class="ident" id="3867736">hs</span><span class="op" id="3867738">.</span><span class="ident" id="3867739">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3867743">if</span>&nbsp;<span class="ident" id="3867746">hs</span><span class="op" id="3867748">.</span><span class="ident" id="3867749">clientHello</span><span class="op" id="3867760">.</span><span class="ident" id="3867761">ocspStapling</span>&nbsp;<span class="op" id="3867774">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3867777">len</span><span class="op" id="3867780">(</span><span class="ident" id="3867781">hs</span><span class="op" id="3867783">.</span><span class="ident" id="3867784">cert</span><span class="op" id="3867788">.</span><span class="ident" id="3867789">OCSPStaple</span><span class="op" id="3867799">)</span>&nbsp;<span class="op" id="3867801">&gt;</span>&nbsp;<span class="num" id="3867803">0</span>&nbsp;<span class="op" id="3867805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3867809">hs</span><span class="op" id="3867811">.</span><span class="ident" id="3867812">hello</span><span class="op" id="3867817">.</span><span class="ident" id="3867818">ocspStapling</span>&nbsp;<span class="op" id="3867831">=</span>&nbsp;<span class="builtintype" id="3867833">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3867839">}</span><br>
<span class="lineno">320</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3867843">hs</span><span class="op" id="3867845">.</span><span class="ident" id="3867846">hello</span><span class="op" id="3867851">.</span><span class="ident" id="3867852">ticketSupported</span>&nbsp;<span class="op" id="3867868">=</span>&nbsp;<span class="ident" id="3867870">hs</span><span class="op" id="3867872">.</span><span class="ident" id="3867873">clientHello</span><span class="op" id="3867884">.</span><span class="ident" id="3867885">ticketSupported</span>&nbsp;<span class="op" id="3867901">&amp;&amp;</span>&nbsp;<span class="op" id="3867904">!</span><span class="ident" id="3867905">config</span><span class="op" id="3867911">.</span><span class="ident" id="3867912">SessionTicketsDisabled</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3867936">hs</span><span class="op" id="3867938">.</span><span class="ident" id="3867939">hello</span><span class="op" id="3867944">.</span><span class="ident" id="3867945">cipherSuite</span>&nbsp;<span class="op" id="3867957">=</span>&nbsp;<span class="ident" id="3867959">hs</span><span class="op" id="3867961">.</span><span class="ident" id="3867962">suite</span><span class="op" id="3867967">.</span><span class="ident" id="3867968">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3867972">hs</span><span class="op" id="3867974">.</span><span class="ident" id="3867975">finishedHash</span><span class="op" id="3867987">.</span><span class="ident" id="3867988">Write</span><span class="op" id="3867993">(</span><span class="ident" id="3867994">hs</span><span class="op" id="3867996">.</span><span class="ident" id="3867997">hello</span><span class="op" id="3868002">.</span><span class="ident" id="3868003">marshal</span><span class="op" id="3868010">(</span><span class="op" id="3868011">)</span><span class="op" id="3868012">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3868015">c</span><span class="op" id="3868016">.</span><span class="ident" id="3868017">writeRecord</span><span class="op" id="3868028">(</span><span class="ident" id="3868029">recordTypeHandshake</span><span class="op" id="3868048">,</span>&nbsp;<span class="ident" id="3868050">hs</span><span class="op" id="3868052">.</span><span class="ident" id="3868053">hello</span><span class="op" id="3868058">.</span><span class="ident" id="3868059">marshal</span><span class="op" id="3868066">(</span><span class="op" id="3868067">)</span><span class="op" id="3868068">)</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3868072">certMsg</span>&nbsp;<span class="op" id="3868080">:=</span>&nbsp;<span class="builtinfunc" id="3868083">new</span><span class="op" id="3868086">(</span><span class="ident" id="3868087">certificateMsg</span><span class="op" id="3868101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3868104">certMsg</span><span class="op" id="3868111">.</span><span class="ident" id="3868112">certificates</span>&nbsp;<span class="op" id="3868125">=</span>&nbsp;<span class="ident" id="3868127">hs</span><span class="op" id="3868129">.</span><span class="ident" id="3868130">cert</span><span class="op" id="3868134">.</span><span class="ident" id="3868135">Certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3868148">hs</span><span class="op" id="3868150">.</span><span class="ident" id="3868151">finishedHash</span><span class="op" id="3868163">.</span><span class="ident" id="3868164">Write</span><span class="op" id="3868169">(</span><span class="ident" id="3868170">certMsg</span><span class="op" id="3868177">.</span><span class="ident" id="3868178">marshal</span><span class="op" id="3868185">(</span><span class="op" id="3868186">)</span><span class="op" id="3868187">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3868190">c</span><span class="op" id="3868191">.</span><span class="ident" id="3868192">writeRecord</span><span class="op" id="3868203">(</span><span class="ident" id="3868204">recordTypeHandshake</span><span class="op" id="3868223">,</span>&nbsp;<span class="ident" id="3868225">certMsg</span><span class="op" id="3868232">.</span><span class="ident" id="3868233">marshal</span><span class="op" id="3868240">(</span><span class="op" id="3868241">)</span><span class="op" id="3868242">)</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3868246">if</span>&nbsp;<span class="ident" id="3868249">hs</span><span class="op" id="3868251">.</span><span class="ident" id="3868252">hello</span><span class="op" id="3868257">.</span><span class="ident" id="3868258">ocspStapling</span>&nbsp;<span class="op" id="3868271">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3868275">certStatus</span>&nbsp;<span class="op" id="3868286">:=</span>&nbsp;<span class="builtinfunc" id="3868289">new</span><span class="op" id="3868292">(</span><span class="ident" id="3868293">certificateStatusMsg</span><span class="op" id="3868313">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3868317">certStatus</span><span class="op" id="3868327">.</span><span class="ident" id="3868328">statusType</span>&nbsp;<span class="op" id="3868339">=</span>&nbsp;<span class="ident" id="3868341">statusTypeOCSP</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3868358">certStatus</span><span class="op" id="3868368">.</span><span class="ident" id="3868369">response</span>&nbsp;<span class="op" id="3868378">=</span>&nbsp;<span class="ident" id="3868380">hs</span><span class="op" id="3868382">.</span><span class="ident" id="3868383">cert</span><span class="op" id="3868387">.</span><span class="ident" id="3868388">OCSPStaple</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3868401">hs</span><span class="op" id="3868403">.</span><span class="ident" id="3868404">finishedHash</span><span class="op" id="3868416">.</span><span class="ident" id="3868417">Write</span><span class="op" id="3868422">(</span><span class="ident" id="3868423">certStatus</span><span class="op" id="3868433">.</span><span class="ident" id="3868434">marshal</span><span class="op" id="3868441">(</span><span class="op" id="3868442">)</span><span class="op" id="3868443">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3868447">c</span><span class="op" id="3868448">.</span><span class="ident" id="3868449">writeRecord</span><span class="op" id="3868460">(</span><span class="ident" id="3868461">recordTypeHandshake</span><span class="op" id="3868480">,</span>&nbsp;<span class="ident" id="3868482">certStatus</span><span class="op" id="3868492">.</span><span class="ident" id="3868493">marshal</span><span class="op" id="3868500">(</span><span class="op" id="3868501">)</span><span class="op" id="3868502">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3868505">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3868509">keyAgreement</span>&nbsp;<span class="op" id="3868522">:=</span>&nbsp;<span class="ident" id="3868525">hs</span><span class="op" id="3868527">.</span><span class="ident" id="3868528">suite</span><span class="op" id="3868533">.</span><span class="ident" id="3868534">ka</span><span class="op" id="3868536">(</span><span class="ident" id="3868537">c</span><span class="op" id="3868538">.</span><span class="ident" id="3868539">vers</span><span class="op" id="3868543">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3868546">skx</span><span class="op" id="3868549">,</span>&nbsp;<span class="ident" id="3868551">err</span>&nbsp;<span class="op" id="3868555">:=</span>&nbsp;<span class="ident" id="3868558">keyAgreement</span><span class="op" id="3868570">.</span><span class="ident" id="3868571">generateServerKeyExchange</span><span class="op" id="3868596">(</span><span class="ident" id="3868597">config</span><span class="op" id="3868603">,</span>&nbsp;<span class="ident" id="3868605">hs</span><span class="op" id="3868607">.</span><span class="ident" id="3868608">cert</span><span class="op" id="3868612">,</span>&nbsp;<span class="ident" id="3868614">hs</span><span class="op" id="3868616">.</span><span class="ident" id="3868617">clientHello</span><span class="op" id="3868628">,</span>&nbsp;<span class="ident" id="3868630">hs</span><span class="op" id="3868632">.</span><span class="ident" id="3868633">hello</span><span class="op" id="3868638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3868641">if</span>&nbsp;<span class="ident" id="3868644">err</span>&nbsp;<span class="op" id="3868648">!=</span>&nbsp;<span class="ident" id="3868651">nil</span>&nbsp;<span class="op" id="3868655">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3868659">c</span><span class="op" id="3868660">.</span><span class="ident" id="3868661">sendAlert</span><span class="op" id="3868670">(</span><span class="ident" id="3868671">alertHandshakeFailure</span><span class="op" id="3868692">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3868696">return</span>&nbsp;<span class="ident" id="3868703">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3868708">}</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3868711">if</span>&nbsp;<span class="ident" id="3868714">skx</span>&nbsp;<span class="op" id="3868718">!=</span>&nbsp;<span class="ident" id="3868721">nil</span>&nbsp;<span class="op" id="3868725">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3868729">hs</span><span class="op" id="3868731">.</span><span class="ident" id="3868732">finishedHash</span><span class="op" id="3868744">.</span><span class="ident" id="3868745">Write</span><span class="op" id="3868750">(</span><span class="ident" id="3868751">skx</span><span class="op" id="3868754">.</span><span class="ident" id="3868755">marshal</span><span class="op" id="3868762">(</span><span class="op" id="3868763">)</span><span class="op" id="3868764">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3868768">c</span><span class="op" id="3868769">.</span><span class="ident" id="3868770">writeRecord</span><span class="op" id="3868781">(</span><span class="ident" id="3868782">recordTypeHandshake</span><span class="op" id="3868801">,</span>&nbsp;<span class="ident" id="3868803">skx</span><span class="op" id="3868806">.</span><span class="ident" id="3868807">marshal</span><span class="op" id="3868814">(</span><span class="op" id="3868815">)</span><span class="op" id="3868816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3868819">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3868823">if</span>&nbsp;<span class="ident" id="3868826">config</span><span class="op" id="3868832">.</span><span class="ident" id="3868833">ClientAuth</span>&nbsp;<span class="op" id="3868844">&gt;=</span>&nbsp;<span class="ident" id="3868847">RequestClientCert</span>&nbsp;<span class="op" id="3868865">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3868869">//&nbsp;Request&nbsp;a&nbsp;client&nbsp;certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3868903">certReq</span>&nbsp;<span class="op" id="3868911">:=</span>&nbsp;<span class="builtinfunc" id="3868914">new</span><span class="op" id="3868917">(</span><span class="ident" id="3868918">certificateRequestMsg</span><span class="op" id="3868939">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3868943">certReq</span><span class="op" id="3868950">.</span><span class="ident" id="3868951">certificateTypes</span>&nbsp;<span class="op" id="3868968">=</span>&nbsp;<span class="op" id="3868970">[</span><span class="op" id="3868971">]</span><span class="builtintype" id="3868972">byte</span><span class="op" id="3868976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="3868981">byte</span><span class="op" id="3868985">(</span><span class="ident" id="3868986">certTypeRSASign</span><span class="op" id="3869001">)</span><span class="op" id="3869002">,</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="3869007">byte</span><span class="op" id="3869011">(</span><span class="ident" id="3869012">certTypeECDSASign</span><span class="op" id="3869029">)</span><span class="op" id="3869030">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3869034">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3869038">if</span>&nbsp;<span class="ident" id="3869041">c</span><span class="op" id="3869042">.</span><span class="ident" id="3869043">vers</span>&nbsp;<span class="op" id="3869048">&gt;=</span>&nbsp;<span class="ident" id="3869051">VersionTLS12</span>&nbsp;<span class="op" id="3869064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3869069">certReq</span><span class="op" id="3869076">.</span><span class="ident" id="3869077">hasSignatureAndHash</span>&nbsp;<span class="op" id="3869097">=</span>&nbsp;<span class="builtintype" id="3869099">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3869107">certReq</span><span class="op" id="3869114">.</span><span class="ident" id="3869115">signatureAndHashes</span>&nbsp;<span class="op" id="3869134">=</span>&nbsp;<span class="ident" id="3869136">supportedClientCertSignatureAlgorithms</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3869177">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3869182">//&nbsp;An&nbsp;empty&nbsp;list&nbsp;of&nbsp;certificateAuthorities&nbsp;signals&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3869238">//&nbsp;the&nbsp;client&nbsp;that&nbsp;it&nbsp;may&nbsp;send&nbsp;any&nbsp;certificate&nbsp;in&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3869299">//&nbsp;to&nbsp;our&nbsp;request.&nbsp;When&nbsp;we&nbsp;know&nbsp;the&nbsp;CAs&nbsp;we&nbsp;trust,&nbsp;then</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3869356">//&nbsp;we&nbsp;can&nbsp;send&nbsp;them&nbsp;down,&nbsp;so&nbsp;that&nbsp;the&nbsp;client&nbsp;can&nbsp;choose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3869414">//&nbsp;an&nbsp;appropriate&nbsp;certificate&nbsp;to&nbsp;give&nbsp;to&nbsp;us.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3869461">if</span>&nbsp;<span class="ident" id="3869464">config</span><span class="op" id="3869470">.</span><span class="ident" id="3869471">ClientCAs</span>&nbsp;<span class="op" id="3869481">!=</span>&nbsp;<span class="ident" id="3869484">nil</span>&nbsp;<span class="op" id="3869488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3869493">certReq</span><span class="op" id="3869500">.</span><span class="ident" id="3869501">certificateAuthorities</span>&nbsp;<span class="op" id="3869524">=</span>&nbsp;<span class="ident" id="3869526">config</span><span class="op" id="3869532">.</span><span class="ident" id="3869533">ClientCAs</span><span class="op" id="3869542">.</span><span class="ident" id="3869543">Subjects</span><span class="op" id="3869551">(</span><span class="op" id="3869552">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3869556">}</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3869560">hs</span><span class="op" id="3869562">.</span><span class="ident" id="3869563">finishedHash</span><span class="op" id="3869575">.</span><span class="ident" id="3869576">Write</span><span class="op" id="3869581">(</span><span class="ident" id="3869582">certReq</span><span class="op" id="3869589">.</span><span class="ident" id="3869590">marshal</span><span class="op" id="3869597">(</span><span class="op" id="3869598">)</span><span class="op" id="3869599">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3869603">c</span><span class="op" id="3869604">.</span><span class="ident" id="3869605">writeRecord</span><span class="op" id="3869616">(</span><span class="ident" id="3869617">recordTypeHandshake</span><span class="op" id="3869636">,</span>&nbsp;<span class="ident" id="3869638">certReq</span><span class="op" id="3869645">.</span><span class="ident" id="3869646">marshal</span><span class="op" id="3869653">(</span><span class="op" id="3869654">)</span><span class="op" id="3869655">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3869658">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3869662">helloDone</span>&nbsp;<span class="op" id="3869672">:=</span>&nbsp;<span class="builtinfunc" id="3869675">new</span><span class="op" id="3869678">(</span><span class="ident" id="3869679">serverHelloDoneMsg</span><span class="op" id="3869697">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3869700">hs</span><span class="op" id="3869702">.</span><span class="ident" id="3869703">finishedHash</span><span class="op" id="3869715">.</span><span class="ident" id="3869716">Write</span><span class="op" id="3869721">(</span><span class="ident" id="3869722">helloDone</span><span class="op" id="3869731">.</span><span class="ident" id="3869732">marshal</span><span class="op" id="3869739">(</span><span class="op" id="3869740">)</span><span class="op" id="3869741">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3869744">c</span><span class="op" id="3869745">.</span><span class="ident" id="3869746">writeRecord</span><span class="op" id="3869757">(</span><span class="ident" id="3869758">recordTypeHandshake</span><span class="op" id="3869777">,</span>&nbsp;<span class="ident" id="3869779">helloDone</span><span class="op" id="3869788">.</span><span class="ident" id="3869789">marshal</span><span class="op" id="3869796">(</span><span class="op" id="3869797">)</span><span class="op" id="3869798">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3869802">var</span>&nbsp;<span class="ident" id="3869806">pub</span>&nbsp;<span class="ident" id="3869810">crypto</span><span class="op" id="3869816">.</span><span class="ident" id="3869817">PublicKey</span>&nbsp;<span class="comment" id="3869827">//&nbsp;public&nbsp;key&nbsp;for&nbsp;client&nbsp;auth,&nbsp;if&nbsp;any</span><br>
<span class="lineno"></span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3869867">msg</span><span class="op" id="3869870">,</span>&nbsp;<span class="ident" id="3869872">err</span>&nbsp;<span class="op" id="3869876">:=</span>&nbsp;<span class="ident" id="3869879">c</span><span class="op" id="3869880">.</span><span class="ident" id="3869881">readHandshake</span><span class="op" id="3869894">(</span><span class="op" id="3869895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3869898">if</span>&nbsp;<span class="ident" id="3869901">err</span>&nbsp;<span class="op" id="3869905">!=</span>&nbsp;<span class="ident" id="3869908">nil</span>&nbsp;<span class="op" id="3869912">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3869916">return</span>&nbsp;<span class="ident" id="3869923">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3869928">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3869932">var</span>&nbsp;<span class="ident" id="3869936">ok</span>&nbsp;<span class="builtintype" id="3869939">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3869945">//&nbsp;If&nbsp;we&nbsp;requested&nbsp;a&nbsp;client&nbsp;certificate,&nbsp;then&nbsp;the&nbsp;client&nbsp;must&nbsp;send&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3870015">//&nbsp;certificate&nbsp;message,&nbsp;even&nbsp;if&nbsp;it&#39;s&nbsp;empty.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3870060">if</span>&nbsp;<span class="ident" id="3870063">config</span><span class="op" id="3870069">.</span><span class="ident" id="3870070">ClientAuth</span>&nbsp;<span class="op" id="3870081">&gt;=</span>&nbsp;<span class="ident" id="3870084">RequestClientCert</span>&nbsp;<span class="op" id="3870102">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3870106">if</span>&nbsp;<span class="ident" id="3870109">certMsg</span><span class="op" id="3870116">,</span>&nbsp;<span class="ident" id="3870118">ok</span>&nbsp;<span class="op" id="3870121">=</span>&nbsp;<span class="ident" id="3870123">msg</span><span class="op" id="3870126">.</span><span class="op" id="3870127">(</span><span class="op" id="3870128">*</span><span class="ident" id="3870129">certificateMsg</span><span class="op" id="3870143">)</span><span class="op" id="3870144">;</span>&nbsp;<span class="op" id="3870146">!</span><span class="ident" id="3870147">ok</span>&nbsp;<span class="op" id="3870150">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3870155">c</span><span class="op" id="3870156">.</span><span class="ident" id="3870157">sendAlert</span><span class="op" id="3870166">(</span><span class="ident" id="3870167">alertUnexpectedMessage</span><span class="op" id="3870189">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3870194">return</span>&nbsp;<span class="ident" id="3870201">unexpectedMessageError</span><span class="op" id="3870223">(</span><span class="ident" id="3870224">certMsg</span><span class="op" id="3870231">,</span>&nbsp;<span class="ident" id="3870233">msg</span><span class="op" id="3870236">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3870240">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3870244">hs</span><span class="op" id="3870246">.</span><span class="ident" id="3870247">finishedHash</span><span class="op" id="3870259">.</span><span class="ident" id="3870260">Write</span><span class="op" id="3870265">(</span><span class="ident" id="3870266">certMsg</span><span class="op" id="3870273">.</span><span class="ident" id="3870274">marshal</span><span class="op" id="3870281">(</span><span class="op" id="3870282">)</span><span class="op" id="3870283">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3870288">if</span>&nbsp;<span class="builtinfunc" id="3870291">len</span><span class="op" id="3870294">(</span><span class="ident" id="3870295">certMsg</span><span class="op" id="3870302">.</span><span class="ident" id="3870303">certificates</span><span class="op" id="3870315">)</span>&nbsp;<span class="op" id="3870317">==</span>&nbsp;<span class="num" id="3870320">0</span>&nbsp;<span class="op" id="3870322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3870327">//&nbsp;The&nbsp;client&nbsp;didn&#39;t&nbsp;actually&nbsp;send&nbsp;a&nbsp;certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3870379">switch</span>&nbsp;<span class="ident" id="3870386">config</span><span class="op" id="3870392">.</span><span class="ident" id="3870393">ClientAuth</span>&nbsp;<span class="op" id="3870404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3870409">case</span>&nbsp;<span class="ident" id="3870414">RequireAnyClientCert</span><span class="op" id="3870434">,</span>&nbsp;<span class="ident" id="3870436">RequireAndVerifyClientCert</span><span class="op" id="3870462">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3870468">c</span><span class="op" id="3870469">.</span><span class="ident" id="3870470">sendAlert</span><span class="op" id="3870479">(</span><span class="ident" id="3870480">alertBadCertificate</span><span class="op" id="3870499">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3870505">return</span>&nbsp;<span class="ident" id="3870512">errors</span><span class="op" id="3870518">.</span><span class="ident" id="3870519">New</span><span class="op" id="3870522">(</span><span class="string" id="3870523">&#34;tls:&nbsp;client&nbsp;didn&#39;t&nbsp;provide&nbsp;a&nbsp;certificate&#34;</span><span class="op" id="3870565">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3870570">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3870574">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3870579">pub</span><span class="op" id="3870582">,</span>&nbsp;<span class="ident" id="3870584">err</span>&nbsp;<span class="op" id="3870588">=</span>&nbsp;<span class="ident" id="3870590">hs</span><span class="op" id="3870592">.</span><span class="ident" id="3870593">processCertsFromClient</span><span class="op" id="3870615">(</span><span class="ident" id="3870616">certMsg</span><span class="op" id="3870623">.</span><span class="ident" id="3870624">certificates</span><span class="op" id="3870636">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3870640">if</span>&nbsp;<span class="ident" id="3870643">err</span>&nbsp;<span class="op" id="3870647">!=</span>&nbsp;<span class="ident" id="3870650">nil</span>&nbsp;<span class="op" id="3870654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3870659">return</span>&nbsp;<span class="ident" id="3870666">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3870672">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3870677">msg</span><span class="op" id="3870680">,</span>&nbsp;<span class="ident" id="3870682">err</span>&nbsp;<span class="op" id="3870686">=</span>&nbsp;<span class="ident" id="3870688">c</span><span class="op" id="3870689">.</span><span class="ident" id="3870690">readHandshake</span><span class="op" id="3870703">(</span><span class="op" id="3870704">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3870708">if</span>&nbsp;<span class="ident" id="3870711">err</span>&nbsp;<span class="op" id="3870715">!=</span>&nbsp;<span class="ident" id="3870718">nil</span>&nbsp;<span class="op" id="3870722">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3870727">return</span>&nbsp;<span class="ident" id="3870734">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3870740">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3870743">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3870747">//&nbsp;Get&nbsp;client&nbsp;key&nbsp;exchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3870775">ckx</span><span class="op" id="3870778">,</span>&nbsp;<span class="ident" id="3870780">ok</span>&nbsp;<span class="op" id="3870783">:=</span>&nbsp;<span class="ident" id="3870786">msg</span><span class="op" id="3870789">.</span><span class="op" id="3870790">(</span><span class="op" id="3870791">*</span><span class="ident" id="3870792">clientKeyExchangeMsg</span><span class="op" id="3870812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3870815">if</span>&nbsp;<span class="op" id="3870818">!</span><span class="ident" id="3870819">ok</span>&nbsp;<span class="op" id="3870822">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3870826">c</span><span class="op" id="3870827">.</span><span class="ident" id="3870828">sendAlert</span><span class="op" id="3870837">(</span><span class="ident" id="3870838">alertUnexpectedMessage</span><span class="op" id="3870860">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3870864">return</span>&nbsp;<span class="ident" id="3870871">unexpectedMessageError</span><span class="op" id="3870893">(</span><span class="ident" id="3870894">ckx</span><span class="op" id="3870897">,</span>&nbsp;<span class="ident" id="3870899">msg</span><span class="op" id="3870902">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3870905">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3870908">hs</span><span class="op" id="3870910">.</span><span class="ident" id="3870911">finishedHash</span><span class="op" id="3870923">.</span><span class="ident" id="3870924">Write</span><span class="op" id="3870929">(</span><span class="ident" id="3870930">ckx</span><span class="op" id="3870933">.</span><span class="ident" id="3870934">marshal</span><span class="op" id="3870941">(</span><span class="op" id="3870942">)</span><span class="op" id="3870943">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3870947">//&nbsp;If&nbsp;we&nbsp;received&nbsp;a&nbsp;client&nbsp;cert&nbsp;in&nbsp;response&nbsp;to&nbsp;our&nbsp;certificate&nbsp;request&nbsp;message,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3871028">//&nbsp;the&nbsp;client&nbsp;will&nbsp;send&nbsp;us&nbsp;a&nbsp;certificateVerifyMsg&nbsp;immediately&nbsp;after&nbsp;the</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3871101">//&nbsp;clientKeyExchangeMsg.&nbsp;&nbsp;This&nbsp;message&nbsp;is&nbsp;a&nbsp;digest&nbsp;of&nbsp;all&nbsp;preceding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3871170">//&nbsp;handshake-layer&nbsp;messages&nbsp;that&nbsp;is&nbsp;signed&nbsp;using&nbsp;the&nbsp;private&nbsp;key&nbsp;corresponding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3871250">//&nbsp;to&nbsp;the&nbsp;client&#39;s&nbsp;certificate.&nbsp;This&nbsp;allows&nbsp;us&nbsp;to&nbsp;verify&nbsp;that&nbsp;the&nbsp;client&nbsp;is&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3871330">//&nbsp;possession&nbsp;of&nbsp;the&nbsp;private&nbsp;key&nbsp;of&nbsp;the&nbsp;certificate.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3871384">if</span>&nbsp;<span class="builtinfunc" id="3871387">len</span><span class="op" id="3871390">(</span><span class="ident" id="3871391">c</span><span class="op" id="3871392">.</span><span class="ident" id="3871393">peerCertificates</span><span class="op" id="3871409">)</span>&nbsp;<span class="op" id="3871411">&gt;</span>&nbsp;<span class="num" id="3871413">0</span>&nbsp;<span class="op" id="3871415">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3871419">msg</span><span class="op" id="3871422">,</span>&nbsp;<span class="ident" id="3871424">err</span>&nbsp;<span class="op" id="3871428">=</span>&nbsp;<span class="ident" id="3871430">c</span><span class="op" id="3871431">.</span><span class="ident" id="3871432">readHandshake</span><span class="op" id="3871445">(</span><span class="op" id="3871446">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3871450">if</span>&nbsp;<span class="ident" id="3871453">err</span>&nbsp;<span class="op" id="3871457">!=</span>&nbsp;<span class="ident" id="3871460">nil</span>&nbsp;<span class="op" id="3871464">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3871469">return</span>&nbsp;<span class="ident" id="3871476">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3871482">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3871486">certVerify</span><span class="op" id="3871496">,</span>&nbsp;<span class="ident" id="3871498">ok</span>&nbsp;<span class="op" id="3871501">:=</span>&nbsp;<span class="ident" id="3871504">msg</span><span class="op" id="3871507">.</span><span class="op" id="3871508">(</span><span class="op" id="3871509">*</span><span class="ident" id="3871510">certificateVerifyMsg</span><span class="op" id="3871530">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3871534">if</span>&nbsp;<span class="op" id="3871537">!</span><span class="ident" id="3871538">ok</span>&nbsp;<span class="op" id="3871541">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3871546">c</span><span class="op" id="3871547">.</span><span class="ident" id="3871548">sendAlert</span><span class="op" id="3871557">(</span><span class="ident" id="3871558">alertUnexpectedMessage</span><span class="op" id="3871580">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3871585">return</span>&nbsp;<span class="ident" id="3871592">unexpectedMessageError</span><span class="op" id="3871614">(</span><span class="ident" id="3871615">certVerify</span><span class="op" id="3871625">,</span>&nbsp;<span class="ident" id="3871627">msg</span><span class="op" id="3871630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3871634">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3871639">switch</span>&nbsp;<span class="ident" id="3871646">key</span>&nbsp;<span class="op" id="3871650">:=</span>&nbsp;<span class="ident" id="3871653">pub</span><span class="op" id="3871656">.</span><span class="op" id="3871657">(</span><span class="keyword" id="3871658">type</span><span class="op" id="3871662">)</span>&nbsp;<span class="op" id="3871664">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3871668">case</span>&nbsp;<span class="op" id="3871673">*</span><span class="ident" id="3871674">ecdsa</span><span class="op" id="3871679">.</span><span class="ident" id="3871680">PublicKey</span><span class="op" id="3871689">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3871694">ecdsaSig</span>&nbsp;<span class="op" id="3871703">:=</span>&nbsp;<span class="builtinfunc" id="3871706">new</span><span class="op" id="3871709">(</span><span class="ident" id="3871710">ecdsaSignature</span><span class="op" id="3871724">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3871729">if</span>&nbsp;<span class="ident" id="3871732">_</span><span class="op" id="3871733">,</span>&nbsp;<span class="ident" id="3871735">err</span>&nbsp;<span class="op" id="3871739">=</span>&nbsp;<span class="ident" id="3871741">asn1</span><span class="op" id="3871745">.</span><span class="ident" id="3871746">Unmarshal</span><span class="op" id="3871755">(</span><span class="ident" id="3871756">certVerify</span><span class="op" id="3871766">.</span><span class="ident" id="3871767">signature</span><span class="op" id="3871776">,</span>&nbsp;<span class="ident" id="3871778">ecdsaSig</span><span class="op" id="3871786">)</span><span class="op" id="3871787">;</span>&nbsp;<span class="ident" id="3871789">err</span>&nbsp;<span class="op" id="3871793">!=</span>&nbsp;<span class="ident" id="3871796">nil</span>&nbsp;<span class="op" id="3871800">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3871806">break</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3871815">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3871820">if</span>&nbsp;<span class="ident" id="3871823">ecdsaSig</span><span class="op" id="3871831">.</span><span class="ident" id="3871832">R</span><span class="op" id="3871833">.</span><span class="ident" id="3871834">Sign</span><span class="op" id="3871838">(</span><span class="op" id="3871839">)</span>&nbsp;<span class="op" id="3871841">&lt;=</span>&nbsp;<span class="num" id="3871844">0</span>&nbsp;<span class="op" id="3871846">||</span>&nbsp;<span class="ident" id="3871849">ecdsaSig</span><span class="op" id="3871857">.</span><span class="ident" id="3871858">S</span><span class="op" id="3871859">.</span><span class="ident" id="3871860">Sign</span><span class="op" id="3871864">(</span><span class="op" id="3871865">)</span>&nbsp;<span class="op" id="3871867">&lt;=</span>&nbsp;<span class="num" id="3871870">0</span>&nbsp;<span class="op" id="3871872">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3871878">err</span>&nbsp;<span class="op" id="3871882">=</span>&nbsp;<span class="ident" id="3871884">errors</span><span class="op" id="3871890">.</span><span class="ident" id="3871891">New</span><span class="op" id="3871894">(</span><span class="string" id="3871895">&#34;ECDSA&nbsp;signature&nbsp;contained&nbsp;zero&nbsp;or&nbsp;negative&nbsp;values&#34;</span><span class="op" id="3871946">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3871952">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3871961">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3871966">digest</span><span class="op" id="3871972">,</span>&nbsp;<span class="ident" id="3871974">_</span><span class="op" id="3871975">,</span>&nbsp;<span class="ident" id="3871977">_</span>&nbsp;<span class="op" id="3871979">:=</span>&nbsp;<span class="ident" id="3871982">hs</span><span class="op" id="3871984">.</span><span class="ident" id="3871985">finishedHash</span><span class="op" id="3871997">.</span><span class="ident" id="3871998">hashForClientCertificate</span><span class="op" id="3872022">(</span><span class="ident" id="3872023">signatureECDSA</span><span class="op" id="3872037">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3872042">if</span>&nbsp;<span class="op" id="3872045">!</span><span class="ident" id="3872046">ecdsa</span><span class="op" id="3872051">.</span><span class="ident" id="3872052">Verify</span><span class="op" id="3872058">(</span><span class="ident" id="3872059">key</span><span class="op" id="3872062">,</span>&nbsp;<span class="ident" id="3872064">digest</span><span class="op" id="3872070">,</span>&nbsp;<span class="ident" id="3872072">ecdsaSig</span><span class="op" id="3872080">.</span><span class="ident" id="3872081">R</span><span class="op" id="3872082">,</span>&nbsp;<span class="ident" id="3872084">ecdsaSig</span><span class="op" id="3872092">.</span><span class="ident" id="3872093">S</span><span class="op" id="3872094">)</span>&nbsp;<span class="op" id="3872096">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3872102">err</span>&nbsp;<span class="op" id="3872106">=</span>&nbsp;<span class="ident" id="3872108">errors</span><span class="op" id="3872114">.</span><span class="ident" id="3872115">New</span><span class="op" id="3872118">(</span><span class="string" id="3872119">&#34;ECDSA&nbsp;verification&nbsp;failure&#34;</span><span class="op" id="3872147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3872153">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3872162">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3872166">case</span>&nbsp;<span class="op" id="3872171">*</span><span class="ident" id="3872172">rsa</span><span class="op" id="3872175">.</span><span class="ident" id="3872176">PublicKey</span><span class="op" id="3872185">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3872190">digest</span><span class="op" id="3872196">,</span>&nbsp;<span class="ident" id="3872198">hashFunc</span><span class="op" id="3872206">,</span>&nbsp;<span class="ident" id="3872208">_</span>&nbsp;<span class="op" id="3872210">:=</span>&nbsp;<span class="ident" id="3872213">hs</span><span class="op" id="3872215">.</span><span class="ident" id="3872216">finishedHash</span><span class="op" id="3872228">.</span><span class="ident" id="3872229">hashForClientCertificate</span><span class="op" id="3872253">(</span><span class="ident" id="3872254">signatureRSA</span><span class="op" id="3872266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3872271">err</span>&nbsp;<span class="op" id="3872275">=</span>&nbsp;<span class="ident" id="3872277">rsa</span><span class="op" id="3872280">.</span><span class="ident" id="3872281">VerifyPKCS1v15</span><span class="op" id="3872295">(</span><span class="ident" id="3872296">key</span><span class="op" id="3872299">,</span>&nbsp;<span class="ident" id="3872301">hashFunc</span><span class="op" id="3872309">,</span>&nbsp;<span class="ident" id="3872311">digest</span><span class="op" id="3872317">,</span>&nbsp;<span class="ident" id="3872319">certVerify</span><span class="op" id="3872329">.</span><span class="ident" id="3872330">signature</span><span class="op" id="3872339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3872343">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3872347">if</span>&nbsp;<span class="ident" id="3872350">err</span>&nbsp;<span class="op" id="3872354">!=</span>&nbsp;<span class="ident" id="3872357">nil</span>&nbsp;<span class="op" id="3872361">{</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3872366">c</span><span class="op" id="3872367">.</span><span class="ident" id="3872368">sendAlert</span><span class="op" id="3872377">(</span><span class="ident" id="3872378">alertBadCertificate</span><span class="op" id="3872397">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3872402">return</span>&nbsp;<span class="ident" id="3872409">errors</span><span class="op" id="3872415">.</span><span class="ident" id="3872416">New</span><span class="op" id="3872419">(</span><span class="string" id="3872420">&#34;could&nbsp;not&nbsp;validate&nbsp;signature&nbsp;of&nbsp;connection&nbsp;nonces:&nbsp;&#34;</span>&nbsp;<span class="op" id="3872474">+</span>&nbsp;<span class="ident" id="3872476">err</span><span class="op" id="3872479">.</span><span class="ident" id="3872480">Error</span><span class="op" id="3872485">(</span><span class="op" id="3872486">)</span><span class="op" id="3872487">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3872491">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3872496">hs</span><span class="op" id="3872498">.</span><span class="ident" id="3872499">finishedHash</span><span class="op" id="3872511">.</span><span class="ident" id="3872512">Write</span><span class="op" id="3872517">(</span><span class="ident" id="3872518">certVerify</span><span class="op" id="3872528">.</span><span class="ident" id="3872529">marshal</span><span class="op" id="3872536">(</span><span class="op" id="3872537">)</span><span class="op" id="3872538">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3872541">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3872545">preMasterSecret</span><span class="op" id="3872560">,</span>&nbsp;<span class="ident" id="3872562">err</span>&nbsp;<span class="op" id="3872566">:=</span>&nbsp;<span class="ident" id="3872569">keyAgreement</span><span class="op" id="3872581">.</span><span class="ident" id="3872582">processClientKeyExchange</span><span class="op" id="3872606">(</span><span class="ident" id="3872607">config</span><span class="op" id="3872613">,</span>&nbsp;<span class="ident" id="3872615">hs</span><span class="op" id="3872617">.</span><span class="ident" id="3872618">cert</span><span class="op" id="3872622">,</span>&nbsp;<span class="ident" id="3872624">ckx</span><span class="op" id="3872627">,</span>&nbsp;<span class="ident" id="3872629">c</span><span class="op" id="3872630">.</span><span class="ident" id="3872631">vers</span><span class="op" id="3872635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3872638">if</span>&nbsp;<span class="ident" id="3872641">err</span>&nbsp;<span class="op" id="3872645">!=</span>&nbsp;<span class="ident" id="3872648">nil</span>&nbsp;<span class="op" id="3872652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3872656">c</span><span class="op" id="3872657">.</span><span class="ident" id="3872658">sendAlert</span><span class="op" id="3872667">(</span><span class="ident" id="3872668">alertHandshakeFailure</span><span class="op" id="3872689">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3872693">return</span>&nbsp;<span class="ident" id="3872700">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3872705">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3872708">hs</span><span class="op" id="3872710">.</span><span class="ident" id="3872711">masterSecret</span>&nbsp;<span class="op" id="3872724">=</span>&nbsp;<span class="ident" id="3872726">masterFromPreMasterSecret</span><span class="op" id="3872751">(</span><span class="ident" id="3872752">c</span><span class="op" id="3872753">.</span><span class="ident" id="3872754">vers</span><span class="op" id="3872758">,</span>&nbsp;<span class="ident" id="3872760">preMasterSecret</span><span class="op" id="3872775">,</span>&nbsp;<span class="ident" id="3872777">hs</span><span class="op" id="3872779">.</span><span class="ident" id="3872780">clientHello</span><span class="op" id="3872791">.</span><span class="ident" id="3872792">random</span><span class="op" id="3872798">,</span>&nbsp;<span class="ident" id="3872800">hs</span><span class="op" id="3872802">.</span><span class="ident" id="3872803">hello</span><span class="op" id="3872808">.</span><span class="ident" id="3872809">random</span><span class="op" id="3872815">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3872819">return</span>&nbsp;<span class="ident" id="3872826">nil</span><br>
<span class="lineno">475</span><span class="op" id="3872830">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3872833">func</span>&nbsp;<span class="op" id="3872838">(</span><span class="ident" id="3872839">hs</span>&nbsp;<span class="op" id="3872842">*</span><span class="ident" id="3872843">serverHandshakeState</span><span class="op" id="3872863">)</span>&nbsp;<span class="ident" id="3872865">establishKeys</span><span class="op" id="3872878">(</span><span class="op" id="3872879">)</span>&nbsp;<span class="builtintype" id="3872881">error</span>&nbsp;<span class="op" id="3872887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3872890">c</span>&nbsp;<span class="op" id="3872892">:=</span>&nbsp;<span class="ident" id="3872895">hs</span><span class="op" id="3872897">.</span><span class="ident" id="3872898">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3872902">clientMAC</span><span class="op" id="3872911">,</span>&nbsp;<span class="ident" id="3872913">serverMAC</span><span class="op" id="3872922">,</span>&nbsp;<span class="ident" id="3872924">clientKey</span><span class="op" id="3872933">,</span>&nbsp;<span class="ident" id="3872935">serverKey</span><span class="op" id="3872944">,</span>&nbsp;<span class="ident" id="3872946">clientIV</span><span class="op" id="3872954">,</span>&nbsp;<span class="ident" id="3872956">serverIV</span>&nbsp;<span class="op" id="3872965">:=</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3872970">keysFromMasterSecret</span><span class="op" id="3872990">(</span><span class="ident" id="3872991">c</span><span class="op" id="3872992">.</span><span class="ident" id="3872993">vers</span><span class="op" id="3872997">,</span>&nbsp;<span class="ident" id="3872999">hs</span><span class="op" id="3873001">.</span><span class="ident" id="3873002">masterSecret</span><span class="op" id="3873014">,</span>&nbsp;<span class="ident" id="3873016">hs</span><span class="op" id="3873018">.</span><span class="ident" id="3873019">clientHello</span><span class="op" id="3873030">.</span><span class="ident" id="3873031">random</span><span class="op" id="3873037">,</span>&nbsp;<span class="ident" id="3873039">hs</span><span class="op" id="3873041">.</span><span class="ident" id="3873042">hello</span><span class="op" id="3873047">.</span><span class="ident" id="3873048">random</span><span class="op" id="3873054">,</span>&nbsp;<span class="ident" id="3873056">hs</span><span class="op" id="3873058">.</span><span class="ident" id="3873059">suite</span><span class="op" id="3873064">.</span><span class="ident" id="3873065">macLen</span><span class="op" id="3873071">,</span>&nbsp;<span class="ident" id="3873073">hs</span><span class="op" id="3873075">.</span><span class="ident" id="3873076">suite</span><span class="op" id="3873081">.</span><span class="ident" id="3873082">keyLen</span><span class="op" id="3873088">,</span>&nbsp;<span class="ident" id="3873090">hs</span><span class="op" id="3873092">.</span><span class="ident" id="3873093">suite</span><span class="op" id="3873098">.</span><span class="ident" id="3873099">ivLen</span><span class="op" id="3873104">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3873108">var</span>&nbsp;<span class="ident" id="3873112">clientCipher</span><span class="op" id="3873124">,</span>&nbsp;<span class="ident" id="3873126">serverCipher</span>&nbsp;<span class="keyword" id="3873139">interface</span><span class="op" id="3873148">{</span><span class="op" id="3873149">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3873152">var</span>&nbsp;<span class="ident" id="3873156">clientHash</span><span class="op" id="3873166">,</span>&nbsp;<span class="ident" id="3873168">serverHash</span>&nbsp;<span class="ident" id="3873179">macFunction</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3873193">if</span>&nbsp;<span class="ident" id="3873196">hs</span><span class="op" id="3873198">.</span><span class="ident" id="3873199">suite</span><span class="op" id="3873204">.</span><span class="ident" id="3873205">aead</span>&nbsp;<span class="op" id="3873210">==</span>&nbsp;<span class="ident" id="3873213">nil</span>&nbsp;<span class="op" id="3873217">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3873221">clientCipher</span>&nbsp;<span class="op" id="3873234">=</span>&nbsp;<span class="ident" id="3873236">hs</span><span class="op" id="3873238">.</span><span class="ident" id="3873239">suite</span><span class="op" id="3873244">.</span><span class="ident" id="3873245">cipher</span><span class="op" id="3873251">(</span><span class="ident" id="3873252">clientKey</span><span class="op" id="3873261">,</span>&nbsp;<span class="ident" id="3873263">clientIV</span><span class="op" id="3873271">,</span>&nbsp;<span class="builtintype" id="3873273">true</span>&nbsp;<span class="comment" id="3873278">/*&nbsp;for&nbsp;reading&nbsp;*/</span><span class="op" id="3873295">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3873299">clientHash</span>&nbsp;<span class="op" id="3873310">=</span>&nbsp;<span class="ident" id="3873312">hs</span><span class="op" id="3873314">.</span><span class="ident" id="3873315">suite</span><span class="op" id="3873320">.</span><span class="ident" id="3873321">mac</span><span class="op" id="3873324">(</span><span class="ident" id="3873325">c</span><span class="op" id="3873326">.</span><span class="ident" id="3873327">vers</span><span class="op" id="3873331">,</span>&nbsp;<span class="ident" id="3873333">clientMAC</span><span class="op" id="3873342">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3873346">serverCipher</span>&nbsp;<span class="op" id="3873359">=</span>&nbsp;<span class="ident" id="3873361">hs</span><span class="op" id="3873363">.</span><span class="ident" id="3873364">suite</span><span class="op" id="3873369">.</span><span class="ident" id="3873370">cipher</span><span class="op" id="3873376">(</span><span class="ident" id="3873377">serverKey</span><span class="op" id="3873386">,</span>&nbsp;<span class="ident" id="3873388">serverIV</span><span class="op" id="3873396">,</span>&nbsp;<span class="builtintype" id="3873398">false</span>&nbsp;<span class="comment" id="3873404">/*&nbsp;not&nbsp;for&nbsp;reading&nbsp;*/</span><span class="op" id="3873425">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3873429">serverHash</span>&nbsp;<span class="op" id="3873440">=</span>&nbsp;<span class="ident" id="3873442">hs</span><span class="op" id="3873444">.</span><span class="ident" id="3873445">suite</span><span class="op" id="3873450">.</span><span class="ident" id="3873451">mac</span><span class="op" id="3873454">(</span><span class="ident" id="3873455">c</span><span class="op" id="3873456">.</span><span class="ident" id="3873457">vers</span><span class="op" id="3873461">,</span>&nbsp;<span class="ident" id="3873463">serverMAC</span><span class="op" id="3873472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3873475">}</span>&nbsp;<span class="keyword" id="3873477">else</span>&nbsp;<span class="op" id="3873482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3873486">clientCipher</span>&nbsp;<span class="op" id="3873499">=</span>&nbsp;<span class="ident" id="3873501">hs</span><span class="op" id="3873503">.</span><span class="ident" id="3873504">suite</span><span class="op" id="3873509">.</span><span class="ident" id="3873510">aead</span><span class="op" id="3873514">(</span><span class="ident" id="3873515">clientKey</span><span class="op" id="3873524">,</span>&nbsp;<span class="ident" id="3873526">clientIV</span><span class="op" id="3873534">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3873538">serverCipher</span>&nbsp;<span class="op" id="3873551">=</span>&nbsp;<span class="ident" id="3873553">hs</span><span class="op" id="3873555">.</span><span class="ident" id="3873556">suite</span><span class="op" id="3873561">.</span><span class="ident" id="3873562">aead</span><span class="op" id="3873566">(</span><span class="ident" id="3873567">serverKey</span><span class="op" id="3873576">,</span>&nbsp;<span class="ident" id="3873578">serverIV</span><span class="op" id="3873586">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3873589">}</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3873593">c</span><span class="op" id="3873594">.</span><span class="ident" id="3873595">in</span><span class="op" id="3873597">.</span><span class="ident" id="3873598">prepareCipherSpec</span><span class="op" id="3873615">(</span><span class="ident" id="3873616">c</span><span class="op" id="3873617">.</span><span class="ident" id="3873618">vers</span><span class="op" id="3873622">,</span>&nbsp;<span class="ident" id="3873624">clientCipher</span><span class="op" id="3873636">,</span>&nbsp;<span class="ident" id="3873638">clientHash</span><span class="op" id="3873648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3873651">c</span><span class="op" id="3873652">.</span><span class="ident" id="3873653">out</span><span class="op" id="3873656">.</span><span class="ident" id="3873657">prepareCipherSpec</span><span class="op" id="3873674">(</span><span class="ident" id="3873675">c</span><span class="op" id="3873676">.</span><span class="ident" id="3873677">vers</span><span class="op" id="3873681">,</span>&nbsp;<span class="ident" id="3873683">serverCipher</span><span class="op" id="3873695">,</span>&nbsp;<span class="ident" id="3873697">serverHash</span><span class="op" id="3873707">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3873711">return</span>&nbsp;<span class="ident" id="3873718">nil</span><br>
<span class="lineno">500</span><span class="op" id="3873722">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3873725">func</span>&nbsp;<span class="op" id="3873730">(</span><span class="ident" id="3873731">hs</span>&nbsp;<span class="op" id="3873734">*</span><span class="ident" id="3873735">serverHandshakeState</span><span class="op" id="3873755">)</span>&nbsp;<span class="ident" id="3873757">readFinished</span><span class="op" id="3873769">(</span><span class="ident" id="3873770">out</span>&nbsp;<span class="op" id="3873774">[</span><span class="op" id="3873775">]</span><span class="builtintype" id="3873776">byte</span><span class="op" id="3873780">)</span>&nbsp;<span class="builtintype" id="3873782">error</span>&nbsp;<span class="op" id="3873788">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3873791">c</span>&nbsp;<span class="op" id="3873793">:=</span>&nbsp;<span class="ident" id="3873796">hs</span><span class="op" id="3873798">.</span><span class="ident" id="3873799">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3873803">c</span><span class="op" id="3873804">.</span><span class="ident" id="3873805">readRecord</span><span class="op" id="3873815">(</span><span class="ident" id="3873816">recordTypeChangeCipherSpec</span><span class="op" id="3873842">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3873845">if</span>&nbsp;<span class="ident" id="3873848">err</span>&nbsp;<span class="op" id="3873852">:=</span>&nbsp;<span class="ident" id="3873855">c</span><span class="op" id="3873856">.</span><span class="ident" id="3873857">in</span><span class="op" id="3873859">.</span><span class="builtintype" id="3873860">error</span><span class="op" id="3873865">(</span><span class="op" id="3873866">)</span><span class="op" id="3873867">;</span>&nbsp;<span class="ident" id="3873869">err</span>&nbsp;<span class="op" id="3873873">!=</span>&nbsp;<span class="ident" id="3873876">nil</span>&nbsp;<span class="op" id="3873880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3873884">return</span>&nbsp;<span class="ident" id="3873891">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3873896">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3873900">if</span>&nbsp;<span class="ident" id="3873903">hs</span><span class="op" id="3873905">.</span><span class="ident" id="3873906">hello</span><span class="op" id="3873911">.</span><span class="ident" id="3873912">nextProtoNeg</span>&nbsp;<span class="op" id="3873925">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3873929">msg</span><span class="op" id="3873932">,</span>&nbsp;<span class="ident" id="3873934">err</span>&nbsp;<span class="op" id="3873938">:=</span>&nbsp;<span class="ident" id="3873941">c</span><span class="op" id="3873942">.</span><span class="ident" id="3873943">readHandshake</span><span class="op" id="3873956">(</span><span class="op" id="3873957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3873961">if</span>&nbsp;<span class="ident" id="3873964">err</span>&nbsp;<span class="op" id="3873968">!=</span>&nbsp;<span class="ident" id="3873971">nil</span>&nbsp;<span class="op" id="3873975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3873980">return</span>&nbsp;<span class="ident" id="3873987">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3873993">}</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3873997">nextProto</span><span class="op" id="3874006">,</span>&nbsp;<span class="ident" id="3874008">ok</span>&nbsp;<span class="op" id="3874011">:=</span>&nbsp;<span class="ident" id="3874014">msg</span><span class="op" id="3874017">.</span><span class="op" id="3874018">(</span><span class="op" id="3874019">*</span><span class="ident" id="3874020">nextProtoMsg</span><span class="op" id="3874032">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3874036">if</span>&nbsp;<span class="op" id="3874039">!</span><span class="ident" id="3874040">ok</span>&nbsp;<span class="op" id="3874043">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3874048">c</span><span class="op" id="3874049">.</span><span class="ident" id="3874050">sendAlert</span><span class="op" id="3874059">(</span><span class="ident" id="3874060">alertUnexpectedMessage</span><span class="op" id="3874082">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3874087">return</span>&nbsp;<span class="ident" id="3874094">unexpectedMessageError</span><span class="op" id="3874116">(</span><span class="ident" id="3874117">nextProto</span><span class="op" id="3874126">,</span>&nbsp;<span class="ident" id="3874128">msg</span><span class="op" id="3874131">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3874135">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3874139">hs</span><span class="op" id="3874141">.</span><span class="ident" id="3874142">finishedHash</span><span class="op" id="3874154">.</span><span class="ident" id="3874155">Write</span><span class="op" id="3874160">(</span><span class="ident" id="3874161">nextProto</span><span class="op" id="3874170">.</span><span class="ident" id="3874171">marshal</span><span class="op" id="3874178">(</span><span class="op" id="3874179">)</span><span class="op" id="3874180">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3874184">c</span><span class="op" id="3874185">.</span><span class="ident" id="3874186">clientProtocol</span>&nbsp;<span class="op" id="3874201">=</span>&nbsp;<span class="ident" id="3874203">nextProto</span><span class="op" id="3874212">.</span><span class="ident" id="3874213">proto</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3874220">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3874224">msg</span><span class="op" id="3874227">,</span>&nbsp;<span class="ident" id="3874229">err</span>&nbsp;<span class="op" id="3874233">:=</span>&nbsp;<span class="ident" id="3874236">c</span><span class="op" id="3874237">.</span><span class="ident" id="3874238">readHandshake</span><span class="op" id="3874251">(</span><span class="op" id="3874252">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3874255">if</span>&nbsp;<span class="ident" id="3874258">err</span>&nbsp;<span class="op" id="3874262">!=</span>&nbsp;<span class="ident" id="3874265">nil</span>&nbsp;<span class="op" id="3874269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3874273">return</span>&nbsp;<span class="ident" id="3874280">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3874285">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3874288">clientFinished</span><span class="op" id="3874302">,</span>&nbsp;<span class="ident" id="3874304">ok</span>&nbsp;<span class="op" id="3874307">:=</span>&nbsp;<span class="ident" id="3874310">msg</span><span class="op" id="3874313">.</span><span class="op" id="3874314">(</span><span class="op" id="3874315">*</span><span class="ident" id="3874316">finishedMsg</span><span class="op" id="3874327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3874330">if</span>&nbsp;<span class="op" id="3874333">!</span><span class="ident" id="3874334">ok</span>&nbsp;<span class="op" id="3874337">{</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3874341">c</span><span class="op" id="3874342">.</span><span class="ident" id="3874343">sendAlert</span><span class="op" id="3874352">(</span><span class="ident" id="3874353">alertUnexpectedMessage</span><span class="op" id="3874375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3874379">return</span>&nbsp;<span class="ident" id="3874386">unexpectedMessageError</span><span class="op" id="3874408">(</span><span class="ident" id="3874409">clientFinished</span><span class="op" id="3874423">,</span>&nbsp;<span class="ident" id="3874425">msg</span><span class="op" id="3874428">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3874431">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3874435">verify</span>&nbsp;<span class="op" id="3874442">:=</span>&nbsp;<span class="ident" id="3874445">hs</span><span class="op" id="3874447">.</span><span class="ident" id="3874448">finishedHash</span><span class="op" id="3874460">.</span><span class="ident" id="3874461">clientSum</span><span class="op" id="3874470">(</span><span class="ident" id="3874471">hs</span><span class="op" id="3874473">.</span><span class="ident" id="3874474">masterSecret</span><span class="op" id="3874486">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3874489">if</span>&nbsp;<span class="builtinfunc" id="3874492">len</span><span class="op" id="3874495">(</span><span class="ident" id="3874496">verify</span><span class="op" id="3874502">)</span>&nbsp;<span class="op" id="3874504">!=</span>&nbsp;<span class="builtinfunc" id="3874507">len</span><span class="op" id="3874510">(</span><span class="ident" id="3874511">clientFinished</span><span class="op" id="3874525">.</span><span class="ident" id="3874526">verifyData</span><span class="op" id="3874536">)</span>&nbsp;<span class="op" id="3874538">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3874543">subtle</span><span class="op" id="3874549">.</span><span class="ident" id="3874550">ConstantTimeCompare</span><span class="op" id="3874569">(</span><span class="ident" id="3874570">verify</span><span class="op" id="3874576">,</span>&nbsp;<span class="ident" id="3874578">clientFinished</span><span class="op" id="3874592">.</span><span class="ident" id="3874593">verifyData</span><span class="op" id="3874603">)</span>&nbsp;<span class="op" id="3874605">!=</span>&nbsp;<span class="num" id="3874608">1</span>&nbsp;<span class="op" id="3874610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3874614">c</span><span class="op" id="3874615">.</span><span class="ident" id="3874616">sendAlert</span><span class="op" id="3874625">(</span><span class="ident" id="3874626">alertHandshakeFailure</span><span class="op" id="3874647">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3874651">return</span>&nbsp;<span class="ident" id="3874658">errors</span><span class="op" id="3874664">.</span><span class="ident" id="3874665">New</span><span class="op" id="3874668">(</span><span class="string" id="3874669">&#34;tls:&nbsp;client&#39;s&nbsp;Finished&nbsp;message&nbsp;is&nbsp;incorrect&#34;</span><span class="op" id="3874714">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3874717">}</span><br>
<span class="lineno">540</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3874721">hs</span><span class="op" id="3874723">.</span><span class="ident" id="3874724">finishedHash</span><span class="op" id="3874736">.</span><span class="ident" id="3874737">Write</span><span class="op" id="3874742">(</span><span class="ident" id="3874743">clientFinished</span><span class="op" id="3874757">.</span><span class="ident" id="3874758">marshal</span><span class="op" id="3874765">(</span><span class="op" id="3874766">)</span><span class="op" id="3874767">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3874770">copy</span><span class="op" id="3874774">(</span><span class="ident" id="3874775">out</span><span class="op" id="3874778">,</span>&nbsp;<span class="ident" id="3874780">verify</span><span class="op" id="3874786">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3874789">return</span>&nbsp;<span class="ident" id="3874796">nil</span><br>
<span class="lineno"></span><span class="op" id="3874800">}</span><br>
<span class="lineno">545</span><br>
<span class="lineno"></span><span class="keyword" id="3874803">func</span>&nbsp;<span class="op" id="3874808">(</span><span class="ident" id="3874809">hs</span>&nbsp;<span class="op" id="3874812">*</span><span class="ident" id="3874813">serverHandshakeState</span><span class="op" id="3874833">)</span>&nbsp;<span class="ident" id="3874835">sendSessionTicket</span><span class="op" id="3874852">(</span><span class="op" id="3874853">)</span>&nbsp;<span class="builtintype" id="3874855">error</span>&nbsp;<span class="op" id="3874861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3874864">if</span>&nbsp;<span class="op" id="3874867">!</span><span class="ident" id="3874868">hs</span><span class="op" id="3874870">.</span><span class="ident" id="3874871">hello</span><span class="op" id="3874876">.</span><span class="ident" id="3874877">ticketSupported</span>&nbsp;<span class="op" id="3874893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3874897">return</span>&nbsp;<span class="ident" id="3874904">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3874909">}</span><br>
<span class="lineno">550</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3874913">c</span>&nbsp;<span class="op" id="3874915">:=</span>&nbsp;<span class="ident" id="3874918">hs</span><span class="op" id="3874920">.</span><span class="ident" id="3874921">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3874924">m</span>&nbsp;<span class="op" id="3874926">:=</span>&nbsp;<span class="builtinfunc" id="3874929">new</span><span class="op" id="3874932">(</span><span class="ident" id="3874933">newSessionTicketMsg</span><span class="op" id="3874952">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3874956">var</span>&nbsp;<span class="ident" id="3874960">err</span>&nbsp;<span class="builtintype" id="3874964">error</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3874971">state</span>&nbsp;<span class="op" id="3874977">:=</span>&nbsp;<span class="ident" id="3874980">sessionState</span><span class="op" id="3874992">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3874996">vers</span><span class="op" id="3875000">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3875010">c</span><span class="op" id="3875011">.</span><span class="ident" id="3875012">vers</span><span class="op" id="3875016">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3875020">cipherSuite</span><span class="op" id="3875031">:</span>&nbsp;&nbsp;<span class="ident" id="3875034">hs</span><span class="op" id="3875036">.</span><span class="ident" id="3875037">suite</span><span class="op" id="3875042">.</span><span class="ident" id="3875043">id</span><span class="op" id="3875045">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3875049">masterSecret</span><span class="op" id="3875061">:</span>&nbsp;<span class="ident" id="3875063">hs</span><span class="op" id="3875065">.</span><span class="ident" id="3875066">masterSecret</span><span class="op" id="3875078">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3875082">certificates</span><span class="op" id="3875094">:</span>&nbsp;<span class="ident" id="3875096">hs</span><span class="op" id="3875098">.</span><span class="ident" id="3875099">certsFromClient</span><span class="op" id="3875114">,</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3875117">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3875120">m</span><span class="op" id="3875121">.</span><span class="ident" id="3875122">ticket</span><span class="op" id="3875128">,</span>&nbsp;<span class="ident" id="3875130">err</span>&nbsp;<span class="op" id="3875134">=</span>&nbsp;<span class="ident" id="3875136">c</span><span class="op" id="3875137">.</span><span class="ident" id="3875138">encryptTicket</span><span class="op" id="3875151">(</span><span class="op" id="3875152">&amp;</span><span class="ident" id="3875153">state</span><span class="op" id="3875158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3875161">if</span>&nbsp;<span class="ident" id="3875164">err</span>&nbsp;<span class="op" id="3875168">!=</span>&nbsp;<span class="ident" id="3875171">nil</span>&nbsp;<span class="op" id="3875175">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3875179">return</span>&nbsp;<span class="ident" id="3875186">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3875191">}</span><br>
<span class="lineno">565</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3875195">hs</span><span class="op" id="3875197">.</span><span class="ident" id="3875198">finishedHash</span><span class="op" id="3875210">.</span><span class="ident" id="3875211">Write</span><span class="op" id="3875216">(</span><span class="ident" id="3875217">m</span><span class="op" id="3875218">.</span><span class="ident" id="3875219">marshal</span><span class="op" id="3875226">(</span><span class="op" id="3875227">)</span><span class="op" id="3875228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3875231">c</span><span class="op" id="3875232">.</span><span class="ident" id="3875233">writeRecord</span><span class="op" id="3875244">(</span><span class="ident" id="3875245">recordTypeHandshake</span><span class="op" id="3875264">,</span>&nbsp;<span class="ident" id="3875266">m</span><span class="op" id="3875267">.</span><span class="ident" id="3875268">marshal</span><span class="op" id="3875275">(</span><span class="op" id="3875276">)</span><span class="op" id="3875277">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3875281">return</span>&nbsp;<span class="ident" id="3875288">nil</span><br>
<span class="lineno">570</span><span class="op" id="3875292">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3875295">func</span>&nbsp;<span class="op" id="3875300">(</span><span class="ident" id="3875301">hs</span>&nbsp;<span class="op" id="3875304">*</span><span class="ident" id="3875305">serverHandshakeState</span><span class="op" id="3875325">)</span>&nbsp;<span class="ident" id="3875327">sendFinished</span><span class="op" id="3875339">(</span><span class="ident" id="3875340">out</span>&nbsp;<span class="op" id="3875344">[</span><span class="op" id="3875345">]</span><span class="builtintype" id="3875346">byte</span><span class="op" id="3875350">)</span>&nbsp;<span class="builtintype" id="3875352">error</span>&nbsp;<span class="op" id="3875358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3875361">c</span>&nbsp;<span class="op" id="3875363">:=</span>&nbsp;<span class="ident" id="3875366">hs</span><span class="op" id="3875368">.</span><span class="ident" id="3875369">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3875373">c</span><span class="op" id="3875374">.</span><span class="ident" id="3875375">writeRecord</span><span class="op" id="3875386">(</span><span class="ident" id="3875387">recordTypeChangeCipherSpec</span><span class="op" id="3875413">,</span>&nbsp;<span class="op" id="3875415">[</span><span class="op" id="3875416">]</span><span class="builtintype" id="3875417">byte</span><span class="op" id="3875421">{</span><span class="num" id="3875422">1</span><span class="op" id="3875423">}</span><span class="op" id="3875424">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3875428">finished</span>&nbsp;<span class="op" id="3875437">:=</span>&nbsp;<span class="builtinfunc" id="3875440">new</span><span class="op" id="3875443">(</span><span class="ident" id="3875444">finishedMsg</span><span class="op" id="3875455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3875458">finished</span><span class="op" id="3875466">.</span><span class="ident" id="3875467">verifyData</span>&nbsp;<span class="op" id="3875478">=</span>&nbsp;<span class="ident" id="3875480">hs</span><span class="op" id="3875482">.</span><span class="ident" id="3875483">finishedHash</span><span class="op" id="3875495">.</span><span class="ident" id="3875496">serverSum</span><span class="op" id="3875505">(</span><span class="ident" id="3875506">hs</span><span class="op" id="3875508">.</span><span class="ident" id="3875509">masterSecret</span><span class="op" id="3875521">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3875524">hs</span><span class="op" id="3875526">.</span><span class="ident" id="3875527">finishedHash</span><span class="op" id="3875539">.</span><span class="ident" id="3875540">Write</span><span class="op" id="3875545">(</span><span class="ident" id="3875546">finished</span><span class="op" id="3875554">.</span><span class="ident" id="3875555">marshal</span><span class="op" id="3875562">(</span><span class="op" id="3875563">)</span><span class="op" id="3875564">)</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3875567">c</span><span class="op" id="3875568">.</span><span class="ident" id="3875569">writeRecord</span><span class="op" id="3875580">(</span><span class="ident" id="3875581">recordTypeHandshake</span><span class="op" id="3875600">,</span>&nbsp;<span class="ident" id="3875602">finished</span><span class="op" id="3875610">.</span><span class="ident" id="3875611">marshal</span><span class="op" id="3875618">(</span><span class="op" id="3875619">)</span><span class="op" id="3875620">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3875624">c</span><span class="op" id="3875625">.</span><span class="ident" id="3875626">cipherSuite</span>&nbsp;<span class="op" id="3875638">=</span>&nbsp;<span class="ident" id="3875640">hs</span><span class="op" id="3875642">.</span><span class="ident" id="3875643">suite</span><span class="op" id="3875648">.</span><span class="ident" id="3875649">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3875653">copy</span><span class="op" id="3875657">(</span><span class="ident" id="3875658">out</span><span class="op" id="3875661">,</span>&nbsp;<span class="ident" id="3875663">finished</span><span class="op" id="3875671">.</span><span class="ident" id="3875672">verifyData</span><span class="op" id="3875682">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3875686">return</span>&nbsp;<span class="ident" id="3875693">nil</span><br>
<span class="lineno"></span><span class="op" id="3875697">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3875700">//&nbsp;processCertsFromClient&nbsp;takes&nbsp;a&nbsp;chain&nbsp;of&nbsp;client&nbsp;certificates&nbsp;either&nbsp;from&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3875777">//&nbsp;Certificates&nbsp;message&nbsp;or&nbsp;from&nbsp;a&nbsp;sessionState&nbsp;and&nbsp;verifies&nbsp;them.&nbsp;It&nbsp;returns</span><br>
<span class="lineno">590</span><span class="comment" id="3875854">//&nbsp;the&nbsp;public&nbsp;key&nbsp;of&nbsp;the&nbsp;leaf&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="keyword" id="3875897">func</span>&nbsp;<span class="op" id="3875902">(</span><span class="ident" id="3875903">hs</span>&nbsp;<span class="op" id="3875906">*</span><span class="ident" id="3875907">serverHandshakeState</span><span class="op" id="3875927">)</span>&nbsp;<span class="ident" id="3875929">processCertsFromClient</span><span class="op" id="3875951">(</span><span class="ident" id="3875952">certificates</span>&nbsp;<span class="op" id="3875965">[</span><span class="op" id="3875966">]</span><span class="op" id="3875967">[</span><span class="op" id="3875968">]</span><span class="builtintype" id="3875969">byte</span><span class="op" id="3875973">)</span>&nbsp;<span class="op" id="3875975">(</span><span class="ident" id="3875976">crypto</span><span class="op" id="3875982">.</span><span class="ident" id="3875983">PublicKey</span><span class="op" id="3875992">,</span>&nbsp;<span class="builtintype" id="3875994">error</span><span class="op" id="3875999">)</span>&nbsp;<span class="op" id="3876001">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3876004">c</span>&nbsp;<span class="op" id="3876006">:=</span>&nbsp;<span class="ident" id="3876009">hs</span><span class="op" id="3876011">.</span><span class="ident" id="3876012">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3876016">hs</span><span class="op" id="3876018">.</span><span class="ident" id="3876019">certsFromClient</span>&nbsp;<span class="op" id="3876035">=</span>&nbsp;<span class="ident" id="3876037">certificates</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3876051">certs</span>&nbsp;<span class="op" id="3876057">:=</span>&nbsp;<span class="builtinfunc" id="3876060">make</span><span class="op" id="3876064">(</span><span class="op" id="3876065">[</span><span class="op" id="3876066">]</span><span class="op" id="3876067">*</span><span class="ident" id="3876068">x509</span><span class="op" id="3876072">.</span><span class="ident" id="3876073">Certificate</span><span class="op" id="3876084">,</span>&nbsp;<span class="builtinfunc" id="3876086">len</span><span class="op" id="3876089">(</span><span class="ident" id="3876090">certificates</span><span class="op" id="3876102">)</span><span class="op" id="3876103">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3876106">var</span>&nbsp;<span class="ident" id="3876110">err</span>&nbsp;<span class="builtintype" id="3876114">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3876121">for</span>&nbsp;<span class="ident" id="3876125">i</span><span class="op" id="3876126">,</span>&nbsp;<span class="ident" id="3876128">asn1Data</span>&nbsp;<span class="op" id="3876137">:=</span>&nbsp;<span class="keyword" id="3876140">range</span>&nbsp;<span class="ident" id="3876146">certificates</span>&nbsp;<span class="op" id="3876159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3876163">if</span>&nbsp;<span class="ident" id="3876166">certs</span><span class="op" id="3876171">[</span><span class="ident" id="3876172">i</span><span class="op" id="3876173">]</span><span class="op" id="3876174">,</span>&nbsp;<span class="ident" id="3876176">err</span>&nbsp;<span class="op" id="3876180">=</span>&nbsp;<span class="ident" id="3876182">x509</span><span class="op" id="3876186">.</span><span class="ident" id="3876187">ParseCertificate</span><span class="op" id="3876203">(</span><span class="ident" id="3876204">asn1Data</span><span class="op" id="3876212">)</span><span class="op" id="3876213">;</span>&nbsp;<span class="ident" id="3876215">err</span>&nbsp;<span class="op" id="3876219">!=</span>&nbsp;<span class="ident" id="3876222">nil</span>&nbsp;<span class="op" id="3876226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3876231">c</span><span class="op" id="3876232">.</span><span class="ident" id="3876233">sendAlert</span><span class="op" id="3876242">(</span><span class="ident" id="3876243">alertBadCertificate</span><span class="op" id="3876262">)</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3876267">return</span>&nbsp;<span class="ident" id="3876274">nil</span><span class="op" id="3876277">,</span>&nbsp;<span class="ident" id="3876279">errors</span><span class="op" id="3876285">.</span><span class="ident" id="3876286">New</span><span class="op" id="3876289">(</span><span class="string" id="3876290">&#34;tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;client&nbsp;certificate:&nbsp;&#34;</span>&nbsp;<span class="op" id="3876334">+</span>&nbsp;<span class="ident" id="3876336">err</span><span class="op" id="3876339">.</span><span class="ident" id="3876340">Error</span><span class="op" id="3876345">(</span><span class="op" id="3876346">)</span><span class="op" id="3876347">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3876351">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3876354">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3876358">if</span>&nbsp;<span class="ident" id="3876361">c</span><span class="op" id="3876362">.</span><span class="ident" id="3876363">config</span><span class="op" id="3876369">.</span><span class="ident" id="3876370">ClientAuth</span>&nbsp;<span class="op" id="3876381">&gt;=</span>&nbsp;<span class="ident" id="3876384">VerifyClientCertIfGiven</span>&nbsp;<span class="op" id="3876408">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3876411">len</span><span class="op" id="3876414">(</span><span class="ident" id="3876415">certs</span><span class="op" id="3876420">)</span>&nbsp;<span class="op" id="3876422">&gt;</span>&nbsp;<span class="num" id="3876424">0</span>&nbsp;<span class="op" id="3876426">{</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3876430">opts</span>&nbsp;<span class="op" id="3876435">:=</span>&nbsp;<span class="ident" id="3876438">x509</span><span class="op" id="3876442">.</span><span class="ident" id="3876443">VerifyOptions</span><span class="op" id="3876456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3876461">Roots</span><span class="op" id="3876466">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3876476">c</span><span class="op" id="3876477">.</span><span class="ident" id="3876478">config</span><span class="op" id="3876484">.</span><span class="ident" id="3876485">ClientCAs</span><span class="op" id="3876494">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3876499">CurrentTime</span><span class="op" id="3876510">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3876514">c</span><span class="op" id="3876515">.</span><span class="ident" id="3876516">config</span><span class="op" id="3876522">.</span><span class="ident" id="3876523">time</span><span class="op" id="3876527">(</span><span class="op" id="3876528">)</span><span class="op" id="3876529">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3876534">Intermediates</span><span class="op" id="3876547">:</span>&nbsp;<span class="ident" id="3876549">x509</span><span class="op" id="3876553">.</span><span class="ident" id="3876554">NewCertPool</span><span class="op" id="3876565">(</span><span class="op" id="3876566">)</span><span class="op" id="3876567">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3876572">KeyUsages</span><span class="op" id="3876581">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3876587">[</span><span class="op" id="3876588">]</span><span class="ident" id="3876589">x509</span><span class="op" id="3876593">.</span><span class="ident" id="3876594">ExtKeyUsage</span><span class="op" id="3876605">{</span><span class="ident" id="3876606">x509</span><span class="op" id="3876610">.</span><span class="ident" id="3876611">ExtKeyUsageClientAuth</span><span class="op" id="3876632">}</span><span class="op" id="3876633">,</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3876637">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3876642">for</span>&nbsp;<span class="ident" id="3876646">_</span><span class="op" id="3876647">,</span>&nbsp;<span class="ident" id="3876649">cert</span>&nbsp;<span class="op" id="3876654">:=</span>&nbsp;<span class="keyword" id="3876657">range</span>&nbsp;<span class="ident" id="3876663">certs</span><span class="op" id="3876668">[</span><span class="num" id="3876669">1</span><span class="op" id="3876670">:</span><span class="op" id="3876671">]</span>&nbsp;<span class="op" id="3876673">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3876678">opts</span><span class="op" id="3876682">.</span><span class="ident" id="3876683">Intermediates</span><span class="op" id="3876696">.</span><span class="ident" id="3876697">AddCert</span><span class="op" id="3876704">(</span><span class="ident" id="3876705">cert</span><span class="op" id="3876709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3876713">}</span><br>
<span class="lineno">615</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3876718">chains</span><span class="op" id="3876724">,</span>&nbsp;<span class="ident" id="3876726">err</span>&nbsp;<span class="op" id="3876730">:=</span>&nbsp;<span class="ident" id="3876733">certs</span><span class="op" id="3876738">[</span><span class="num" id="3876739">0</span><span class="op" id="3876740">]</span><span class="op" id="3876741">.</span><span class="ident" id="3876742">Verify</span><span class="op" id="3876748">(</span><span class="ident" id="3876749">opts</span><span class="op" id="3876753">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3876757">if</span>&nbsp;<span class="ident" id="3876760">err</span>&nbsp;<span class="op" id="3876764">!=</span>&nbsp;<span class="ident" id="3876767">nil</span>&nbsp;<span class="op" id="3876771">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3876776">c</span><span class="op" id="3876777">.</span><span class="ident" id="3876778">sendAlert</span><span class="op" id="3876787">(</span><span class="ident" id="3876788">alertBadCertificate</span><span class="op" id="3876807">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3876812">return</span>&nbsp;<span class="ident" id="3876819">nil</span><span class="op" id="3876822">,</span>&nbsp;<span class="ident" id="3876824">errors</span><span class="op" id="3876830">.</span><span class="ident" id="3876831">New</span><span class="op" id="3876834">(</span><span class="string" id="3876835">&#34;tls:&nbsp;failed&nbsp;to&nbsp;verify&nbsp;client&#39;s&nbsp;certificate:&nbsp;&#34;</span>&nbsp;<span class="op" id="3876882">+</span>&nbsp;<span class="ident" id="3876884">err</span><span class="op" id="3876887">.</span><span class="ident" id="3876888">Error</span><span class="op" id="3876893">(</span><span class="op" id="3876894">)</span><span class="op" id="3876895">)</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3876899">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3876904">ok</span>&nbsp;<span class="op" id="3876907">:=</span>&nbsp;<span class="builtintype" id="3876910">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3876918">for</span>&nbsp;<span class="ident" id="3876922">_</span><span class="op" id="3876923">,</span>&nbsp;<span class="ident" id="3876925">ku</span>&nbsp;<span class="op" id="3876928">:=</span>&nbsp;<span class="keyword" id="3876931">range</span>&nbsp;<span class="ident" id="3876937">certs</span><span class="op" id="3876942">[</span><span class="num" id="3876943">0</span><span class="op" id="3876944">]</span><span class="op" id="3876945">.</span><span class="ident" id="3876946">ExtKeyUsage</span>&nbsp;<span class="op" id="3876958">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3876963">if</span>&nbsp;<span class="ident" id="3876966">ku</span>&nbsp;<span class="op" id="3876969">==</span>&nbsp;<span class="ident" id="3876972">x509</span><span class="op" id="3876976">.</span><span class="ident" id="3876977">ExtKeyUsageClientAuth</span>&nbsp;<span class="op" id="3876999">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3877005">ok</span>&nbsp;<span class="op" id="3877008">=</span>&nbsp;<span class="builtintype" id="3877010">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3877019">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3877028">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3877032">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3877036">if</span>&nbsp;<span class="op" id="3877039">!</span><span class="ident" id="3877040">ok</span>&nbsp;<span class="op" id="3877043">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3877048">c</span><span class="op" id="3877049">.</span><span class="ident" id="3877050">sendAlert</span><span class="op" id="3877059">(</span><span class="ident" id="3877060">alertHandshakeFailure</span><span class="op" id="3877081">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3877086">return</span>&nbsp;<span class="ident" id="3877093">nil</span><span class="op" id="3877096">,</span>&nbsp;<span class="ident" id="3877098">errors</span><span class="op" id="3877104">.</span><span class="ident" id="3877105">New</span><span class="op" id="3877108">(</span><span class="string" id="3877109">&#34;tls:&nbsp;client&#39;s&nbsp;certificate&#39;s&nbsp;extended&nbsp;key&nbsp;usage&nbsp;doesn&#39;t&nbsp;permit&nbsp;it&nbsp;to&nbsp;be&nbsp;used&nbsp;for&nbsp;client&nbsp;authentication&#34;</span><span class="op" id="3877212">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3877216">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3877221">c</span><span class="op" id="3877222">.</span><span class="ident" id="3877223">verifiedChains</span>&nbsp;<span class="op" id="3877238">=</span>&nbsp;<span class="ident" id="3877240">chains</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3877248">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3877252">if</span>&nbsp;<span class="builtinfunc" id="3877255">len</span><span class="op" id="3877258">(</span><span class="ident" id="3877259">certs</span><span class="op" id="3877264">)</span>&nbsp;<span class="op" id="3877266">&gt;</span>&nbsp;<span class="num" id="3877268">0</span>&nbsp;<span class="op" id="3877270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3877274">var</span>&nbsp;<span class="ident" id="3877278">pub</span>&nbsp;<span class="ident" id="3877282">crypto</span><span class="op" id="3877288">.</span><span class="ident" id="3877289">PublicKey</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3877301">switch</span>&nbsp;<span class="ident" id="3877308">key</span>&nbsp;<span class="op" id="3877312">:=</span>&nbsp;<span class="ident" id="3877315">certs</span><span class="op" id="3877320">[</span><span class="num" id="3877321">0</span><span class="op" id="3877322">]</span><span class="op" id="3877323">.</span><span class="ident" id="3877324">PublicKey</span><span class="op" id="3877333">.</span><span class="op" id="3877334">(</span><span class="keyword" id="3877335">type</span><span class="op" id="3877339">)</span>&nbsp;<span class="op" id="3877341">{</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3877345">case</span>&nbsp;<span class="op" id="3877350">*</span><span class="ident" id="3877351">ecdsa</span><span class="op" id="3877356">.</span><span class="ident" id="3877357">PublicKey</span><span class="op" id="3877366">,</span>&nbsp;<span class="op" id="3877368">*</span><span class="ident" id="3877369">rsa</span><span class="op" id="3877372">.</span><span class="ident" id="3877373">PublicKey</span><span class="op" id="3877382">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3877387">pub</span>&nbsp;<span class="op" id="3877391">=</span>&nbsp;<span class="ident" id="3877393">key</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3877399">default</span><span class="op" id="3877406">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3877411">c</span><span class="op" id="3877412">.</span><span class="ident" id="3877413">sendAlert</span><span class="op" id="3877422">(</span><span class="ident" id="3877423">alertUnsupportedCertificate</span><span class="op" id="3877450">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3877455">return</span>&nbsp;<span class="ident" id="3877462">nil</span><span class="op" id="3877465">,</span>&nbsp;<span class="ident" id="3877467">fmt</span><span class="op" id="3877470">.</span><span class="ident" id="3877471">Errorf</span><span class="op" id="3877477">(</span><span class="string" id="3877478">&#34;tls:&nbsp;client&#39;s&nbsp;certificate&nbsp;contains&nbsp;an&nbsp;unsupported&nbsp;public&nbsp;key&nbsp;of&nbsp;type&nbsp;%T&#34;</span><span class="op" id="3877551">,</span>&nbsp;<span class="ident" id="3877553">certs</span><span class="op" id="3877558">[</span><span class="num" id="3877559">0</span><span class="op" id="3877560">]</span><span class="op" id="3877561">.</span><span class="ident" id="3877562">PublicKey</span><span class="op" id="3877571">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3877575">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3877579">c</span><span class="op" id="3877580">.</span><span class="ident" id="3877581">peerCertificates</span>&nbsp;<span class="op" id="3877598">=</span>&nbsp;<span class="ident" id="3877600">certs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3877608">return</span>&nbsp;<span class="ident" id="3877615">pub</span><span class="op" id="3877618">,</span>&nbsp;<span class="ident" id="3877620">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3877625">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3877629">return</span>&nbsp;<span class="ident" id="3877636">nil</span><span class="op" id="3877639">,</span>&nbsp;<span class="ident" id="3877641">nil</span><br>
<span class="lineno"></span><span class="op" id="3877645">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3877648">//&nbsp;tryCipherSuite&nbsp;returns&nbsp;a&nbsp;cipherSuite&nbsp;with&nbsp;the&nbsp;given&nbsp;id&nbsp;if&nbsp;that&nbsp;cipher&nbsp;suite</span><br>
<span class="lineno"></span><span class="comment" id="3877727">//&nbsp;is&nbsp;acceptable&nbsp;to&nbsp;use.</span><br>
<span class="lineno">655</span><span class="keyword" id="3877752">func</span>&nbsp;<span class="op" id="3877757">(</span><span class="ident" id="3877758">c</span>&nbsp;<span class="op" id="3877760">*</span><span class="ident" id="3877761">Conn</span><span class="op" id="3877765">)</span>&nbsp;<span class="ident" id="3877767">tryCipherSuite</span><span class="op" id="3877781">(</span><span class="ident" id="3877782">id</span>&nbsp;<span class="builtintype" id="3877785">uint16</span><span class="op" id="3877791">,</span>&nbsp;<span class="ident" id="3877793">supportedCipherSuites</span>&nbsp;<span class="op" id="3877815">[</span><span class="op" id="3877816">]</span><span class="builtintype" id="3877817">uint16</span><span class="op" id="3877823">,</span>&nbsp;<span class="ident" id="3877825">version</span>&nbsp;<span class="builtintype" id="3877833">uint16</span><span class="op" id="3877839">,</span>&nbsp;<span class="ident" id="3877841">ellipticOk</span><span class="op" id="3877851">,</span>&nbsp;<span class="ident" id="3877853">ecdsaOk</span>&nbsp;<span class="builtintype" id="3877861">bool</span><span class="op" id="3877865">)</span>&nbsp;<span class="op" id="3877867">*</span><span class="ident" id="3877868">cipherSuite</span>&nbsp;<span class="op" id="3877880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3877883">for</span>&nbsp;<span class="ident" id="3877887">_</span><span class="op" id="3877888">,</span>&nbsp;<span class="ident" id="3877890">supported</span>&nbsp;<span class="op" id="3877900">:=</span>&nbsp;<span class="keyword" id="3877903">range</span>&nbsp;<span class="ident" id="3877909">supportedCipherSuites</span>&nbsp;<span class="op" id="3877931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3877935">if</span>&nbsp;<span class="ident" id="3877938">id</span>&nbsp;<span class="op" id="3877941">==</span>&nbsp;<span class="ident" id="3877944">supported</span>&nbsp;<span class="op" id="3877954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3877959">var</span>&nbsp;<span class="ident" id="3877963">candidate</span>&nbsp;<span class="op" id="3877973">*</span><span class="ident" id="3877974">cipherSuite</span><br>
<span class="lineno"></span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3877990">for</span>&nbsp;<span class="ident" id="3877994">_</span><span class="op" id="3877995">,</span>&nbsp;<span class="ident" id="3877997">s</span>&nbsp;<span class="op" id="3877999">:=</span>&nbsp;<span class="keyword" id="3878002">range</span>&nbsp;<span class="ident" id="3878008">cipherSuites</span>&nbsp;<span class="op" id="3878021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3878027">if</span>&nbsp;<span class="ident" id="3878030">s</span><span class="op" id="3878031">.</span><span class="ident" id="3878032">id</span>&nbsp;<span class="op" id="3878035">==</span>&nbsp;<span class="ident" id="3878038">id</span>&nbsp;<span class="op" id="3878041">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3878048">candidate</span>&nbsp;<span class="op" id="3878058">=</span>&nbsp;<span class="ident" id="3878060">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3878067">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3878077">}</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3878082">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3878087">if</span>&nbsp;<span class="ident" id="3878090">candidate</span>&nbsp;<span class="op" id="3878100">==</span>&nbsp;<span class="ident" id="3878103">nil</span>&nbsp;<span class="op" id="3878107">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3878113">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3878125">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3878130">//&nbsp;Don&#39;t&nbsp;select&nbsp;a&nbsp;ciphersuite&nbsp;which&nbsp;we&nbsp;can&#39;t</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3878178">//&nbsp;support&nbsp;for&nbsp;this&nbsp;client.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3878209">if</span>&nbsp;<span class="op" id="3878212">(</span><span class="ident" id="3878213">candidate</span><span class="op" id="3878222">.</span><span class="ident" id="3878223">flags</span><span class="op" id="3878228">&amp;</span><span class="ident" id="3878229">suiteECDHE</span>&nbsp;<span class="op" id="3878240">!=</span>&nbsp;<span class="num" id="3878243">0</span><span class="op" id="3878244">)</span>&nbsp;<span class="op" id="3878246">&amp;&amp;</span>&nbsp;<span class="op" id="3878249">!</span><span class="ident" id="3878250">ellipticOk</span>&nbsp;<span class="op" id="3878261">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3878267">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3878279">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3878284">if</span>&nbsp;<span class="op" id="3878287">(</span><span class="ident" id="3878288">candidate</span><span class="op" id="3878297">.</span><span class="ident" id="3878298">flags</span><span class="op" id="3878303">&amp;</span><span class="ident" id="3878304">suiteECDSA</span>&nbsp;<span class="op" id="3878315">!=</span>&nbsp;<span class="num" id="3878318">0</span><span class="op" id="3878319">)</span>&nbsp;<span class="op" id="3878321">!=</span>&nbsp;<span class="ident" id="3878324">ecdsaOk</span>&nbsp;<span class="op" id="3878332">{</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3878338">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3878350">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3878355">if</span>&nbsp;<span class="ident" id="3878358">version</span>&nbsp;<span class="op" id="3878366">&lt;</span>&nbsp;<span class="ident" id="3878368">VersionTLS12</span>&nbsp;<span class="op" id="3878381">&amp;&amp;</span>&nbsp;<span class="ident" id="3878384">candidate</span><span class="op" id="3878393">.</span><span class="ident" id="3878394">flags</span><span class="op" id="3878399">&amp;</span><span class="ident" id="3878400">suiteTLS12</span>&nbsp;<span class="op" id="3878411">!=</span>&nbsp;<span class="num" id="3878414">0</span>&nbsp;<span class="op" id="3878416">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3878422">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3878434">}</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3878439">return</span>&nbsp;<span class="ident" id="3878446">candidate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3878458">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3878461">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3878465">return</span>&nbsp;<span class="ident" id="3878472">nil</span><br>
<span class="lineno">685</span><span class="op" id="3878476">}</span>
</div>
</body>
</html>
