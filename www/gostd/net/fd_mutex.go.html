<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html" class="current">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3055381">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3055436">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3055490">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3055541">package</span>&nbsp;<span class="ident" id="3055549">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3055554">import</span>&nbsp;<span class="string" id="3055561">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3055576">//&nbsp;fdMutex&nbsp;is&nbsp;a&nbsp;specialized&nbsp;synchronization&nbsp;primitive</span><br>
<span class="lineno">10</span><span class="comment" id="3055630">//&nbsp;that&nbsp;manages&nbsp;lifetime&nbsp;of&nbsp;an&nbsp;fd&nbsp;and&nbsp;serializes&nbsp;access</span><br>
<span class="lineno"></span><span class="comment" id="3055686">//&nbsp;to&nbsp;Read&nbsp;and&nbsp;Write&nbsp;methods&nbsp;on&nbsp;netFD.</span><br>
<span class="lineno"></span><span class="keyword" id="3055725">type</span>&nbsp;<span class="ident" id="3055730">fdMutex</span>&nbsp;<span class="keyword" id="3055738">struct</span>&nbsp;<span class="op" id="3055745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3055748">state</span>&nbsp;<span class="ident" id="3055754">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3055762">rsema</span>&nbsp;<span class="builtintype" id="3055768">uint32</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3055776">wsema</span>&nbsp;<span class="builtintype" id="3055782">uint32</span><br>
<span class="lineno"></span><span class="op" id="3055789">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3055792">//&nbsp;fdMutex.state&nbsp;is&nbsp;organized&nbsp;as&nbsp;follows:</span><br>
<span class="lineno"></span><span class="comment" id="3055834">//&nbsp;1&nbsp;bit&nbsp;-&nbsp;whether&nbsp;netFD&nbsp;is&nbsp;closed,&nbsp;if&nbsp;set&nbsp;all&nbsp;subsequent&nbsp;lock&nbsp;operations&nbsp;will&nbsp;fail.</span><br>
<span class="lineno">20</span><span class="comment" id="3055919">//&nbsp;1&nbsp;bit&nbsp;-&nbsp;lock&nbsp;for&nbsp;read&nbsp;operations.</span><br>
<span class="lineno"></span><span class="comment" id="3055956">//&nbsp;1&nbsp;bit&nbsp;-&nbsp;lock&nbsp;for&nbsp;write&nbsp;operations.</span><br>
<span class="lineno"></span><span class="comment" id="3055994">//&nbsp;20&nbsp;bits&nbsp;-&nbsp;total&nbsp;number&nbsp;of&nbsp;references&nbsp;(read+write+misc).</span><br>
<span class="lineno"></span><span class="comment" id="3056053">//&nbsp;20&nbsp;bits&nbsp;-&nbsp;number&nbsp;of&nbsp;outstanding&nbsp;read&nbsp;waiters.</span><br>
<span class="lineno"></span><span class="comment" id="3056102">//&nbsp;20&nbsp;bits&nbsp;-&nbsp;number&nbsp;of&nbsp;outstanding&nbsp;write&nbsp;waiters.</span><br>
<span class="lineno">25</span><span class="keyword" id="3056152">const</span>&nbsp;<span class="op" id="3056158">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3056161">mutexClosed</span>&nbsp;&nbsp;<span class="op" id="3056174">=</span>&nbsp;<span class="num" id="3056176">1</span>&nbsp;<span class="op" id="3056178">&lt;&lt;</span>&nbsp;<span class="num" id="3056181">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3056184">mutexRLock</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3056197">=</span>&nbsp;<span class="num" id="3056199">1</span>&nbsp;<span class="op" id="3056201">&lt;&lt;</span>&nbsp;<span class="num" id="3056204">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3056207">mutexWLock</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3056220">=</span>&nbsp;<span class="num" id="3056222">1</span>&nbsp;<span class="op" id="3056224">&lt;&lt;</span>&nbsp;<span class="num" id="3056227">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3056230">mutexRef</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3056243">=</span>&nbsp;<span class="num" id="3056245">1</span>&nbsp;<span class="op" id="3056247">&lt;&lt;</span>&nbsp;<span class="num" id="3056250">3</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3056253">mutexRefMask</span>&nbsp;<span class="op" id="3056266">=</span>&nbsp;<span class="op" id="3056268">(</span><span class="num" id="3056269">1</span><span class="op" id="3056270">&lt;&lt;</span><span class="num" id="3056272">20</span>&nbsp;<span class="op" id="3056275">-</span>&nbsp;<span class="num" id="3056277">1</span><span class="op" id="3056278">)</span>&nbsp;<span class="op" id="3056280">&lt;&lt;</span>&nbsp;<span class="num" id="3056283">3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3056286">mutexRWait</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3056299">=</span>&nbsp;<span class="num" id="3056301">1</span>&nbsp;<span class="op" id="3056303">&lt;&lt;</span>&nbsp;<span class="num" id="3056306">23</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3056310">mutexRMask</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3056323">=</span>&nbsp;<span class="op" id="3056325">(</span><span class="num" id="3056326">1</span><span class="op" id="3056327">&lt;&lt;</span><span class="num" id="3056329">20</span>&nbsp;<span class="op" id="3056332">-</span>&nbsp;<span class="num" id="3056334">1</span><span class="op" id="3056335">)</span>&nbsp;<span class="op" id="3056337">&lt;&lt;</span>&nbsp;<span class="num" id="3056340">23</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3056344">mutexWWait</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3056357">=</span>&nbsp;<span class="num" id="3056359">1</span>&nbsp;<span class="op" id="3056361">&lt;&lt;</span>&nbsp;<span class="num" id="3056364">43</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3056368">mutexWMask</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3056381">=</span>&nbsp;<span class="op" id="3056383">(</span><span class="num" id="3056384">1</span><span class="op" id="3056385">&lt;&lt;</span><span class="num" id="3056387">20</span>&nbsp;<span class="op" id="3056390">-</span>&nbsp;<span class="num" id="3056392">1</span><span class="op" id="3056393">)</span>&nbsp;<span class="op" id="3056395">&lt;&lt;</span>&nbsp;<span class="num" id="3056398">43</span><br>
<span class="lineno">35</span><span class="op" id="3056401">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3056404">//&nbsp;Read&nbsp;operations&nbsp;must&nbsp;do&nbsp;RWLock(true)/RWUnlock(true).</span><br>
<span class="lineno"></span><span class="comment" id="3056460">//&nbsp;Write&nbsp;operations&nbsp;must&nbsp;do&nbsp;RWLock(false)/RWUnlock(false).</span><br>
<span class="lineno"></span><span class="comment" id="3056519">//&nbsp;Misc&nbsp;operations&nbsp;must&nbsp;do&nbsp;Incref/Decref.&nbsp;Misc&nbsp;operations&nbsp;include&nbsp;functions&nbsp;like</span><br>
<span class="lineno">40</span><span class="comment" id="3056600">//&nbsp;setsockopt&nbsp;and&nbsp;setDeadline.&nbsp;They&nbsp;need&nbsp;to&nbsp;use&nbsp;Incref/Decref&nbsp;to&nbsp;ensure&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3056677">//&nbsp;they&nbsp;operate&nbsp;on&nbsp;the&nbsp;correct&nbsp;fd&nbsp;in&nbsp;presence&nbsp;of&nbsp;a&nbsp;concurrent&nbsp;Close&nbsp;call</span><br>
<span class="lineno"></span><span class="comment" id="3056750">//&nbsp;(otherwise&nbsp;fd&nbsp;can&nbsp;be&nbsp;closed&nbsp;under&nbsp;their&nbsp;feet).</span><br>
<span class="lineno"></span><span class="comment" id="3056800">//&nbsp;Close&nbsp;operation&nbsp;must&nbsp;do&nbsp;IncrefAndClose/Decref.</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="3056851">//&nbsp;RWLock/Incref&nbsp;return&nbsp;whether&nbsp;fd&nbsp;is&nbsp;open.</span><br>
<span class="lineno"></span><span class="comment" id="3056895">//&nbsp;RWUnlock/Decref&nbsp;return&nbsp;whether&nbsp;fd&nbsp;is&nbsp;closed&nbsp;and&nbsp;there&nbsp;are&nbsp;no&nbsp;remaining&nbsp;references.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3056982">func</span>&nbsp;<span class="op" id="3056987">(</span><span class="ident" id="3056988">mu</span>&nbsp;<span class="op" id="3056991">*</span><span class="ident" id="3056992">fdMutex</span><span class="op" id="3056999">)</span>&nbsp;<span class="ident" id="3057001">Incref</span><span class="op" id="3057007">(</span><span class="op" id="3057008">)</span>&nbsp;<span class="builtintype" id="3057010">bool</span>&nbsp;<span class="op" id="3057015">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3057018">for</span>&nbsp;<span class="op" id="3057022">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3057026">old</span>&nbsp;<span class="op" id="3057030">:=</span>&nbsp;<span class="ident" id="3057033">atomic</span><span class="op" id="3057039">.</span><span class="ident" id="3057040">LoadUint64</span><span class="op" id="3057050">(</span><span class="op" id="3057051">&amp;</span><span class="ident" id="3057052">mu</span><span class="op" id="3057054">.</span><span class="ident" id="3057055">state</span><span class="op" id="3057060">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3057064">if</span>&nbsp;<span class="ident" id="3057067">old</span><span class="op" id="3057070">&amp;</span><span class="ident" id="3057071">mutexClosed</span>&nbsp;<span class="op" id="3057083">!=</span>&nbsp;<span class="num" id="3057086">0</span>&nbsp;<span class="op" id="3057088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3057093">return</span>&nbsp;<span class="builtintype" id="3057100">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3057108">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3057112">new</span>&nbsp;<span class="op" id="3057116">:=</span>&nbsp;<span class="ident" id="3057119">old</span>&nbsp;<span class="op" id="3057123">+</span>&nbsp;<span class="ident" id="3057125">mutexRef</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3057136">if</span>&nbsp;<span class="builtinfunc" id="3057139">new</span><span class="op" id="3057142">&amp;</span><span class="ident" id="3057143">mutexRefMask</span>&nbsp;<span class="op" id="3057156">==</span>&nbsp;<span class="num" id="3057159">0</span>&nbsp;<span class="op" id="3057161">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3057166">panic</span><span class="op" id="3057171">(</span><span class="string" id="3057172">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="3057199">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3057203">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3057207">if</span>&nbsp;<span class="ident" id="3057210">atomic</span><span class="op" id="3057216">.</span><span class="ident" id="3057217">CompareAndSwapUint64</span><span class="op" id="3057237">(</span><span class="op" id="3057238">&amp;</span><span class="ident" id="3057239">mu</span><span class="op" id="3057241">.</span><span class="ident" id="3057242">state</span><span class="op" id="3057247">,</span>&nbsp;<span class="ident" id="3057249">old</span><span class="op" id="3057252">,</span>&nbsp;<span class="builtinfunc" id="3057254">new</span><span class="op" id="3057257">)</span>&nbsp;<span class="op" id="3057259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3057264">return</span>&nbsp;<span class="builtintype" id="3057271">true</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3057278">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3057281">}</span><br>
<span class="lineno"></span><span class="op" id="3057283">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3057286">func</span>&nbsp;<span class="op" id="3057291">(</span><span class="ident" id="3057292">mu</span>&nbsp;<span class="op" id="3057295">*</span><span class="ident" id="3057296">fdMutex</span><span class="op" id="3057303">)</span>&nbsp;<span class="ident" id="3057305">IncrefAndClose</span><span class="op" id="3057319">(</span><span class="op" id="3057320">)</span>&nbsp;<span class="builtintype" id="3057322">bool</span>&nbsp;<span class="op" id="3057327">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3057330">for</span>&nbsp;<span class="op" id="3057334">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3057338">old</span>&nbsp;<span class="op" id="3057342">:=</span>&nbsp;<span class="ident" id="3057345">atomic</span><span class="op" id="3057351">.</span><span class="ident" id="3057352">LoadUint64</span><span class="op" id="3057362">(</span><span class="op" id="3057363">&amp;</span><span class="ident" id="3057364">mu</span><span class="op" id="3057366">.</span><span class="ident" id="3057367">state</span><span class="op" id="3057372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3057376">if</span>&nbsp;<span class="ident" id="3057379">old</span><span class="op" id="3057382">&amp;</span><span class="ident" id="3057383">mutexClosed</span>&nbsp;<span class="op" id="3057395">!=</span>&nbsp;<span class="num" id="3057398">0</span>&nbsp;<span class="op" id="3057400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3057405">return</span>&nbsp;<span class="builtintype" id="3057412">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3057420">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3057424">//&nbsp;Mark&nbsp;as&nbsp;closed&nbsp;and&nbsp;acquire&nbsp;a&nbsp;reference.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3057469">new</span>&nbsp;<span class="op" id="3057473">:=</span>&nbsp;<span class="op" id="3057476">(</span><span class="ident" id="3057477">old</span>&nbsp;<span class="op" id="3057481">|</span>&nbsp;<span class="ident" id="3057483">mutexClosed</span><span class="op" id="3057494">)</span>&nbsp;<span class="op" id="3057496">+</span>&nbsp;<span class="ident" id="3057498">mutexRef</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3057509">if</span>&nbsp;<span class="builtinfunc" id="3057512">new</span><span class="op" id="3057515">&amp;</span><span class="ident" id="3057516">mutexRefMask</span>&nbsp;<span class="op" id="3057529">==</span>&nbsp;<span class="num" id="3057532">0</span>&nbsp;<span class="op" id="3057534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3057539">panic</span><span class="op" id="3057544">(</span><span class="string" id="3057545">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="3057572">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3057576">}</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3057580">//&nbsp;Remove&nbsp;all&nbsp;read&nbsp;and&nbsp;write&nbsp;waiters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3057620">new</span>&nbsp;<span class="op" id="3057624">&amp;^=</span>&nbsp;<span class="ident" id="3057628">mutexRMask</span>&nbsp;<span class="op" id="3057639">|</span>&nbsp;<span class="ident" id="3057641">mutexWMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3057654">if</span>&nbsp;<span class="ident" id="3057657">atomic</span><span class="op" id="3057663">.</span><span class="ident" id="3057664">CompareAndSwapUint64</span><span class="op" id="3057684">(</span><span class="op" id="3057685">&amp;</span><span class="ident" id="3057686">mu</span><span class="op" id="3057688">.</span><span class="ident" id="3057689">state</span><span class="op" id="3057694">,</span>&nbsp;<span class="ident" id="3057696">old</span><span class="op" id="3057699">,</span>&nbsp;<span class="builtinfunc" id="3057701">new</span><span class="op" id="3057704">)</span>&nbsp;<span class="op" id="3057706">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3057711">//&nbsp;Wake&nbsp;all&nbsp;read&nbsp;and&nbsp;write&nbsp;waiters,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3057750">//&nbsp;they&nbsp;will&nbsp;observe&nbsp;closed&nbsp;flag&nbsp;after&nbsp;wakeup.</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3057800">for</span>&nbsp;<span class="ident" id="3057804">old</span><span class="op" id="3057807">&amp;</span><span class="ident" id="3057808">mutexRMask</span>&nbsp;<span class="op" id="3057819">!=</span>&nbsp;<span class="num" id="3057822">0</span>&nbsp;<span class="op" id="3057824">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3057830">old</span>&nbsp;<span class="op" id="3057834">-=</span>&nbsp;<span class="ident" id="3057837">mutexRWait</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3057852">runtime_Semrelease</span><span class="op" id="3057870">(</span><span class="op" id="3057871">&amp;</span><span class="ident" id="3057872">mu</span><span class="op" id="3057874">.</span><span class="ident" id="3057875">rsema</span><span class="op" id="3057880">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3057885">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3057890">for</span>&nbsp;<span class="ident" id="3057894">old</span><span class="op" id="3057897">&amp;</span><span class="ident" id="3057898">mutexWMask</span>&nbsp;<span class="op" id="3057909">!=</span>&nbsp;<span class="num" id="3057912">0</span>&nbsp;<span class="op" id="3057914">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3057920">old</span>&nbsp;<span class="op" id="3057924">-=</span>&nbsp;<span class="ident" id="3057927">mutexWWait</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3057942">runtime_Semrelease</span><span class="op" id="3057960">(</span><span class="op" id="3057961">&amp;</span><span class="ident" id="3057962">mu</span><span class="op" id="3057964">.</span><span class="ident" id="3057965">wsema</span><span class="op" id="3057970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3057975">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3057980">return</span>&nbsp;<span class="builtintype" id="3057987">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3057994">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3057997">}</span><br>
<span class="lineno"></span><span class="op" id="3057999">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3058002">func</span>&nbsp;<span class="op" id="3058007">(</span><span class="ident" id="3058008">mu</span>&nbsp;<span class="op" id="3058011">*</span><span class="ident" id="3058012">fdMutex</span><span class="op" id="3058019">)</span>&nbsp;<span class="ident" id="3058021">Decref</span><span class="op" id="3058027">(</span><span class="op" id="3058028">)</span>&nbsp;<span class="builtintype" id="3058030">bool</span>&nbsp;<span class="op" id="3058035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3058038">for</span>&nbsp;<span class="op" id="3058042">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3058046">old</span>&nbsp;<span class="op" id="3058050">:=</span>&nbsp;<span class="ident" id="3058053">atomic</span><span class="op" id="3058059">.</span><span class="ident" id="3058060">LoadUint64</span><span class="op" id="3058070">(</span><span class="op" id="3058071">&amp;</span><span class="ident" id="3058072">mu</span><span class="op" id="3058074">.</span><span class="ident" id="3058075">state</span><span class="op" id="3058080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3058084">if</span>&nbsp;<span class="ident" id="3058087">old</span><span class="op" id="3058090">&amp;</span><span class="ident" id="3058091">mutexRefMask</span>&nbsp;<span class="op" id="3058104">==</span>&nbsp;<span class="num" id="3058107">0</span>&nbsp;<span class="op" id="3058109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3058114">panic</span><span class="op" id="3058119">(</span><span class="string" id="3058120">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="3058147">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3058151">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3058155">new</span>&nbsp;<span class="op" id="3058159">:=</span>&nbsp;<span class="ident" id="3058162">old</span>&nbsp;<span class="op" id="3058166">-</span>&nbsp;<span class="ident" id="3058168">mutexRef</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3058179">if</span>&nbsp;<span class="ident" id="3058182">atomic</span><span class="op" id="3058188">.</span><span class="ident" id="3058189">CompareAndSwapUint64</span><span class="op" id="3058209">(</span><span class="op" id="3058210">&amp;</span><span class="ident" id="3058211">mu</span><span class="op" id="3058213">.</span><span class="ident" id="3058214">state</span><span class="op" id="3058219">,</span>&nbsp;<span class="ident" id="3058221">old</span><span class="op" id="3058224">,</span>&nbsp;<span class="builtinfunc" id="3058226">new</span><span class="op" id="3058229">)</span>&nbsp;<span class="op" id="3058231">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3058236">return</span>&nbsp;<span class="builtinfunc" id="3058243">new</span><span class="op" id="3058246">&amp;</span><span class="op" id="3058247">(</span><span class="ident" id="3058248">mutexClosed</span><span class="op" id="3058259">|</span><span class="ident" id="3058260">mutexRefMask</span><span class="op" id="3058272">)</span>&nbsp;<span class="op" id="3058274">==</span>&nbsp;<span class="ident" id="3058277">mutexClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3058291">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3058294">}</span><br>
<span class="lineno"></span><span class="op" id="3058296">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="keyword" id="3058299">func</span>&nbsp;<span class="op" id="3058304">(</span><span class="ident" id="3058305">mu</span>&nbsp;<span class="op" id="3058308">*</span><span class="ident" id="3058309">fdMutex</span><span class="op" id="3058316">)</span>&nbsp;<span class="ident" id="3058318">RWLock</span><span class="op" id="3058324">(</span><span class="ident" id="3058325">read</span>&nbsp;<span class="builtintype" id="3058330">bool</span><span class="op" id="3058334">)</span>&nbsp;<span class="builtintype" id="3058336">bool</span>&nbsp;<span class="op" id="3058341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3058344">var</span>&nbsp;<span class="ident" id="3058348">mutexBit</span><span class="op" id="3058356">,</span>&nbsp;<span class="ident" id="3058358">mutexWait</span><span class="op" id="3058367">,</span>&nbsp;<span class="ident" id="3058369">mutexMask</span>&nbsp;<span class="ident" id="3058379">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3058387">var</span>&nbsp;<span class="ident" id="3058391">mutexSema</span>&nbsp;<span class="op" id="3058401">*</span><span class="builtintype" id="3058402">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3058410">if</span>&nbsp;<span class="ident" id="3058413">read</span>&nbsp;<span class="op" id="3058418">{</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3058422">mutexBit</span>&nbsp;<span class="op" id="3058431">=</span>&nbsp;<span class="ident" id="3058433">mutexRLock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3058446">mutexWait</span>&nbsp;<span class="op" id="3058456">=</span>&nbsp;<span class="ident" id="3058458">mutexRWait</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3058471">mutexMask</span>&nbsp;<span class="op" id="3058481">=</span>&nbsp;<span class="ident" id="3058483">mutexRMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3058496">mutexSema</span>&nbsp;<span class="op" id="3058506">=</span>&nbsp;<span class="op" id="3058508">&amp;</span><span class="ident" id="3058509">mu</span><span class="op" id="3058511">.</span><span class="ident" id="3058512">rsema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3058519">}</span>&nbsp;<span class="keyword" id="3058521">else</span>&nbsp;<span class="op" id="3058526">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3058530">mutexBit</span>&nbsp;<span class="op" id="3058539">=</span>&nbsp;<span class="ident" id="3058541">mutexWLock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3058554">mutexWait</span>&nbsp;<span class="op" id="3058564">=</span>&nbsp;<span class="ident" id="3058566">mutexWWait</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3058579">mutexMask</span>&nbsp;<span class="op" id="3058589">=</span>&nbsp;<span class="ident" id="3058591">mutexWMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3058604">mutexSema</span>&nbsp;<span class="op" id="3058614">=</span>&nbsp;<span class="op" id="3058616">&amp;</span><span class="ident" id="3058617">mu</span><span class="op" id="3058619">.</span><span class="ident" id="3058620">wsema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3058627">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3058630">for</span>&nbsp;<span class="op" id="3058634">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3058638">old</span>&nbsp;<span class="op" id="3058642">:=</span>&nbsp;<span class="ident" id="3058645">atomic</span><span class="op" id="3058651">.</span><span class="ident" id="3058652">LoadUint64</span><span class="op" id="3058662">(</span><span class="op" id="3058663">&amp;</span><span class="ident" id="3058664">mu</span><span class="op" id="3058666">.</span><span class="ident" id="3058667">state</span><span class="op" id="3058672">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3058676">if</span>&nbsp;<span class="ident" id="3058679">old</span><span class="op" id="3058682">&amp;</span><span class="ident" id="3058683">mutexClosed</span>&nbsp;<span class="op" id="3058695">!=</span>&nbsp;<span class="num" id="3058698">0</span>&nbsp;<span class="op" id="3058700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3058705">return</span>&nbsp;<span class="builtintype" id="3058712">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3058720">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3058724">var</span>&nbsp;<span class="builtinfunc" id="3058728">new</span>&nbsp;<span class="ident" id="3058732">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3058741">if</span>&nbsp;<span class="ident" id="3058744">old</span><span class="op" id="3058747">&amp;</span><span class="ident" id="3058748">mutexBit</span>&nbsp;<span class="op" id="3058757">==</span>&nbsp;<span class="num" id="3058760">0</span>&nbsp;<span class="op" id="3058762">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3058767">//&nbsp;Lock&nbsp;is&nbsp;free,&nbsp;acquire&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3058799">new</span>&nbsp;<span class="op" id="3058803">=</span>&nbsp;<span class="op" id="3058805">(</span><span class="ident" id="3058806">old</span>&nbsp;<span class="op" id="3058810">|</span>&nbsp;<span class="ident" id="3058812">mutexBit</span><span class="op" id="3058820">)</span>&nbsp;<span class="op" id="3058822">+</span>&nbsp;<span class="ident" id="3058824">mutexRef</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3058836">if</span>&nbsp;<span class="builtinfunc" id="3058839">new</span><span class="op" id="3058842">&amp;</span><span class="ident" id="3058843">mutexRefMask</span>&nbsp;<span class="op" id="3058856">==</span>&nbsp;<span class="num" id="3058859">0</span>&nbsp;<span class="op" id="3058861">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3058867">panic</span><span class="op" id="3058872">(</span><span class="string" id="3058873">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="3058900">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3058905">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3058909">}</span>&nbsp;<span class="keyword" id="3058911">else</span>&nbsp;<span class="op" id="3058916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3058921">//&nbsp;Wait&nbsp;for&nbsp;lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3058942">new</span>&nbsp;<span class="op" id="3058946">=</span>&nbsp;<span class="ident" id="3058948">old</span>&nbsp;<span class="op" id="3058952">+</span>&nbsp;<span class="ident" id="3058954">mutexWait</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3058967">if</span>&nbsp;<span class="builtinfunc" id="3058970">new</span><span class="op" id="3058973">&amp;</span><span class="ident" id="3058974">mutexMask</span>&nbsp;<span class="op" id="3058984">==</span>&nbsp;<span class="num" id="3058987">0</span>&nbsp;<span class="op" id="3058989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3058995">panic</span><span class="op" id="3059000">(</span><span class="string" id="3059001">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="3059028">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3059033">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3059037">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3059041">if</span>&nbsp;<span class="ident" id="3059044">atomic</span><span class="op" id="3059050">.</span><span class="ident" id="3059051">CompareAndSwapUint64</span><span class="op" id="3059071">(</span><span class="op" id="3059072">&amp;</span><span class="ident" id="3059073">mu</span><span class="op" id="3059075">.</span><span class="ident" id="3059076">state</span><span class="op" id="3059081">,</span>&nbsp;<span class="ident" id="3059083">old</span><span class="op" id="3059086">,</span>&nbsp;<span class="builtinfunc" id="3059088">new</span><span class="op" id="3059091">)</span>&nbsp;<span class="op" id="3059093">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3059098">if</span>&nbsp;<span class="ident" id="3059101">old</span><span class="op" id="3059104">&amp;</span><span class="ident" id="3059105">mutexBit</span>&nbsp;<span class="op" id="3059114">==</span>&nbsp;<span class="num" id="3059117">0</span>&nbsp;<span class="op" id="3059119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3059125">return</span>&nbsp;<span class="builtintype" id="3059132">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3059140">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3059145">runtime_Semacquire</span><span class="op" id="3059163">(</span><span class="ident" id="3059164">mutexSema</span><span class="op" id="3059173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3059178">//&nbsp;The&nbsp;signaller&nbsp;has&nbsp;subtracted&nbsp;mutexWait.</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3059223">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3059226">}</span><br>
<span class="lineno"></span><span class="op" id="3059228">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3059231">func</span>&nbsp;<span class="op" id="3059236">(</span><span class="ident" id="3059237">mu</span>&nbsp;<span class="op" id="3059240">*</span><span class="ident" id="3059241">fdMutex</span><span class="op" id="3059248">)</span>&nbsp;<span class="ident" id="3059250">RWUnlock</span><span class="op" id="3059258">(</span><span class="ident" id="3059259">read</span>&nbsp;<span class="builtintype" id="3059264">bool</span><span class="op" id="3059268">)</span>&nbsp;<span class="builtintype" id="3059270">bool</span>&nbsp;<span class="op" id="3059275">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3059278">var</span>&nbsp;<span class="ident" id="3059282">mutexBit</span><span class="op" id="3059290">,</span>&nbsp;<span class="ident" id="3059292">mutexWait</span><span class="op" id="3059301">,</span>&nbsp;<span class="ident" id="3059303">mutexMask</span>&nbsp;<span class="ident" id="3059313">uint64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3059321">var</span>&nbsp;<span class="ident" id="3059325">mutexSema</span>&nbsp;<span class="op" id="3059335">*</span><span class="builtintype" id="3059336">uint32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3059344">if</span>&nbsp;<span class="ident" id="3059347">read</span>&nbsp;<span class="op" id="3059352">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3059356">mutexBit</span>&nbsp;<span class="op" id="3059365">=</span>&nbsp;<span class="ident" id="3059367">mutexRLock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3059380">mutexWait</span>&nbsp;<span class="op" id="3059390">=</span>&nbsp;<span class="ident" id="3059392">mutexRWait</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3059405">mutexMask</span>&nbsp;<span class="op" id="3059415">=</span>&nbsp;<span class="ident" id="3059417">mutexRMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3059430">mutexSema</span>&nbsp;<span class="op" id="3059440">=</span>&nbsp;<span class="op" id="3059442">&amp;</span><span class="ident" id="3059443">mu</span><span class="op" id="3059445">.</span><span class="ident" id="3059446">rsema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3059453">}</span>&nbsp;<span class="keyword" id="3059455">else</span>&nbsp;<span class="op" id="3059460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3059464">mutexBit</span>&nbsp;<span class="op" id="3059473">=</span>&nbsp;<span class="ident" id="3059475">mutexWLock</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3059488">mutexWait</span>&nbsp;<span class="op" id="3059498">=</span>&nbsp;<span class="ident" id="3059500">mutexWWait</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3059513">mutexMask</span>&nbsp;<span class="op" id="3059523">=</span>&nbsp;<span class="ident" id="3059525">mutexWMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3059538">mutexSema</span>&nbsp;<span class="op" id="3059548">=</span>&nbsp;<span class="op" id="3059550">&amp;</span><span class="ident" id="3059551">mu</span><span class="op" id="3059553">.</span><span class="ident" id="3059554">wsema</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3059561">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3059564">for</span>&nbsp;<span class="op" id="3059568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3059572">old</span>&nbsp;<span class="op" id="3059576">:=</span>&nbsp;<span class="ident" id="3059579">atomic</span><span class="op" id="3059585">.</span><span class="ident" id="3059586">LoadUint64</span><span class="op" id="3059596">(</span><span class="op" id="3059597">&amp;</span><span class="ident" id="3059598">mu</span><span class="op" id="3059600">.</span><span class="ident" id="3059601">state</span><span class="op" id="3059606">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3059610">if</span>&nbsp;<span class="ident" id="3059613">old</span><span class="op" id="3059616">&amp;</span><span class="ident" id="3059617">mutexBit</span>&nbsp;<span class="op" id="3059626">==</span>&nbsp;<span class="num" id="3059629">0</span>&nbsp;<span class="op" id="3059631">||</span>&nbsp;<span class="ident" id="3059634">old</span><span class="op" id="3059637">&amp;</span><span class="ident" id="3059638">mutexRefMask</span>&nbsp;<span class="op" id="3059651">==</span>&nbsp;<span class="num" id="3059654">0</span>&nbsp;<span class="op" id="3059656">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3059661">panic</span><span class="op" id="3059666">(</span><span class="string" id="3059667">&#34;net:&nbsp;inconsistent&nbsp;fdMutex&#34;</span><span class="op" id="3059694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3059698">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3059702">//&nbsp;Drop&nbsp;lock,&nbsp;drop&nbsp;reference&nbsp;and&nbsp;wake&nbsp;read&nbsp;waiter&nbsp;if&nbsp;present.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3059766">new</span>&nbsp;<span class="op" id="3059770">:=</span>&nbsp;<span class="op" id="3059773">(</span><span class="ident" id="3059774">old</span>&nbsp;<span class="op" id="3059778">&amp;^</span>&nbsp;<span class="ident" id="3059781">mutexBit</span><span class="op" id="3059789">)</span>&nbsp;<span class="op" id="3059791">-</span>&nbsp;<span class="ident" id="3059793">mutexRef</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3059804">if</span>&nbsp;<span class="ident" id="3059807">old</span><span class="op" id="3059810">&amp;</span><span class="ident" id="3059811">mutexMask</span>&nbsp;<span class="op" id="3059821">!=</span>&nbsp;<span class="num" id="3059824">0</span>&nbsp;<span class="op" id="3059826">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3059831">new</span>&nbsp;<span class="op" id="3059835">-=</span>&nbsp;<span class="ident" id="3059838">mutexWait</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3059850">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3059854">if</span>&nbsp;<span class="ident" id="3059857">atomic</span><span class="op" id="3059863">.</span><span class="ident" id="3059864">CompareAndSwapUint64</span><span class="op" id="3059884">(</span><span class="op" id="3059885">&amp;</span><span class="ident" id="3059886">mu</span><span class="op" id="3059888">.</span><span class="ident" id="3059889">state</span><span class="op" id="3059894">,</span>&nbsp;<span class="ident" id="3059896">old</span><span class="op" id="3059899">,</span>&nbsp;<span class="builtinfunc" id="3059901">new</span><span class="op" id="3059904">)</span>&nbsp;<span class="op" id="3059906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3059911">if</span>&nbsp;<span class="ident" id="3059914">old</span><span class="op" id="3059917">&amp;</span><span class="ident" id="3059918">mutexMask</span>&nbsp;<span class="op" id="3059928">!=</span>&nbsp;<span class="num" id="3059931">0</span>&nbsp;<span class="op" id="3059933">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3059939">runtime_Semrelease</span><span class="op" id="3059957">(</span><span class="ident" id="3059958">mutexSema</span><span class="op" id="3059967">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3059972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3059977">return</span>&nbsp;<span class="builtinfunc" id="3059984">new</span><span class="op" id="3059987">&amp;</span><span class="op" id="3059988">(</span><span class="ident" id="3059989">mutexClosed</span><span class="op" id="3060000">|</span><span class="ident" id="3060001">mutexRefMask</span><span class="op" id="3060013">)</span>&nbsp;<span class="op" id="3060015">==</span>&nbsp;<span class="ident" id="3060018">mutexClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3060032">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3060035">}</span><br>
<span class="lineno">180</span><span class="op" id="3060037">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3060040">//&nbsp;Implemented&nbsp;in&nbsp;runtime&nbsp;package.</span><br>
<span class="lineno"></span><span class="keyword" id="3060075">func</span>&nbsp;<span class="ident" id="3060080">runtime_Semacquire</span><span class="op" id="3060098">(</span><span class="ident" id="3060099">sema</span>&nbsp;<span class="op" id="3060104">*</span><span class="builtintype" id="3060105">uint32</span><span class="op" id="3060111">)</span><br>
<span class="lineno"></span><span class="keyword" id="3060113">func</span>&nbsp;<span class="ident" id="3060118">runtime_Semrelease</span><span class="op" id="3060136">(</span><span class="ident" id="3060137">sema</span>&nbsp;<span class="op" id="3060142">*</span><span class="builtintype" id="3060143">uint32</span><span class="op" id="3060149">)</span>
</div>
</body>
</html>
