<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/rpc</h2>
<ul>
<li><a href="/gostd/net/rpc/client.go.html">client.go</a></li>
<li><a href="/gostd/net/rpc/client_test.go.html">client_test.go</a></li>
<li><a href="/gostd/net/rpc/debug.go.html">debug.go</a></li>
<li><a href="/gostd/net/rpc/server.go.html" class="current">server.go</a></li>
<li><a href="/gostd/net/rpc/server_test.go.html">server_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5758650">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5758705">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5758759">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5758810">/*<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;Package&nbsp;rpc&nbsp;provides&nbsp;access&nbsp;to&nbsp;the&nbsp;exported&nbsp;methods&nbsp;of&nbsp;an&nbsp;object&nbsp;across&nbsp;a<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;network&nbsp;or&nbsp;other&nbsp;I/O&nbsp;connection.&nbsp;&nbsp;A&nbsp;server&nbsp;registers&nbsp;an&nbsp;object,&nbsp;making&nbsp;it&nbsp;visible<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;as&nbsp;a&nbsp;service&nbsp;with&nbsp;the&nbsp;name&nbsp;of&nbsp;the&nbsp;type&nbsp;of&nbsp;the&nbsp;object.&nbsp;&nbsp;After&nbsp;registration,&nbsp;exported<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;methods&nbsp;of&nbsp;the&nbsp;object&nbsp;will&nbsp;be&nbsp;accessible&nbsp;remotely.&nbsp;&nbsp;A&nbsp;server&nbsp;may&nbsp;register&nbsp;multiple<br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;objects&nbsp;(services)&nbsp;of&nbsp;different&nbsp;types&nbsp;but&nbsp;it&nbsp;is&nbsp;an&nbsp;error&nbsp;to&nbsp;register&nbsp;multiple<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;objects&nbsp;of&nbsp;the&nbsp;same&nbsp;type.<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;Only&nbsp;methods&nbsp;that&nbsp;satisfy&nbsp;these&nbsp;criteria&nbsp;will&nbsp;be&nbsp;made&nbsp;available&nbsp;for&nbsp;remote&nbsp;access;<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;other&nbsp;methods&nbsp;will&nbsp;be&nbsp;ignored:<br>
<span class="lineno">15</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;the&nbsp;method&nbsp;is&nbsp;exported.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;the&nbsp;method&nbsp;has&nbsp;two&nbsp;arguments,&nbsp;both&nbsp;exported&nbsp;(or&nbsp;builtin)&nbsp;types.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;the&nbsp;method&#39;s&nbsp;second&nbsp;argument&nbsp;is&nbsp;a&nbsp;pointer.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;the&nbsp;method&nbsp;has&nbsp;return&nbsp;type&nbsp;error.<br>
<span class="lineno">20</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;In&nbsp;effect,&nbsp;the&nbsp;method&nbsp;must&nbsp;look&nbsp;schematically&nbsp;like<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;func&nbsp;(t&nbsp;*T)&nbsp;MethodName(argType&nbsp;T1,&nbsp;replyType&nbsp;*T2)&nbsp;error<br>
<span class="lineno"></span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;where&nbsp;T,&nbsp;T1&nbsp;and&nbsp;T2&nbsp;can&nbsp;be&nbsp;marshaled&nbsp;by&nbsp;encoding/gob.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;These&nbsp;requirements&nbsp;apply&nbsp;even&nbsp;if&nbsp;a&nbsp;different&nbsp;codec&nbsp;is&nbsp;used.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;(In&nbsp;the&nbsp;future,&nbsp;these&nbsp;requirements&nbsp;may&nbsp;soften&nbsp;for&nbsp;custom&nbsp;codecs.)<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;The&nbsp;method&#39;s&nbsp;first&nbsp;argument&nbsp;represents&nbsp;the&nbsp;arguments&nbsp;provided&nbsp;by&nbsp;the&nbsp;caller;&nbsp;the<br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;second&nbsp;argument&nbsp;represents&nbsp;the&nbsp;result&nbsp;parameters&nbsp;to&nbsp;be&nbsp;returned&nbsp;to&nbsp;the&nbsp;caller.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;The&nbsp;method&#39;s&nbsp;return&nbsp;value,&nbsp;if&nbsp;non-nil,&nbsp;is&nbsp;passed&nbsp;back&nbsp;as&nbsp;a&nbsp;string&nbsp;that&nbsp;the&nbsp;client<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;sees&nbsp;as&nbsp;if&nbsp;created&nbsp;by&nbsp;errors.New.&nbsp;&nbsp;If&nbsp;an&nbsp;error&nbsp;is&nbsp;returned,&nbsp;the&nbsp;reply&nbsp;parameter<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;will&nbsp;not&nbsp;be&nbsp;sent&nbsp;back&nbsp;to&nbsp;the&nbsp;client.<br>
<span class="lineno"></span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp;The&nbsp;server&nbsp;may&nbsp;handle&nbsp;requests&nbsp;on&nbsp;a&nbsp;single&nbsp;connection&nbsp;by&nbsp;calling&nbsp;ServeConn.&nbsp;&nbsp;More<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;typically&nbsp;it&nbsp;will&nbsp;create&nbsp;a&nbsp;network&nbsp;listener&nbsp;and&nbsp;call&nbsp;Accept&nbsp;or,&nbsp;for&nbsp;an&nbsp;HTTP<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;listener,&nbsp;HandleHTTP&nbsp;and&nbsp;http.Serve.<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;A&nbsp;client&nbsp;wishing&nbsp;to&nbsp;use&nbsp;the&nbsp;service&nbsp;establishes&nbsp;a&nbsp;connection&nbsp;and&nbsp;then&nbsp;invokes<br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;NewClient&nbsp;on&nbsp;the&nbsp;connection.&nbsp;&nbsp;The&nbsp;convenience&nbsp;function&nbsp;Dial&nbsp;(DialHTTP)&nbsp;performs<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;both&nbsp;steps&nbsp;for&nbsp;a&nbsp;raw&nbsp;network&nbsp;connection&nbsp;(an&nbsp;HTTP&nbsp;connection).&nbsp;&nbsp;The&nbsp;resulting<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;Client&nbsp;object&nbsp;has&nbsp;two&nbsp;methods,&nbsp;Call&nbsp;and&nbsp;Go,&nbsp;that&nbsp;specify&nbsp;the&nbsp;service&nbsp;and&nbsp;method&nbsp;to<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;call,&nbsp;a&nbsp;pointer&nbsp;containing&nbsp;the&nbsp;arguments,&nbsp;and&nbsp;a&nbsp;pointer&nbsp;to&nbsp;receive&nbsp;the&nbsp;result<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;parameters.<br>
<span class="lineno">45</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;The&nbsp;Call&nbsp;method&nbsp;waits&nbsp;for&nbsp;the&nbsp;remote&nbsp;call&nbsp;to&nbsp;complete&nbsp;while&nbsp;the&nbsp;Go&nbsp;method<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;launches&nbsp;the&nbsp;call&nbsp;asynchronously&nbsp;and&nbsp;signals&nbsp;completion&nbsp;using&nbsp;the&nbsp;Call<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;structure&#39;s&nbsp;Done&nbsp;channel.<br>
<span class="lineno"></span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;Unless&nbsp;an&nbsp;explicit&nbsp;codec&nbsp;is&nbsp;set&nbsp;up,&nbsp;package&nbsp;encoding/gob&nbsp;is&nbsp;used&nbsp;to<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;transport&nbsp;the&nbsp;data.<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;Here&nbsp;is&nbsp;a&nbsp;simple&nbsp;example.&nbsp;&nbsp;A&nbsp;server&nbsp;wishes&nbsp;to&nbsp;export&nbsp;an&nbsp;object&nbsp;of&nbsp;type&nbsp;Arith:<br>
<span class="lineno"></span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;package&nbsp;server<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type&nbsp;Args&nbsp;struct&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A,&nbsp;B&nbsp;int<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type&nbsp;Quotient&nbsp;struct&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Quo,&nbsp;Rem&nbsp;int<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type&nbsp;Arith&nbsp;int<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;func&nbsp;(t&nbsp;*Arith)&nbsp;Multiply(args&nbsp;*Args,&nbsp;reply&nbsp;*int)&nbsp;error&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*reply&nbsp;=&nbsp;args.A&nbsp;*&nbsp;args.B<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;nil<br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;func&nbsp;(t&nbsp;*Arith)&nbsp;Divide(args&nbsp;*Args,&nbsp;quo&nbsp;*Quotient)&nbsp;error&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;args.B&nbsp;==&nbsp;0&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;errors.New(&#34;divide&nbsp;by&nbsp;zero&#34;)<br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;quo.Quo&nbsp;=&nbsp;args.A&nbsp;/&nbsp;args.B<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;quo.Rem&nbsp;=&nbsp;args.A&nbsp;%&nbsp;args.B<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;nil<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<span class="lineno">80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;The&nbsp;server&nbsp;calls&nbsp;(for&nbsp;HTTP&nbsp;service):<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;arith&nbsp;:=&nbsp;new(Arith)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rpc.Register(arith)<br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rpc.HandleHTTP()<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;l,&nbsp;e&nbsp;:=&nbsp;net.Listen(&#34;tcp&#34;,&nbsp;&#34;:1234&#34;)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;e&nbsp;!=&nbsp;nil&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.Fatal(&#34;listen&nbsp;error:&#34;,&nbsp;e)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;go&nbsp;http.Serve(l,&nbsp;nil)<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;At&nbsp;this&nbsp;point,&nbsp;clients&nbsp;can&nbsp;see&nbsp;a&nbsp;service&nbsp;&#34;Arith&#34;&nbsp;with&nbsp;methods&nbsp;&#34;Arith.Multiply&#34;&nbsp;and<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&#34;Arith.Divide&#34;.&nbsp;&nbsp;To&nbsp;invoke&nbsp;one,&nbsp;a&nbsp;client&nbsp;first&nbsp;dials&nbsp;the&nbsp;server:<br>
<span class="lineno"></span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;client,&nbsp;err&nbsp;:=&nbsp;rpc.DialHTTP(&#34;tcp&#34;,&nbsp;serverAddress&nbsp;+&nbsp;&#34;:1234&#34;)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;err&nbsp;!=&nbsp;nil&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.Fatal(&#34;dialing:&#34;,&nbsp;err)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<span class="lineno"></span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;Then&nbsp;it&nbsp;can&nbsp;make&nbsp;a&nbsp;remote&nbsp;call:<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Synchronous&nbsp;call<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;args&nbsp;:=&nbsp;&amp;server.Args{7,8}<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;reply&nbsp;int<br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err&nbsp;=&nbsp;client.Call(&#34;Arith.Multiply&#34;,&nbsp;args,&nbsp;&amp;reply)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;err&nbsp;!=&nbsp;nil&nbsp;{<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.Fatal(&#34;arith&nbsp;error:&#34;,&nbsp;err)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fmt.Printf(&#34;Arith:&nbsp;%d*%d=%d&#34;,&nbsp;args.A,&nbsp;args.B,&nbsp;reply)<br>
<span class="lineno">110</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;or<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Asynchronous&nbsp;call<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;quotient&nbsp;:=&nbsp;new(Quotient)<br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;divCall&nbsp;:=&nbsp;client.Go(&#34;Arith.Divide&#34;,&nbsp;args,&nbsp;quotient,&nbsp;nil)<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;replyCall&nbsp;:=&nbsp;&lt;-divCall.Done&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;will&nbsp;be&nbsp;equal&nbsp;to&nbsp;divCall<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;check&nbsp;errors,&nbsp;print,&nbsp;etc.<br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;A&nbsp;server&nbsp;implementation&nbsp;will&nbsp;often&nbsp;provide&nbsp;a&nbsp;simple,&nbsp;type-safe&nbsp;wrapper&nbsp;for&nbsp;the<br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;client.<br>
<span class="lineno"></span>*/</span><br>
<span class="lineno"></span><span class="keyword" id="5762639">package</span>&nbsp;<span class="ident" id="5762647">rpc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5762652">import</span>&nbsp;<span class="op" id="5762659">(</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5762662">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5762671">&#34;encoding/gob&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5762687">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5762697">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5762703">&#34;log&#34;</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5762710">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5762717">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5762729">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5762740">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5762751">&#34;sync&#34;</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5762759">&#34;unicode&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5762770">&#34;unicode/utf8&#34;</span><br>
<span class="lineno"></span><span class="op" id="5762785">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5762788">const</span>&nbsp;<span class="op" id="5762794">(</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5762797">//&nbsp;Defaults&nbsp;used&nbsp;by&nbsp;HandleHTTP</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5762829">DefaultRPCPath</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5762846">=</span>&nbsp;<span class="string" id="5762848">&#34;/_goRPC_&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5762860">DefaultDebugPath</span>&nbsp;<span class="op" id="5762877">=</span>&nbsp;<span class="string" id="5762879">&#34;/debug/rpc&#34;</span><br>
<span class="lineno"></span><span class="op" id="5762892">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">145</span><span class="comment" id="5762895">//&nbsp;Precompute&nbsp;the&nbsp;reflect&nbsp;type&nbsp;for&nbsp;error.&nbsp;&nbsp;Can&#39;t&nbsp;use&nbsp;error&nbsp;directly</span><br>
<span class="lineno"></span><span class="comment" id="5762963">//&nbsp;because&nbsp;Typeof&nbsp;takes&nbsp;an&nbsp;empty&nbsp;interface&nbsp;value.&nbsp;&nbsp;This&nbsp;is&nbsp;annoying.</span><br>
<span class="lineno"></span><span class="keyword" id="5763032">var</span>&nbsp;<span class="ident" id="5763036">typeOfError</span>&nbsp;<span class="op" id="5763048">=</span>&nbsp;<span class="ident" id="5763050">reflect</span><span class="op" id="5763057">.</span><span class="ident" id="5763058">TypeOf</span><span class="op" id="5763064">(</span><span class="op" id="5763065">(</span><span class="op" id="5763066">*</span><span class="builtintype" id="5763067">error</span><span class="op" id="5763072">)</span><span class="op" id="5763073">(</span><span class="builtintype" id="5763074">nil</span><span class="op" id="5763077">)</span><span class="op" id="5763078">)</span><span class="op" id="5763079">.</span><span class="ident" id="5763080">Elem</span><span class="op" id="5763084">(</span><span class="op" id="5763085">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5763088">type</span>&nbsp;<span class="ident" id="5763093">methodType</span>&nbsp;<span class="keyword" id="5763104">struct</span>&nbsp;<span class="op" id="5763111">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5763114">sync</span><span class="op" id="5763118">.</span><span class="ident" id="5763119">Mutex</span>&nbsp;<span class="comment" id="5763125">//&nbsp;protects&nbsp;counters</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5763147">method</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5763158">reflect</span><span class="op" id="5763165">.</span><span class="ident" id="5763166">Method</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5763174">ArgType</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5763185">reflect</span><span class="op" id="5763192">.</span><span class="ident" id="5763193">Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5763199">ReplyType</span>&nbsp;&nbsp;<span class="ident" id="5763210">reflect</span><span class="op" id="5763217">.</span><span class="ident" id="5763218">Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5763224">numCalls</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5763235">uint</span><br>
<span class="lineno">155</span><span class="op" id="5763240">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5763243">type</span>&nbsp;<span class="ident" id="5763248">service</span>&nbsp;<span class="keyword" id="5763256">struct</span>&nbsp;<span class="op" id="5763263">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5763266">name</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5763273">string</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5763296">//&nbsp;name&nbsp;of&nbsp;service</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5763316">rcvr</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5763323">reflect</span><span class="op" id="5763330">.</span><span class="ident" id="5763331">Value</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5763346">//&nbsp;receiver&nbsp;of&nbsp;methods&nbsp;for&nbsp;the&nbsp;service</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5763386">typ</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5763393">reflect</span><span class="op" id="5763400">.</span><span class="ident" id="5763401">Type</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5763416">//&nbsp;type&nbsp;of&nbsp;the&nbsp;receiver</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5763441">method</span>&nbsp;<span class="keyword" id="5763448">map</span><span class="op" id="5763451">[</span><span class="builtintype" id="5763452">string</span><span class="op" id="5763458">]</span><span class="op" id="5763459">*</span><span class="ident" id="5763460">methodType</span>&nbsp;<span class="comment" id="5763471">//&nbsp;registered&nbsp;methods</span><br>
<span class="lineno"></span><span class="op" id="5763493">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5763496">//&nbsp;Request&nbsp;is&nbsp;a&nbsp;header&nbsp;written&nbsp;before&nbsp;every&nbsp;RPC&nbsp;call.&nbsp;&nbsp;It&nbsp;is&nbsp;used&nbsp;internally</span><br>
<span class="lineno">165</span><span class="comment" id="5763573">//&nbsp;but&nbsp;documented&nbsp;here&nbsp;as&nbsp;an&nbsp;aid&nbsp;to&nbsp;debugging,&nbsp;such&nbsp;as&nbsp;when&nbsp;analyzing</span><br>
<span class="lineno"></span><span class="comment" id="5763643">//&nbsp;network&nbsp;traffic.</span><br>
<span class="lineno"></span><span class="keyword" id="5763663">type</span>&nbsp;<span class="ident" id="5763668">Request</span>&nbsp;<span class="keyword" id="5763676">struct</span>&nbsp;<span class="op" id="5763683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5763686">ServiceMethod</span>&nbsp;<span class="builtintype" id="5763700">string</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="5763709">//&nbsp;format:&nbsp;&#34;Service.Method&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5763738">Seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5763752">uint64</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="5763761">//&nbsp;sequence&nbsp;number&nbsp;chosen&nbsp;by&nbsp;client</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5763798">next</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5763812">*</span><span class="ident" id="5763813">Request</span>&nbsp;<span class="comment" id="5763821">//&nbsp;for&nbsp;free&nbsp;list&nbsp;in&nbsp;Server</span><br>
<span class="lineno"></span><span class="op" id="5763848">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5763851">//&nbsp;Response&nbsp;is&nbsp;a&nbsp;header&nbsp;written&nbsp;before&nbsp;every&nbsp;RPC&nbsp;return.&nbsp;&nbsp;It&nbsp;is&nbsp;used&nbsp;internally</span><br>
<span class="lineno"></span><span class="comment" id="5763931">//&nbsp;but&nbsp;documented&nbsp;here&nbsp;as&nbsp;an&nbsp;aid&nbsp;to&nbsp;debugging,&nbsp;such&nbsp;as&nbsp;when&nbsp;analyzing</span><br>
<span class="lineno">175</span><span class="comment" id="5764001">//&nbsp;network&nbsp;traffic.</span><br>
<span class="lineno"></span><span class="keyword" id="5764021">type</span>&nbsp;<span class="ident" id="5764026">Response</span>&nbsp;<span class="keyword" id="5764035">struct</span>&nbsp;<span class="op" id="5764042">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5764045">ServiceMethod</span>&nbsp;<span class="builtintype" id="5764059">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5764069">//&nbsp;echoes&nbsp;that&nbsp;of&nbsp;the&nbsp;Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5764100">Seq</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5764114">uint64</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5764124">//&nbsp;echoes&nbsp;that&nbsp;of&nbsp;the&nbsp;request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5764155">Error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5764169">string</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5764179">//&nbsp;error,&nbsp;if&nbsp;any.</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5764198">next</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5764212">*</span><span class="ident" id="5764213">Response</span>&nbsp;<span class="comment" id="5764222">//&nbsp;for&nbsp;free&nbsp;list&nbsp;in&nbsp;Server</span><br>
<span class="lineno"></span><span class="op" id="5764249">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5764252">//&nbsp;Server&nbsp;represents&nbsp;an&nbsp;RPC&nbsp;Server.</span><br>
<span class="lineno"></span><span class="keyword" id="5764288">type</span>&nbsp;<span class="ident" id="5764293">Server</span>&nbsp;<span class="keyword" id="5764300">struct</span>&nbsp;<span class="op" id="5764307">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5764310">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5764321">sync</span><span class="op" id="5764325">.</span><span class="ident" id="5764326">RWMutex</span>&nbsp;<span class="comment" id="5764334">//&nbsp;protects&nbsp;the&nbsp;serviceMap</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5764362">serviceMap</span>&nbsp;<span class="keyword" id="5764373">map</span><span class="op" id="5764376">[</span><span class="builtintype" id="5764377">string</span><span class="op" id="5764383">]</span><span class="op" id="5764384">*</span><span class="ident" id="5764385">service</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5764394">reqLock</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5764405">sync</span><span class="op" id="5764409">.</span><span class="ident" id="5764410">Mutex</span>&nbsp;<span class="comment" id="5764416">//&nbsp;protects&nbsp;freeReq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5764437">freeReq</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5764448">*</span><span class="ident" id="5764449">Request</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5764458">respLock</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5764469">sync</span><span class="op" id="5764473">.</span><span class="ident" id="5764474">Mutex</span>&nbsp;<span class="comment" id="5764480">//&nbsp;protects&nbsp;freeResp</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5764502">freeResp</span>&nbsp;&nbsp;&nbsp;<span class="op" id="5764513">*</span><span class="ident" id="5764514">Response</span><br>
<span class="lineno"></span><span class="op" id="5764523">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5764526">//&nbsp;NewServer&nbsp;returns&nbsp;a&nbsp;new&nbsp;Server.</span><br>
<span class="lineno"></span><span class="keyword" id="5764561">func</span>&nbsp;<span class="ident" id="5764566">NewServer</span><span class="op" id="5764575">(</span><span class="op" id="5764576">)</span>&nbsp;<span class="op" id="5764578">*</span><span class="ident" id="5764579">Server</span>&nbsp;<span class="op" id="5764586">{</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5764589">return</span>&nbsp;<span class="op" id="5764596">&amp;</span><span class="ident" id="5764597">Server</span><span class="op" id="5764603">{</span><span class="ident" id="5764604">serviceMap</span><span class="op" id="5764614">:</span>&nbsp;<span class="builtinfunc" id="5764616">make</span><span class="op" id="5764620">(</span><span class="keyword" id="5764621">map</span><span class="op" id="5764624">[</span><span class="builtintype" id="5764625">string</span><span class="op" id="5764631">]</span><span class="op" id="5764632">*</span><span class="ident" id="5764633">service</span><span class="op" id="5764640">)</span><span class="op" id="5764641">}</span><br>
<span class="lineno"></span><span class="op" id="5764643">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5764646">//&nbsp;DefaultServer&nbsp;is&nbsp;the&nbsp;default&nbsp;instance&nbsp;of&nbsp;*Server.</span><br>
<span class="lineno"></span><span class="keyword" id="5764699">var</span>&nbsp;<span class="ident" id="5764703">DefaultServer</span>&nbsp;<span class="op" id="5764717">=</span>&nbsp;<span class="ident" id="5764719">NewServer</span><span class="op" id="5764728">(</span><span class="op" id="5764729">)</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="comment" id="5764732">//&nbsp;Is&nbsp;this&nbsp;an&nbsp;exported&nbsp;-&nbsp;upper&nbsp;case&nbsp;-&nbsp;name?</span><br>
<span class="lineno"></span><span class="keyword" id="5764776">func</span>&nbsp;<span class="ident" id="5764781">isExported</span><span class="op" id="5764791">(</span><span class="ident" id="5764792">name</span>&nbsp;<span class="builtintype" id="5764797">string</span><span class="op" id="5764803">)</span>&nbsp;<span class="builtintype" id="5764805">bool</span>&nbsp;<span class="op" id="5764810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5764813">rune</span><span class="op" id="5764817">,</span>&nbsp;<span class="ident" id="5764819">_</span>&nbsp;<span class="op" id="5764821">:=</span>&nbsp;<span class="ident" id="5764824">utf8</span><span class="op" id="5764828">.</span><span class="ident" id="5764829">DecodeRuneInString</span><span class="op" id="5764847">(</span><span class="ident" id="5764848">name</span><span class="op" id="5764852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5764855">return</span>&nbsp;<span class="ident" id="5764862">unicode</span><span class="op" id="5764869">.</span><span class="ident" id="5764870">IsUpper</span><span class="op" id="5764877">(</span><span class="builtintype" id="5764878">rune</span><span class="op" id="5764882">)</span><br>
<span class="lineno">205</span><span class="op" id="5764884">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5764887">//&nbsp;Is&nbsp;this&nbsp;type&nbsp;exported&nbsp;or&nbsp;a&nbsp;builtin?</span><br>
<span class="lineno"></span><span class="keyword" id="5764926">func</span>&nbsp;<span class="ident" id="5764931">isExportedOrBuiltinType</span><span class="op" id="5764954">(</span><span class="ident" id="5764955">t</span>&nbsp;<span class="ident" id="5764957">reflect</span><span class="op" id="5764964">.</span><span class="ident" id="5764965">Type</span><span class="op" id="5764969">)</span>&nbsp;<span class="builtintype" id="5764971">bool</span>&nbsp;<span class="op" id="5764976">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5764979">for</span>&nbsp;<span class="ident" id="5764983">t</span><span class="op" id="5764984">.</span><span class="ident" id="5764985">Kind</span><span class="op" id="5764989">(</span><span class="op" id="5764990">)</span>&nbsp;<span class="op" id="5764992">==</span>&nbsp;<span class="ident" id="5764995">reflect</span><span class="op" id="5765002">.</span><span class="ident" id="5765003">Ptr</span>&nbsp;<span class="op" id="5765007">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5765011">t</span>&nbsp;<span class="op" id="5765013">=</span>&nbsp;<span class="ident" id="5765015">t</span><span class="op" id="5765016">.</span><span class="ident" id="5765017">Elem</span><span class="op" id="5765021">(</span><span class="op" id="5765022">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5765025">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5765028">//&nbsp;PkgPath&nbsp;will&nbsp;be&nbsp;non-empty&nbsp;even&nbsp;for&nbsp;an&nbsp;exported&nbsp;type,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5765085">//&nbsp;so&nbsp;we&nbsp;need&nbsp;to&nbsp;check&nbsp;the&nbsp;type&nbsp;name&nbsp;as&nbsp;well.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5765132">return</span>&nbsp;<span class="ident" id="5765139">isExported</span><span class="op" id="5765149">(</span><span class="ident" id="5765150">t</span><span class="op" id="5765151">.</span><span class="ident" id="5765152">Name</span><span class="op" id="5765156">(</span><span class="op" id="5765157">)</span><span class="op" id="5765158">)</span>&nbsp;<span class="op" id="5765160">||</span>&nbsp;<span class="ident" id="5765163">t</span><span class="op" id="5765164">.</span><span class="ident" id="5765165">PkgPath</span><span class="op" id="5765172">(</span><span class="op" id="5765173">)</span>&nbsp;<span class="op" id="5765175">==</span>&nbsp;<span class="string" id="5765178">&#34;&#34;</span><br>
<span class="lineno">215</span><span class="op" id="5765181">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5765184">//&nbsp;Register&nbsp;publishes&nbsp;in&nbsp;the&nbsp;server&nbsp;the&nbsp;set&nbsp;of&nbsp;methods&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5765246">//&nbsp;receiver&nbsp;value&nbsp;that&nbsp;satisfy&nbsp;the&nbsp;following&nbsp;conditions:</span><br>
<span class="lineno"></span><span class="comment" id="5765303">//&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;exported&nbsp;method</span><br>
<span class="lineno">220</span><span class="comment" id="5765324">//&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;two&nbsp;arguments,&nbsp;both&nbsp;of&nbsp;exported&nbsp;type</span><br>
<span class="lineno"></span><span class="comment" id="5765366">//&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;the&nbsp;second&nbsp;argument&nbsp;is&nbsp;a&nbsp;pointer</span><br>
<span class="lineno"></span><span class="comment" id="5765404">//&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;one&nbsp;return&nbsp;value,&nbsp;of&nbsp;type&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="5765441">//&nbsp;It&nbsp;returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;receiver&nbsp;is&nbsp;not&nbsp;an&nbsp;exported&nbsp;type&nbsp;or&nbsp;has</span><br>
<span class="lineno"></span><span class="comment" id="5765511">//&nbsp;no&nbsp;suitable&nbsp;methods.&nbsp;It&nbsp;also&nbsp;logs&nbsp;the&nbsp;error&nbsp;using&nbsp;package&nbsp;log.</span><br>
<span class="lineno">225</span><span class="comment" id="5765577">//&nbsp;The&nbsp;client&nbsp;accesses&nbsp;each&nbsp;method&nbsp;using&nbsp;a&nbsp;string&nbsp;of&nbsp;the&nbsp;form&nbsp;&#34;Type.Method&#34;,</span><br>
<span class="lineno"></span><span class="comment" id="5765654">//&nbsp;where&nbsp;Type&nbsp;is&nbsp;the&nbsp;receiver&#39;s&nbsp;concrete&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="5765701">func</span>&nbsp;<span class="op" id="5765706">(</span><span class="ident" id="5765707">server</span>&nbsp;<span class="op" id="5765714">*</span><span class="ident" id="5765715">Server</span><span class="op" id="5765721">)</span>&nbsp;<span class="ident" id="5765723">Register</span><span class="op" id="5765731">(</span><span class="ident" id="5765732">rcvr</span>&nbsp;<span class="keyword" id="5765737">interface</span><span class="op" id="5765746">{</span><span class="op" id="5765747">}</span><span class="op" id="5765748">)</span>&nbsp;<span class="builtintype" id="5765750">error</span>&nbsp;<span class="op" id="5765756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5765759">return</span>&nbsp;<span class="ident" id="5765766">server</span><span class="op" id="5765772">.</span><span class="ident" id="5765773">register</span><span class="op" id="5765781">(</span><span class="ident" id="5765782">rcvr</span><span class="op" id="5765786">,</span>&nbsp;<span class="string" id="5765788">&#34;&#34;</span><span class="op" id="5765790">,</span>&nbsp;<span class="builtintype" id="5765792">false</span><span class="op" id="5765797">)</span><br>
<span class="lineno"></span><span class="op" id="5765799">}</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span><span class="comment" id="5765802">//&nbsp;RegisterName&nbsp;is&nbsp;like&nbsp;Register&nbsp;but&nbsp;uses&nbsp;the&nbsp;provided&nbsp;name&nbsp;for&nbsp;the&nbsp;type</span><br>
<span class="lineno"></span><span class="comment" id="5765875">//&nbsp;instead&nbsp;of&nbsp;the&nbsp;receiver&#39;s&nbsp;concrete&nbsp;type.</span><br>
<span class="lineno"></span><span class="keyword" id="5765919">func</span>&nbsp;<span class="op" id="5765924">(</span><span class="ident" id="5765925">server</span>&nbsp;<span class="op" id="5765932">*</span><span class="ident" id="5765933">Server</span><span class="op" id="5765939">)</span>&nbsp;<span class="ident" id="5765941">RegisterName</span><span class="op" id="5765953">(</span><span class="ident" id="5765954">name</span>&nbsp;<span class="builtintype" id="5765959">string</span><span class="op" id="5765965">,</span>&nbsp;<span class="ident" id="5765967">rcvr</span>&nbsp;<span class="keyword" id="5765972">interface</span><span class="op" id="5765981">{</span><span class="op" id="5765982">}</span><span class="op" id="5765983">)</span>&nbsp;<span class="builtintype" id="5765985">error</span>&nbsp;<span class="op" id="5765991">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5765994">return</span>&nbsp;<span class="ident" id="5766001">server</span><span class="op" id="5766007">.</span><span class="ident" id="5766008">register</span><span class="op" id="5766016">(</span><span class="ident" id="5766017">rcvr</span><span class="op" id="5766021">,</span>&nbsp;<span class="ident" id="5766023">name</span><span class="op" id="5766027">,</span>&nbsp;<span class="builtintype" id="5766029">true</span><span class="op" id="5766033">)</span><br>
<span class="lineno">235</span><span class="op" id="5766035">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5766038">func</span>&nbsp;<span class="op" id="5766043">(</span><span class="ident" id="5766044">server</span>&nbsp;<span class="op" id="5766051">*</span><span class="ident" id="5766052">Server</span><span class="op" id="5766058">)</span>&nbsp;<span class="ident" id="5766060">register</span><span class="op" id="5766068">(</span><span class="ident" id="5766069">rcvr</span>&nbsp;<span class="keyword" id="5766074">interface</span><span class="op" id="5766083">{</span><span class="op" id="5766084">}</span><span class="op" id="5766085">,</span>&nbsp;<span class="ident" id="5766087">name</span>&nbsp;<span class="builtintype" id="5766092">string</span><span class="op" id="5766098">,</span>&nbsp;<span class="ident" id="5766100">useName</span>&nbsp;<span class="builtintype" id="5766108">bool</span><span class="op" id="5766112">)</span>&nbsp;<span class="builtintype" id="5766114">error</span>&nbsp;<span class="op" id="5766120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5766123">server</span><span class="op" id="5766129">.</span><span class="ident" id="5766130">mu</span><span class="op" id="5766132">.</span><span class="ident" id="5766133">Lock</span><span class="op" id="5766137">(</span><span class="op" id="5766138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5766141">defer</span>&nbsp;<span class="ident" id="5766147">server</span><span class="op" id="5766153">.</span><span class="ident" id="5766154">mu</span><span class="op" id="5766156">.</span><span class="ident" id="5766157">Unlock</span><span class="op" id="5766163">(</span><span class="op" id="5766164">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5766167">if</span>&nbsp;<span class="ident" id="5766170">server</span><span class="op" id="5766176">.</span><span class="ident" id="5766177">serviceMap</span>&nbsp;<span class="op" id="5766188">==</span>&nbsp;<span class="builtintype" id="5766191">nil</span>&nbsp;<span class="op" id="5766195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5766199">server</span><span class="op" id="5766205">.</span><span class="ident" id="5766206">serviceMap</span>&nbsp;<span class="op" id="5766217">=</span>&nbsp;<span class="builtinfunc" id="5766219">make</span><span class="op" id="5766223">(</span><span class="keyword" id="5766224">map</span><span class="op" id="5766227">[</span><span class="builtintype" id="5766228">string</span><span class="op" id="5766234">]</span><span class="op" id="5766235">*</span><span class="ident" id="5766236">service</span><span class="op" id="5766243">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5766246">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5766249">s</span>&nbsp;<span class="op" id="5766251">:=</span>&nbsp;<span class="builtinfunc" id="5766254">new</span><span class="op" id="5766257">(</span><span class="ident" id="5766258">service</span><span class="op" id="5766265">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5766268">s</span><span class="op" id="5766269">.</span><span class="ident" id="5766270">typ</span>&nbsp;<span class="op" id="5766274">=</span>&nbsp;<span class="ident" id="5766276">reflect</span><span class="op" id="5766283">.</span><span class="ident" id="5766284">TypeOf</span><span class="op" id="5766290">(</span><span class="ident" id="5766291">rcvr</span><span class="op" id="5766295">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5766298">s</span><span class="op" id="5766299">.</span><span class="ident" id="5766300">rcvr</span>&nbsp;<span class="op" id="5766305">=</span>&nbsp;<span class="ident" id="5766307">reflect</span><span class="op" id="5766314">.</span><span class="ident" id="5766315">ValueOf</span><span class="op" id="5766322">(</span><span class="ident" id="5766323">rcvr</span><span class="op" id="5766327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5766330">sname</span>&nbsp;<span class="op" id="5766336">:=</span>&nbsp;<span class="ident" id="5766339">reflect</span><span class="op" id="5766346">.</span><span class="ident" id="5766347">Indirect</span><span class="op" id="5766355">(</span><span class="ident" id="5766356">s</span><span class="op" id="5766357">.</span><span class="ident" id="5766358">rcvr</span><span class="op" id="5766362">)</span><span class="op" id="5766363">.</span><span class="ident" id="5766364">Type</span><span class="op" id="5766368">(</span><span class="op" id="5766369">)</span><span class="op" id="5766370">.</span><span class="ident" id="5766371">Name</span><span class="op" id="5766375">(</span><span class="op" id="5766376">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5766379">if</span>&nbsp;<span class="ident" id="5766382">useName</span>&nbsp;<span class="op" id="5766390">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5766394">sname</span>&nbsp;<span class="op" id="5766400">=</span>&nbsp;<span class="ident" id="5766402">name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5766408">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5766411">if</span>&nbsp;<span class="ident" id="5766414">sname</span>&nbsp;<span class="op" id="5766420">==</span>&nbsp;<span class="string" id="5766423">&#34;&#34;</span>&nbsp;<span class="op" id="5766426">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5766430">s</span>&nbsp;<span class="op" id="5766432">:=</span>&nbsp;<span class="string" id="5766435">&#34;rpc.Register:&nbsp;no&nbsp;service&nbsp;name&nbsp;for&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="5766477">+</span>&nbsp;<span class="ident" id="5766479">s</span><span class="op" id="5766480">.</span><span class="ident" id="5766481">typ</span><span class="op" id="5766484">.</span><span class="ident" id="5766485">String</span><span class="op" id="5766491">(</span><span class="op" id="5766492">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5766496">log</span><span class="op" id="5766499">.</span><span class="ident" id="5766500">Print</span><span class="op" id="5766505">(</span><span class="ident" id="5766506">s</span><span class="op" id="5766507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5766511">return</span>&nbsp;<span class="ident" id="5766518">errors</span><span class="op" id="5766524">.</span><span class="ident" id="5766525">New</span><span class="op" id="5766528">(</span><span class="ident" id="5766529">s</span><span class="op" id="5766530">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5766533">}</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5766536">if</span>&nbsp;<span class="op" id="5766539">!</span><span class="ident" id="5766540">isExported</span><span class="op" id="5766550">(</span><span class="ident" id="5766551">sname</span><span class="op" id="5766556">)</span>&nbsp;<span class="op" id="5766558">&amp;&amp;</span>&nbsp;<span class="op" id="5766561">!</span><span class="ident" id="5766562">useName</span>&nbsp;<span class="op" id="5766570">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5766574">s</span>&nbsp;<span class="op" id="5766576">:=</span>&nbsp;<span class="string" id="5766579">&#34;rpc.Register:&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="5766601">+</span>&nbsp;<span class="ident" id="5766603">sname</span>&nbsp;<span class="op" id="5766609">+</span>&nbsp;<span class="string" id="5766611">&#34;&nbsp;is&nbsp;not&nbsp;exported&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5766632">log</span><span class="op" id="5766635">.</span><span class="ident" id="5766636">Print</span><span class="op" id="5766641">(</span><span class="ident" id="5766642">s</span><span class="op" id="5766643">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5766647">return</span>&nbsp;<span class="ident" id="5766654">errors</span><span class="op" id="5766660">.</span><span class="ident" id="5766661">New</span><span class="op" id="5766664">(</span><span class="ident" id="5766665">s</span><span class="op" id="5766666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5766669">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5766672">if</span>&nbsp;<span class="ident" id="5766675">_</span><span class="op" id="5766676">,</span>&nbsp;<span class="ident" id="5766678">present</span>&nbsp;<span class="op" id="5766686">:=</span>&nbsp;<span class="ident" id="5766689">server</span><span class="op" id="5766695">.</span><span class="ident" id="5766696">serviceMap</span><span class="op" id="5766706">[</span><span class="ident" id="5766707">sname</span><span class="op" id="5766712">]</span><span class="op" id="5766713">;</span>&nbsp;<span class="ident" id="5766715">present</span>&nbsp;<span class="op" id="5766723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5766727">return</span>&nbsp;<span class="ident" id="5766734">errors</span><span class="op" id="5766740">.</span><span class="ident" id="5766741">New</span><span class="op" id="5766744">(</span><span class="string" id="5766745">&#34;rpc:&nbsp;service&nbsp;already&nbsp;defined:&nbsp;&#34;</span>&nbsp;<span class="op" id="5766778">+</span>&nbsp;<span class="ident" id="5766780">sname</span><span class="op" id="5766785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5766788">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5766791">s</span><span class="op" id="5766792">.</span><span class="ident" id="5766793">name</span>&nbsp;<span class="op" id="5766798">=</span>&nbsp;<span class="ident" id="5766800">sname</span><br>
<span class="lineno"></span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5766808">//&nbsp;Install&nbsp;the&nbsp;methods</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5766832">s</span><span class="op" id="5766833">.</span><span class="ident" id="5766834">method</span>&nbsp;<span class="op" id="5766841">=</span>&nbsp;<span class="ident" id="5766843">suitableMethods</span><span class="op" id="5766858">(</span><span class="ident" id="5766859">s</span><span class="op" id="5766860">.</span><span class="ident" id="5766861">typ</span><span class="op" id="5766864">,</span>&nbsp;<span class="builtintype" id="5766866">true</span><span class="op" id="5766870">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5766874">if</span>&nbsp;<span class="builtinfunc" id="5766877">len</span><span class="op" id="5766880">(</span><span class="ident" id="5766881">s</span><span class="op" id="5766882">.</span><span class="ident" id="5766883">method</span><span class="op" id="5766889">)</span>&nbsp;<span class="op" id="5766891">==</span>&nbsp;<span class="num" id="5766894">0</span>&nbsp;<span class="op" id="5766896">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5766900">str</span>&nbsp;<span class="op" id="5766904">:=</span>&nbsp;<span class="string" id="5766907">&#34;&#34;</span><br>
<span class="lineno">270</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5766913">//&nbsp;To&nbsp;help&nbsp;the&nbsp;user,&nbsp;see&nbsp;if&nbsp;a&nbsp;pointer&nbsp;receiver&nbsp;would&nbsp;work.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5766974">method</span>&nbsp;<span class="op" id="5766981">:=</span>&nbsp;<span class="ident" id="5766984">suitableMethods</span><span class="op" id="5766999">(</span><span class="ident" id="5767000">reflect</span><span class="op" id="5767007">.</span><span class="ident" id="5767008">PtrTo</span><span class="op" id="5767013">(</span><span class="ident" id="5767014">s</span><span class="op" id="5767015">.</span><span class="ident" id="5767016">typ</span><span class="op" id="5767019">)</span><span class="op" id="5767020">,</span>&nbsp;<span class="builtintype" id="5767022">false</span><span class="op" id="5767027">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5767031">if</span>&nbsp;<span class="builtinfunc" id="5767034">len</span><span class="op" id="5767037">(</span><span class="ident" id="5767038">method</span><span class="op" id="5767044">)</span>&nbsp;<span class="op" id="5767046">!=</span>&nbsp;<span class="num" id="5767049">0</span>&nbsp;<span class="op" id="5767051">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5767056">str</span>&nbsp;<span class="op" id="5767060">=</span>&nbsp;<span class="string" id="5767062">&#34;rpc.Register:&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="5767084">+</span>&nbsp;<span class="ident" id="5767086">sname</span>&nbsp;<span class="op" id="5767092">+</span>&nbsp;<span class="string" id="5767094">&#34;&nbsp;has&nbsp;no&nbsp;exported&nbsp;methods&nbsp;of&nbsp;suitable&nbsp;type&nbsp;(hint:&nbsp;pass&nbsp;a&nbsp;pointer&nbsp;to&nbsp;value&nbsp;of&nbsp;that&nbsp;type)&#34;</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5767185">}</span>&nbsp;<span class="keyword" id="5767187">else</span>&nbsp;<span class="op" id="5767192">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5767197">str</span>&nbsp;<span class="op" id="5767201">=</span>&nbsp;<span class="string" id="5767203">&#34;rpc.Register:&nbsp;type&nbsp;&#34;</span>&nbsp;<span class="op" id="5767225">+</span>&nbsp;<span class="ident" id="5767227">sname</span>&nbsp;<span class="op" id="5767233">+</span>&nbsp;<span class="string" id="5767235">&#34;&nbsp;has&nbsp;no&nbsp;exported&nbsp;methods&nbsp;of&nbsp;suitable&nbsp;type&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5767281">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5767285">log</span><span class="op" id="5767288">.</span><span class="ident" id="5767289">Print</span><span class="op" id="5767294">(</span><span class="ident" id="5767295">str</span><span class="op" id="5767298">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5767302">return</span>&nbsp;<span class="ident" id="5767309">errors</span><span class="op" id="5767315">.</span><span class="ident" id="5767316">New</span><span class="op" id="5767319">(</span><span class="ident" id="5767320">str</span><span class="op" id="5767323">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5767326">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5767329">server</span><span class="op" id="5767335">.</span><span class="ident" id="5767336">serviceMap</span><span class="op" id="5767346">[</span><span class="ident" id="5767347">s</span><span class="op" id="5767348">.</span><span class="ident" id="5767349">name</span><span class="op" id="5767353">]</span>&nbsp;<span class="op" id="5767355">=</span>&nbsp;<span class="ident" id="5767357">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5767360">return</span>&nbsp;<span class="builtintype" id="5767367">nil</span><br>
<span class="lineno"></span><span class="op" id="5767371">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span><span class="comment" id="5767374">//&nbsp;suitableMethods&nbsp;returns&nbsp;suitable&nbsp;Rpc&nbsp;methods&nbsp;of&nbsp;typ,&nbsp;it&nbsp;will&nbsp;report</span><br>
<span class="lineno"></span><span class="comment" id="5767445">//&nbsp;error&nbsp;using&nbsp;log&nbsp;if&nbsp;reportErr&nbsp;is&nbsp;true.</span><br>
<span class="lineno"></span><span class="keyword" id="5767486">func</span>&nbsp;<span class="ident" id="5767491">suitableMethods</span><span class="op" id="5767506">(</span><span class="ident" id="5767507">typ</span>&nbsp;<span class="ident" id="5767511">reflect</span><span class="op" id="5767518">.</span><span class="ident" id="5767519">Type</span><span class="op" id="5767523">,</span>&nbsp;<span class="ident" id="5767525">reportErr</span>&nbsp;<span class="builtintype" id="5767535">bool</span><span class="op" id="5767539">)</span>&nbsp;<span class="keyword" id="5767541">map</span><span class="op" id="5767544">[</span><span class="builtintype" id="5767545">string</span><span class="op" id="5767551">]</span><span class="op" id="5767552">*</span><span class="ident" id="5767553">methodType</span>&nbsp;<span class="op" id="5767564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5767567">methods</span>&nbsp;<span class="op" id="5767575">:=</span>&nbsp;<span class="builtinfunc" id="5767578">make</span><span class="op" id="5767582">(</span><span class="keyword" id="5767583">map</span><span class="op" id="5767586">[</span><span class="builtintype" id="5767587">string</span><span class="op" id="5767593">]</span><span class="op" id="5767594">*</span><span class="ident" id="5767595">methodType</span><span class="op" id="5767605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5767608">for</span>&nbsp;<span class="ident" id="5767612">m</span>&nbsp;<span class="op" id="5767614">:=</span>&nbsp;<span class="num" id="5767617">0</span><span class="op" id="5767618">;</span>&nbsp;<span class="ident" id="5767620">m</span>&nbsp;<span class="op" id="5767622">&lt;</span>&nbsp;<span class="ident" id="5767624">typ</span><span class="op" id="5767627">.</span><span class="ident" id="5767628">NumMethod</span><span class="op" id="5767637">(</span><span class="op" id="5767638">)</span><span class="op" id="5767639">;</span>&nbsp;<span class="ident" id="5767641">m</span><span class="op" id="5767642">++</span>&nbsp;<span class="op" id="5767645">{</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5767649">method</span>&nbsp;<span class="op" id="5767656">:=</span>&nbsp;<span class="ident" id="5767659">typ</span><span class="op" id="5767662">.</span><span class="ident" id="5767663">Method</span><span class="op" id="5767669">(</span><span class="ident" id="5767670">m</span><span class="op" id="5767671">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5767675">mtype</span>&nbsp;<span class="op" id="5767681">:=</span>&nbsp;<span class="ident" id="5767684">method</span><span class="op" id="5767690">.</span><span class="ident" id="5767691">Type</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5767698">mname</span>&nbsp;<span class="op" id="5767704">:=</span>&nbsp;<span class="ident" id="5767707">method</span><span class="op" id="5767713">.</span><span class="ident" id="5767714">Name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5767721">//&nbsp;Method&nbsp;must&nbsp;be&nbsp;exported.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5767751">if</span>&nbsp;<span class="ident" id="5767754">method</span><span class="op" id="5767760">.</span><span class="ident" id="5767761">PkgPath</span>&nbsp;<span class="op" id="5767769">!=</span>&nbsp;<span class="string" id="5767772">&#34;&#34;</span>&nbsp;<span class="op" id="5767775">{</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5767780">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5767791">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5767795">//&nbsp;Method&nbsp;needs&nbsp;three&nbsp;ins:&nbsp;receiver,&nbsp;*args,&nbsp;*reply.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5767849">if</span>&nbsp;<span class="ident" id="5767852">mtype</span><span class="op" id="5767857">.</span><span class="ident" id="5767858">NumIn</span><span class="op" id="5767863">(</span><span class="op" id="5767864">)</span>&nbsp;<span class="op" id="5767866">!=</span>&nbsp;<span class="num" id="5767869">3</span>&nbsp;<span class="op" id="5767871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5767876">if</span>&nbsp;<span class="ident" id="5767879">reportErr</span>&nbsp;<span class="op" id="5767889">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5767895">log</span><span class="op" id="5767898">.</span><span class="ident" id="5767899">Println</span><span class="op" id="5767906">(</span><span class="string" id="5767907">&#34;method&#34;</span><span class="op" id="5767915">,</span>&nbsp;<span class="ident" id="5767917">mname</span><span class="op" id="5767922">,</span>&nbsp;<span class="string" id="5767924">&#34;has&nbsp;wrong&nbsp;number&nbsp;of&nbsp;ins:&#34;</span><span class="op" id="5767950">,</span>&nbsp;<span class="ident" id="5767952">mtype</span><span class="op" id="5767957">.</span><span class="ident" id="5767958">NumIn</span><span class="op" id="5767963">(</span><span class="op" id="5767964">)</span><span class="op" id="5767965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5767970">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5767975">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5767986">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5767990">//&nbsp;First&nbsp;arg&nbsp;need&nbsp;not&nbsp;be&nbsp;a&nbsp;pointer.</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5768028">argType</span>&nbsp;<span class="op" id="5768036">:=</span>&nbsp;<span class="ident" id="5768039">mtype</span><span class="op" id="5768044">.</span><span class="ident" id="5768045">In</span><span class="op" id="5768047">(</span><span class="num" id="5768048">1</span><span class="op" id="5768049">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5768053">if</span>&nbsp;<span class="op" id="5768056">!</span><span class="ident" id="5768057">isExportedOrBuiltinType</span><span class="op" id="5768080">(</span><span class="ident" id="5768081">argType</span><span class="op" id="5768088">)</span>&nbsp;<span class="op" id="5768090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5768095">if</span>&nbsp;<span class="ident" id="5768098">reportErr</span>&nbsp;<span class="op" id="5768108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5768114">log</span><span class="op" id="5768117">.</span><span class="ident" id="5768118">Println</span><span class="op" id="5768125">(</span><span class="ident" id="5768126">mname</span><span class="op" id="5768131">,</span>&nbsp;<span class="string" id="5768133">&#34;argument&nbsp;type&nbsp;not&nbsp;exported:&#34;</span><span class="op" id="5768162">,</span>&nbsp;<span class="ident" id="5768164">argType</span><span class="op" id="5768171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5768176">}</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5768181">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5768192">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5768196">//&nbsp;Second&nbsp;arg&nbsp;must&nbsp;be&nbsp;a&nbsp;pointer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5768231">replyType</span>&nbsp;<span class="op" id="5768241">:=</span>&nbsp;<span class="ident" id="5768244">mtype</span><span class="op" id="5768249">.</span><span class="ident" id="5768250">In</span><span class="op" id="5768252">(</span><span class="num" id="5768253">2</span><span class="op" id="5768254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5768258">if</span>&nbsp;<span class="ident" id="5768261">replyType</span><span class="op" id="5768270">.</span><span class="ident" id="5768271">Kind</span><span class="op" id="5768275">(</span><span class="op" id="5768276">)</span>&nbsp;<span class="op" id="5768278">!=</span>&nbsp;<span class="ident" id="5768281">reflect</span><span class="op" id="5768288">.</span><span class="ident" id="5768289">Ptr</span>&nbsp;<span class="op" id="5768293">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5768298">if</span>&nbsp;<span class="ident" id="5768301">reportErr</span>&nbsp;<span class="op" id="5768311">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5768317">log</span><span class="op" id="5768320">.</span><span class="ident" id="5768321">Println</span><span class="op" id="5768328">(</span><span class="string" id="5768329">&#34;method&#34;</span><span class="op" id="5768337">,</span>&nbsp;<span class="ident" id="5768339">mname</span><span class="op" id="5768344">,</span>&nbsp;<span class="string" id="5768346">&#34;reply&nbsp;type&nbsp;not&nbsp;a&nbsp;pointer:&#34;</span><span class="op" id="5768373">,</span>&nbsp;<span class="ident" id="5768375">replyType</span><span class="op" id="5768384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5768389">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5768394">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5768405">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5768409">//&nbsp;Reply&nbsp;type&nbsp;must&nbsp;be&nbsp;exported.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5768443">if</span>&nbsp;<span class="op" id="5768446">!</span><span class="ident" id="5768447">isExportedOrBuiltinType</span><span class="op" id="5768470">(</span><span class="ident" id="5768471">replyType</span><span class="op" id="5768480">)</span>&nbsp;<span class="op" id="5768482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5768487">if</span>&nbsp;<span class="ident" id="5768490">reportErr</span>&nbsp;<span class="op" id="5768500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5768506">log</span><span class="op" id="5768509">.</span><span class="ident" id="5768510">Println</span><span class="op" id="5768517">(</span><span class="string" id="5768518">&#34;method&#34;</span><span class="op" id="5768526">,</span>&nbsp;<span class="ident" id="5768528">mname</span><span class="op" id="5768533">,</span>&nbsp;<span class="string" id="5768535">&#34;reply&nbsp;type&nbsp;not&nbsp;exported:&#34;</span><span class="op" id="5768561">,</span>&nbsp;<span class="ident" id="5768563">replyType</span><span class="op" id="5768572">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5768577">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5768582">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5768593">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5768597">//&nbsp;Method&nbsp;needs&nbsp;one&nbsp;out.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5768624">if</span>&nbsp;<span class="ident" id="5768627">mtype</span><span class="op" id="5768632">.</span><span class="ident" id="5768633">NumOut</span><span class="op" id="5768639">(</span><span class="op" id="5768640">)</span>&nbsp;<span class="op" id="5768642">!=</span>&nbsp;<span class="num" id="5768645">1</span>&nbsp;<span class="op" id="5768647">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5768652">if</span>&nbsp;<span class="ident" id="5768655">reportErr</span>&nbsp;<span class="op" id="5768665">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5768671">log</span><span class="op" id="5768674">.</span><span class="ident" id="5768675">Println</span><span class="op" id="5768682">(</span><span class="string" id="5768683">&#34;method&#34;</span><span class="op" id="5768691">,</span>&nbsp;<span class="ident" id="5768693">mname</span><span class="op" id="5768698">,</span>&nbsp;<span class="string" id="5768700">&#34;has&nbsp;wrong&nbsp;number&nbsp;of&nbsp;outs:&#34;</span><span class="op" id="5768727">,</span>&nbsp;<span class="ident" id="5768729">mtype</span><span class="op" id="5768734">.</span><span class="ident" id="5768735">NumOut</span><span class="op" id="5768741">(</span><span class="op" id="5768742">)</span><span class="op" id="5768743">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5768748">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5768753">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5768764">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5768768">//&nbsp;The&nbsp;return&nbsp;type&nbsp;of&nbsp;the&nbsp;method&nbsp;must&nbsp;be&nbsp;error.</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5768818">if</span>&nbsp;<span class="ident" id="5768821">returnType</span>&nbsp;<span class="op" id="5768832">:=</span>&nbsp;<span class="ident" id="5768835">mtype</span><span class="op" id="5768840">.</span><span class="ident" id="5768841">Out</span><span class="op" id="5768844">(</span><span class="num" id="5768845">0</span><span class="op" id="5768846">)</span><span class="op" id="5768847">;</span>&nbsp;<span class="ident" id="5768849">returnType</span>&nbsp;<span class="op" id="5768860">!=</span>&nbsp;<span class="ident" id="5768863">typeOfError</span>&nbsp;<span class="op" id="5768875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5768880">if</span>&nbsp;<span class="ident" id="5768883">reportErr</span>&nbsp;<span class="op" id="5768893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5768899">log</span><span class="op" id="5768902">.</span><span class="ident" id="5768903">Println</span><span class="op" id="5768910">(</span><span class="string" id="5768911">&#34;method&#34;</span><span class="op" id="5768919">,</span>&nbsp;<span class="ident" id="5768921">mname</span><span class="op" id="5768926">,</span>&nbsp;<span class="string" id="5768928">&#34;returns&#34;</span><span class="op" id="5768937">,</span>&nbsp;<span class="ident" id="5768939">returnType</span><span class="op" id="5768949">.</span><span class="ident" id="5768950">String</span><span class="op" id="5768956">(</span><span class="op" id="5768957">)</span><span class="op" id="5768958">,</span>&nbsp;<span class="string" id="5768960">&#34;not&nbsp;error&#34;</span><span class="op" id="5768971">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5768976">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5768981">continue</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5768992">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5768996">methods</span><span class="op" id="5769003">[</span><span class="ident" id="5769004">mname</span><span class="op" id="5769009">]</span>&nbsp;<span class="op" id="5769011">=</span>&nbsp;<span class="op" id="5769013">&amp;</span><span class="ident" id="5769014">methodType</span><span class="op" id="5769024">{</span><span class="ident" id="5769025">method</span><span class="op" id="5769031">:</span>&nbsp;<span class="ident" id="5769033">method</span><span class="op" id="5769039">,</span>&nbsp;<span class="ident" id="5769041">ArgType</span><span class="op" id="5769048">:</span>&nbsp;<span class="ident" id="5769050">argType</span><span class="op" id="5769057">,</span>&nbsp;<span class="ident" id="5769059">ReplyType</span><span class="op" id="5769068">:</span>&nbsp;<span class="ident" id="5769070">replyType</span><span class="op" id="5769079">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5769082">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5769085">return</span>&nbsp;<span class="ident" id="5769092">methods</span><br>
<span class="lineno"></span><span class="op" id="5769100">}</span><br>
<span class="lineno">345</span><br>
<span class="lineno"></span><span class="comment" id="5769103">//&nbsp;A&nbsp;value&nbsp;sent&nbsp;as&nbsp;a&nbsp;placeholder&nbsp;for&nbsp;the&nbsp;server&#39;s&nbsp;response&nbsp;value&nbsp;when&nbsp;the&nbsp;server</span><br>
<span class="lineno"></span><span class="comment" id="5769184">//&nbsp;receives&nbsp;an&nbsp;invalid&nbsp;request.&nbsp;It&nbsp;is&nbsp;never&nbsp;decoded&nbsp;by&nbsp;the&nbsp;client&nbsp;since&nbsp;the&nbsp;Response</span><br>
<span class="lineno"></span><span class="comment" id="5769269">//&nbsp;contains&nbsp;an&nbsp;error&nbsp;when&nbsp;it&nbsp;is&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="5769307">var</span>&nbsp;<span class="ident" id="5769311">invalidRequest</span>&nbsp;<span class="op" id="5769326">=</span>&nbsp;<span class="keyword" id="5769328">struct</span><span class="op" id="5769334">{</span><span class="op" id="5769335">}</span><span class="op" id="5769336">{</span><span class="op" id="5769337">}</span><br>
<span class="lineno">350</span><br>
<span class="lineno"></span><span class="keyword" id="5769340">func</span>&nbsp;<span class="op" id="5769345">(</span><span class="ident" id="5769346">server</span>&nbsp;<span class="op" id="5769353">*</span><span class="ident" id="5769354">Server</span><span class="op" id="5769360">)</span>&nbsp;<span class="ident" id="5769362">sendResponse</span><span class="op" id="5769374">(</span><span class="ident" id="5769375">sending</span>&nbsp;<span class="op" id="5769383">*</span><span class="ident" id="5769384">sync</span><span class="op" id="5769388">.</span><span class="ident" id="5769389">Mutex</span><span class="op" id="5769394">,</span>&nbsp;<span class="ident" id="5769396">req</span>&nbsp;<span class="op" id="5769400">*</span><span class="ident" id="5769401">Request</span><span class="op" id="5769408">,</span>&nbsp;<span class="ident" id="5769410">reply</span>&nbsp;<span class="keyword" id="5769416">interface</span><span class="op" id="5769425">{</span><span class="op" id="5769426">}</span><span class="op" id="5769427">,</span>&nbsp;<span class="ident" id="5769429">codec</span>&nbsp;<span class="ident" id="5769435">ServerCodec</span><span class="op" id="5769446">,</span>&nbsp;<span class="ident" id="5769448">errmsg</span>&nbsp;<span class="builtintype" id="5769455">string</span><span class="op" id="5769461">)</span>&nbsp;<span class="op" id="5769463">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5769466">resp</span>&nbsp;<span class="op" id="5769471">:=</span>&nbsp;<span class="ident" id="5769474">server</span><span class="op" id="5769480">.</span><span class="ident" id="5769481">getResponse</span><span class="op" id="5769492">(</span><span class="op" id="5769493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5769496">//&nbsp;Encode&nbsp;the&nbsp;response&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5769527">resp</span><span class="op" id="5769531">.</span><span class="ident" id="5769532">ServiceMethod</span>&nbsp;<span class="op" id="5769546">=</span>&nbsp;<span class="ident" id="5769548">req</span><span class="op" id="5769551">.</span><span class="ident" id="5769552">ServiceMethod</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5769567">if</span>&nbsp;<span class="ident" id="5769570">errmsg</span>&nbsp;<span class="op" id="5769577">!=</span>&nbsp;<span class="string" id="5769580">&#34;&#34;</span>&nbsp;<span class="op" id="5769583">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5769587">resp</span><span class="op" id="5769591">.</span><span class="ident" id="5769592">Error</span>&nbsp;<span class="op" id="5769598">=</span>&nbsp;<span class="ident" id="5769600">errmsg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5769609">reply</span>&nbsp;<span class="op" id="5769615">=</span>&nbsp;<span class="ident" id="5769617">invalidRequest</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5769633">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5769636">resp</span><span class="op" id="5769640">.</span><span class="ident" id="5769641">Seq</span>&nbsp;<span class="op" id="5769645">=</span>&nbsp;<span class="ident" id="5769647">req</span><span class="op" id="5769650">.</span><span class="ident" id="5769651">Seq</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5769656">sending</span><span class="op" id="5769663">.</span><span class="ident" id="5769664">Lock</span><span class="op" id="5769668">(</span><span class="op" id="5769669">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5769672">err</span>&nbsp;<span class="op" id="5769676">:=</span>&nbsp;<span class="ident" id="5769679">codec</span><span class="op" id="5769684">.</span><span class="ident" id="5769685">WriteResponse</span><span class="op" id="5769698">(</span><span class="ident" id="5769699">resp</span><span class="op" id="5769703">,</span>&nbsp;<span class="ident" id="5769705">reply</span><span class="op" id="5769710">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5769713">if</span>&nbsp;<span class="ident" id="5769716">debugLog</span>&nbsp;<span class="op" id="5769725">&amp;&amp;</span>&nbsp;<span class="ident" id="5769728">err</span>&nbsp;<span class="op" id="5769732">!=</span>&nbsp;<span class="builtintype" id="5769735">nil</span>&nbsp;<span class="op" id="5769739">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5769743">log</span><span class="op" id="5769746">.</span><span class="ident" id="5769747">Println</span><span class="op" id="5769754">(</span><span class="string" id="5769755">&#34;rpc:&nbsp;writing&nbsp;response:&#34;</span><span class="op" id="5769779">,</span>&nbsp;<span class="ident" id="5769781">err</span><span class="op" id="5769784">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5769787">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5769790">sending</span><span class="op" id="5769797">.</span><span class="ident" id="5769798">Unlock</span><span class="op" id="5769804">(</span><span class="op" id="5769805">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5769808">server</span><span class="op" id="5769814">.</span><span class="ident" id="5769815">freeResponse</span><span class="op" id="5769827">(</span><span class="ident" id="5769828">resp</span><span class="op" id="5769832">)</span><br>
<span class="lineno"></span><span class="op" id="5769834">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5769837">func</span>&nbsp;<span class="op" id="5769842">(</span><span class="ident" id="5769843">m</span>&nbsp;<span class="op" id="5769845">*</span><span class="ident" id="5769846">methodType</span><span class="op" id="5769856">)</span>&nbsp;<span class="ident" id="5769858">NumCalls</span><span class="op" id="5769866">(</span><span class="op" id="5769867">)</span>&nbsp;<span class="op" id="5769869">(</span><span class="ident" id="5769870">n</span>&nbsp;<span class="builtintype" id="5769872">uint</span><span class="op" id="5769876">)</span>&nbsp;<span class="op" id="5769878">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5769881">m</span><span class="op" id="5769882">.</span><span class="ident" id="5769883">Lock</span><span class="op" id="5769887">(</span><span class="op" id="5769888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5769891">n</span>&nbsp;<span class="op" id="5769893">=</span>&nbsp;<span class="ident" id="5769895">m</span><span class="op" id="5769896">.</span><span class="ident" id="5769897">numCalls</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5769907">m</span><span class="op" id="5769908">.</span><span class="ident" id="5769909">Unlock</span><span class="op" id="5769915">(</span><span class="op" id="5769916">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5769919">return</span>&nbsp;<span class="ident" id="5769926">n</span><br>
<span class="lineno"></span><span class="op" id="5769928">}</span><br>
<span class="lineno">375</span><br>
<span class="lineno"></span><span class="keyword" id="5769931">func</span>&nbsp;<span class="op" id="5769936">(</span><span class="ident" id="5769937">s</span>&nbsp;<span class="op" id="5769939">*</span><span class="ident" id="5769940">service</span><span class="op" id="5769947">)</span>&nbsp;<span class="ident" id="5769949">call</span><span class="op" id="5769953">(</span><span class="ident" id="5769954">server</span>&nbsp;<span class="op" id="5769961">*</span><span class="ident" id="5769962">Server</span><span class="op" id="5769968">,</span>&nbsp;<span class="ident" id="5769970">sending</span>&nbsp;<span class="op" id="5769978">*</span><span class="ident" id="5769979">sync</span><span class="op" id="5769983">.</span><span class="ident" id="5769984">Mutex</span><span class="op" id="5769989">,</span>&nbsp;<span class="ident" id="5769991">mtype</span>&nbsp;<span class="op" id="5769997">*</span><span class="ident" id="5769998">methodType</span><span class="op" id="5770008">,</span>&nbsp;<span class="ident" id="5770010">req</span>&nbsp;<span class="op" id="5770014">*</span><span class="ident" id="5770015">Request</span><span class="op" id="5770022">,</span>&nbsp;<span class="ident" id="5770024">argv</span><span class="op" id="5770028">,</span>&nbsp;<span class="ident" id="5770030">replyv</span>&nbsp;<span class="ident" id="5770037">reflect</span><span class="op" id="5770044">.</span><span class="ident" id="5770045">Value</span><span class="op" id="5770050">,</span>&nbsp;<span class="ident" id="5770052">codec</span>&nbsp;<span class="ident" id="5770058">ServerCodec</span><span class="op" id="5770069">)</span>&nbsp;<span class="op" id="5770071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5770074">mtype</span><span class="op" id="5770079">.</span><span class="ident" id="5770080">Lock</span><span class="op" id="5770084">(</span><span class="op" id="5770085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5770088">mtype</span><span class="op" id="5770093">.</span><span class="ident" id="5770094">numCalls</span><span class="op" id="5770102">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5770106">mtype</span><span class="op" id="5770111">.</span><span class="ident" id="5770112">Unlock</span><span class="op" id="5770118">(</span><span class="op" id="5770119">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5770122">function</span>&nbsp;<span class="op" id="5770131">:=</span>&nbsp;<span class="ident" id="5770134">mtype</span><span class="op" id="5770139">.</span><span class="ident" id="5770140">method</span><span class="op" id="5770146">.</span><span class="ident" id="5770147">Func</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5770153">//&nbsp;Invoke&nbsp;the&nbsp;method,&nbsp;providing&nbsp;a&nbsp;new&nbsp;value&nbsp;for&nbsp;the&nbsp;reply.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5770213">returnValues</span>&nbsp;<span class="op" id="5770226">:=</span>&nbsp;<span class="ident" id="5770229">function</span><span class="op" id="5770237">.</span><span class="ident" id="5770238">Call</span><span class="op" id="5770242">(</span><span class="op" id="5770243">[</span><span class="op" id="5770244">]</span><span class="ident" id="5770245">reflect</span><span class="op" id="5770252">.</span><span class="ident" id="5770253">Value</span><span class="op" id="5770258">{</span><span class="ident" id="5770259">s</span><span class="op" id="5770260">.</span><span class="ident" id="5770261">rcvr</span><span class="op" id="5770265">,</span>&nbsp;<span class="ident" id="5770267">argv</span><span class="op" id="5770271">,</span>&nbsp;<span class="ident" id="5770273">replyv</span><span class="op" id="5770279">}</span><span class="op" id="5770280">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5770283">//&nbsp;The&nbsp;return&nbsp;value&nbsp;for&nbsp;the&nbsp;method&nbsp;is&nbsp;an&nbsp;error.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5770332">errInter</span>&nbsp;<span class="op" id="5770341">:=</span>&nbsp;<span class="ident" id="5770344">returnValues</span><span class="op" id="5770356">[</span><span class="num" id="5770357">0</span><span class="op" id="5770358">]</span><span class="op" id="5770359">.</span><span class="ident" id="5770360">Interface</span><span class="op" id="5770369">(</span><span class="op" id="5770370">)</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5770373">errmsg</span>&nbsp;<span class="op" id="5770380">:=</span>&nbsp;<span class="string" id="5770383">&#34;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5770387">if</span>&nbsp;<span class="ident" id="5770390">errInter</span>&nbsp;<span class="op" id="5770399">!=</span>&nbsp;<span class="builtintype" id="5770402">nil</span>&nbsp;<span class="op" id="5770406">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5770410">errmsg</span>&nbsp;<span class="op" id="5770417">=</span>&nbsp;<span class="ident" id="5770419">errInter</span><span class="op" id="5770427">.</span><span class="op" id="5770428">(</span><span class="builtintype" id="5770429">error</span><span class="op" id="5770434">)</span><span class="op" id="5770435">.</span><span class="ident" id="5770436">Error</span><span class="op" id="5770441">(</span><span class="op" id="5770442">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5770445">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5770448">server</span><span class="op" id="5770454">.</span><span class="ident" id="5770455">sendResponse</span><span class="op" id="5770467">(</span><span class="ident" id="5770468">sending</span><span class="op" id="5770475">,</span>&nbsp;<span class="ident" id="5770477">req</span><span class="op" id="5770480">,</span>&nbsp;<span class="ident" id="5770482">replyv</span><span class="op" id="5770488">.</span><span class="ident" id="5770489">Interface</span><span class="op" id="5770498">(</span><span class="op" id="5770499">)</span><span class="op" id="5770500">,</span>&nbsp;<span class="ident" id="5770502">codec</span><span class="op" id="5770507">,</span>&nbsp;<span class="ident" id="5770509">errmsg</span><span class="op" id="5770515">)</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5770518">server</span><span class="op" id="5770524">.</span><span class="ident" id="5770525">freeRequest</span><span class="op" id="5770536">(</span><span class="ident" id="5770537">req</span><span class="op" id="5770540">)</span><br>
<span class="lineno"></span><span class="op" id="5770542">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5770545">type</span>&nbsp;<span class="ident" id="5770550">gobServerCodec</span>&nbsp;<span class="keyword" id="5770565">struct</span>&nbsp;<span class="op" id="5770572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5770575">rwc</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5770582">io</span><span class="op" id="5770584">.</span><span class="ident" id="5770585">ReadWriteCloser</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5770602">dec</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5770609">*</span><span class="ident" id="5770610">gob</span><span class="op" id="5770613">.</span><span class="ident" id="5770614">Decoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5770623">enc</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5770630">*</span><span class="ident" id="5770631">gob</span><span class="op" id="5770634">.</span><span class="ident" id="5770635">Encoder</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5770644">encBuf</span>&nbsp;<span class="op" id="5770651">*</span><span class="ident" id="5770652">bufio</span><span class="op" id="5770657">.</span><span class="ident" id="5770658">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5770666">closed</span>&nbsp;<span class="builtintype" id="5770673">bool</span><br>
<span class="lineno"></span><span class="op" id="5770678">}</span><br>
<span class="lineno">400</span><br>
<span class="lineno"></span><span class="keyword" id="5770681">func</span>&nbsp;<span class="op" id="5770686">(</span><span class="ident" id="5770687">c</span>&nbsp;<span class="op" id="5770689">*</span><span class="ident" id="5770690">gobServerCodec</span><span class="op" id="5770704">)</span>&nbsp;<span class="ident" id="5770706">ReadRequestHeader</span><span class="op" id="5770723">(</span><span class="ident" id="5770724">r</span>&nbsp;<span class="op" id="5770726">*</span><span class="ident" id="5770727">Request</span><span class="op" id="5770734">)</span>&nbsp;<span class="builtintype" id="5770736">error</span>&nbsp;<span class="op" id="5770742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5770745">return</span>&nbsp;<span class="ident" id="5770752">c</span><span class="op" id="5770753">.</span><span class="ident" id="5770754">dec</span><span class="op" id="5770757">.</span><span class="ident" id="5770758">Decode</span><span class="op" id="5770764">(</span><span class="ident" id="5770765">r</span><span class="op" id="5770766">)</span><br>
<span class="lineno"></span><span class="op" id="5770768">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">405</span><span class="keyword" id="5770771">func</span>&nbsp;<span class="op" id="5770776">(</span><span class="ident" id="5770777">c</span>&nbsp;<span class="op" id="5770779">*</span><span class="ident" id="5770780">gobServerCodec</span><span class="op" id="5770794">)</span>&nbsp;<span class="ident" id="5770796">ReadRequestBody</span><span class="op" id="5770811">(</span><span class="ident" id="5770812">body</span>&nbsp;<span class="keyword" id="5770817">interface</span><span class="op" id="5770826">{</span><span class="op" id="5770827">}</span><span class="op" id="5770828">)</span>&nbsp;<span class="builtintype" id="5770830">error</span>&nbsp;<span class="op" id="5770836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5770839">return</span>&nbsp;<span class="ident" id="5770846">c</span><span class="op" id="5770847">.</span><span class="ident" id="5770848">dec</span><span class="op" id="5770851">.</span><span class="ident" id="5770852">Decode</span><span class="op" id="5770858">(</span><span class="ident" id="5770859">body</span><span class="op" id="5770863">)</span><br>
<span class="lineno"></span><span class="op" id="5770865">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5770868">func</span>&nbsp;<span class="op" id="5770873">(</span><span class="ident" id="5770874">c</span>&nbsp;<span class="op" id="5770876">*</span><span class="ident" id="5770877">gobServerCodec</span><span class="op" id="5770891">)</span>&nbsp;<span class="ident" id="5770893">WriteResponse</span><span class="op" id="5770906">(</span><span class="ident" id="5770907">r</span>&nbsp;<span class="op" id="5770909">*</span><span class="ident" id="5770910">Response</span><span class="op" id="5770918">,</span>&nbsp;<span class="ident" id="5770920">body</span>&nbsp;<span class="keyword" id="5770925">interface</span><span class="op" id="5770934">{</span><span class="op" id="5770935">}</span><span class="op" id="5770936">)</span>&nbsp;<span class="op" id="5770938">(</span><span class="ident" id="5770939">err</span>&nbsp;<span class="builtintype" id="5770943">error</span><span class="op" id="5770948">)</span>&nbsp;<span class="op" id="5770950">{</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5770953">if</span>&nbsp;<span class="ident" id="5770956">err</span>&nbsp;<span class="op" id="5770960">=</span>&nbsp;<span class="ident" id="5770962">c</span><span class="op" id="5770963">.</span><span class="ident" id="5770964">enc</span><span class="op" id="5770967">.</span><span class="ident" id="5770968">Encode</span><span class="op" id="5770974">(</span><span class="ident" id="5770975">r</span><span class="op" id="5770976">)</span><span class="op" id="5770977">;</span>&nbsp;<span class="ident" id="5770979">err</span>&nbsp;<span class="op" id="5770983">!=</span>&nbsp;<span class="builtintype" id="5770986">nil</span>&nbsp;<span class="op" id="5770990">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5770994">if</span>&nbsp;<span class="ident" id="5770997">c</span><span class="op" id="5770998">.</span><span class="ident" id="5770999">encBuf</span><span class="op" id="5771005">.</span><span class="ident" id="5771006">Flush</span><span class="op" id="5771011">(</span><span class="op" id="5771012">)</span>&nbsp;<span class="op" id="5771014">==</span>&nbsp;<span class="builtintype" id="5771017">nil</span>&nbsp;<span class="op" id="5771021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5771026">//&nbsp;Gob&nbsp;couldn&#39;t&nbsp;encode&nbsp;the&nbsp;header.&nbsp;Should&nbsp;not&nbsp;happen,&nbsp;so&nbsp;if&nbsp;it&nbsp;does,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5771098">//&nbsp;shut&nbsp;down&nbsp;the&nbsp;connection&nbsp;to&nbsp;signal&nbsp;that&nbsp;the&nbsp;connection&nbsp;is&nbsp;broken.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5771170">log</span><span class="op" id="5771173">.</span><span class="ident" id="5771174">Println</span><span class="op" id="5771181">(</span><span class="string" id="5771182">&#34;rpc:&nbsp;gob&nbsp;error&nbsp;encoding&nbsp;response:&#34;</span><span class="op" id="5771217">,</span>&nbsp;<span class="ident" id="5771219">err</span><span class="op" id="5771222">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5771227">c</span><span class="op" id="5771228">.</span><span class="ident" id="5771229">Close</span><span class="op" id="5771234">(</span><span class="op" id="5771235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5771239">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5771243">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5771251">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5771254">if</span>&nbsp;<span class="ident" id="5771257">err</span>&nbsp;<span class="op" id="5771261">=</span>&nbsp;<span class="ident" id="5771263">c</span><span class="op" id="5771264">.</span><span class="ident" id="5771265">enc</span><span class="op" id="5771268">.</span><span class="ident" id="5771269">Encode</span><span class="op" id="5771275">(</span><span class="ident" id="5771276">body</span><span class="op" id="5771280">)</span><span class="op" id="5771281">;</span>&nbsp;<span class="ident" id="5771283">err</span>&nbsp;<span class="op" id="5771287">!=</span>&nbsp;<span class="builtintype" id="5771290">nil</span>&nbsp;<span class="op" id="5771294">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5771298">if</span>&nbsp;<span class="ident" id="5771301">c</span><span class="op" id="5771302">.</span><span class="ident" id="5771303">encBuf</span><span class="op" id="5771309">.</span><span class="ident" id="5771310">Flush</span><span class="op" id="5771315">(</span><span class="op" id="5771316">)</span>&nbsp;<span class="op" id="5771318">==</span>&nbsp;<span class="builtintype" id="5771321">nil</span>&nbsp;<span class="op" id="5771325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5771330">//&nbsp;Was&nbsp;a&nbsp;gob&nbsp;problem&nbsp;encoding&nbsp;the&nbsp;body&nbsp;but&nbsp;the&nbsp;header&nbsp;has&nbsp;been&nbsp;written.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5771405">//&nbsp;Shut&nbsp;down&nbsp;the&nbsp;connection&nbsp;to&nbsp;signal&nbsp;that&nbsp;the&nbsp;connection&nbsp;is&nbsp;broken.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5771477">log</span><span class="op" id="5771480">.</span><span class="ident" id="5771481">Println</span><span class="op" id="5771488">(</span><span class="string" id="5771489">&#34;rpc:&nbsp;gob&nbsp;error&nbsp;encoding&nbsp;body:&#34;</span><span class="op" id="5771520">,</span>&nbsp;<span class="ident" id="5771522">err</span><span class="op" id="5771525">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5771530">c</span><span class="op" id="5771531">.</span><span class="ident" id="5771532">Close</span><span class="op" id="5771537">(</span><span class="op" id="5771538">)</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5771542">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5771546">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5771554">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5771557">return</span>&nbsp;<span class="ident" id="5771564">c</span><span class="op" id="5771565">.</span><span class="ident" id="5771566">encBuf</span><span class="op" id="5771572">.</span><span class="ident" id="5771573">Flush</span><span class="op" id="5771578">(</span><span class="op" id="5771579">)</span><br>
<span class="lineno"></span><span class="op" id="5771581">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span><span class="keyword" id="5771584">func</span>&nbsp;<span class="op" id="5771589">(</span><span class="ident" id="5771590">c</span>&nbsp;<span class="op" id="5771592">*</span><span class="ident" id="5771593">gobServerCodec</span><span class="op" id="5771607">)</span>&nbsp;<span class="ident" id="5771609">Close</span><span class="op" id="5771614">(</span><span class="op" id="5771615">)</span>&nbsp;<span class="builtintype" id="5771617">error</span>&nbsp;<span class="op" id="5771623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5771626">if</span>&nbsp;<span class="ident" id="5771629">c</span><span class="op" id="5771630">.</span><span class="ident" id="5771631">closed</span>&nbsp;<span class="op" id="5771638">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5771642">//&nbsp;Only&nbsp;call&nbsp;c.rwc.Close&nbsp;once;&nbsp;otherwise&nbsp;the&nbsp;semantics&nbsp;are&nbsp;undefined.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5771714">return</span>&nbsp;<span class="builtintype" id="5771721">nil</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5771726">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5771729">c</span><span class="op" id="5771730">.</span><span class="ident" id="5771731">closed</span>&nbsp;<span class="op" id="5771738">=</span>&nbsp;<span class="builtintype" id="5771740">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5771746">return</span>&nbsp;<span class="ident" id="5771753">c</span><span class="op" id="5771754">.</span><span class="ident" id="5771755">rwc</span><span class="op" id="5771758">.</span><span class="ident" id="5771759">Close</span><span class="op" id="5771764">(</span><span class="op" id="5771765">)</span><br>
<span class="lineno"></span><span class="op" id="5771767">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">440</span><span class="comment" id="5771770">//&nbsp;ServeConn&nbsp;runs&nbsp;the&nbsp;server&nbsp;on&nbsp;a&nbsp;single&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="5771823">//&nbsp;ServeConn&nbsp;blocks,&nbsp;serving&nbsp;the&nbsp;connection&nbsp;until&nbsp;the&nbsp;client&nbsp;hangs&nbsp;up.</span><br>
<span class="lineno"></span><span class="comment" id="5771894">//&nbsp;The&nbsp;caller&nbsp;typically&nbsp;invokes&nbsp;ServeConn&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="comment" id="5771955">//&nbsp;ServeConn&nbsp;uses&nbsp;the&nbsp;gob&nbsp;wire&nbsp;format&nbsp;(see&nbsp;package&nbsp;gob)&nbsp;on&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5772018">//&nbsp;connection.&nbsp;&nbsp;To&nbsp;use&nbsp;an&nbsp;alternate&nbsp;codec,&nbsp;use&nbsp;ServeCodec.</span><br>
<span class="lineno">445</span><span class="keyword" id="5772077">func</span>&nbsp;<span class="op" id="5772082">(</span><span class="ident" id="5772083">server</span>&nbsp;<span class="op" id="5772090">*</span><span class="ident" id="5772091">Server</span><span class="op" id="5772097">)</span>&nbsp;<span class="ident" id="5772099">ServeConn</span><span class="op" id="5772108">(</span><span class="ident" id="5772109">conn</span>&nbsp;<span class="ident" id="5772114">io</span><span class="op" id="5772116">.</span><span class="ident" id="5772117">ReadWriteCloser</span><span class="op" id="5772132">)</span>&nbsp;<span class="op" id="5772134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5772137">buf</span>&nbsp;<span class="op" id="5772141">:=</span>&nbsp;<span class="ident" id="5772144">bufio</span><span class="op" id="5772149">.</span><span class="ident" id="5772150">NewWriter</span><span class="op" id="5772159">(</span><span class="ident" id="5772160">conn</span><span class="op" id="5772164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5772167">srv</span>&nbsp;<span class="op" id="5772171">:=</span>&nbsp;<span class="op" id="5772174">&amp;</span><span class="ident" id="5772175">gobServerCodec</span><span class="op" id="5772189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5772193">rwc</span><span class="op" id="5772196">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5772201">conn</span><span class="op" id="5772205">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5772209">dec</span><span class="op" id="5772212">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5772217">gob</span><span class="op" id="5772220">.</span><span class="ident" id="5772221">NewDecoder</span><span class="op" id="5772231">(</span><span class="ident" id="5772232">conn</span><span class="op" id="5772236">)</span><span class="op" id="5772237">,</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5772241">enc</span><span class="op" id="5772244">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5772249">gob</span><span class="op" id="5772252">.</span><span class="ident" id="5772253">NewEncoder</span><span class="op" id="5772263">(</span><span class="ident" id="5772264">buf</span><span class="op" id="5772267">)</span><span class="op" id="5772268">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5772272">encBuf</span><span class="op" id="5772278">:</span>&nbsp;<span class="ident" id="5772280">buf</span><span class="op" id="5772283">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5772286">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5772289">server</span><span class="op" id="5772295">.</span><span class="ident" id="5772296">ServeCodec</span><span class="op" id="5772306">(</span><span class="ident" id="5772307">srv</span><span class="op" id="5772310">)</span><br>
<span class="lineno"></span><span class="op" id="5772312">}</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span><span class="comment" id="5772315">//&nbsp;ServeCodec&nbsp;is&nbsp;like&nbsp;ServeConn&nbsp;but&nbsp;uses&nbsp;the&nbsp;specified&nbsp;codec&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="5772379">//&nbsp;decode&nbsp;requests&nbsp;and&nbsp;encode&nbsp;responses.</span><br>
<span class="lineno"></span><span class="keyword" id="5772420">func</span>&nbsp;<span class="op" id="5772425">(</span><span class="ident" id="5772426">server</span>&nbsp;<span class="op" id="5772433">*</span><span class="ident" id="5772434">Server</span><span class="op" id="5772440">)</span>&nbsp;<span class="ident" id="5772442">ServeCodec</span><span class="op" id="5772452">(</span><span class="ident" id="5772453">codec</span>&nbsp;<span class="ident" id="5772459">ServerCodec</span><span class="op" id="5772470">)</span>&nbsp;<span class="op" id="5772472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5772475">sending</span>&nbsp;<span class="op" id="5772483">:=</span>&nbsp;<span class="builtinfunc" id="5772486">new</span><span class="op" id="5772489">(</span><span class="ident" id="5772490">sync</span><span class="op" id="5772494">.</span><span class="ident" id="5772495">Mutex</span><span class="op" id="5772500">)</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5772503">for</span>&nbsp;<span class="op" id="5772507">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5772511">service</span><span class="op" id="5772518">,</span>&nbsp;<span class="ident" id="5772520">mtype</span><span class="op" id="5772525">,</span>&nbsp;<span class="ident" id="5772527">req</span><span class="op" id="5772530">,</span>&nbsp;<span class="ident" id="5772532">argv</span><span class="op" id="5772536">,</span>&nbsp;<span class="ident" id="5772538">replyv</span><span class="op" id="5772544">,</span>&nbsp;<span class="ident" id="5772546">keepReading</span><span class="op" id="5772557">,</span>&nbsp;<span class="ident" id="5772559">err</span>&nbsp;<span class="op" id="5772563">:=</span>&nbsp;<span class="ident" id="5772566">server</span><span class="op" id="5772572">.</span><span class="ident" id="5772573">readRequest</span><span class="op" id="5772584">(</span><span class="ident" id="5772585">codec</span><span class="op" id="5772590">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5772594">if</span>&nbsp;<span class="ident" id="5772597">err</span>&nbsp;<span class="op" id="5772601">!=</span>&nbsp;<span class="builtintype" id="5772604">nil</span>&nbsp;<span class="op" id="5772608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5772613">if</span>&nbsp;<span class="ident" id="5772616">debugLog</span>&nbsp;<span class="op" id="5772625">&amp;&amp;</span>&nbsp;<span class="ident" id="5772628">err</span>&nbsp;<span class="op" id="5772632">!=</span>&nbsp;<span class="ident" id="5772635">io</span><span class="op" id="5772637">.</span><span class="ident" id="5772638">EOF</span>&nbsp;<span class="op" id="5772642">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5772648">log</span><span class="op" id="5772651">.</span><span class="ident" id="5772652">Println</span><span class="op" id="5772659">(</span><span class="string" id="5772660">&#34;rpc:&#34;</span><span class="op" id="5772666">,</span>&nbsp;<span class="ident" id="5772668">err</span><span class="op" id="5772671">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5772676">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5772681">if</span>&nbsp;<span class="op" id="5772684">!</span><span class="ident" id="5772685">keepReading</span>&nbsp;<span class="op" id="5772697">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5772703">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5772712">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5772717">//&nbsp;send&nbsp;a&nbsp;response&nbsp;if&nbsp;we&nbsp;actually&nbsp;managed&nbsp;to&nbsp;read&nbsp;a&nbsp;header.</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5772780">if</span>&nbsp;<span class="ident" id="5772783">req</span>&nbsp;<span class="op" id="5772787">!=</span>&nbsp;<span class="builtintype" id="5772790">nil</span>&nbsp;<span class="op" id="5772794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5772800">server</span><span class="op" id="5772806">.</span><span class="ident" id="5772807">sendResponse</span><span class="op" id="5772819">(</span><span class="ident" id="5772820">sending</span><span class="op" id="5772827">,</span>&nbsp;<span class="ident" id="5772829">req</span><span class="op" id="5772832">,</span>&nbsp;<span class="ident" id="5772834">invalidRequest</span><span class="op" id="5772848">,</span>&nbsp;<span class="ident" id="5772850">codec</span><span class="op" id="5772855">,</span>&nbsp;<span class="ident" id="5772857">err</span><span class="op" id="5772860">.</span><span class="ident" id="5772861">Error</span><span class="op" id="5772866">(</span><span class="op" id="5772867">)</span><span class="op" id="5772868">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5772874">server</span><span class="op" id="5772880">.</span><span class="ident" id="5772881">freeRequest</span><span class="op" id="5772892">(</span><span class="ident" id="5772893">req</span><span class="op" id="5772896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5772901">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5772906">continue</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5772917">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5772921">go</span>&nbsp;<span class="ident" id="5772924">service</span><span class="op" id="5772931">.</span><span class="ident" id="5772932">call</span><span class="op" id="5772936">(</span><span class="ident" id="5772937">server</span><span class="op" id="5772943">,</span>&nbsp;<span class="ident" id="5772945">sending</span><span class="op" id="5772952">,</span>&nbsp;<span class="ident" id="5772954">mtype</span><span class="op" id="5772959">,</span>&nbsp;<span class="ident" id="5772961">req</span><span class="op" id="5772964">,</span>&nbsp;<span class="ident" id="5772966">argv</span><span class="op" id="5772970">,</span>&nbsp;<span class="ident" id="5772972">replyv</span><span class="op" id="5772978">,</span>&nbsp;<span class="ident" id="5772980">codec</span><span class="op" id="5772985">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5772988">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5772991">codec</span><span class="op" id="5772996">.</span><span class="ident" id="5772997">Close</span><span class="op" id="5773002">(</span><span class="op" id="5773003">)</span><br>
<span class="lineno"></span><span class="op" id="5773005">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span><span class="comment" id="5773008">//&nbsp;ServeRequest&nbsp;is&nbsp;like&nbsp;ServeCodec&nbsp;but&nbsp;synchronously&nbsp;serves&nbsp;a&nbsp;single&nbsp;request.</span><br>
<span class="lineno"></span><span class="comment" id="5773086">//&nbsp;It&nbsp;does&nbsp;not&nbsp;close&nbsp;the&nbsp;codec&nbsp;upon&nbsp;completion.</span><br>
<span class="lineno"></span><span class="keyword" id="5773134">func</span>&nbsp;<span class="op" id="5773139">(</span><span class="ident" id="5773140">server</span>&nbsp;<span class="op" id="5773147">*</span><span class="ident" id="5773148">Server</span><span class="op" id="5773154">)</span>&nbsp;<span class="ident" id="5773156">ServeRequest</span><span class="op" id="5773168">(</span><span class="ident" id="5773169">codec</span>&nbsp;<span class="ident" id="5773175">ServerCodec</span><span class="op" id="5773186">)</span>&nbsp;<span class="builtintype" id="5773188">error</span>&nbsp;<span class="op" id="5773194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5773197">sending</span>&nbsp;<span class="op" id="5773205">:=</span>&nbsp;<span class="builtinfunc" id="5773208">new</span><span class="op" id="5773211">(</span><span class="ident" id="5773212">sync</span><span class="op" id="5773216">.</span><span class="ident" id="5773217">Mutex</span><span class="op" id="5773222">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5773225">service</span><span class="op" id="5773232">,</span>&nbsp;<span class="ident" id="5773234">mtype</span><span class="op" id="5773239">,</span>&nbsp;<span class="ident" id="5773241">req</span><span class="op" id="5773244">,</span>&nbsp;<span class="ident" id="5773246">argv</span><span class="op" id="5773250">,</span>&nbsp;<span class="ident" id="5773252">replyv</span><span class="op" id="5773258">,</span>&nbsp;<span class="ident" id="5773260">keepReading</span><span class="op" id="5773271">,</span>&nbsp;<span class="ident" id="5773273">err</span>&nbsp;<span class="op" id="5773277">:=</span>&nbsp;<span class="ident" id="5773280">server</span><span class="op" id="5773286">.</span><span class="ident" id="5773287">readRequest</span><span class="op" id="5773298">(</span><span class="ident" id="5773299">codec</span><span class="op" id="5773304">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5773307">if</span>&nbsp;<span class="ident" id="5773310">err</span>&nbsp;<span class="op" id="5773314">!=</span>&nbsp;<span class="builtintype" id="5773317">nil</span>&nbsp;<span class="op" id="5773321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5773325">if</span>&nbsp;<span class="op" id="5773328">!</span><span class="ident" id="5773329">keepReading</span>&nbsp;<span class="op" id="5773341">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5773346">return</span>&nbsp;<span class="ident" id="5773353">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5773359">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5773363">//&nbsp;send&nbsp;a&nbsp;response&nbsp;if&nbsp;we&nbsp;actually&nbsp;managed&nbsp;to&nbsp;read&nbsp;a&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5773425">if</span>&nbsp;<span class="ident" id="5773428">req</span>&nbsp;<span class="op" id="5773432">!=</span>&nbsp;<span class="builtintype" id="5773435">nil</span>&nbsp;<span class="op" id="5773439">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5773444">server</span><span class="op" id="5773450">.</span><span class="ident" id="5773451">sendResponse</span><span class="op" id="5773463">(</span><span class="ident" id="5773464">sending</span><span class="op" id="5773471">,</span>&nbsp;<span class="ident" id="5773473">req</span><span class="op" id="5773476">,</span>&nbsp;<span class="ident" id="5773478">invalidRequest</span><span class="op" id="5773492">,</span>&nbsp;<span class="ident" id="5773494">codec</span><span class="op" id="5773499">,</span>&nbsp;<span class="ident" id="5773501">err</span><span class="op" id="5773504">.</span><span class="ident" id="5773505">Error</span><span class="op" id="5773510">(</span><span class="op" id="5773511">)</span><span class="op" id="5773512">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5773517">server</span><span class="op" id="5773523">.</span><span class="ident" id="5773524">freeRequest</span><span class="op" id="5773535">(</span><span class="ident" id="5773536">req</span><span class="op" id="5773539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5773543">}</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5773547">return</span>&nbsp;<span class="ident" id="5773554">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5773559">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5773562">service</span><span class="op" id="5773569">.</span><span class="ident" id="5773570">call</span><span class="op" id="5773574">(</span><span class="ident" id="5773575">server</span><span class="op" id="5773581">,</span>&nbsp;<span class="ident" id="5773583">sending</span><span class="op" id="5773590">,</span>&nbsp;<span class="ident" id="5773592">mtype</span><span class="op" id="5773597">,</span>&nbsp;<span class="ident" id="5773599">req</span><span class="op" id="5773602">,</span>&nbsp;<span class="ident" id="5773604">argv</span><span class="op" id="5773608">,</span>&nbsp;<span class="ident" id="5773610">replyv</span><span class="op" id="5773616">,</span>&nbsp;<span class="ident" id="5773618">codec</span><span class="op" id="5773623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5773626">return</span>&nbsp;<span class="builtintype" id="5773633">nil</span><br>
<span class="lineno"></span><span class="op" id="5773637">}</span><br>
<span class="lineno">500</span><br>
<span class="lineno"></span><span class="keyword" id="5773640">func</span>&nbsp;<span class="op" id="5773645">(</span><span class="ident" id="5773646">server</span>&nbsp;<span class="op" id="5773653">*</span><span class="ident" id="5773654">Server</span><span class="op" id="5773660">)</span>&nbsp;<span class="ident" id="5773662">getRequest</span><span class="op" id="5773672">(</span><span class="op" id="5773673">)</span>&nbsp;<span class="op" id="5773675">*</span><span class="ident" id="5773676">Request</span>&nbsp;<span class="op" id="5773684">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5773687">server</span><span class="op" id="5773693">.</span><span class="ident" id="5773694">reqLock</span><span class="op" id="5773701">.</span><span class="ident" id="5773702">Lock</span><span class="op" id="5773706">(</span><span class="op" id="5773707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5773710">req</span>&nbsp;<span class="op" id="5773714">:=</span>&nbsp;<span class="ident" id="5773717">server</span><span class="op" id="5773723">.</span><span class="ident" id="5773724">freeReq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5773733">if</span>&nbsp;<span class="ident" id="5773736">req</span>&nbsp;<span class="op" id="5773740">==</span>&nbsp;<span class="builtintype" id="5773743">nil</span>&nbsp;<span class="op" id="5773747">{</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5773751">req</span>&nbsp;<span class="op" id="5773755">=</span>&nbsp;<span class="builtinfunc" id="5773757">new</span><span class="op" id="5773760">(</span><span class="ident" id="5773761">Request</span><span class="op" id="5773768">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5773771">}</span>&nbsp;<span class="keyword" id="5773773">else</span>&nbsp;<span class="op" id="5773778">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5773782">server</span><span class="op" id="5773788">.</span><span class="ident" id="5773789">freeReq</span>&nbsp;<span class="op" id="5773797">=</span>&nbsp;<span class="ident" id="5773799">req</span><span class="op" id="5773802">.</span><span class="ident" id="5773803">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5773810">*</span><span class="ident" id="5773811">req</span>&nbsp;<span class="op" id="5773815">=</span>&nbsp;<span class="ident" id="5773817">Request</span><span class="op" id="5773824">{</span><span class="op" id="5773825">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5773828">}</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5773831">server</span><span class="op" id="5773837">.</span><span class="ident" id="5773838">reqLock</span><span class="op" id="5773845">.</span><span class="ident" id="5773846">Unlock</span><span class="op" id="5773852">(</span><span class="op" id="5773853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5773856">return</span>&nbsp;<span class="ident" id="5773863">req</span><br>
<span class="lineno"></span><span class="op" id="5773867">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5773870">func</span>&nbsp;<span class="op" id="5773875">(</span><span class="ident" id="5773876">server</span>&nbsp;<span class="op" id="5773883">*</span><span class="ident" id="5773884">Server</span><span class="op" id="5773890">)</span>&nbsp;<span class="ident" id="5773892">freeRequest</span><span class="op" id="5773903">(</span><span class="ident" id="5773904">req</span>&nbsp;<span class="op" id="5773908">*</span><span class="ident" id="5773909">Request</span><span class="op" id="5773916">)</span>&nbsp;<span class="op" id="5773918">{</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5773921">server</span><span class="op" id="5773927">.</span><span class="ident" id="5773928">reqLock</span><span class="op" id="5773935">.</span><span class="ident" id="5773936">Lock</span><span class="op" id="5773940">(</span><span class="op" id="5773941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5773944">req</span><span class="op" id="5773947">.</span><span class="ident" id="5773948">next</span>&nbsp;<span class="op" id="5773953">=</span>&nbsp;<span class="ident" id="5773955">server</span><span class="op" id="5773961">.</span><span class="ident" id="5773962">freeReq</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5773971">server</span><span class="op" id="5773977">.</span><span class="ident" id="5773978">freeReq</span>&nbsp;<span class="op" id="5773986">=</span>&nbsp;<span class="ident" id="5773988">req</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5773993">server</span><span class="op" id="5773999">.</span><span class="ident" id="5774000">reqLock</span><span class="op" id="5774007">.</span><span class="ident" id="5774008">Unlock</span><span class="op" id="5774014">(</span><span class="op" id="5774015">)</span><br>
<span class="lineno"></span><span class="op" id="5774017">}</span><br>
<span class="lineno">520</span><br>
<span class="lineno"></span><span class="keyword" id="5774020">func</span>&nbsp;<span class="op" id="5774025">(</span><span class="ident" id="5774026">server</span>&nbsp;<span class="op" id="5774033">*</span><span class="ident" id="5774034">Server</span><span class="op" id="5774040">)</span>&nbsp;<span class="ident" id="5774042">getResponse</span><span class="op" id="5774053">(</span><span class="op" id="5774054">)</span>&nbsp;<span class="op" id="5774056">*</span><span class="ident" id="5774057">Response</span>&nbsp;<span class="op" id="5774066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5774069">server</span><span class="op" id="5774075">.</span><span class="ident" id="5774076">respLock</span><span class="op" id="5774084">.</span><span class="ident" id="5774085">Lock</span><span class="op" id="5774089">(</span><span class="op" id="5774090">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5774093">resp</span>&nbsp;<span class="op" id="5774098">:=</span>&nbsp;<span class="ident" id="5774101">server</span><span class="op" id="5774107">.</span><span class="ident" id="5774108">freeResp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5774118">if</span>&nbsp;<span class="ident" id="5774121">resp</span>&nbsp;<span class="op" id="5774126">==</span>&nbsp;<span class="builtintype" id="5774129">nil</span>&nbsp;<span class="op" id="5774133">{</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5774137">resp</span>&nbsp;<span class="op" id="5774142">=</span>&nbsp;<span class="builtinfunc" id="5774144">new</span><span class="op" id="5774147">(</span><span class="ident" id="5774148">Response</span><span class="op" id="5774156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5774159">}</span>&nbsp;<span class="keyword" id="5774161">else</span>&nbsp;<span class="op" id="5774166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5774170">server</span><span class="op" id="5774176">.</span><span class="ident" id="5774177">freeResp</span>&nbsp;<span class="op" id="5774186">=</span>&nbsp;<span class="ident" id="5774188">resp</span><span class="op" id="5774192">.</span><span class="ident" id="5774193">next</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5774200">*</span><span class="ident" id="5774201">resp</span>&nbsp;<span class="op" id="5774206">=</span>&nbsp;<span class="ident" id="5774208">Response</span><span class="op" id="5774216">{</span><span class="op" id="5774217">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5774220">}</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5774223">server</span><span class="op" id="5774229">.</span><span class="ident" id="5774230">respLock</span><span class="op" id="5774238">.</span><span class="ident" id="5774239">Unlock</span><span class="op" id="5774245">(</span><span class="op" id="5774246">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5774249">return</span>&nbsp;<span class="ident" id="5774256">resp</span><br>
<span class="lineno"></span><span class="op" id="5774261">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5774264">func</span>&nbsp;<span class="op" id="5774269">(</span><span class="ident" id="5774270">server</span>&nbsp;<span class="op" id="5774277">*</span><span class="ident" id="5774278">Server</span><span class="op" id="5774284">)</span>&nbsp;<span class="ident" id="5774286">freeResponse</span><span class="op" id="5774298">(</span><span class="ident" id="5774299">resp</span>&nbsp;<span class="op" id="5774304">*</span><span class="ident" id="5774305">Response</span><span class="op" id="5774313">)</span>&nbsp;<span class="op" id="5774315">{</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5774318">server</span><span class="op" id="5774324">.</span><span class="ident" id="5774325">respLock</span><span class="op" id="5774333">.</span><span class="ident" id="5774334">Lock</span><span class="op" id="5774338">(</span><span class="op" id="5774339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5774342">resp</span><span class="op" id="5774346">.</span><span class="ident" id="5774347">next</span>&nbsp;<span class="op" id="5774352">=</span>&nbsp;<span class="ident" id="5774354">server</span><span class="op" id="5774360">.</span><span class="ident" id="5774361">freeResp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5774371">server</span><span class="op" id="5774377">.</span><span class="ident" id="5774378">freeResp</span>&nbsp;<span class="op" id="5774387">=</span>&nbsp;<span class="ident" id="5774389">resp</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5774395">server</span><span class="op" id="5774401">.</span><span class="ident" id="5774402">respLock</span><span class="op" id="5774410">.</span><span class="ident" id="5774411">Unlock</span><span class="op" id="5774417">(</span><span class="op" id="5774418">)</span><br>
<span class="lineno"></span><span class="op" id="5774420">}</span><br>
<span class="lineno">540</span><br>
<span class="lineno"></span><span class="keyword" id="5774423">func</span>&nbsp;<span class="op" id="5774428">(</span><span class="ident" id="5774429">server</span>&nbsp;<span class="op" id="5774436">*</span><span class="ident" id="5774437">Server</span><span class="op" id="5774443">)</span>&nbsp;<span class="ident" id="5774445">readRequest</span><span class="op" id="5774456">(</span><span class="ident" id="5774457">codec</span>&nbsp;<span class="ident" id="5774463">ServerCodec</span><span class="op" id="5774474">)</span>&nbsp;<span class="op" id="5774476">(</span><span class="ident" id="5774477">service</span>&nbsp;<span class="op" id="5774485">*</span><span class="ident" id="5774486">service</span><span class="op" id="5774493">,</span>&nbsp;<span class="ident" id="5774495">mtype</span>&nbsp;<span class="op" id="5774501">*</span><span class="ident" id="5774502">methodType</span><span class="op" id="5774512">,</span>&nbsp;<span class="ident" id="5774514">req</span>&nbsp;<span class="op" id="5774518">*</span><span class="ident" id="5774519">Request</span><span class="op" id="5774526">,</span>&nbsp;<span class="ident" id="5774528">argv</span><span class="op" id="5774532">,</span>&nbsp;<span class="ident" id="5774534">replyv</span>&nbsp;<span class="ident" id="5774541">reflect</span><span class="op" id="5774548">.</span><span class="ident" id="5774549">Value</span><span class="op" id="5774554">,</span>&nbsp;<span class="ident" id="5774556">keepReading</span>&nbsp;<span class="builtintype" id="5774568">bool</span><span class="op" id="5774572">,</span>&nbsp;<span class="ident" id="5774574">err</span>&nbsp;<span class="builtintype" id="5774578">error</span><span class="op" id="5774583">)</span>&nbsp;<span class="op" id="5774585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5774588">service</span><span class="op" id="5774595">,</span>&nbsp;<span class="ident" id="5774597">mtype</span><span class="op" id="5774602">,</span>&nbsp;<span class="ident" id="5774604">req</span><span class="op" id="5774607">,</span>&nbsp;<span class="ident" id="5774609">keepReading</span><span class="op" id="5774620">,</span>&nbsp;<span class="ident" id="5774622">err</span>&nbsp;<span class="op" id="5774626">=</span>&nbsp;<span class="ident" id="5774628">server</span><span class="op" id="5774634">.</span><span class="ident" id="5774635">readRequestHeader</span><span class="op" id="5774652">(</span><span class="ident" id="5774653">codec</span><span class="op" id="5774658">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5774661">if</span>&nbsp;<span class="ident" id="5774664">err</span>&nbsp;<span class="op" id="5774668">!=</span>&nbsp;<span class="builtintype" id="5774671">nil</span>&nbsp;<span class="op" id="5774675">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5774679">if</span>&nbsp;<span class="op" id="5774682">!</span><span class="ident" id="5774683">keepReading</span>&nbsp;<span class="op" id="5774695">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5774700">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5774709">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5774713">//&nbsp;discard&nbsp;body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5774731">codec</span><span class="op" id="5774736">.</span><span class="ident" id="5774737">ReadRequestBody</span><span class="op" id="5774752">(</span><span class="builtintype" id="5774753">nil</span><span class="op" id="5774756">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5774760">return</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5774768">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5774772">//&nbsp;Decode&nbsp;the&nbsp;argument&nbsp;value.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5774803">argIsValue</span>&nbsp;<span class="op" id="5774814">:=</span>&nbsp;<span class="builtintype" id="5774817">false</span>&nbsp;<span class="comment" id="5774823">//&nbsp;if&nbsp;true,&nbsp;need&nbsp;to&nbsp;indirect&nbsp;before&nbsp;calling.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5774869">if</span>&nbsp;<span class="ident" id="5774872">mtype</span><span class="op" id="5774877">.</span><span class="ident" id="5774878">ArgType</span><span class="op" id="5774885">.</span><span class="ident" id="5774886">Kind</span><span class="op" id="5774890">(</span><span class="op" id="5774891">)</span>&nbsp;<span class="op" id="5774893">==</span>&nbsp;<span class="ident" id="5774896">reflect</span><span class="op" id="5774903">.</span><span class="ident" id="5774904">Ptr</span>&nbsp;<span class="op" id="5774908">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5774912">argv</span>&nbsp;<span class="op" id="5774917">=</span>&nbsp;<span class="ident" id="5774919">reflect</span><span class="op" id="5774926">.</span><span class="ident" id="5774927">New</span><span class="op" id="5774930">(</span><span class="ident" id="5774931">mtype</span><span class="op" id="5774936">.</span><span class="ident" id="5774937">ArgType</span><span class="op" id="5774944">.</span><span class="ident" id="5774945">Elem</span><span class="op" id="5774949">(</span><span class="op" id="5774950">)</span><span class="op" id="5774951">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5774954">}</span>&nbsp;<span class="keyword" id="5774956">else</span>&nbsp;<span class="op" id="5774961">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5774965">argv</span>&nbsp;<span class="op" id="5774970">=</span>&nbsp;<span class="ident" id="5774972">reflect</span><span class="op" id="5774979">.</span><span class="ident" id="5774980">New</span><span class="op" id="5774983">(</span><span class="ident" id="5774984">mtype</span><span class="op" id="5774989">.</span><span class="ident" id="5774990">ArgType</span><span class="op" id="5774997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5775001">argIsValue</span>&nbsp;<span class="op" id="5775012">=</span>&nbsp;<span class="builtintype" id="5775014">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5775020">}</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5775023">//&nbsp;argv&nbsp;guaranteed&nbsp;to&nbsp;be&nbsp;a&nbsp;pointer&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5775064">if</span>&nbsp;<span class="ident" id="5775067">err</span>&nbsp;<span class="op" id="5775071">=</span>&nbsp;<span class="ident" id="5775073">codec</span><span class="op" id="5775078">.</span><span class="ident" id="5775079">ReadRequestBody</span><span class="op" id="5775094">(</span><span class="ident" id="5775095">argv</span><span class="op" id="5775099">.</span><span class="ident" id="5775100">Interface</span><span class="op" id="5775109">(</span><span class="op" id="5775110">)</span><span class="op" id="5775111">)</span><span class="op" id="5775112">;</span>&nbsp;<span class="ident" id="5775114">err</span>&nbsp;<span class="op" id="5775118">!=</span>&nbsp;<span class="builtintype" id="5775121">nil</span>&nbsp;<span class="op" id="5775125">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5775129">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5775137">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5775140">if</span>&nbsp;<span class="ident" id="5775143">argIsValue</span>&nbsp;<span class="op" id="5775154">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5775158">argv</span>&nbsp;<span class="op" id="5775163">=</span>&nbsp;<span class="ident" id="5775165">argv</span><span class="op" id="5775169">.</span><span class="ident" id="5775170">Elem</span><span class="op" id="5775174">(</span><span class="op" id="5775175">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5775178">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5775182">replyv</span>&nbsp;<span class="op" id="5775189">=</span>&nbsp;<span class="ident" id="5775191">reflect</span><span class="op" id="5775198">.</span><span class="ident" id="5775199">New</span><span class="op" id="5775202">(</span><span class="ident" id="5775203">mtype</span><span class="op" id="5775208">.</span><span class="ident" id="5775209">ReplyType</span><span class="op" id="5775218">.</span><span class="ident" id="5775219">Elem</span><span class="op" id="5775223">(</span><span class="op" id="5775224">)</span><span class="op" id="5775225">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5775228">return</span><br>
<span class="lineno">570</span><span class="op" id="5775235">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5775238">func</span>&nbsp;<span class="op" id="5775243">(</span><span class="ident" id="5775244">server</span>&nbsp;<span class="op" id="5775251">*</span><span class="ident" id="5775252">Server</span><span class="op" id="5775258">)</span>&nbsp;<span class="ident" id="5775260">readRequestHeader</span><span class="op" id="5775277">(</span><span class="ident" id="5775278">codec</span>&nbsp;<span class="ident" id="5775284">ServerCodec</span><span class="op" id="5775295">)</span>&nbsp;<span class="op" id="5775297">(</span><span class="ident" id="5775298">service</span>&nbsp;<span class="op" id="5775306">*</span><span class="ident" id="5775307">service</span><span class="op" id="5775314">,</span>&nbsp;<span class="ident" id="5775316">mtype</span>&nbsp;<span class="op" id="5775322">*</span><span class="ident" id="5775323">methodType</span><span class="op" id="5775333">,</span>&nbsp;<span class="ident" id="5775335">req</span>&nbsp;<span class="op" id="5775339">*</span><span class="ident" id="5775340">Request</span><span class="op" id="5775347">,</span>&nbsp;<span class="ident" id="5775349">keepReading</span>&nbsp;<span class="builtintype" id="5775361">bool</span><span class="op" id="5775365">,</span>&nbsp;<span class="ident" id="5775367">err</span>&nbsp;<span class="builtintype" id="5775371">error</span><span class="op" id="5775376">)</span>&nbsp;<span class="op" id="5775378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5775381">//&nbsp;Grab&nbsp;the&nbsp;request&nbsp;header.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5775410">req</span>&nbsp;<span class="op" id="5775414">=</span>&nbsp;<span class="ident" id="5775416">server</span><span class="op" id="5775422">.</span><span class="ident" id="5775423">getRequest</span><span class="op" id="5775433">(</span><span class="op" id="5775434">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5775437">err</span>&nbsp;<span class="op" id="5775441">=</span>&nbsp;<span class="ident" id="5775443">codec</span><span class="op" id="5775448">.</span><span class="ident" id="5775449">ReadRequestHeader</span><span class="op" id="5775466">(</span><span class="ident" id="5775467">req</span><span class="op" id="5775470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5775473">if</span>&nbsp;<span class="ident" id="5775476">err</span>&nbsp;<span class="op" id="5775480">!=</span>&nbsp;<span class="builtintype" id="5775483">nil</span>&nbsp;<span class="op" id="5775487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5775491">req</span>&nbsp;<span class="op" id="5775495">=</span>&nbsp;<span class="builtintype" id="5775497">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5775503">if</span>&nbsp;<span class="ident" id="5775506">err</span>&nbsp;<span class="op" id="5775510">==</span>&nbsp;<span class="ident" id="5775513">io</span><span class="op" id="5775515">.</span><span class="ident" id="5775516">EOF</span>&nbsp;<span class="op" id="5775520">||</span>&nbsp;<span class="ident" id="5775523">err</span>&nbsp;<span class="op" id="5775527">==</span>&nbsp;<span class="ident" id="5775530">io</span><span class="op" id="5775532">.</span><span class="ident" id="5775533">ErrUnexpectedEOF</span>&nbsp;<span class="op" id="5775550">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5775555">return</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5775564">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5775568">err</span>&nbsp;<span class="op" id="5775572">=</span>&nbsp;<span class="ident" id="5775574">errors</span><span class="op" id="5775580">.</span><span class="ident" id="5775581">New</span><span class="op" id="5775584">(</span><span class="string" id="5775585">&#34;rpc:&nbsp;server&nbsp;cannot&nbsp;decode&nbsp;request:&nbsp;&#34;</span>&nbsp;<span class="op" id="5775623">+</span>&nbsp;<span class="ident" id="5775625">err</span><span class="op" id="5775628">.</span><span class="ident" id="5775629">Error</span><span class="op" id="5775634">(</span><span class="op" id="5775635">)</span><span class="op" id="5775636">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5775640">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5775648">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5775652">//&nbsp;We&nbsp;read&nbsp;the&nbsp;header&nbsp;successfully.&nbsp;&nbsp;If&nbsp;we&nbsp;see&nbsp;an&nbsp;error&nbsp;now,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5775714">//&nbsp;we&nbsp;can&nbsp;still&nbsp;recover&nbsp;and&nbsp;move&nbsp;on&nbsp;to&nbsp;the&nbsp;next&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5775772">keepReading</span>&nbsp;<span class="op" id="5775784">=</span>&nbsp;<span class="builtintype" id="5775786">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5775793">dot</span>&nbsp;<span class="op" id="5775797">:=</span>&nbsp;<span class="ident" id="5775800">strings</span><span class="op" id="5775807">.</span><span class="ident" id="5775808">LastIndex</span><span class="op" id="5775817">(</span><span class="ident" id="5775818">req</span><span class="op" id="5775821">.</span><span class="ident" id="5775822">ServiceMethod</span><span class="op" id="5775835">,</span>&nbsp;<span class="string" id="5775837">&#34;.&#34;</span><span class="op" id="5775840">)</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5775843">if</span>&nbsp;<span class="ident" id="5775846">dot</span>&nbsp;<span class="op" id="5775850">&lt;</span>&nbsp;<span class="num" id="5775852">0</span>&nbsp;<span class="op" id="5775854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5775858">err</span>&nbsp;<span class="op" id="5775862">=</span>&nbsp;<span class="ident" id="5775864">errors</span><span class="op" id="5775870">.</span><span class="ident" id="5775871">New</span><span class="op" id="5775874">(</span><span class="string" id="5775875">&#34;rpc:&nbsp;service/method&nbsp;request&nbsp;ill-formed:&nbsp;&#34;</span>&nbsp;<span class="op" id="5775918">+</span>&nbsp;<span class="ident" id="5775920">req</span><span class="op" id="5775923">.</span><span class="ident" id="5775924">ServiceMethod</span><span class="op" id="5775937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5775941">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5775949">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5775952">serviceName</span>&nbsp;<span class="op" id="5775964">:=</span>&nbsp;<span class="ident" id="5775967">req</span><span class="op" id="5775970">.</span><span class="ident" id="5775971">ServiceMethod</span><span class="op" id="5775984">[</span><span class="op" id="5775985">:</span><span class="ident" id="5775986">dot</span><span class="op" id="5775989">]</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5775992">methodName</span>&nbsp;<span class="op" id="5776003">:=</span>&nbsp;<span class="ident" id="5776006">req</span><span class="op" id="5776009">.</span><span class="ident" id="5776010">ServiceMethod</span><span class="op" id="5776023">[</span><span class="ident" id="5776024">dot</span><span class="op" id="5776027">+</span><span class="num" id="5776028">1</span><span class="op" id="5776029">:</span><span class="op" id="5776030">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5776034">//&nbsp;Look&nbsp;up&nbsp;the&nbsp;request.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5776059">server</span><span class="op" id="5776065">.</span><span class="ident" id="5776066">mu</span><span class="op" id="5776068">.</span><span class="ident" id="5776069">RLock</span><span class="op" id="5776074">(</span><span class="op" id="5776075">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5776078">service</span>&nbsp;<span class="op" id="5776086">=</span>&nbsp;<span class="ident" id="5776088">server</span><span class="op" id="5776094">.</span><span class="ident" id="5776095">serviceMap</span><span class="op" id="5776105">[</span><span class="ident" id="5776106">serviceName</span><span class="op" id="5776117">]</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5776120">server</span><span class="op" id="5776126">.</span><span class="ident" id="5776127">mu</span><span class="op" id="5776129">.</span><span class="ident" id="5776130">RUnlock</span><span class="op" id="5776137">(</span><span class="op" id="5776138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5776141">if</span>&nbsp;<span class="ident" id="5776144">service</span>&nbsp;<span class="op" id="5776152">==</span>&nbsp;<span class="builtintype" id="5776155">nil</span>&nbsp;<span class="op" id="5776159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5776163">err</span>&nbsp;<span class="op" id="5776167">=</span>&nbsp;<span class="ident" id="5776169">errors</span><span class="op" id="5776175">.</span><span class="ident" id="5776176">New</span><span class="op" id="5776179">(</span><span class="string" id="5776180">&#34;rpc:&nbsp;can&#39;t&nbsp;find&nbsp;service&nbsp;&#34;</span>&nbsp;<span class="op" id="5776207">+</span>&nbsp;<span class="ident" id="5776209">req</span><span class="op" id="5776212">.</span><span class="ident" id="5776213">ServiceMethod</span><span class="op" id="5776226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5776230">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5776238">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5776241">mtype</span>&nbsp;<span class="op" id="5776247">=</span>&nbsp;<span class="ident" id="5776249">service</span><span class="op" id="5776256">.</span><span class="ident" id="5776257">method</span><span class="op" id="5776263">[</span><span class="ident" id="5776264">methodName</span><span class="op" id="5776274">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5776277">if</span>&nbsp;<span class="ident" id="5776280">mtype</span>&nbsp;<span class="op" id="5776286">==</span>&nbsp;<span class="builtintype" id="5776289">nil</span>&nbsp;<span class="op" id="5776293">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5776297">err</span>&nbsp;<span class="op" id="5776301">=</span>&nbsp;<span class="ident" id="5776303">errors</span><span class="op" id="5776309">.</span><span class="ident" id="5776310">New</span><span class="op" id="5776313">(</span><span class="string" id="5776314">&#34;rpc:&nbsp;can&#39;t&nbsp;find&nbsp;method&nbsp;&#34;</span>&nbsp;<span class="op" id="5776340">+</span>&nbsp;<span class="ident" id="5776342">req</span><span class="op" id="5776345">.</span><span class="ident" id="5776346">ServiceMethod</span><span class="op" id="5776359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5776362">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5776365">return</span><br>
<span class="lineno">610</span><span class="op" id="5776372">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5776375">//&nbsp;Accept&nbsp;accepts&nbsp;connections&nbsp;on&nbsp;the&nbsp;listener&nbsp;and&nbsp;serves&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="5776441">//&nbsp;for&nbsp;each&nbsp;incoming&nbsp;connection.&nbsp;&nbsp;Accept&nbsp;blocks;&nbsp;the&nbsp;caller&nbsp;typically</span><br>
<span class="lineno"></span><span class="comment" id="5776511">//&nbsp;invokes&nbsp;it&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno">615</span><span class="keyword" id="5776544">func</span>&nbsp;<span class="op" id="5776549">(</span><span class="ident" id="5776550">server</span>&nbsp;<span class="op" id="5776557">*</span><span class="ident" id="5776558">Server</span><span class="op" id="5776564">)</span>&nbsp;<span class="ident" id="5776566">Accept</span><span class="op" id="5776572">(</span><span class="ident" id="5776573">lis</span>&nbsp;<span class="ident" id="5776577">net</span><span class="op" id="5776580">.</span><span class="ident" id="5776581">Listener</span><span class="op" id="5776589">)</span>&nbsp;<span class="op" id="5776591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5776594">for</span>&nbsp;<span class="op" id="5776598">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5776602">conn</span><span class="op" id="5776606">,</span>&nbsp;<span class="ident" id="5776608">err</span>&nbsp;<span class="op" id="5776612">:=</span>&nbsp;<span class="ident" id="5776615">lis</span><span class="op" id="5776618">.</span><span class="ident" id="5776619">Accept</span><span class="op" id="5776625">(</span><span class="op" id="5776626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5776630">if</span>&nbsp;<span class="ident" id="5776633">err</span>&nbsp;<span class="op" id="5776637">!=</span>&nbsp;<span class="builtintype" id="5776640">nil</span>&nbsp;<span class="op" id="5776644">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5776649">log</span><span class="op" id="5776652">.</span><span class="ident" id="5776653">Fatal</span><span class="op" id="5776658">(</span><span class="string" id="5776659">&#34;rpc.Serve:&nbsp;accept:&#34;</span><span class="op" id="5776679">,</span>&nbsp;<span class="ident" id="5776681">err</span><span class="op" id="5776684">.</span><span class="ident" id="5776685">Error</span><span class="op" id="5776690">(</span><span class="op" id="5776691">)</span><span class="op" id="5776692">)</span>&nbsp;<span class="comment" id="5776694">//&nbsp;TODO(r):&nbsp;exit?</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5776714">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5776718">go</span>&nbsp;<span class="ident" id="5776721">server</span><span class="op" id="5776727">.</span><span class="ident" id="5776728">ServeConn</span><span class="op" id="5776737">(</span><span class="ident" id="5776738">conn</span><span class="op" id="5776742">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5776745">}</span><br>
<span class="lineno"></span><span class="op" id="5776747">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">625</span><span class="comment" id="5776750">//&nbsp;Register&nbsp;publishes&nbsp;the&nbsp;receiver&#39;s&nbsp;methods&nbsp;in&nbsp;the&nbsp;DefaultServer.</span><br>
<span class="lineno"></span><span class="keyword" id="5776817">func</span>&nbsp;<span class="ident" id="5776822">Register</span><span class="op" id="5776830">(</span><span class="ident" id="5776831">rcvr</span>&nbsp;<span class="keyword" id="5776836">interface</span><span class="op" id="5776845">{</span><span class="op" id="5776846">}</span><span class="op" id="5776847">)</span>&nbsp;<span class="builtintype" id="5776849">error</span>&nbsp;<span class="op" id="5776855">{</span>&nbsp;<span class="keyword" id="5776857">return</span>&nbsp;<span class="ident" id="5776864">DefaultServer</span><span class="op" id="5776877">.</span><span class="ident" id="5776878">Register</span><span class="op" id="5776886">(</span><span class="ident" id="5776887">rcvr</span><span class="op" id="5776891">)</span>&nbsp;<span class="op" id="5776893">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5776896">//&nbsp;RegisterName&nbsp;is&nbsp;like&nbsp;Register&nbsp;but&nbsp;uses&nbsp;the&nbsp;provided&nbsp;name&nbsp;for&nbsp;the&nbsp;type</span><br>
<span class="lineno"></span><span class="comment" id="5776969">//&nbsp;instead&nbsp;of&nbsp;the&nbsp;receiver&#39;s&nbsp;concrete&nbsp;type.</span><br>
<span class="lineno">630</span><span class="keyword" id="5777013">func</span>&nbsp;<span class="ident" id="5777018">RegisterName</span><span class="op" id="5777030">(</span><span class="ident" id="5777031">name</span>&nbsp;<span class="builtintype" id="5777036">string</span><span class="op" id="5777042">,</span>&nbsp;<span class="ident" id="5777044">rcvr</span>&nbsp;<span class="keyword" id="5777049">interface</span><span class="op" id="5777058">{</span><span class="op" id="5777059">}</span><span class="op" id="5777060">)</span>&nbsp;<span class="builtintype" id="5777062">error</span>&nbsp;<span class="op" id="5777068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5777071">return</span>&nbsp;<span class="ident" id="5777078">DefaultServer</span><span class="op" id="5777091">.</span><span class="ident" id="5777092">RegisterName</span><span class="op" id="5777104">(</span><span class="ident" id="5777105">name</span><span class="op" id="5777109">,</span>&nbsp;<span class="ident" id="5777111">rcvr</span><span class="op" id="5777115">)</span><br>
<span class="lineno"></span><span class="op" id="5777117">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5777120">//&nbsp;A&nbsp;ServerCodec&nbsp;implements&nbsp;reading&nbsp;of&nbsp;RPC&nbsp;requests&nbsp;and&nbsp;writing&nbsp;of</span><br>
<span class="lineno">635</span><span class="comment" id="5777187">//&nbsp;RPC&nbsp;responses&nbsp;for&nbsp;the&nbsp;server&nbsp;side&nbsp;of&nbsp;an&nbsp;RPC&nbsp;session.</span><br>
<span class="lineno"></span><span class="comment" id="5777243">//&nbsp;The&nbsp;server&nbsp;calls&nbsp;ReadRequestHeader&nbsp;and&nbsp;ReadRequestBody&nbsp;in&nbsp;pairs</span><br>
<span class="lineno"></span><span class="comment" id="5777310">//&nbsp;to&nbsp;read&nbsp;requests&nbsp;from&nbsp;the&nbsp;connection,&nbsp;and&nbsp;it&nbsp;calls&nbsp;WriteResponse&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="5777381">//&nbsp;write&nbsp;a&nbsp;response&nbsp;back.&nbsp;&nbsp;The&nbsp;server&nbsp;calls&nbsp;Close&nbsp;when&nbsp;finished&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5777454">//&nbsp;connection.&nbsp;ReadRequestBody&nbsp;may&nbsp;be&nbsp;called&nbsp;with&nbsp;a&nbsp;nil</span><br>
<span class="lineno">640</span><span class="comment" id="5777510">//&nbsp;argument&nbsp;to&nbsp;force&nbsp;the&nbsp;body&nbsp;of&nbsp;the&nbsp;request&nbsp;to&nbsp;be&nbsp;read&nbsp;and&nbsp;discarded.</span><br>
<span class="lineno"></span><span class="keyword" id="5777581">type</span>&nbsp;<span class="ident" id="5777586">ServerCodec</span>&nbsp;<span class="keyword" id="5777598">interface</span>&nbsp;<span class="op" id="5777608">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5777611">ReadRequestHeader</span><span class="op" id="5777628">(</span><span class="op" id="5777629">*</span><span class="ident" id="5777630">Request</span><span class="op" id="5777637">)</span>&nbsp;<span class="builtintype" id="5777639">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5777646">ReadRequestBody</span><span class="op" id="5777661">(</span><span class="keyword" id="5777662">interface</span><span class="op" id="5777671">{</span><span class="op" id="5777672">}</span><span class="op" id="5777673">)</span>&nbsp;<span class="builtintype" id="5777675">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5777682">//&nbsp;WriteResponse&nbsp;must&nbsp;be&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines.</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5777756">WriteResponse</span><span class="op" id="5777769">(</span><span class="op" id="5777770">*</span><span class="ident" id="5777771">Response</span><span class="op" id="5777779">,</span>&nbsp;<span class="keyword" id="5777781">interface</span><span class="op" id="5777790">{</span><span class="op" id="5777791">}</span><span class="op" id="5777792">)</span>&nbsp;<span class="builtintype" id="5777794">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5777802">Close</span><span class="op" id="5777807">(</span><span class="op" id="5777808">)</span>&nbsp;<span class="builtintype" id="5777810">error</span><br>
<span class="lineno"></span><span class="op" id="5777816">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">650</span><span class="comment" id="5777819">//&nbsp;ServeConn&nbsp;runs&nbsp;the&nbsp;DefaultServer&nbsp;on&nbsp;a&nbsp;single&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="5777879">//&nbsp;ServeConn&nbsp;blocks,&nbsp;serving&nbsp;the&nbsp;connection&nbsp;until&nbsp;the&nbsp;client&nbsp;hangs&nbsp;up.</span><br>
<span class="lineno"></span><span class="comment" id="5777950">//&nbsp;The&nbsp;caller&nbsp;typically&nbsp;invokes&nbsp;ServeConn&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="comment" id="5778011">//&nbsp;ServeConn&nbsp;uses&nbsp;the&nbsp;gob&nbsp;wire&nbsp;format&nbsp;(see&nbsp;package&nbsp;gob)&nbsp;on&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="5778074">//&nbsp;connection.&nbsp;&nbsp;To&nbsp;use&nbsp;an&nbsp;alternate&nbsp;codec,&nbsp;use&nbsp;ServeCodec.</span><br>
<span class="lineno">655</span><span class="keyword" id="5778133">func</span>&nbsp;<span class="ident" id="5778138">ServeConn</span><span class="op" id="5778147">(</span><span class="ident" id="5778148">conn</span>&nbsp;<span class="ident" id="5778153">io</span><span class="op" id="5778155">.</span><span class="ident" id="5778156">ReadWriteCloser</span><span class="op" id="5778171">)</span>&nbsp;<span class="op" id="5778173">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5778176">DefaultServer</span><span class="op" id="5778189">.</span><span class="ident" id="5778190">ServeConn</span><span class="op" id="5778199">(</span><span class="ident" id="5778200">conn</span><span class="op" id="5778204">)</span><br>
<span class="lineno"></span><span class="op" id="5778206">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5778209">//&nbsp;ServeCodec&nbsp;is&nbsp;like&nbsp;ServeConn&nbsp;but&nbsp;uses&nbsp;the&nbsp;specified&nbsp;codec&nbsp;to</span><br>
<span class="lineno">660</span><span class="comment" id="5778273">//&nbsp;decode&nbsp;requests&nbsp;and&nbsp;encode&nbsp;responses.</span><br>
<span class="lineno"></span><span class="keyword" id="5778314">func</span>&nbsp;<span class="ident" id="5778319">ServeCodec</span><span class="op" id="5778329">(</span><span class="ident" id="5778330">codec</span>&nbsp;<span class="ident" id="5778336">ServerCodec</span><span class="op" id="5778347">)</span>&nbsp;<span class="op" id="5778349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5778352">DefaultServer</span><span class="op" id="5778365">.</span><span class="ident" id="5778366">ServeCodec</span><span class="op" id="5778376">(</span><span class="ident" id="5778377">codec</span><span class="op" id="5778382">)</span><br>
<span class="lineno"></span><span class="op" id="5778384">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">665</span><span class="comment" id="5778387">//&nbsp;ServeRequest&nbsp;is&nbsp;like&nbsp;ServeCodec&nbsp;but&nbsp;synchronously&nbsp;serves&nbsp;a&nbsp;single&nbsp;request.</span><br>
<span class="lineno"></span><span class="comment" id="5778465">//&nbsp;It&nbsp;does&nbsp;not&nbsp;close&nbsp;the&nbsp;codec&nbsp;upon&nbsp;completion.</span><br>
<span class="lineno"></span><span class="keyword" id="5778513">func</span>&nbsp;<span class="ident" id="5778518">ServeRequest</span><span class="op" id="5778530">(</span><span class="ident" id="5778531">codec</span>&nbsp;<span class="ident" id="5778537">ServerCodec</span><span class="op" id="5778548">)</span>&nbsp;<span class="builtintype" id="5778550">error</span>&nbsp;<span class="op" id="5778556">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5778559">return</span>&nbsp;<span class="ident" id="5778566">DefaultServer</span><span class="op" id="5778579">.</span><span class="ident" id="5778580">ServeRequest</span><span class="op" id="5778592">(</span><span class="ident" id="5778593">codec</span><span class="op" id="5778598">)</span><br>
<span class="lineno"></span><span class="op" id="5778600">}</span><br>
<span class="lineno">670</span><br>
<span class="lineno"></span><span class="comment" id="5778603">//&nbsp;Accept&nbsp;accepts&nbsp;connections&nbsp;on&nbsp;the&nbsp;listener&nbsp;and&nbsp;serves&nbsp;requests</span><br>
<span class="lineno"></span><span class="comment" id="5778669">//&nbsp;to&nbsp;DefaultServer&nbsp;for&nbsp;each&nbsp;incoming&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="5778719">//&nbsp;Accept&nbsp;blocks;&nbsp;the&nbsp;caller&nbsp;typically&nbsp;invokes&nbsp;it&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="5778788">func</span>&nbsp;<span class="ident" id="5778793">Accept</span><span class="op" id="5778799">(</span><span class="ident" id="5778800">lis</span>&nbsp;<span class="ident" id="5778804">net</span><span class="op" id="5778807">.</span><span class="ident" id="5778808">Listener</span><span class="op" id="5778816">)</span>&nbsp;<span class="op" id="5778818">{</span>&nbsp;<span class="ident" id="5778820">DefaultServer</span><span class="op" id="5778833">.</span><span class="ident" id="5778834">Accept</span><span class="op" id="5778840">(</span><span class="ident" id="5778841">lis</span><span class="op" id="5778844">)</span>&nbsp;<span class="op" id="5778846">}</span><br>
<span class="lineno">675</span><br>
<span class="lineno"></span><span class="comment" id="5778849">//&nbsp;Can&nbsp;connect&nbsp;to&nbsp;RPC&nbsp;service&nbsp;using&nbsp;HTTP&nbsp;CONNECT&nbsp;to&nbsp;rpcPath.</span><br>
<span class="lineno"></span><span class="keyword" id="5778910">var</span>&nbsp;<span class="ident" id="5778914">connected</span>&nbsp;<span class="op" id="5778924">=</span>&nbsp;<span class="string" id="5778926">&#34;200&nbsp;Connected&nbsp;to&nbsp;Go&nbsp;RPC&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5778953">//&nbsp;ServeHTTP&nbsp;implements&nbsp;an&nbsp;http.Handler&nbsp;that&nbsp;answers&nbsp;RPC&nbsp;requests.</span><br>
<span class="lineno">680</span><span class="keyword" id="5779020">func</span>&nbsp;<span class="op" id="5779025">(</span><span class="ident" id="5779026">server</span>&nbsp;<span class="op" id="5779033">*</span><span class="ident" id="5779034">Server</span><span class="op" id="5779040">)</span>&nbsp;<span class="ident" id="5779042">ServeHTTP</span><span class="op" id="5779051">(</span><span class="ident" id="5779052">w</span>&nbsp;<span class="ident" id="5779054">http</span><span class="op" id="5779058">.</span><span class="ident" id="5779059">ResponseWriter</span><span class="op" id="5779073">,</span>&nbsp;<span class="ident" id="5779075">req</span>&nbsp;<span class="op" id="5779079">*</span><span class="ident" id="5779080">http</span><span class="op" id="5779084">.</span><span class="ident" id="5779085">Request</span><span class="op" id="5779092">)</span>&nbsp;<span class="op" id="5779094">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5779097">if</span>&nbsp;<span class="ident" id="5779100">req</span><span class="op" id="5779103">.</span><span class="ident" id="5779104">Method</span>&nbsp;<span class="op" id="5779111">!=</span>&nbsp;<span class="string" id="5779114">&#34;CONNECT&#34;</span>&nbsp;<span class="op" id="5779124">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5779128">w</span><span class="op" id="5779129">.</span><span class="ident" id="5779130">Header</span><span class="op" id="5779136">(</span><span class="op" id="5779137">)</span><span class="op" id="5779138">.</span><span class="ident" id="5779139">Set</span><span class="op" id="5779142">(</span><span class="string" id="5779143">&#34;Content-Type&#34;</span><span class="op" id="5779157">,</span>&nbsp;<span class="string" id="5779159">&#34;text/plain;&nbsp;charset=utf-8&#34;</span><span class="op" id="5779186">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5779190">w</span><span class="op" id="5779191">.</span><span class="ident" id="5779192">WriteHeader</span><span class="op" id="5779203">(</span><span class="ident" id="5779204">http</span><span class="op" id="5779208">.</span><span class="ident" id="5779209">StatusMethodNotAllowed</span><span class="op" id="5779231">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5779235">io</span><span class="op" id="5779237">.</span><span class="ident" id="5779238">WriteString</span><span class="op" id="5779249">(</span><span class="ident" id="5779250">w</span><span class="op" id="5779251">,</span>&nbsp;<span class="string" id="5779253">&#34;405&nbsp;must&nbsp;CONNECT\n&#34;</span><span class="op" id="5779273">)</span><br>
<span class="lineno">685</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5779277">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5779285">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5779288">conn</span><span class="op" id="5779292">,</span>&nbsp;<span class="ident" id="5779294">_</span><span class="op" id="5779295">,</span>&nbsp;<span class="ident" id="5779297">err</span>&nbsp;<span class="op" id="5779301">:=</span>&nbsp;<span class="ident" id="5779304">w</span><span class="op" id="5779305">.</span><span class="op" id="5779306">(</span><span class="ident" id="5779307">http</span><span class="op" id="5779311">.</span><span class="ident" id="5779312">Hijacker</span><span class="op" id="5779320">)</span><span class="op" id="5779321">.</span><span class="ident" id="5779322">Hijack</span><span class="op" id="5779328">(</span><span class="op" id="5779329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5779332">if</span>&nbsp;<span class="ident" id="5779335">err</span>&nbsp;<span class="op" id="5779339">!=</span>&nbsp;<span class="builtintype" id="5779342">nil</span>&nbsp;<span class="op" id="5779346">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5779350">log</span><span class="op" id="5779353">.</span><span class="ident" id="5779354">Print</span><span class="op" id="5779359">(</span><span class="string" id="5779360">&#34;rpc&nbsp;hijacking&nbsp;&#34;</span><span class="op" id="5779376">,</span>&nbsp;<span class="ident" id="5779378">req</span><span class="op" id="5779381">.</span><span class="ident" id="5779382">RemoteAddr</span><span class="op" id="5779392">,</span>&nbsp;<span class="string" id="5779394">&#34;:&nbsp;&#34;</span><span class="op" id="5779398">,</span>&nbsp;<span class="ident" id="5779400">err</span><span class="op" id="5779403">.</span><span class="ident" id="5779404">Error</span><span class="op" id="5779409">(</span><span class="op" id="5779410">)</span><span class="op" id="5779411">)</span><br>
<span class="lineno">690</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5779415">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5779423">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5779426">io</span><span class="op" id="5779428">.</span><span class="ident" id="5779429">WriteString</span><span class="op" id="5779440">(</span><span class="ident" id="5779441">conn</span><span class="op" id="5779445">,</span>&nbsp;<span class="string" id="5779447">&#34;HTTP/1.0&nbsp;&#34;</span><span class="op" id="5779458">+</span><span class="ident" id="5779459">connected</span><span class="op" id="5779468">+</span><span class="string" id="5779469">&#34;\n\n&#34;</span><span class="op" id="5779475">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5779478">server</span><span class="op" id="5779484">.</span><span class="ident" id="5779485">ServeConn</span><span class="op" id="5779494">(</span><span class="ident" id="5779495">conn</span><span class="op" id="5779499">)</span><br>
<span class="lineno"></span><span class="op" id="5779501">}</span><br>
<span class="lineno">695</span><br>
<span class="lineno"></span><span class="comment" id="5779504">//&nbsp;HandleHTTP&nbsp;registers&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;for&nbsp;RPC&nbsp;messages&nbsp;on&nbsp;rpcPath,</span><br>
<span class="lineno"></span><span class="comment" id="5779573">//&nbsp;and&nbsp;a&nbsp;debugging&nbsp;handler&nbsp;on&nbsp;debugPath.</span><br>
<span class="lineno"></span><span class="comment" id="5779614">//&nbsp;It&nbsp;is&nbsp;still&nbsp;necessary&nbsp;to&nbsp;invoke&nbsp;http.Serve(),&nbsp;typically&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="5779692">func</span>&nbsp;<span class="op" id="5779697">(</span><span class="ident" id="5779698">server</span>&nbsp;<span class="op" id="5779705">*</span><span class="ident" id="5779706">Server</span><span class="op" id="5779712">)</span>&nbsp;<span class="ident" id="5779714">HandleHTTP</span><span class="op" id="5779724">(</span><span class="ident" id="5779725">rpcPath</span><span class="op" id="5779732">,</span>&nbsp;<span class="ident" id="5779734">debugPath</span>&nbsp;<span class="builtintype" id="5779744">string</span><span class="op" id="5779750">)</span>&nbsp;<span class="op" id="5779752">{</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5779755">http</span><span class="op" id="5779759">.</span><span class="ident" id="5779760">Handle</span><span class="op" id="5779766">(</span><span class="ident" id="5779767">rpcPath</span><span class="op" id="5779774">,</span>&nbsp;<span class="ident" id="5779776">server</span><span class="op" id="5779782">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5779785">http</span><span class="op" id="5779789">.</span><span class="ident" id="5779790">Handle</span><span class="op" id="5779796">(</span><span class="ident" id="5779797">debugPath</span><span class="op" id="5779806">,</span>&nbsp;<span class="ident" id="5779808">debugHTTP</span><span class="op" id="5779817">{</span><span class="ident" id="5779818">server</span><span class="op" id="5779824">}</span><span class="op" id="5779825">)</span><br>
<span class="lineno"></span><span class="op" id="5779827">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5779830">//&nbsp;HandleHTTP&nbsp;registers&nbsp;an&nbsp;HTTP&nbsp;handler&nbsp;for&nbsp;RPC&nbsp;messages&nbsp;to&nbsp;DefaultServer</span><br>
<span class="lineno">705</span><span class="comment" id="5779904">//&nbsp;on&nbsp;DefaultRPCPath&nbsp;and&nbsp;a&nbsp;debugging&nbsp;handler&nbsp;on&nbsp;DefaultDebugPath.</span><br>
<span class="lineno"></span><span class="comment" id="5779970">//&nbsp;It&nbsp;is&nbsp;still&nbsp;necessary&nbsp;to&nbsp;invoke&nbsp;http.Serve(),&nbsp;typically&nbsp;in&nbsp;a&nbsp;go&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="5780048">func</span>&nbsp;<span class="ident" id="5780053">HandleHTTP</span><span class="op" id="5780063">(</span><span class="op" id="5780064">)</span>&nbsp;<span class="op" id="5780066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5780069">DefaultServer</span><span class="op" id="5780082">.</span><span class="ident" id="5780083">HandleHTTP</span><span class="op" id="5780093">(</span><span class="ident" id="5780094">DefaultRPCPath</span><span class="op" id="5780108">,</span>&nbsp;<span class="ident" id="5780110">DefaultDebugPath</span><span class="op" id="5780126">)</span><br>
<span class="lineno"></span><span class="op" id="5780128">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
