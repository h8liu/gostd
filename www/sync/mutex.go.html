<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="1673224">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1673279">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1673333">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="1673384">//&nbsp;Package&nbsp;sync&nbsp;provides&nbsp;basic&nbsp;synchronization&nbsp;primitives&nbsp;such&nbsp;as&nbsp;mutual</span><br>
<span class="lineno"></span><span class="comment" id="1673457">//&nbsp;exclusion&nbsp;locks.&nbsp;&nbsp;Other&nbsp;than&nbsp;the&nbsp;Once&nbsp;and&nbsp;WaitGroup&nbsp;types,&nbsp;most&nbsp;are&nbsp;intended</span><br>
<span class="lineno"></span><span class="comment" id="1673537">//&nbsp;for&nbsp;use&nbsp;by&nbsp;low-level&nbsp;library&nbsp;routines.&nbsp;&nbsp;Higher-level&nbsp;synchronization&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1673612">//&nbsp;better&nbsp;done&nbsp;via&nbsp;channels&nbsp;and&nbsp;communication.</span><br>
<span class="lineno"></span><span class="comment" id="1673659">//</span><br>
<span class="lineno">10</span><span class="comment" id="1673662">//&nbsp;Values&nbsp;containing&nbsp;the&nbsp;types&nbsp;defined&nbsp;in&nbsp;this&nbsp;package&nbsp;should&nbsp;not&nbsp;be&nbsp;copied.</span><br>
<span class="lineno"></span><span class="keyword" id="1673739">package</span>&nbsp;<span class="ident" id="1673747">sync</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1673753">import</span>&nbsp;<span class="op" id="1673760">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1673763">&#34;sync/atomic&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1673778">&#34;unsafe&#34;</span><br>
<span class="lineno"></span><span class="op" id="1673787">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1673790">//&nbsp;A&nbsp;Mutex&nbsp;is&nbsp;a&nbsp;mutual&nbsp;exclusion&nbsp;lock.</span><br>
<span class="lineno"></span><span class="comment" id="1673829">//&nbsp;Mutexes&nbsp;can&nbsp;be&nbsp;created&nbsp;as&nbsp;part&nbsp;of&nbsp;other&nbsp;structures;</span><br>
<span class="lineno">20</span><span class="comment" id="1673884">//&nbsp;the&nbsp;zero&nbsp;value&nbsp;for&nbsp;a&nbsp;Mutex&nbsp;is&nbsp;an&nbsp;unlocked&nbsp;mutex.</span><br>
<span class="lineno"></span><span class="keyword" id="1673936">type</span>&nbsp;<span class="ident" id="1673941">Mutex</span>&nbsp;<span class="keyword" id="1673947">struct</span>&nbsp;<span class="op" id="1673954">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1673957">state</span>&nbsp;<span class="builtintype" id="1673963">int32</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1673970">sema</span>&nbsp;&nbsp;<span class="builtintype" id="1673976">uint32</span><br>
<span class="lineno"></span><span class="op" id="1673983">}</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="comment" id="1673986">//&nbsp;A&nbsp;Locker&nbsp;represents&nbsp;an&nbsp;object&nbsp;that&nbsp;can&nbsp;be&nbsp;locked&nbsp;and&nbsp;unlocked.</span><br>
<span class="lineno"></span><span class="keyword" id="1674052">type</span>&nbsp;<span class="ident" id="1674057">Locker</span>&nbsp;<span class="keyword" id="1674064">interface</span>&nbsp;<span class="op" id="1674074">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1674077">Lock</span><span class="op" id="1674081">(</span><span class="op" id="1674082">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1674085">Unlock</span><span class="op" id="1674091">(</span><span class="op" id="1674092">)</span><br>
<span class="lineno">30</span><span class="op" id="1674094">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1674097">const</span>&nbsp;<span class="op" id="1674103">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1674106">mutexLocked</span>&nbsp;<span class="op" id="1674118">=</span>&nbsp;<span class="num" id="1674120">1</span>&nbsp;<span class="op" id="1674122">&lt;&lt;</span>&nbsp;<span class="ident" id="1674125">iota</span>&nbsp;<span class="comment" id="1674130">//&nbsp;mutex&nbsp;is&nbsp;locked</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1674150">mutexWoken</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1674162">mutexWaiterShift</span>&nbsp;<span class="op" id="1674179">=</span>&nbsp;<span class="ident" id="1674181">iota</span><br>
<span class="lineno"></span><span class="op" id="1674186">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1674189">//&nbsp;Lock&nbsp;locks&nbsp;m.</span><br>
<span class="lineno"></span><span class="comment" id="1674206">//&nbsp;If&nbsp;the&nbsp;lock&nbsp;is&nbsp;already&nbsp;in&nbsp;use,&nbsp;the&nbsp;calling&nbsp;goroutine</span><br>
<span class="lineno">40</span><span class="comment" id="1674262">//&nbsp;blocks&nbsp;until&nbsp;the&nbsp;mutex&nbsp;is&nbsp;available.</span><br>
<span class="lineno"></span><span class="keyword" id="1674302">func</span>&nbsp;<span class="op" id="1674307">(</span><span class="ident" id="1674308">m</span>&nbsp;<span class="op" id="1674310">*</span><span class="ident" id="1674311"><a href="/sync/mutex.go.html#1673941">Mutex</a></span><span class="op" id="1674316">)</span>&nbsp;<span class="ident" id="1674318">Lock</span><span class="op" id="1674322">(</span><span class="op" id="1674323">)</span>&nbsp;<span class="op" id="1674325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1674328">//&nbsp;Fast&nbsp;path:&nbsp;grab&nbsp;unlocked&nbsp;mutex.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1674364">if</span>&nbsp;<span class="ident" id="1674367"><a href="/sync/mutex.go.html#1673763">atomic</a></span><span class="op" id="1674373">.</span><span class="ident" id="1674374">CompareAndSwapInt32</span><span class="op" id="1674393">(</span><span class="op" id="1674394">&amp;</span><span class="ident" id="1674395"><a href="/sync/mutex.go.html#1674308">m</a></span><span class="op" id="1674396">.</span><span class="ident" id="1674397">state</span><span class="op" id="1674402">,</span>&nbsp;<span class="num" id="1674404">0</span><span class="op" id="1674405">,</span>&nbsp;<span class="ident" id="1674407"><a href="/sync/mutex.go.html#1674106">mutexLocked</a></span><span class="op" id="1674418">)</span>&nbsp;<span class="op" id="1674420">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1674424">if</span>&nbsp;<span class="ident" id="1674427"><a href="/sync/race0.go.html#1684026">raceenabled</a></span>&nbsp;<span class="op" id="1674439">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1674444"><a href="/sync/race0.go.html#1684052">raceAcquire</a></span><span class="op" id="1674455">(</span><span class="ident" id="1674456"><a href="/sync/mutex.go.html#1673778">unsafe</a></span><span class="op" id="1674462">.</span><span class="ident" id="1674463">Pointer</span><span class="op" id="1674470">(</span><span class="ident" id="1674471"><a href="/sync/mutex.go.html#1674308">m</a></span><span class="op" id="1674472">)</span><span class="op" id="1674473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1674477">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1674481">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1674489">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1674493">awoke</span>&nbsp;<span class="op" id="1674499">:=</span>&nbsp;<span class="ident" id="1674502">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1674509">for</span>&nbsp;<span class="op" id="1674513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1674517">old</span>&nbsp;<span class="op" id="1674521">:=</span>&nbsp;<span class="ident" id="1674524"><a href="/sync/mutex.go.html#1674308">m</a></span><span class="op" id="1674525">.</span><span class="ident" id="1674526">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1674534">new</span>&nbsp;<span class="op" id="1674538">:=</span>&nbsp;<span class="ident" id="1674541"><a href="/sync/mutex.go.html#1674517">old</a></span>&nbsp;<span class="op" id="1674545">|</span>&nbsp;<span class="ident" id="1674547"><a href="/sync/mutex.go.html#1674106">mutexLocked</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1674561">if</span>&nbsp;<span class="ident" id="1674564"><a href="/sync/mutex.go.html#1674517">old</a></span><span class="op" id="1674567">&amp;</span><span class="ident" id="1674568"><a href="/sync/mutex.go.html#1674106">mutexLocked</a></span>&nbsp;<span class="op" id="1674580">!=</span>&nbsp;<span class="num" id="1674583">0</span>&nbsp;<span class="op" id="1674585">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1674590"><a href="/sync/mutex.go.html#1674534">new</a></span>&nbsp;<span class="op" id="1674594">=</span>&nbsp;<span class="ident" id="1674596"><a href="/sync/mutex.go.html#1674517">old</a></span>&nbsp;<span class="op" id="1674600">+</span>&nbsp;<span class="num" id="1674602">1</span><span class="op" id="1674603">&lt;&lt;</span><span class="ident" id="1674605"><a href="/sync/mutex.go.html#1674162">mutexWaiterShift</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1674624">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1674628">if</span>&nbsp;<span class="ident" id="1674631"><a href="/sync/mutex.go.html#1674493">awoke</a></span>&nbsp;<span class="op" id="1674637">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1674642">//&nbsp;The&nbsp;goroutine&nbsp;has&nbsp;been&nbsp;woken&nbsp;from&nbsp;sleep,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1674689">//&nbsp;so&nbsp;we&nbsp;need&nbsp;to&nbsp;reset&nbsp;the&nbsp;flag&nbsp;in&nbsp;either&nbsp;case.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1674740"><a href="/sync/mutex.go.html#1674534">new</a></span>&nbsp;<span class="op" id="1674744">&amp;^=</span>&nbsp;<span class="ident" id="1674748"><a href="/sync/mutex.go.html#1674150">mutexWoken</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1674761">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1674765">if</span>&nbsp;<span class="ident" id="1674768"><a href="/sync/mutex.go.html#1673763">atomic</a></span><span class="op" id="1674774">.</span><span class="ident" id="1674775">CompareAndSwapInt32</span><span class="op" id="1674794">(</span><span class="op" id="1674795">&amp;</span><span class="ident" id="1674796"><a href="/sync/mutex.go.html#1674308">m</a></span><span class="op" id="1674797">.</span><span class="ident" id="1674798">state</span><span class="op" id="1674803">,</span>&nbsp;<span class="ident" id="1674805"><a href="/sync/mutex.go.html#1674517">old</a></span><span class="op" id="1674808">,</span>&nbsp;<span class="builtinfunc" id="1674810"><a href="/sync/mutex.go.html#1674534">new</a></span><span class="op" id="1674813">)</span>&nbsp;<span class="op" id="1674815">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1674820">if</span>&nbsp;<span class="ident" id="1674823"><a href="/sync/mutex.go.html#1674517">old</a></span><span class="op" id="1674826">&amp;</span><span class="ident" id="1674827"><a href="/sync/mutex.go.html#1674106">mutexLocked</a></span>&nbsp;<span class="op" id="1674839">==</span>&nbsp;<span class="num" id="1674842">0</span>&nbsp;<span class="op" id="1674844">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1674850">break</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1674859">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1674864"><a href="/sync/runtime.go.html#1684726">runtime_Semacquire</a></span><span class="op" id="1674882">(</span><span class="op" id="1674883">&amp;</span><span class="ident" id="1674884"><a href="/sync/mutex.go.html#1674308">m</a></span><span class="op" id="1674885">.</span><span class="ident" id="1674886">sema</span><span class="op" id="1674890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1674895"><a href="/sync/mutex.go.html#1674493">awoke</a></span>&nbsp;<span class="op" id="1674901">=</span>&nbsp;<span class="ident" id="1674903">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1674910">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1674913">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1674917">if</span>&nbsp;<span class="ident" id="1674920"><a href="/sync/race0.go.html#1684026">raceenabled</a></span>&nbsp;<span class="op" id="1674932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1674936"><a href="/sync/race0.go.html#1684052">raceAcquire</a></span><span class="op" id="1674947">(</span><span class="ident" id="1674948"><a href="/sync/mutex.go.html#1673778">unsafe</a></span><span class="op" id="1674954">.</span><span class="ident" id="1674955">Pointer</span><span class="op" id="1674962">(</span><span class="ident" id="1674963"><a href="/sync/mutex.go.html#1674308">m</a></span><span class="op" id="1674964">)</span><span class="op" id="1674965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1674968">}</span><br>
<span class="lineno"></span><span class="op" id="1674970">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="comment" id="1674973">//&nbsp;Unlock&nbsp;unlocks&nbsp;m.</span><br>
<span class="lineno"></span><span class="comment" id="1674994">//&nbsp;It&nbsp;is&nbsp;a&nbsp;run-time&nbsp;error&nbsp;if&nbsp;m&nbsp;is&nbsp;not&nbsp;locked&nbsp;on&nbsp;entry&nbsp;to&nbsp;Unlock.</span><br>
<span class="lineno"></span><span class="comment" id="1675059">//</span><br>
<span class="lineno"></span><span class="comment" id="1675062">//&nbsp;A&nbsp;locked&nbsp;Mutex&nbsp;is&nbsp;not&nbsp;associated&nbsp;with&nbsp;a&nbsp;particular&nbsp;goroutine.</span><br>
<span class="lineno">80</span><span class="comment" id="1675127">//&nbsp;It&nbsp;is&nbsp;allowed&nbsp;for&nbsp;one&nbsp;goroutine&nbsp;to&nbsp;lock&nbsp;a&nbsp;Mutex&nbsp;and&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="1675187">//&nbsp;arrange&nbsp;for&nbsp;another&nbsp;goroutine&nbsp;to&nbsp;unlock&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="1675234">func</span>&nbsp;<span class="op" id="1675239">(</span><span class="ident" id="1675240">m</span>&nbsp;<span class="op" id="1675242">*</span><span class="ident" id="1675243"><a href="/sync/mutex.go.html#1673941">Mutex</a></span><span class="op" id="1675248">)</span>&nbsp;<span class="ident" id="1675250">Unlock</span><span class="op" id="1675256">(</span><span class="op" id="1675257">)</span>&nbsp;<span class="op" id="1675259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1675262">if</span>&nbsp;<span class="ident" id="1675265"><a href="/sync/race0.go.html#1684026">raceenabled</a></span>&nbsp;<span class="op" id="1675277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1675281">_</span>&nbsp;<span class="op" id="1675283">=</span>&nbsp;<span class="ident" id="1675285"><a href="/sync/mutex.go.html#1675240">m</a></span><span class="op" id="1675286">.</span><span class="ident" id="1675287">state</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1675295"><a href="/sync/race0.go.html#1684095">raceRelease</a></span><span class="op" id="1675306">(</span><span class="ident" id="1675307"><a href="/sync/mutex.go.html#1673778">unsafe</a></span><span class="op" id="1675313">.</span><span class="ident" id="1675314">Pointer</span><span class="op" id="1675321">(</span><span class="ident" id="1675322"><a href="/sync/mutex.go.html#1675240">m</a></span><span class="op" id="1675323">)</span><span class="op" id="1675324">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1675327">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1675331">//&nbsp;Fast&nbsp;path:&nbsp;drop&nbsp;lock&nbsp;bit.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1675361">new</span>&nbsp;<span class="op" id="1675365">:=</span>&nbsp;<span class="ident" id="1675368"><a href="/sync/mutex.go.html#1673763">atomic</a></span><span class="op" id="1675374">.</span><span class="ident" id="1675375">AddInt32</span><span class="op" id="1675383">(</span><span class="op" id="1675384">&amp;</span><span class="ident" id="1675385"><a href="/sync/mutex.go.html#1675240">m</a></span><span class="op" id="1675386">.</span><span class="ident" id="1675387">state</span><span class="op" id="1675392">,</span>&nbsp;<span class="op" id="1675394">-</span><span class="ident" id="1675395"><a href="/sync/mutex.go.html#1674106">mutexLocked</a></span><span class="op" id="1675406">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1675409">if</span>&nbsp;<span class="op" id="1675412">(</span><span class="builtinfunc" id="1675413"><a href="/sync/mutex.go.html#1675361">new</a></span><span class="op" id="1675416">+</span><span class="ident" id="1675417"><a href="/sync/mutex.go.html#1674106">mutexLocked</a></span><span class="op" id="1675428">)</span><span class="op" id="1675429">&amp;</span><span class="ident" id="1675430"><a href="/sync/mutex.go.html#1674106">mutexLocked</a></span>&nbsp;<span class="op" id="1675442">==</span>&nbsp;<span class="num" id="1675445">0</span>&nbsp;<span class="op" id="1675447">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1675451">panic</span><span class="op" id="1675456">(</span><span class="string" id="1675457">&#34;sync:&nbsp;unlock&nbsp;of&nbsp;unlocked&nbsp;mutex&#34;</span><span class="op" id="1675489">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1675492">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1675496">old</span>&nbsp;<span class="op" id="1675500">:=</span>&nbsp;<span class="builtinfunc" id="1675503"><a href="/sync/mutex.go.html#1675361">new</a></span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1675508">for</span>&nbsp;<span class="op" id="1675512">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1675516">//&nbsp;If&nbsp;there&nbsp;are&nbsp;no&nbsp;waiters&nbsp;or&nbsp;a&nbsp;goroutine&nbsp;has&nbsp;already</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1675572">//&nbsp;been&nbsp;woken&nbsp;or&nbsp;grabbed&nbsp;the&nbsp;lock,&nbsp;no&nbsp;need&nbsp;to&nbsp;wake&nbsp;anyone.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1675633">if</span>&nbsp;<span class="ident" id="1675636"><a href="/sync/mutex.go.html#1675496">old</a></span><span class="op" id="1675639">&gt;&gt;</span><span class="ident" id="1675641"><a href="/sync/mutex.go.html#1674162">mutexWaiterShift</a></span>&nbsp;<span class="op" id="1675658">==</span>&nbsp;<span class="num" id="1675661">0</span>&nbsp;<span class="op" id="1675663">||</span>&nbsp;<span class="ident" id="1675666"><a href="/sync/mutex.go.html#1675496">old</a></span><span class="op" id="1675669">&amp;</span><span class="op" id="1675670">(</span><span class="ident" id="1675671"><a href="/sync/mutex.go.html#1674106">mutexLocked</a></span><span class="op" id="1675682">|</span><span class="ident" id="1675683"><a href="/sync/mutex.go.html#1674150">mutexWoken</a></span><span class="op" id="1675693">)</span>&nbsp;<span class="op" id="1675695">!=</span>&nbsp;<span class="num" id="1675698">0</span>&nbsp;<span class="op" id="1675700">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1675705">return</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1675714">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1675718">//&nbsp;Grab&nbsp;the&nbsp;right&nbsp;to&nbsp;wake&nbsp;someone.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1675755"><a href="/sync/mutex.go.html#1675361">new</a></span>&nbsp;<span class="op" id="1675759">=</span>&nbsp;<span class="op" id="1675761">(</span><span class="ident" id="1675762"><a href="/sync/mutex.go.html#1675496">old</a></span>&nbsp;<span class="op" id="1675766">-</span>&nbsp;<span class="num" id="1675768">1</span><span class="op" id="1675769">&lt;&lt;</span><span class="ident" id="1675771"><a href="/sync/mutex.go.html#1674162">mutexWaiterShift</a></span><span class="op" id="1675787">)</span>&nbsp;<span class="op" id="1675789">|</span>&nbsp;<span class="ident" id="1675791"><a href="/sync/mutex.go.html#1674150">mutexWoken</a></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1675804">if</span>&nbsp;<span class="ident" id="1675807"><a href="/sync/mutex.go.html#1673763">atomic</a></span><span class="op" id="1675813">.</span><span class="ident" id="1675814">CompareAndSwapInt32</span><span class="op" id="1675833">(</span><span class="op" id="1675834">&amp;</span><span class="ident" id="1675835"><a href="/sync/mutex.go.html#1675240">m</a></span><span class="op" id="1675836">.</span><span class="ident" id="1675837">state</span><span class="op" id="1675842">,</span>&nbsp;<span class="ident" id="1675844"><a href="/sync/mutex.go.html#1675496">old</a></span><span class="op" id="1675847">,</span>&nbsp;<span class="builtinfunc" id="1675849"><a href="/sync/mutex.go.html#1675361">new</a></span><span class="op" id="1675852">)</span>&nbsp;<span class="op" id="1675854">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1675859"><a href="/sync/runtime.go.html#1684992">runtime_Semrelease</a></span><span class="op" id="1675877">(</span><span class="op" id="1675878">&amp;</span><span class="ident" id="1675879"><a href="/sync/mutex.go.html#1675240">m</a></span><span class="op" id="1675880">.</span><span class="ident" id="1675881">sema</span><span class="op" id="1675885">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1675890">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1675899">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1675903"><a href="/sync/mutex.go.html#1675496">old</a></span>&nbsp;<span class="op" id="1675907">=</span>&nbsp;<span class="ident" id="1675909"><a href="/sync/mutex.go.html#1675240">m</a></span><span class="op" id="1675910">.</span><span class="ident" id="1675911">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1675918">}</span><br>
<span class="lineno"></span><span class="op" id="1675920">}</span>
</div>
</body>
</html>
