<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/cipher</h2>
<ul>
<li><a href="/gostd/crypto/cipher/benchmark_test.go.html">benchmark_test.go</a></li>
<li><a href="/gostd/crypto/cipher/cbc.go.html">cbc.go</a></li>
<li><a href="/gostd/crypto/cipher/cbc_aes_test.go.html">cbc_aes_test.go</a></li>
<li><a href="/gostd/crypto/cipher/cfb.go.html">cfb.go</a></li>
<li><a href="/gostd/crypto/cipher/cfb_test.go.html">cfb_test.go</a></li>
<li><a href="/gostd/crypto/cipher/cipher.go.html">cipher.go</a></li>
<li><a href="/gostd/crypto/cipher/cipher_test.go.html">cipher_test.go</a></li>
<li><a href="/gostd/crypto/cipher/common_test.go.html">common_test.go</a></li>
<li><a href="/gostd/crypto/cipher/ctr.go.html">ctr.go</a></li>
<li><a href="/gostd/crypto/cipher/ctr_aes_test.go.html">ctr_aes_test.go</a></li>
<li><a href="/gostd/crypto/cipher/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/cipher/gcm.go.html">gcm.go</a></li>
<li><a href="/gostd/crypto/cipher/gcm_test.go.html">gcm_test.go</a></li>
<li><a href="/gostd/crypto/cipher/io.go.html">io.go</a></li>
<li><a href="/gostd/crypto/cipher/ofb.go.html">ofb.go</a></li>
<li><a href="/gostd/crypto/cipher/ofb_test.go.html">ofb_test.go</a></li>
<li><a href="/gostd/crypto/cipher/xor.go.html">xor.go</a></li>
<li><a href="/gostd/crypto/cipher/xor_test.go.html">xor_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3914596">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3914651">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3914705">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3914756">package</span>&nbsp;<span class="ident" id="3914764">cipher</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3914772">import</span>&nbsp;<span class="op" id="3914779">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3914782">&#34;crypto/subtle&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3914799">&#34;errors&#34;</span><br>
<span class="lineno">10</span><span class="op" id="3914808">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3914811">//&nbsp;AEAD&nbsp;is&nbsp;a&nbsp;cipher&nbsp;mode&nbsp;providing&nbsp;authenticated&nbsp;encryption&nbsp;with&nbsp;associated</span><br>
<span class="lineno"></span><span class="comment" id="3914887">//&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="3914896">type</span>&nbsp;<span class="ident" id="3914901">AEAD</span>&nbsp;<span class="keyword" id="3914906">interface</span>&nbsp;<span class="op" id="3914916">{</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3914919">//&nbsp;NonceSize&nbsp;returns&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;nonce&nbsp;that&nbsp;must&nbsp;be&nbsp;passed&nbsp;to&nbsp;Seal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3914991">//&nbsp;and&nbsp;Open.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3915005">NonceSize</span><span class="op" id="3915014">(</span><span class="op" id="3915015">)</span>&nbsp;<span class="builtintype" id="3915017">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3915023">//&nbsp;Overhead&nbsp;returns&nbsp;the&nbsp;maximum&nbsp;difference&nbsp;between&nbsp;the&nbsp;lengths&nbsp;of&nbsp;a</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3915092">//&nbsp;plaintext&nbsp;and&nbsp;ciphertext.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3915122">Overhead</span><span class="op" id="3915130">(</span><span class="op" id="3915131">)</span>&nbsp;<span class="builtintype" id="3915133">int</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3915139">//&nbsp;Seal&nbsp;encrypts&nbsp;and&nbsp;authenticates&nbsp;plaintext,&nbsp;authenticates&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3915204">//&nbsp;additional&nbsp;data&nbsp;and&nbsp;appends&nbsp;the&nbsp;result&nbsp;to&nbsp;dst,&nbsp;returning&nbsp;the&nbsp;updated</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3915277">//&nbsp;slice.&nbsp;The&nbsp;nonce&nbsp;must&nbsp;be&nbsp;NonceSize()&nbsp;bytes&nbsp;long&nbsp;and&nbsp;unique&nbsp;for&nbsp;all</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3915348">//&nbsp;time,&nbsp;for&nbsp;a&nbsp;given&nbsp;key.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3915375">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3915379">//&nbsp;The&nbsp;plaintext&nbsp;and&nbsp;dst&nbsp;may&nbsp;alias&nbsp;exactly&nbsp;or&nbsp;not&nbsp;at&nbsp;all.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3915438">Seal</span><span class="op" id="3915442">(</span><span class="ident" id="3915443">dst</span><span class="op" id="3915446">,</span>&nbsp;<span class="ident" id="3915448">nonce</span><span class="op" id="3915453">,</span>&nbsp;<span class="ident" id="3915455">plaintext</span><span class="op" id="3915464">,</span>&nbsp;<span class="ident" id="3915466">data</span>&nbsp;<span class="op" id="3915471">[</span><span class="op" id="3915472">]</span><span class="builtintype" id="3915473">byte</span><span class="op" id="3915477">)</span>&nbsp;<span class="op" id="3915479">[</span><span class="op" id="3915480">]</span><span class="builtintype" id="3915481">byte</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3915488">//&nbsp;Open&nbsp;decrypts&nbsp;and&nbsp;authenticates&nbsp;ciphertext,&nbsp;authenticates&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3915554">//&nbsp;additional&nbsp;data&nbsp;and,&nbsp;if&nbsp;successful,&nbsp;appends&nbsp;the&nbsp;resulting&nbsp;plaintext</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3915626">//&nbsp;to&nbsp;dst,&nbsp;returning&nbsp;the&nbsp;updated&nbsp;slice.&nbsp;The&nbsp;nonce&nbsp;must&nbsp;be&nbsp;NonceSize()</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3915697">//&nbsp;bytes&nbsp;long&nbsp;and&nbsp;both&nbsp;it&nbsp;and&nbsp;the&nbsp;additional&nbsp;data&nbsp;must&nbsp;match&nbsp;the</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3915763">//&nbsp;value&nbsp;passed&nbsp;to&nbsp;Seal.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3915789">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3915793">//&nbsp;The&nbsp;ciphertext&nbsp;and&nbsp;dst&nbsp;may&nbsp;alias&nbsp;exactly&nbsp;or&nbsp;not&nbsp;at&nbsp;all.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3915853">Open</span><span class="op" id="3915857">(</span><span class="ident" id="3915858">dst</span><span class="op" id="3915861">,</span>&nbsp;<span class="ident" id="3915863">nonce</span><span class="op" id="3915868">,</span>&nbsp;<span class="ident" id="3915870">ciphertext</span><span class="op" id="3915880">,</span>&nbsp;<span class="ident" id="3915882">data</span>&nbsp;<span class="op" id="3915887">[</span><span class="op" id="3915888">]</span><span class="builtintype" id="3915889">byte</span><span class="op" id="3915893">)</span>&nbsp;<span class="op" id="3915895">(</span><span class="op" id="3915896">[</span><span class="op" id="3915897">]</span><span class="builtintype" id="3915898">byte</span><span class="op" id="3915902">,</span>&nbsp;<span class="builtintype" id="3915904">error</span><span class="op" id="3915909">)</span><br>
<span class="lineno"></span><span class="op" id="3915911">}</span><br>
<span class="lineno">40</span><br>
<span class="lineno"></span><span class="comment" id="3915914">//&nbsp;gcmFieldElement&nbsp;represents&nbsp;a&nbsp;value&nbsp;in&nbsp;GF(2¹²⁸).&nbsp;In&nbsp;order&nbsp;to&nbsp;reflect&nbsp;the&nbsp;GCM</span><br>
<span class="lineno"></span><span class="comment" id="3915997">//&nbsp;standard&nbsp;and&nbsp;make&nbsp;getUint64&nbsp;suitable&nbsp;for&nbsp;marshaling&nbsp;these&nbsp;values,&nbsp;the&nbsp;bits</span><br>
<span class="lineno"></span><span class="comment" id="3916075">//&nbsp;are&nbsp;stored&nbsp;backwards.&nbsp;For&nbsp;example:</span><br>
<span class="lineno"></span><span class="comment" id="3916113">//&nbsp;&nbsp;&nbsp;the&nbsp;coefficient&nbsp;of&nbsp;x⁰&nbsp;can&nbsp;be&nbsp;obtained&nbsp;by&nbsp;v.low&nbsp;&gt;&gt;&nbsp;63.</span><br>
<span class="lineno">45</span><span class="comment" id="3916174">//&nbsp;&nbsp;&nbsp;the&nbsp;coefficient&nbsp;of&nbsp;x⁶³&nbsp;can&nbsp;be&nbsp;obtained&nbsp;by&nbsp;v.low&nbsp;&amp;&nbsp;1.</span><br>
<span class="lineno"></span><span class="comment" id="3916235">//&nbsp;&nbsp;&nbsp;the&nbsp;coefficient&nbsp;of&nbsp;x⁶⁴&nbsp;can&nbsp;be&nbsp;obtained&nbsp;by&nbsp;v.high&nbsp;&gt;&gt;&nbsp;63.</span><br>
<span class="lineno"></span><span class="comment" id="3916300">//&nbsp;&nbsp;&nbsp;the&nbsp;coefficient&nbsp;of&nbsp;x¹²⁷&nbsp;can&nbsp;be&nbsp;obtained&nbsp;by&nbsp;v.high&nbsp;&amp;&nbsp;1.</span><br>
<span class="lineno"></span><span class="keyword" id="3916364">type</span>&nbsp;<span class="ident" id="3916369">gcmFieldElement</span>&nbsp;<span class="keyword" id="3916385">struct</span>&nbsp;<span class="op" id="3916392">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3916395">low</span><span class="op" id="3916398">,</span>&nbsp;<span class="ident" id="3916400">high</span>&nbsp;<span class="ident" id="3916405">uint64</span><br>
<span class="lineno">50</span><span class="op" id="3916412">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3916415">//&nbsp;gcm&nbsp;represents&nbsp;a&nbsp;Galois&nbsp;Counter&nbsp;Mode&nbsp;with&nbsp;a&nbsp;specific&nbsp;key.&nbsp;See</span><br>
<span class="lineno"></span><span class="comment" id="3916480">//&nbsp;http://csrc.nist.gov/groups/ST/toolkit/BCM/documents/proposedmodes/gcm/gcm-revised-spec.pdf</span><br>
<span class="lineno"></span><span class="keyword" id="3916575">type</span>&nbsp;<span class="ident" id="3916580">gcm</span>&nbsp;<span class="keyword" id="3916584">struct</span>&nbsp;<span class="op" id="3916591">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3916594">cipher</span>&nbsp;<span class="ident" id="3916601">Block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3916608">//&nbsp;productTable&nbsp;contains&nbsp;the&nbsp;first&nbsp;sixteen&nbsp;powers&nbsp;of&nbsp;the&nbsp;key,&nbsp;H.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3916674">//&nbsp;However,&nbsp;they&nbsp;are&nbsp;in&nbsp;bit&nbsp;reversed&nbsp;order.&nbsp;See&nbsp;NewGCM.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3916731">productTable</span>&nbsp;<span class="op" id="3916744">[</span><span class="num" id="3916745">16</span><span class="op" id="3916747">]</span><span class="ident" id="3916748">gcmFieldElement</span><br>
<span class="lineno"></span><span class="op" id="3916764">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="comment" id="3916767">//&nbsp;NewGCM&nbsp;returns&nbsp;the&nbsp;given&nbsp;128-bit,&nbsp;block&nbsp;cipher&nbsp;wrapped&nbsp;in&nbsp;Galois&nbsp;Counter&nbsp;Mode.</span><br>
<span class="lineno"></span><span class="keyword" id="3916849">func</span>&nbsp;<span class="ident" id="3916854">NewGCM</span><span class="op" id="3916860">(</span><span class="ident" id="3916861">cipher</span>&nbsp;<span class="ident" id="3916868">Block</span><span class="op" id="3916873">)</span>&nbsp;<span class="op" id="3916875">(</span><span class="ident" id="3916876">AEAD</span><span class="op" id="3916880">,</span>&nbsp;<span class="builtintype" id="3916882">error</span><span class="op" id="3916887">)</span>&nbsp;<span class="op" id="3916889">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3916892">if</span>&nbsp;<span class="ident" id="3916895">cipher</span><span class="op" id="3916901">.</span><span class="ident" id="3916902">BlockSize</span><span class="op" id="3916911">(</span><span class="op" id="3916912">)</span>&nbsp;<span class="op" id="3916914">!=</span>&nbsp;<span class="ident" id="3916917">gcmBlockSize</span>&nbsp;<span class="op" id="3916930">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3916934">return</span>&nbsp;<span class="ident" id="3916941">nil</span><span class="op" id="3916944">,</span>&nbsp;<span class="ident" id="3916946">errors</span><span class="op" id="3916952">.</span><span class="ident" id="3916953">New</span><span class="op" id="3916956">(</span><span class="string" id="3916957">&#34;cipher:&nbsp;NewGCM&nbsp;requires&nbsp;128-bit&nbsp;block&nbsp;cipher&#34;</span><span class="op" id="3917003">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3917006">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3917010">var</span>&nbsp;<span class="ident" id="3917014">key</span>&nbsp;<span class="op" id="3917018">[</span><span class="ident" id="3917019">gcmBlockSize</span><span class="op" id="3917031">]</span><span class="builtintype" id="3917032">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3917038">cipher</span><span class="op" id="3917044">.</span><span class="ident" id="3917045">Encrypt</span><span class="op" id="3917052">(</span><span class="ident" id="3917053">key</span><span class="op" id="3917056">[</span><span class="op" id="3917057">:</span><span class="op" id="3917058">]</span><span class="op" id="3917059">,</span>&nbsp;<span class="ident" id="3917061">key</span><span class="op" id="3917064">[</span><span class="op" id="3917065">:</span><span class="op" id="3917066">]</span><span class="op" id="3917067">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3917071">g</span>&nbsp;<span class="op" id="3917073">:=</span>&nbsp;<span class="op" id="3917076">&amp;</span><span class="ident" id="3917077">gcm</span><span class="op" id="3917080">{</span><span class="ident" id="3917081">cipher</span><span class="op" id="3917087">:</span>&nbsp;<span class="ident" id="3917089">cipher</span><span class="op" id="3917095">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3917099">//&nbsp;We&nbsp;precompute&nbsp;16&nbsp;multiples&nbsp;of&nbsp;|key|.&nbsp;However,&nbsp;when&nbsp;we&nbsp;do&nbsp;lookups</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3917168">//&nbsp;into&nbsp;this&nbsp;table&nbsp;we&#39;ll&nbsp;be&nbsp;using&nbsp;bits&nbsp;from&nbsp;a&nbsp;field&nbsp;element&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3917233">//&nbsp;therefore&nbsp;the&nbsp;bits&nbsp;will&nbsp;be&nbsp;in&nbsp;the&nbsp;reverse&nbsp;order.&nbsp;So&nbsp;normally&nbsp;one</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3917302">//&nbsp;would&nbsp;expect,&nbsp;say,&nbsp;4*key&nbsp;to&nbsp;be&nbsp;in&nbsp;index&nbsp;4&nbsp;of&nbsp;the&nbsp;table&nbsp;but&nbsp;due&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3917372">//&nbsp;this&nbsp;bit&nbsp;ordering&nbsp;it&nbsp;will&nbsp;actually&nbsp;be&nbsp;in&nbsp;index&nbsp;0010&nbsp;(base&nbsp;2)&nbsp;=&nbsp;2.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3917442">x</span>&nbsp;<span class="op" id="3917444">:=</span>&nbsp;<span class="ident" id="3917447">gcmFieldElement</span><span class="op" id="3917462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3917466">getUint64</span><span class="op" id="3917475">(</span><span class="ident" id="3917476">key</span><span class="op" id="3917479">[</span><span class="op" id="3917480">:</span><span class="num" id="3917481">8</span><span class="op" id="3917482">]</span><span class="op" id="3917483">)</span><span class="op" id="3917484">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3917488">getUint64</span><span class="op" id="3917497">(</span><span class="ident" id="3917498">key</span><span class="op" id="3917501">[</span><span class="num" id="3917502">8</span><span class="op" id="3917503">:</span><span class="op" id="3917504">]</span><span class="op" id="3917505">)</span><span class="op" id="3917506">,</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3917509">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3917512">g</span><span class="op" id="3917513">.</span><span class="ident" id="3917514">productTable</span><span class="op" id="3917526">[</span><span class="ident" id="3917527">reverseBits</span><span class="op" id="3917538">(</span><span class="num" id="3917539">1</span><span class="op" id="3917540">)</span><span class="op" id="3917541">]</span>&nbsp;<span class="op" id="3917543">=</span>&nbsp;<span class="ident" id="3917545">x</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3917549">for</span>&nbsp;<span class="ident" id="3917553">i</span>&nbsp;<span class="op" id="3917555">:=</span>&nbsp;<span class="num" id="3917558">2</span><span class="op" id="3917559">;</span>&nbsp;<span class="ident" id="3917561">i</span>&nbsp;<span class="op" id="3917563">&lt;</span>&nbsp;<span class="num" id="3917565">16</span><span class="op" id="3917567">;</span>&nbsp;<span class="ident" id="3917569">i</span>&nbsp;<span class="op" id="3917571">+=</span>&nbsp;<span class="num" id="3917574">2</span>&nbsp;<span class="op" id="3917576">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3917580">g</span><span class="op" id="3917581">.</span><span class="ident" id="3917582">productTable</span><span class="op" id="3917594">[</span><span class="ident" id="3917595">reverseBits</span><span class="op" id="3917606">(</span><span class="ident" id="3917607">i</span><span class="op" id="3917608">)</span><span class="op" id="3917609">]</span>&nbsp;<span class="op" id="3917611">=</span>&nbsp;<span class="ident" id="3917613">gcmDouble</span><span class="op" id="3917622">(</span><span class="op" id="3917623">&amp;</span><span class="ident" id="3917624">g</span><span class="op" id="3917625">.</span><span class="ident" id="3917626">productTable</span><span class="op" id="3917638">[</span><span class="ident" id="3917639">reverseBits</span><span class="op" id="3917650">(</span><span class="ident" id="3917651">i</span><span class="op" id="3917652">/</span><span class="num" id="3917653">2</span><span class="op" id="3917654">)</span><span class="op" id="3917655">]</span><span class="op" id="3917656">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3917660">g</span><span class="op" id="3917661">.</span><span class="ident" id="3917662">productTable</span><span class="op" id="3917674">[</span><span class="ident" id="3917675">reverseBits</span><span class="op" id="3917686">(</span><span class="ident" id="3917687">i</span><span class="op" id="3917688">+</span><span class="num" id="3917689">1</span><span class="op" id="3917690">)</span><span class="op" id="3917691">]</span>&nbsp;<span class="op" id="3917693">=</span>&nbsp;<span class="ident" id="3917695">gcmAdd</span><span class="op" id="3917701">(</span><span class="op" id="3917702">&amp;</span><span class="ident" id="3917703">g</span><span class="op" id="3917704">.</span><span class="ident" id="3917705">productTable</span><span class="op" id="3917717">[</span><span class="ident" id="3917718">reverseBits</span><span class="op" id="3917729">(</span><span class="ident" id="3917730">i</span><span class="op" id="3917731">)</span><span class="op" id="3917732">]</span><span class="op" id="3917733">,</span>&nbsp;<span class="op" id="3917735">&amp;</span><span class="ident" id="3917736">x</span><span class="op" id="3917737">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3917740">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3917744">return</span>&nbsp;<span class="ident" id="3917751">g</span><span class="op" id="3917752">,</span>&nbsp;<span class="ident" id="3917754">nil</span><br>
<span class="lineno"></span><span class="op" id="3917758">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="keyword" id="3917761">const</span>&nbsp;<span class="op" id="3917767">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3917770">gcmBlockSize</span>&nbsp;<span class="op" id="3917783">=</span>&nbsp;<span class="num" id="3917785">16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3917789">gcmTagSize</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3917802">=</span>&nbsp;<span class="num" id="3917804">16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3917808">gcmNonceSize</span>&nbsp;<span class="op" id="3917821">=</span>&nbsp;<span class="num" id="3917823">12</span><br>
<span class="lineno">95</span><span class="op" id="3917826">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3917829">func</span>&nbsp;<span class="op" id="3917834">(</span><span class="op" id="3917835">*</span><span class="ident" id="3917836">gcm</span><span class="op" id="3917839">)</span>&nbsp;<span class="ident" id="3917841">NonceSize</span><span class="op" id="3917850">(</span><span class="op" id="3917851">)</span>&nbsp;<span class="builtintype" id="3917853">int</span>&nbsp;<span class="op" id="3917857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3917860">return</span>&nbsp;<span class="ident" id="3917867">gcmNonceSize</span><br>
<span class="lineno"></span><span class="op" id="3917880">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="keyword" id="3917883">func</span>&nbsp;<span class="op" id="3917888">(</span><span class="op" id="3917889">*</span><span class="ident" id="3917890">gcm</span><span class="op" id="3917893">)</span>&nbsp;<span class="ident" id="3917895">Overhead</span><span class="op" id="3917903">(</span><span class="op" id="3917904">)</span>&nbsp;<span class="builtintype" id="3917906">int</span>&nbsp;<span class="op" id="3917910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3917913">return</span>&nbsp;<span class="ident" id="3917920">gcmTagSize</span><br>
<span class="lineno"></span><span class="op" id="3917931">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="keyword" id="3917934">func</span>&nbsp;<span class="op" id="3917939">(</span><span class="ident" id="3917940">g</span>&nbsp;<span class="op" id="3917942">*</span><span class="ident" id="3917943">gcm</span><span class="op" id="3917946">)</span>&nbsp;<span class="ident" id="3917948">Seal</span><span class="op" id="3917952">(</span><span class="ident" id="3917953">dst</span><span class="op" id="3917956">,</span>&nbsp;<span class="ident" id="3917958">nonce</span><span class="op" id="3917963">,</span>&nbsp;<span class="ident" id="3917965">plaintext</span><span class="op" id="3917974">,</span>&nbsp;<span class="ident" id="3917976">data</span>&nbsp;<span class="op" id="3917981">[</span><span class="op" id="3917982">]</span><span class="builtintype" id="3917983">byte</span><span class="op" id="3917987">)</span>&nbsp;<span class="op" id="3917989">[</span><span class="op" id="3917990">]</span><span class="builtintype" id="3917991">byte</span>&nbsp;<span class="op" id="3917996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3917999">if</span>&nbsp;<span class="builtinfunc" id="3918002">len</span><span class="op" id="3918005">(</span><span class="ident" id="3918006">nonce</span><span class="op" id="3918011">)</span>&nbsp;<span class="op" id="3918013">!=</span>&nbsp;<span class="ident" id="3918016">gcmNonceSize</span>&nbsp;<span class="op" id="3918029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3918033">panic</span><span class="op" id="3918038">(</span><span class="string" id="3918039">&#34;cipher:&nbsp;incorrect&nbsp;nonce&nbsp;length&nbsp;given&nbsp;to&nbsp;GCM&#34;</span><span class="op" id="3918084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3918087">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3918091">ret</span><span class="op" id="3918094">,</span>&nbsp;<span class="ident" id="3918096">out</span>&nbsp;<span class="op" id="3918100">:=</span>&nbsp;<span class="ident" id="3918103">sliceForAppend</span><span class="op" id="3918117">(</span><span class="ident" id="3918118">dst</span><span class="op" id="3918121">,</span>&nbsp;<span class="builtinfunc" id="3918123">len</span><span class="op" id="3918126">(</span><span class="ident" id="3918127">plaintext</span><span class="op" id="3918136">)</span><span class="op" id="3918137">+</span><span class="ident" id="3918138">gcmTagSize</span><span class="op" id="3918148">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3918152">//&nbsp;See&nbsp;GCM&nbsp;spec,&nbsp;section&nbsp;7.1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3918183">var</span>&nbsp;<span class="ident" id="3918187">counter</span><span class="op" id="3918194">,</span>&nbsp;<span class="ident" id="3918196">tagMask</span>&nbsp;<span class="op" id="3918204">[</span><span class="ident" id="3918205">gcmBlockSize</span><span class="op" id="3918217">]</span><span class="builtintype" id="3918218">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3918224">copy</span><span class="op" id="3918228">(</span><span class="ident" id="3918229">counter</span><span class="op" id="3918236">[</span><span class="op" id="3918237">:</span><span class="op" id="3918238">]</span><span class="op" id="3918239">,</span>&nbsp;<span class="ident" id="3918241">nonce</span><span class="op" id="3918246">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3918249">counter</span><span class="op" id="3918256">[</span><span class="ident" id="3918257">gcmBlockSize</span><span class="op" id="3918269">-</span><span class="num" id="3918270">1</span><span class="op" id="3918271">]</span>&nbsp;<span class="op" id="3918273">=</span>&nbsp;<span class="num" id="3918275">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3918279">g</span><span class="op" id="3918280">.</span><span class="ident" id="3918281">cipher</span><span class="op" id="3918287">.</span><span class="ident" id="3918288">Encrypt</span><span class="op" id="3918295">(</span><span class="ident" id="3918296">tagMask</span><span class="op" id="3918303">[</span><span class="op" id="3918304">:</span><span class="op" id="3918305">]</span><span class="op" id="3918306">,</span>&nbsp;<span class="ident" id="3918308">counter</span><span class="op" id="3918315">[</span><span class="op" id="3918316">:</span><span class="op" id="3918317">]</span><span class="op" id="3918318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3918321">gcmInc32</span><span class="op" id="3918329">(</span><span class="op" id="3918330">&amp;</span><span class="ident" id="3918331">counter</span><span class="op" id="3918338">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3918342">g</span><span class="op" id="3918343">.</span><span class="ident" id="3918344">counterCrypt</span><span class="op" id="3918356">(</span><span class="ident" id="3918357">out</span><span class="op" id="3918360">,</span>&nbsp;<span class="ident" id="3918362">plaintext</span><span class="op" id="3918371">,</span>&nbsp;<span class="op" id="3918373">&amp;</span><span class="ident" id="3918374">counter</span><span class="op" id="3918381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3918384">g</span><span class="op" id="3918385">.</span><span class="ident" id="3918386">auth</span><span class="op" id="3918390">(</span><span class="ident" id="3918391">out</span><span class="op" id="3918394">[</span><span class="builtinfunc" id="3918395">len</span><span class="op" id="3918398">(</span><span class="ident" id="3918399">plaintext</span><span class="op" id="3918408">)</span><span class="op" id="3918409">:</span><span class="op" id="3918410">]</span><span class="op" id="3918411">,</span>&nbsp;<span class="ident" id="3918413">out</span><span class="op" id="3918416">[</span><span class="op" id="3918417">:</span><span class="builtinfunc" id="3918418">len</span><span class="op" id="3918421">(</span><span class="ident" id="3918422">plaintext</span><span class="op" id="3918431">)</span><span class="op" id="3918432">]</span><span class="op" id="3918433">,</span>&nbsp;<span class="ident" id="3918435">data</span><span class="op" id="3918439">,</span>&nbsp;<span class="op" id="3918441">&amp;</span><span class="ident" id="3918442">tagMask</span><span class="op" id="3918449">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3918453">return</span>&nbsp;<span class="ident" id="3918460">ret</span><br>
<span class="lineno"></span><span class="op" id="3918464">}</span><br>
<span class="lineno">125</span><br>
<span class="lineno"></span><span class="keyword" id="3918467">var</span>&nbsp;<span class="ident" id="3918471">errOpen</span>&nbsp;<span class="op" id="3918479">=</span>&nbsp;<span class="ident" id="3918481">errors</span><span class="op" id="3918487">.</span><span class="ident" id="3918488">New</span><span class="op" id="3918491">(</span><span class="string" id="3918492">&#34;cipher:&nbsp;message&nbsp;authentication&nbsp;failed&#34;</span><span class="op" id="3918531">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3918534">func</span>&nbsp;<span class="op" id="3918539">(</span><span class="ident" id="3918540">g</span>&nbsp;<span class="op" id="3918542">*</span><span class="ident" id="3918543">gcm</span><span class="op" id="3918546">)</span>&nbsp;<span class="ident" id="3918548">Open</span><span class="op" id="3918552">(</span><span class="ident" id="3918553">dst</span><span class="op" id="3918556">,</span>&nbsp;<span class="ident" id="3918558">nonce</span><span class="op" id="3918563">,</span>&nbsp;<span class="ident" id="3918565">ciphertext</span><span class="op" id="3918575">,</span>&nbsp;<span class="ident" id="3918577">data</span>&nbsp;<span class="op" id="3918582">[</span><span class="op" id="3918583">]</span><span class="builtintype" id="3918584">byte</span><span class="op" id="3918588">)</span>&nbsp;<span class="op" id="3918590">(</span><span class="op" id="3918591">[</span><span class="op" id="3918592">]</span><span class="builtintype" id="3918593">byte</span><span class="op" id="3918597">,</span>&nbsp;<span class="builtintype" id="3918599">error</span><span class="op" id="3918604">)</span>&nbsp;<span class="op" id="3918606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3918609">if</span>&nbsp;<span class="builtinfunc" id="3918612">len</span><span class="op" id="3918615">(</span><span class="ident" id="3918616">nonce</span><span class="op" id="3918621">)</span>&nbsp;<span class="op" id="3918623">!=</span>&nbsp;<span class="ident" id="3918626">gcmNonceSize</span>&nbsp;<span class="op" id="3918639">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3918643">panic</span><span class="op" id="3918648">(</span><span class="string" id="3918649">&#34;cipher:&nbsp;incorrect&nbsp;nonce&nbsp;length&nbsp;given&nbsp;to&nbsp;GCM&#34;</span><span class="op" id="3918694">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3918697">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3918701">if</span>&nbsp;<span class="builtinfunc" id="3918704">len</span><span class="op" id="3918707">(</span><span class="ident" id="3918708">ciphertext</span><span class="op" id="3918718">)</span>&nbsp;<span class="op" id="3918720">&lt;</span>&nbsp;<span class="ident" id="3918722">gcmTagSize</span>&nbsp;<span class="op" id="3918733">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3918737">return</span>&nbsp;<span class="ident" id="3918744">nil</span><span class="op" id="3918747">,</span>&nbsp;<span class="ident" id="3918749">errOpen</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3918758">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3918761">tag</span>&nbsp;<span class="op" id="3918765">:=</span>&nbsp;<span class="ident" id="3918768">ciphertext</span><span class="op" id="3918778">[</span><span class="builtinfunc" id="3918779">len</span><span class="op" id="3918782">(</span><span class="ident" id="3918783">ciphertext</span><span class="op" id="3918793">)</span><span class="op" id="3918794">-</span><span class="ident" id="3918795">gcmTagSize</span><span class="op" id="3918805">:</span><span class="op" id="3918806">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3918809">ciphertext</span>&nbsp;<span class="op" id="3918820">=</span>&nbsp;<span class="ident" id="3918822">ciphertext</span><span class="op" id="3918832">[</span><span class="op" id="3918833">:</span><span class="builtinfunc" id="3918834">len</span><span class="op" id="3918837">(</span><span class="ident" id="3918838">ciphertext</span><span class="op" id="3918848">)</span><span class="op" id="3918849">-</span><span class="ident" id="3918850">gcmTagSize</span><span class="op" id="3918860">]</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3918864">//&nbsp;See&nbsp;GCM&nbsp;spec,&nbsp;section&nbsp;7.1.</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3918895">var</span>&nbsp;<span class="ident" id="3918899">counter</span><span class="op" id="3918906">,</span>&nbsp;<span class="ident" id="3918908">tagMask</span>&nbsp;<span class="op" id="3918916">[</span><span class="ident" id="3918917">gcmBlockSize</span><span class="op" id="3918929">]</span><span class="builtintype" id="3918930">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3918936">copy</span><span class="op" id="3918940">(</span><span class="ident" id="3918941">counter</span><span class="op" id="3918948">[</span><span class="op" id="3918949">:</span><span class="op" id="3918950">]</span><span class="op" id="3918951">,</span>&nbsp;<span class="ident" id="3918953">nonce</span><span class="op" id="3918958">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3918961">counter</span><span class="op" id="3918968">[</span><span class="ident" id="3918969">gcmBlockSize</span><span class="op" id="3918981">-</span><span class="num" id="3918982">1</span><span class="op" id="3918983">]</span>&nbsp;<span class="op" id="3918985">=</span>&nbsp;<span class="num" id="3918987">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3918991">g</span><span class="op" id="3918992">.</span><span class="ident" id="3918993">cipher</span><span class="op" id="3918999">.</span><span class="ident" id="3919000">Encrypt</span><span class="op" id="3919007">(</span><span class="ident" id="3919008">tagMask</span><span class="op" id="3919015">[</span><span class="op" id="3919016">:</span><span class="op" id="3919017">]</span><span class="op" id="3919018">,</span>&nbsp;<span class="ident" id="3919020">counter</span><span class="op" id="3919027">[</span><span class="op" id="3919028">:</span><span class="op" id="3919029">]</span><span class="op" id="3919030">)</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3919033">gcmInc32</span><span class="op" id="3919041">(</span><span class="op" id="3919042">&amp;</span><span class="ident" id="3919043">counter</span><span class="op" id="3919050">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3919054">var</span>&nbsp;<span class="ident" id="3919058">expectedTag</span>&nbsp;<span class="op" id="3919070">[</span><span class="ident" id="3919071">gcmTagSize</span><span class="op" id="3919081">]</span><span class="builtintype" id="3919082">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3919088">g</span><span class="op" id="3919089">.</span><span class="ident" id="3919090">auth</span><span class="op" id="3919094">(</span><span class="ident" id="3919095">expectedTag</span><span class="op" id="3919106">[</span><span class="op" id="3919107">:</span><span class="op" id="3919108">]</span><span class="op" id="3919109">,</span>&nbsp;<span class="ident" id="3919111">ciphertext</span><span class="op" id="3919121">,</span>&nbsp;<span class="ident" id="3919123">data</span><span class="op" id="3919127">,</span>&nbsp;<span class="op" id="3919129">&amp;</span><span class="ident" id="3919130">tagMask</span><span class="op" id="3919137">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3919141">if</span>&nbsp;<span class="ident" id="3919144">subtle</span><span class="op" id="3919150">.</span><span class="ident" id="3919151">ConstantTimeCompare</span><span class="op" id="3919170">(</span><span class="ident" id="3919171">expectedTag</span><span class="op" id="3919182">[</span><span class="op" id="3919183">:</span><span class="op" id="3919184">]</span><span class="op" id="3919185">,</span>&nbsp;<span class="ident" id="3919187">tag</span><span class="op" id="3919190">)</span>&nbsp;<span class="op" id="3919192">!=</span>&nbsp;<span class="num" id="3919195">1</span>&nbsp;<span class="op" id="3919197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3919201">return</span>&nbsp;<span class="ident" id="3919208">nil</span><span class="op" id="3919211">,</span>&nbsp;<span class="ident" id="3919213">errOpen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3919222">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3919226">ret</span><span class="op" id="3919229">,</span>&nbsp;<span class="ident" id="3919231">out</span>&nbsp;<span class="op" id="3919235">:=</span>&nbsp;<span class="ident" id="3919238">sliceForAppend</span><span class="op" id="3919252">(</span><span class="ident" id="3919253">dst</span><span class="op" id="3919256">,</span>&nbsp;<span class="builtinfunc" id="3919258">len</span><span class="op" id="3919261">(</span><span class="ident" id="3919262">ciphertext</span><span class="op" id="3919272">)</span><span class="op" id="3919273">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3919276">g</span><span class="op" id="3919277">.</span><span class="ident" id="3919278">counterCrypt</span><span class="op" id="3919290">(</span><span class="ident" id="3919291">out</span><span class="op" id="3919294">,</span>&nbsp;<span class="ident" id="3919296">ciphertext</span><span class="op" id="3919306">,</span>&nbsp;<span class="op" id="3919308">&amp;</span><span class="ident" id="3919309">counter</span><span class="op" id="3919316">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3919320">return</span>&nbsp;<span class="ident" id="3919327">ret</span><span class="op" id="3919330">,</span>&nbsp;<span class="ident" id="3919332">nil</span><br>
<span class="lineno"></span><span class="op" id="3919336">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span><span class="comment" id="3919339">//&nbsp;reverseBits&nbsp;reverses&nbsp;the&nbsp;order&nbsp;of&nbsp;the&nbsp;bits&nbsp;of&nbsp;4-bit&nbsp;number&nbsp;in&nbsp;i.</span><br>
<span class="lineno"></span><span class="keyword" id="3919407">func</span>&nbsp;<span class="ident" id="3919412">reverseBits</span><span class="op" id="3919423">(</span><span class="ident" id="3919424">i</span>&nbsp;<span class="builtintype" id="3919426">int</span><span class="op" id="3919429">)</span>&nbsp;<span class="builtintype" id="3919431">int</span>&nbsp;<span class="op" id="3919435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3919438">i</span>&nbsp;<span class="op" id="3919440">=</span>&nbsp;<span class="op" id="3919442">(</span><span class="op" id="3919443">(</span><span class="ident" id="3919444">i</span>&nbsp;<span class="op" id="3919446">&lt;&lt;</span>&nbsp;<span class="num" id="3919449">2</span><span class="op" id="3919450">)</span>&nbsp;<span class="op" id="3919452">&amp;</span>&nbsp;<span class="num" id="3919454">0xc</span><span class="op" id="3919457">)</span>&nbsp;<span class="op" id="3919459">|</span>&nbsp;<span class="op" id="3919461">(</span><span class="op" id="3919462">(</span><span class="ident" id="3919463">i</span>&nbsp;<span class="op" id="3919465">&gt;&gt;</span>&nbsp;<span class="num" id="3919468">2</span><span class="op" id="3919469">)</span>&nbsp;<span class="op" id="3919471">&amp;</span>&nbsp;<span class="num" id="3919473">0x3</span><span class="op" id="3919476">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3919479">i</span>&nbsp;<span class="op" id="3919481">=</span>&nbsp;<span class="op" id="3919483">(</span><span class="op" id="3919484">(</span><span class="ident" id="3919485">i</span>&nbsp;<span class="op" id="3919487">&lt;&lt;</span>&nbsp;<span class="num" id="3919490">1</span><span class="op" id="3919491">)</span>&nbsp;<span class="op" id="3919493">&amp;</span>&nbsp;<span class="num" id="3919495">0xa</span><span class="op" id="3919498">)</span>&nbsp;<span class="op" id="3919500">|</span>&nbsp;<span class="op" id="3919502">(</span><span class="op" id="3919503">(</span><span class="ident" id="3919504">i</span>&nbsp;<span class="op" id="3919506">&gt;&gt;</span>&nbsp;<span class="num" id="3919509">1</span><span class="op" id="3919510">)</span>&nbsp;<span class="op" id="3919512">&amp;</span>&nbsp;<span class="num" id="3919514">0x5</span><span class="op" id="3919517">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3919520">return</span>&nbsp;<span class="ident" id="3919527">i</span><br>
<span class="lineno">165</span><span class="op" id="3919529">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3919532">//&nbsp;gcmAdd&nbsp;adds&nbsp;two&nbsp;elements&nbsp;of&nbsp;GF(2¹²⁸)&nbsp;and&nbsp;returns&nbsp;the&nbsp;sum.</span><br>
<span class="lineno"></span><span class="keyword" id="3919597">func</span>&nbsp;<span class="ident" id="3919602">gcmAdd</span><span class="op" id="3919608">(</span><span class="ident" id="3919609">x</span><span class="op" id="3919610">,</span>&nbsp;<span class="ident" id="3919612">y</span>&nbsp;<span class="op" id="3919614">*</span><span class="ident" id="3919615">gcmFieldElement</span><span class="op" id="3919630">)</span>&nbsp;<span class="ident" id="3919632">gcmFieldElement</span>&nbsp;<span class="op" id="3919648">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3919651">//&nbsp;Addition&nbsp;in&nbsp;a&nbsp;characteristic&nbsp;2&nbsp;field&nbsp;is&nbsp;just&nbsp;XOR.</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3919705">return</span>&nbsp;<span class="ident" id="3919712">gcmFieldElement</span><span class="op" id="3919727">{</span><span class="ident" id="3919728">x</span><span class="op" id="3919729">.</span><span class="ident" id="3919730">low</span>&nbsp;<span class="op" id="3919734">^</span>&nbsp;<span class="ident" id="3919736">y</span><span class="op" id="3919737">.</span><span class="ident" id="3919738">low</span><span class="op" id="3919741">,</span>&nbsp;<span class="ident" id="3919743">x</span><span class="op" id="3919744">.</span><span class="ident" id="3919745">high</span>&nbsp;<span class="op" id="3919750">^</span>&nbsp;<span class="ident" id="3919752">y</span><span class="op" id="3919753">.</span><span class="ident" id="3919754">high</span><span class="op" id="3919758">}</span><br>
<span class="lineno"></span><span class="op" id="3919760">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3919763">//&nbsp;gcmDouble&nbsp;returns&nbsp;the&nbsp;result&nbsp;of&nbsp;doubling&nbsp;an&nbsp;element&nbsp;of&nbsp;GF(2¹²⁸).</span><br>
<span class="lineno"></span><span class="keyword" id="3919835">func</span>&nbsp;<span class="ident" id="3919840">gcmDouble</span><span class="op" id="3919849">(</span><span class="ident" id="3919850">x</span>&nbsp;<span class="op" id="3919852">*</span><span class="ident" id="3919853">gcmFieldElement</span><span class="op" id="3919868">)</span>&nbsp;<span class="op" id="3919870">(</span><span class="ident" id="3919871">double</span>&nbsp;<span class="ident" id="3919878">gcmFieldElement</span><span class="op" id="3919893">)</span>&nbsp;<span class="op" id="3919895">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3919898">msbSet</span>&nbsp;<span class="op" id="3919905">:=</span>&nbsp;<span class="ident" id="3919908">x</span><span class="op" id="3919909">.</span><span class="ident" id="3919910">high</span><span class="op" id="3919914">&amp;</span><span class="num" id="3919915">1</span>&nbsp;<span class="op" id="3919917">==</span>&nbsp;<span class="num" id="3919920">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3919924">//&nbsp;Because&nbsp;of&nbsp;the&nbsp;bit-ordering,&nbsp;doubling&nbsp;is&nbsp;actually&nbsp;a&nbsp;right&nbsp;shift.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3919993">double</span><span class="op" id="3919999">.</span><span class="ident" id="3920000">high</span>&nbsp;<span class="op" id="3920005">=</span>&nbsp;<span class="ident" id="3920007">x</span><span class="op" id="3920008">.</span><span class="ident" id="3920009">high</span>&nbsp;<span class="op" id="3920014">&gt;&gt;</span>&nbsp;<span class="num" id="3920017">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3920020">double</span><span class="op" id="3920026">.</span><span class="ident" id="3920027">high</span>&nbsp;<span class="op" id="3920032">|=</span>&nbsp;<span class="ident" id="3920035">x</span><span class="op" id="3920036">.</span><span class="ident" id="3920037">low</span>&nbsp;<span class="op" id="3920041">&lt;&lt;</span>&nbsp;<span class="num" id="3920044">63</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3920048">double</span><span class="op" id="3920054">.</span><span class="ident" id="3920055">low</span>&nbsp;<span class="op" id="3920059">=</span>&nbsp;<span class="ident" id="3920061">x</span><span class="op" id="3920062">.</span><span class="ident" id="3920063">low</span>&nbsp;<span class="op" id="3920067">&gt;&gt;</span>&nbsp;<span class="num" id="3920070">1</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3920074">//&nbsp;If&nbsp;the&nbsp;most-significant&nbsp;bit&nbsp;was&nbsp;set&nbsp;before&nbsp;shifting&nbsp;then&nbsp;it,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3920139">//&nbsp;conceptually,&nbsp;becomes&nbsp;a&nbsp;term&nbsp;of&nbsp;x^128.&nbsp;This&nbsp;is&nbsp;greater&nbsp;than&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3920207">//&nbsp;irreducible&nbsp;polynomial&nbsp;so&nbsp;the&nbsp;result&nbsp;has&nbsp;to&nbsp;be&nbsp;reduced.&nbsp;The</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3920271">//&nbsp;irreducible&nbsp;polynomial&nbsp;is&nbsp;1+x+x^2+x^7+x^128.&nbsp;We&nbsp;can&nbsp;subtract&nbsp;that&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3920344">//&nbsp;eliminate&nbsp;the&nbsp;term&nbsp;at&nbsp;x^128&nbsp;which&nbsp;also&nbsp;means&nbsp;subtracting&nbsp;the&nbsp;other</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3920415">//&nbsp;four&nbsp;terms.&nbsp;In&nbsp;characteristic&nbsp;2&nbsp;fields,&nbsp;subtraction&nbsp;==&nbsp;addition&nbsp;==</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3920486">//&nbsp;XOR.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3920495">if</span>&nbsp;<span class="ident" id="3920498">msbSet</span>&nbsp;<span class="op" id="3920505">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3920509">double</span><span class="op" id="3920515">.</span><span class="ident" id="3920516">low</span>&nbsp;<span class="op" id="3920520">^=</span>&nbsp;<span class="num" id="3920523">0xe100000000000000</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3920543">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3920547">return</span><br>
<span class="lineno"></span><span class="op" id="3920554">}</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span><span class="keyword" id="3920557">var</span>&nbsp;<span class="ident" id="3920561">gcmReductionTable</span>&nbsp;<span class="op" id="3920579">=</span>&nbsp;<span class="op" id="3920581">[</span><span class="op" id="3920582">]</span><span class="builtintype" id="3920583">uint16</span><span class="op" id="3920589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="3920592">0x0000</span><span class="op" id="3920598">,</span>&nbsp;<span class="num" id="3920600">0x1c20</span><span class="op" id="3920606">,</span>&nbsp;<span class="num" id="3920608">0x3840</span><span class="op" id="3920614">,</span>&nbsp;<span class="num" id="3920616">0x2460</span><span class="op" id="3920622">,</span>&nbsp;<span class="num" id="3920624">0x7080</span><span class="op" id="3920630">,</span>&nbsp;<span class="num" id="3920632">0x6ca0</span><span class="op" id="3920638">,</span>&nbsp;<span class="num" id="3920640">0x48c0</span><span class="op" id="3920646">,</span>&nbsp;<span class="num" id="3920648">0x54e0</span><span class="op" id="3920654">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="num" id="3920657">0xe100</span><span class="op" id="3920663">,</span>&nbsp;<span class="num" id="3920665">0xfd20</span><span class="op" id="3920671">,</span>&nbsp;<span class="num" id="3920673">0xd940</span><span class="op" id="3920679">,</span>&nbsp;<span class="num" id="3920681">0xc560</span><span class="op" id="3920687">,</span>&nbsp;<span class="num" id="3920689">0x9180</span><span class="op" id="3920695">,</span>&nbsp;<span class="num" id="3920697">0x8da0</span><span class="op" id="3920703">,</span>&nbsp;<span class="num" id="3920705">0xa9c0</span><span class="op" id="3920711">,</span>&nbsp;<span class="num" id="3920713">0xb5e0</span><span class="op" id="3920719">,</span><br>
<span class="lineno"></span><span class="op" id="3920721">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span><span class="comment" id="3920724">//&nbsp;mul&nbsp;sets&nbsp;y&nbsp;to&nbsp;y*H,&nbsp;where&nbsp;H&nbsp;is&nbsp;the&nbsp;GCM&nbsp;key,&nbsp;fixed&nbsp;during&nbsp;NewGCM.</span><br>
<span class="lineno"></span><span class="keyword" id="3920791">func</span>&nbsp;<span class="op" id="3920796">(</span><span class="ident" id="3920797">g</span>&nbsp;<span class="op" id="3920799">*</span><span class="ident" id="3920800">gcm</span><span class="op" id="3920803">)</span>&nbsp;<span class="ident" id="3920805">mul</span><span class="op" id="3920808">(</span><span class="ident" id="3920809">y</span>&nbsp;<span class="op" id="3920811">*</span><span class="ident" id="3920812">gcmFieldElement</span><span class="op" id="3920827">)</span>&nbsp;<span class="op" id="3920829">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3920832">var</span>&nbsp;<span class="ident" id="3920836">z</span>&nbsp;<span class="ident" id="3920838">gcmFieldElement</span><br>
<span class="lineno"></span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3920856">for</span>&nbsp;<span class="ident" id="3920860">i</span>&nbsp;<span class="op" id="3920862">:=</span>&nbsp;<span class="num" id="3920865">0</span><span class="op" id="3920866">;</span>&nbsp;<span class="ident" id="3920868">i</span>&nbsp;<span class="op" id="3920870">&lt;</span>&nbsp;<span class="num" id="3920872">2</span><span class="op" id="3920873">;</span>&nbsp;<span class="ident" id="3920875">i</span><span class="op" id="3920876">++</span>&nbsp;<span class="op" id="3920879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3920883">word</span>&nbsp;<span class="op" id="3920888">:=</span>&nbsp;<span class="ident" id="3920891">y</span><span class="op" id="3920892">.</span><span class="ident" id="3920893">high</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3920900">if</span>&nbsp;<span class="ident" id="3920903">i</span>&nbsp;<span class="op" id="3920905">==</span>&nbsp;<span class="num" id="3920908">1</span>&nbsp;<span class="op" id="3920910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3920915">word</span>&nbsp;<span class="op" id="3920920">=</span>&nbsp;<span class="ident" id="3920922">y</span><span class="op" id="3920923">.</span><span class="ident" id="3920924">low</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3920930">}</span><br>
<span class="lineno">210</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3920935">//&nbsp;Multiplication&nbsp;works&nbsp;by&nbsp;multiplying&nbsp;z&nbsp;by&nbsp;16&nbsp;and&nbsp;adding&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3920998">//&nbsp;one&nbsp;of&nbsp;the&nbsp;precomputed&nbsp;multiples&nbsp;of&nbsp;H.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3921042">for</span>&nbsp;<span class="ident" id="3921046">j</span>&nbsp;<span class="op" id="3921048">:=</span>&nbsp;<span class="num" id="3921051">0</span><span class="op" id="3921052">;</span>&nbsp;<span class="ident" id="3921054">j</span>&nbsp;<span class="op" id="3921056">&lt;</span>&nbsp;<span class="num" id="3921058">64</span><span class="op" id="3921060">;</span>&nbsp;<span class="ident" id="3921062">j</span>&nbsp;<span class="op" id="3921064">+=</span>&nbsp;<span class="num" id="3921067">4</span>&nbsp;<span class="op" id="3921069">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3921074">msw</span>&nbsp;<span class="op" id="3921078">:=</span>&nbsp;<span class="ident" id="3921081">z</span><span class="op" id="3921082">.</span><span class="ident" id="3921083">high</span>&nbsp;<span class="op" id="3921088">&amp;</span>&nbsp;<span class="num" id="3921090">0xf</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3921097">z</span><span class="op" id="3921098">.</span><span class="ident" id="3921099">high</span>&nbsp;<span class="op" id="3921104">&gt;&gt;=</span>&nbsp;<span class="num" id="3921108">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3921113">z</span><span class="op" id="3921114">.</span><span class="ident" id="3921115">high</span>&nbsp;<span class="op" id="3921120">|=</span>&nbsp;<span class="ident" id="3921123">z</span><span class="op" id="3921124">.</span><span class="ident" id="3921125">low</span>&nbsp;<span class="op" id="3921129">&lt;&lt;</span>&nbsp;<span class="num" id="3921132">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3921138">z</span><span class="op" id="3921139">.</span><span class="ident" id="3921140">low</span>&nbsp;<span class="op" id="3921144">&gt;&gt;=</span>&nbsp;<span class="num" id="3921148">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3921153">z</span><span class="op" id="3921154">.</span><span class="ident" id="3921155">low</span>&nbsp;<span class="op" id="3921159">^=</span>&nbsp;<span class="ident" id="3921162">uint64</span><span class="op" id="3921168">(</span><span class="ident" id="3921169">gcmReductionTable</span><span class="op" id="3921186">[</span><span class="ident" id="3921187">msw</span><span class="op" id="3921190">]</span><span class="op" id="3921191">)</span>&nbsp;<span class="op" id="3921193">&lt;&lt;</span>&nbsp;<span class="num" id="3921196">48</span><br>
<span class="lineno"></span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3921203">//&nbsp;the&nbsp;values&nbsp;in&nbsp;|table|&nbsp;are&nbsp;ordered&nbsp;for</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3921247">//&nbsp;little-endian&nbsp;bit&nbsp;positions.&nbsp;See&nbsp;the&nbsp;comment</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3921298">//&nbsp;in&nbsp;NewGCM.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3921315">t</span>&nbsp;<span class="op" id="3921317">:=</span>&nbsp;<span class="op" id="3921320">&amp;</span><span class="ident" id="3921321">g</span><span class="op" id="3921322">.</span><span class="ident" id="3921323">productTable</span><span class="op" id="3921335">[</span><span class="ident" id="3921336">word</span><span class="op" id="3921340">&amp;</span><span class="num" id="3921341">0xf</span><span class="op" id="3921344">]</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3921350">z</span><span class="op" id="3921351">.</span><span class="ident" id="3921352">low</span>&nbsp;<span class="op" id="3921356">^=</span>&nbsp;<span class="ident" id="3921359">t</span><span class="op" id="3921360">.</span><span class="ident" id="3921361">low</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3921368">z</span><span class="op" id="3921369">.</span><span class="ident" id="3921370">high</span>&nbsp;<span class="op" id="3921375">^=</span>&nbsp;<span class="ident" id="3921378">t</span><span class="op" id="3921379">.</span><span class="ident" id="3921380">high</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3921388">word</span>&nbsp;<span class="op" id="3921393">&gt;&gt;=</span>&nbsp;<span class="num" id="3921397">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3921401">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3921404">}</span><br>
<span class="lineno">230</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3921408">*</span><span class="ident" id="3921409">y</span>&nbsp;<span class="op" id="3921411">=</span>&nbsp;<span class="ident" id="3921413">z</span><br>
<span class="lineno"></span><span class="op" id="3921415">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3921418">//&nbsp;updateBlocks&nbsp;extends&nbsp;y&nbsp;with&nbsp;more&nbsp;polynomial&nbsp;terms&nbsp;from&nbsp;blocks,&nbsp;based&nbsp;on</span><br>
<span class="lineno">235</span><span class="comment" id="3921493">//&nbsp;Horner&#39;s&nbsp;rule.&nbsp;There&nbsp;must&nbsp;be&nbsp;a&nbsp;multiple&nbsp;of&nbsp;gcmBlockSize&nbsp;bytes&nbsp;in&nbsp;blocks.</span><br>
<span class="lineno"></span><span class="keyword" id="3921569">func</span>&nbsp;<span class="op" id="3921574">(</span><span class="ident" id="3921575">g</span>&nbsp;<span class="op" id="3921577">*</span><span class="ident" id="3921578">gcm</span><span class="op" id="3921581">)</span>&nbsp;<span class="ident" id="3921583">updateBlocks</span><span class="op" id="3921595">(</span><span class="ident" id="3921596">y</span>&nbsp;<span class="op" id="3921598">*</span><span class="ident" id="3921599">gcmFieldElement</span><span class="op" id="3921614">,</span>&nbsp;<span class="ident" id="3921616">blocks</span>&nbsp;<span class="op" id="3921623">[</span><span class="op" id="3921624">]</span><span class="builtintype" id="3921625">byte</span><span class="op" id="3921629">)</span>&nbsp;<span class="op" id="3921631">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3921634">for</span>&nbsp;<span class="builtinfunc" id="3921638">len</span><span class="op" id="3921641">(</span><span class="ident" id="3921642">blocks</span><span class="op" id="3921648">)</span>&nbsp;<span class="op" id="3921650">&gt;</span>&nbsp;<span class="num" id="3921652">0</span>&nbsp;<span class="op" id="3921654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3921658">y</span><span class="op" id="3921659">.</span><span class="ident" id="3921660">low</span>&nbsp;<span class="op" id="3921664">^=</span>&nbsp;<span class="ident" id="3921667">getUint64</span><span class="op" id="3921676">(</span><span class="ident" id="3921677">blocks</span><span class="op" id="3921683">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3921687">y</span><span class="op" id="3921688">.</span><span class="ident" id="3921689">high</span>&nbsp;<span class="op" id="3921694">^=</span>&nbsp;<span class="ident" id="3921697">getUint64</span><span class="op" id="3921706">(</span><span class="ident" id="3921707">blocks</span><span class="op" id="3921713">[</span><span class="num" id="3921714">8</span><span class="op" id="3921715">:</span><span class="op" id="3921716">]</span><span class="op" id="3921717">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3921721">g</span><span class="op" id="3921722">.</span><span class="ident" id="3921723">mul</span><span class="op" id="3921726">(</span><span class="ident" id="3921727">y</span><span class="op" id="3921728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3921732">blocks</span>&nbsp;<span class="op" id="3921739">=</span>&nbsp;<span class="ident" id="3921741">blocks</span><span class="op" id="3921747">[</span><span class="ident" id="3921748">gcmBlockSize</span><span class="op" id="3921760">:</span><span class="op" id="3921761">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3921764">}</span><br>
<span class="lineno"></span><span class="op" id="3921766">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">245</span><span class="comment" id="3921769">//&nbsp;update&nbsp;extends&nbsp;y&nbsp;with&nbsp;more&nbsp;polynomial&nbsp;terms&nbsp;from&nbsp;data.&nbsp;If&nbsp;data&nbsp;is&nbsp;not&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3921844">//&nbsp;multiple&nbsp;of&nbsp;gcmBlockSize&nbsp;bytes&nbsp;long&nbsp;then&nbsp;the&nbsp;remainder&nbsp;is&nbsp;zero&nbsp;padded.</span><br>
<span class="lineno"></span><span class="keyword" id="3921918">func</span>&nbsp;<span class="op" id="3921923">(</span><span class="ident" id="3921924">g</span>&nbsp;<span class="op" id="3921926">*</span><span class="ident" id="3921927">gcm</span><span class="op" id="3921930">)</span>&nbsp;<span class="ident" id="3921932">update</span><span class="op" id="3921938">(</span><span class="ident" id="3921939">y</span>&nbsp;<span class="op" id="3921941">*</span><span class="ident" id="3921942">gcmFieldElement</span><span class="op" id="3921957">,</span>&nbsp;<span class="ident" id="3921959">data</span>&nbsp;<span class="op" id="3921964">[</span><span class="op" id="3921965">]</span><span class="builtintype" id="3921966">byte</span><span class="op" id="3921970">)</span>&nbsp;<span class="op" id="3921972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3921975">fullBlocks</span>&nbsp;<span class="op" id="3921986">:=</span>&nbsp;<span class="op" id="3921989">(</span><span class="builtinfunc" id="3921990">len</span><span class="op" id="3921993">(</span><span class="ident" id="3921994">data</span><span class="op" id="3921998">)</span>&nbsp;<span class="op" id="3922000">&gt;&gt;</span>&nbsp;<span class="num" id="3922003">4</span><span class="op" id="3922004">)</span>&nbsp;<span class="op" id="3922006">&lt;&lt;</span>&nbsp;<span class="num" id="3922009">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3922012">g</span><span class="op" id="3922013">.</span><span class="ident" id="3922014">updateBlocks</span><span class="op" id="3922026">(</span><span class="ident" id="3922027">y</span><span class="op" id="3922028">,</span>&nbsp;<span class="ident" id="3922030">data</span><span class="op" id="3922034">[</span><span class="op" id="3922035">:</span><span class="ident" id="3922036">fullBlocks</span><span class="op" id="3922046">]</span><span class="op" id="3922047">)</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3922051">if</span>&nbsp;<span class="builtinfunc" id="3922054">len</span><span class="op" id="3922057">(</span><span class="ident" id="3922058">data</span><span class="op" id="3922062">)</span>&nbsp;<span class="op" id="3922064">!=</span>&nbsp;<span class="ident" id="3922067">fullBlocks</span>&nbsp;<span class="op" id="3922078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3922082">var</span>&nbsp;<span class="ident" id="3922086">partialBlock</span>&nbsp;<span class="op" id="3922099">[</span><span class="ident" id="3922100">gcmBlockSize</span><span class="op" id="3922112">]</span><span class="builtintype" id="3922113">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3922120">copy</span><span class="op" id="3922124">(</span><span class="ident" id="3922125">partialBlock</span><span class="op" id="3922137">[</span><span class="op" id="3922138">:</span><span class="op" id="3922139">]</span><span class="op" id="3922140">,</span>&nbsp;<span class="ident" id="3922142">data</span><span class="op" id="3922146">[</span><span class="ident" id="3922147">fullBlocks</span><span class="op" id="3922157">:</span><span class="op" id="3922158">]</span><span class="op" id="3922159">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3922163">g</span><span class="op" id="3922164">.</span><span class="ident" id="3922165">updateBlocks</span><span class="op" id="3922177">(</span><span class="ident" id="3922178">y</span><span class="op" id="3922179">,</span>&nbsp;<span class="ident" id="3922181">partialBlock</span><span class="op" id="3922193">[</span><span class="op" id="3922194">:</span><span class="op" id="3922195">]</span><span class="op" id="3922196">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3922199">}</span><br>
<span class="lineno"></span><span class="op" id="3922201">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3922204">//&nbsp;gcmInc32&nbsp;treats&nbsp;the&nbsp;final&nbsp;four&nbsp;bytes&nbsp;of&nbsp;counterBlock&nbsp;as&nbsp;a&nbsp;big-endian&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="3922282">//&nbsp;and&nbsp;increments&nbsp;it.</span><br>
<span class="lineno">260</span><span class="keyword" id="3922304">func</span>&nbsp;<span class="ident" id="3922309">gcmInc32</span><span class="op" id="3922317">(</span><span class="ident" id="3922318">counterBlock</span>&nbsp;<span class="op" id="3922331">*</span><span class="op" id="3922332">[</span><span class="num" id="3922333">16</span><span class="op" id="3922335">]</span><span class="builtintype" id="3922336">byte</span><span class="op" id="3922340">)</span>&nbsp;<span class="op" id="3922342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3922345">for</span>&nbsp;<span class="ident" id="3922349">i</span>&nbsp;<span class="op" id="3922351">:=</span>&nbsp;<span class="ident" id="3922354">gcmBlockSize</span>&nbsp;<span class="op" id="3922367">-</span>&nbsp;<span class="num" id="3922369">1</span><span class="op" id="3922370">;</span>&nbsp;<span class="ident" id="3922372">i</span>&nbsp;<span class="op" id="3922374">&gt;=</span>&nbsp;<span class="ident" id="3922377">gcmBlockSize</span><span class="op" id="3922389">-</span><span class="num" id="3922390">4</span><span class="op" id="3922391">;</span>&nbsp;<span class="ident" id="3922393">i</span><span class="op" id="3922394">--</span>&nbsp;<span class="op" id="3922397">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3922401">counterBlock</span><span class="op" id="3922413">[</span><span class="ident" id="3922414">i</span><span class="op" id="3922415">]</span><span class="op" id="3922416">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3922421">if</span>&nbsp;<span class="ident" id="3922424">counterBlock</span><span class="op" id="3922436">[</span><span class="ident" id="3922437">i</span><span class="op" id="3922438">]</span>&nbsp;<span class="op" id="3922440">!=</span>&nbsp;<span class="num" id="3922443">0</span>&nbsp;<span class="op" id="3922445">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3922450">break</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3922458">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3922461">}</span><br>
<span class="lineno"></span><span class="op" id="3922463">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3922466">//&nbsp;sliceForAppend&nbsp;takes&nbsp;a&nbsp;slice&nbsp;and&nbsp;a&nbsp;requested&nbsp;number&nbsp;of&nbsp;bytes.&nbsp;It&nbsp;returns&nbsp;a</span><br>
<span class="lineno">270</span><span class="comment" id="3922544">//&nbsp;slice&nbsp;with&nbsp;the&nbsp;contents&nbsp;of&nbsp;the&nbsp;given&nbsp;slice&nbsp;followed&nbsp;by&nbsp;that&nbsp;many&nbsp;bytes&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3922624">//&nbsp;second&nbsp;slice&nbsp;that&nbsp;aliases&nbsp;into&nbsp;it&nbsp;and&nbsp;contains&nbsp;only&nbsp;the&nbsp;extra&nbsp;bytes.&nbsp;If&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3922703">//&nbsp;original&nbsp;slice&nbsp;has&nbsp;sufficient&nbsp;capacity&nbsp;then&nbsp;no&nbsp;allocation&nbsp;is&nbsp;performed.</span><br>
<span class="lineno"></span><span class="keyword" id="3922778">func</span>&nbsp;<span class="ident" id="3922783">sliceForAppend</span><span class="op" id="3922797">(</span><span class="ident" id="3922798">in</span>&nbsp;<span class="op" id="3922801">[</span><span class="op" id="3922802">]</span><span class="builtintype" id="3922803">byte</span><span class="op" id="3922807">,</span>&nbsp;<span class="ident" id="3922809">n</span>&nbsp;<span class="builtintype" id="3922811">int</span><span class="op" id="3922814">)</span>&nbsp;<span class="op" id="3922816">(</span><span class="ident" id="3922817">head</span><span class="op" id="3922821">,</span>&nbsp;<span class="ident" id="3922823">tail</span>&nbsp;<span class="op" id="3922828">[</span><span class="op" id="3922829">]</span><span class="builtintype" id="3922830">byte</span><span class="op" id="3922834">)</span>&nbsp;<span class="op" id="3922836">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3922839">if</span>&nbsp;<span class="ident" id="3922842">total</span>&nbsp;<span class="op" id="3922848">:=</span>&nbsp;<span class="builtinfunc" id="3922851">len</span><span class="op" id="3922854">(</span><span class="ident" id="3922855">in</span><span class="op" id="3922857">)</span>&nbsp;<span class="op" id="3922859">+</span>&nbsp;<span class="ident" id="3922861">n</span><span class="op" id="3922862">;</span>&nbsp;<span class="builtinfunc" id="3922864">cap</span><span class="op" id="3922867">(</span><span class="ident" id="3922868">in</span><span class="op" id="3922870">)</span>&nbsp;<span class="op" id="3922872">&gt;=</span>&nbsp;<span class="ident" id="3922875">total</span>&nbsp;<span class="op" id="3922881">{</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3922885">head</span>&nbsp;<span class="op" id="3922890">=</span>&nbsp;<span class="ident" id="3922892">in</span><span class="op" id="3922894">[</span><span class="op" id="3922895">:</span><span class="ident" id="3922896">total</span><span class="op" id="3922901">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3922904">}</span>&nbsp;<span class="keyword" id="3922906">else</span>&nbsp;<span class="op" id="3922911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3922915">head</span>&nbsp;<span class="op" id="3922920">=</span>&nbsp;<span class="builtinfunc" id="3922922">make</span><span class="op" id="3922926">(</span><span class="op" id="3922927">[</span><span class="op" id="3922928">]</span><span class="builtintype" id="3922929">byte</span><span class="op" id="3922933">,</span>&nbsp;<span class="ident" id="3922935">total</span><span class="op" id="3922940">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3922944">copy</span><span class="op" id="3922948">(</span><span class="ident" id="3922949">head</span><span class="op" id="3922953">,</span>&nbsp;<span class="ident" id="3922955">in</span><span class="op" id="3922957">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3922960">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3922963">tail</span>&nbsp;<span class="op" id="3922968">=</span>&nbsp;<span class="ident" id="3922970">head</span><span class="op" id="3922974">[</span><span class="builtinfunc" id="3922975">len</span><span class="op" id="3922978">(</span><span class="ident" id="3922979">in</span><span class="op" id="3922981">)</span><span class="op" id="3922982">:</span><span class="op" id="3922983">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3922986">return</span><br>
<span class="lineno"></span><span class="op" id="3922993">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3922996">//&nbsp;counterCrypt&nbsp;crypts&nbsp;in&nbsp;to&nbsp;out&nbsp;using&nbsp;g.cipher&nbsp;in&nbsp;counter&nbsp;mode.</span><br>
<span class="lineno">285</span><span class="keyword" id="3923061">func</span>&nbsp;<span class="op" id="3923066">(</span><span class="ident" id="3923067">g</span>&nbsp;<span class="op" id="3923069">*</span><span class="ident" id="3923070">gcm</span><span class="op" id="3923073">)</span>&nbsp;<span class="ident" id="3923075">counterCrypt</span><span class="op" id="3923087">(</span><span class="ident" id="3923088">out</span><span class="op" id="3923091">,</span>&nbsp;<span class="ident" id="3923093">in</span>&nbsp;<span class="op" id="3923096">[</span><span class="op" id="3923097">]</span><span class="builtintype" id="3923098">byte</span><span class="op" id="3923102">,</span>&nbsp;<span class="ident" id="3923104">counter</span>&nbsp;<span class="op" id="3923112">*</span><span class="op" id="3923113">[</span><span class="ident" id="3923114">gcmBlockSize</span><span class="op" id="3923126">]</span><span class="builtintype" id="3923127">byte</span><span class="op" id="3923131">)</span>&nbsp;<span class="op" id="3923133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3923136">var</span>&nbsp;<span class="ident" id="3923140">mask</span>&nbsp;<span class="op" id="3923145">[</span><span class="ident" id="3923146">gcmBlockSize</span><span class="op" id="3923158">]</span><span class="builtintype" id="3923159">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3923166">for</span>&nbsp;<span class="builtinfunc" id="3923170">len</span><span class="op" id="3923173">(</span><span class="ident" id="3923174">in</span><span class="op" id="3923176">)</span>&nbsp;<span class="op" id="3923178">&gt;=</span>&nbsp;<span class="ident" id="3923181">gcmBlockSize</span>&nbsp;<span class="op" id="3923194">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3923198">g</span><span class="op" id="3923199">.</span><span class="ident" id="3923200">cipher</span><span class="op" id="3923206">.</span><span class="ident" id="3923207">Encrypt</span><span class="op" id="3923214">(</span><span class="ident" id="3923215">mask</span><span class="op" id="3923219">[</span><span class="op" id="3923220">:</span><span class="op" id="3923221">]</span><span class="op" id="3923222">,</span>&nbsp;<span class="ident" id="3923224">counter</span><span class="op" id="3923231">[</span><span class="op" id="3923232">:</span><span class="op" id="3923233">]</span><span class="op" id="3923234">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3923238">gcmInc32</span><span class="op" id="3923246">(</span><span class="ident" id="3923247">counter</span><span class="op" id="3923254">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3923259">xorWords</span><span class="op" id="3923267">(</span><span class="ident" id="3923268">out</span><span class="op" id="3923271">,</span>&nbsp;<span class="ident" id="3923273">in</span><span class="op" id="3923275">,</span>&nbsp;<span class="ident" id="3923277">mask</span><span class="op" id="3923281">[</span><span class="op" id="3923282">:</span><span class="op" id="3923283">]</span><span class="op" id="3923284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3923288">out</span>&nbsp;<span class="op" id="3923292">=</span>&nbsp;<span class="ident" id="3923294">out</span><span class="op" id="3923297">[</span><span class="ident" id="3923298">gcmBlockSize</span><span class="op" id="3923310">:</span><span class="op" id="3923311">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3923315">in</span>&nbsp;<span class="op" id="3923318">=</span>&nbsp;<span class="ident" id="3923320">in</span><span class="op" id="3923322">[</span><span class="ident" id="3923323">gcmBlockSize</span><span class="op" id="3923335">:</span><span class="op" id="3923336">]</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3923339">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3923343">if</span>&nbsp;<span class="builtinfunc" id="3923346">len</span><span class="op" id="3923349">(</span><span class="ident" id="3923350">in</span><span class="op" id="3923352">)</span>&nbsp;<span class="op" id="3923354">&gt;</span>&nbsp;<span class="num" id="3923356">0</span>&nbsp;<span class="op" id="3923358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3923362">g</span><span class="op" id="3923363">.</span><span class="ident" id="3923364">cipher</span><span class="op" id="3923370">.</span><span class="ident" id="3923371">Encrypt</span><span class="op" id="3923378">(</span><span class="ident" id="3923379">mask</span><span class="op" id="3923383">[</span><span class="op" id="3923384">:</span><span class="op" id="3923385">]</span><span class="op" id="3923386">,</span>&nbsp;<span class="ident" id="3923388">counter</span><span class="op" id="3923395">[</span><span class="op" id="3923396">:</span><span class="op" id="3923397">]</span><span class="op" id="3923398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3923402">gcmInc32</span><span class="op" id="3923410">(</span><span class="ident" id="3923411">counter</span><span class="op" id="3923418">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3923422">xorBytes</span><span class="op" id="3923430">(</span><span class="ident" id="3923431">out</span><span class="op" id="3923434">,</span>&nbsp;<span class="ident" id="3923436">in</span><span class="op" id="3923438">,</span>&nbsp;<span class="ident" id="3923440">mask</span><span class="op" id="3923444">[</span><span class="op" id="3923445">:</span><span class="op" id="3923446">]</span><span class="op" id="3923447">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3923450">}</span><br>
<span class="lineno"></span><span class="op" id="3923452">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3923455">//&nbsp;auth&nbsp;calculates&nbsp;GHASH(ciphertext,&nbsp;additionalData),&nbsp;masks&nbsp;the&nbsp;result&nbsp;with</span><br>
<span class="lineno">305</span><span class="comment" id="3923531">//&nbsp;tagMask&nbsp;and&nbsp;writes&nbsp;the&nbsp;result&nbsp;to&nbsp;out.</span><br>
<span class="lineno"></span><span class="keyword" id="3923572">func</span>&nbsp;<span class="op" id="3923577">(</span><span class="ident" id="3923578">g</span>&nbsp;<span class="op" id="3923580">*</span><span class="ident" id="3923581">gcm</span><span class="op" id="3923584">)</span>&nbsp;<span class="ident" id="3923586">auth</span><span class="op" id="3923590">(</span><span class="ident" id="3923591">out</span><span class="op" id="3923594">,</span>&nbsp;<span class="ident" id="3923596">ciphertext</span><span class="op" id="3923606">,</span>&nbsp;<span class="ident" id="3923608">additionalData</span>&nbsp;<span class="op" id="3923623">[</span><span class="op" id="3923624">]</span><span class="builtintype" id="3923625">byte</span><span class="op" id="3923629">,</span>&nbsp;<span class="ident" id="3923631">tagMask</span>&nbsp;<span class="op" id="3923639">*</span><span class="op" id="3923640">[</span><span class="ident" id="3923641">gcmTagSize</span><span class="op" id="3923651">]</span><span class="builtintype" id="3923652">byte</span><span class="op" id="3923656">)</span>&nbsp;<span class="op" id="3923658">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3923661">var</span>&nbsp;<span class="ident" id="3923665">y</span>&nbsp;<span class="ident" id="3923667">gcmFieldElement</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3923684">g</span><span class="op" id="3923685">.</span><span class="ident" id="3923686">update</span><span class="op" id="3923692">(</span><span class="op" id="3923693">&amp;</span><span class="ident" id="3923694">y</span><span class="op" id="3923695">,</span>&nbsp;<span class="ident" id="3923697">additionalData</span><span class="op" id="3923711">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3923714">g</span><span class="op" id="3923715">.</span><span class="ident" id="3923716">update</span><span class="op" id="3923722">(</span><span class="op" id="3923723">&amp;</span><span class="ident" id="3923724">y</span><span class="op" id="3923725">,</span>&nbsp;<span class="ident" id="3923727">ciphertext</span><span class="op" id="3923737">)</span><br>
<span class="lineno">310</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3923741">y</span><span class="op" id="3923742">.</span><span class="ident" id="3923743">low</span>&nbsp;<span class="op" id="3923747">^=</span>&nbsp;<span class="ident" id="3923750">uint64</span><span class="op" id="3923756">(</span><span class="builtinfunc" id="3923757">len</span><span class="op" id="3923760">(</span><span class="ident" id="3923761">additionalData</span><span class="op" id="3923775">)</span><span class="op" id="3923776">)</span>&nbsp;<span class="op" id="3923778">*</span>&nbsp;<span class="num" id="3923780">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3923783">y</span><span class="op" id="3923784">.</span><span class="ident" id="3923785">high</span>&nbsp;<span class="op" id="3923790">^=</span>&nbsp;<span class="ident" id="3923793">uint64</span><span class="op" id="3923799">(</span><span class="builtinfunc" id="3923800">len</span><span class="op" id="3923803">(</span><span class="ident" id="3923804">ciphertext</span><span class="op" id="3923814">)</span><span class="op" id="3923815">)</span>&nbsp;<span class="op" id="3923817">*</span>&nbsp;<span class="num" id="3923819">8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3923823">g</span><span class="op" id="3923824">.</span><span class="ident" id="3923825">mul</span><span class="op" id="3923828">(</span><span class="op" id="3923829">&amp;</span><span class="ident" id="3923830">y</span><span class="op" id="3923831">)</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3923835">putUint64</span><span class="op" id="3923844">(</span><span class="ident" id="3923845">out</span><span class="op" id="3923848">,</span>&nbsp;<span class="ident" id="3923850">y</span><span class="op" id="3923851">.</span><span class="ident" id="3923852">low</span><span class="op" id="3923855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3923858">putUint64</span><span class="op" id="3923867">(</span><span class="ident" id="3923868">out</span><span class="op" id="3923871">[</span><span class="num" id="3923872">8</span><span class="op" id="3923873">:</span><span class="op" id="3923874">]</span><span class="op" id="3923875">,</span>&nbsp;<span class="ident" id="3923877">y</span><span class="op" id="3923878">.</span><span class="ident" id="3923879">high</span><span class="op" id="3923883">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3923887">xorWords</span><span class="op" id="3923895">(</span><span class="ident" id="3923896">out</span><span class="op" id="3923899">,</span>&nbsp;<span class="ident" id="3923901">out</span><span class="op" id="3923904">,</span>&nbsp;<span class="ident" id="3923906">tagMask</span><span class="op" id="3923913">[</span><span class="op" id="3923914">:</span><span class="op" id="3923915">]</span><span class="op" id="3923916">)</span><br>
<span class="lineno">320</span><span class="op" id="3923918">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3923921">func</span>&nbsp;<span class="ident" id="3923926">getUint64</span><span class="op" id="3923935">(</span><span class="ident" id="3923936">data</span>&nbsp;<span class="op" id="3923941">[</span><span class="op" id="3923942">]</span><span class="builtintype" id="3923943">byte</span><span class="op" id="3923947">)</span>&nbsp;<span class="ident" id="3923949">uint64</span>&nbsp;<span class="op" id="3923956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3923959">r</span>&nbsp;<span class="op" id="3923961">:=</span>&nbsp;<span class="ident" id="3923964">uint64</span><span class="op" id="3923970">(</span><span class="ident" id="3923971">data</span><span class="op" id="3923975">[</span><span class="num" id="3923976">0</span><span class="op" id="3923977">]</span><span class="op" id="3923978">)</span><span class="op" id="3923979">&lt;&lt;</span><span class="num" id="3923981">56</span>&nbsp;<span class="op" id="3923984">|</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3923988">uint64</span><span class="op" id="3923994">(</span><span class="ident" id="3923995">data</span><span class="op" id="3923999">[</span><span class="num" id="3924000">1</span><span class="op" id="3924001">]</span><span class="op" id="3924002">)</span><span class="op" id="3924003">&lt;&lt;</span><span class="num" id="3924005">48</span>&nbsp;<span class="op" id="3924008">|</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3924012">uint64</span><span class="op" id="3924018">(</span><span class="ident" id="3924019">data</span><span class="op" id="3924023">[</span><span class="num" id="3924024">2</span><span class="op" id="3924025">]</span><span class="op" id="3924026">)</span><span class="op" id="3924027">&lt;&lt;</span><span class="num" id="3924029">40</span>&nbsp;<span class="op" id="3924032">|</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3924036">uint64</span><span class="op" id="3924042">(</span><span class="ident" id="3924043">data</span><span class="op" id="3924047">[</span><span class="num" id="3924048">3</span><span class="op" id="3924049">]</span><span class="op" id="3924050">)</span><span class="op" id="3924051">&lt;&lt;</span><span class="num" id="3924053">32</span>&nbsp;<span class="op" id="3924056">|</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3924060">uint64</span><span class="op" id="3924066">(</span><span class="ident" id="3924067">data</span><span class="op" id="3924071">[</span><span class="num" id="3924072">4</span><span class="op" id="3924073">]</span><span class="op" id="3924074">)</span><span class="op" id="3924075">&lt;&lt;</span><span class="num" id="3924077">24</span>&nbsp;<span class="op" id="3924080">|</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3924084">uint64</span><span class="op" id="3924090">(</span><span class="ident" id="3924091">data</span><span class="op" id="3924095">[</span><span class="num" id="3924096">5</span><span class="op" id="3924097">]</span><span class="op" id="3924098">)</span><span class="op" id="3924099">&lt;&lt;</span><span class="num" id="3924101">16</span>&nbsp;<span class="op" id="3924104">|</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3924108">uint64</span><span class="op" id="3924114">(</span><span class="ident" id="3924115">data</span><span class="op" id="3924119">[</span><span class="num" id="3924120">6</span><span class="op" id="3924121">]</span><span class="op" id="3924122">)</span><span class="op" id="3924123">&lt;&lt;</span><span class="num" id="3924125">8</span>&nbsp;<span class="op" id="3924127">|</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3924131">uint64</span><span class="op" id="3924137">(</span><span class="ident" id="3924138">data</span><span class="op" id="3924142">[</span><span class="num" id="3924143">7</span><span class="op" id="3924144">]</span><span class="op" id="3924145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3924148">return</span>&nbsp;<span class="ident" id="3924155">r</span><br>
<span class="lineno"></span><span class="op" id="3924157">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3924160">func</span>&nbsp;<span class="ident" id="3924165">putUint64</span><span class="op" id="3924174">(</span><span class="ident" id="3924175">out</span>&nbsp;<span class="op" id="3924179">[</span><span class="op" id="3924180">]</span><span class="builtintype" id="3924181">byte</span><span class="op" id="3924185">,</span>&nbsp;<span class="ident" id="3924187">v</span>&nbsp;<span class="ident" id="3924189">uint64</span><span class="op" id="3924195">)</span>&nbsp;<span class="op" id="3924197">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3924200">out</span><span class="op" id="3924203">[</span><span class="num" id="3924204">0</span><span class="op" id="3924205">]</span>&nbsp;<span class="op" id="3924207">=</span>&nbsp;<span class="builtintype" id="3924209">byte</span><span class="op" id="3924213">(</span><span class="ident" id="3924214">v</span>&nbsp;<span class="op" id="3924216">&gt;&gt;</span>&nbsp;<span class="num" id="3924219">56</span><span class="op" id="3924221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3924224">out</span><span class="op" id="3924227">[</span><span class="num" id="3924228">1</span><span class="op" id="3924229">]</span>&nbsp;<span class="op" id="3924231">=</span>&nbsp;<span class="builtintype" id="3924233">byte</span><span class="op" id="3924237">(</span><span class="ident" id="3924238">v</span>&nbsp;<span class="op" id="3924240">&gt;&gt;</span>&nbsp;<span class="num" id="3924243">48</span><span class="op" id="3924245">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3924248">out</span><span class="op" id="3924251">[</span><span class="num" id="3924252">2</span><span class="op" id="3924253">]</span>&nbsp;<span class="op" id="3924255">=</span>&nbsp;<span class="builtintype" id="3924257">byte</span><span class="op" id="3924261">(</span><span class="ident" id="3924262">v</span>&nbsp;<span class="op" id="3924264">&gt;&gt;</span>&nbsp;<span class="num" id="3924267">40</span><span class="op" id="3924269">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3924272">out</span><span class="op" id="3924275">[</span><span class="num" id="3924276">3</span><span class="op" id="3924277">]</span>&nbsp;<span class="op" id="3924279">=</span>&nbsp;<span class="builtintype" id="3924281">byte</span><span class="op" id="3924285">(</span><span class="ident" id="3924286">v</span>&nbsp;<span class="op" id="3924288">&gt;&gt;</span>&nbsp;<span class="num" id="3924291">32</span><span class="op" id="3924293">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3924296">out</span><span class="op" id="3924299">[</span><span class="num" id="3924300">4</span><span class="op" id="3924301">]</span>&nbsp;<span class="op" id="3924303">=</span>&nbsp;<span class="builtintype" id="3924305">byte</span><span class="op" id="3924309">(</span><span class="ident" id="3924310">v</span>&nbsp;<span class="op" id="3924312">&gt;&gt;</span>&nbsp;<span class="num" id="3924315">24</span><span class="op" id="3924317">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3924320">out</span><span class="op" id="3924323">[</span><span class="num" id="3924324">5</span><span class="op" id="3924325">]</span>&nbsp;<span class="op" id="3924327">=</span>&nbsp;<span class="builtintype" id="3924329">byte</span><span class="op" id="3924333">(</span><span class="ident" id="3924334">v</span>&nbsp;<span class="op" id="3924336">&gt;&gt;</span>&nbsp;<span class="num" id="3924339">16</span><span class="op" id="3924341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3924344">out</span><span class="op" id="3924347">[</span><span class="num" id="3924348">6</span><span class="op" id="3924349">]</span>&nbsp;<span class="op" id="3924351">=</span>&nbsp;<span class="builtintype" id="3924353">byte</span><span class="op" id="3924357">(</span><span class="ident" id="3924358">v</span>&nbsp;<span class="op" id="3924360">&gt;&gt;</span>&nbsp;<span class="num" id="3924363">8</span><span class="op" id="3924364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3924367">out</span><span class="op" id="3924370">[</span><span class="num" id="3924371">7</span><span class="op" id="3924372">]</span>&nbsp;<span class="op" id="3924374">=</span>&nbsp;<span class="builtintype" id="3924376">byte</span><span class="op" id="3924380">(</span><span class="ident" id="3924381">v</span><span class="op" id="3924382">)</span><br>
<span class="lineno"></span><span class="op" id="3924384">}</span>
</div>
</body>
</html>
