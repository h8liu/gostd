<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/tls</h2>
<ul>
<li><a href="/gostd/crypto/tls/alert.go.html">alert.go</a></li>
<li><a href="/gostd/crypto/tls/cipher_suites.go.html">cipher_suites.go</a></li>
<li><a href="/gostd/crypto/tls/common.go.html">common.go</a></li>
<li><a href="/gostd/crypto/tls/conn.go.html">conn.go</a></li>
<li><a href="/gostd/crypto/tls/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/crypto/tls/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client.go.html">handshake_client.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client_test.go.html">handshake_client_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages.go.html">handshake_messages.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages_test.go.html">handshake_messages_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server.go.html">handshake_server.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server_test.go.html">handshake_server_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_test.go.html">handshake_test.go</a></li>
<li><a href="/gostd/crypto/tls/key_agreement.go.html">key_agreement.go</a></li>
<li><a href="/gostd/crypto/tls/prf.go.html">prf.go</a></li>
<li><a href="/gostd/crypto/tls/prf_test.go.html">prf_test.go</a></li>
<li><a href="/gostd/crypto/tls/ticket.go.html">ticket.go</a></li>
<li><a href="/gostd/crypto/tls/tls.go.html">tls.go</a></li>
<li><a href="/gostd/crypto/tls/tls_test.go.html">tls_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4511338">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4511393">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4511447">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4511498">package</span>&nbsp;<span class="ident" id="4511506">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4511511">import</span>&nbsp;<span class="op" id="4511518">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4511521">&#34;crypto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4511531">&#34;crypto/ecdsa&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4511547">&#34;crypto/rsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4511561">&#34;crypto/subtle&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4511578">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4511593">&#34;encoding/asn1&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4511610">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4511620">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4511627">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="4511632">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4511635">//&nbsp;serverHandshakeState&nbsp;contains&nbsp;details&nbsp;of&nbsp;a&nbsp;server&nbsp;handshake&nbsp;in&nbsp;progress.</span><br>
<span class="lineno">20</span><span class="comment" id="4511711">//&nbsp;It&#39;s&nbsp;discarded&nbsp;once&nbsp;the&nbsp;handshake&nbsp;has&nbsp;completed.</span><br>
<span class="lineno"></span><span class="keyword" id="4511763">type</span>&nbsp;<span class="ident" id="4511768">serverHandshakeState</span>&nbsp;<span class="keyword" id="4511789">struct</span>&nbsp;<span class="op" id="4511796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4511799">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4511815">*</span><span class="ident" id="4511816">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4511822">clientHello</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4511838">*</span><span class="ident" id="4511839">clientHelloMsg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4511855">hello</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4511871">*</span><span class="ident" id="4511872">serverHelloMsg</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4511888">suite</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4511904">*</span><span class="ident" id="4511905">cipherSuite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4511918">ellipticOk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4511934">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4511940">ecdsaOk</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4511956">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4511962">sessionState</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4511978">*</span><span class="ident" id="4511979">sessionState</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4511993">finishedHash</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4512009">finishedHash</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4512023">masterSecret</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4512039">[</span><span class="op" id="4512040">]</span><span class="builtintype" id="4512041">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4512047">certsFromClient</span>&nbsp;<span class="op" id="4512063">[</span><span class="op" id="4512064">]</span><span class="op" id="4512065">[</span><span class="op" id="4512066">]</span><span class="builtintype" id="4512067">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4512073">cert</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4512089">*</span><span class="ident" id="4512090">Certificate</span><br>
<span class="lineno"></span><span class="op" id="4512102">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="comment" id="4512105">//&nbsp;serverHandshake&nbsp;performs&nbsp;a&nbsp;TLS&nbsp;handshake&nbsp;as&nbsp;a&nbsp;server.</span><br>
<span class="lineno"></span><span class="keyword" id="4512162">func</span>&nbsp;<span class="op" id="4512167">(</span><span class="ident" id="4512168">c</span>&nbsp;<span class="op" id="4512170">*</span><span class="ident" id="4512171">Conn</span><span class="op" id="4512175">)</span>&nbsp;<span class="ident" id="4512177">serverHandshake</span><span class="op" id="4512192">(</span><span class="op" id="4512193">)</span>&nbsp;<span class="builtintype" id="4512195">error</span>&nbsp;<span class="op" id="4512201">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4512204">config</span>&nbsp;<span class="op" id="4512211">:=</span>&nbsp;<span class="ident" id="4512214">c</span><span class="op" id="4512215">.</span><span class="ident" id="4512216">config</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4512225">//&nbsp;If&nbsp;this&nbsp;is&nbsp;the&nbsp;first&nbsp;server&nbsp;handshake,&nbsp;we&nbsp;generate&nbsp;a&nbsp;random&nbsp;key&nbsp;to</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4512296">//&nbsp;encrypt&nbsp;the&nbsp;tickets&nbsp;with.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4512326">config</span><span class="op" id="4512332">.</span><span class="ident" id="4512333">serverInitOnce</span><span class="op" id="4512347">.</span><span class="ident" id="4512348">Do</span><span class="op" id="4512350">(</span><span class="ident" id="4512351">config</span><span class="op" id="4512357">.</span><span class="ident" id="4512358">serverInit</span><span class="op" id="4512368">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4512372">hs</span>&nbsp;<span class="op" id="4512375">:=</span>&nbsp;<span class="ident" id="4512378">serverHandshakeState</span><span class="op" id="4512398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4512402">c</span><span class="op" id="4512403">:</span>&nbsp;<span class="ident" id="4512405">c</span><span class="op" id="4512406">,</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4512409">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4512412">isResume</span><span class="op" id="4512420">,</span>&nbsp;<span class="ident" id="4512422">err</span>&nbsp;<span class="op" id="4512426">:=</span>&nbsp;<span class="ident" id="4512429">hs</span><span class="op" id="4512431">.</span><span class="ident" id="4512432">readClientHello</span><span class="op" id="4512447">(</span><span class="op" id="4512448">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4512451">if</span>&nbsp;<span class="ident" id="4512454">err</span>&nbsp;<span class="op" id="4512458">!=</span>&nbsp;<span class="ident" id="4512461">nil</span>&nbsp;<span class="op" id="4512465">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4512469">return</span>&nbsp;<span class="ident" id="4512476">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4512481">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4512485">//&nbsp;For&nbsp;an&nbsp;overview&nbsp;of&nbsp;TLS&nbsp;handshaking,&nbsp;see&nbsp;https://tools.ietf.org/html/rfc5246#section-7.3</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4512577">if</span>&nbsp;<span class="ident" id="4512580">isResume</span>&nbsp;<span class="op" id="4512589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4512593">//&nbsp;The&nbsp;client&nbsp;has&nbsp;included&nbsp;a&nbsp;session&nbsp;ticket&nbsp;and&nbsp;so&nbsp;we&nbsp;do&nbsp;an&nbsp;abbreviated&nbsp;handshake.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4512678">if</span>&nbsp;<span class="ident" id="4512681">err</span>&nbsp;<span class="op" id="4512685">:=</span>&nbsp;<span class="ident" id="4512688">hs</span><span class="op" id="4512690">.</span><span class="ident" id="4512691">doResumeHandshake</span><span class="op" id="4512708">(</span><span class="op" id="4512709">)</span><span class="op" id="4512710">;</span>&nbsp;<span class="ident" id="4512712">err</span>&nbsp;<span class="op" id="4512716">!=</span>&nbsp;<span class="ident" id="4512719">nil</span>&nbsp;<span class="op" id="4512723">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4512728">return</span>&nbsp;<span class="ident" id="4512735">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4512741">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4512745">if</span>&nbsp;<span class="ident" id="4512748">err</span>&nbsp;<span class="op" id="4512752">:=</span>&nbsp;<span class="ident" id="4512755">hs</span><span class="op" id="4512757">.</span><span class="ident" id="4512758">establishKeys</span><span class="op" id="4512771">(</span><span class="op" id="4512772">)</span><span class="op" id="4512773">;</span>&nbsp;<span class="ident" id="4512775">err</span>&nbsp;<span class="op" id="4512779">!=</span>&nbsp;<span class="ident" id="4512782">nil</span>&nbsp;<span class="op" id="4512786">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4512791">return</span>&nbsp;<span class="ident" id="4512798">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4512804">}</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4512808">if</span>&nbsp;<span class="ident" id="4512811">err</span>&nbsp;<span class="op" id="4512815">:=</span>&nbsp;<span class="ident" id="4512818">hs</span><span class="op" id="4512820">.</span><span class="ident" id="4512821">sendFinished</span><span class="op" id="4512833">(</span><span class="ident" id="4512834">c</span><span class="op" id="4512835">.</span><span class="ident" id="4512836">firstFinished</span><span class="op" id="4512849">[</span><span class="op" id="4512850">:</span><span class="op" id="4512851">]</span><span class="op" id="4512852">)</span><span class="op" id="4512853">;</span>&nbsp;<span class="ident" id="4512855">err</span>&nbsp;<span class="op" id="4512859">!=</span>&nbsp;<span class="ident" id="4512862">nil</span>&nbsp;<span class="op" id="4512866">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4512871">return</span>&nbsp;<span class="ident" id="4512878">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4512884">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4512888">if</span>&nbsp;<span class="ident" id="4512891">err</span>&nbsp;<span class="op" id="4512895">:=</span>&nbsp;<span class="ident" id="4512898">hs</span><span class="op" id="4512900">.</span><span class="ident" id="4512901">readFinished</span><span class="op" id="4512913">(</span><span class="ident" id="4512914">nil</span><span class="op" id="4512917">)</span><span class="op" id="4512918">;</span>&nbsp;<span class="ident" id="4512920">err</span>&nbsp;<span class="op" id="4512924">!=</span>&nbsp;<span class="ident" id="4512927">nil</span>&nbsp;<span class="op" id="4512931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4512936">return</span>&nbsp;<span class="ident" id="4512943">err</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4512949">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4512953">c</span><span class="op" id="4512954">.</span><span class="ident" id="4512955">didResume</span>&nbsp;<span class="op" id="4512965">=</span>&nbsp;<span class="builtintype" id="4512967">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4512973">}</span>&nbsp;<span class="keyword" id="4512975">else</span>&nbsp;<span class="op" id="4512980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4512984">//&nbsp;The&nbsp;client&nbsp;didn&#39;t&nbsp;include&nbsp;a&nbsp;session&nbsp;ticket,&nbsp;or&nbsp;it&nbsp;wasn&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4513046">//&nbsp;valid&nbsp;so&nbsp;we&nbsp;do&nbsp;a&nbsp;full&nbsp;handshake.</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4513084">if</span>&nbsp;<span class="ident" id="4513087">err</span>&nbsp;<span class="op" id="4513091">:=</span>&nbsp;<span class="ident" id="4513094">hs</span><span class="op" id="4513096">.</span><span class="ident" id="4513097">doFullHandshake</span><span class="op" id="4513112">(</span><span class="op" id="4513113">)</span><span class="op" id="4513114">;</span>&nbsp;<span class="ident" id="4513116">err</span>&nbsp;<span class="op" id="4513120">!=</span>&nbsp;<span class="ident" id="4513123">nil</span>&nbsp;<span class="op" id="4513127">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4513132">return</span>&nbsp;<span class="ident" id="4513139">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4513145">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4513149">if</span>&nbsp;<span class="ident" id="4513152">err</span>&nbsp;<span class="op" id="4513156">:=</span>&nbsp;<span class="ident" id="4513159">hs</span><span class="op" id="4513161">.</span><span class="ident" id="4513162">establishKeys</span><span class="op" id="4513175">(</span><span class="op" id="4513176">)</span><span class="op" id="4513177">;</span>&nbsp;<span class="ident" id="4513179">err</span>&nbsp;<span class="op" id="4513183">!=</span>&nbsp;<span class="ident" id="4513186">nil</span>&nbsp;<span class="op" id="4513190">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4513195">return</span>&nbsp;<span class="ident" id="4513202">err</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4513208">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4513212">if</span>&nbsp;<span class="ident" id="4513215">err</span>&nbsp;<span class="op" id="4513219">:=</span>&nbsp;<span class="ident" id="4513222">hs</span><span class="op" id="4513224">.</span><span class="ident" id="4513225">readFinished</span><span class="op" id="4513237">(</span><span class="ident" id="4513238">c</span><span class="op" id="4513239">.</span><span class="ident" id="4513240">firstFinished</span><span class="op" id="4513253">[</span><span class="op" id="4513254">:</span><span class="op" id="4513255">]</span><span class="op" id="4513256">)</span><span class="op" id="4513257">;</span>&nbsp;<span class="ident" id="4513259">err</span>&nbsp;<span class="op" id="4513263">!=</span>&nbsp;<span class="ident" id="4513266">nil</span>&nbsp;<span class="op" id="4513270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4513275">return</span>&nbsp;<span class="ident" id="4513282">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4513288">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4513292">if</span>&nbsp;<span class="ident" id="4513295">err</span>&nbsp;<span class="op" id="4513299">:=</span>&nbsp;<span class="ident" id="4513302">hs</span><span class="op" id="4513304">.</span><span class="ident" id="4513305">sendSessionTicket</span><span class="op" id="4513322">(</span><span class="op" id="4513323">)</span><span class="op" id="4513324">;</span>&nbsp;<span class="ident" id="4513326">err</span>&nbsp;<span class="op" id="4513330">!=</span>&nbsp;<span class="ident" id="4513333">nil</span>&nbsp;<span class="op" id="4513337">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4513342">return</span>&nbsp;<span class="ident" id="4513349">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4513355">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4513359">if</span>&nbsp;<span class="ident" id="4513362">err</span>&nbsp;<span class="op" id="4513366">:=</span>&nbsp;<span class="ident" id="4513369">hs</span><span class="op" id="4513371">.</span><span class="ident" id="4513372">sendFinished</span><span class="op" id="4513384">(</span><span class="ident" id="4513385">nil</span><span class="op" id="4513388">)</span><span class="op" id="4513389">;</span>&nbsp;<span class="ident" id="4513391">err</span>&nbsp;<span class="op" id="4513395">!=</span>&nbsp;<span class="ident" id="4513398">nil</span>&nbsp;<span class="op" id="4513402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4513407">return</span>&nbsp;<span class="ident" id="4513414">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4513420">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4513423">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4513426">c</span><span class="op" id="4513427">.</span><span class="ident" id="4513428">handshakeComplete</span>&nbsp;<span class="op" id="4513446">=</span>&nbsp;<span class="builtintype" id="4513448">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4513455">return</span>&nbsp;<span class="ident" id="4513462">nil</span><br>
<span class="lineno"></span><span class="op" id="4513466">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span><span class="comment" id="4513469">//&nbsp;readClientHello&nbsp;reads&nbsp;a&nbsp;ClientHello&nbsp;message&nbsp;from&nbsp;the&nbsp;client&nbsp;and&nbsp;decides</span><br>
<span class="lineno"></span><span class="comment" id="4513544">//&nbsp;whether&nbsp;we&nbsp;will&nbsp;perform&nbsp;session&nbsp;resumption.</span><br>
<span class="lineno"></span><span class="keyword" id="4513591">func</span>&nbsp;<span class="op" id="4513596">(</span><span class="ident" id="4513597">hs</span>&nbsp;<span class="op" id="4513600">*</span><span class="ident" id="4513601">serverHandshakeState</span><span class="op" id="4513621">)</span>&nbsp;<span class="ident" id="4513623">readClientHello</span><span class="op" id="4513638">(</span><span class="op" id="4513639">)</span>&nbsp;<span class="op" id="4513641">(</span><span class="ident" id="4513642">isResume</span>&nbsp;<span class="builtintype" id="4513651">bool</span><span class="op" id="4513655">,</span>&nbsp;<span class="ident" id="4513657">err</span>&nbsp;<span class="builtintype" id="4513661">error</span><span class="op" id="4513666">)</span>&nbsp;<span class="op" id="4513668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4513671">config</span>&nbsp;<span class="op" id="4513678">:=</span>&nbsp;<span class="ident" id="4513681">hs</span><span class="op" id="4513683">.</span><span class="ident" id="4513684">c</span><span class="op" id="4513685">.</span><span class="ident" id="4513686">config</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4513694">c</span>&nbsp;<span class="op" id="4513696">:=</span>&nbsp;<span class="ident" id="4513699">hs</span><span class="op" id="4513701">.</span><span class="ident" id="4513702">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4513706">msg</span><span class="op" id="4513709">,</span>&nbsp;<span class="ident" id="4513711">err</span>&nbsp;<span class="op" id="4513715">:=</span>&nbsp;<span class="ident" id="4513718">c</span><span class="op" id="4513719">.</span><span class="ident" id="4513720">readHandshake</span><span class="op" id="4513733">(</span><span class="op" id="4513734">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4513737">if</span>&nbsp;<span class="ident" id="4513740">err</span>&nbsp;<span class="op" id="4513744">!=</span>&nbsp;<span class="ident" id="4513747">nil</span>&nbsp;<span class="op" id="4513751">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4513755">return</span>&nbsp;<span class="builtintype" id="4513762">false</span><span class="op" id="4513767">,</span>&nbsp;<span class="ident" id="4513769">err</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4513774">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4513777">var</span>&nbsp;<span class="ident" id="4513781">ok</span>&nbsp;<span class="builtintype" id="4513784">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4513790">hs</span><span class="op" id="4513792">.</span><span class="ident" id="4513793">clientHello</span><span class="op" id="4513804">,</span>&nbsp;<span class="ident" id="4513806">ok</span>&nbsp;<span class="op" id="4513809">=</span>&nbsp;<span class="ident" id="4513811">msg</span><span class="op" id="4513814">.</span><span class="op" id="4513815">(</span><span class="op" id="4513816">*</span><span class="ident" id="4513817">clientHelloMsg</span><span class="op" id="4513831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4513834">if</span>&nbsp;<span class="op" id="4513837">!</span><span class="ident" id="4513838">ok</span>&nbsp;<span class="op" id="4513841">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4513845">c</span><span class="op" id="4513846">.</span><span class="ident" id="4513847">sendAlert</span><span class="op" id="4513856">(</span><span class="ident" id="4513857">alertUnexpectedMessage</span><span class="op" id="4513879">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4513883">return</span>&nbsp;<span class="builtintype" id="4513890">false</span><span class="op" id="4513895">,</span>&nbsp;<span class="ident" id="4513897">unexpectedMessageError</span><span class="op" id="4513919">(</span><span class="ident" id="4513920">hs</span><span class="op" id="4513922">.</span><span class="ident" id="4513923">clientHello</span><span class="op" id="4513934">,</span>&nbsp;<span class="ident" id="4513936">msg</span><span class="op" id="4513939">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4513942">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4513945">c</span><span class="op" id="4513946">.</span><span class="ident" id="4513947">vers</span><span class="op" id="4513951">,</span>&nbsp;<span class="ident" id="4513953">ok</span>&nbsp;<span class="op" id="4513956">=</span>&nbsp;<span class="ident" id="4513958">config</span><span class="op" id="4513964">.</span><span class="ident" id="4513965">mutualVersion</span><span class="op" id="4513978">(</span><span class="ident" id="4513979">hs</span><span class="op" id="4513981">.</span><span class="ident" id="4513982">clientHello</span><span class="op" id="4513993">.</span><span class="ident" id="4513994">vers</span><span class="op" id="4513998">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4514001">if</span>&nbsp;<span class="op" id="4514004">!</span><span class="ident" id="4514005">ok</span>&nbsp;<span class="op" id="4514008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4514012">c</span><span class="op" id="4514013">.</span><span class="ident" id="4514014">sendAlert</span><span class="op" id="4514023">(</span><span class="ident" id="4514024">alertProtocolVersion</span><span class="op" id="4514044">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4514048">return</span>&nbsp;<span class="builtintype" id="4514055">false</span><span class="op" id="4514060">,</span>&nbsp;<span class="ident" id="4514062">fmt</span><span class="op" id="4514065">.</span><span class="ident" id="4514066">Errorf</span><span class="op" id="4514072">(</span><span class="string" id="4514073">&#34;tls:&nbsp;client&nbsp;offered&nbsp;an&nbsp;unsupported,&nbsp;maximum&nbsp;protocol&nbsp;version&nbsp;of&nbsp;%x&#34;</span><span class="op" id="4514141">,</span>&nbsp;<span class="ident" id="4514143">hs</span><span class="op" id="4514145">.</span><span class="ident" id="4514146">clientHello</span><span class="op" id="4514157">.</span><span class="ident" id="4514158">vers</span><span class="op" id="4514162">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4514165">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4514168">c</span><span class="op" id="4514169">.</span><span class="ident" id="4514170">haveVers</span>&nbsp;<span class="op" id="4514179">=</span>&nbsp;<span class="builtintype" id="4514181">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4514188">hs</span><span class="op" id="4514190">.</span><span class="ident" id="4514191">finishedHash</span>&nbsp;<span class="op" id="4514204">=</span>&nbsp;<span class="ident" id="4514206">newFinishedHash</span><span class="op" id="4514221">(</span><span class="ident" id="4514222">c</span><span class="op" id="4514223">.</span><span class="ident" id="4514224">vers</span><span class="op" id="4514228">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4514231">hs</span><span class="op" id="4514233">.</span><span class="ident" id="4514234">finishedHash</span><span class="op" id="4514246">.</span><span class="ident" id="4514247">Write</span><span class="op" id="4514252">(</span><span class="ident" id="4514253">hs</span><span class="op" id="4514255">.</span><span class="ident" id="4514256">clientHello</span><span class="op" id="4514267">.</span><span class="ident" id="4514268">marshal</span><span class="op" id="4514275">(</span><span class="op" id="4514276">)</span><span class="op" id="4514277">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4514281">hs</span><span class="op" id="4514283">.</span><span class="ident" id="4514284">hello</span>&nbsp;<span class="op" id="4514290">=</span>&nbsp;<span class="builtinfunc" id="4514292">new</span><span class="op" id="4514295">(</span><span class="ident" id="4514296">serverHelloMsg</span><span class="op" id="4514310">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4514314">supportedCurve</span>&nbsp;<span class="op" id="4514329">:=</span>&nbsp;<span class="builtintype" id="4514332">false</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4514339">preferredCurves</span>&nbsp;<span class="op" id="4514355">:=</span>&nbsp;<span class="ident" id="4514358">config</span><span class="op" id="4514364">.</span><span class="ident" id="4514365">curvePreferences</span><span class="op" id="4514381">(</span><span class="op" id="4514382">)</span><br>
<span class="lineno"></span><span class="ident" id="4514384">Curves</span><span class="op" id="4514390">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4514393">for</span>&nbsp;<span class="ident" id="4514397">_</span><span class="op" id="4514398">,</span>&nbsp;<span class="ident" id="4514400">curve</span>&nbsp;<span class="op" id="4514406">:=</span>&nbsp;<span class="keyword" id="4514409">range</span>&nbsp;<span class="ident" id="4514415">hs</span><span class="op" id="4514417">.</span><span class="ident" id="4514418">clientHello</span><span class="op" id="4514429">.</span><span class="ident" id="4514430">supportedCurves</span>&nbsp;<span class="op" id="4514446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4514450">for</span>&nbsp;<span class="ident" id="4514454">_</span><span class="op" id="4514455">,</span>&nbsp;<span class="ident" id="4514457">supported</span>&nbsp;<span class="op" id="4514467">:=</span>&nbsp;<span class="keyword" id="4514470">range</span>&nbsp;<span class="ident" id="4514476">preferredCurves</span>&nbsp;<span class="op" id="4514492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4514497">if</span>&nbsp;<span class="ident" id="4514500">supported</span>&nbsp;<span class="op" id="4514510">==</span>&nbsp;<span class="ident" id="4514513">curve</span>&nbsp;<span class="op" id="4514519">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4514525">supportedCurve</span>&nbsp;<span class="op" id="4514540">=</span>&nbsp;<span class="builtintype" id="4514542">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4514551">break</span>&nbsp;<span class="ident" id="4514557">Curves</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4514567">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4514571">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4514574">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4514578">supportedPointFormat</span>&nbsp;<span class="op" id="4514599">:=</span>&nbsp;<span class="builtintype" id="4514602">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4514609">for</span>&nbsp;<span class="ident" id="4514613">_</span><span class="op" id="4514614">,</span>&nbsp;<span class="ident" id="4514616">pointFormat</span>&nbsp;<span class="op" id="4514628">:=</span>&nbsp;<span class="keyword" id="4514631">range</span>&nbsp;<span class="ident" id="4514637">hs</span><span class="op" id="4514639">.</span><span class="ident" id="4514640">clientHello</span><span class="op" id="4514651">.</span><span class="ident" id="4514652">supportedPoints</span>&nbsp;<span class="op" id="4514668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4514672">if</span>&nbsp;<span class="ident" id="4514675">pointFormat</span>&nbsp;<span class="op" id="4514687">==</span>&nbsp;<span class="ident" id="4514690">pointFormatUncompressed</span>&nbsp;<span class="op" id="4514714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4514719">supportedPointFormat</span>&nbsp;<span class="op" id="4514740">=</span>&nbsp;<span class="builtintype" id="4514742">true</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4514750">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4514758">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4514761">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4514764">hs</span><span class="op" id="4514766">.</span><span class="ident" id="4514767">ellipticOk</span>&nbsp;<span class="op" id="4514778">=</span>&nbsp;<span class="ident" id="4514780">supportedCurve</span>&nbsp;<span class="op" id="4514795">&amp;&amp;</span>&nbsp;<span class="ident" id="4514798">supportedPointFormat</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4514821">foundCompression</span>&nbsp;<span class="op" id="4514838">:=</span>&nbsp;<span class="builtintype" id="4514841">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4514848">//&nbsp;We&nbsp;only&nbsp;support&nbsp;null&nbsp;compression,&nbsp;so&nbsp;check&nbsp;that&nbsp;the&nbsp;client&nbsp;offered&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4514923">for</span>&nbsp;<span class="ident" id="4514927">_</span><span class="op" id="4514928">,</span>&nbsp;<span class="ident" id="4514930">compression</span>&nbsp;<span class="op" id="4514942">:=</span>&nbsp;<span class="keyword" id="4514945">range</span>&nbsp;<span class="ident" id="4514951">hs</span><span class="op" id="4514953">.</span><span class="ident" id="4514954">clientHello</span><span class="op" id="4514965">.</span><span class="ident" id="4514966">compressionMethods</span>&nbsp;<span class="op" id="4514985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4514989">if</span>&nbsp;<span class="ident" id="4514992">compression</span>&nbsp;<span class="op" id="4515004">==</span>&nbsp;<span class="ident" id="4515007">compressionNone</span>&nbsp;<span class="op" id="4515023">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4515028">foundCompression</span>&nbsp;<span class="op" id="4515045">=</span>&nbsp;<span class="builtintype" id="4515047">true</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4515055">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4515063">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4515066">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4515070">if</span>&nbsp;<span class="op" id="4515073">!</span><span class="ident" id="4515074">foundCompression</span>&nbsp;<span class="op" id="4515091">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4515095">c</span><span class="op" id="4515096">.</span><span class="ident" id="4515097">sendAlert</span><span class="op" id="4515106">(</span><span class="ident" id="4515107">alertHandshakeFailure</span><span class="op" id="4515128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4515132">return</span>&nbsp;<span class="builtintype" id="4515139">false</span><span class="op" id="4515144">,</span>&nbsp;<span class="ident" id="4515146">errors</span><span class="op" id="4515152">.</span><span class="ident" id="4515153">New</span><span class="op" id="4515156">(</span><span class="string" id="4515157">&#34;tls:&nbsp;client&nbsp;does&nbsp;not&nbsp;support&nbsp;uncompressed&nbsp;connections&#34;</span><span class="op" id="4515212">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4515215">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4515219">hs</span><span class="op" id="4515221">.</span><span class="ident" id="4515222">hello</span><span class="op" id="4515227">.</span><span class="ident" id="4515228">vers</span>&nbsp;<span class="op" id="4515233">=</span>&nbsp;<span class="ident" id="4515235">c</span><span class="op" id="4515236">.</span><span class="ident" id="4515237">vers</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4515243">hs</span><span class="op" id="4515245">.</span><span class="ident" id="4515246">hello</span><span class="op" id="4515251">.</span><span class="ident" id="4515252">random</span>&nbsp;<span class="op" id="4515259">=</span>&nbsp;<span class="builtinfunc" id="4515261">make</span><span class="op" id="4515265">(</span><span class="op" id="4515266">[</span><span class="op" id="4515267">]</span><span class="builtintype" id="4515268">byte</span><span class="op" id="4515272">,</span>&nbsp;<span class="num" id="4515274">32</span><span class="op" id="4515276">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4515279">_</span><span class="op" id="4515280">,</span>&nbsp;<span class="ident" id="4515282">err</span>&nbsp;<span class="op" id="4515286">=</span>&nbsp;<span class="ident" id="4515288">io</span><span class="op" id="4515290">.</span><span class="ident" id="4515291">ReadFull</span><span class="op" id="4515299">(</span><span class="ident" id="4515300">config</span><span class="op" id="4515306">.</span><span class="ident" id="4515307">rand</span><span class="op" id="4515311">(</span><span class="op" id="4515312">)</span><span class="op" id="4515313">,</span>&nbsp;<span class="ident" id="4515315">hs</span><span class="op" id="4515317">.</span><span class="ident" id="4515318">hello</span><span class="op" id="4515323">.</span><span class="ident" id="4515324">random</span><span class="op" id="4515330">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4515333">if</span>&nbsp;<span class="ident" id="4515336">err</span>&nbsp;<span class="op" id="4515340">!=</span>&nbsp;<span class="ident" id="4515343">nil</span>&nbsp;<span class="op" id="4515347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4515351">c</span><span class="op" id="4515352">.</span><span class="ident" id="4515353">sendAlert</span><span class="op" id="4515362">(</span><span class="ident" id="4515363">alertInternalError</span><span class="op" id="4515381">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4515385">return</span>&nbsp;<span class="builtintype" id="4515392">false</span><span class="op" id="4515397">,</span>&nbsp;<span class="ident" id="4515399">err</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4515404">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4515407">hs</span><span class="op" id="4515409">.</span><span class="ident" id="4515410">hello</span><span class="op" id="4515415">.</span><span class="ident" id="4515416">secureRenegotiation</span>&nbsp;<span class="op" id="4515436">=</span>&nbsp;<span class="ident" id="4515438">hs</span><span class="op" id="4515440">.</span><span class="ident" id="4515441">clientHello</span><span class="op" id="4515452">.</span><span class="ident" id="4515453">secureRenegotiation</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4515474">hs</span><span class="op" id="4515476">.</span><span class="ident" id="4515477">hello</span><span class="op" id="4515482">.</span><span class="ident" id="4515483">compressionMethod</span>&nbsp;<span class="op" id="4515501">=</span>&nbsp;<span class="ident" id="4515503">compressionNone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4515520">if</span>&nbsp;<span class="builtinfunc" id="4515523">len</span><span class="op" id="4515526">(</span><span class="ident" id="4515527">hs</span><span class="op" id="4515529">.</span><span class="ident" id="4515530">clientHello</span><span class="op" id="4515541">.</span><span class="ident" id="4515542">serverName</span><span class="op" id="4515552">)</span>&nbsp;<span class="op" id="4515554">&gt;</span>&nbsp;<span class="num" id="4515556">0</span>&nbsp;<span class="op" id="4515558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4515562">c</span><span class="op" id="4515563">.</span><span class="ident" id="4515564">serverName</span>&nbsp;<span class="op" id="4515575">=</span>&nbsp;<span class="ident" id="4515577">hs</span><span class="op" id="4515579">.</span><span class="ident" id="4515580">clientHello</span><span class="op" id="4515591">.</span><span class="ident" id="4515592">serverName</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4515604">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4515608">if</span>&nbsp;<span class="builtinfunc" id="4515611">len</span><span class="op" id="4515614">(</span><span class="ident" id="4515615">hs</span><span class="op" id="4515617">.</span><span class="ident" id="4515618">clientHello</span><span class="op" id="4515629">.</span><span class="ident" id="4515630">alpnProtocols</span><span class="op" id="4515643">)</span>&nbsp;<span class="op" id="4515645">&gt;</span>&nbsp;<span class="num" id="4515647">0</span>&nbsp;<span class="op" id="4515649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4515653">if</span>&nbsp;<span class="ident" id="4515656">selectedProto</span><span class="op" id="4515669">,</span>&nbsp;<span class="ident" id="4515671">fallback</span>&nbsp;<span class="op" id="4515680">:=</span>&nbsp;<span class="ident" id="4515683">mutualProtocol</span><span class="op" id="4515697">(</span><span class="ident" id="4515698">hs</span><span class="op" id="4515700">.</span><span class="ident" id="4515701">clientHello</span><span class="op" id="4515712">.</span><span class="ident" id="4515713">alpnProtocols</span><span class="op" id="4515726">,</span>&nbsp;<span class="ident" id="4515728">c</span><span class="op" id="4515729">.</span><span class="ident" id="4515730">config</span><span class="op" id="4515736">.</span><span class="ident" id="4515737">NextProtos</span><span class="op" id="4515747">)</span><span class="op" id="4515748">;</span>&nbsp;<span class="op" id="4515750">!</span><span class="ident" id="4515751">fallback</span>&nbsp;<span class="op" id="4515760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4515765">hs</span><span class="op" id="4515767">.</span><span class="ident" id="4515768">hello</span><span class="op" id="4515773">.</span><span class="ident" id="4515774">alpnProtocol</span>&nbsp;<span class="op" id="4515787">=</span>&nbsp;<span class="ident" id="4515789">selectedProto</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4515806">c</span><span class="op" id="4515807">.</span><span class="ident" id="4515808">clientProtocol</span>&nbsp;<span class="op" id="4515823">=</span>&nbsp;<span class="ident" id="4515825">selectedProto</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4515841">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4515844">}</span>&nbsp;<span class="keyword" id="4515846">else</span>&nbsp;<span class="op" id="4515851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4515855">//&nbsp;Although&nbsp;sending&nbsp;an&nbsp;empty&nbsp;NPN&nbsp;extension&nbsp;is&nbsp;reasonable,&nbsp;Firefox&nbsp;has</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4515927">//&nbsp;had&nbsp;a&nbsp;bug&nbsp;around&nbsp;this.&nbsp;Best&nbsp;to&nbsp;send&nbsp;nothing&nbsp;at&nbsp;all&nbsp;if</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4515986">//&nbsp;config.NextProtos&nbsp;is&nbsp;empty.&nbsp;See</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4516023">//&nbsp;https://code.google.com/p/go/issues/detail?id=5445.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4516080">if</span>&nbsp;<span class="ident" id="4516083">hs</span><span class="op" id="4516085">.</span><span class="ident" id="4516086">clientHello</span><span class="op" id="4516097">.</span><span class="ident" id="4516098">nextProtoNeg</span>&nbsp;<span class="op" id="4516111">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="4516114">len</span><span class="op" id="4516117">(</span><span class="ident" id="4516118">config</span><span class="op" id="4516124">.</span><span class="ident" id="4516125">NextProtos</span><span class="op" id="4516135">)</span>&nbsp;<span class="op" id="4516137">&gt;</span>&nbsp;<span class="num" id="4516139">0</span>&nbsp;<span class="op" id="4516141">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4516146">hs</span><span class="op" id="4516148">.</span><span class="ident" id="4516149">hello</span><span class="op" id="4516154">.</span><span class="ident" id="4516155">nextProtoNeg</span>&nbsp;<span class="op" id="4516168">=</span>&nbsp;<span class="builtintype" id="4516170">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4516178">hs</span><span class="op" id="4516180">.</span><span class="ident" id="4516181">hello</span><span class="op" id="4516186">.</span><span class="ident" id="4516187">nextProtos</span>&nbsp;<span class="op" id="4516198">=</span>&nbsp;<span class="ident" id="4516200">config</span><span class="op" id="4516206">.</span><span class="ident" id="4516207">NextProtos</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4516220">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4516223">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4516227">if</span>&nbsp;<span class="builtinfunc" id="4516230">len</span><span class="op" id="4516233">(</span><span class="ident" id="4516234">config</span><span class="op" id="4516240">.</span><span class="ident" id="4516241">Certificates</span><span class="op" id="4516253">)</span>&nbsp;<span class="op" id="4516255">==</span>&nbsp;<span class="num" id="4516258">0</span>&nbsp;<span class="op" id="4516260">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4516264">c</span><span class="op" id="4516265">.</span><span class="ident" id="4516266">sendAlert</span><span class="op" id="4516275">(</span><span class="ident" id="4516276">alertInternalError</span><span class="op" id="4516294">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4516298">return</span>&nbsp;<span class="builtintype" id="4516305">false</span><span class="op" id="4516310">,</span>&nbsp;<span class="ident" id="4516312">errors</span><span class="op" id="4516318">.</span><span class="ident" id="4516319">New</span><span class="op" id="4516322">(</span><span class="string" id="4516323">&#34;tls:&nbsp;no&nbsp;certificates&nbsp;configured&#34;</span><span class="op" id="4516356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4516359">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4516362">hs</span><span class="op" id="4516364">.</span><span class="ident" id="4516365">cert</span>&nbsp;<span class="op" id="4516370">=</span>&nbsp;<span class="op" id="4516372">&amp;</span><span class="ident" id="4516373">config</span><span class="op" id="4516379">.</span><span class="ident" id="4516380">Certificates</span><span class="op" id="4516392">[</span><span class="num" id="4516393">0</span><span class="op" id="4516394">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4516397">if</span>&nbsp;<span class="builtinfunc" id="4516400">len</span><span class="op" id="4516403">(</span><span class="ident" id="4516404">hs</span><span class="op" id="4516406">.</span><span class="ident" id="4516407">clientHello</span><span class="op" id="4516418">.</span><span class="ident" id="4516419">serverName</span><span class="op" id="4516429">)</span>&nbsp;<span class="op" id="4516431">&gt;</span>&nbsp;<span class="num" id="4516433">0</span>&nbsp;<span class="op" id="4516435">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4516439">chi</span>&nbsp;<span class="op" id="4516443">:=</span>&nbsp;<span class="op" id="4516446">&amp;</span><span class="ident" id="4516447">ClientHelloInfo</span><span class="op" id="4516462">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4516467">CipherSuites</span><span class="op" id="4516479">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4516484">hs</span><span class="op" id="4516486">.</span><span class="ident" id="4516487">clientHello</span><span class="op" id="4516498">.</span><span class="ident" id="4516499">cipherSuites</span><span class="op" id="4516511">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4516516">ServerName</span><span class="op" id="4516526">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4516533">hs</span><span class="op" id="4516535">.</span><span class="ident" id="4516536">clientHello</span><span class="op" id="4516547">.</span><span class="ident" id="4516548">serverName</span><span class="op" id="4516558">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4516563">SupportedCurves</span><span class="op" id="4516578">:</span>&nbsp;<span class="ident" id="4516580">hs</span><span class="op" id="4516582">.</span><span class="ident" id="4516583">clientHello</span><span class="op" id="4516594">.</span><span class="ident" id="4516595">supportedCurves</span><span class="op" id="4516610">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4516615">SupportedPoints</span><span class="op" id="4516630">:</span>&nbsp;<span class="ident" id="4516632">hs</span><span class="op" id="4516634">.</span><span class="ident" id="4516635">clientHello</span><span class="op" id="4516646">.</span><span class="ident" id="4516647">supportedPoints</span><span class="op" id="4516662">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4516666">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4516670">if</span>&nbsp;<span class="ident" id="4516673">hs</span><span class="op" id="4516675">.</span><span class="ident" id="4516676">cert</span><span class="op" id="4516680">,</span>&nbsp;<span class="ident" id="4516682">err</span>&nbsp;<span class="op" id="4516686">=</span>&nbsp;<span class="ident" id="4516688">config</span><span class="op" id="4516694">.</span><span class="ident" id="4516695">getCertificate</span><span class="op" id="4516709">(</span><span class="ident" id="4516710">chi</span><span class="op" id="4516713">)</span><span class="op" id="4516714">;</span>&nbsp;<span class="ident" id="4516716">err</span>&nbsp;<span class="op" id="4516720">!=</span>&nbsp;<span class="ident" id="4516723">nil</span>&nbsp;<span class="op" id="4516727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4516732">c</span><span class="op" id="4516733">.</span><span class="ident" id="4516734">sendAlert</span><span class="op" id="4516743">(</span><span class="ident" id="4516744">alertInternalError</span><span class="op" id="4516762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4516767">return</span>&nbsp;<span class="builtintype" id="4516774">false</span><span class="op" id="4516779">,</span>&nbsp;<span class="ident" id="4516781">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4516787">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4516790">}</span><br>
<span class="lineno">200</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4516794">_</span><span class="op" id="4516795">,</span>&nbsp;<span class="ident" id="4516797">hs</span><span class="op" id="4516799">.</span><span class="ident" id="4516800">ecdsaOk</span>&nbsp;<span class="op" id="4516808">=</span>&nbsp;<span class="ident" id="4516810">hs</span><span class="op" id="4516812">.</span><span class="ident" id="4516813">cert</span><span class="op" id="4516817">.</span><span class="ident" id="4516818">PrivateKey</span><span class="op" id="4516828">.</span><span class="op" id="4516829">(</span><span class="op" id="4516830">*</span><span class="ident" id="4516831">ecdsa</span><span class="op" id="4516836">.</span><span class="ident" id="4516837">PrivateKey</span><span class="op" id="4516847">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4516851">if</span>&nbsp;<span class="ident" id="4516854">hs</span><span class="op" id="4516856">.</span><span class="ident" id="4516857">checkForResumption</span><span class="op" id="4516875">(</span><span class="op" id="4516876">)</span>&nbsp;<span class="op" id="4516878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4516882">return</span>&nbsp;<span class="builtintype" id="4516889">true</span><span class="op" id="4516893">,</span>&nbsp;<span class="ident" id="4516895">nil</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4516900">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4516904">var</span>&nbsp;<span class="ident" id="4516908">preferenceList</span><span class="op" id="4516922">,</span>&nbsp;<span class="ident" id="4516924">supportedList</span>&nbsp;<span class="op" id="4516938">[</span><span class="op" id="4516939">]</span><span class="builtintype" id="4516940">uint16</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4516948">if</span>&nbsp;<span class="ident" id="4516951">c</span><span class="op" id="4516952">.</span><span class="ident" id="4516953">config</span><span class="op" id="4516959">.</span><span class="ident" id="4516960">PreferServerCipherSuites</span>&nbsp;<span class="op" id="4516985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4516989">preferenceList</span>&nbsp;<span class="op" id="4517004">=</span>&nbsp;<span class="ident" id="4517006">c</span><span class="op" id="4517007">.</span><span class="ident" id="4517008">config</span><span class="op" id="4517014">.</span><span class="ident" id="4517015">cipherSuites</span><span class="op" id="4517027">(</span><span class="op" id="4517028">)</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4517032">supportedList</span>&nbsp;<span class="op" id="4517046">=</span>&nbsp;<span class="ident" id="4517048">hs</span><span class="op" id="4517050">.</span><span class="ident" id="4517051">clientHello</span><span class="op" id="4517062">.</span><span class="ident" id="4517063">cipherSuites</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4517077">}</span>&nbsp;<span class="keyword" id="4517079">else</span>&nbsp;<span class="op" id="4517084">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4517088">preferenceList</span>&nbsp;<span class="op" id="4517103">=</span>&nbsp;<span class="ident" id="4517105">hs</span><span class="op" id="4517107">.</span><span class="ident" id="4517108">clientHello</span><span class="op" id="4517119">.</span><span class="ident" id="4517120">cipherSuites</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4517135">supportedList</span>&nbsp;<span class="op" id="4517149">=</span>&nbsp;<span class="ident" id="4517151">c</span><span class="op" id="4517152">.</span><span class="ident" id="4517153">config</span><span class="op" id="4517159">.</span><span class="ident" id="4517160">cipherSuites</span><span class="op" id="4517172">(</span><span class="op" id="4517173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4517176">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4517180">for</span>&nbsp;<span class="ident" id="4517184">_</span><span class="op" id="4517185">,</span>&nbsp;<span class="ident" id="4517187">id</span>&nbsp;<span class="op" id="4517190">:=</span>&nbsp;<span class="keyword" id="4517193">range</span>&nbsp;<span class="ident" id="4517199">preferenceList</span>&nbsp;<span class="op" id="4517214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4517218">if</span>&nbsp;<span class="ident" id="4517221">hs</span><span class="op" id="4517223">.</span><span class="ident" id="4517224">suite</span>&nbsp;<span class="op" id="4517230">=</span>&nbsp;<span class="ident" id="4517232">c</span><span class="op" id="4517233">.</span><span class="ident" id="4517234">tryCipherSuite</span><span class="op" id="4517248">(</span><span class="ident" id="4517249">id</span><span class="op" id="4517251">,</span>&nbsp;<span class="ident" id="4517253">supportedList</span><span class="op" id="4517266">,</span>&nbsp;<span class="ident" id="4517268">c</span><span class="op" id="4517269">.</span><span class="ident" id="4517270">vers</span><span class="op" id="4517274">,</span>&nbsp;<span class="ident" id="4517276">hs</span><span class="op" id="4517278">.</span><span class="ident" id="4517279">ellipticOk</span><span class="op" id="4517289">,</span>&nbsp;<span class="ident" id="4517291">hs</span><span class="op" id="4517293">.</span><span class="ident" id="4517294">ecdsaOk</span><span class="op" id="4517301">)</span><span class="op" id="4517302">;</span>&nbsp;<span class="ident" id="4517304">hs</span><span class="op" id="4517306">.</span><span class="ident" id="4517307">suite</span>&nbsp;<span class="op" id="4517313">!=</span>&nbsp;<span class="ident" id="4517316">nil</span>&nbsp;<span class="op" id="4517320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4517325">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4517333">}</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4517336">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4517340">if</span>&nbsp;<span class="ident" id="4517343">hs</span><span class="op" id="4517345">.</span><span class="ident" id="4517346">suite</span>&nbsp;<span class="op" id="4517352">==</span>&nbsp;<span class="ident" id="4517355">nil</span>&nbsp;<span class="op" id="4517359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4517363">c</span><span class="op" id="4517364">.</span><span class="ident" id="4517365">sendAlert</span><span class="op" id="4517374">(</span><span class="ident" id="4517375">alertHandshakeFailure</span><span class="op" id="4517396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4517400">return</span>&nbsp;<span class="builtintype" id="4517407">false</span><span class="op" id="4517412">,</span>&nbsp;<span class="ident" id="4517414">errors</span><span class="op" id="4517420">.</span><span class="ident" id="4517421">New</span><span class="op" id="4517424">(</span><span class="string" id="4517425">&#34;tls:&nbsp;no&nbsp;cipher&nbsp;suite&nbsp;supported&nbsp;by&nbsp;both&nbsp;client&nbsp;and&nbsp;server&#34;</span><span class="op" id="4517483">)</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4517486">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4517490">//&nbsp;See&nbsp;https://tools.ietf.org/html/draft-ietf-tls-downgrade-scsv-00.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4517560">for</span>&nbsp;<span class="ident" id="4517564">_</span><span class="op" id="4517565">,</span>&nbsp;<span class="ident" id="4517567">id</span>&nbsp;<span class="op" id="4517570">:=</span>&nbsp;<span class="keyword" id="4517573">range</span>&nbsp;<span class="ident" id="4517579">hs</span><span class="op" id="4517581">.</span><span class="ident" id="4517582">clientHello</span><span class="op" id="4517593">.</span><span class="ident" id="4517594">cipherSuites</span>&nbsp;<span class="op" id="4517607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4517611">if</span>&nbsp;<span class="ident" id="4517614">id</span>&nbsp;<span class="op" id="4517617">==</span>&nbsp;<span class="ident" id="4517620">TLS_FALLBACK_SCSV</span>&nbsp;<span class="op" id="4517638">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4517643">//&nbsp;The&nbsp;client&nbsp;is&nbsp;doing&nbsp;a&nbsp;fallback&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4517692">if</span>&nbsp;<span class="ident" id="4517695">hs</span><span class="op" id="4517697">.</span><span class="ident" id="4517698">clientHello</span><span class="op" id="4517709">.</span><span class="ident" id="4517710">vers</span>&nbsp;<span class="op" id="4517715">&lt;</span>&nbsp;<span class="ident" id="4517717">c</span><span class="op" id="4517718">.</span><span class="ident" id="4517719">config</span><span class="op" id="4517725">.</span><span class="ident" id="4517726">MaxVersion</span>&nbsp;<span class="op" id="4517737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4517743">c</span><span class="op" id="4517744">.</span><span class="ident" id="4517745">sendAlert</span><span class="op" id="4517754">(</span><span class="ident" id="4517755">alertInappropriateFallback</span><span class="op" id="4517781">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4517787">return</span>&nbsp;<span class="builtintype" id="4517794">false</span><span class="op" id="4517799">,</span>&nbsp;<span class="ident" id="4517801">errors</span><span class="op" id="4517807">.</span><span class="ident" id="4517808">New</span><span class="op" id="4517811">(</span><span class="string" id="4517812">&#34;tls:&nbsp;client&nbsp;using&nbsp;inppropriate&nbsp;protocol&nbsp;fallback&#34;</span><span class="op" id="4517862">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4517867">}</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4517872">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4517880">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4517883">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4517887">return</span>&nbsp;<span class="builtintype" id="4517894">false</span><span class="op" id="4517899">,</span>&nbsp;<span class="ident" id="4517901">nil</span><br>
<span class="lineno">240</span><span class="op" id="4517905">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4517908">//&nbsp;checkForResumption&nbsp;returns&nbsp;true&nbsp;if&nbsp;we&nbsp;should&nbsp;perform&nbsp;resumption&nbsp;on&nbsp;this&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="4517995">func</span>&nbsp;<span class="op" id="4518000">(</span><span class="ident" id="4518001">hs</span>&nbsp;<span class="op" id="4518004">*</span><span class="ident" id="4518005">serverHandshakeState</span><span class="op" id="4518025">)</span>&nbsp;<span class="ident" id="4518027">checkForResumption</span><span class="op" id="4518045">(</span><span class="op" id="4518046">)</span>&nbsp;<span class="builtintype" id="4518048">bool</span>&nbsp;<span class="op" id="4518053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4518056">c</span>&nbsp;<span class="op" id="4518058">:=</span>&nbsp;<span class="ident" id="4518061">hs</span><span class="op" id="4518063">.</span><span class="ident" id="4518064">c</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4518068">if</span>&nbsp;<span class="ident" id="4518071">c</span><span class="op" id="4518072">.</span><span class="ident" id="4518073">config</span><span class="op" id="4518079">.</span><span class="ident" id="4518080">SessionTicketsDisabled</span>&nbsp;<span class="op" id="4518103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4518107">return</span>&nbsp;<span class="builtintype" id="4518114">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4518121">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4518125">var</span>&nbsp;<span class="ident" id="4518129">ok</span>&nbsp;<span class="builtintype" id="4518132">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4518138">if</span>&nbsp;<span class="ident" id="4518141">hs</span><span class="op" id="4518143">.</span><span class="ident" id="4518144">sessionState</span><span class="op" id="4518156">,</span>&nbsp;<span class="ident" id="4518158">ok</span>&nbsp;<span class="op" id="4518161">=</span>&nbsp;<span class="ident" id="4518163">c</span><span class="op" id="4518164">.</span><span class="ident" id="4518165">decryptTicket</span><span class="op" id="4518178">(</span><span class="ident" id="4518179">hs</span><span class="op" id="4518181">.</span><span class="ident" id="4518182">clientHello</span><span class="op" id="4518193">.</span><span class="ident" id="4518194">sessionTicket</span><span class="op" id="4518207">)</span><span class="op" id="4518208">;</span>&nbsp;<span class="op" id="4518210">!</span><span class="ident" id="4518211">ok</span>&nbsp;<span class="op" id="4518214">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4518218">return</span>&nbsp;<span class="builtintype" id="4518225">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4518232">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4518236">if</span>&nbsp;<span class="ident" id="4518239">hs</span><span class="op" id="4518241">.</span><span class="ident" id="4518242">sessionState</span><span class="op" id="4518254">.</span><span class="ident" id="4518255">vers</span>&nbsp;<span class="op" id="4518260">&gt;</span>&nbsp;<span class="ident" id="4518262">hs</span><span class="op" id="4518264">.</span><span class="ident" id="4518265">clientHello</span><span class="op" id="4518276">.</span><span class="ident" id="4518277">vers</span>&nbsp;<span class="op" id="4518282">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4518286">return</span>&nbsp;<span class="builtintype" id="4518293">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4518300">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4518303">if</span>&nbsp;<span class="ident" id="4518306">vers</span><span class="op" id="4518310">,</span>&nbsp;<span class="ident" id="4518312">ok</span>&nbsp;<span class="op" id="4518315">:=</span>&nbsp;<span class="ident" id="4518318">c</span><span class="op" id="4518319">.</span><span class="ident" id="4518320">config</span><span class="op" id="4518326">.</span><span class="ident" id="4518327">mutualVersion</span><span class="op" id="4518340">(</span><span class="ident" id="4518341">hs</span><span class="op" id="4518343">.</span><span class="ident" id="4518344">sessionState</span><span class="op" id="4518356">.</span><span class="ident" id="4518357">vers</span><span class="op" id="4518361">)</span><span class="op" id="4518362">;</span>&nbsp;<span class="op" id="4518364">!</span><span class="ident" id="4518365">ok</span>&nbsp;<span class="op" id="4518368">||</span>&nbsp;<span class="ident" id="4518371">vers</span>&nbsp;<span class="op" id="4518376">!=</span>&nbsp;<span class="ident" id="4518379">hs</span><span class="op" id="4518381">.</span><span class="ident" id="4518382">sessionState</span><span class="op" id="4518394">.</span><span class="ident" id="4518395">vers</span>&nbsp;<span class="op" id="4518400">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4518404">return</span>&nbsp;<span class="builtintype" id="4518411">false</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4518418">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4518422">cipherSuiteOk</span>&nbsp;<span class="op" id="4518436">:=</span>&nbsp;<span class="builtintype" id="4518439">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4518446">//&nbsp;Check&nbsp;that&nbsp;the&nbsp;client&nbsp;is&nbsp;still&nbsp;offering&nbsp;the&nbsp;ciphersuite&nbsp;in&nbsp;the&nbsp;session.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4518522">for</span>&nbsp;<span class="ident" id="4518526">_</span><span class="op" id="4518527">,</span>&nbsp;<span class="ident" id="4518529">id</span>&nbsp;<span class="op" id="4518532">:=</span>&nbsp;<span class="keyword" id="4518535">range</span>&nbsp;<span class="ident" id="4518541">hs</span><span class="op" id="4518543">.</span><span class="ident" id="4518544">clientHello</span><span class="op" id="4518555">.</span><span class="ident" id="4518556">cipherSuites</span>&nbsp;<span class="op" id="4518569">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4518573">if</span>&nbsp;<span class="ident" id="4518576">id</span>&nbsp;<span class="op" id="4518579">==</span>&nbsp;<span class="ident" id="4518582">hs</span><span class="op" id="4518584">.</span><span class="ident" id="4518585">sessionState</span><span class="op" id="4518597">.</span><span class="ident" id="4518598">cipherSuite</span>&nbsp;<span class="op" id="4518610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4518615">cipherSuiteOk</span>&nbsp;<span class="op" id="4518629">=</span>&nbsp;<span class="builtintype" id="4518631">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4518639">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4518647">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4518650">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4518653">if</span>&nbsp;<span class="op" id="4518656">!</span><span class="ident" id="4518657">cipherSuiteOk</span>&nbsp;<span class="op" id="4518671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4518675">return</span>&nbsp;<span class="builtintype" id="4518682">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4518689">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4518693">//&nbsp;Check&nbsp;that&nbsp;we&nbsp;also&nbsp;support&nbsp;the&nbsp;ciphersuite&nbsp;from&nbsp;the&nbsp;session.</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4518758">hs</span><span class="op" id="4518760">.</span><span class="ident" id="4518761">suite</span>&nbsp;<span class="op" id="4518767">=</span>&nbsp;<span class="ident" id="4518769">c</span><span class="op" id="4518770">.</span><span class="ident" id="4518771">tryCipherSuite</span><span class="op" id="4518785">(</span><span class="ident" id="4518786">hs</span><span class="op" id="4518788">.</span><span class="ident" id="4518789">sessionState</span><span class="op" id="4518801">.</span><span class="ident" id="4518802">cipherSuite</span><span class="op" id="4518813">,</span>&nbsp;<span class="ident" id="4518815">c</span><span class="op" id="4518816">.</span><span class="ident" id="4518817">config</span><span class="op" id="4518823">.</span><span class="ident" id="4518824">cipherSuites</span><span class="op" id="4518836">(</span><span class="op" id="4518837">)</span><span class="op" id="4518838">,</span>&nbsp;<span class="ident" id="4518840">hs</span><span class="op" id="4518842">.</span><span class="ident" id="4518843">sessionState</span><span class="op" id="4518855">.</span><span class="ident" id="4518856">vers</span><span class="op" id="4518860">,</span>&nbsp;<span class="ident" id="4518862">hs</span><span class="op" id="4518864">.</span><span class="ident" id="4518865">ellipticOk</span><span class="op" id="4518875">,</span>&nbsp;<span class="ident" id="4518877">hs</span><span class="op" id="4518879">.</span><span class="ident" id="4518880">ecdsaOk</span><span class="op" id="4518887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4518890">if</span>&nbsp;<span class="ident" id="4518893">hs</span><span class="op" id="4518895">.</span><span class="ident" id="4518896">suite</span>&nbsp;<span class="op" id="4518902">==</span>&nbsp;<span class="ident" id="4518905">nil</span>&nbsp;<span class="op" id="4518909">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4518913">return</span>&nbsp;<span class="builtintype" id="4518920">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4518927">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4518931">sessionHasClientCerts</span>&nbsp;<span class="op" id="4518953">:=</span>&nbsp;<span class="builtinfunc" id="4518956">len</span><span class="op" id="4518959">(</span><span class="ident" id="4518960">hs</span><span class="op" id="4518962">.</span><span class="ident" id="4518963">sessionState</span><span class="op" id="4518975">.</span><span class="ident" id="4518976">certificates</span><span class="op" id="4518988">)</span>&nbsp;<span class="op" id="4518990">!=</span>&nbsp;<span class="num" id="4518993">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4518996">needClientCerts</span>&nbsp;<span class="op" id="4519012">:=</span>&nbsp;<span class="ident" id="4519015">c</span><span class="op" id="4519016">.</span><span class="ident" id="4519017">config</span><span class="op" id="4519023">.</span><span class="ident" id="4519024">ClientAuth</span>&nbsp;<span class="op" id="4519035">==</span>&nbsp;<span class="ident" id="4519038">RequireAnyClientCert</span>&nbsp;<span class="op" id="4519059">||</span>&nbsp;<span class="ident" id="4519062">c</span><span class="op" id="4519063">.</span><span class="ident" id="4519064">config</span><span class="op" id="4519070">.</span><span class="ident" id="4519071">ClientAuth</span>&nbsp;<span class="op" id="4519082">==</span>&nbsp;<span class="ident" id="4519085">RequireAndVerifyClientCert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4519113">if</span>&nbsp;<span class="ident" id="4519116">needClientCerts</span>&nbsp;<span class="op" id="4519132">&amp;&amp;</span>&nbsp;<span class="op" id="4519135">!</span><span class="ident" id="4519136">sessionHasClientCerts</span>&nbsp;<span class="op" id="4519158">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4519162">return</span>&nbsp;<span class="builtintype" id="4519169">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4519176">}</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4519179">if</span>&nbsp;<span class="ident" id="4519182">sessionHasClientCerts</span>&nbsp;<span class="op" id="4519204">&amp;&amp;</span>&nbsp;<span class="ident" id="4519207">c</span><span class="op" id="4519208">.</span><span class="ident" id="4519209">config</span><span class="op" id="4519215">.</span><span class="ident" id="4519216">ClientAuth</span>&nbsp;<span class="op" id="4519227">==</span>&nbsp;<span class="ident" id="4519230">NoClientCert</span>&nbsp;<span class="op" id="4519243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4519247">return</span>&nbsp;<span class="builtintype" id="4519254">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4519261">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4519265">return</span>&nbsp;<span class="builtintype" id="4519272">true</span><br>
<span class="lineno">290</span><span class="op" id="4519277">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4519280">func</span>&nbsp;<span class="op" id="4519285">(</span><span class="ident" id="4519286">hs</span>&nbsp;<span class="op" id="4519289">*</span><span class="ident" id="4519290">serverHandshakeState</span><span class="op" id="4519310">)</span>&nbsp;<span class="ident" id="4519312">doResumeHandshake</span><span class="op" id="4519329">(</span><span class="op" id="4519330">)</span>&nbsp;<span class="builtintype" id="4519332">error</span>&nbsp;<span class="op" id="4519338">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4519341">c</span>&nbsp;<span class="op" id="4519343">:=</span>&nbsp;<span class="ident" id="4519346">hs</span><span class="op" id="4519348">.</span><span class="ident" id="4519349">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4519353">hs</span><span class="op" id="4519355">.</span><span class="ident" id="4519356">hello</span><span class="op" id="4519361">.</span><span class="ident" id="4519362">cipherSuite</span>&nbsp;<span class="op" id="4519374">=</span>&nbsp;<span class="ident" id="4519376">hs</span><span class="op" id="4519378">.</span><span class="ident" id="4519379">suite</span><span class="op" id="4519384">.</span><span class="ident" id="4519385">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4519389">//&nbsp;We&nbsp;echo&nbsp;the&nbsp;client&#39;s&nbsp;session&nbsp;ID&nbsp;in&nbsp;the&nbsp;ServerHello&nbsp;to&nbsp;let&nbsp;it&nbsp;know</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4519459">//&nbsp;that&nbsp;we&#39;re&nbsp;doing&nbsp;a&nbsp;resumption.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4519494">hs</span><span class="op" id="4519496">.</span><span class="ident" id="4519497">hello</span><span class="op" id="4519502">.</span><span class="ident" id="4519503">sessionId</span>&nbsp;<span class="op" id="4519513">=</span>&nbsp;<span class="ident" id="4519515">hs</span><span class="op" id="4519517">.</span><span class="ident" id="4519518">clientHello</span><span class="op" id="4519529">.</span><span class="ident" id="4519530">sessionId</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4519541">hs</span><span class="op" id="4519543">.</span><span class="ident" id="4519544">finishedHash</span><span class="op" id="4519556">.</span><span class="ident" id="4519557">Write</span><span class="op" id="4519562">(</span><span class="ident" id="4519563">hs</span><span class="op" id="4519565">.</span><span class="ident" id="4519566">hello</span><span class="op" id="4519571">.</span><span class="ident" id="4519572">marshal</span><span class="op" id="4519579">(</span><span class="op" id="4519580">)</span><span class="op" id="4519581">)</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4519584">c</span><span class="op" id="4519585">.</span><span class="ident" id="4519586">writeRecord</span><span class="op" id="4519597">(</span><span class="ident" id="4519598">recordTypeHandshake</span><span class="op" id="4519617">,</span>&nbsp;<span class="ident" id="4519619">hs</span><span class="op" id="4519621">.</span><span class="ident" id="4519622">hello</span><span class="op" id="4519627">.</span><span class="ident" id="4519628">marshal</span><span class="op" id="4519635">(</span><span class="op" id="4519636">)</span><span class="op" id="4519637">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4519641">if</span>&nbsp;<span class="builtinfunc" id="4519644">len</span><span class="op" id="4519647">(</span><span class="ident" id="4519648">hs</span><span class="op" id="4519650">.</span><span class="ident" id="4519651">sessionState</span><span class="op" id="4519663">.</span><span class="ident" id="4519664">certificates</span><span class="op" id="4519676">)</span>&nbsp;<span class="op" id="4519678">&gt;</span>&nbsp;<span class="num" id="4519680">0</span>&nbsp;<span class="op" id="4519682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4519686">if</span>&nbsp;<span class="ident" id="4519689">_</span><span class="op" id="4519690">,</span>&nbsp;<span class="ident" id="4519692">err</span>&nbsp;<span class="op" id="4519696">:=</span>&nbsp;<span class="ident" id="4519699">hs</span><span class="op" id="4519701">.</span><span class="ident" id="4519702">processCertsFromClient</span><span class="op" id="4519724">(</span><span class="ident" id="4519725">hs</span><span class="op" id="4519727">.</span><span class="ident" id="4519728">sessionState</span><span class="op" id="4519740">.</span><span class="ident" id="4519741">certificates</span><span class="op" id="4519753">)</span><span class="op" id="4519754">;</span>&nbsp;<span class="ident" id="4519756">err</span>&nbsp;<span class="op" id="4519760">!=</span>&nbsp;<span class="ident" id="4519763">nil</span>&nbsp;<span class="op" id="4519767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4519772">return</span>&nbsp;<span class="ident" id="4519779">err</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4519785">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4519788">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4519792">hs</span><span class="op" id="4519794">.</span><span class="ident" id="4519795">masterSecret</span>&nbsp;<span class="op" id="4519808">=</span>&nbsp;<span class="ident" id="4519810">hs</span><span class="op" id="4519812">.</span><span class="ident" id="4519813">sessionState</span><span class="op" id="4519825">.</span><span class="ident" id="4519826">masterSecret</span><br>
<span class="lineno"></span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4519841">return</span>&nbsp;<span class="ident" id="4519848">nil</span><br>
<span class="lineno"></span><span class="op" id="4519852">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4519855">func</span>&nbsp;<span class="op" id="4519860">(</span><span class="ident" id="4519861">hs</span>&nbsp;<span class="op" id="4519864">*</span><span class="ident" id="4519865">serverHandshakeState</span><span class="op" id="4519885">)</span>&nbsp;<span class="ident" id="4519887">doFullHandshake</span><span class="op" id="4519902">(</span><span class="op" id="4519903">)</span>&nbsp;<span class="builtintype" id="4519905">error</span>&nbsp;<span class="op" id="4519911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4519914">config</span>&nbsp;<span class="op" id="4519921">:=</span>&nbsp;<span class="ident" id="4519924">hs</span><span class="op" id="4519926">.</span><span class="ident" id="4519927">c</span><span class="op" id="4519928">.</span><span class="ident" id="4519929">config</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4519937">c</span>&nbsp;<span class="op" id="4519939">:=</span>&nbsp;<span class="ident" id="4519942">hs</span><span class="op" id="4519944">.</span><span class="ident" id="4519945">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4519949">if</span>&nbsp;<span class="ident" id="4519952">hs</span><span class="op" id="4519954">.</span><span class="ident" id="4519955">clientHello</span><span class="op" id="4519966">.</span><span class="ident" id="4519967">ocspStapling</span>&nbsp;<span class="op" id="4519980">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="4519983">len</span><span class="op" id="4519986">(</span><span class="ident" id="4519987">hs</span><span class="op" id="4519989">.</span><span class="ident" id="4519990">cert</span><span class="op" id="4519994">.</span><span class="ident" id="4519995">OCSPStaple</span><span class="op" id="4520005">)</span>&nbsp;<span class="op" id="4520007">&gt;</span>&nbsp;<span class="num" id="4520009">0</span>&nbsp;<span class="op" id="4520011">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4520015">hs</span><span class="op" id="4520017">.</span><span class="ident" id="4520018">hello</span><span class="op" id="4520023">.</span><span class="ident" id="4520024">ocspStapling</span>&nbsp;<span class="op" id="4520037">=</span>&nbsp;<span class="builtintype" id="4520039">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4520045">}</span><br>
<span class="lineno">320</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4520049">hs</span><span class="op" id="4520051">.</span><span class="ident" id="4520052">hello</span><span class="op" id="4520057">.</span><span class="ident" id="4520058">ticketSupported</span>&nbsp;<span class="op" id="4520074">=</span>&nbsp;<span class="ident" id="4520076">hs</span><span class="op" id="4520078">.</span><span class="ident" id="4520079">clientHello</span><span class="op" id="4520090">.</span><span class="ident" id="4520091">ticketSupported</span>&nbsp;<span class="op" id="4520107">&amp;&amp;</span>&nbsp;<span class="op" id="4520110">!</span><span class="ident" id="4520111">config</span><span class="op" id="4520117">.</span><span class="ident" id="4520118">SessionTicketsDisabled</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4520142">hs</span><span class="op" id="4520144">.</span><span class="ident" id="4520145">hello</span><span class="op" id="4520150">.</span><span class="ident" id="4520151">cipherSuite</span>&nbsp;<span class="op" id="4520163">=</span>&nbsp;<span class="ident" id="4520165">hs</span><span class="op" id="4520167">.</span><span class="ident" id="4520168">suite</span><span class="op" id="4520173">.</span><span class="ident" id="4520174">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4520178">hs</span><span class="op" id="4520180">.</span><span class="ident" id="4520181">finishedHash</span><span class="op" id="4520193">.</span><span class="ident" id="4520194">Write</span><span class="op" id="4520199">(</span><span class="ident" id="4520200">hs</span><span class="op" id="4520202">.</span><span class="ident" id="4520203">hello</span><span class="op" id="4520208">.</span><span class="ident" id="4520209">marshal</span><span class="op" id="4520216">(</span><span class="op" id="4520217">)</span><span class="op" id="4520218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4520221">c</span><span class="op" id="4520222">.</span><span class="ident" id="4520223">writeRecord</span><span class="op" id="4520234">(</span><span class="ident" id="4520235">recordTypeHandshake</span><span class="op" id="4520254">,</span>&nbsp;<span class="ident" id="4520256">hs</span><span class="op" id="4520258">.</span><span class="ident" id="4520259">hello</span><span class="op" id="4520264">.</span><span class="ident" id="4520265">marshal</span><span class="op" id="4520272">(</span><span class="op" id="4520273">)</span><span class="op" id="4520274">)</span><br>
<span class="lineno">325</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4520278">certMsg</span>&nbsp;<span class="op" id="4520286">:=</span>&nbsp;<span class="builtinfunc" id="4520289">new</span><span class="op" id="4520292">(</span><span class="ident" id="4520293">certificateMsg</span><span class="op" id="4520307">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4520310">certMsg</span><span class="op" id="4520317">.</span><span class="ident" id="4520318">certificates</span>&nbsp;<span class="op" id="4520331">=</span>&nbsp;<span class="ident" id="4520333">hs</span><span class="op" id="4520335">.</span><span class="ident" id="4520336">cert</span><span class="op" id="4520340">.</span><span class="ident" id="4520341">Certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4520354">hs</span><span class="op" id="4520356">.</span><span class="ident" id="4520357">finishedHash</span><span class="op" id="4520369">.</span><span class="ident" id="4520370">Write</span><span class="op" id="4520375">(</span><span class="ident" id="4520376">certMsg</span><span class="op" id="4520383">.</span><span class="ident" id="4520384">marshal</span><span class="op" id="4520391">(</span><span class="op" id="4520392">)</span><span class="op" id="4520393">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4520396">c</span><span class="op" id="4520397">.</span><span class="ident" id="4520398">writeRecord</span><span class="op" id="4520409">(</span><span class="ident" id="4520410">recordTypeHandshake</span><span class="op" id="4520429">,</span>&nbsp;<span class="ident" id="4520431">certMsg</span><span class="op" id="4520438">.</span><span class="ident" id="4520439">marshal</span><span class="op" id="4520446">(</span><span class="op" id="4520447">)</span><span class="op" id="4520448">)</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4520452">if</span>&nbsp;<span class="ident" id="4520455">hs</span><span class="op" id="4520457">.</span><span class="ident" id="4520458">hello</span><span class="op" id="4520463">.</span><span class="ident" id="4520464">ocspStapling</span>&nbsp;<span class="op" id="4520477">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4520481">certStatus</span>&nbsp;<span class="op" id="4520492">:=</span>&nbsp;<span class="builtinfunc" id="4520495">new</span><span class="op" id="4520498">(</span><span class="ident" id="4520499">certificateStatusMsg</span><span class="op" id="4520519">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4520523">certStatus</span><span class="op" id="4520533">.</span><span class="ident" id="4520534">statusType</span>&nbsp;<span class="op" id="4520545">=</span>&nbsp;<span class="ident" id="4520547">statusTypeOCSP</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4520564">certStatus</span><span class="op" id="4520574">.</span><span class="ident" id="4520575">response</span>&nbsp;<span class="op" id="4520584">=</span>&nbsp;<span class="ident" id="4520586">hs</span><span class="op" id="4520588">.</span><span class="ident" id="4520589">cert</span><span class="op" id="4520593">.</span><span class="ident" id="4520594">OCSPStaple</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4520607">hs</span><span class="op" id="4520609">.</span><span class="ident" id="4520610">finishedHash</span><span class="op" id="4520622">.</span><span class="ident" id="4520623">Write</span><span class="op" id="4520628">(</span><span class="ident" id="4520629">certStatus</span><span class="op" id="4520639">.</span><span class="ident" id="4520640">marshal</span><span class="op" id="4520647">(</span><span class="op" id="4520648">)</span><span class="op" id="4520649">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4520653">c</span><span class="op" id="4520654">.</span><span class="ident" id="4520655">writeRecord</span><span class="op" id="4520666">(</span><span class="ident" id="4520667">recordTypeHandshake</span><span class="op" id="4520686">,</span>&nbsp;<span class="ident" id="4520688">certStatus</span><span class="op" id="4520698">.</span><span class="ident" id="4520699">marshal</span><span class="op" id="4520706">(</span><span class="op" id="4520707">)</span><span class="op" id="4520708">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4520711">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4520715">keyAgreement</span>&nbsp;<span class="op" id="4520728">:=</span>&nbsp;<span class="ident" id="4520731">hs</span><span class="op" id="4520733">.</span><span class="ident" id="4520734">suite</span><span class="op" id="4520739">.</span><span class="ident" id="4520740">ka</span><span class="op" id="4520742">(</span><span class="ident" id="4520743">c</span><span class="op" id="4520744">.</span><span class="ident" id="4520745">vers</span><span class="op" id="4520749">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4520752">skx</span><span class="op" id="4520755">,</span>&nbsp;<span class="ident" id="4520757">err</span>&nbsp;<span class="op" id="4520761">:=</span>&nbsp;<span class="ident" id="4520764">keyAgreement</span><span class="op" id="4520776">.</span><span class="ident" id="4520777">generateServerKeyExchange</span><span class="op" id="4520802">(</span><span class="ident" id="4520803">config</span><span class="op" id="4520809">,</span>&nbsp;<span class="ident" id="4520811">hs</span><span class="op" id="4520813">.</span><span class="ident" id="4520814">cert</span><span class="op" id="4520818">,</span>&nbsp;<span class="ident" id="4520820">hs</span><span class="op" id="4520822">.</span><span class="ident" id="4520823">clientHello</span><span class="op" id="4520834">,</span>&nbsp;<span class="ident" id="4520836">hs</span><span class="op" id="4520838">.</span><span class="ident" id="4520839">hello</span><span class="op" id="4520844">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4520847">if</span>&nbsp;<span class="ident" id="4520850">err</span>&nbsp;<span class="op" id="4520854">!=</span>&nbsp;<span class="ident" id="4520857">nil</span>&nbsp;<span class="op" id="4520861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4520865">c</span><span class="op" id="4520866">.</span><span class="ident" id="4520867">sendAlert</span><span class="op" id="4520876">(</span><span class="ident" id="4520877">alertHandshakeFailure</span><span class="op" id="4520898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4520902">return</span>&nbsp;<span class="ident" id="4520909">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4520914">}</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4520917">if</span>&nbsp;<span class="ident" id="4520920">skx</span>&nbsp;<span class="op" id="4520924">!=</span>&nbsp;<span class="ident" id="4520927">nil</span>&nbsp;<span class="op" id="4520931">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4520935">hs</span><span class="op" id="4520937">.</span><span class="ident" id="4520938">finishedHash</span><span class="op" id="4520950">.</span><span class="ident" id="4520951">Write</span><span class="op" id="4520956">(</span><span class="ident" id="4520957">skx</span><span class="op" id="4520960">.</span><span class="ident" id="4520961">marshal</span><span class="op" id="4520968">(</span><span class="op" id="4520969">)</span><span class="op" id="4520970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4520974">c</span><span class="op" id="4520975">.</span><span class="ident" id="4520976">writeRecord</span><span class="op" id="4520987">(</span><span class="ident" id="4520988">recordTypeHandshake</span><span class="op" id="4521007">,</span>&nbsp;<span class="ident" id="4521009">skx</span><span class="op" id="4521012">.</span><span class="ident" id="4521013">marshal</span><span class="op" id="4521020">(</span><span class="op" id="4521021">)</span><span class="op" id="4521022">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4521025">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4521029">if</span>&nbsp;<span class="ident" id="4521032">config</span><span class="op" id="4521038">.</span><span class="ident" id="4521039">ClientAuth</span>&nbsp;<span class="op" id="4521050">&gt;=</span>&nbsp;<span class="ident" id="4521053">RequestClientCert</span>&nbsp;<span class="op" id="4521071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4521075">//&nbsp;Request&nbsp;a&nbsp;client&nbsp;certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4521109">certReq</span>&nbsp;<span class="op" id="4521117">:=</span>&nbsp;<span class="builtinfunc" id="4521120">new</span><span class="op" id="4521123">(</span><span class="ident" id="4521124">certificateRequestMsg</span><span class="op" id="4521145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4521149">certReq</span><span class="op" id="4521156">.</span><span class="ident" id="4521157">certificateTypes</span>&nbsp;<span class="op" id="4521174">=</span>&nbsp;<span class="op" id="4521176">[</span><span class="op" id="4521177">]</span><span class="builtintype" id="4521178">byte</span><span class="op" id="4521182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="4521187">byte</span><span class="op" id="4521191">(</span><span class="ident" id="4521192">certTypeRSASign</span><span class="op" id="4521207">)</span><span class="op" id="4521208">,</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtintype" id="4521213">byte</span><span class="op" id="4521217">(</span><span class="ident" id="4521218">certTypeECDSASign</span><span class="op" id="4521235">)</span><span class="op" id="4521236">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4521240">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4521244">if</span>&nbsp;<span class="ident" id="4521247">c</span><span class="op" id="4521248">.</span><span class="ident" id="4521249">vers</span>&nbsp;<span class="op" id="4521254">&gt;=</span>&nbsp;<span class="ident" id="4521257">VersionTLS12</span>&nbsp;<span class="op" id="4521270">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4521275">certReq</span><span class="op" id="4521282">.</span><span class="ident" id="4521283">hasSignatureAndHash</span>&nbsp;<span class="op" id="4521303">=</span>&nbsp;<span class="builtintype" id="4521305">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4521313">certReq</span><span class="op" id="4521320">.</span><span class="ident" id="4521321">signatureAndHashes</span>&nbsp;<span class="op" id="4521340">=</span>&nbsp;<span class="ident" id="4521342">supportedClientCertSignatureAlgorithms</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4521383">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4521388">//&nbsp;An&nbsp;empty&nbsp;list&nbsp;of&nbsp;certificateAuthorities&nbsp;signals&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4521444">//&nbsp;the&nbsp;client&nbsp;that&nbsp;it&nbsp;may&nbsp;send&nbsp;any&nbsp;certificate&nbsp;in&nbsp;response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4521505">//&nbsp;to&nbsp;our&nbsp;request.&nbsp;When&nbsp;we&nbsp;know&nbsp;the&nbsp;CAs&nbsp;we&nbsp;trust,&nbsp;then</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4521562">//&nbsp;we&nbsp;can&nbsp;send&nbsp;them&nbsp;down,&nbsp;so&nbsp;that&nbsp;the&nbsp;client&nbsp;can&nbsp;choose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4521620">//&nbsp;an&nbsp;appropriate&nbsp;certificate&nbsp;to&nbsp;give&nbsp;to&nbsp;us.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4521667">if</span>&nbsp;<span class="ident" id="4521670">config</span><span class="op" id="4521676">.</span><span class="ident" id="4521677">ClientCAs</span>&nbsp;<span class="op" id="4521687">!=</span>&nbsp;<span class="ident" id="4521690">nil</span>&nbsp;<span class="op" id="4521694">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4521699">certReq</span><span class="op" id="4521706">.</span><span class="ident" id="4521707">certificateAuthorities</span>&nbsp;<span class="op" id="4521730">=</span>&nbsp;<span class="ident" id="4521732">config</span><span class="op" id="4521738">.</span><span class="ident" id="4521739">ClientCAs</span><span class="op" id="4521748">.</span><span class="ident" id="4521749">Subjects</span><span class="op" id="4521757">(</span><span class="op" id="4521758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4521762">}</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4521766">hs</span><span class="op" id="4521768">.</span><span class="ident" id="4521769">finishedHash</span><span class="op" id="4521781">.</span><span class="ident" id="4521782">Write</span><span class="op" id="4521787">(</span><span class="ident" id="4521788">certReq</span><span class="op" id="4521795">.</span><span class="ident" id="4521796">marshal</span><span class="op" id="4521803">(</span><span class="op" id="4521804">)</span><span class="op" id="4521805">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4521809">c</span><span class="op" id="4521810">.</span><span class="ident" id="4521811">writeRecord</span><span class="op" id="4521822">(</span><span class="ident" id="4521823">recordTypeHandshake</span><span class="op" id="4521842">,</span>&nbsp;<span class="ident" id="4521844">certReq</span><span class="op" id="4521851">.</span><span class="ident" id="4521852">marshal</span><span class="op" id="4521859">(</span><span class="op" id="4521860">)</span><span class="op" id="4521861">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4521864">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4521868">helloDone</span>&nbsp;<span class="op" id="4521878">:=</span>&nbsp;<span class="builtinfunc" id="4521881">new</span><span class="op" id="4521884">(</span><span class="ident" id="4521885">serverHelloDoneMsg</span><span class="op" id="4521903">)</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4521906">hs</span><span class="op" id="4521908">.</span><span class="ident" id="4521909">finishedHash</span><span class="op" id="4521921">.</span><span class="ident" id="4521922">Write</span><span class="op" id="4521927">(</span><span class="ident" id="4521928">helloDone</span><span class="op" id="4521937">.</span><span class="ident" id="4521938">marshal</span><span class="op" id="4521945">(</span><span class="op" id="4521946">)</span><span class="op" id="4521947">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4521950">c</span><span class="op" id="4521951">.</span><span class="ident" id="4521952">writeRecord</span><span class="op" id="4521963">(</span><span class="ident" id="4521964">recordTypeHandshake</span><span class="op" id="4521983">,</span>&nbsp;<span class="ident" id="4521985">helloDone</span><span class="op" id="4521994">.</span><span class="ident" id="4521995">marshal</span><span class="op" id="4522002">(</span><span class="op" id="4522003">)</span><span class="op" id="4522004">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4522008">var</span>&nbsp;<span class="ident" id="4522012">pub</span>&nbsp;<span class="ident" id="4522016">crypto</span><span class="op" id="4522022">.</span><span class="ident" id="4522023">PublicKey</span>&nbsp;<span class="comment" id="4522033">//&nbsp;public&nbsp;key&nbsp;for&nbsp;client&nbsp;auth,&nbsp;if&nbsp;any</span><br>
<span class="lineno"></span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4522073">msg</span><span class="op" id="4522076">,</span>&nbsp;<span class="ident" id="4522078">err</span>&nbsp;<span class="op" id="4522082">:=</span>&nbsp;<span class="ident" id="4522085">c</span><span class="op" id="4522086">.</span><span class="ident" id="4522087">readHandshake</span><span class="op" id="4522100">(</span><span class="op" id="4522101">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4522104">if</span>&nbsp;<span class="ident" id="4522107">err</span>&nbsp;<span class="op" id="4522111">!=</span>&nbsp;<span class="ident" id="4522114">nil</span>&nbsp;<span class="op" id="4522118">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4522122">return</span>&nbsp;<span class="ident" id="4522129">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4522134">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4522138">var</span>&nbsp;<span class="ident" id="4522142">ok</span>&nbsp;<span class="builtintype" id="4522145">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4522151">//&nbsp;If&nbsp;we&nbsp;requested&nbsp;a&nbsp;client&nbsp;certificate,&nbsp;then&nbsp;the&nbsp;client&nbsp;must&nbsp;send&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4522221">//&nbsp;certificate&nbsp;message,&nbsp;even&nbsp;if&nbsp;it&#39;s&nbsp;empty.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4522266">if</span>&nbsp;<span class="ident" id="4522269">config</span><span class="op" id="4522275">.</span><span class="ident" id="4522276">ClientAuth</span>&nbsp;<span class="op" id="4522287">&gt;=</span>&nbsp;<span class="ident" id="4522290">RequestClientCert</span>&nbsp;<span class="op" id="4522308">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4522312">if</span>&nbsp;<span class="ident" id="4522315">certMsg</span><span class="op" id="4522322">,</span>&nbsp;<span class="ident" id="4522324">ok</span>&nbsp;<span class="op" id="4522327">=</span>&nbsp;<span class="ident" id="4522329">msg</span><span class="op" id="4522332">.</span><span class="op" id="4522333">(</span><span class="op" id="4522334">*</span><span class="ident" id="4522335">certificateMsg</span><span class="op" id="4522349">)</span><span class="op" id="4522350">;</span>&nbsp;<span class="op" id="4522352">!</span><span class="ident" id="4522353">ok</span>&nbsp;<span class="op" id="4522356">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4522361">c</span><span class="op" id="4522362">.</span><span class="ident" id="4522363">sendAlert</span><span class="op" id="4522372">(</span><span class="ident" id="4522373">alertUnexpectedMessage</span><span class="op" id="4522395">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4522400">return</span>&nbsp;<span class="ident" id="4522407">unexpectedMessageError</span><span class="op" id="4522429">(</span><span class="ident" id="4522430">certMsg</span><span class="op" id="4522437">,</span>&nbsp;<span class="ident" id="4522439">msg</span><span class="op" id="4522442">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4522446">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4522450">hs</span><span class="op" id="4522452">.</span><span class="ident" id="4522453">finishedHash</span><span class="op" id="4522465">.</span><span class="ident" id="4522466">Write</span><span class="op" id="4522471">(</span><span class="ident" id="4522472">certMsg</span><span class="op" id="4522479">.</span><span class="ident" id="4522480">marshal</span><span class="op" id="4522487">(</span><span class="op" id="4522488">)</span><span class="op" id="4522489">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4522494">if</span>&nbsp;<span class="builtinfunc" id="4522497">len</span><span class="op" id="4522500">(</span><span class="ident" id="4522501">certMsg</span><span class="op" id="4522508">.</span><span class="ident" id="4522509">certificates</span><span class="op" id="4522521">)</span>&nbsp;<span class="op" id="4522523">==</span>&nbsp;<span class="num" id="4522526">0</span>&nbsp;<span class="op" id="4522528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4522533">//&nbsp;The&nbsp;client&nbsp;didn&#39;t&nbsp;actually&nbsp;send&nbsp;a&nbsp;certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4522585">switch</span>&nbsp;<span class="ident" id="4522592">config</span><span class="op" id="4522598">.</span><span class="ident" id="4522599">ClientAuth</span>&nbsp;<span class="op" id="4522610">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4522615">case</span>&nbsp;<span class="ident" id="4522620">RequireAnyClientCert</span><span class="op" id="4522640">,</span>&nbsp;<span class="ident" id="4522642">RequireAndVerifyClientCert</span><span class="op" id="4522668">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4522674">c</span><span class="op" id="4522675">.</span><span class="ident" id="4522676">sendAlert</span><span class="op" id="4522685">(</span><span class="ident" id="4522686">alertBadCertificate</span><span class="op" id="4522705">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4522711">return</span>&nbsp;<span class="ident" id="4522718">errors</span><span class="op" id="4522724">.</span><span class="ident" id="4522725">New</span><span class="op" id="4522728">(</span><span class="string" id="4522729">&#34;tls:&nbsp;client&nbsp;didn&#39;t&nbsp;provide&nbsp;a&nbsp;certificate&#34;</span><span class="op" id="4522771">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4522776">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4522780">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4522785">pub</span><span class="op" id="4522788">,</span>&nbsp;<span class="ident" id="4522790">err</span>&nbsp;<span class="op" id="4522794">=</span>&nbsp;<span class="ident" id="4522796">hs</span><span class="op" id="4522798">.</span><span class="ident" id="4522799">processCertsFromClient</span><span class="op" id="4522821">(</span><span class="ident" id="4522822">certMsg</span><span class="op" id="4522829">.</span><span class="ident" id="4522830">certificates</span><span class="op" id="4522842">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4522846">if</span>&nbsp;<span class="ident" id="4522849">err</span>&nbsp;<span class="op" id="4522853">!=</span>&nbsp;<span class="ident" id="4522856">nil</span>&nbsp;<span class="op" id="4522860">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4522865">return</span>&nbsp;<span class="ident" id="4522872">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4522878">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4522883">msg</span><span class="op" id="4522886">,</span>&nbsp;<span class="ident" id="4522888">err</span>&nbsp;<span class="op" id="4522892">=</span>&nbsp;<span class="ident" id="4522894">c</span><span class="op" id="4522895">.</span><span class="ident" id="4522896">readHandshake</span><span class="op" id="4522909">(</span><span class="op" id="4522910">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4522914">if</span>&nbsp;<span class="ident" id="4522917">err</span>&nbsp;<span class="op" id="4522921">!=</span>&nbsp;<span class="ident" id="4522924">nil</span>&nbsp;<span class="op" id="4522928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4522933">return</span>&nbsp;<span class="ident" id="4522940">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4522946">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4522949">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4522953">//&nbsp;Get&nbsp;client&nbsp;key&nbsp;exchange</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4522981">ckx</span><span class="op" id="4522984">,</span>&nbsp;<span class="ident" id="4522986">ok</span>&nbsp;<span class="op" id="4522989">:=</span>&nbsp;<span class="ident" id="4522992">msg</span><span class="op" id="4522995">.</span><span class="op" id="4522996">(</span><span class="op" id="4522997">*</span><span class="ident" id="4522998">clientKeyExchangeMsg</span><span class="op" id="4523018">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4523021">if</span>&nbsp;<span class="op" id="4523024">!</span><span class="ident" id="4523025">ok</span>&nbsp;<span class="op" id="4523028">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4523032">c</span><span class="op" id="4523033">.</span><span class="ident" id="4523034">sendAlert</span><span class="op" id="4523043">(</span><span class="ident" id="4523044">alertUnexpectedMessage</span><span class="op" id="4523066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4523070">return</span>&nbsp;<span class="ident" id="4523077">unexpectedMessageError</span><span class="op" id="4523099">(</span><span class="ident" id="4523100">ckx</span><span class="op" id="4523103">,</span>&nbsp;<span class="ident" id="4523105">msg</span><span class="op" id="4523108">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4523111">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4523114">hs</span><span class="op" id="4523116">.</span><span class="ident" id="4523117">finishedHash</span><span class="op" id="4523129">.</span><span class="ident" id="4523130">Write</span><span class="op" id="4523135">(</span><span class="ident" id="4523136">ckx</span><span class="op" id="4523139">.</span><span class="ident" id="4523140">marshal</span><span class="op" id="4523147">(</span><span class="op" id="4523148">)</span><span class="op" id="4523149">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4523153">//&nbsp;If&nbsp;we&nbsp;received&nbsp;a&nbsp;client&nbsp;cert&nbsp;in&nbsp;response&nbsp;to&nbsp;our&nbsp;certificate&nbsp;request&nbsp;message,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4523234">//&nbsp;the&nbsp;client&nbsp;will&nbsp;send&nbsp;us&nbsp;a&nbsp;certificateVerifyMsg&nbsp;immediately&nbsp;after&nbsp;the</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4523307">//&nbsp;clientKeyExchangeMsg.&nbsp;&nbsp;This&nbsp;message&nbsp;is&nbsp;a&nbsp;digest&nbsp;of&nbsp;all&nbsp;preceding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4523376">//&nbsp;handshake-layer&nbsp;messages&nbsp;that&nbsp;is&nbsp;signed&nbsp;using&nbsp;the&nbsp;private&nbsp;key&nbsp;corresponding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4523456">//&nbsp;to&nbsp;the&nbsp;client&#39;s&nbsp;certificate.&nbsp;This&nbsp;allows&nbsp;us&nbsp;to&nbsp;verify&nbsp;that&nbsp;the&nbsp;client&nbsp;is&nbsp;in</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4523536">//&nbsp;possession&nbsp;of&nbsp;the&nbsp;private&nbsp;key&nbsp;of&nbsp;the&nbsp;certificate.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4523590">if</span>&nbsp;<span class="builtinfunc" id="4523593">len</span><span class="op" id="4523596">(</span><span class="ident" id="4523597">c</span><span class="op" id="4523598">.</span><span class="ident" id="4523599">peerCertificates</span><span class="op" id="4523615">)</span>&nbsp;<span class="op" id="4523617">&gt;</span>&nbsp;<span class="num" id="4523619">0</span>&nbsp;<span class="op" id="4523621">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4523625">msg</span><span class="op" id="4523628">,</span>&nbsp;<span class="ident" id="4523630">err</span>&nbsp;<span class="op" id="4523634">=</span>&nbsp;<span class="ident" id="4523636">c</span><span class="op" id="4523637">.</span><span class="ident" id="4523638">readHandshake</span><span class="op" id="4523651">(</span><span class="op" id="4523652">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4523656">if</span>&nbsp;<span class="ident" id="4523659">err</span>&nbsp;<span class="op" id="4523663">!=</span>&nbsp;<span class="ident" id="4523666">nil</span>&nbsp;<span class="op" id="4523670">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4523675">return</span>&nbsp;<span class="ident" id="4523682">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4523688">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4523692">certVerify</span><span class="op" id="4523702">,</span>&nbsp;<span class="ident" id="4523704">ok</span>&nbsp;<span class="op" id="4523707">:=</span>&nbsp;<span class="ident" id="4523710">msg</span><span class="op" id="4523713">.</span><span class="op" id="4523714">(</span><span class="op" id="4523715">*</span><span class="ident" id="4523716">certificateVerifyMsg</span><span class="op" id="4523736">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4523740">if</span>&nbsp;<span class="op" id="4523743">!</span><span class="ident" id="4523744">ok</span>&nbsp;<span class="op" id="4523747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4523752">c</span><span class="op" id="4523753">.</span><span class="ident" id="4523754">sendAlert</span><span class="op" id="4523763">(</span><span class="ident" id="4523764">alertUnexpectedMessage</span><span class="op" id="4523786">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4523791">return</span>&nbsp;<span class="ident" id="4523798">unexpectedMessageError</span><span class="op" id="4523820">(</span><span class="ident" id="4523821">certVerify</span><span class="op" id="4523831">,</span>&nbsp;<span class="ident" id="4523833">msg</span><span class="op" id="4523836">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4523840">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4523845">switch</span>&nbsp;<span class="ident" id="4523852">key</span>&nbsp;<span class="op" id="4523856">:=</span>&nbsp;<span class="ident" id="4523859">pub</span><span class="op" id="4523862">.</span><span class="op" id="4523863">(</span><span class="keyword" id="4523864">type</span><span class="op" id="4523868">)</span>&nbsp;<span class="op" id="4523870">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4523874">case</span>&nbsp;<span class="op" id="4523879">*</span><span class="ident" id="4523880">ecdsa</span><span class="op" id="4523885">.</span><span class="ident" id="4523886">PublicKey</span><span class="op" id="4523895">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4523900">ecdsaSig</span>&nbsp;<span class="op" id="4523909">:=</span>&nbsp;<span class="builtinfunc" id="4523912">new</span><span class="op" id="4523915">(</span><span class="ident" id="4523916">ecdsaSignature</span><span class="op" id="4523930">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4523935">if</span>&nbsp;<span class="ident" id="4523938">_</span><span class="op" id="4523939">,</span>&nbsp;<span class="ident" id="4523941">err</span>&nbsp;<span class="op" id="4523945">=</span>&nbsp;<span class="ident" id="4523947">asn1</span><span class="op" id="4523951">.</span><span class="ident" id="4523952">Unmarshal</span><span class="op" id="4523961">(</span><span class="ident" id="4523962">certVerify</span><span class="op" id="4523972">.</span><span class="ident" id="4523973">signature</span><span class="op" id="4523982">,</span>&nbsp;<span class="ident" id="4523984">ecdsaSig</span><span class="op" id="4523992">)</span><span class="op" id="4523993">;</span>&nbsp;<span class="ident" id="4523995">err</span>&nbsp;<span class="op" id="4523999">!=</span>&nbsp;<span class="ident" id="4524002">nil</span>&nbsp;<span class="op" id="4524006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4524012">break</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4524021">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4524026">if</span>&nbsp;<span class="ident" id="4524029">ecdsaSig</span><span class="op" id="4524037">.</span><span class="ident" id="4524038">R</span><span class="op" id="4524039">.</span><span class="ident" id="4524040">Sign</span><span class="op" id="4524044">(</span><span class="op" id="4524045">)</span>&nbsp;<span class="op" id="4524047">&lt;=</span>&nbsp;<span class="num" id="4524050">0</span>&nbsp;<span class="op" id="4524052">||</span>&nbsp;<span class="ident" id="4524055">ecdsaSig</span><span class="op" id="4524063">.</span><span class="ident" id="4524064">S</span><span class="op" id="4524065">.</span><span class="ident" id="4524066">Sign</span><span class="op" id="4524070">(</span><span class="op" id="4524071">)</span>&nbsp;<span class="op" id="4524073">&lt;=</span>&nbsp;<span class="num" id="4524076">0</span>&nbsp;<span class="op" id="4524078">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4524084">err</span>&nbsp;<span class="op" id="4524088">=</span>&nbsp;<span class="ident" id="4524090">errors</span><span class="op" id="4524096">.</span><span class="ident" id="4524097">New</span><span class="op" id="4524100">(</span><span class="string" id="4524101">&#34;ECDSA&nbsp;signature&nbsp;contained&nbsp;zero&nbsp;or&nbsp;negative&nbsp;values&#34;</span><span class="op" id="4524152">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4524158">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4524167">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4524172">digest</span><span class="op" id="4524178">,</span>&nbsp;<span class="ident" id="4524180">_</span><span class="op" id="4524181">,</span>&nbsp;<span class="ident" id="4524183">_</span>&nbsp;<span class="op" id="4524185">:=</span>&nbsp;<span class="ident" id="4524188">hs</span><span class="op" id="4524190">.</span><span class="ident" id="4524191">finishedHash</span><span class="op" id="4524203">.</span><span class="ident" id="4524204">hashForClientCertificate</span><span class="op" id="4524228">(</span><span class="ident" id="4524229">signatureECDSA</span><span class="op" id="4524243">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4524248">if</span>&nbsp;<span class="op" id="4524251">!</span><span class="ident" id="4524252">ecdsa</span><span class="op" id="4524257">.</span><span class="ident" id="4524258">Verify</span><span class="op" id="4524264">(</span><span class="ident" id="4524265">key</span><span class="op" id="4524268">,</span>&nbsp;<span class="ident" id="4524270">digest</span><span class="op" id="4524276">,</span>&nbsp;<span class="ident" id="4524278">ecdsaSig</span><span class="op" id="4524286">.</span><span class="ident" id="4524287">R</span><span class="op" id="4524288">,</span>&nbsp;<span class="ident" id="4524290">ecdsaSig</span><span class="op" id="4524298">.</span><span class="ident" id="4524299">S</span><span class="op" id="4524300">)</span>&nbsp;<span class="op" id="4524302">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4524308">err</span>&nbsp;<span class="op" id="4524312">=</span>&nbsp;<span class="ident" id="4524314">errors</span><span class="op" id="4524320">.</span><span class="ident" id="4524321">New</span><span class="op" id="4524324">(</span><span class="string" id="4524325">&#34;ECDSA&nbsp;verification&nbsp;failure&#34;</span><span class="op" id="4524353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4524359">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4524368">}</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4524372">case</span>&nbsp;<span class="op" id="4524377">*</span><span class="ident" id="4524378">rsa</span><span class="op" id="4524381">.</span><span class="ident" id="4524382">PublicKey</span><span class="op" id="4524391">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4524396">digest</span><span class="op" id="4524402">,</span>&nbsp;<span class="ident" id="4524404">hashFunc</span><span class="op" id="4524412">,</span>&nbsp;<span class="ident" id="4524414">_</span>&nbsp;<span class="op" id="4524416">:=</span>&nbsp;<span class="ident" id="4524419">hs</span><span class="op" id="4524421">.</span><span class="ident" id="4524422">finishedHash</span><span class="op" id="4524434">.</span><span class="ident" id="4524435">hashForClientCertificate</span><span class="op" id="4524459">(</span><span class="ident" id="4524460">signatureRSA</span><span class="op" id="4524472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4524477">err</span>&nbsp;<span class="op" id="4524481">=</span>&nbsp;<span class="ident" id="4524483">rsa</span><span class="op" id="4524486">.</span><span class="ident" id="4524487">VerifyPKCS1v15</span><span class="op" id="4524501">(</span><span class="ident" id="4524502">key</span><span class="op" id="4524505">,</span>&nbsp;<span class="ident" id="4524507">hashFunc</span><span class="op" id="4524515">,</span>&nbsp;<span class="ident" id="4524517">digest</span><span class="op" id="4524523">,</span>&nbsp;<span class="ident" id="4524525">certVerify</span><span class="op" id="4524535">.</span><span class="ident" id="4524536">signature</span><span class="op" id="4524545">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4524549">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4524553">if</span>&nbsp;<span class="ident" id="4524556">err</span>&nbsp;<span class="op" id="4524560">!=</span>&nbsp;<span class="ident" id="4524563">nil</span>&nbsp;<span class="op" id="4524567">{</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4524572">c</span><span class="op" id="4524573">.</span><span class="ident" id="4524574">sendAlert</span><span class="op" id="4524583">(</span><span class="ident" id="4524584">alertBadCertificate</span><span class="op" id="4524603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4524608">return</span>&nbsp;<span class="ident" id="4524615">errors</span><span class="op" id="4524621">.</span><span class="ident" id="4524622">New</span><span class="op" id="4524625">(</span><span class="string" id="4524626">&#34;could&nbsp;not&nbsp;validate&nbsp;signature&nbsp;of&nbsp;connection&nbsp;nonces:&nbsp;&#34;</span>&nbsp;<span class="op" id="4524680">+</span>&nbsp;<span class="ident" id="4524682">err</span><span class="op" id="4524685">.</span><span class="ident" id="4524686">Error</span><span class="op" id="4524691">(</span><span class="op" id="4524692">)</span><span class="op" id="4524693">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4524697">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4524702">hs</span><span class="op" id="4524704">.</span><span class="ident" id="4524705">finishedHash</span><span class="op" id="4524717">.</span><span class="ident" id="4524718">Write</span><span class="op" id="4524723">(</span><span class="ident" id="4524724">certVerify</span><span class="op" id="4524734">.</span><span class="ident" id="4524735">marshal</span><span class="op" id="4524742">(</span><span class="op" id="4524743">)</span><span class="op" id="4524744">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4524747">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4524751">preMasterSecret</span><span class="op" id="4524766">,</span>&nbsp;<span class="ident" id="4524768">err</span>&nbsp;<span class="op" id="4524772">:=</span>&nbsp;<span class="ident" id="4524775">keyAgreement</span><span class="op" id="4524787">.</span><span class="ident" id="4524788">processClientKeyExchange</span><span class="op" id="4524812">(</span><span class="ident" id="4524813">config</span><span class="op" id="4524819">,</span>&nbsp;<span class="ident" id="4524821">hs</span><span class="op" id="4524823">.</span><span class="ident" id="4524824">cert</span><span class="op" id="4524828">,</span>&nbsp;<span class="ident" id="4524830">ckx</span><span class="op" id="4524833">,</span>&nbsp;<span class="ident" id="4524835">c</span><span class="op" id="4524836">.</span><span class="ident" id="4524837">vers</span><span class="op" id="4524841">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4524844">if</span>&nbsp;<span class="ident" id="4524847">err</span>&nbsp;<span class="op" id="4524851">!=</span>&nbsp;<span class="ident" id="4524854">nil</span>&nbsp;<span class="op" id="4524858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4524862">c</span><span class="op" id="4524863">.</span><span class="ident" id="4524864">sendAlert</span><span class="op" id="4524873">(</span><span class="ident" id="4524874">alertHandshakeFailure</span><span class="op" id="4524895">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4524899">return</span>&nbsp;<span class="ident" id="4524906">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4524911">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4524914">hs</span><span class="op" id="4524916">.</span><span class="ident" id="4524917">masterSecret</span>&nbsp;<span class="op" id="4524930">=</span>&nbsp;<span class="ident" id="4524932">masterFromPreMasterSecret</span><span class="op" id="4524957">(</span><span class="ident" id="4524958">c</span><span class="op" id="4524959">.</span><span class="ident" id="4524960">vers</span><span class="op" id="4524964">,</span>&nbsp;<span class="ident" id="4524966">preMasterSecret</span><span class="op" id="4524981">,</span>&nbsp;<span class="ident" id="4524983">hs</span><span class="op" id="4524985">.</span><span class="ident" id="4524986">clientHello</span><span class="op" id="4524997">.</span><span class="ident" id="4524998">random</span><span class="op" id="4525004">,</span>&nbsp;<span class="ident" id="4525006">hs</span><span class="op" id="4525008">.</span><span class="ident" id="4525009">hello</span><span class="op" id="4525014">.</span><span class="ident" id="4525015">random</span><span class="op" id="4525021">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4525025">return</span>&nbsp;<span class="ident" id="4525032">nil</span><br>
<span class="lineno">475</span><span class="op" id="4525036">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4525039">func</span>&nbsp;<span class="op" id="4525044">(</span><span class="ident" id="4525045">hs</span>&nbsp;<span class="op" id="4525048">*</span><span class="ident" id="4525049">serverHandshakeState</span><span class="op" id="4525069">)</span>&nbsp;<span class="ident" id="4525071">establishKeys</span><span class="op" id="4525084">(</span><span class="op" id="4525085">)</span>&nbsp;<span class="builtintype" id="4525087">error</span>&nbsp;<span class="op" id="4525093">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4525096">c</span>&nbsp;<span class="op" id="4525098">:=</span>&nbsp;<span class="ident" id="4525101">hs</span><span class="op" id="4525103">.</span><span class="ident" id="4525104">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4525108">clientMAC</span><span class="op" id="4525117">,</span>&nbsp;<span class="ident" id="4525119">serverMAC</span><span class="op" id="4525128">,</span>&nbsp;<span class="ident" id="4525130">clientKey</span><span class="op" id="4525139">,</span>&nbsp;<span class="ident" id="4525141">serverKey</span><span class="op" id="4525150">,</span>&nbsp;<span class="ident" id="4525152">clientIV</span><span class="op" id="4525160">,</span>&nbsp;<span class="ident" id="4525162">serverIV</span>&nbsp;<span class="op" id="4525171">:=</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4525176">keysFromMasterSecret</span><span class="op" id="4525196">(</span><span class="ident" id="4525197">c</span><span class="op" id="4525198">.</span><span class="ident" id="4525199">vers</span><span class="op" id="4525203">,</span>&nbsp;<span class="ident" id="4525205">hs</span><span class="op" id="4525207">.</span><span class="ident" id="4525208">masterSecret</span><span class="op" id="4525220">,</span>&nbsp;<span class="ident" id="4525222">hs</span><span class="op" id="4525224">.</span><span class="ident" id="4525225">clientHello</span><span class="op" id="4525236">.</span><span class="ident" id="4525237">random</span><span class="op" id="4525243">,</span>&nbsp;<span class="ident" id="4525245">hs</span><span class="op" id="4525247">.</span><span class="ident" id="4525248">hello</span><span class="op" id="4525253">.</span><span class="ident" id="4525254">random</span><span class="op" id="4525260">,</span>&nbsp;<span class="ident" id="4525262">hs</span><span class="op" id="4525264">.</span><span class="ident" id="4525265">suite</span><span class="op" id="4525270">.</span><span class="ident" id="4525271">macLen</span><span class="op" id="4525277">,</span>&nbsp;<span class="ident" id="4525279">hs</span><span class="op" id="4525281">.</span><span class="ident" id="4525282">suite</span><span class="op" id="4525287">.</span><span class="ident" id="4525288">keyLen</span><span class="op" id="4525294">,</span>&nbsp;<span class="ident" id="4525296">hs</span><span class="op" id="4525298">.</span><span class="ident" id="4525299">suite</span><span class="op" id="4525304">.</span><span class="ident" id="4525305">ivLen</span><span class="op" id="4525310">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4525314">var</span>&nbsp;<span class="ident" id="4525318">clientCipher</span><span class="op" id="4525330">,</span>&nbsp;<span class="ident" id="4525332">serverCipher</span>&nbsp;<span class="keyword" id="4525345">interface</span><span class="op" id="4525354">{</span><span class="op" id="4525355">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4525358">var</span>&nbsp;<span class="ident" id="4525362">clientHash</span><span class="op" id="4525372">,</span>&nbsp;<span class="ident" id="4525374">serverHash</span>&nbsp;<span class="ident" id="4525385">macFunction</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4525399">if</span>&nbsp;<span class="ident" id="4525402">hs</span><span class="op" id="4525404">.</span><span class="ident" id="4525405">suite</span><span class="op" id="4525410">.</span><span class="ident" id="4525411">aead</span>&nbsp;<span class="op" id="4525416">==</span>&nbsp;<span class="ident" id="4525419">nil</span>&nbsp;<span class="op" id="4525423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4525427">clientCipher</span>&nbsp;<span class="op" id="4525440">=</span>&nbsp;<span class="ident" id="4525442">hs</span><span class="op" id="4525444">.</span><span class="ident" id="4525445">suite</span><span class="op" id="4525450">.</span><span class="ident" id="4525451">cipher</span><span class="op" id="4525457">(</span><span class="ident" id="4525458">clientKey</span><span class="op" id="4525467">,</span>&nbsp;<span class="ident" id="4525469">clientIV</span><span class="op" id="4525477">,</span>&nbsp;<span class="builtintype" id="4525479">true</span>&nbsp;<span class="comment" id="4525484">/*&nbsp;for&nbsp;reading&nbsp;*/</span><span class="op" id="4525501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4525505">clientHash</span>&nbsp;<span class="op" id="4525516">=</span>&nbsp;<span class="ident" id="4525518">hs</span><span class="op" id="4525520">.</span><span class="ident" id="4525521">suite</span><span class="op" id="4525526">.</span><span class="ident" id="4525527">mac</span><span class="op" id="4525530">(</span><span class="ident" id="4525531">c</span><span class="op" id="4525532">.</span><span class="ident" id="4525533">vers</span><span class="op" id="4525537">,</span>&nbsp;<span class="ident" id="4525539">clientMAC</span><span class="op" id="4525548">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4525552">serverCipher</span>&nbsp;<span class="op" id="4525565">=</span>&nbsp;<span class="ident" id="4525567">hs</span><span class="op" id="4525569">.</span><span class="ident" id="4525570">suite</span><span class="op" id="4525575">.</span><span class="ident" id="4525576">cipher</span><span class="op" id="4525582">(</span><span class="ident" id="4525583">serverKey</span><span class="op" id="4525592">,</span>&nbsp;<span class="ident" id="4525594">serverIV</span><span class="op" id="4525602">,</span>&nbsp;<span class="builtintype" id="4525604">false</span>&nbsp;<span class="comment" id="4525610">/*&nbsp;not&nbsp;for&nbsp;reading&nbsp;*/</span><span class="op" id="4525631">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4525635">serverHash</span>&nbsp;<span class="op" id="4525646">=</span>&nbsp;<span class="ident" id="4525648">hs</span><span class="op" id="4525650">.</span><span class="ident" id="4525651">suite</span><span class="op" id="4525656">.</span><span class="ident" id="4525657">mac</span><span class="op" id="4525660">(</span><span class="ident" id="4525661">c</span><span class="op" id="4525662">.</span><span class="ident" id="4525663">vers</span><span class="op" id="4525667">,</span>&nbsp;<span class="ident" id="4525669">serverMAC</span><span class="op" id="4525678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4525681">}</span>&nbsp;<span class="keyword" id="4525683">else</span>&nbsp;<span class="op" id="4525688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4525692">clientCipher</span>&nbsp;<span class="op" id="4525705">=</span>&nbsp;<span class="ident" id="4525707">hs</span><span class="op" id="4525709">.</span><span class="ident" id="4525710">suite</span><span class="op" id="4525715">.</span><span class="ident" id="4525716">aead</span><span class="op" id="4525720">(</span><span class="ident" id="4525721">clientKey</span><span class="op" id="4525730">,</span>&nbsp;<span class="ident" id="4525732">clientIV</span><span class="op" id="4525740">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4525744">serverCipher</span>&nbsp;<span class="op" id="4525757">=</span>&nbsp;<span class="ident" id="4525759">hs</span><span class="op" id="4525761">.</span><span class="ident" id="4525762">suite</span><span class="op" id="4525767">.</span><span class="ident" id="4525768">aead</span><span class="op" id="4525772">(</span><span class="ident" id="4525773">serverKey</span><span class="op" id="4525782">,</span>&nbsp;<span class="ident" id="4525784">serverIV</span><span class="op" id="4525792">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4525795">}</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4525799">c</span><span class="op" id="4525800">.</span><span class="ident" id="4525801">in</span><span class="op" id="4525803">.</span><span class="ident" id="4525804">prepareCipherSpec</span><span class="op" id="4525821">(</span><span class="ident" id="4525822">c</span><span class="op" id="4525823">.</span><span class="ident" id="4525824">vers</span><span class="op" id="4525828">,</span>&nbsp;<span class="ident" id="4525830">clientCipher</span><span class="op" id="4525842">,</span>&nbsp;<span class="ident" id="4525844">clientHash</span><span class="op" id="4525854">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4525857">c</span><span class="op" id="4525858">.</span><span class="ident" id="4525859">out</span><span class="op" id="4525862">.</span><span class="ident" id="4525863">prepareCipherSpec</span><span class="op" id="4525880">(</span><span class="ident" id="4525881">c</span><span class="op" id="4525882">.</span><span class="ident" id="4525883">vers</span><span class="op" id="4525887">,</span>&nbsp;<span class="ident" id="4525889">serverCipher</span><span class="op" id="4525901">,</span>&nbsp;<span class="ident" id="4525903">serverHash</span><span class="op" id="4525913">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4525917">return</span>&nbsp;<span class="ident" id="4525924">nil</span><br>
<span class="lineno">500</span><span class="op" id="4525928">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4525931">func</span>&nbsp;<span class="op" id="4525936">(</span><span class="ident" id="4525937">hs</span>&nbsp;<span class="op" id="4525940">*</span><span class="ident" id="4525941">serverHandshakeState</span><span class="op" id="4525961">)</span>&nbsp;<span class="ident" id="4525963">readFinished</span><span class="op" id="4525975">(</span><span class="ident" id="4525976">out</span>&nbsp;<span class="op" id="4525980">[</span><span class="op" id="4525981">]</span><span class="builtintype" id="4525982">byte</span><span class="op" id="4525986">)</span>&nbsp;<span class="builtintype" id="4525988">error</span>&nbsp;<span class="op" id="4525994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4525997">c</span>&nbsp;<span class="op" id="4525999">:=</span>&nbsp;<span class="ident" id="4526002">hs</span><span class="op" id="4526004">.</span><span class="ident" id="4526005">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4526009">c</span><span class="op" id="4526010">.</span><span class="ident" id="4526011">readRecord</span><span class="op" id="4526021">(</span><span class="ident" id="4526022">recordTypeChangeCipherSpec</span><span class="op" id="4526048">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4526051">if</span>&nbsp;<span class="ident" id="4526054">err</span>&nbsp;<span class="op" id="4526058">:=</span>&nbsp;<span class="ident" id="4526061">c</span><span class="op" id="4526062">.</span><span class="ident" id="4526063">in</span><span class="op" id="4526065">.</span><span class="builtintype" id="4526066">error</span><span class="op" id="4526071">(</span><span class="op" id="4526072">)</span><span class="op" id="4526073">;</span>&nbsp;<span class="ident" id="4526075">err</span>&nbsp;<span class="op" id="4526079">!=</span>&nbsp;<span class="ident" id="4526082">nil</span>&nbsp;<span class="op" id="4526086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4526090">return</span>&nbsp;<span class="ident" id="4526097">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4526102">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4526106">if</span>&nbsp;<span class="ident" id="4526109">hs</span><span class="op" id="4526111">.</span><span class="ident" id="4526112">hello</span><span class="op" id="4526117">.</span><span class="ident" id="4526118">nextProtoNeg</span>&nbsp;<span class="op" id="4526131">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4526135">msg</span><span class="op" id="4526138">,</span>&nbsp;<span class="ident" id="4526140">err</span>&nbsp;<span class="op" id="4526144">:=</span>&nbsp;<span class="ident" id="4526147">c</span><span class="op" id="4526148">.</span><span class="ident" id="4526149">readHandshake</span><span class="op" id="4526162">(</span><span class="op" id="4526163">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4526167">if</span>&nbsp;<span class="ident" id="4526170">err</span>&nbsp;<span class="op" id="4526174">!=</span>&nbsp;<span class="ident" id="4526177">nil</span>&nbsp;<span class="op" id="4526181">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4526186">return</span>&nbsp;<span class="ident" id="4526193">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4526199">}</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4526203">nextProto</span><span class="op" id="4526212">,</span>&nbsp;<span class="ident" id="4526214">ok</span>&nbsp;<span class="op" id="4526217">:=</span>&nbsp;<span class="ident" id="4526220">msg</span><span class="op" id="4526223">.</span><span class="op" id="4526224">(</span><span class="op" id="4526225">*</span><span class="ident" id="4526226">nextProtoMsg</span><span class="op" id="4526238">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4526242">if</span>&nbsp;<span class="op" id="4526245">!</span><span class="ident" id="4526246">ok</span>&nbsp;<span class="op" id="4526249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4526254">c</span><span class="op" id="4526255">.</span><span class="ident" id="4526256">sendAlert</span><span class="op" id="4526265">(</span><span class="ident" id="4526266">alertUnexpectedMessage</span><span class="op" id="4526288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4526293">return</span>&nbsp;<span class="ident" id="4526300">unexpectedMessageError</span><span class="op" id="4526322">(</span><span class="ident" id="4526323">nextProto</span><span class="op" id="4526332">,</span>&nbsp;<span class="ident" id="4526334">msg</span><span class="op" id="4526337">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4526341">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4526345">hs</span><span class="op" id="4526347">.</span><span class="ident" id="4526348">finishedHash</span><span class="op" id="4526360">.</span><span class="ident" id="4526361">Write</span><span class="op" id="4526366">(</span><span class="ident" id="4526367">nextProto</span><span class="op" id="4526376">.</span><span class="ident" id="4526377">marshal</span><span class="op" id="4526384">(</span><span class="op" id="4526385">)</span><span class="op" id="4526386">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4526390">c</span><span class="op" id="4526391">.</span><span class="ident" id="4526392">clientProtocol</span>&nbsp;<span class="op" id="4526407">=</span>&nbsp;<span class="ident" id="4526409">nextProto</span><span class="op" id="4526418">.</span><span class="ident" id="4526419">proto</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4526426">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4526430">msg</span><span class="op" id="4526433">,</span>&nbsp;<span class="ident" id="4526435">err</span>&nbsp;<span class="op" id="4526439">:=</span>&nbsp;<span class="ident" id="4526442">c</span><span class="op" id="4526443">.</span><span class="ident" id="4526444">readHandshake</span><span class="op" id="4526457">(</span><span class="op" id="4526458">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4526461">if</span>&nbsp;<span class="ident" id="4526464">err</span>&nbsp;<span class="op" id="4526468">!=</span>&nbsp;<span class="ident" id="4526471">nil</span>&nbsp;<span class="op" id="4526475">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4526479">return</span>&nbsp;<span class="ident" id="4526486">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4526491">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4526494">clientFinished</span><span class="op" id="4526508">,</span>&nbsp;<span class="ident" id="4526510">ok</span>&nbsp;<span class="op" id="4526513">:=</span>&nbsp;<span class="ident" id="4526516">msg</span><span class="op" id="4526519">.</span><span class="op" id="4526520">(</span><span class="op" id="4526521">*</span><span class="ident" id="4526522">finishedMsg</span><span class="op" id="4526533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4526536">if</span>&nbsp;<span class="op" id="4526539">!</span><span class="ident" id="4526540">ok</span>&nbsp;<span class="op" id="4526543">{</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4526547">c</span><span class="op" id="4526548">.</span><span class="ident" id="4526549">sendAlert</span><span class="op" id="4526558">(</span><span class="ident" id="4526559">alertUnexpectedMessage</span><span class="op" id="4526581">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4526585">return</span>&nbsp;<span class="ident" id="4526592">unexpectedMessageError</span><span class="op" id="4526614">(</span><span class="ident" id="4526615">clientFinished</span><span class="op" id="4526629">,</span>&nbsp;<span class="ident" id="4526631">msg</span><span class="op" id="4526634">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4526637">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4526641">verify</span>&nbsp;<span class="op" id="4526648">:=</span>&nbsp;<span class="ident" id="4526651">hs</span><span class="op" id="4526653">.</span><span class="ident" id="4526654">finishedHash</span><span class="op" id="4526666">.</span><span class="ident" id="4526667">clientSum</span><span class="op" id="4526676">(</span><span class="ident" id="4526677">hs</span><span class="op" id="4526679">.</span><span class="ident" id="4526680">masterSecret</span><span class="op" id="4526692">)</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4526695">if</span>&nbsp;<span class="builtinfunc" id="4526698">len</span><span class="op" id="4526701">(</span><span class="ident" id="4526702">verify</span><span class="op" id="4526708">)</span>&nbsp;<span class="op" id="4526710">!=</span>&nbsp;<span class="builtinfunc" id="4526713">len</span><span class="op" id="4526716">(</span><span class="ident" id="4526717">clientFinished</span><span class="op" id="4526731">.</span><span class="ident" id="4526732">verifyData</span><span class="op" id="4526742">)</span>&nbsp;<span class="op" id="4526744">||</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4526749">subtle</span><span class="op" id="4526755">.</span><span class="ident" id="4526756">ConstantTimeCompare</span><span class="op" id="4526775">(</span><span class="ident" id="4526776">verify</span><span class="op" id="4526782">,</span>&nbsp;<span class="ident" id="4526784">clientFinished</span><span class="op" id="4526798">.</span><span class="ident" id="4526799">verifyData</span><span class="op" id="4526809">)</span>&nbsp;<span class="op" id="4526811">!=</span>&nbsp;<span class="num" id="4526814">1</span>&nbsp;<span class="op" id="4526816">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4526820">c</span><span class="op" id="4526821">.</span><span class="ident" id="4526822">sendAlert</span><span class="op" id="4526831">(</span><span class="ident" id="4526832">alertHandshakeFailure</span><span class="op" id="4526853">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4526857">return</span>&nbsp;<span class="ident" id="4526864">errors</span><span class="op" id="4526870">.</span><span class="ident" id="4526871">New</span><span class="op" id="4526874">(</span><span class="string" id="4526875">&#34;tls:&nbsp;client&#39;s&nbsp;Finished&nbsp;message&nbsp;is&nbsp;incorrect&#34;</span><span class="op" id="4526920">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4526923">}</span><br>
<span class="lineno">540</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4526927">hs</span><span class="op" id="4526929">.</span><span class="ident" id="4526930">finishedHash</span><span class="op" id="4526942">.</span><span class="ident" id="4526943">Write</span><span class="op" id="4526948">(</span><span class="ident" id="4526949">clientFinished</span><span class="op" id="4526963">.</span><span class="ident" id="4526964">marshal</span><span class="op" id="4526971">(</span><span class="op" id="4526972">)</span><span class="op" id="4526973">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4526976">copy</span><span class="op" id="4526980">(</span><span class="ident" id="4526981">out</span><span class="op" id="4526984">,</span>&nbsp;<span class="ident" id="4526986">verify</span><span class="op" id="4526992">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4526995">return</span>&nbsp;<span class="ident" id="4527002">nil</span><br>
<span class="lineno"></span><span class="op" id="4527006">}</span><br>
<span class="lineno">545</span><br>
<span class="lineno"></span><span class="keyword" id="4527009">func</span>&nbsp;<span class="op" id="4527014">(</span><span class="ident" id="4527015">hs</span>&nbsp;<span class="op" id="4527018">*</span><span class="ident" id="4527019">serverHandshakeState</span><span class="op" id="4527039">)</span>&nbsp;<span class="ident" id="4527041">sendSessionTicket</span><span class="op" id="4527058">(</span><span class="op" id="4527059">)</span>&nbsp;<span class="builtintype" id="4527061">error</span>&nbsp;<span class="op" id="4527067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4527070">if</span>&nbsp;<span class="op" id="4527073">!</span><span class="ident" id="4527074">hs</span><span class="op" id="4527076">.</span><span class="ident" id="4527077">hello</span><span class="op" id="4527082">.</span><span class="ident" id="4527083">ticketSupported</span>&nbsp;<span class="op" id="4527099">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4527103">return</span>&nbsp;<span class="ident" id="4527110">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4527115">}</span><br>
<span class="lineno">550</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4527119">c</span>&nbsp;<span class="op" id="4527121">:=</span>&nbsp;<span class="ident" id="4527124">hs</span><span class="op" id="4527126">.</span><span class="ident" id="4527127">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4527130">m</span>&nbsp;<span class="op" id="4527132">:=</span>&nbsp;<span class="builtinfunc" id="4527135">new</span><span class="op" id="4527138">(</span><span class="ident" id="4527139">newSessionTicketMsg</span><span class="op" id="4527158">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4527162">var</span>&nbsp;<span class="ident" id="4527166">err</span>&nbsp;<span class="builtintype" id="4527170">error</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4527177">state</span>&nbsp;<span class="op" id="4527183">:=</span>&nbsp;<span class="ident" id="4527186">sessionState</span><span class="op" id="4527198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4527202">vers</span><span class="op" id="4527206">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4527216">c</span><span class="op" id="4527217">.</span><span class="ident" id="4527218">vers</span><span class="op" id="4527222">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4527226">cipherSuite</span><span class="op" id="4527237">:</span>&nbsp;&nbsp;<span class="ident" id="4527240">hs</span><span class="op" id="4527242">.</span><span class="ident" id="4527243">suite</span><span class="op" id="4527248">.</span><span class="ident" id="4527249">id</span><span class="op" id="4527251">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4527255">masterSecret</span><span class="op" id="4527267">:</span>&nbsp;<span class="ident" id="4527269">hs</span><span class="op" id="4527271">.</span><span class="ident" id="4527272">masterSecret</span><span class="op" id="4527284">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4527288">certificates</span><span class="op" id="4527300">:</span>&nbsp;<span class="ident" id="4527302">hs</span><span class="op" id="4527304">.</span><span class="ident" id="4527305">certsFromClient</span><span class="op" id="4527320">,</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4527323">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4527326">m</span><span class="op" id="4527327">.</span><span class="ident" id="4527328">ticket</span><span class="op" id="4527334">,</span>&nbsp;<span class="ident" id="4527336">err</span>&nbsp;<span class="op" id="4527340">=</span>&nbsp;<span class="ident" id="4527342">c</span><span class="op" id="4527343">.</span><span class="ident" id="4527344">encryptTicket</span><span class="op" id="4527357">(</span><span class="op" id="4527358">&amp;</span><span class="ident" id="4527359">state</span><span class="op" id="4527364">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4527367">if</span>&nbsp;<span class="ident" id="4527370">err</span>&nbsp;<span class="op" id="4527374">!=</span>&nbsp;<span class="ident" id="4527377">nil</span>&nbsp;<span class="op" id="4527381">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4527385">return</span>&nbsp;<span class="ident" id="4527392">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4527397">}</span><br>
<span class="lineno">565</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4527401">hs</span><span class="op" id="4527403">.</span><span class="ident" id="4527404">finishedHash</span><span class="op" id="4527416">.</span><span class="ident" id="4527417">Write</span><span class="op" id="4527422">(</span><span class="ident" id="4527423">m</span><span class="op" id="4527424">.</span><span class="ident" id="4527425">marshal</span><span class="op" id="4527432">(</span><span class="op" id="4527433">)</span><span class="op" id="4527434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4527437">c</span><span class="op" id="4527438">.</span><span class="ident" id="4527439">writeRecord</span><span class="op" id="4527450">(</span><span class="ident" id="4527451">recordTypeHandshake</span><span class="op" id="4527470">,</span>&nbsp;<span class="ident" id="4527472">m</span><span class="op" id="4527473">.</span><span class="ident" id="4527474">marshal</span><span class="op" id="4527481">(</span><span class="op" id="4527482">)</span><span class="op" id="4527483">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4527487">return</span>&nbsp;<span class="ident" id="4527494">nil</span><br>
<span class="lineno">570</span><span class="op" id="4527498">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4527501">func</span>&nbsp;<span class="op" id="4527506">(</span><span class="ident" id="4527507">hs</span>&nbsp;<span class="op" id="4527510">*</span><span class="ident" id="4527511">serverHandshakeState</span><span class="op" id="4527531">)</span>&nbsp;<span class="ident" id="4527533">sendFinished</span><span class="op" id="4527545">(</span><span class="ident" id="4527546">out</span>&nbsp;<span class="op" id="4527550">[</span><span class="op" id="4527551">]</span><span class="builtintype" id="4527552">byte</span><span class="op" id="4527556">)</span>&nbsp;<span class="builtintype" id="4527558">error</span>&nbsp;<span class="op" id="4527564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4527567">c</span>&nbsp;<span class="op" id="4527569">:=</span>&nbsp;<span class="ident" id="4527572">hs</span><span class="op" id="4527574">.</span><span class="ident" id="4527575">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4527579">c</span><span class="op" id="4527580">.</span><span class="ident" id="4527581">writeRecord</span><span class="op" id="4527592">(</span><span class="ident" id="4527593">recordTypeChangeCipherSpec</span><span class="op" id="4527619">,</span>&nbsp;<span class="op" id="4527621">[</span><span class="op" id="4527622">]</span><span class="builtintype" id="4527623">byte</span><span class="op" id="4527627">{</span><span class="num" id="4527628">1</span><span class="op" id="4527629">}</span><span class="op" id="4527630">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4527634">finished</span>&nbsp;<span class="op" id="4527643">:=</span>&nbsp;<span class="builtinfunc" id="4527646">new</span><span class="op" id="4527649">(</span><span class="ident" id="4527650">finishedMsg</span><span class="op" id="4527661">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4527664">finished</span><span class="op" id="4527672">.</span><span class="ident" id="4527673">verifyData</span>&nbsp;<span class="op" id="4527684">=</span>&nbsp;<span class="ident" id="4527686">hs</span><span class="op" id="4527688">.</span><span class="ident" id="4527689">finishedHash</span><span class="op" id="4527701">.</span><span class="ident" id="4527702">serverSum</span><span class="op" id="4527711">(</span><span class="ident" id="4527712">hs</span><span class="op" id="4527714">.</span><span class="ident" id="4527715">masterSecret</span><span class="op" id="4527727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4527730">hs</span><span class="op" id="4527732">.</span><span class="ident" id="4527733">finishedHash</span><span class="op" id="4527745">.</span><span class="ident" id="4527746">Write</span><span class="op" id="4527751">(</span><span class="ident" id="4527752">finished</span><span class="op" id="4527760">.</span><span class="ident" id="4527761">marshal</span><span class="op" id="4527768">(</span><span class="op" id="4527769">)</span><span class="op" id="4527770">)</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4527773">c</span><span class="op" id="4527774">.</span><span class="ident" id="4527775">writeRecord</span><span class="op" id="4527786">(</span><span class="ident" id="4527787">recordTypeHandshake</span><span class="op" id="4527806">,</span>&nbsp;<span class="ident" id="4527808">finished</span><span class="op" id="4527816">.</span><span class="ident" id="4527817">marshal</span><span class="op" id="4527824">(</span><span class="op" id="4527825">)</span><span class="op" id="4527826">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4527830">c</span><span class="op" id="4527831">.</span><span class="ident" id="4527832">cipherSuite</span>&nbsp;<span class="op" id="4527844">=</span>&nbsp;<span class="ident" id="4527846">hs</span><span class="op" id="4527848">.</span><span class="ident" id="4527849">suite</span><span class="op" id="4527854">.</span><span class="ident" id="4527855">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4527859">copy</span><span class="op" id="4527863">(</span><span class="ident" id="4527864">out</span><span class="op" id="4527867">,</span>&nbsp;<span class="ident" id="4527869">finished</span><span class="op" id="4527877">.</span><span class="ident" id="4527878">verifyData</span><span class="op" id="4527888">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4527892">return</span>&nbsp;<span class="ident" id="4527899">nil</span><br>
<span class="lineno"></span><span class="op" id="4527903">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4527906">//&nbsp;processCertsFromClient&nbsp;takes&nbsp;a&nbsp;chain&nbsp;of&nbsp;client&nbsp;certificates&nbsp;either&nbsp;from&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4527983">//&nbsp;Certificates&nbsp;message&nbsp;or&nbsp;from&nbsp;a&nbsp;sessionState&nbsp;and&nbsp;verifies&nbsp;them.&nbsp;It&nbsp;returns</span><br>
<span class="lineno">590</span><span class="comment" id="4528060">//&nbsp;the&nbsp;public&nbsp;key&nbsp;of&nbsp;the&nbsp;leaf&nbsp;certificate.</span><br>
<span class="lineno"></span><span class="keyword" id="4528103">func</span>&nbsp;<span class="op" id="4528108">(</span><span class="ident" id="4528109">hs</span>&nbsp;<span class="op" id="4528112">*</span><span class="ident" id="4528113">serverHandshakeState</span><span class="op" id="4528133">)</span>&nbsp;<span class="ident" id="4528135">processCertsFromClient</span><span class="op" id="4528157">(</span><span class="ident" id="4528158">certificates</span>&nbsp;<span class="op" id="4528171">[</span><span class="op" id="4528172">]</span><span class="op" id="4528173">[</span><span class="op" id="4528174">]</span><span class="builtintype" id="4528175">byte</span><span class="op" id="4528179">)</span>&nbsp;<span class="op" id="4528181">(</span><span class="ident" id="4528182">crypto</span><span class="op" id="4528188">.</span><span class="ident" id="4528189">PublicKey</span><span class="op" id="4528198">,</span>&nbsp;<span class="builtintype" id="4528200">error</span><span class="op" id="4528205">)</span>&nbsp;<span class="op" id="4528207">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4528210">c</span>&nbsp;<span class="op" id="4528212">:=</span>&nbsp;<span class="ident" id="4528215">hs</span><span class="op" id="4528217">.</span><span class="ident" id="4528218">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4528222">hs</span><span class="op" id="4528224">.</span><span class="ident" id="4528225">certsFromClient</span>&nbsp;<span class="op" id="4528241">=</span>&nbsp;<span class="ident" id="4528243">certificates</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4528257">certs</span>&nbsp;<span class="op" id="4528263">:=</span>&nbsp;<span class="builtinfunc" id="4528266">make</span><span class="op" id="4528270">(</span><span class="op" id="4528271">[</span><span class="op" id="4528272">]</span><span class="op" id="4528273">*</span><span class="ident" id="4528274">x509</span><span class="op" id="4528278">.</span><span class="ident" id="4528279">Certificate</span><span class="op" id="4528290">,</span>&nbsp;<span class="builtinfunc" id="4528292">len</span><span class="op" id="4528295">(</span><span class="ident" id="4528296">certificates</span><span class="op" id="4528308">)</span><span class="op" id="4528309">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4528312">var</span>&nbsp;<span class="ident" id="4528316">err</span>&nbsp;<span class="builtintype" id="4528320">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4528327">for</span>&nbsp;<span class="ident" id="4528331">i</span><span class="op" id="4528332">,</span>&nbsp;<span class="ident" id="4528334">asn1Data</span>&nbsp;<span class="op" id="4528343">:=</span>&nbsp;<span class="keyword" id="4528346">range</span>&nbsp;<span class="ident" id="4528352">certificates</span>&nbsp;<span class="op" id="4528365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4528369">if</span>&nbsp;<span class="ident" id="4528372">certs</span><span class="op" id="4528377">[</span><span class="ident" id="4528378">i</span><span class="op" id="4528379">]</span><span class="op" id="4528380">,</span>&nbsp;<span class="ident" id="4528382">err</span>&nbsp;<span class="op" id="4528386">=</span>&nbsp;<span class="ident" id="4528388">x509</span><span class="op" id="4528392">.</span><span class="ident" id="4528393">ParseCertificate</span><span class="op" id="4528409">(</span><span class="ident" id="4528410">asn1Data</span><span class="op" id="4528418">)</span><span class="op" id="4528419">;</span>&nbsp;<span class="ident" id="4528421">err</span>&nbsp;<span class="op" id="4528425">!=</span>&nbsp;<span class="ident" id="4528428">nil</span>&nbsp;<span class="op" id="4528432">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4528437">c</span><span class="op" id="4528438">.</span><span class="ident" id="4528439">sendAlert</span><span class="op" id="4528448">(</span><span class="ident" id="4528449">alertBadCertificate</span><span class="op" id="4528468">)</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4528473">return</span>&nbsp;<span class="ident" id="4528480">nil</span><span class="op" id="4528483">,</span>&nbsp;<span class="ident" id="4528485">errors</span><span class="op" id="4528491">.</span><span class="ident" id="4528492">New</span><span class="op" id="4528495">(</span><span class="string" id="4528496">&#34;tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;client&nbsp;certificate:&nbsp;&#34;</span>&nbsp;<span class="op" id="4528540">+</span>&nbsp;<span class="ident" id="4528542">err</span><span class="op" id="4528545">.</span><span class="ident" id="4528546">Error</span><span class="op" id="4528551">(</span><span class="op" id="4528552">)</span><span class="op" id="4528553">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4528557">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4528560">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4528564">if</span>&nbsp;<span class="ident" id="4528567">c</span><span class="op" id="4528568">.</span><span class="ident" id="4528569">config</span><span class="op" id="4528575">.</span><span class="ident" id="4528576">ClientAuth</span>&nbsp;<span class="op" id="4528587">&gt;=</span>&nbsp;<span class="ident" id="4528590">VerifyClientCertIfGiven</span>&nbsp;<span class="op" id="4528614">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="4528617">len</span><span class="op" id="4528620">(</span><span class="ident" id="4528621">certs</span><span class="op" id="4528626">)</span>&nbsp;<span class="op" id="4528628">&gt;</span>&nbsp;<span class="num" id="4528630">0</span>&nbsp;<span class="op" id="4528632">{</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4528636">opts</span>&nbsp;<span class="op" id="4528641">:=</span>&nbsp;<span class="ident" id="4528644">x509</span><span class="op" id="4528648">.</span><span class="ident" id="4528649">VerifyOptions</span><span class="op" id="4528662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4528667">Roots</span><span class="op" id="4528672">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4528682">c</span><span class="op" id="4528683">.</span><span class="ident" id="4528684">config</span><span class="op" id="4528690">.</span><span class="ident" id="4528691">ClientCAs</span><span class="op" id="4528700">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4528705">CurrentTime</span><span class="op" id="4528716">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4528720">c</span><span class="op" id="4528721">.</span><span class="ident" id="4528722">config</span><span class="op" id="4528728">.</span><span class="ident" id="4528729">time</span><span class="op" id="4528733">(</span><span class="op" id="4528734">)</span><span class="op" id="4528735">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4528740">Intermediates</span><span class="op" id="4528753">:</span>&nbsp;<span class="ident" id="4528755">x509</span><span class="op" id="4528759">.</span><span class="ident" id="4528760">NewCertPool</span><span class="op" id="4528771">(</span><span class="op" id="4528772">)</span><span class="op" id="4528773">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4528778">KeyUsages</span><span class="op" id="4528787">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4528793">[</span><span class="op" id="4528794">]</span><span class="ident" id="4528795">x509</span><span class="op" id="4528799">.</span><span class="ident" id="4528800">ExtKeyUsage</span><span class="op" id="4528811">{</span><span class="ident" id="4528812">x509</span><span class="op" id="4528816">.</span><span class="ident" id="4528817">ExtKeyUsageClientAuth</span><span class="op" id="4528838">}</span><span class="op" id="4528839">,</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4528843">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4528848">for</span>&nbsp;<span class="ident" id="4528852">_</span><span class="op" id="4528853">,</span>&nbsp;<span class="ident" id="4528855">cert</span>&nbsp;<span class="op" id="4528860">:=</span>&nbsp;<span class="keyword" id="4528863">range</span>&nbsp;<span class="ident" id="4528869">certs</span><span class="op" id="4528874">[</span><span class="num" id="4528875">1</span><span class="op" id="4528876">:</span><span class="op" id="4528877">]</span>&nbsp;<span class="op" id="4528879">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4528884">opts</span><span class="op" id="4528888">.</span><span class="ident" id="4528889">Intermediates</span><span class="op" id="4528902">.</span><span class="ident" id="4528903">AddCert</span><span class="op" id="4528910">(</span><span class="ident" id="4528911">cert</span><span class="op" id="4528915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4528919">}</span><br>
<span class="lineno">615</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4528924">chains</span><span class="op" id="4528930">,</span>&nbsp;<span class="ident" id="4528932">err</span>&nbsp;<span class="op" id="4528936">:=</span>&nbsp;<span class="ident" id="4528939">certs</span><span class="op" id="4528944">[</span><span class="num" id="4528945">0</span><span class="op" id="4528946">]</span><span class="op" id="4528947">.</span><span class="ident" id="4528948">Verify</span><span class="op" id="4528954">(</span><span class="ident" id="4528955">opts</span><span class="op" id="4528959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4528963">if</span>&nbsp;<span class="ident" id="4528966">err</span>&nbsp;<span class="op" id="4528970">!=</span>&nbsp;<span class="ident" id="4528973">nil</span>&nbsp;<span class="op" id="4528977">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4528982">c</span><span class="op" id="4528983">.</span><span class="ident" id="4528984">sendAlert</span><span class="op" id="4528993">(</span><span class="ident" id="4528994">alertBadCertificate</span><span class="op" id="4529013">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4529018">return</span>&nbsp;<span class="ident" id="4529025">nil</span><span class="op" id="4529028">,</span>&nbsp;<span class="ident" id="4529030">errors</span><span class="op" id="4529036">.</span><span class="ident" id="4529037">New</span><span class="op" id="4529040">(</span><span class="string" id="4529041">&#34;tls:&nbsp;failed&nbsp;to&nbsp;verify&nbsp;client&#39;s&nbsp;certificate:&nbsp;&#34;</span>&nbsp;<span class="op" id="4529088">+</span>&nbsp;<span class="ident" id="4529090">err</span><span class="op" id="4529093">.</span><span class="ident" id="4529094">Error</span><span class="op" id="4529099">(</span><span class="op" id="4529100">)</span><span class="op" id="4529101">)</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4529105">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4529110">ok</span>&nbsp;<span class="op" id="4529113">:=</span>&nbsp;<span class="builtintype" id="4529116">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4529124">for</span>&nbsp;<span class="ident" id="4529128">_</span><span class="op" id="4529129">,</span>&nbsp;<span class="ident" id="4529131">ku</span>&nbsp;<span class="op" id="4529134">:=</span>&nbsp;<span class="keyword" id="4529137">range</span>&nbsp;<span class="ident" id="4529143">certs</span><span class="op" id="4529148">[</span><span class="num" id="4529149">0</span><span class="op" id="4529150">]</span><span class="op" id="4529151">.</span><span class="ident" id="4529152">ExtKeyUsage</span>&nbsp;<span class="op" id="4529164">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4529169">if</span>&nbsp;<span class="ident" id="4529172">ku</span>&nbsp;<span class="op" id="4529175">==</span>&nbsp;<span class="ident" id="4529178">x509</span><span class="op" id="4529182">.</span><span class="ident" id="4529183">ExtKeyUsageClientAuth</span>&nbsp;<span class="op" id="4529205">{</span><br>
<span class="lineno">625</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4529211">ok</span>&nbsp;<span class="op" id="4529214">=</span>&nbsp;<span class="builtintype" id="4529216">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4529225">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4529234">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4529238">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4529242">if</span>&nbsp;<span class="op" id="4529245">!</span><span class="ident" id="4529246">ok</span>&nbsp;<span class="op" id="4529249">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4529254">c</span><span class="op" id="4529255">.</span><span class="ident" id="4529256">sendAlert</span><span class="op" id="4529265">(</span><span class="ident" id="4529266">alertHandshakeFailure</span><span class="op" id="4529287">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4529292">return</span>&nbsp;<span class="ident" id="4529299">nil</span><span class="op" id="4529302">,</span>&nbsp;<span class="ident" id="4529304">errors</span><span class="op" id="4529310">.</span><span class="ident" id="4529311">New</span><span class="op" id="4529314">(</span><span class="string" id="4529315">&#34;tls:&nbsp;client&#39;s&nbsp;certificate&#39;s&nbsp;extended&nbsp;key&nbsp;usage&nbsp;doesn&#39;t&nbsp;permit&nbsp;it&nbsp;to&nbsp;be&nbsp;used&nbsp;for&nbsp;client&nbsp;authentication&#34;</span><span class="op" id="4529418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4529422">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4529427">c</span><span class="op" id="4529428">.</span><span class="ident" id="4529429">verifiedChains</span>&nbsp;<span class="op" id="4529444">=</span>&nbsp;<span class="ident" id="4529446">chains</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4529454">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4529458">if</span>&nbsp;<span class="builtinfunc" id="4529461">len</span><span class="op" id="4529464">(</span><span class="ident" id="4529465">certs</span><span class="op" id="4529470">)</span>&nbsp;<span class="op" id="4529472">&gt;</span>&nbsp;<span class="num" id="4529474">0</span>&nbsp;<span class="op" id="4529476">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4529480">var</span>&nbsp;<span class="ident" id="4529484">pub</span>&nbsp;<span class="ident" id="4529488">crypto</span><span class="op" id="4529494">.</span><span class="ident" id="4529495">PublicKey</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4529507">switch</span>&nbsp;<span class="ident" id="4529514">key</span>&nbsp;<span class="op" id="4529518">:=</span>&nbsp;<span class="ident" id="4529521">certs</span><span class="op" id="4529526">[</span><span class="num" id="4529527">0</span><span class="op" id="4529528">]</span><span class="op" id="4529529">.</span><span class="ident" id="4529530">PublicKey</span><span class="op" id="4529539">.</span><span class="op" id="4529540">(</span><span class="keyword" id="4529541">type</span><span class="op" id="4529545">)</span>&nbsp;<span class="op" id="4529547">{</span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4529551">case</span>&nbsp;<span class="op" id="4529556">*</span><span class="ident" id="4529557">ecdsa</span><span class="op" id="4529562">.</span><span class="ident" id="4529563">PublicKey</span><span class="op" id="4529572">,</span>&nbsp;<span class="op" id="4529574">*</span><span class="ident" id="4529575">rsa</span><span class="op" id="4529578">.</span><span class="ident" id="4529579">PublicKey</span><span class="op" id="4529588">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4529593">pub</span>&nbsp;<span class="op" id="4529597">=</span>&nbsp;<span class="ident" id="4529599">key</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4529605">default</span><span class="op" id="4529612">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4529617">c</span><span class="op" id="4529618">.</span><span class="ident" id="4529619">sendAlert</span><span class="op" id="4529628">(</span><span class="ident" id="4529629">alertUnsupportedCertificate</span><span class="op" id="4529656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4529661">return</span>&nbsp;<span class="ident" id="4529668">nil</span><span class="op" id="4529671">,</span>&nbsp;<span class="ident" id="4529673">fmt</span><span class="op" id="4529676">.</span><span class="ident" id="4529677">Errorf</span><span class="op" id="4529683">(</span><span class="string" id="4529684">&#34;tls:&nbsp;client&#39;s&nbsp;certificate&nbsp;contains&nbsp;an&nbsp;unsupported&nbsp;public&nbsp;key&nbsp;of&nbsp;type&nbsp;%T&#34;</span><span class="op" id="4529757">,</span>&nbsp;<span class="ident" id="4529759">certs</span><span class="op" id="4529764">[</span><span class="num" id="4529765">0</span><span class="op" id="4529766">]</span><span class="op" id="4529767">.</span><span class="ident" id="4529768">PublicKey</span><span class="op" id="4529777">)</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4529781">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4529785">c</span><span class="op" id="4529786">.</span><span class="ident" id="4529787">peerCertificates</span>&nbsp;<span class="op" id="4529804">=</span>&nbsp;<span class="ident" id="4529806">certs</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4529814">return</span>&nbsp;<span class="ident" id="4529821">pub</span><span class="op" id="4529824">,</span>&nbsp;<span class="ident" id="4529826">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4529831">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4529835">return</span>&nbsp;<span class="ident" id="4529842">nil</span><span class="op" id="4529845">,</span>&nbsp;<span class="ident" id="4529847">nil</span><br>
<span class="lineno"></span><span class="op" id="4529851">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4529854">//&nbsp;tryCipherSuite&nbsp;returns&nbsp;a&nbsp;cipherSuite&nbsp;with&nbsp;the&nbsp;given&nbsp;id&nbsp;if&nbsp;that&nbsp;cipher&nbsp;suite</span><br>
<span class="lineno"></span><span class="comment" id="4529933">//&nbsp;is&nbsp;acceptable&nbsp;to&nbsp;use.</span><br>
<span class="lineno">655</span><span class="keyword" id="4529958">func</span>&nbsp;<span class="op" id="4529963">(</span><span class="ident" id="4529964">c</span>&nbsp;<span class="op" id="4529966">*</span><span class="ident" id="4529967">Conn</span><span class="op" id="4529971">)</span>&nbsp;<span class="ident" id="4529973">tryCipherSuite</span><span class="op" id="4529987">(</span><span class="ident" id="4529988">id</span>&nbsp;<span class="builtintype" id="4529991">uint16</span><span class="op" id="4529997">,</span>&nbsp;<span class="ident" id="4529999">supportedCipherSuites</span>&nbsp;<span class="op" id="4530021">[</span><span class="op" id="4530022">]</span><span class="builtintype" id="4530023">uint16</span><span class="op" id="4530029">,</span>&nbsp;<span class="ident" id="4530031">version</span>&nbsp;<span class="builtintype" id="4530039">uint16</span><span class="op" id="4530045">,</span>&nbsp;<span class="ident" id="4530047">ellipticOk</span><span class="op" id="4530057">,</span>&nbsp;<span class="ident" id="4530059">ecdsaOk</span>&nbsp;<span class="builtintype" id="4530067">bool</span><span class="op" id="4530071">)</span>&nbsp;<span class="op" id="4530073">*</span><span class="ident" id="4530074">cipherSuite</span>&nbsp;<span class="op" id="4530086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4530089">for</span>&nbsp;<span class="ident" id="4530093">_</span><span class="op" id="4530094">,</span>&nbsp;<span class="ident" id="4530096">supported</span>&nbsp;<span class="op" id="4530106">:=</span>&nbsp;<span class="keyword" id="4530109">range</span>&nbsp;<span class="ident" id="4530115">supportedCipherSuites</span>&nbsp;<span class="op" id="4530137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4530141">if</span>&nbsp;<span class="ident" id="4530144">id</span>&nbsp;<span class="op" id="4530147">==</span>&nbsp;<span class="ident" id="4530150">supported</span>&nbsp;<span class="op" id="4530160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4530165">var</span>&nbsp;<span class="ident" id="4530169">candidate</span>&nbsp;<span class="op" id="4530179">*</span><span class="ident" id="4530180">cipherSuite</span><br>
<span class="lineno"></span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4530196">for</span>&nbsp;<span class="ident" id="4530200">_</span><span class="op" id="4530201">,</span>&nbsp;<span class="ident" id="4530203">s</span>&nbsp;<span class="op" id="4530205">:=</span>&nbsp;<span class="keyword" id="4530208">range</span>&nbsp;<span class="ident" id="4530214">cipherSuites</span>&nbsp;<span class="op" id="4530227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4530233">if</span>&nbsp;<span class="ident" id="4530236">s</span><span class="op" id="4530237">.</span><span class="ident" id="4530238">id</span>&nbsp;<span class="op" id="4530241">==</span>&nbsp;<span class="ident" id="4530244">id</span>&nbsp;<span class="op" id="4530247">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4530254">candidate</span>&nbsp;<span class="op" id="4530264">=</span>&nbsp;<span class="ident" id="4530266">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4530273">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4530283">}</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4530288">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4530293">if</span>&nbsp;<span class="ident" id="4530296">candidate</span>&nbsp;<span class="op" id="4530306">==</span>&nbsp;<span class="ident" id="4530309">nil</span>&nbsp;<span class="op" id="4530313">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4530319">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4530331">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4530336">//&nbsp;Don&#39;t&nbsp;select&nbsp;a&nbsp;ciphersuite&nbsp;which&nbsp;we&nbsp;can&#39;t</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4530384">//&nbsp;support&nbsp;for&nbsp;this&nbsp;client.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4530415">if</span>&nbsp;<span class="op" id="4530418">(</span><span class="ident" id="4530419">candidate</span><span class="op" id="4530428">.</span><span class="ident" id="4530429">flags</span><span class="op" id="4530434">&amp;</span><span class="ident" id="4530435">suiteECDHE</span>&nbsp;<span class="op" id="4530446">!=</span>&nbsp;<span class="num" id="4530449">0</span><span class="op" id="4530450">)</span>&nbsp;<span class="op" id="4530452">&amp;&amp;</span>&nbsp;<span class="op" id="4530455">!</span><span class="ident" id="4530456">ellipticOk</span>&nbsp;<span class="op" id="4530467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4530473">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4530485">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4530490">if</span>&nbsp;<span class="op" id="4530493">(</span><span class="ident" id="4530494">candidate</span><span class="op" id="4530503">.</span><span class="ident" id="4530504">flags</span><span class="op" id="4530509">&amp;</span><span class="ident" id="4530510">suiteECDSA</span>&nbsp;<span class="op" id="4530521">!=</span>&nbsp;<span class="num" id="4530524">0</span><span class="op" id="4530525">)</span>&nbsp;<span class="op" id="4530527">!=</span>&nbsp;<span class="ident" id="4530530">ecdsaOk</span>&nbsp;<span class="op" id="4530538">{</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4530544">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4530556">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4530561">if</span>&nbsp;<span class="ident" id="4530564">version</span>&nbsp;<span class="op" id="4530572">&lt;</span>&nbsp;<span class="ident" id="4530574">VersionTLS12</span>&nbsp;<span class="op" id="4530587">&amp;&amp;</span>&nbsp;<span class="ident" id="4530590">candidate</span><span class="op" id="4530599">.</span><span class="ident" id="4530600">flags</span><span class="op" id="4530605">&amp;</span><span class="ident" id="4530606">suiteTLS12</span>&nbsp;<span class="op" id="4530617">!=</span>&nbsp;<span class="num" id="4530620">0</span>&nbsp;<span class="op" id="4530622">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4530628">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4530640">}</span><br>
<span class="lineno">680</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4530645">return</span>&nbsp;<span class="ident" id="4530652">candidate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4530664">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4530667">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4530671">return</span>&nbsp;<span class="ident" id="4530678">nil</span><br>
<span class="lineno">685</span><span class="op" id="4530682">}</span>
</div>
</body>
</html>
