<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3098874">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3098930">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3098984">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="3099035">package</span>&nbsp;<span class="ident" id="3099043">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3099048">import</span>&nbsp;<span class="string" id="3099055">&#34;sync&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3099063">//&nbsp;call&nbsp;is&nbsp;an&nbsp;in-flight&nbsp;or&nbsp;completed&nbsp;singleflight.Do&nbsp;call</span><br>
<span class="lineno">10</span><span class="keyword" id="3099121">type</span>&nbsp;<span class="ident" id="3099126">call</span>&nbsp;<span class="keyword" id="3099131">struct</span>&nbsp;<span class="op" id="3099138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3099141">wg</span>&nbsp;<span class="ident" id="3099144">sync</span><span class="op" id="3099148">.</span><span class="ident" id="3099149">WaitGroup</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3099161">//&nbsp;These&nbsp;fields&nbsp;are&nbsp;written&nbsp;once&nbsp;before&nbsp;the&nbsp;WaitGroup&nbsp;is&nbsp;done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3099224">//&nbsp;and&nbsp;are&nbsp;only&nbsp;read&nbsp;after&nbsp;the&nbsp;WaitGroup&nbsp;is&nbsp;done.</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3099275">val</span>&nbsp;<span class="keyword" id="3099279">interface</span><span class="op" id="3099288">{</span><span class="op" id="3099289">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3099292">err</span>&nbsp;<span class="builtintype" id="3099296">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3099304">//&nbsp;These&nbsp;fields&nbsp;are&nbsp;read&nbsp;and&nbsp;written&nbsp;with&nbsp;the&nbsp;singleflight</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3099364">//&nbsp;mutex&nbsp;held&nbsp;before&nbsp;the&nbsp;WaitGroup&nbsp;is&nbsp;done,&nbsp;and&nbsp;are&nbsp;read&nbsp;but</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3099426">//&nbsp;not&nbsp;written&nbsp;after&nbsp;the&nbsp;WaitGroup&nbsp;is&nbsp;done.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3099471">dups</span>&nbsp;&nbsp;<span class="builtintype" id="3099477">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3099482">chans</span>&nbsp;<span class="op" id="3099488">[</span><span class="op" id="3099489">]</span><span class="keyword" id="3099490">chan</span><span class="op" id="3099494">&lt;-</span>&nbsp;<span class="ident" id="3099497">singleflightResult</span><br>
<span class="lineno"></span><span class="op" id="3099516">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="3099519">//&nbsp;singleflight&nbsp;represents&nbsp;a&nbsp;class&nbsp;of&nbsp;work&nbsp;and&nbsp;forms&nbsp;a&nbsp;namespace&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="3099587">//&nbsp;which&nbsp;units&nbsp;of&nbsp;work&nbsp;can&nbsp;be&nbsp;executed&nbsp;with&nbsp;duplicate&nbsp;suppression.</span><br>
<span class="lineno"></span><span class="keyword" id="3099654">type</span>&nbsp;<span class="ident" id="3099659">singleflight</span>&nbsp;<span class="keyword" id="3099672">struct</span>&nbsp;<span class="op" id="3099679">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3099682">mu</span>&nbsp;<span class="ident" id="3099685">sync</span><span class="op" id="3099689">.</span><span class="ident" id="3099690">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3099702">//&nbsp;protects&nbsp;m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3099717">m</span>&nbsp;&nbsp;<span class="keyword" id="3099720">map</span><span class="op" id="3099723">[</span><span class="builtintype" id="3099724">string</span><span class="op" id="3099730">]</span><span class="op" id="3099731">*</span><span class="ident" id="3099732">call</span>&nbsp;<span class="comment" id="3099737">//&nbsp;lazily&nbsp;initialized</span><br>
<span class="lineno">30</span><span class="op" id="3099759">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3099762">//&nbsp;singleflightResult&nbsp;holds&nbsp;the&nbsp;results&nbsp;of&nbsp;Do,&nbsp;so&nbsp;they&nbsp;can&nbsp;be&nbsp;passed</span><br>
<span class="lineno"></span><span class="comment" id="3099831">//&nbsp;on&nbsp;a&nbsp;channel.</span><br>
<span class="lineno"></span><span class="keyword" id="3099848">type</span>&nbsp;<span class="ident" id="3099853">singleflightResult</span>&nbsp;<span class="keyword" id="3099872">struct</span>&nbsp;<span class="op" id="3099879">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3099882">v</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3099889">interface</span><span class="op" id="3099898">{</span><span class="op" id="3099899">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3099902">err</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3099909">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3099916">shared</span>&nbsp;<span class="builtintype" id="3099923">bool</span><br>
<span class="lineno"></span><span class="op" id="3099928">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="3099931">//&nbsp;Do&nbsp;executes&nbsp;and&nbsp;returns&nbsp;the&nbsp;results&nbsp;of&nbsp;the&nbsp;given&nbsp;function,&nbsp;making</span><br>
<span class="lineno"></span><span class="comment" id="3100000">//&nbsp;sure&nbsp;that&nbsp;only&nbsp;one&nbsp;execution&nbsp;is&nbsp;in-flight&nbsp;for&nbsp;a&nbsp;given&nbsp;key&nbsp;at&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3100066">//&nbsp;time.&nbsp;If&nbsp;a&nbsp;duplicate&nbsp;comes&nbsp;in,&nbsp;the&nbsp;duplicate&nbsp;caller&nbsp;waits&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3100135">//&nbsp;original&nbsp;to&nbsp;complete&nbsp;and&nbsp;receives&nbsp;the&nbsp;same&nbsp;results.</span><br>
<span class="lineno"></span><span class="comment" id="3100190">//&nbsp;The&nbsp;return&nbsp;value&nbsp;shared&nbsp;indicates&nbsp;whether&nbsp;v&nbsp;was&nbsp;given&nbsp;to&nbsp;multiple&nbsp;callers.</span><br>
<span class="lineno">45</span><span class="keyword" id="3100268">func</span>&nbsp;<span class="op" id="3100273">(</span><span class="ident" id="3100274">g</span>&nbsp;<span class="op" id="3100276">*</span><span class="ident" id="3100277">singleflight</span><span class="op" id="3100289">)</span>&nbsp;<span class="ident" id="3100291">Do</span><span class="op" id="3100293">(</span><span class="ident" id="3100294">key</span>&nbsp;<span class="builtintype" id="3100298">string</span><span class="op" id="3100304">,</span>&nbsp;<span class="ident" id="3100306">fn</span>&nbsp;<span class="keyword" id="3100309">func</span><span class="op" id="3100313">(</span><span class="op" id="3100314">)</span>&nbsp;<span class="op" id="3100316">(</span><span class="keyword" id="3100317">interface</span><span class="op" id="3100326">{</span><span class="op" id="3100327">}</span><span class="op" id="3100328">,</span>&nbsp;<span class="builtintype" id="3100330">error</span><span class="op" id="3100335">)</span><span class="op" id="3100336">)</span>&nbsp;<span class="op" id="3100338">(</span><span class="ident" id="3100339">v</span>&nbsp;<span class="keyword" id="3100341">interface</span><span class="op" id="3100350">{</span><span class="op" id="3100351">}</span><span class="op" id="3100352">,</span>&nbsp;<span class="ident" id="3100354">err</span>&nbsp;<span class="builtintype" id="3100358">error</span><span class="op" id="3100363">,</span>&nbsp;<span class="ident" id="3100365">shared</span>&nbsp;<span class="builtintype" id="3100372">bool</span><span class="op" id="3100376">)</span>&nbsp;<span class="op" id="3100378">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3100381">g</span><span class="op" id="3100382">.</span><span class="ident" id="3100383">mu</span><span class="op" id="3100385">.</span><span class="ident" id="3100386">Lock</span><span class="op" id="3100390">(</span><span class="op" id="3100391">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3100394">if</span>&nbsp;<span class="ident" id="3100397">g</span><span class="op" id="3100398">.</span><span class="ident" id="3100399">m</span>&nbsp;<span class="op" id="3100401">==</span>&nbsp;<span class="ident" id="3100404">nil</span>&nbsp;<span class="op" id="3100408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3100412">g</span><span class="op" id="3100413">.</span><span class="ident" id="3100414">m</span>&nbsp;<span class="op" id="3100416">=</span>&nbsp;<span class="builtinfunc" id="3100418">make</span><span class="op" id="3100422">(</span><span class="keyword" id="3100423">map</span><span class="op" id="3100426">[</span><span class="builtintype" id="3100427">string</span><span class="op" id="3100433">]</span><span class="op" id="3100434">*</span><span class="ident" id="3100435">call</span><span class="op" id="3100439">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3100442">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3100445">if</span>&nbsp;<span class="ident" id="3100448">c</span><span class="op" id="3100449">,</span>&nbsp;<span class="ident" id="3100451">ok</span>&nbsp;<span class="op" id="3100454">:=</span>&nbsp;<span class="ident" id="3100457">g</span><span class="op" id="3100458">.</span><span class="ident" id="3100459">m</span><span class="op" id="3100460">[</span><span class="ident" id="3100461">key</span><span class="op" id="3100464">]</span><span class="op" id="3100465">;</span>&nbsp;<span class="ident" id="3100467">ok</span>&nbsp;<span class="op" id="3100470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3100474">c</span><span class="op" id="3100475">.</span><span class="ident" id="3100476">dups</span><span class="op" id="3100480">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3100485">g</span><span class="op" id="3100486">.</span><span class="ident" id="3100487">mu</span><span class="op" id="3100489">.</span><span class="ident" id="3100490">Unlock</span><span class="op" id="3100496">(</span><span class="op" id="3100497">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3100501">c</span><span class="op" id="3100502">.</span><span class="ident" id="3100503">wg</span><span class="op" id="3100505">.</span><span class="ident" id="3100506">Wait</span><span class="op" id="3100510">(</span><span class="op" id="3100511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3100515">return</span>&nbsp;<span class="ident" id="3100522">c</span><span class="op" id="3100523">.</span><span class="ident" id="3100524">val</span><span class="op" id="3100527">,</span>&nbsp;<span class="ident" id="3100529">c</span><span class="op" id="3100530">.</span><span class="ident" id="3100531">err</span><span class="op" id="3100534">,</span>&nbsp;<span class="builtintype" id="3100536">true</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3100542">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3100545">c</span>&nbsp;<span class="op" id="3100547">:=</span>&nbsp;<span class="builtinfunc" id="3100550">new</span><span class="op" id="3100553">(</span><span class="ident" id="3100554">call</span><span class="op" id="3100558">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3100561">c</span><span class="op" id="3100562">.</span><span class="ident" id="3100563">wg</span><span class="op" id="3100565">.</span><span class="ident" id="3100566">Add</span><span class="op" id="3100569">(</span><span class="num" id="3100570">1</span><span class="op" id="3100571">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3100574">g</span><span class="op" id="3100575">.</span><span class="ident" id="3100576">m</span><span class="op" id="3100577">[</span><span class="ident" id="3100578">key</span><span class="op" id="3100581">]</span>&nbsp;<span class="op" id="3100583">=</span>&nbsp;<span class="ident" id="3100585">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3100588">g</span><span class="op" id="3100589">.</span><span class="ident" id="3100590">mu</span><span class="op" id="3100592">.</span><span class="ident" id="3100593">Unlock</span><span class="op" id="3100599">(</span><span class="op" id="3100600">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3100604">g</span><span class="op" id="3100605">.</span><span class="ident" id="3100606">doCall</span><span class="op" id="3100612">(</span><span class="ident" id="3100613">c</span><span class="op" id="3100614">,</span>&nbsp;<span class="ident" id="3100616">key</span><span class="op" id="3100619">,</span>&nbsp;<span class="ident" id="3100621">fn</span><span class="op" id="3100623">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3100626">return</span>&nbsp;<span class="ident" id="3100633">c</span><span class="op" id="3100634">.</span><span class="ident" id="3100635">val</span><span class="op" id="3100638">,</span>&nbsp;<span class="ident" id="3100640">c</span><span class="op" id="3100641">.</span><span class="ident" id="3100642">err</span><span class="op" id="3100645">,</span>&nbsp;<span class="ident" id="3100647">c</span><span class="op" id="3100648">.</span><span class="ident" id="3100649">dups</span>&nbsp;<span class="op" id="3100654">&gt;</span>&nbsp;<span class="num" id="3100656">0</span><br>
<span class="lineno"></span><span class="op" id="3100658">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="3100661">//&nbsp;DoChan&nbsp;is&nbsp;like&nbsp;Do&nbsp;but&nbsp;returns&nbsp;a&nbsp;channel&nbsp;that&nbsp;will&nbsp;receive&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3100726">//&nbsp;results&nbsp;when&nbsp;they&nbsp;are&nbsp;ready.</span><br>
<span class="lineno"></span><span class="keyword" id="3100758">func</span>&nbsp;<span class="op" id="3100763">(</span><span class="ident" id="3100764">g</span>&nbsp;<span class="op" id="3100766">*</span><span class="ident" id="3100767">singleflight</span><span class="op" id="3100779">)</span>&nbsp;<span class="ident" id="3100781">DoChan</span><span class="op" id="3100787">(</span><span class="ident" id="3100788">key</span>&nbsp;<span class="builtintype" id="3100792">string</span><span class="op" id="3100798">,</span>&nbsp;<span class="ident" id="3100800">fn</span>&nbsp;<span class="keyword" id="3100803">func</span><span class="op" id="3100807">(</span><span class="op" id="3100808">)</span>&nbsp;<span class="op" id="3100810">(</span><span class="keyword" id="3100811">interface</span><span class="op" id="3100820">{</span><span class="op" id="3100821">}</span><span class="op" id="3100822">,</span>&nbsp;<span class="builtintype" id="3100824">error</span><span class="op" id="3100829">)</span><span class="op" id="3100830">)</span>&nbsp;<span class="op" id="3100832">&lt;-</span><span class="keyword" id="3100834">chan</span>&nbsp;<span class="ident" id="3100839">singleflightResult</span>&nbsp;<span class="op" id="3100858">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3100861">ch</span>&nbsp;<span class="op" id="3100864">:=</span>&nbsp;<span class="builtinfunc" id="3100867">make</span><span class="op" id="3100871">(</span><span class="keyword" id="3100872">chan</span>&nbsp;<span class="ident" id="3100877">singleflightResult</span><span class="op" id="3100895">,</span>&nbsp;<span class="num" id="3100897">1</span><span class="op" id="3100898">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3100901">g</span><span class="op" id="3100902">.</span><span class="ident" id="3100903">mu</span><span class="op" id="3100905">.</span><span class="ident" id="3100906">Lock</span><span class="op" id="3100910">(</span><span class="op" id="3100911">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3100914">if</span>&nbsp;<span class="ident" id="3100917">g</span><span class="op" id="3100918">.</span><span class="ident" id="3100919">m</span>&nbsp;<span class="op" id="3100921">==</span>&nbsp;<span class="ident" id="3100924">nil</span>&nbsp;<span class="op" id="3100928">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3100932">g</span><span class="op" id="3100933">.</span><span class="ident" id="3100934">m</span>&nbsp;<span class="op" id="3100936">=</span>&nbsp;<span class="builtinfunc" id="3100938">make</span><span class="op" id="3100942">(</span><span class="keyword" id="3100943">map</span><span class="op" id="3100946">[</span><span class="builtintype" id="3100947">string</span><span class="op" id="3100953">]</span><span class="op" id="3100954">*</span><span class="ident" id="3100955">call</span><span class="op" id="3100959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3100962">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3100965">if</span>&nbsp;<span class="ident" id="3100968">c</span><span class="op" id="3100969">,</span>&nbsp;<span class="ident" id="3100971">ok</span>&nbsp;<span class="op" id="3100974">:=</span>&nbsp;<span class="ident" id="3100977">g</span><span class="op" id="3100978">.</span><span class="ident" id="3100979">m</span><span class="op" id="3100980">[</span><span class="ident" id="3100981">key</span><span class="op" id="3100984">]</span><span class="op" id="3100985">;</span>&nbsp;<span class="ident" id="3100987">ok</span>&nbsp;<span class="op" id="3100990">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3100994">c</span><span class="op" id="3100995">.</span><span class="ident" id="3100996">dups</span><span class="op" id="3101000">++</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3101005">c</span><span class="op" id="3101006">.</span><span class="ident" id="3101007">chans</span>&nbsp;<span class="op" id="3101013">=</span>&nbsp;<span class="builtinfunc" id="3101015">append</span><span class="op" id="3101021">(</span><span class="ident" id="3101022">c</span><span class="op" id="3101023">.</span><span class="ident" id="3101024">chans</span><span class="op" id="3101029">,</span>&nbsp;<span class="ident" id="3101031">ch</span><span class="op" id="3101033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3101037">g</span><span class="op" id="3101038">.</span><span class="ident" id="3101039">mu</span><span class="op" id="3101041">.</span><span class="ident" id="3101042">Unlock</span><span class="op" id="3101048">(</span><span class="op" id="3101049">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3101053">return</span>&nbsp;<span class="ident" id="3101060">ch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3101064">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3101067">c</span>&nbsp;<span class="op" id="3101069">:=</span>&nbsp;<span class="op" id="3101072">&amp;</span><span class="ident" id="3101073">call</span><span class="op" id="3101077">{</span><span class="ident" id="3101078">chans</span><span class="op" id="3101083">:</span>&nbsp;<span class="op" id="3101085">[</span><span class="op" id="3101086">]</span><span class="keyword" id="3101087">chan</span><span class="op" id="3101091">&lt;-</span>&nbsp;<span class="ident" id="3101094">singleflightResult</span><span class="op" id="3101112">{</span><span class="ident" id="3101113">ch</span><span class="op" id="3101115">}</span><span class="op" id="3101116">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3101119">c</span><span class="op" id="3101120">.</span><span class="ident" id="3101121">wg</span><span class="op" id="3101123">.</span><span class="ident" id="3101124">Add</span><span class="op" id="3101127">(</span><span class="num" id="3101128">1</span><span class="op" id="3101129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3101132">g</span><span class="op" id="3101133">.</span><span class="ident" id="3101134">m</span><span class="op" id="3101135">[</span><span class="ident" id="3101136">key</span><span class="op" id="3101139">]</span>&nbsp;<span class="op" id="3101141">=</span>&nbsp;<span class="ident" id="3101143">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3101146">g</span><span class="op" id="3101147">.</span><span class="ident" id="3101148">mu</span><span class="op" id="3101150">.</span><span class="ident" id="3101151">Unlock</span><span class="op" id="3101157">(</span><span class="op" id="3101158">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3101162">go</span>&nbsp;<span class="ident" id="3101165">g</span><span class="op" id="3101166">.</span><span class="ident" id="3101167">doCall</span><span class="op" id="3101173">(</span><span class="ident" id="3101174">c</span><span class="op" id="3101175">,</span>&nbsp;<span class="ident" id="3101177">key</span><span class="op" id="3101180">,</span>&nbsp;<span class="ident" id="3101182">fn</span><span class="op" id="3101184">)</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3101188">return</span>&nbsp;<span class="ident" id="3101195">ch</span><br>
<span class="lineno"></span><span class="op" id="3101198">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3101201">//&nbsp;doCall&nbsp;handles&nbsp;the&nbsp;single&nbsp;call&nbsp;for&nbsp;a&nbsp;key.</span><br>
<span class="lineno">90</span><span class="keyword" id="3101246">func</span>&nbsp;<span class="op" id="3101251">(</span><span class="ident" id="3101252">g</span>&nbsp;<span class="op" id="3101254">*</span><span class="ident" id="3101255">singleflight</span><span class="op" id="3101267">)</span>&nbsp;<span class="ident" id="3101269">doCall</span><span class="op" id="3101275">(</span><span class="ident" id="3101276">c</span>&nbsp;<span class="op" id="3101278">*</span><span class="ident" id="3101279">call</span><span class="op" id="3101283">,</span>&nbsp;<span class="ident" id="3101285">key</span>&nbsp;<span class="builtintype" id="3101289">string</span><span class="op" id="3101295">,</span>&nbsp;<span class="ident" id="3101297">fn</span>&nbsp;<span class="keyword" id="3101300">func</span><span class="op" id="3101304">(</span><span class="op" id="3101305">)</span>&nbsp;<span class="op" id="3101307">(</span><span class="keyword" id="3101308">interface</span><span class="op" id="3101317">{</span><span class="op" id="3101318">}</span><span class="op" id="3101319">,</span>&nbsp;<span class="builtintype" id="3101321">error</span><span class="op" id="3101326">)</span><span class="op" id="3101327">)</span>&nbsp;<span class="op" id="3101329">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3101332">c</span><span class="op" id="3101333">.</span><span class="ident" id="3101334">val</span><span class="op" id="3101337">,</span>&nbsp;<span class="ident" id="3101339">c</span><span class="op" id="3101340">.</span><span class="ident" id="3101341">err</span>&nbsp;<span class="op" id="3101345">=</span>&nbsp;<span class="ident" id="3101347">fn</span><span class="op" id="3101349">(</span><span class="op" id="3101350">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3101353">c</span><span class="op" id="3101354">.</span><span class="ident" id="3101355">wg</span><span class="op" id="3101357">.</span><span class="ident" id="3101358">Done</span><span class="op" id="3101362">(</span><span class="op" id="3101363">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3101367">g</span><span class="op" id="3101368">.</span><span class="ident" id="3101369">mu</span><span class="op" id="3101371">.</span><span class="ident" id="3101372">Lock</span><span class="op" id="3101376">(</span><span class="op" id="3101377">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3101380">delete</span><span class="op" id="3101386">(</span><span class="ident" id="3101387">g</span><span class="op" id="3101388">.</span><span class="ident" id="3101389">m</span><span class="op" id="3101390">,</span>&nbsp;<span class="ident" id="3101392">key</span><span class="op" id="3101395">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3101398">for</span>&nbsp;<span class="ident" id="3101402">_</span><span class="op" id="3101403">,</span>&nbsp;<span class="ident" id="3101405">ch</span>&nbsp;<span class="op" id="3101408">:=</span>&nbsp;<span class="keyword" id="3101411">range</span>&nbsp;<span class="ident" id="3101417">c</span><span class="op" id="3101418">.</span><span class="ident" id="3101419">chans</span>&nbsp;<span class="op" id="3101425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3101429">ch</span>&nbsp;<span class="op" id="3101432">&lt;-</span>&nbsp;<span class="ident" id="3101435">singleflightResult</span><span class="op" id="3101453">{</span><span class="ident" id="3101454">c</span><span class="op" id="3101455">.</span><span class="ident" id="3101456">val</span><span class="op" id="3101459">,</span>&nbsp;<span class="ident" id="3101461">c</span><span class="op" id="3101462">.</span><span class="ident" id="3101463">err</span><span class="op" id="3101466">,</span>&nbsp;<span class="ident" id="3101468">c</span><span class="op" id="3101469">.</span><span class="ident" id="3101470">dups</span>&nbsp;<span class="op" id="3101475">&gt;</span>&nbsp;<span class="num" id="3101477">0</span><span class="op" id="3101478">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3101481">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3101484">g</span><span class="op" id="3101485">.</span><span class="ident" id="3101486">mu</span><span class="op" id="3101488">.</span><span class="ident" id="3101489">Unlock</span><span class="op" id="3101495">(</span><span class="op" id="3101496">)</span><br>
<span class="lineno">100</span><span class="op" id="3101498">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3101501">//&nbsp;Forget&nbsp;tells&nbsp;the&nbsp;singleflight&nbsp;to&nbsp;forget&nbsp;about&nbsp;a&nbsp;key.&nbsp;&nbsp;Future&nbsp;calls</span><br>
<span class="lineno"></span><span class="comment" id="3101571">//&nbsp;to&nbsp;Do&nbsp;for&nbsp;this&nbsp;key&nbsp;will&nbsp;call&nbsp;the&nbsp;function&nbsp;rather&nbsp;than&nbsp;waiting&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="3101640">//&nbsp;an&nbsp;earlier&nbsp;call&nbsp;to&nbsp;complete.</span><br>
<span class="lineno">105</span><span class="keyword" id="3101672">func</span>&nbsp;<span class="op" id="3101677">(</span><span class="ident" id="3101678">g</span>&nbsp;<span class="op" id="3101680">*</span><span class="ident" id="3101681">singleflight</span><span class="op" id="3101693">)</span>&nbsp;<span class="ident" id="3101695">Forget</span><span class="op" id="3101701">(</span><span class="ident" id="3101702">key</span>&nbsp;<span class="builtintype" id="3101706">string</span><span class="op" id="3101712">)</span>&nbsp;<span class="op" id="3101714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3101717">g</span><span class="op" id="3101718">.</span><span class="ident" id="3101719">mu</span><span class="op" id="3101721">.</span><span class="ident" id="3101722">Lock</span><span class="op" id="3101726">(</span><span class="op" id="3101727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3101730">delete</span><span class="op" id="3101736">(</span><span class="ident" id="3101737">g</span><span class="op" id="3101738">.</span><span class="ident" id="3101739">m</span><span class="op" id="3101740">,</span>&nbsp;<span class="ident" id="3101742">key</span><span class="op" id="3101745">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3101748">g</span><span class="op" id="3101749">.</span><span class="ident" id="3101750">mu</span><span class="op" id="3101752">.</span><span class="ident" id="3101753">Unlock</span><span class="op" id="3101759">(</span><span class="op" id="3101760">)</span><br>
<span class="lineno"></span><span class="op" id="3101762">}</span>
</div>
</body>
</html>
