<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="6508889">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6508944">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6508998">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6509049">package</span>&nbsp;<span class="ident" id="6509057">time</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6509063">func</span>&nbsp;<span class="ident" id="6509068">init</span><span class="op" id="6509072">(</span><span class="op" id="6509073">)</span>&nbsp;<span class="op" id="6509075">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6509078">//&nbsp;force&nbsp;US/Pacific&nbsp;for&nbsp;time&nbsp;zone&nbsp;tests</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6509119"><a href="/time/export_test.go.html#6508703">ForceUSPacificForTesting</a></span><span class="op" id="6509143">(</span><span class="op" id="6509144">)</span><br>
<span class="lineno">10</span><span class="op" id="6509146">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6509149">var</span>&nbsp;<span class="ident" id="6509153">Interrupt</span>&nbsp;<span class="op" id="6509163">=</span>&nbsp;<span class="ident" id="6509165"><a href="/time/sys_unix.go.html#1577392">interrupt</a></span><br>
<span class="lineno"></span><span class="keyword" id="6509175">var</span>&nbsp;<span class="ident" id="6509179">DaysIn</span>&nbsp;<span class="op" id="6509186">=</span>&nbsp;<span class="ident" id="6509188"><a href="/time/time.go.html#1602810">daysIn</a></span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="6509196">func</span>&nbsp;<span class="ident" id="6509201">empty</span><span class="op" id="6509206">(</span><span class="ident" id="6509207">arg</span>&nbsp;<span class="keyword" id="6509211">interface</span><span class="op" id="6509220">{</span><span class="op" id="6509221">}</span><span class="op" id="6509222">,</span>&nbsp;<span class="ident" id="6509224">seq</span>&nbsp;<span class="builtintype" id="6509228">uintptr</span><span class="op" id="6509235">)</span>&nbsp;<span class="op" id="6509237">{</span><span class="op" id="6509238">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6509241">//&nbsp;Test&nbsp;that&nbsp;a&nbsp;runtimeTimer&nbsp;with&nbsp;a&nbsp;duration&nbsp;so&nbsp;large&nbsp;it&nbsp;overflows</span><br>
<span class="lineno"></span><span class="comment" id="6509307">//&nbsp;does&nbsp;not&nbsp;cause&nbsp;other&nbsp;timers&nbsp;to&nbsp;hang.</span><br>
<span class="lineno"></span><span class="comment" id="6509347">//</span><br>
<span class="lineno">20</span><span class="comment" id="6509350">//&nbsp;This&nbsp;test&nbsp;has&nbsp;to&nbsp;be&nbsp;in&nbsp;internal_test.go&nbsp;since&nbsp;it&nbsp;fiddles&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="6509415">//&nbsp;unexported&nbsp;data&nbsp;structures.</span><br>
<span class="lineno"></span><span class="keyword" id="6509446">func</span>&nbsp;<span class="ident" id="6509451">CheckRuntimeTimerOverflow</span><span class="op" id="6509476">(</span><span class="op" id="6509477">)</span>&nbsp;<span class="op" id="6509479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6509482">//&nbsp;We&nbsp;manually&nbsp;create&nbsp;a&nbsp;runtimeTimer&nbsp;to&nbsp;bypass&nbsp;the&nbsp;overflow</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6509543">//&nbsp;detection&nbsp;logic&nbsp;in&nbsp;NewTimer:&nbsp;we&#39;re&nbsp;testing&nbsp;the&nbsp;underlying</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6509605">//&nbsp;runtime.addtimer&nbsp;function.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6509636">r</span>&nbsp;<span class="op" id="6509638">:=</span>&nbsp;<span class="op" id="6509641">&amp;</span><span class="ident" id="6509642"><a href="/time/sleep.go.html#1574149">runtimeTimer</a></span><span class="op" id="6509654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6509658">when</span><span class="op" id="6509662">:</span>&nbsp;<span class="ident" id="6509664"><a href="/time/sleep.go.html#1574007">runtimeNano</a></span><span class="op" id="6509675">(</span><span class="op" id="6509676">)</span>&nbsp;<span class="op" id="6509678">+</span>&nbsp;<span class="op" id="6509680">(</span><span class="num" id="6509681">1</span><span class="op" id="6509682">&lt;&lt;</span><span class="num" id="6509684">63</span>&nbsp;<span class="op" id="6509687">-</span>&nbsp;<span class="num" id="6509689">1</span><span class="op" id="6509690">)</span><span class="op" id="6509691">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6509695">f</span><span class="op" id="6509696">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6509701"><a href="/time/internal_test.go.html#6509201">empty</a></span><span class="op" id="6509706">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6509710">arg</span><span class="op" id="6509713">:</span>&nbsp;&nbsp;<span class="ident" id="6509716">nil</span><span class="op" id="6509719">,</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6509722">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6509725"><a href="/time/sleep.go.html#1574768">startTimer</a></span><span class="op" id="6509735">(</span><span class="ident" id="6509736"><a href="/time/internal_test.go.html#6509636">r</a></span><span class="op" id="6509737">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6509741">//&nbsp;Start&nbsp;a&nbsp;goroutine&nbsp;that&nbsp;should&nbsp;send&nbsp;on&nbsp;t.C&nbsp;right&nbsp;away.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6509799">t</span>&nbsp;<span class="op" id="6509801">:=</span>&nbsp;<span class="ident" id="6509804"><a href="/time/sleep.go.html#1575583">NewTimer</a></span><span class="op" id="6509812">(</span><span class="num" id="6509813">1</span><span class="op" id="6509814">)</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="6509818">defer</span>&nbsp;<span class="keyword" id="6509824">func</span><span class="op" id="6509828">(</span><span class="op" id="6509829">)</span>&nbsp;<span class="op" id="6509831">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6509835">//&nbsp;Subsequent&nbsp;tests&nbsp;won&#39;t&nbsp;work&nbsp;correctly&nbsp;if&nbsp;we&nbsp;don&#39;t&nbsp;stop&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6509899">//&nbsp;overflow&nbsp;timer&nbsp;and&nbsp;kick&nbsp;the&nbsp;timer&nbsp;proc&nbsp;back&nbsp;into&nbsp;service.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6509962">//</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6509967">//&nbsp;The&nbsp;timer&nbsp;proc&nbsp;is&nbsp;now&nbsp;sleeping&nbsp;and&nbsp;can&nbsp;only&nbsp;be&nbsp;awoken&nbsp;by</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6510029">//&nbsp;adding&nbsp;a&nbsp;timer&nbsp;to&nbsp;the&nbsp;*beginning*&nbsp;of&nbsp;the&nbsp;heap.&nbsp;We&nbsp;can&#39;t</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6510090">//&nbsp;wake&nbsp;it&nbsp;up&nbsp;by&nbsp;calling&nbsp;NewTimer&nbsp;since&nbsp;other&nbsp;tests&nbsp;may&nbsp;have</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6510153">//&nbsp;left&nbsp;timers&nbsp;running&nbsp;that&nbsp;should&nbsp;have&nbsp;expired&nbsp;before&nbsp;ours.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6510216">//&nbsp;Instead&nbsp;we&nbsp;zero&nbsp;the&nbsp;overflow&nbsp;timer&nbsp;duration&nbsp;and&nbsp;start&nbsp;it</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6510278">//&nbsp;once&nbsp;more.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6510294"><a href="/time/sleep.go.html#1574799">stopTimer</a></span><span class="op" id="6510303">(</span><span class="ident" id="6510304"><a href="/time/internal_test.go.html#6509636">r</a></span><span class="op" id="6510305">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6510309"><a href="/time/internal_test.go.html#6509799">t</a></span><span class="op" id="6510310">.</span><span class="ident" id="6510311">Stop</span><span class="op" id="6510315">(</span><span class="op" id="6510316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6510320"><a href="/time/internal_test.go.html#6509636">r</a></span><span class="op" id="6510321">.</span><span class="ident" id="6510322">when</span>&nbsp;<span class="op" id="6510327">=</span>&nbsp;<span class="num" id="6510329">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="6510333"><a href="/time/sleep.go.html#1574768">startTimer</a></span><span class="op" id="6510343">(</span><span class="ident" id="6510344"><a href="/time/internal_test.go.html#6509636">r</a></span><span class="op" id="6510345">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6510348">}</span><span class="op" id="6510349">(</span><span class="op" id="6510350">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6510354">//&nbsp;If&nbsp;the&nbsp;test&nbsp;fails,&nbsp;we&nbsp;will&nbsp;hang&nbsp;here&nbsp;until&nbsp;the&nbsp;timeout&nbsp;in&nbsp;the&nbsp;testing&nbsp;package</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6510436">//&nbsp;fires,&nbsp;which&nbsp;is&nbsp;10&nbsp;minutes.&nbsp;It&nbsp;would&nbsp;be&nbsp;nice&nbsp;to&nbsp;catch&nbsp;the&nbsp;problem&nbsp;sooner,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6510514">//&nbsp;but&nbsp;there&nbsp;is&nbsp;no&nbsp;reliable&nbsp;way&nbsp;to&nbsp;guarantee&nbsp;that&nbsp;timerproc&nbsp;schedules&nbsp;without</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6510593">//&nbsp;doing&nbsp;something&nbsp;involving&nbsp;timerproc&nbsp;itself.&nbsp;Previous&nbsp;failed&nbsp;attempts&nbsp;have</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6510671">//&nbsp;tried&nbsp;calling&nbsp;runtime.Gosched&nbsp;and&nbsp;runtime.GC,&nbsp;but&nbsp;neither&nbsp;is&nbsp;reliable.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="6510746">//&nbsp;So&nbsp;we&nbsp;fall&nbsp;back&nbsp;to&nbsp;hope:&nbsp;We&nbsp;hope&nbsp;we&nbsp;don&#39;t&nbsp;hang&nbsp;here.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="6510803">&lt;-</span><span class="ident" id="6510805"><a href="/time/internal_test.go.html#6509799">t</a></span><span class="op" id="6510806">.</span><span class="ident" id="6510807">C</span><br>
<span class="lineno"></span><span class="op" id="6510809">}</span>
</div>
</body>
</html>
