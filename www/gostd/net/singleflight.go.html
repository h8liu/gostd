<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4146033">//&nbsp;Copyright&nbsp;2013&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4146089">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4146143">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4146194">package</span>&nbsp;<span class="ident" id="4146202">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4146207">import</span>&nbsp;<span class="string" id="4146214">&#34;sync&#34;</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4146222">//&nbsp;call&nbsp;is&nbsp;an&nbsp;in-flight&nbsp;or&nbsp;completed&nbsp;singleflight.Do&nbsp;call</span><br>
<span class="lineno">10</span><span class="keyword" id="4146280">type</span>&nbsp;<span class="ident" id="4146285">call</span>&nbsp;<span class="keyword" id="4146290">struct</span>&nbsp;<span class="op" id="4146297">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4146300">wg</span>&nbsp;<span class="ident" id="4146303">sync</span><span class="op" id="4146307">.</span><span class="ident" id="4146308">WaitGroup</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4146320">//&nbsp;These&nbsp;fields&nbsp;are&nbsp;written&nbsp;once&nbsp;before&nbsp;the&nbsp;WaitGroup&nbsp;is&nbsp;done</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4146383">//&nbsp;and&nbsp;are&nbsp;only&nbsp;read&nbsp;after&nbsp;the&nbsp;WaitGroup&nbsp;is&nbsp;done.</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4146434">val</span>&nbsp;<span class="keyword" id="4146438">interface</span><span class="op" id="4146447">{</span><span class="op" id="4146448">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4146451">err</span>&nbsp;<span class="builtintype" id="4146455">error</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4146463">//&nbsp;These&nbsp;fields&nbsp;are&nbsp;read&nbsp;and&nbsp;written&nbsp;with&nbsp;the&nbsp;singleflight</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4146523">//&nbsp;mutex&nbsp;held&nbsp;before&nbsp;the&nbsp;WaitGroup&nbsp;is&nbsp;done,&nbsp;and&nbsp;are&nbsp;read&nbsp;but</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4146585">//&nbsp;not&nbsp;written&nbsp;after&nbsp;the&nbsp;WaitGroup&nbsp;is&nbsp;done.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4146630">dups</span>&nbsp;&nbsp;<span class="builtintype" id="4146636">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4146641">chans</span>&nbsp;<span class="op" id="4146647">[</span><span class="op" id="4146648">]</span><span class="keyword" id="4146649">chan</span><span class="op" id="4146653">&lt;-</span>&nbsp;<span class="ident" id="4146656">singleflightResult</span><br>
<span class="lineno"></span><span class="op" id="4146675">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="comment" id="4146678">//&nbsp;singleflight&nbsp;represents&nbsp;a&nbsp;class&nbsp;of&nbsp;work&nbsp;and&nbsp;forms&nbsp;a&nbsp;namespace&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="4146746">//&nbsp;which&nbsp;units&nbsp;of&nbsp;work&nbsp;can&nbsp;be&nbsp;executed&nbsp;with&nbsp;duplicate&nbsp;suppression.</span><br>
<span class="lineno"></span><span class="keyword" id="4146813">type</span>&nbsp;<span class="ident" id="4146818">singleflight</span>&nbsp;<span class="keyword" id="4146831">struct</span>&nbsp;<span class="op" id="4146838">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4146841">mu</span>&nbsp;<span class="ident" id="4146844">sync</span><span class="op" id="4146848">.</span><span class="ident" id="4146849">Mutex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="4146861">//&nbsp;protects&nbsp;m</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4146876">m</span>&nbsp;&nbsp;<span class="keyword" id="4146879">map</span><span class="op" id="4146882">[</span><span class="builtintype" id="4146883">string</span><span class="op" id="4146889">]</span><span class="op" id="4146890">*</span><span class="ident" id="4146891">call</span>&nbsp;<span class="comment" id="4146896">//&nbsp;lazily&nbsp;initialized</span><br>
<span class="lineno">30</span><span class="op" id="4146918">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4146921">//&nbsp;singleflightResult&nbsp;holds&nbsp;the&nbsp;results&nbsp;of&nbsp;Do,&nbsp;so&nbsp;they&nbsp;can&nbsp;be&nbsp;passed</span><br>
<span class="lineno"></span><span class="comment" id="4146990">//&nbsp;on&nbsp;a&nbsp;channel.</span><br>
<span class="lineno"></span><span class="keyword" id="4147007">type</span>&nbsp;<span class="ident" id="4147012">singleflightResult</span>&nbsp;<span class="keyword" id="4147031">struct</span>&nbsp;<span class="op" id="4147038">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4147041">v</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="4147048">interface</span><span class="op" id="4147057">{</span><span class="op" id="4147058">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4147061">err</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4147068">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4147075">shared</span>&nbsp;<span class="builtintype" id="4147082">bool</span><br>
<span class="lineno"></span><span class="op" id="4147087">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="comment" id="4147090">//&nbsp;Do&nbsp;executes&nbsp;and&nbsp;returns&nbsp;the&nbsp;results&nbsp;of&nbsp;the&nbsp;given&nbsp;function,&nbsp;making</span><br>
<span class="lineno"></span><span class="comment" id="4147159">//&nbsp;sure&nbsp;that&nbsp;only&nbsp;one&nbsp;execution&nbsp;is&nbsp;in-flight&nbsp;for&nbsp;a&nbsp;given&nbsp;key&nbsp;at&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="4147225">//&nbsp;time.&nbsp;If&nbsp;a&nbsp;duplicate&nbsp;comes&nbsp;in,&nbsp;the&nbsp;duplicate&nbsp;caller&nbsp;waits&nbsp;for&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4147294">//&nbsp;original&nbsp;to&nbsp;complete&nbsp;and&nbsp;receives&nbsp;the&nbsp;same&nbsp;results.</span><br>
<span class="lineno"></span><span class="comment" id="4147349">//&nbsp;The&nbsp;return&nbsp;value&nbsp;shared&nbsp;indicates&nbsp;whether&nbsp;v&nbsp;was&nbsp;given&nbsp;to&nbsp;multiple&nbsp;callers.</span><br>
<span class="lineno">45</span><span class="keyword" id="4147427">func</span>&nbsp;<span class="op" id="4147432">(</span><span class="ident" id="4147433">g</span>&nbsp;<span class="op" id="4147435">*</span><span class="ident" id="4147436">singleflight</span><span class="op" id="4147448">)</span>&nbsp;<span class="ident" id="4147450">Do</span><span class="op" id="4147452">(</span><span class="ident" id="4147453">key</span>&nbsp;<span class="builtintype" id="4147457">string</span><span class="op" id="4147463">,</span>&nbsp;<span class="ident" id="4147465">fn</span>&nbsp;<span class="keyword" id="4147468">func</span><span class="op" id="4147472">(</span><span class="op" id="4147473">)</span>&nbsp;<span class="op" id="4147475">(</span><span class="keyword" id="4147476">interface</span><span class="op" id="4147485">{</span><span class="op" id="4147486">}</span><span class="op" id="4147487">,</span>&nbsp;<span class="builtintype" id="4147489">error</span><span class="op" id="4147494">)</span><span class="op" id="4147495">)</span>&nbsp;<span class="op" id="4147497">(</span><span class="ident" id="4147498">v</span>&nbsp;<span class="keyword" id="4147500">interface</span><span class="op" id="4147509">{</span><span class="op" id="4147510">}</span><span class="op" id="4147511">,</span>&nbsp;<span class="ident" id="4147513">err</span>&nbsp;<span class="builtintype" id="4147517">error</span><span class="op" id="4147522">,</span>&nbsp;<span class="ident" id="4147524">shared</span>&nbsp;<span class="builtintype" id="4147531">bool</span><span class="op" id="4147535">)</span>&nbsp;<span class="op" id="4147537">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4147540">g</span><span class="op" id="4147541">.</span><span class="ident" id="4147542">mu</span><span class="op" id="4147544">.</span><span class="ident" id="4147545">Lock</span><span class="op" id="4147549">(</span><span class="op" id="4147550">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4147553">if</span>&nbsp;<span class="ident" id="4147556">g</span><span class="op" id="4147557">.</span><span class="ident" id="4147558">m</span>&nbsp;<span class="op" id="4147560">==</span>&nbsp;<span class="ident" id="4147563">nil</span>&nbsp;<span class="op" id="4147567">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4147571">g</span><span class="op" id="4147572">.</span><span class="ident" id="4147573">m</span>&nbsp;<span class="op" id="4147575">=</span>&nbsp;<span class="builtinfunc" id="4147577">make</span><span class="op" id="4147581">(</span><span class="keyword" id="4147582">map</span><span class="op" id="4147585">[</span><span class="builtintype" id="4147586">string</span><span class="op" id="4147592">]</span><span class="op" id="4147593">*</span><span class="ident" id="4147594">call</span><span class="op" id="4147598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4147601">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4147604">if</span>&nbsp;<span class="ident" id="4147607">c</span><span class="op" id="4147608">,</span>&nbsp;<span class="ident" id="4147610">ok</span>&nbsp;<span class="op" id="4147613">:=</span>&nbsp;<span class="ident" id="4147616">g</span><span class="op" id="4147617">.</span><span class="ident" id="4147618">m</span><span class="op" id="4147619">[</span><span class="ident" id="4147620">key</span><span class="op" id="4147623">]</span><span class="op" id="4147624">;</span>&nbsp;<span class="ident" id="4147626">ok</span>&nbsp;<span class="op" id="4147629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4147633">c</span><span class="op" id="4147634">.</span><span class="ident" id="4147635">dups</span><span class="op" id="4147639">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4147644">g</span><span class="op" id="4147645">.</span><span class="ident" id="4147646">mu</span><span class="op" id="4147648">.</span><span class="ident" id="4147649">Unlock</span><span class="op" id="4147655">(</span><span class="op" id="4147656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4147660">c</span><span class="op" id="4147661">.</span><span class="ident" id="4147662">wg</span><span class="op" id="4147664">.</span><span class="ident" id="4147665">Wait</span><span class="op" id="4147669">(</span><span class="op" id="4147670">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4147674">return</span>&nbsp;<span class="ident" id="4147681">c</span><span class="op" id="4147682">.</span><span class="ident" id="4147683">val</span><span class="op" id="4147686">,</span>&nbsp;<span class="ident" id="4147688">c</span><span class="op" id="4147689">.</span><span class="ident" id="4147690">err</span><span class="op" id="4147693">,</span>&nbsp;<span class="builtintype" id="4147695">true</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4147701">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4147704">c</span>&nbsp;<span class="op" id="4147706">:=</span>&nbsp;<span class="builtinfunc" id="4147709">new</span><span class="op" id="4147712">(</span><span class="ident" id="4147713">call</span><span class="op" id="4147717">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4147720">c</span><span class="op" id="4147721">.</span><span class="ident" id="4147722">wg</span><span class="op" id="4147724">.</span><span class="ident" id="4147725">Add</span><span class="op" id="4147728">(</span><span class="num" id="4147729">1</span><span class="op" id="4147730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4147733">g</span><span class="op" id="4147734">.</span><span class="ident" id="4147735">m</span><span class="op" id="4147736">[</span><span class="ident" id="4147737">key</span><span class="op" id="4147740">]</span>&nbsp;<span class="op" id="4147742">=</span>&nbsp;<span class="ident" id="4147744">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4147747">g</span><span class="op" id="4147748">.</span><span class="ident" id="4147749">mu</span><span class="op" id="4147751">.</span><span class="ident" id="4147752">Unlock</span><span class="op" id="4147758">(</span><span class="op" id="4147759">)</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4147763">g</span><span class="op" id="4147764">.</span><span class="ident" id="4147765">doCall</span><span class="op" id="4147771">(</span><span class="ident" id="4147772">c</span><span class="op" id="4147773">,</span>&nbsp;<span class="ident" id="4147775">key</span><span class="op" id="4147778">,</span>&nbsp;<span class="ident" id="4147780">fn</span><span class="op" id="4147782">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4147785">return</span>&nbsp;<span class="ident" id="4147792">c</span><span class="op" id="4147793">.</span><span class="ident" id="4147794">val</span><span class="op" id="4147797">,</span>&nbsp;<span class="ident" id="4147799">c</span><span class="op" id="4147800">.</span><span class="ident" id="4147801">err</span><span class="op" id="4147804">,</span>&nbsp;<span class="ident" id="4147806">c</span><span class="op" id="4147807">.</span><span class="ident" id="4147808">dups</span>&nbsp;<span class="op" id="4147813">&gt;</span>&nbsp;<span class="num" id="4147815">0</span><br>
<span class="lineno"></span><span class="op" id="4147817">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span><span class="comment" id="4147820">//&nbsp;DoChan&nbsp;is&nbsp;like&nbsp;Do&nbsp;but&nbsp;returns&nbsp;a&nbsp;channel&nbsp;that&nbsp;will&nbsp;receive&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4147885">//&nbsp;results&nbsp;when&nbsp;they&nbsp;are&nbsp;ready.</span><br>
<span class="lineno"></span><span class="keyword" id="4147917">func</span>&nbsp;<span class="op" id="4147922">(</span><span class="ident" id="4147923">g</span>&nbsp;<span class="op" id="4147925">*</span><span class="ident" id="4147926">singleflight</span><span class="op" id="4147938">)</span>&nbsp;<span class="ident" id="4147940">DoChan</span><span class="op" id="4147946">(</span><span class="ident" id="4147947">key</span>&nbsp;<span class="builtintype" id="4147951">string</span><span class="op" id="4147957">,</span>&nbsp;<span class="ident" id="4147959">fn</span>&nbsp;<span class="keyword" id="4147962">func</span><span class="op" id="4147966">(</span><span class="op" id="4147967">)</span>&nbsp;<span class="op" id="4147969">(</span><span class="keyword" id="4147970">interface</span><span class="op" id="4147979">{</span><span class="op" id="4147980">}</span><span class="op" id="4147981">,</span>&nbsp;<span class="builtintype" id="4147983">error</span><span class="op" id="4147988">)</span><span class="op" id="4147989">)</span>&nbsp;<span class="op" id="4147991">&lt;-</span><span class="keyword" id="4147993">chan</span>&nbsp;<span class="ident" id="4147998">singleflightResult</span>&nbsp;<span class="op" id="4148017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4148020">ch</span>&nbsp;<span class="op" id="4148023">:=</span>&nbsp;<span class="builtinfunc" id="4148026">make</span><span class="op" id="4148030">(</span><span class="keyword" id="4148031">chan</span>&nbsp;<span class="ident" id="4148036">singleflightResult</span><span class="op" id="4148054">,</span>&nbsp;<span class="num" id="4148056">1</span><span class="op" id="4148057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4148060">g</span><span class="op" id="4148061">.</span><span class="ident" id="4148062">mu</span><span class="op" id="4148064">.</span><span class="ident" id="4148065">Lock</span><span class="op" id="4148069">(</span><span class="op" id="4148070">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4148073">if</span>&nbsp;<span class="ident" id="4148076">g</span><span class="op" id="4148077">.</span><span class="ident" id="4148078">m</span>&nbsp;<span class="op" id="4148080">==</span>&nbsp;<span class="ident" id="4148083">nil</span>&nbsp;<span class="op" id="4148087">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4148091">g</span><span class="op" id="4148092">.</span><span class="ident" id="4148093">m</span>&nbsp;<span class="op" id="4148095">=</span>&nbsp;<span class="builtinfunc" id="4148097">make</span><span class="op" id="4148101">(</span><span class="keyword" id="4148102">map</span><span class="op" id="4148105">[</span><span class="builtintype" id="4148106">string</span><span class="op" id="4148112">]</span><span class="op" id="4148113">*</span><span class="ident" id="4148114">call</span><span class="op" id="4148118">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4148121">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4148124">if</span>&nbsp;<span class="ident" id="4148127">c</span><span class="op" id="4148128">,</span>&nbsp;<span class="ident" id="4148130">ok</span>&nbsp;<span class="op" id="4148133">:=</span>&nbsp;<span class="ident" id="4148136">g</span><span class="op" id="4148137">.</span><span class="ident" id="4148138">m</span><span class="op" id="4148139">[</span><span class="ident" id="4148140">key</span><span class="op" id="4148143">]</span><span class="op" id="4148144">;</span>&nbsp;<span class="ident" id="4148146">ok</span>&nbsp;<span class="op" id="4148149">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4148153">c</span><span class="op" id="4148154">.</span><span class="ident" id="4148155">dups</span><span class="op" id="4148159">++</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4148164">c</span><span class="op" id="4148165">.</span><span class="ident" id="4148166">chans</span>&nbsp;<span class="op" id="4148172">=</span>&nbsp;<span class="builtinfunc" id="4148174">append</span><span class="op" id="4148180">(</span><span class="ident" id="4148181">c</span><span class="op" id="4148182">.</span><span class="ident" id="4148183">chans</span><span class="op" id="4148188">,</span>&nbsp;<span class="ident" id="4148190">ch</span><span class="op" id="4148192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4148196">g</span><span class="op" id="4148197">.</span><span class="ident" id="4148198">mu</span><span class="op" id="4148200">.</span><span class="ident" id="4148201">Unlock</span><span class="op" id="4148207">(</span><span class="op" id="4148208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4148212">return</span>&nbsp;<span class="ident" id="4148219">ch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4148223">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4148226">c</span>&nbsp;<span class="op" id="4148228">:=</span>&nbsp;<span class="op" id="4148231">&amp;</span><span class="ident" id="4148232">call</span><span class="op" id="4148236">{</span><span class="ident" id="4148237">chans</span><span class="op" id="4148242">:</span>&nbsp;<span class="op" id="4148244">[</span><span class="op" id="4148245">]</span><span class="keyword" id="4148246">chan</span><span class="op" id="4148250">&lt;-</span>&nbsp;<span class="ident" id="4148253">singleflightResult</span><span class="op" id="4148271">{</span><span class="ident" id="4148272">ch</span><span class="op" id="4148274">}</span><span class="op" id="4148275">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4148278">c</span><span class="op" id="4148279">.</span><span class="ident" id="4148280">wg</span><span class="op" id="4148282">.</span><span class="ident" id="4148283">Add</span><span class="op" id="4148286">(</span><span class="num" id="4148287">1</span><span class="op" id="4148288">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4148291">g</span><span class="op" id="4148292">.</span><span class="ident" id="4148293">m</span><span class="op" id="4148294">[</span><span class="ident" id="4148295">key</span><span class="op" id="4148298">]</span>&nbsp;<span class="op" id="4148300">=</span>&nbsp;<span class="ident" id="4148302">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4148305">g</span><span class="op" id="4148306">.</span><span class="ident" id="4148307">mu</span><span class="op" id="4148309">.</span><span class="ident" id="4148310">Unlock</span><span class="op" id="4148316">(</span><span class="op" id="4148317">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4148321">go</span>&nbsp;<span class="ident" id="4148324">g</span><span class="op" id="4148325">.</span><span class="ident" id="4148326">doCall</span><span class="op" id="4148332">(</span><span class="ident" id="4148333">c</span><span class="op" id="4148334">,</span>&nbsp;<span class="ident" id="4148336">key</span><span class="op" id="4148339">,</span>&nbsp;<span class="ident" id="4148341">fn</span><span class="op" id="4148343">)</span><br>
<span class="lineno">85</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4148347">return</span>&nbsp;<span class="ident" id="4148354">ch</span><br>
<span class="lineno"></span><span class="op" id="4148357">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4148360">//&nbsp;doCall&nbsp;handles&nbsp;the&nbsp;single&nbsp;call&nbsp;for&nbsp;a&nbsp;key.</span><br>
<span class="lineno">90</span><span class="keyword" id="4148405">func</span>&nbsp;<span class="op" id="4148410">(</span><span class="ident" id="4148411">g</span>&nbsp;<span class="op" id="4148413">*</span><span class="ident" id="4148414">singleflight</span><span class="op" id="4148426">)</span>&nbsp;<span class="ident" id="4148428">doCall</span><span class="op" id="4148434">(</span><span class="ident" id="4148435">c</span>&nbsp;<span class="op" id="4148437">*</span><span class="ident" id="4148438">call</span><span class="op" id="4148442">,</span>&nbsp;<span class="ident" id="4148444">key</span>&nbsp;<span class="builtintype" id="4148448">string</span><span class="op" id="4148454">,</span>&nbsp;<span class="ident" id="4148456">fn</span>&nbsp;<span class="keyword" id="4148459">func</span><span class="op" id="4148463">(</span><span class="op" id="4148464">)</span>&nbsp;<span class="op" id="4148466">(</span><span class="keyword" id="4148467">interface</span><span class="op" id="4148476">{</span><span class="op" id="4148477">}</span><span class="op" id="4148478">,</span>&nbsp;<span class="builtintype" id="4148480">error</span><span class="op" id="4148485">)</span><span class="op" id="4148486">)</span>&nbsp;<span class="op" id="4148488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4148491">c</span><span class="op" id="4148492">.</span><span class="ident" id="4148493">val</span><span class="op" id="4148496">,</span>&nbsp;<span class="ident" id="4148498">c</span><span class="op" id="4148499">.</span><span class="ident" id="4148500">err</span>&nbsp;<span class="op" id="4148504">=</span>&nbsp;<span class="ident" id="4148506">fn</span><span class="op" id="4148508">(</span><span class="op" id="4148509">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4148512">c</span><span class="op" id="4148513">.</span><span class="ident" id="4148514">wg</span><span class="op" id="4148516">.</span><span class="ident" id="4148517">Done</span><span class="op" id="4148521">(</span><span class="op" id="4148522">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4148526">g</span><span class="op" id="4148527">.</span><span class="ident" id="4148528">mu</span><span class="op" id="4148530">.</span><span class="ident" id="4148531">Lock</span><span class="op" id="4148535">(</span><span class="op" id="4148536">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4148539">delete</span><span class="op" id="4148545">(</span><span class="ident" id="4148546">g</span><span class="op" id="4148547">.</span><span class="ident" id="4148548">m</span><span class="op" id="4148549">,</span>&nbsp;<span class="ident" id="4148551">key</span><span class="op" id="4148554">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4148557">for</span>&nbsp;<span class="ident" id="4148561">_</span><span class="op" id="4148562">,</span>&nbsp;<span class="ident" id="4148564">ch</span>&nbsp;<span class="op" id="4148567">:=</span>&nbsp;<span class="keyword" id="4148570">range</span>&nbsp;<span class="ident" id="4148576">c</span><span class="op" id="4148577">.</span><span class="ident" id="4148578">chans</span>&nbsp;<span class="op" id="4148584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4148588">ch</span>&nbsp;<span class="op" id="4148591">&lt;-</span>&nbsp;<span class="ident" id="4148594">singleflightResult</span><span class="op" id="4148612">{</span><span class="ident" id="4148613">c</span><span class="op" id="4148614">.</span><span class="ident" id="4148615">val</span><span class="op" id="4148618">,</span>&nbsp;<span class="ident" id="4148620">c</span><span class="op" id="4148621">.</span><span class="ident" id="4148622">err</span><span class="op" id="4148625">,</span>&nbsp;<span class="ident" id="4148627">c</span><span class="op" id="4148628">.</span><span class="ident" id="4148629">dups</span>&nbsp;<span class="op" id="4148634">&gt;</span>&nbsp;<span class="num" id="4148636">0</span><span class="op" id="4148637">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4148640">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4148643">g</span><span class="op" id="4148644">.</span><span class="ident" id="4148645">mu</span><span class="op" id="4148647">.</span><span class="ident" id="4148648">Unlock</span><span class="op" id="4148654">(</span><span class="op" id="4148655">)</span><br>
<span class="lineno">100</span><span class="op" id="4148657">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4148660">//&nbsp;Forget&nbsp;tells&nbsp;the&nbsp;singleflight&nbsp;to&nbsp;forget&nbsp;about&nbsp;a&nbsp;key.&nbsp;&nbsp;Future&nbsp;calls</span><br>
<span class="lineno"></span><span class="comment" id="4148730">//&nbsp;to&nbsp;Do&nbsp;for&nbsp;this&nbsp;key&nbsp;will&nbsp;call&nbsp;the&nbsp;function&nbsp;rather&nbsp;than&nbsp;waiting&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="4148799">//&nbsp;an&nbsp;earlier&nbsp;call&nbsp;to&nbsp;complete.</span><br>
<span class="lineno">105</span><span class="keyword" id="4148831">func</span>&nbsp;<span class="op" id="4148836">(</span><span class="ident" id="4148837">g</span>&nbsp;<span class="op" id="4148839">*</span><span class="ident" id="4148840">singleflight</span><span class="op" id="4148852">)</span>&nbsp;<span class="ident" id="4148854">Forget</span><span class="op" id="4148860">(</span><span class="ident" id="4148861">key</span>&nbsp;<span class="builtintype" id="4148865">string</span><span class="op" id="4148871">)</span>&nbsp;<span class="op" id="4148873">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4148876">g</span><span class="op" id="4148877">.</span><span class="ident" id="4148878">mu</span><span class="op" id="4148880">.</span><span class="ident" id="4148881">Lock</span><span class="op" id="4148885">(</span><span class="op" id="4148886">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4148889">delete</span><span class="op" id="4148895">(</span><span class="ident" id="4148896">g</span><span class="op" id="4148897">.</span><span class="ident" id="4148898">m</span><span class="op" id="4148899">,</span>&nbsp;<span class="ident" id="4148901">key</span><span class="op" id="4148904">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4148907">g</span><span class="op" id="4148908">.</span><span class="ident" id="4148909">mu</span><span class="op" id="4148911">.</span><span class="ident" id="4148912">Unlock</span><span class="op" id="4148918">(</span><span class="op" id="4148919">)</span><br>
<span class="lineno"></span><span class="op" id="4148921">}</span>
</div>
</body>
</html>
