<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/mail</h2>
<ul>
<li><a href="/gostd/net/mail/message.go.html" class="current">message.go</a></li>
<li><a href="/gostd/net/mail/message_test.go.html">message_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5863806">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5863861">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5863915">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5863966">/*<br>
<span class="lineno"></span>Package&nbsp;mail&nbsp;implements&nbsp;parsing&nbsp;of&nbsp;mail&nbsp;messages.<br>
<span class="lineno"></span><br>
<span class="lineno"></span>For&nbsp;the&nbsp;most&nbsp;part,&nbsp;this&nbsp;package&nbsp;follows&nbsp;the&nbsp;syntax&nbsp;as&nbsp;specified&nbsp;by&nbsp;RFC&nbsp;5322.<br>
<span class="lineno"></span>Notable&nbsp;divergences:<br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Obsolete&nbsp;address&nbsp;formats&nbsp;are&nbsp;not&nbsp;parsed,&nbsp;including&nbsp;addresses&nbsp;with<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;embedded&nbsp;route&nbsp;information.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Group&nbsp;addresses&nbsp;are&nbsp;not&nbsp;parsed.<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;The&nbsp;full&nbsp;range&nbsp;of&nbsp;spacing&nbsp;(the&nbsp;CFWS&nbsp;syntax&nbsp;element)&nbsp;is&nbsp;not&nbsp;supported,<br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;such&nbsp;as&nbsp;breaking&nbsp;addresses&nbsp;across&nbsp;lines.<br>
<span class="lineno">15</span>*/</span><br>
<span class="lineno"></span><span class="keyword" id="5864373">package</span>&nbsp;<span class="ident" id="5864381">mail</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5864387">import</span>&nbsp;<span class="op" id="5864394">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5864397">&#34;bufio&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5864406">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5864415">&#34;encoding/base64&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5864434">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5864444">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5864451">&#34;io&#34;</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5864457">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5864470">&#34;log&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5864477">&#34;net/textproto&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5864494">&#34;strconv&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5864505">&#34;strings&#34;</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5864516">&#34;time&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5864524">&#34;unicode&#34;</span><br>
<span class="lineno"></span><span class="op" id="5864534">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5864537">var</span>&nbsp;<span class="ident" id="5864541">debug</span>&nbsp;<span class="op" id="5864547">=</span>&nbsp;<span class="ident" id="5864549">debugT</span><span class="op" id="5864555">(</span><span class="builtintype" id="5864556">false</span><span class="op" id="5864561">)</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="5864564">type</span>&nbsp;<span class="ident" id="5864569">debugT</span>&nbsp;<span class="builtintype" id="5864576">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5864582">func</span>&nbsp;<span class="op" id="5864587">(</span><span class="ident" id="5864588">d</span>&nbsp;<span class="ident" id="5864590">debugT</span><span class="op" id="5864596">)</span>&nbsp;<span class="ident" id="5864598">Printf</span><span class="op" id="5864604">(</span><span class="ident" id="5864605">format</span>&nbsp;<span class="builtintype" id="5864612">string</span><span class="op" id="5864618">,</span>&nbsp;<span class="ident" id="5864620">args</span>&nbsp;<span class="op" id="5864625">...</span><span class="keyword" id="5864628">interface</span><span class="op" id="5864637">{</span><span class="op" id="5864638">}</span><span class="op" id="5864639">)</span>&nbsp;<span class="op" id="5864641">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5864644">if</span>&nbsp;<span class="ident" id="5864647">d</span>&nbsp;<span class="op" id="5864649">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5864653">log</span><span class="op" id="5864656">.</span><span class="ident" id="5864657">Printf</span><span class="op" id="5864663">(</span><span class="ident" id="5864664">format</span><span class="op" id="5864670">,</span>&nbsp;<span class="ident" id="5864672">args</span><span class="op" id="5864676">...</span><span class="op" id="5864679">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5864682">}</span><br>
<span class="lineno"></span><span class="op" id="5864684">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5864687">//&nbsp;A&nbsp;Message&nbsp;represents&nbsp;a&nbsp;parsed&nbsp;mail&nbsp;message.</span><br>
<span class="lineno">45</span><span class="keyword" id="5864734">type</span>&nbsp;<span class="ident" id="5864739">Message</span>&nbsp;<span class="keyword" id="5864747">struct</span>&nbsp;<span class="op" id="5864754">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5864757">Header</span>&nbsp;<span class="ident" id="5864764">Header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5864772">Body</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5864779">io</span><span class="op" id="5864781">.</span><span class="ident" id="5864782">Reader</span><br>
<span class="lineno"></span><span class="op" id="5864789">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">50</span><span class="comment" id="5864792">//&nbsp;ReadMessage&nbsp;reads&nbsp;a&nbsp;message&nbsp;from&nbsp;r.</span><br>
<span class="lineno"></span><span class="comment" id="5864831">//&nbsp;The&nbsp;headers&nbsp;are&nbsp;parsed,&nbsp;and&nbsp;the&nbsp;body&nbsp;of&nbsp;the&nbsp;message&nbsp;will&nbsp;be&nbsp;available</span><br>
<span class="lineno"></span><span class="comment" id="5864904">//&nbsp;for&nbsp;reading&nbsp;from&nbsp;r.</span><br>
<span class="lineno"></span><span class="keyword" id="5864927">func</span>&nbsp;<span class="ident" id="5864932">ReadMessage</span><span class="op" id="5864943">(</span><span class="ident" id="5864944">r</span>&nbsp;<span class="ident" id="5864946">io</span><span class="op" id="5864948">.</span><span class="ident" id="5864949">Reader</span><span class="op" id="5864955">)</span>&nbsp;<span class="op" id="5864957">(</span><span class="ident" id="5864958">msg</span>&nbsp;<span class="op" id="5864962">*</span><span class="ident" id="5864963">Message</span><span class="op" id="5864970">,</span>&nbsp;<span class="ident" id="5864972">err</span>&nbsp;<span class="builtintype" id="5864976">error</span><span class="op" id="5864981">)</span>&nbsp;<span class="op" id="5864983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5864986">tp</span>&nbsp;<span class="op" id="5864989">:=</span>&nbsp;<span class="ident" id="5864992">textproto</span><span class="op" id="5865001">.</span><span class="ident" id="5865002">NewReader</span><span class="op" id="5865011">(</span><span class="ident" id="5865012">bufio</span><span class="op" id="5865017">.</span><span class="ident" id="5865018">NewReader</span><span class="op" id="5865027">(</span><span class="ident" id="5865028">r</span><span class="op" id="5865029">)</span><span class="op" id="5865030">)</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5865034">hdr</span><span class="op" id="5865037">,</span>&nbsp;<span class="ident" id="5865039">err</span>&nbsp;<span class="op" id="5865043">:=</span>&nbsp;<span class="ident" id="5865046">tp</span><span class="op" id="5865048">.</span><span class="ident" id="5865049">ReadMIMEHeader</span><span class="op" id="5865063">(</span><span class="op" id="5865064">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5865067">if</span>&nbsp;<span class="ident" id="5865070">err</span>&nbsp;<span class="op" id="5865074">!=</span>&nbsp;<span class="builtintype" id="5865077">nil</span>&nbsp;<span class="op" id="5865081">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5865085">return</span>&nbsp;<span class="builtintype" id="5865092">nil</span><span class="op" id="5865095">,</span>&nbsp;<span class="ident" id="5865097">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5865102">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5865106">return</span>&nbsp;<span class="op" id="5865113">&amp;</span><span class="ident" id="5865114">Message</span><span class="op" id="5865121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5865125">Header</span><span class="op" id="5865131">:</span>&nbsp;<span class="ident" id="5865133">Header</span><span class="op" id="5865139">(</span><span class="ident" id="5865140">hdr</span><span class="op" id="5865143">)</span><span class="op" id="5865144">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5865148">Body</span><span class="op" id="5865152">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="5865156">tp</span><span class="op" id="5865158">.</span><span class="ident" id="5865159">R</span><span class="op" id="5865160">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5865163">}</span><span class="op" id="5865164">,</span>&nbsp;<span class="builtintype" id="5865166">nil</span><br>
<span class="lineno">65</span><span class="op" id="5865170">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5865173">//&nbsp;Layouts&nbsp;suitable&nbsp;for&nbsp;passing&nbsp;to&nbsp;time.Parse.</span><br>
<span class="lineno"></span><span class="comment" id="5865220">//&nbsp;These&nbsp;are&nbsp;tried&nbsp;in&nbsp;order.</span><br>
<span class="lineno"></span><span class="keyword" id="5865249">var</span>&nbsp;<span class="ident" id="5865253">dateLayouts</span>&nbsp;<span class="op" id="5865265">[</span><span class="op" id="5865266">]</span><span class="builtintype" id="5865267">string</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="keyword" id="5865275">func</span>&nbsp;<span class="ident" id="5865280">init</span><span class="op" id="5865284">(</span><span class="op" id="5865285">)</span>&nbsp;<span class="op" id="5865287">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5865290">//&nbsp;Generate&nbsp;layouts&nbsp;based&nbsp;on&nbsp;RFC&nbsp;5322,&nbsp;section&nbsp;3.3.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5865344">dows</span>&nbsp;<span class="op" id="5865349">:=</span>&nbsp;<span class="op" id="5865352">[</span><span class="op" id="5865353">...</span><span class="op" id="5865356">]</span><span class="builtintype" id="5865357">string</span><span class="op" id="5865363">{</span><span class="string" id="5865364">&#34;&#34;</span><span class="op" id="5865366">,</span>&nbsp;<span class="string" id="5865368">&#34;Mon,&nbsp;&#34;</span><span class="op" id="5865375">}</span>&nbsp;&nbsp;&nbsp;<span class="comment" id="5865379">//&nbsp;day-of-week</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5865395">days</span>&nbsp;<span class="op" id="5865400">:=</span>&nbsp;<span class="op" id="5865403">[</span><span class="op" id="5865404">...</span><span class="op" id="5865407">]</span><span class="builtintype" id="5865408">string</span><span class="op" id="5865414">{</span><span class="string" id="5865415">&#34;2&#34;</span><span class="op" id="5865418">,</span>&nbsp;<span class="string" id="5865420">&#34;02&#34;</span><span class="op" id="5865424">}</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5865430">//&nbsp;day&nbsp;=&nbsp;1*2DIGIT</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5865449">years</span>&nbsp;<span class="op" id="5865455">:=</span>&nbsp;<span class="op" id="5865458">[</span><span class="op" id="5865459">...</span><span class="op" id="5865462">]</span><span class="builtintype" id="5865463">string</span><span class="op" id="5865469">{</span><span class="string" id="5865470">&#34;2006&#34;</span><span class="op" id="5865476">,</span>&nbsp;<span class="string" id="5865478">&#34;06&#34;</span><span class="op" id="5865482">}</span>&nbsp;<span class="comment" id="5865484">//&nbsp;year&nbsp;=&nbsp;4*DIGIT&nbsp;/&nbsp;2*DIGIT</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5865513">seconds</span>&nbsp;<span class="op" id="5865521">:=</span>&nbsp;<span class="op" id="5865524">[</span><span class="op" id="5865525">...</span><span class="op" id="5865528">]</span><span class="builtintype" id="5865529">string</span><span class="op" id="5865535">{</span><span class="string" id="5865536">&#34;:05&#34;</span><span class="op" id="5865541">,</span>&nbsp;<span class="string" id="5865543">&#34;&#34;</span><span class="op" id="5865545">}</span>&nbsp;&nbsp;<span class="comment" id="5865548">//&nbsp;second</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5865559">//&nbsp;&#34;-0700&nbsp;(MST)&#34;&nbsp;is&nbsp;not&nbsp;in&nbsp;RFC&nbsp;5322,&nbsp;but&nbsp;is&nbsp;common.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5865612">zones</span>&nbsp;<span class="op" id="5865618">:=</span>&nbsp;<span class="op" id="5865621">[</span><span class="op" id="5865622">...</span><span class="op" id="5865625">]</span><span class="builtintype" id="5865626">string</span><span class="op" id="5865632">{</span><span class="string" id="5865633">&#34;-0700&#34;</span><span class="op" id="5865640">,</span>&nbsp;<span class="string" id="5865642">&#34;MST&#34;</span><span class="op" id="5865647">,</span>&nbsp;<span class="string" id="5865649">&#34;-0700&nbsp;(MST)&#34;</span><span class="op" id="5865662">}</span>&nbsp;<span class="comment" id="5865664">//&nbsp;zone&nbsp;=&nbsp;((&#34;+&#34;&nbsp;/&nbsp;&#34;-&#34;)&nbsp;4DIGIT)&nbsp;/&nbsp;&#34;GMT&#34;&nbsp;/&nbsp;...</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5865711">for</span>&nbsp;<span class="ident" id="5865715">_</span><span class="op" id="5865716">,</span>&nbsp;<span class="ident" id="5865718">dow</span>&nbsp;<span class="op" id="5865722">:=</span>&nbsp;<span class="keyword" id="5865725">range</span>&nbsp;<span class="ident" id="5865731">dows</span>&nbsp;<span class="op" id="5865736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5865740">for</span>&nbsp;<span class="ident" id="5865744">_</span><span class="op" id="5865745">,</span>&nbsp;<span class="ident" id="5865747">day</span>&nbsp;<span class="op" id="5865751">:=</span>&nbsp;<span class="keyword" id="5865754">range</span>&nbsp;<span class="ident" id="5865760">days</span>&nbsp;<span class="op" id="5865765">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5865770">for</span>&nbsp;<span class="ident" id="5865774">_</span><span class="op" id="5865775">,</span>&nbsp;<span class="ident" id="5865777">year</span>&nbsp;<span class="op" id="5865782">:=</span>&nbsp;<span class="keyword" id="5865785">range</span>&nbsp;<span class="ident" id="5865791">years</span>&nbsp;<span class="op" id="5865797">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5865803">for</span>&nbsp;<span class="ident" id="5865807">_</span><span class="op" id="5865808">,</span>&nbsp;<span class="ident" id="5865810">second</span>&nbsp;<span class="op" id="5865817">:=</span>&nbsp;<span class="keyword" id="5865820">range</span>&nbsp;<span class="ident" id="5865826">seconds</span>&nbsp;<span class="op" id="5865834">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5865841">for</span>&nbsp;<span class="ident" id="5865845">_</span><span class="op" id="5865846">,</span>&nbsp;<span class="ident" id="5865848">zone</span>&nbsp;<span class="op" id="5865853">:=</span>&nbsp;<span class="keyword" id="5865856">range</span>&nbsp;<span class="ident" id="5865862">zones</span>&nbsp;<span class="op" id="5865868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5865876">s</span>&nbsp;<span class="op" id="5865878">:=</span>&nbsp;<span class="ident" id="5865881">dow</span>&nbsp;<span class="op" id="5865885">+</span>&nbsp;<span class="ident" id="5865887">day</span>&nbsp;<span class="op" id="5865891">+</span>&nbsp;<span class="string" id="5865893">&#34;&nbsp;Jan&nbsp;&#34;</span>&nbsp;<span class="op" id="5865901">+</span>&nbsp;<span class="ident" id="5865903">year</span>&nbsp;<span class="op" id="5865908">+</span>&nbsp;<span class="string" id="5865910">&#34;&nbsp;15:04&#34;</span>&nbsp;<span class="op" id="5865919">+</span>&nbsp;<span class="ident" id="5865921">second</span>&nbsp;<span class="op" id="5865928">+</span>&nbsp;<span class="string" id="5865930">&#34;&nbsp;&#34;</span>&nbsp;<span class="op" id="5865934">+</span>&nbsp;<span class="ident" id="5865936">zone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5865947">dateLayouts</span>&nbsp;<span class="op" id="5865959">=</span>&nbsp;<span class="builtinfunc" id="5865961">append</span><span class="op" id="5865967">(</span><span class="ident" id="5865968">dateLayouts</span><span class="op" id="5865979">,</span>&nbsp;<span class="ident" id="5865981">s</span><span class="op" id="5865982">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5865989">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5865995">}</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5866000">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5866004">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5866007">}</span><br>
<span class="lineno"></span><span class="op" id="5866009">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="keyword" id="5866012">func</span>&nbsp;<span class="ident" id="5866017">parseDate</span><span class="op" id="5866026">(</span><span class="ident" id="5866027">date</span>&nbsp;<span class="builtintype" id="5866032">string</span><span class="op" id="5866038">)</span>&nbsp;<span class="op" id="5866040">(</span><span class="ident" id="5866041">time</span><span class="op" id="5866045">.</span><span class="ident" id="5866046">Time</span><span class="op" id="5866050">,</span>&nbsp;<span class="builtintype" id="5866052">error</span><span class="op" id="5866057">)</span>&nbsp;<span class="op" id="5866059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5866062">for</span>&nbsp;<span class="ident" id="5866066">_</span><span class="op" id="5866067">,</span>&nbsp;<span class="ident" id="5866069">layout</span>&nbsp;<span class="op" id="5866076">:=</span>&nbsp;<span class="keyword" id="5866079">range</span>&nbsp;<span class="ident" id="5866085">dateLayouts</span>&nbsp;<span class="op" id="5866097">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5866101">t</span><span class="op" id="5866102">,</span>&nbsp;<span class="ident" id="5866104">err</span>&nbsp;<span class="op" id="5866108">:=</span>&nbsp;<span class="ident" id="5866111">time</span><span class="op" id="5866115">.</span><span class="ident" id="5866116">Parse</span><span class="op" id="5866121">(</span><span class="ident" id="5866122">layout</span><span class="op" id="5866128">,</span>&nbsp;<span class="ident" id="5866130">date</span><span class="op" id="5866134">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5866138">if</span>&nbsp;<span class="ident" id="5866141">err</span>&nbsp;<span class="op" id="5866145">==</span>&nbsp;<span class="builtintype" id="5866148">nil</span>&nbsp;<span class="op" id="5866152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5866157">return</span>&nbsp;<span class="ident" id="5866164">t</span><span class="op" id="5866165">,</span>&nbsp;<span class="builtintype" id="5866167">nil</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5866173">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5866176">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5866179">return</span>&nbsp;<span class="ident" id="5866186">time</span><span class="op" id="5866190">.</span><span class="ident" id="5866191">Time</span><span class="op" id="5866195">{</span><span class="op" id="5866196">}</span><span class="op" id="5866197">,</span>&nbsp;<span class="ident" id="5866199">errors</span><span class="op" id="5866205">.</span><span class="ident" id="5866206">New</span><span class="op" id="5866209">(</span><span class="string" id="5866210">&#34;mail:&nbsp;header&nbsp;could&nbsp;not&nbsp;be&nbsp;parsed&#34;</span><span class="op" id="5866244">)</span><br>
<span class="lineno"></span><span class="op" id="5866246">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">105</span><span class="comment" id="5866249">//&nbsp;A&nbsp;Header&nbsp;represents&nbsp;the&nbsp;key-value&nbsp;pairs&nbsp;in&nbsp;a&nbsp;mail&nbsp;message&nbsp;header.</span><br>
<span class="lineno"></span><span class="keyword" id="5866318">type</span>&nbsp;<span class="ident" id="5866323">Header</span>&nbsp;<span class="keyword" id="5866330">map</span><span class="op" id="5866333">[</span><span class="builtintype" id="5866334">string</span><span class="op" id="5866340">]</span><span class="op" id="5866341">[</span><span class="op" id="5866342">]</span><span class="builtintype" id="5866343">string</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5866351">//&nbsp;Get&nbsp;gets&nbsp;the&nbsp;first&nbsp;value&nbsp;associated&nbsp;with&nbsp;the&nbsp;given&nbsp;key.</span><br>
<span class="lineno"></span><span class="comment" id="5866410">//&nbsp;If&nbsp;there&nbsp;are&nbsp;no&nbsp;values&nbsp;associated&nbsp;with&nbsp;the&nbsp;key,&nbsp;Get&nbsp;returns&nbsp;&#34;&#34;.</span><br>
<span class="lineno">110</span><span class="keyword" id="5866477">func</span>&nbsp;<span class="op" id="5866482">(</span><span class="ident" id="5866483">h</span>&nbsp;<span class="ident" id="5866485">Header</span><span class="op" id="5866491">)</span>&nbsp;<span class="ident" id="5866493">Get</span><span class="op" id="5866496">(</span><span class="ident" id="5866497">key</span>&nbsp;<span class="builtintype" id="5866501">string</span><span class="op" id="5866507">)</span>&nbsp;<span class="builtintype" id="5866509">string</span>&nbsp;<span class="op" id="5866516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5866519">return</span>&nbsp;<span class="ident" id="5866526">textproto</span><span class="op" id="5866535">.</span><span class="ident" id="5866536">MIMEHeader</span><span class="op" id="5866546">(</span><span class="ident" id="5866547">h</span><span class="op" id="5866548">)</span><span class="op" id="5866549">.</span><span class="ident" id="5866550">Get</span><span class="op" id="5866553">(</span><span class="ident" id="5866554">key</span><span class="op" id="5866557">)</span><br>
<span class="lineno"></span><span class="op" id="5866559">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5866562">var</span>&nbsp;<span class="ident" id="5866566">ErrHeaderNotPresent</span>&nbsp;<span class="op" id="5866586">=</span>&nbsp;<span class="ident" id="5866588">errors</span><span class="op" id="5866594">.</span><span class="ident" id="5866595">New</span><span class="op" id="5866598">(</span><span class="string" id="5866599">&#34;mail:&nbsp;header&nbsp;not&nbsp;in&nbsp;message&#34;</span><span class="op" id="5866628">)</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span><span class="comment" id="5866631">//&nbsp;Date&nbsp;parses&nbsp;the&nbsp;Date&nbsp;header&nbsp;field.</span><br>
<span class="lineno"></span><span class="keyword" id="5866669">func</span>&nbsp;<span class="op" id="5866674">(</span><span class="ident" id="5866675">h</span>&nbsp;<span class="ident" id="5866677">Header</span><span class="op" id="5866683">)</span>&nbsp;<span class="ident" id="5866685">Date</span><span class="op" id="5866689">(</span><span class="op" id="5866690">)</span>&nbsp;<span class="op" id="5866692">(</span><span class="ident" id="5866693">time</span><span class="op" id="5866697">.</span><span class="ident" id="5866698">Time</span><span class="op" id="5866702">,</span>&nbsp;<span class="builtintype" id="5866704">error</span><span class="op" id="5866709">)</span>&nbsp;<span class="op" id="5866711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5866714">hdr</span>&nbsp;<span class="op" id="5866718">:=</span>&nbsp;<span class="ident" id="5866721">h</span><span class="op" id="5866722">.</span><span class="ident" id="5866723">Get</span><span class="op" id="5866726">(</span><span class="string" id="5866727">&#34;Date&#34;</span><span class="op" id="5866733">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5866736">if</span>&nbsp;<span class="ident" id="5866739">hdr</span>&nbsp;<span class="op" id="5866743">==</span>&nbsp;<span class="string" id="5866746">&#34;&#34;</span>&nbsp;<span class="op" id="5866749">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5866753">return</span>&nbsp;<span class="ident" id="5866760">time</span><span class="op" id="5866764">.</span><span class="ident" id="5866765">Time</span><span class="op" id="5866769">{</span><span class="op" id="5866770">}</span><span class="op" id="5866771">,</span>&nbsp;<span class="ident" id="5866773">ErrHeaderNotPresent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5866794">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5866797">return</span>&nbsp;<span class="ident" id="5866804">parseDate</span><span class="op" id="5866813">(</span><span class="ident" id="5866814">hdr</span><span class="op" id="5866817">)</span><br>
<span class="lineno"></span><span class="op" id="5866819">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">125</span><span class="comment" id="5866822">//&nbsp;AddressList&nbsp;parses&nbsp;the&nbsp;named&nbsp;header&nbsp;field&nbsp;as&nbsp;a&nbsp;list&nbsp;of&nbsp;addresses.</span><br>
<span class="lineno"></span><span class="keyword" id="5866891">func</span>&nbsp;<span class="op" id="5866896">(</span><span class="ident" id="5866897">h</span>&nbsp;<span class="ident" id="5866899">Header</span><span class="op" id="5866905">)</span>&nbsp;<span class="ident" id="5866907">AddressList</span><span class="op" id="5866918">(</span><span class="ident" id="5866919">key</span>&nbsp;<span class="builtintype" id="5866923">string</span><span class="op" id="5866929">)</span>&nbsp;<span class="op" id="5866931">(</span><span class="op" id="5866932">[</span><span class="op" id="5866933">]</span><span class="op" id="5866934">*</span><span class="ident" id="5866935">Address</span><span class="op" id="5866942">,</span>&nbsp;<span class="builtintype" id="5866944">error</span><span class="op" id="5866949">)</span>&nbsp;<span class="op" id="5866951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5866954">hdr</span>&nbsp;<span class="op" id="5866958">:=</span>&nbsp;<span class="ident" id="5866961">h</span><span class="op" id="5866962">.</span><span class="ident" id="5866963">Get</span><span class="op" id="5866966">(</span><span class="ident" id="5866967">key</span><span class="op" id="5866970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5866973">if</span>&nbsp;<span class="ident" id="5866976">hdr</span>&nbsp;<span class="op" id="5866980">==</span>&nbsp;<span class="string" id="5866983">&#34;&#34;</span>&nbsp;<span class="op" id="5866986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5866990">return</span>&nbsp;<span class="builtintype" id="5866997">nil</span><span class="op" id="5867000">,</span>&nbsp;<span class="ident" id="5867002">ErrHeaderNotPresent</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5867023">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5867026">return</span>&nbsp;<span class="ident" id="5867033">ParseAddressList</span><span class="op" id="5867049">(</span><span class="ident" id="5867050">hdr</span><span class="op" id="5867053">)</span><br>
<span class="lineno"></span><span class="op" id="5867055">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5867058">//&nbsp;Address&nbsp;represents&nbsp;a&nbsp;single&nbsp;mail&nbsp;address.</span><br>
<span class="lineno">135</span><span class="comment" id="5867103">//&nbsp;An&nbsp;address&nbsp;such&nbsp;as&nbsp;&#34;Barry&nbsp;Gibbs&nbsp;&lt;bg@example.com&gt;&#34;&nbsp;is&nbsp;represented</span><br>
<span class="lineno"></span><span class="comment" id="5867171">//&nbsp;as&nbsp;Address{Name:&nbsp;&#34;Barry&nbsp;Gibbs&#34;,&nbsp;Address:&nbsp;&#34;bg@example.com&#34;}.</span><br>
<span class="lineno"></span><span class="keyword" id="5867234">type</span>&nbsp;<span class="ident" id="5867239">Address</span>&nbsp;<span class="keyword" id="5867247">struct</span>&nbsp;<span class="op" id="5867254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5867257">Name</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5867265">string</span>&nbsp;<span class="comment" id="5867272">//&nbsp;Proper&nbsp;name;&nbsp;may&nbsp;be&nbsp;empty.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5867303">Address</span>&nbsp;<span class="builtintype" id="5867311">string</span>&nbsp;<span class="comment" id="5867318">//&nbsp;user@domain</span><br>
<span class="lineno">140</span><span class="op" id="5867333">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5867336">//&nbsp;Parses&nbsp;a&nbsp;single&nbsp;RFC&nbsp;5322&nbsp;address,&nbsp;e.g.&nbsp;&#34;Barry&nbsp;Gibbs&nbsp;&lt;bg@example.com&gt;&#34;</span><br>
<span class="lineno"></span><span class="keyword" id="5867409">func</span>&nbsp;<span class="ident" id="5867414">ParseAddress</span><span class="op" id="5867426">(</span><span class="ident" id="5867427">address</span>&nbsp;<span class="builtintype" id="5867435">string</span><span class="op" id="5867441">)</span>&nbsp;<span class="op" id="5867443">(</span><span class="op" id="5867444">*</span><span class="ident" id="5867445">Address</span><span class="op" id="5867452">,</span>&nbsp;<span class="builtintype" id="5867454">error</span><span class="op" id="5867459">)</span>&nbsp;<span class="op" id="5867461">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5867464">return</span>&nbsp;<span class="ident" id="5867471">newAddrParser</span><span class="op" id="5867484">(</span><span class="ident" id="5867485">address</span><span class="op" id="5867492">)</span><span class="op" id="5867493">.</span><span class="ident" id="5867494">parseAddress</span><span class="op" id="5867506">(</span><span class="op" id="5867507">)</span><br>
<span class="lineno">145</span><span class="op" id="5867509">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5867512">//&nbsp;ParseAddressList&nbsp;parses&nbsp;the&nbsp;given&nbsp;string&nbsp;as&nbsp;a&nbsp;list&nbsp;of&nbsp;addresses.</span><br>
<span class="lineno"></span><span class="keyword" id="5867580">func</span>&nbsp;<span class="ident" id="5867585">ParseAddressList</span><span class="op" id="5867601">(</span><span class="ident" id="5867602">list</span>&nbsp;<span class="builtintype" id="5867607">string</span><span class="op" id="5867613">)</span>&nbsp;<span class="op" id="5867615">(</span><span class="op" id="5867616">[</span><span class="op" id="5867617">]</span><span class="op" id="5867618">*</span><span class="ident" id="5867619">Address</span><span class="op" id="5867626">,</span>&nbsp;<span class="builtintype" id="5867628">error</span><span class="op" id="5867633">)</span>&nbsp;<span class="op" id="5867635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5867638">return</span>&nbsp;<span class="ident" id="5867645">newAddrParser</span><span class="op" id="5867658">(</span><span class="ident" id="5867659">list</span><span class="op" id="5867663">)</span><span class="op" id="5867664">.</span><span class="ident" id="5867665">parseAddressList</span><span class="op" id="5867681">(</span><span class="op" id="5867682">)</span><br>
<span class="lineno">150</span><span class="op" id="5867684">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5867687">//&nbsp;String&nbsp;formats&nbsp;the&nbsp;address&nbsp;as&nbsp;a&nbsp;valid&nbsp;RFC&nbsp;5322&nbsp;address.</span><br>
<span class="lineno"></span><span class="comment" id="5867746">//&nbsp;If&nbsp;the&nbsp;address&#39;s&nbsp;name&nbsp;contains&nbsp;non-ASCII&nbsp;characters</span><br>
<span class="lineno"></span><span class="comment" id="5867801">//&nbsp;the&nbsp;name&nbsp;will&nbsp;be&nbsp;rendered&nbsp;according&nbsp;to&nbsp;RFC&nbsp;2047.</span><br>
<span class="lineno">155</span><span class="keyword" id="5867853">func</span>&nbsp;<span class="op" id="5867858">(</span><span class="ident" id="5867859">a</span>&nbsp;<span class="op" id="5867861">*</span><span class="ident" id="5867862">Address</span><span class="op" id="5867869">)</span>&nbsp;<span class="ident" id="5867871">String</span><span class="op" id="5867877">(</span><span class="op" id="5867878">)</span>&nbsp;<span class="builtintype" id="5867880">string</span>&nbsp;<span class="op" id="5867887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5867890">s</span>&nbsp;<span class="op" id="5867892">:=</span>&nbsp;<span class="string" id="5867895">&#34;&lt;&#34;</span>&nbsp;<span class="op" id="5867899">+</span>&nbsp;<span class="ident" id="5867901">a</span><span class="op" id="5867902">.</span><span class="ident" id="5867903">Address</span>&nbsp;<span class="op" id="5867911">+</span>&nbsp;<span class="string" id="5867913">&#34;&gt;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5867918">if</span>&nbsp;<span class="ident" id="5867921">a</span><span class="op" id="5867922">.</span><span class="ident" id="5867923">Name</span>&nbsp;<span class="op" id="5867928">==</span>&nbsp;<span class="string" id="5867931">&#34;&#34;</span>&nbsp;<span class="op" id="5867934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5867938">return</span>&nbsp;<span class="ident" id="5867945">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5867948">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5867951">//&nbsp;If&nbsp;every&nbsp;character&nbsp;is&nbsp;printable&nbsp;ASCII,&nbsp;quoting&nbsp;is&nbsp;simple.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5868013">allPrintable</span>&nbsp;<span class="op" id="5868026">:=</span>&nbsp;<span class="builtintype" id="5868029">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5868035">for</span>&nbsp;<span class="ident" id="5868039">i</span>&nbsp;<span class="op" id="5868041">:=</span>&nbsp;<span class="num" id="5868044">0</span><span class="op" id="5868045">;</span>&nbsp;<span class="ident" id="5868047">i</span>&nbsp;<span class="op" id="5868049">&lt;</span>&nbsp;<span class="builtinfunc" id="5868051">len</span><span class="op" id="5868054">(</span><span class="ident" id="5868055">a</span><span class="op" id="5868056">.</span><span class="ident" id="5868057">Name</span><span class="op" id="5868061">)</span><span class="op" id="5868062">;</span>&nbsp;<span class="ident" id="5868064">i</span><span class="op" id="5868065">++</span>&nbsp;<span class="op" id="5868068">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5868072">//&nbsp;isWSP&nbsp;here&nbsp;should&nbsp;actually&nbsp;be&nbsp;isFWS,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5868114">//&nbsp;but&nbsp;we&nbsp;don&#39;t&nbsp;support&nbsp;folding&nbsp;yet.</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5868153">if</span>&nbsp;<span class="op" id="5868156">!</span><span class="ident" id="5868157">isVchar</span><span class="op" id="5868164">(</span><span class="ident" id="5868165">a</span><span class="op" id="5868166">.</span><span class="ident" id="5868167">Name</span><span class="op" id="5868171">[</span><span class="ident" id="5868172">i</span><span class="op" id="5868173">]</span><span class="op" id="5868174">)</span>&nbsp;<span class="op" id="5868176">&amp;&amp;</span>&nbsp;<span class="op" id="5868179">!</span><span class="ident" id="5868180">isWSP</span><span class="op" id="5868185">(</span><span class="ident" id="5868186">a</span><span class="op" id="5868187">.</span><span class="ident" id="5868188">Name</span><span class="op" id="5868192">[</span><span class="ident" id="5868193">i</span><span class="op" id="5868194">]</span><span class="op" id="5868195">)</span>&nbsp;<span class="op" id="5868197">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5868202">allPrintable</span>&nbsp;<span class="op" id="5868215">=</span>&nbsp;<span class="builtintype" id="5868217">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5868226">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5868234">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5868237">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5868240">if</span>&nbsp;<span class="ident" id="5868243">allPrintable</span>&nbsp;<span class="op" id="5868256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5868260">b</span>&nbsp;<span class="op" id="5868262">:=</span>&nbsp;<span class="ident" id="5868265">bytes</span><span class="op" id="5868270">.</span><span class="ident" id="5868271">NewBufferString</span><span class="op" id="5868286">(</span><span class="string" id="5868287">`&#34;`</span><span class="op" id="5868290">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5868294">for</span>&nbsp;<span class="ident" id="5868298">i</span>&nbsp;<span class="op" id="5868300">:=</span>&nbsp;<span class="num" id="5868303">0</span><span class="op" id="5868304">;</span>&nbsp;<span class="ident" id="5868306">i</span>&nbsp;<span class="op" id="5868308">&lt;</span>&nbsp;<span class="builtinfunc" id="5868310">len</span><span class="op" id="5868313">(</span><span class="ident" id="5868314">a</span><span class="op" id="5868315">.</span><span class="ident" id="5868316">Name</span><span class="op" id="5868320">)</span><span class="op" id="5868321">;</span>&nbsp;<span class="ident" id="5868323">i</span><span class="op" id="5868324">++</span>&nbsp;<span class="op" id="5868327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5868332">if</span>&nbsp;<span class="op" id="5868335">!</span><span class="ident" id="5868336">isQtext</span><span class="op" id="5868343">(</span><span class="ident" id="5868344">a</span><span class="op" id="5868345">.</span><span class="ident" id="5868346">Name</span><span class="op" id="5868350">[</span><span class="ident" id="5868351">i</span><span class="op" id="5868352">]</span><span class="op" id="5868353">)</span>&nbsp;<span class="op" id="5868355">&amp;&amp;</span>&nbsp;<span class="op" id="5868358">!</span><span class="ident" id="5868359">isWSP</span><span class="op" id="5868364">(</span><span class="ident" id="5868365">a</span><span class="op" id="5868366">.</span><span class="ident" id="5868367">Name</span><span class="op" id="5868371">[</span><span class="ident" id="5868372">i</span><span class="op" id="5868373">]</span><span class="op" id="5868374">)</span>&nbsp;<span class="op" id="5868376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5868382">b</span><span class="op" id="5868383">.</span><span class="ident" id="5868384">WriteByte</span><span class="op" id="5868393">(</span><span class="string" id="5868394">&#39;\\&#39;</span><span class="op" id="5868398">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5868403">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5868408">b</span><span class="op" id="5868409">.</span><span class="ident" id="5868410">WriteByte</span><span class="op" id="5868419">(</span><span class="ident" id="5868420">a</span><span class="op" id="5868421">.</span><span class="ident" id="5868422">Name</span><span class="op" id="5868426">[</span><span class="ident" id="5868427">i</span><span class="op" id="5868428">]</span><span class="op" id="5868429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5868433">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5868437">b</span><span class="op" id="5868438">.</span><span class="ident" id="5868439">WriteString</span><span class="op" id="5868450">(</span><span class="string" id="5868451">`&#34;&nbsp;`</span><span class="op" id="5868455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5868459">b</span><span class="op" id="5868460">.</span><span class="ident" id="5868461">WriteString</span><span class="op" id="5868472">(</span><span class="ident" id="5868473">s</span><span class="op" id="5868474">)</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5868478">return</span>&nbsp;<span class="ident" id="5868485">b</span><span class="op" id="5868486">.</span><span class="ident" id="5868487">String</span><span class="op" id="5868493">(</span><span class="op" id="5868494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5868497">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5868501">//&nbsp;UTF-8&nbsp;&#34;Q&#34;&nbsp;encoding</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5868524">b</span>&nbsp;<span class="op" id="5868526">:=</span>&nbsp;<span class="ident" id="5868529">bytes</span><span class="op" id="5868534">.</span><span class="ident" id="5868535">NewBufferString</span><span class="op" id="5868550">(</span><span class="string" id="5868551">&#34;=?utf-8?q?&#34;</span><span class="op" id="5868563">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5868566">for</span>&nbsp;<span class="ident" id="5868570">i</span>&nbsp;<span class="op" id="5868572">:=</span>&nbsp;<span class="num" id="5868575">0</span><span class="op" id="5868576">;</span>&nbsp;<span class="ident" id="5868578">i</span>&nbsp;<span class="op" id="5868580">&lt;</span>&nbsp;<span class="builtinfunc" id="5868582">len</span><span class="op" id="5868585">(</span><span class="ident" id="5868586">a</span><span class="op" id="5868587">.</span><span class="ident" id="5868588">Name</span><span class="op" id="5868592">)</span><span class="op" id="5868593">;</span>&nbsp;<span class="ident" id="5868595">i</span><span class="op" id="5868596">++</span>&nbsp;<span class="op" id="5868599">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5868603">switch</span>&nbsp;<span class="ident" id="5868610">c</span>&nbsp;<span class="op" id="5868612">:=</span>&nbsp;<span class="ident" id="5868615">a</span><span class="op" id="5868616">.</span><span class="ident" id="5868617">Name</span><span class="op" id="5868621">[</span><span class="ident" id="5868622">i</span><span class="op" id="5868623">]</span><span class="op" id="5868624">;</span>&nbsp;<span class="op" id="5868626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5868630">case</span>&nbsp;<span class="ident" id="5868635">c</span>&nbsp;<span class="op" id="5868637">==</span>&nbsp;<span class="string" id="5868640">&#39;&nbsp;&#39;</span><span class="op" id="5868643">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5868648">b</span><span class="op" id="5868649">.</span><span class="ident" id="5868650">WriteByte</span><span class="op" id="5868659">(</span><span class="string" id="5868660">&#39;_&#39;</span><span class="op" id="5868663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5868667">case</span>&nbsp;<span class="ident" id="5868672">isVchar</span><span class="op" id="5868679">(</span><span class="ident" id="5868680">c</span><span class="op" id="5868681">)</span>&nbsp;<span class="op" id="5868683">&amp;&amp;</span>&nbsp;<span class="ident" id="5868686">c</span>&nbsp;<span class="op" id="5868688">!=</span>&nbsp;<span class="string" id="5868691">&#39;=&#39;</span>&nbsp;<span class="op" id="5868695">&amp;&amp;</span>&nbsp;<span class="ident" id="5868698">c</span>&nbsp;<span class="op" id="5868700">!=</span>&nbsp;<span class="string" id="5868703">&#39;?&#39;</span>&nbsp;<span class="op" id="5868707">&amp;&amp;</span>&nbsp;<span class="ident" id="5868710">c</span>&nbsp;<span class="op" id="5868712">!=</span>&nbsp;<span class="string" id="5868715">&#39;_&#39;</span><span class="op" id="5868718">:</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5868723">b</span><span class="op" id="5868724">.</span><span class="ident" id="5868725">WriteByte</span><span class="op" id="5868734">(</span><span class="ident" id="5868735">c</span><span class="op" id="5868736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5868740">default</span><span class="op" id="5868747">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5868752">fmt</span><span class="op" id="5868755">.</span><span class="ident" id="5868756">Fprintf</span><span class="op" id="5868763">(</span><span class="ident" id="5868764">b</span><span class="op" id="5868765">,</span>&nbsp;<span class="string" id="5868767">&#34;=%02X&#34;</span><span class="op" id="5868774">,</span>&nbsp;<span class="ident" id="5868776">c</span><span class="op" id="5868777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5868781">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5868784">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5868787">b</span><span class="op" id="5868788">.</span><span class="ident" id="5868789">WriteString</span><span class="op" id="5868800">(</span><span class="string" id="5868801">&#34;?=&nbsp;&#34;</span><span class="op" id="5868806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5868809">b</span><span class="op" id="5868810">.</span><span class="ident" id="5868811">WriteString</span><span class="op" id="5868822">(</span><span class="ident" id="5868823">s</span><span class="op" id="5868824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5868827">return</span>&nbsp;<span class="ident" id="5868834">b</span><span class="op" id="5868835">.</span><span class="ident" id="5868836">String</span><span class="op" id="5868842">(</span><span class="op" id="5868843">)</span><br>
<span class="lineno"></span><span class="op" id="5868845">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span><span class="keyword" id="5868848">type</span>&nbsp;<span class="ident" id="5868853">addrParser</span>&nbsp;<span class="op" id="5868864">[</span><span class="op" id="5868865">]</span><span class="builtintype" id="5868866">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5868872">func</span>&nbsp;<span class="ident" id="5868877">newAddrParser</span><span class="op" id="5868890">(</span><span class="ident" id="5868891">s</span>&nbsp;<span class="builtintype" id="5868893">string</span><span class="op" id="5868899">)</span>&nbsp;<span class="op" id="5868901">*</span><span class="ident" id="5868902">addrParser</span>&nbsp;<span class="op" id="5868913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5868916">p</span>&nbsp;<span class="op" id="5868918">:=</span>&nbsp;<span class="ident" id="5868921">addrParser</span><span class="op" id="5868931">(</span><span class="ident" id="5868932">s</span><span class="op" id="5868933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5868936">return</span>&nbsp;<span class="op" id="5868943">&amp;</span><span class="ident" id="5868944">p</span><br>
<span class="lineno">205</span><span class="op" id="5868946">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5868949">func</span>&nbsp;<span class="op" id="5868954">(</span><span class="ident" id="5868955">p</span>&nbsp;<span class="op" id="5868957">*</span><span class="ident" id="5868958">addrParser</span><span class="op" id="5868968">)</span>&nbsp;<span class="ident" id="5868970">parseAddressList</span><span class="op" id="5868986">(</span><span class="op" id="5868987">)</span>&nbsp;<span class="op" id="5868989">(</span><span class="op" id="5868990">[</span><span class="op" id="5868991">]</span><span class="op" id="5868992">*</span><span class="ident" id="5868993">Address</span><span class="op" id="5869000">,</span>&nbsp;<span class="builtintype" id="5869002">error</span><span class="op" id="5869007">)</span>&nbsp;<span class="op" id="5869009">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5869012">var</span>&nbsp;<span class="ident" id="5869016">list</span>&nbsp;<span class="op" id="5869021">[</span><span class="op" id="5869022">]</span><span class="op" id="5869023">*</span><span class="ident" id="5869024">Address</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5869033">for</span>&nbsp;<span class="op" id="5869037">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5869041">p</span><span class="op" id="5869042">.</span><span class="ident" id="5869043">skipSpace</span><span class="op" id="5869052">(</span><span class="op" id="5869053">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5869057">addr</span><span class="op" id="5869061">,</span>&nbsp;<span class="ident" id="5869063">err</span>&nbsp;<span class="op" id="5869067">:=</span>&nbsp;<span class="ident" id="5869070">p</span><span class="op" id="5869071">.</span><span class="ident" id="5869072">parseAddress</span><span class="op" id="5869084">(</span><span class="op" id="5869085">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5869089">if</span>&nbsp;<span class="ident" id="5869092">err</span>&nbsp;<span class="op" id="5869096">!=</span>&nbsp;<span class="builtintype" id="5869099">nil</span>&nbsp;<span class="op" id="5869103">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5869108">return</span>&nbsp;<span class="builtintype" id="5869115">nil</span><span class="op" id="5869118">,</span>&nbsp;<span class="ident" id="5869120">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5869126">}</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5869130">list</span>&nbsp;<span class="op" id="5869135">=</span>&nbsp;<span class="builtinfunc" id="5869137">append</span><span class="op" id="5869143">(</span><span class="ident" id="5869144">list</span><span class="op" id="5869148">,</span>&nbsp;<span class="ident" id="5869150">addr</span><span class="op" id="5869154">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5869159">p</span><span class="op" id="5869160">.</span><span class="ident" id="5869161">skipSpace</span><span class="op" id="5869170">(</span><span class="op" id="5869171">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5869175">if</span>&nbsp;<span class="ident" id="5869178">p</span><span class="op" id="5869179">.</span><span class="ident" id="5869180">empty</span><span class="op" id="5869185">(</span><span class="op" id="5869186">)</span>&nbsp;<span class="op" id="5869188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5869193">break</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5869201">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5869205">if</span>&nbsp;<span class="op" id="5869208">!</span><span class="ident" id="5869209">p</span><span class="op" id="5869210">.</span><span class="ident" id="5869211">consume</span><span class="op" id="5869218">(</span><span class="string" id="5869219">&#39;,&#39;</span><span class="op" id="5869222">)</span>&nbsp;<span class="op" id="5869224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5869229">return</span>&nbsp;<span class="builtintype" id="5869236">nil</span><span class="op" id="5869239">,</span>&nbsp;<span class="ident" id="5869241">errors</span><span class="op" id="5869247">.</span><span class="ident" id="5869248">New</span><span class="op" id="5869251">(</span><span class="string" id="5869252">&#34;mail:&nbsp;expected&nbsp;comma&#34;</span><span class="op" id="5869274">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5869278">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5869281">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5869284">return</span>&nbsp;<span class="ident" id="5869291">list</span><span class="op" id="5869295">,</span>&nbsp;<span class="builtintype" id="5869297">nil</span><br>
<span class="lineno"></span><span class="op" id="5869301">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5869304">//&nbsp;parseAddress&nbsp;parses&nbsp;a&nbsp;single&nbsp;RFC&nbsp;5322&nbsp;address&nbsp;at&nbsp;the&nbsp;start&nbsp;of&nbsp;p.</span><br>
<span class="lineno"></span><span class="keyword" id="5869372">func</span>&nbsp;<span class="op" id="5869377">(</span><span class="ident" id="5869378">p</span>&nbsp;<span class="op" id="5869380">*</span><span class="ident" id="5869381">addrParser</span><span class="op" id="5869391">)</span>&nbsp;<span class="ident" id="5869393">parseAddress</span><span class="op" id="5869405">(</span><span class="op" id="5869406">)</span>&nbsp;<span class="op" id="5869408">(</span><span class="ident" id="5869409">addr</span>&nbsp;<span class="op" id="5869414">*</span><span class="ident" id="5869415">Address</span><span class="op" id="5869422">,</span>&nbsp;<span class="ident" id="5869424">err</span>&nbsp;<span class="builtintype" id="5869428">error</span><span class="op" id="5869433">)</span>&nbsp;<span class="op" id="5869435">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5869438">debug</span><span class="op" id="5869443">.</span><span class="ident" id="5869444">Printf</span><span class="op" id="5869450">(</span><span class="string" id="5869451">&#34;parseAddress:&nbsp;%q&#34;</span><span class="op" id="5869469">,</span>&nbsp;<span class="op" id="5869471">*</span><span class="ident" id="5869472">p</span><span class="op" id="5869473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5869476">p</span><span class="op" id="5869477">.</span><span class="ident" id="5869478">skipSpace</span><span class="op" id="5869487">(</span><span class="op" id="5869488">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5869491">if</span>&nbsp;<span class="ident" id="5869494">p</span><span class="op" id="5869495">.</span><span class="ident" id="5869496">empty</span><span class="op" id="5869501">(</span><span class="op" id="5869502">)</span>&nbsp;<span class="op" id="5869504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5869508">return</span>&nbsp;<span class="builtintype" id="5869515">nil</span><span class="op" id="5869518">,</span>&nbsp;<span class="ident" id="5869520">errors</span><span class="op" id="5869526">.</span><span class="ident" id="5869527">New</span><span class="op" id="5869530">(</span><span class="string" id="5869531">&#34;mail:&nbsp;no&nbsp;address&#34;</span><span class="op" id="5869549">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5869552">}</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5869556">//&nbsp;address&nbsp;=&nbsp;name-addr&nbsp;/&nbsp;addr-spec</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5869592">//&nbsp;TODO(dsymonds):&nbsp;Support&nbsp;parsing&nbsp;group&nbsp;address.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5869644">//&nbsp;addr-spec&nbsp;has&nbsp;a&nbsp;more&nbsp;restricted&nbsp;grammar&nbsp;than&nbsp;name-addr,</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5869704">//&nbsp;so&nbsp;try&nbsp;parsing&nbsp;it&nbsp;first,&nbsp;and&nbsp;fallback&nbsp;to&nbsp;name-addr.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5869760">//&nbsp;TODO(dsymonds):&nbsp;Is&nbsp;this&nbsp;really&nbsp;correct?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5869804">spec</span><span class="op" id="5869808">,</span>&nbsp;<span class="ident" id="5869810">err</span>&nbsp;<span class="op" id="5869814">:=</span>&nbsp;<span class="ident" id="5869817">p</span><span class="op" id="5869818">.</span><span class="ident" id="5869819">consumeAddrSpec</span><span class="op" id="5869834">(</span><span class="op" id="5869835">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5869838">if</span>&nbsp;<span class="ident" id="5869841">err</span>&nbsp;<span class="op" id="5869845">==</span>&nbsp;<span class="builtintype" id="5869848">nil</span>&nbsp;<span class="op" id="5869852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5869856">return</span>&nbsp;<span class="op" id="5869863">&amp;</span><span class="ident" id="5869864">Address</span><span class="op" id="5869871">{</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5869876">Address</span><span class="op" id="5869883">:</span>&nbsp;<span class="ident" id="5869885">spec</span><span class="op" id="5869889">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5869893">}</span><span class="op" id="5869894">,</span>&nbsp;<span class="ident" id="5869896">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5869901">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5869904">debug</span><span class="op" id="5869909">.</span><span class="ident" id="5869910">Printf</span><span class="op" id="5869916">(</span><span class="string" id="5869917">&#34;parseAddress:&nbsp;not&nbsp;an&nbsp;addr-spec:&nbsp;%v&#34;</span><span class="op" id="5869953">,</span>&nbsp;<span class="ident" id="5869955">err</span><span class="op" id="5869958">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5869961">debug</span><span class="op" id="5869966">.</span><span class="ident" id="5869967">Printf</span><span class="op" id="5869973">(</span><span class="string" id="5869974">&#34;parseAddress:&nbsp;state&nbsp;is&nbsp;now&nbsp;%q&#34;</span><span class="op" id="5870005">,</span>&nbsp;<span class="op" id="5870007">*</span><span class="ident" id="5870008">p</span><span class="op" id="5870009">)</span><br>
<span class="lineno">250</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5870013">//&nbsp;display-name</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5870030">var</span>&nbsp;<span class="ident" id="5870034">displayName</span>&nbsp;<span class="builtintype" id="5870046">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5870054">if</span>&nbsp;<span class="ident" id="5870057">p</span><span class="op" id="5870058">.</span><span class="ident" id="5870059">peek</span><span class="op" id="5870063">(</span><span class="op" id="5870064">)</span>&nbsp;<span class="op" id="5870066">!=</span>&nbsp;<span class="string" id="5870069">&#39;&lt;&#39;</span>&nbsp;<span class="op" id="5870073">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5870077">displayName</span><span class="op" id="5870088">,</span>&nbsp;<span class="ident" id="5870090">err</span>&nbsp;<span class="op" id="5870094">=</span>&nbsp;<span class="ident" id="5870096">p</span><span class="op" id="5870097">.</span><span class="ident" id="5870098">consumePhrase</span><span class="op" id="5870111">(</span><span class="op" id="5870112">)</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5870116">if</span>&nbsp;<span class="ident" id="5870119">err</span>&nbsp;<span class="op" id="5870123">!=</span>&nbsp;<span class="builtintype" id="5870126">nil</span>&nbsp;<span class="op" id="5870130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5870135">return</span>&nbsp;<span class="builtintype" id="5870142">nil</span><span class="op" id="5870145">,</span>&nbsp;<span class="ident" id="5870147">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5870153">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5870156">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5870159">debug</span><span class="op" id="5870164">.</span><span class="ident" id="5870165">Printf</span><span class="op" id="5870171">(</span><span class="string" id="5870172">&#34;parseAddress:&nbsp;displayName=%q&#34;</span><span class="op" id="5870202">,</span>&nbsp;<span class="ident" id="5870204">displayName</span><span class="op" id="5870215">)</span><br>
<span class="lineno">260</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5870219">//&nbsp;angle-addr&nbsp;=&nbsp;&#34;&lt;&#34;&nbsp;addr-spec&nbsp;&#34;&gt;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5870254">p</span><span class="op" id="5870255">.</span><span class="ident" id="5870256">skipSpace</span><span class="op" id="5870265">(</span><span class="op" id="5870266">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5870269">if</span>&nbsp;<span class="op" id="5870272">!</span><span class="ident" id="5870273">p</span><span class="op" id="5870274">.</span><span class="ident" id="5870275">consume</span><span class="op" id="5870282">(</span><span class="string" id="5870283">&#39;&lt;&#39;</span><span class="op" id="5870286">)</span>&nbsp;<span class="op" id="5870288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5870292">return</span>&nbsp;<span class="builtintype" id="5870299">nil</span><span class="op" id="5870302">,</span>&nbsp;<span class="ident" id="5870304">errors</span><span class="op" id="5870310">.</span><span class="ident" id="5870311">New</span><span class="op" id="5870314">(</span><span class="string" id="5870315">&#34;mail:&nbsp;no&nbsp;angle-addr&#34;</span><span class="op" id="5870336">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5870339">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5870342">spec</span><span class="op" id="5870346">,</span>&nbsp;<span class="ident" id="5870348">err</span>&nbsp;<span class="op" id="5870352">=</span>&nbsp;<span class="ident" id="5870354">p</span><span class="op" id="5870355">.</span><span class="ident" id="5870356">consumeAddrSpec</span><span class="op" id="5870371">(</span><span class="op" id="5870372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5870375">if</span>&nbsp;<span class="ident" id="5870378">err</span>&nbsp;<span class="op" id="5870382">!=</span>&nbsp;<span class="builtintype" id="5870385">nil</span>&nbsp;<span class="op" id="5870389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5870393">return</span>&nbsp;<span class="builtintype" id="5870400">nil</span><span class="op" id="5870403">,</span>&nbsp;<span class="ident" id="5870405">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5870410">}</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5870413">if</span>&nbsp;<span class="op" id="5870416">!</span><span class="ident" id="5870417">p</span><span class="op" id="5870418">.</span><span class="ident" id="5870419">consume</span><span class="op" id="5870426">(</span><span class="string" id="5870427">&#39;&gt;&#39;</span><span class="op" id="5870430">)</span>&nbsp;<span class="op" id="5870432">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5870436">return</span>&nbsp;<span class="builtintype" id="5870443">nil</span><span class="op" id="5870446">,</span>&nbsp;<span class="ident" id="5870448">errors</span><span class="op" id="5870454">.</span><span class="ident" id="5870455">New</span><span class="op" id="5870458">(</span><span class="string" id="5870459">&#34;mail:&nbsp;unclosed&nbsp;angle-addr&#34;</span><span class="op" id="5870486">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5870489">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5870492">debug</span><span class="op" id="5870497">.</span><span class="ident" id="5870498">Printf</span><span class="op" id="5870504">(</span><span class="string" id="5870505">&#34;parseAddress:&nbsp;spec=%q&#34;</span><span class="op" id="5870528">,</span>&nbsp;<span class="ident" id="5870530">spec</span><span class="op" id="5870534">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5870538">return</span>&nbsp;<span class="op" id="5870545">&amp;</span><span class="ident" id="5870546">Address</span><span class="op" id="5870553">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5870557">Name</span><span class="op" id="5870561">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5870566">displayName</span><span class="op" id="5870577">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5870581">Address</span><span class="op" id="5870588">:</span>&nbsp;<span class="ident" id="5870590">spec</span><span class="op" id="5870594">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5870597">}</span><span class="op" id="5870598">,</span>&nbsp;<span class="builtintype" id="5870600">nil</span><br>
<span class="lineno"></span><span class="op" id="5870604">}</span><br>
<span class="lineno">280</span><br>
<span class="lineno"></span><span class="comment" id="5870607">//&nbsp;consumeAddrSpec&nbsp;parses&nbsp;a&nbsp;single&nbsp;RFC&nbsp;5322&nbsp;addr-spec&nbsp;at&nbsp;the&nbsp;start&nbsp;of&nbsp;p.</span><br>
<span class="lineno"></span><span class="keyword" id="5870680">func</span>&nbsp;<span class="op" id="5870685">(</span><span class="ident" id="5870686">p</span>&nbsp;<span class="op" id="5870688">*</span><span class="ident" id="5870689">addrParser</span><span class="op" id="5870699">)</span>&nbsp;<span class="ident" id="5870701">consumeAddrSpec</span><span class="op" id="5870716">(</span><span class="op" id="5870717">)</span>&nbsp;<span class="op" id="5870719">(</span><span class="ident" id="5870720">spec</span>&nbsp;<span class="builtintype" id="5870725">string</span><span class="op" id="5870731">,</span>&nbsp;<span class="ident" id="5870733">err</span>&nbsp;<span class="builtintype" id="5870737">error</span><span class="op" id="5870742">)</span>&nbsp;<span class="op" id="5870744">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5870747">debug</span><span class="op" id="5870752">.</span><span class="ident" id="5870753">Printf</span><span class="op" id="5870759">(</span><span class="string" id="5870760">&#34;consumeAddrSpec:&nbsp;%q&#34;</span><span class="op" id="5870781">,</span>&nbsp;<span class="op" id="5870783">*</span><span class="ident" id="5870784">p</span><span class="op" id="5870785">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5870789">orig</span>&nbsp;<span class="op" id="5870794">:=</span>&nbsp;<span class="op" id="5870797">*</span><span class="ident" id="5870798">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5870801">defer</span>&nbsp;<span class="keyword" id="5870807">func</span><span class="op" id="5870811">(</span><span class="op" id="5870812">)</span>&nbsp;<span class="op" id="5870814">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5870818">if</span>&nbsp;<span class="ident" id="5870821">err</span>&nbsp;<span class="op" id="5870825">!=</span>&nbsp;<span class="builtintype" id="5870828">nil</span>&nbsp;<span class="op" id="5870832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5870837">*</span><span class="ident" id="5870838">p</span>&nbsp;<span class="op" id="5870840">=</span>&nbsp;<span class="ident" id="5870842">orig</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5870849">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5870852">}</span><span class="op" id="5870853">(</span><span class="op" id="5870854">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5870858">//&nbsp;local-part&nbsp;=&nbsp;dot-atom&nbsp;/&nbsp;quoted-string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5870900">var</span>&nbsp;<span class="ident" id="5870904">localPart</span>&nbsp;<span class="builtintype" id="5870914">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5870922">p</span><span class="op" id="5870923">.</span><span class="ident" id="5870924">skipSpace</span><span class="op" id="5870933">(</span><span class="op" id="5870934">)</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5870937">if</span>&nbsp;<span class="ident" id="5870940">p</span><span class="op" id="5870941">.</span><span class="ident" id="5870942">empty</span><span class="op" id="5870947">(</span><span class="op" id="5870948">)</span>&nbsp;<span class="op" id="5870950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5870954">return</span>&nbsp;<span class="string" id="5870961">&#34;&#34;</span><span class="op" id="5870963">,</span>&nbsp;<span class="ident" id="5870965">errors</span><span class="op" id="5870971">.</span><span class="ident" id="5870972">New</span><span class="op" id="5870975">(</span><span class="string" id="5870976">&#34;mail:&nbsp;no&nbsp;addr-spec&#34;</span><span class="op" id="5870996">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5870999">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5871002">if</span>&nbsp;<span class="ident" id="5871005">p</span><span class="op" id="5871006">.</span><span class="ident" id="5871007">peek</span><span class="op" id="5871011">(</span><span class="op" id="5871012">)</span>&nbsp;<span class="op" id="5871014">==</span>&nbsp;<span class="string" id="5871017">&#39;&#34;&#39;</span>&nbsp;<span class="op" id="5871021">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5871025">//&nbsp;quoted-string</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5871044">debug</span><span class="op" id="5871049">.</span><span class="ident" id="5871050">Printf</span><span class="op" id="5871056">(</span><span class="string" id="5871057">&#34;consumeAddrSpec:&nbsp;parsing&nbsp;quoted-string&#34;</span><span class="op" id="5871097">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5871101">localPart</span><span class="op" id="5871110">,</span>&nbsp;<span class="ident" id="5871112">err</span>&nbsp;<span class="op" id="5871116">=</span>&nbsp;<span class="ident" id="5871118">p</span><span class="op" id="5871119">.</span><span class="ident" id="5871120">consumeQuotedString</span><span class="op" id="5871139">(</span><span class="op" id="5871140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5871143">}</span>&nbsp;<span class="keyword" id="5871145">else</span>&nbsp;<span class="op" id="5871150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5871154">//&nbsp;dot-atom</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5871168">debug</span><span class="op" id="5871173">.</span><span class="ident" id="5871174">Printf</span><span class="op" id="5871180">(</span><span class="string" id="5871181">&#34;consumeAddrSpec:&nbsp;parsing&nbsp;dot-atom&#34;</span><span class="op" id="5871216">)</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5871220">localPart</span><span class="op" id="5871229">,</span>&nbsp;<span class="ident" id="5871231">err</span>&nbsp;<span class="op" id="5871235">=</span>&nbsp;<span class="ident" id="5871237">p</span><span class="op" id="5871238">.</span><span class="ident" id="5871239">consumeAtom</span><span class="op" id="5871250">(</span><span class="builtintype" id="5871251">true</span><span class="op" id="5871255">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5871258">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5871261">if</span>&nbsp;<span class="ident" id="5871264">err</span>&nbsp;<span class="op" id="5871268">!=</span>&nbsp;<span class="builtintype" id="5871271">nil</span>&nbsp;<span class="op" id="5871275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5871279">debug</span><span class="op" id="5871284">.</span><span class="ident" id="5871285">Printf</span><span class="op" id="5871291">(</span><span class="string" id="5871292">&#34;consumeAddrSpec:&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="5871321">,</span>&nbsp;<span class="ident" id="5871323">err</span><span class="op" id="5871326">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5871330">return</span>&nbsp;<span class="string" id="5871337">&#34;&#34;</span><span class="op" id="5871339">,</span>&nbsp;<span class="ident" id="5871341">err</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5871346">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5871350">if</span>&nbsp;<span class="op" id="5871353">!</span><span class="ident" id="5871354">p</span><span class="op" id="5871355">.</span><span class="ident" id="5871356">consume</span><span class="op" id="5871363">(</span><span class="string" id="5871364">&#39;@&#39;</span><span class="op" id="5871367">)</span>&nbsp;<span class="op" id="5871369">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5871373">return</span>&nbsp;<span class="string" id="5871380">&#34;&#34;</span><span class="op" id="5871382">,</span>&nbsp;<span class="ident" id="5871384">errors</span><span class="op" id="5871390">.</span><span class="ident" id="5871391">New</span><span class="op" id="5871394">(</span><span class="string" id="5871395">&#34;mail:&nbsp;missing&nbsp;@&nbsp;in&nbsp;addr-spec&#34;</span><span class="op" id="5871425">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5871428">}</span><br>
<span class="lineno">315</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5871432">//&nbsp;domain&nbsp;=&nbsp;dot-atom&nbsp;/&nbsp;domain-literal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5871471">var</span>&nbsp;<span class="ident" id="5871475">domain</span>&nbsp;<span class="builtintype" id="5871482">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5871490">p</span><span class="op" id="5871491">.</span><span class="ident" id="5871492">skipSpace</span><span class="op" id="5871501">(</span><span class="op" id="5871502">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5871505">if</span>&nbsp;<span class="ident" id="5871508">p</span><span class="op" id="5871509">.</span><span class="ident" id="5871510">empty</span><span class="op" id="5871515">(</span><span class="op" id="5871516">)</span>&nbsp;<span class="op" id="5871518">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5871522">return</span>&nbsp;<span class="string" id="5871529">&#34;&#34;</span><span class="op" id="5871531">,</span>&nbsp;<span class="ident" id="5871533">errors</span><span class="op" id="5871539">.</span><span class="ident" id="5871540">New</span><span class="op" id="5871543">(</span><span class="string" id="5871544">&#34;mail:&nbsp;no&nbsp;domain&nbsp;in&nbsp;addr-spec&#34;</span><span class="op" id="5871574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5871577">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5871580">//&nbsp;TODO(dsymonds):&nbsp;Handle&nbsp;domain-literal</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5871622">domain</span><span class="op" id="5871628">,</span>&nbsp;<span class="ident" id="5871630">err</span>&nbsp;<span class="op" id="5871634">=</span>&nbsp;<span class="ident" id="5871636">p</span><span class="op" id="5871637">.</span><span class="ident" id="5871638">consumeAtom</span><span class="op" id="5871649">(</span><span class="builtintype" id="5871650">true</span><span class="op" id="5871654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5871657">if</span>&nbsp;<span class="ident" id="5871660">err</span>&nbsp;<span class="op" id="5871664">!=</span>&nbsp;<span class="builtintype" id="5871667">nil</span>&nbsp;<span class="op" id="5871671">{</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5871675">return</span>&nbsp;<span class="string" id="5871682">&#34;&#34;</span><span class="op" id="5871684">,</span>&nbsp;<span class="ident" id="5871686">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5871691">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5871695">return</span>&nbsp;<span class="ident" id="5871702">localPart</span>&nbsp;<span class="op" id="5871712">+</span>&nbsp;<span class="string" id="5871714">&#34;@&#34;</span>&nbsp;<span class="op" id="5871718">+</span>&nbsp;<span class="ident" id="5871720">domain</span><span class="op" id="5871726">,</span>&nbsp;<span class="builtintype" id="5871728">nil</span><br>
<span class="lineno"></span><span class="op" id="5871732">}</span><br>
<span class="lineno">330</span><br>
<span class="lineno"></span><span class="comment" id="5871735">//&nbsp;consumePhrase&nbsp;parses&nbsp;the&nbsp;RFC&nbsp;5322&nbsp;phrase&nbsp;at&nbsp;the&nbsp;start&nbsp;of&nbsp;p.</span><br>
<span class="lineno"></span><span class="keyword" id="5871798">func</span>&nbsp;<span class="op" id="5871803">(</span><span class="ident" id="5871804">p</span>&nbsp;<span class="op" id="5871806">*</span><span class="ident" id="5871807">addrParser</span><span class="op" id="5871817">)</span>&nbsp;<span class="ident" id="5871819">consumePhrase</span><span class="op" id="5871832">(</span><span class="op" id="5871833">)</span>&nbsp;<span class="op" id="5871835">(</span><span class="ident" id="5871836">phrase</span>&nbsp;<span class="builtintype" id="5871843">string</span><span class="op" id="5871849">,</span>&nbsp;<span class="ident" id="5871851">err</span>&nbsp;<span class="builtintype" id="5871855">error</span><span class="op" id="5871860">)</span>&nbsp;<span class="op" id="5871862">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5871865">debug</span><span class="op" id="5871870">.</span><span class="ident" id="5871871">Printf</span><span class="op" id="5871877">(</span><span class="string" id="5871878">&#34;consumePhrase:&nbsp;[%s]&#34;</span><span class="op" id="5871899">,</span>&nbsp;<span class="op" id="5871901">*</span><span class="ident" id="5871902">p</span><span class="op" id="5871903">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5871906">//&nbsp;phrase&nbsp;=&nbsp;1*word</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5871926">var</span>&nbsp;<span class="ident" id="5871930">words</span>&nbsp;<span class="op" id="5871936">[</span><span class="op" id="5871937">]</span><span class="builtintype" id="5871938">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5871946">for</span>&nbsp;<span class="op" id="5871950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5871954">//&nbsp;word&nbsp;=&nbsp;atom&nbsp;/&nbsp;quoted-string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5871987">var</span>&nbsp;<span class="ident" id="5871991">word</span>&nbsp;<span class="builtintype" id="5871996">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5872005">p</span><span class="op" id="5872006">.</span><span class="ident" id="5872007">skipSpace</span><span class="op" id="5872016">(</span><span class="op" id="5872017">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5872021">if</span>&nbsp;<span class="ident" id="5872024">p</span><span class="op" id="5872025">.</span><span class="ident" id="5872026">empty</span><span class="op" id="5872031">(</span><span class="op" id="5872032">)</span>&nbsp;<span class="op" id="5872034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5872039">return</span>&nbsp;<span class="string" id="5872046">&#34;&#34;</span><span class="op" id="5872048">,</span>&nbsp;<span class="ident" id="5872050">errors</span><span class="op" id="5872056">.</span><span class="ident" id="5872057">New</span><span class="op" id="5872060">(</span><span class="string" id="5872061">&#34;mail:&nbsp;missing&nbsp;phrase&#34;</span><span class="op" id="5872083">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5872087">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5872091">if</span>&nbsp;<span class="ident" id="5872094">p</span><span class="op" id="5872095">.</span><span class="ident" id="5872096">peek</span><span class="op" id="5872100">(</span><span class="op" id="5872101">)</span>&nbsp;<span class="op" id="5872103">==</span>&nbsp;<span class="string" id="5872106">&#39;&#34;&#39;</span>&nbsp;<span class="op" id="5872110">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5872115">//&nbsp;quoted-string</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5872135">word</span><span class="op" id="5872139">,</span>&nbsp;<span class="ident" id="5872141">err</span>&nbsp;<span class="op" id="5872145">=</span>&nbsp;<span class="ident" id="5872147">p</span><span class="op" id="5872148">.</span><span class="ident" id="5872149">consumeQuotedString</span><span class="op" id="5872168">(</span><span class="op" id="5872169">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5872173">}</span>&nbsp;<span class="keyword" id="5872175">else</span>&nbsp;<span class="op" id="5872180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5872185">//&nbsp;atom</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5872196">//&nbsp;We&nbsp;actually&nbsp;parse&nbsp;dot-atom&nbsp;here&nbsp;to&nbsp;be&nbsp;more&nbsp;permissive</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5872256">//&nbsp;than&nbsp;what&nbsp;RFC&nbsp;5322&nbsp;specifies.</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5872292">word</span><span class="op" id="5872296">,</span>&nbsp;<span class="ident" id="5872298">err</span>&nbsp;<span class="op" id="5872302">=</span>&nbsp;<span class="ident" id="5872304">p</span><span class="op" id="5872305">.</span><span class="ident" id="5872306">consumeAtom</span><span class="op" id="5872317">(</span><span class="builtintype" id="5872318">true</span><span class="op" id="5872322">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5872326">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5872331">//&nbsp;RFC&nbsp;2047&nbsp;encoded-word&nbsp;starts&nbsp;with&nbsp;=?,&nbsp;ends&nbsp;with&nbsp;?=,&nbsp;and&nbsp;has&nbsp;two&nbsp;other&nbsp;?s.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5872410">if</span>&nbsp;<span class="ident" id="5872413">err</span>&nbsp;<span class="op" id="5872417">==</span>&nbsp;<span class="builtintype" id="5872420">nil</span>&nbsp;<span class="op" id="5872424">&amp;&amp;</span>&nbsp;<span class="ident" id="5872427">strings</span><span class="op" id="5872434">.</span><span class="ident" id="5872435">HasPrefix</span><span class="op" id="5872444">(</span><span class="ident" id="5872445">word</span><span class="op" id="5872449">,</span>&nbsp;<span class="string" id="5872451">&#34;=?&#34;</span><span class="op" id="5872455">)</span>&nbsp;<span class="op" id="5872457">&amp;&amp;</span>&nbsp;<span class="ident" id="5872460">strings</span><span class="op" id="5872467">.</span><span class="ident" id="5872468">HasSuffix</span><span class="op" id="5872477">(</span><span class="ident" id="5872478">word</span><span class="op" id="5872482">,</span>&nbsp;<span class="string" id="5872484">&#34;?=&#34;</span><span class="op" id="5872488">)</span>&nbsp;<span class="op" id="5872490">&amp;&amp;</span>&nbsp;<span class="ident" id="5872493">strings</span><span class="op" id="5872500">.</span><span class="ident" id="5872501">Count</span><span class="op" id="5872506">(</span><span class="ident" id="5872507">word</span><span class="op" id="5872511">,</span>&nbsp;<span class="string" id="5872513">&#34;?&#34;</span><span class="op" id="5872516">)</span>&nbsp;<span class="op" id="5872518">==</span>&nbsp;<span class="num" id="5872521">4</span>&nbsp;<span class="op" id="5872523">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5872528">word</span><span class="op" id="5872532">,</span>&nbsp;<span class="ident" id="5872534">err</span>&nbsp;<span class="op" id="5872538">=</span>&nbsp;<span class="ident" id="5872540">decodeRFC2047Word</span><span class="op" id="5872557">(</span><span class="ident" id="5872558">word</span><span class="op" id="5872562">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5872566">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5872571">if</span>&nbsp;<span class="ident" id="5872574">err</span>&nbsp;<span class="op" id="5872578">!=</span>&nbsp;<span class="builtintype" id="5872581">nil</span>&nbsp;<span class="op" id="5872585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5872590">break</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5872598">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5872602">debug</span><span class="op" id="5872607">.</span><span class="ident" id="5872608">Printf</span><span class="op" id="5872614">(</span><span class="string" id="5872615">&#34;consumePhrase:&nbsp;consumed&nbsp;%q&#34;</span><span class="op" id="5872643">,</span>&nbsp;<span class="ident" id="5872645">word</span><span class="op" id="5872649">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5872653">words</span>&nbsp;<span class="op" id="5872659">=</span>&nbsp;<span class="builtinfunc" id="5872661">append</span><span class="op" id="5872667">(</span><span class="ident" id="5872668">words</span><span class="op" id="5872673">,</span>&nbsp;<span class="ident" id="5872675">word</span><span class="op" id="5872679">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5872682">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5872685">//&nbsp;Ignore&nbsp;any&nbsp;error&nbsp;if&nbsp;we&nbsp;got&nbsp;at&nbsp;least&nbsp;one&nbsp;word.</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5872735">if</span>&nbsp;<span class="ident" id="5872738">err</span>&nbsp;<span class="op" id="5872742">!=</span>&nbsp;<span class="builtintype" id="5872745">nil</span>&nbsp;<span class="op" id="5872749">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="5872752">len</span><span class="op" id="5872755">(</span><span class="ident" id="5872756">words</span><span class="op" id="5872761">)</span>&nbsp;<span class="op" id="5872763">==</span>&nbsp;<span class="num" id="5872766">0</span>&nbsp;<span class="op" id="5872768">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5872772">debug</span><span class="op" id="5872777">.</span><span class="ident" id="5872778">Printf</span><span class="op" id="5872784">(</span><span class="string" id="5872785">&#34;consumePhrase:&nbsp;hit&nbsp;err:&nbsp;%v&#34;</span><span class="op" id="5872813">,</span>&nbsp;<span class="ident" id="5872815">err</span><span class="op" id="5872818">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5872822">return</span>&nbsp;<span class="string" id="5872829">&#34;&#34;</span><span class="op" id="5872831">,</span>&nbsp;<span class="ident" id="5872833">fmt</span><span class="op" id="5872836">.</span><span class="ident" id="5872837">Errorf</span><span class="op" id="5872843">(</span><span class="string" id="5872844">&#34;mail:&nbsp;missing&nbsp;word&nbsp;in&nbsp;phrase:&nbsp;%v&#34;</span><span class="op" id="5872878">,</span>&nbsp;<span class="ident" id="5872880">err</span><span class="op" id="5872883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5872886">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5872889">phrase</span>&nbsp;<span class="op" id="5872896">=</span>&nbsp;<span class="ident" id="5872898">strings</span><span class="op" id="5872905">.</span><span class="ident" id="5872906">Join</span><span class="op" id="5872910">(</span><span class="ident" id="5872911">words</span><span class="op" id="5872916">,</span>&nbsp;<span class="string" id="5872918">&#34;&nbsp;&#34;</span><span class="op" id="5872921">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5872924">return</span>&nbsp;<span class="ident" id="5872931">phrase</span><span class="op" id="5872937">,</span>&nbsp;<span class="builtintype" id="5872939">nil</span><br>
<span class="lineno"></span><span class="op" id="5872943">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5872946">//&nbsp;consumeQuotedString&nbsp;parses&nbsp;the&nbsp;quoted&nbsp;string&nbsp;at&nbsp;the&nbsp;start&nbsp;of&nbsp;p.</span><br>
<span class="lineno"></span><span class="keyword" id="5873013">func</span>&nbsp;<span class="op" id="5873018">(</span><span class="ident" id="5873019">p</span>&nbsp;<span class="op" id="5873021">*</span><span class="ident" id="5873022">addrParser</span><span class="op" id="5873032">)</span>&nbsp;<span class="ident" id="5873034">consumeQuotedString</span><span class="op" id="5873053">(</span><span class="op" id="5873054">)</span>&nbsp;<span class="op" id="5873056">(</span><span class="ident" id="5873057">qs</span>&nbsp;<span class="builtintype" id="5873060">string</span><span class="op" id="5873066">,</span>&nbsp;<span class="ident" id="5873068">err</span>&nbsp;<span class="builtintype" id="5873072">error</span><span class="op" id="5873077">)</span>&nbsp;<span class="op" id="5873079">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5873082">//&nbsp;Assume&nbsp;first&nbsp;byte&nbsp;is&nbsp;&#39;&#34;&#39;.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5873112">i</span>&nbsp;<span class="op" id="5873114">:=</span>&nbsp;<span class="num" id="5873117">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5873120">qsb</span>&nbsp;<span class="op" id="5873124">:=</span>&nbsp;<span class="builtinfunc" id="5873127">make</span><span class="op" id="5873131">(</span><span class="op" id="5873132">[</span><span class="op" id="5873133">]</span><span class="builtintype" id="5873134">byte</span><span class="op" id="5873138">,</span>&nbsp;<span class="num" id="5873140">0</span><span class="op" id="5873141">,</span>&nbsp;<span class="num" id="5873143">10</span><span class="op" id="5873145">)</span><br>
<span class="lineno"></span><span class="ident" id="5873147">Loop</span><span class="op" id="5873151">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5873154">for</span>&nbsp;<span class="op" id="5873158">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5873162">if</span>&nbsp;<span class="ident" id="5873165">i</span>&nbsp;<span class="op" id="5873167">&gt;=</span>&nbsp;<span class="ident" id="5873170">p</span><span class="op" id="5873171">.</span><span class="builtinfunc" id="5873172">len</span><span class="op" id="5873175">(</span><span class="op" id="5873176">)</span>&nbsp;<span class="op" id="5873178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5873183">return</span>&nbsp;<span class="string" id="5873190">&#34;&#34;</span><span class="op" id="5873192">,</span>&nbsp;<span class="ident" id="5873194">errors</span><span class="op" id="5873200">.</span><span class="ident" id="5873201">New</span><span class="op" id="5873204">(</span><span class="string" id="5873205">&#34;mail:&nbsp;unclosed&nbsp;quoted-string&#34;</span><span class="op" id="5873235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5873239">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5873243">switch</span>&nbsp;<span class="ident" id="5873250">c</span>&nbsp;<span class="op" id="5873252">:=</span>&nbsp;<span class="op" id="5873255">(</span><span class="op" id="5873256">*</span><span class="ident" id="5873257">p</span><span class="op" id="5873258">)</span><span class="op" id="5873259">[</span><span class="ident" id="5873260">i</span><span class="op" id="5873261">]</span><span class="op" id="5873262">;</span>&nbsp;<span class="op" id="5873264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5873268">case</span>&nbsp;<span class="ident" id="5873273">c</span>&nbsp;<span class="op" id="5873275">==</span>&nbsp;<span class="string" id="5873278">&#39;&#34;&#39;</span><span class="op" id="5873281">:</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5873286">break</span>&nbsp;<span class="ident" id="5873292">Loop</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5873299">case</span>&nbsp;<span class="ident" id="5873304">c</span>&nbsp;<span class="op" id="5873306">==</span>&nbsp;<span class="string" id="5873309">&#39;\\&#39;</span><span class="op" id="5873313">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5873318">if</span>&nbsp;<span class="ident" id="5873321">i</span><span class="op" id="5873322">+</span><span class="num" id="5873323">1</span>&nbsp;<span class="op" id="5873325">==</span>&nbsp;<span class="ident" id="5873328">p</span><span class="op" id="5873329">.</span><span class="builtinfunc" id="5873330">len</span><span class="op" id="5873333">(</span><span class="op" id="5873334">)</span>&nbsp;<span class="op" id="5873336">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5873342">return</span>&nbsp;<span class="string" id="5873349">&#34;&#34;</span><span class="op" id="5873351">,</span>&nbsp;<span class="ident" id="5873353">errors</span><span class="op" id="5873359">.</span><span class="ident" id="5873360">New</span><span class="op" id="5873363">(</span><span class="string" id="5873364">&#34;mail:&nbsp;unclosed&nbsp;quoted-string&#34;</span><span class="op" id="5873394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5873399">}</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5873404">qsb</span>&nbsp;<span class="op" id="5873408">=</span>&nbsp;<span class="builtinfunc" id="5873410">append</span><span class="op" id="5873416">(</span><span class="ident" id="5873417">qsb</span><span class="op" id="5873420">,</span>&nbsp;<span class="op" id="5873422">(</span><span class="op" id="5873423">*</span><span class="ident" id="5873424">p</span><span class="op" id="5873425">)</span><span class="op" id="5873426">[</span><span class="ident" id="5873427">i</span><span class="op" id="5873428">+</span><span class="num" id="5873429">1</span><span class="op" id="5873430">]</span><span class="op" id="5873431">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5873436">i</span>&nbsp;<span class="op" id="5873438">+=</span>&nbsp;<span class="num" id="5873441">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5873445">case</span>&nbsp;<span class="ident" id="5873450">isQtext</span><span class="op" id="5873457">(</span><span class="ident" id="5873458">c</span><span class="op" id="5873459">)</span><span class="op" id="5873460">,</span>&nbsp;<span class="ident" id="5873462">c</span>&nbsp;<span class="op" id="5873464">==</span>&nbsp;<span class="string" id="5873467">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="5873471">||</span>&nbsp;<span class="ident" id="5873474">c</span>&nbsp;<span class="op" id="5873476">==</span>&nbsp;<span class="string" id="5873479">&#39;\t&#39;</span><span class="op" id="5873483">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5873488">//&nbsp;qtext&nbsp;(printable&nbsp;US-ASCII&nbsp;excluding&nbsp;&#34;&nbsp;and&nbsp;\),&nbsp;or</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5873543">//&nbsp;FWS&nbsp;(almost;&nbsp;we&#39;re&nbsp;ignoring&nbsp;CRLF)</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5873583">qsb</span>&nbsp;<span class="op" id="5873587">=</span>&nbsp;<span class="builtinfunc" id="5873589">append</span><span class="op" id="5873595">(</span><span class="ident" id="5873596">qsb</span><span class="op" id="5873599">,</span>&nbsp;<span class="ident" id="5873601">c</span><span class="op" id="5873602">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5873607">i</span><span class="op" id="5873608">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5873613">default</span><span class="op" id="5873620">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5873625">return</span>&nbsp;<span class="string" id="5873632">&#34;&#34;</span><span class="op" id="5873634">,</span>&nbsp;<span class="ident" id="5873636">fmt</span><span class="op" id="5873639">.</span><span class="ident" id="5873640">Errorf</span><span class="op" id="5873646">(</span><span class="string" id="5873647">&#34;mail:&nbsp;bad&nbsp;character&nbsp;in&nbsp;quoted-string:&nbsp;%q&#34;</span><span class="op" id="5873689">,</span>&nbsp;<span class="ident" id="5873691">c</span><span class="op" id="5873692">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5873696">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5873699">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5873702">*</span><span class="ident" id="5873703">p</span>&nbsp;<span class="op" id="5873705">=</span>&nbsp;<span class="op" id="5873707">(</span><span class="op" id="5873708">*</span><span class="ident" id="5873709">p</span><span class="op" id="5873710">)</span><span class="op" id="5873711">[</span><span class="ident" id="5873712">i</span><span class="op" id="5873713">+</span><span class="num" id="5873714">1</span><span class="op" id="5873715">:</span><span class="op" id="5873716">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5873719">return</span>&nbsp;<span class="builtintype" id="5873726">string</span><span class="op" id="5873732">(</span><span class="ident" id="5873733">qsb</span><span class="op" id="5873736">)</span><span class="op" id="5873737">,</span>&nbsp;<span class="builtintype" id="5873739">nil</span><br>
<span class="lineno"></span><span class="op" id="5873743">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">405</span><span class="comment" id="5873746">//&nbsp;consumeAtom&nbsp;parses&nbsp;an&nbsp;RFC&nbsp;5322&nbsp;atom&nbsp;at&nbsp;the&nbsp;start&nbsp;of&nbsp;p.</span><br>
<span class="lineno"></span><span class="comment" id="5873804">//&nbsp;If&nbsp;dot&nbsp;is&nbsp;true,&nbsp;consumeAtom&nbsp;parses&nbsp;an&nbsp;RFC&nbsp;5322&nbsp;dot-atom&nbsp;instead.</span><br>
<span class="lineno"></span><span class="keyword" id="5873872">func</span>&nbsp;<span class="op" id="5873877">(</span><span class="ident" id="5873878">p</span>&nbsp;<span class="op" id="5873880">*</span><span class="ident" id="5873881">addrParser</span><span class="op" id="5873891">)</span>&nbsp;<span class="ident" id="5873893">consumeAtom</span><span class="op" id="5873904">(</span><span class="ident" id="5873905">dot</span>&nbsp;<span class="builtintype" id="5873909">bool</span><span class="op" id="5873913">)</span>&nbsp;<span class="op" id="5873915">(</span><span class="ident" id="5873916">atom</span>&nbsp;<span class="builtintype" id="5873921">string</span><span class="op" id="5873927">,</span>&nbsp;<span class="ident" id="5873929">err</span>&nbsp;<span class="builtintype" id="5873933">error</span><span class="op" id="5873938">)</span>&nbsp;<span class="op" id="5873940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5873943">if</span>&nbsp;<span class="op" id="5873946">!</span><span class="ident" id="5873947">isAtext</span><span class="op" id="5873954">(</span><span class="ident" id="5873955">p</span><span class="op" id="5873956">.</span><span class="ident" id="5873957">peek</span><span class="op" id="5873961">(</span><span class="op" id="5873962">)</span><span class="op" id="5873963">,</span>&nbsp;<span class="builtintype" id="5873965">false</span><span class="op" id="5873970">)</span>&nbsp;<span class="op" id="5873972">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5873976">return</span>&nbsp;<span class="string" id="5873983">&#34;&#34;</span><span class="op" id="5873985">,</span>&nbsp;<span class="ident" id="5873987">errors</span><span class="op" id="5873993">.</span><span class="ident" id="5873994">New</span><span class="op" id="5873997">(</span><span class="string" id="5873998">&#34;mail:&nbsp;invalid&nbsp;string&#34;</span><span class="op" id="5874020">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5874023">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5874026">i</span>&nbsp;<span class="op" id="5874028">:=</span>&nbsp;<span class="num" id="5874031">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5874034">for</span>&nbsp;<span class="op" id="5874038">;</span>&nbsp;<span class="ident" id="5874040">i</span>&nbsp;<span class="op" id="5874042">&lt;</span>&nbsp;<span class="ident" id="5874044">p</span><span class="op" id="5874045">.</span><span class="builtinfunc" id="5874046">len</span><span class="op" id="5874049">(</span><span class="op" id="5874050">)</span>&nbsp;<span class="op" id="5874052">&amp;&amp;</span>&nbsp;<span class="ident" id="5874055">isAtext</span><span class="op" id="5874062">(</span><span class="op" id="5874063">(</span><span class="op" id="5874064">*</span><span class="ident" id="5874065">p</span><span class="op" id="5874066">)</span><span class="op" id="5874067">[</span><span class="ident" id="5874068">i</span><span class="op" id="5874069">]</span><span class="op" id="5874070">,</span>&nbsp;<span class="ident" id="5874072">dot</span><span class="op" id="5874075">)</span><span class="op" id="5874076">;</span>&nbsp;<span class="ident" id="5874078">i</span><span class="op" id="5874079">++</span>&nbsp;<span class="op" id="5874082">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5874085">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5874088">atom</span><span class="op" id="5874092">,</span>&nbsp;<span class="op" id="5874094">*</span><span class="ident" id="5874095">p</span>&nbsp;<span class="op" id="5874097">=</span>&nbsp;<span class="builtintype" id="5874099">string</span><span class="op" id="5874105">(</span><span class="op" id="5874106">(</span><span class="op" id="5874107">*</span><span class="ident" id="5874108">p</span><span class="op" id="5874109">)</span><span class="op" id="5874110">[</span><span class="op" id="5874111">:</span><span class="ident" id="5874112">i</span><span class="op" id="5874113">]</span><span class="op" id="5874114">)</span><span class="op" id="5874115">,</span>&nbsp;<span class="op" id="5874117">(</span><span class="op" id="5874118">*</span><span class="ident" id="5874119">p</span><span class="op" id="5874120">)</span><span class="op" id="5874121">[</span><span class="ident" id="5874122">i</span><span class="op" id="5874123">:</span><span class="op" id="5874124">]</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5874127">return</span>&nbsp;<span class="ident" id="5874134">atom</span><span class="op" id="5874138">,</span>&nbsp;<span class="builtintype" id="5874140">nil</span><br>
<span class="lineno"></span><span class="op" id="5874144">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5874147">func</span>&nbsp;<span class="op" id="5874152">(</span><span class="ident" id="5874153">p</span>&nbsp;<span class="op" id="5874155">*</span><span class="ident" id="5874156">addrParser</span><span class="op" id="5874166">)</span>&nbsp;<span class="ident" id="5874168">consume</span><span class="op" id="5874175">(</span><span class="ident" id="5874176">c</span>&nbsp;<span class="builtintype" id="5874178">byte</span><span class="op" id="5874182">)</span>&nbsp;<span class="builtintype" id="5874184">bool</span>&nbsp;<span class="op" id="5874189">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5874192">if</span>&nbsp;<span class="ident" id="5874195">p</span><span class="op" id="5874196">.</span><span class="ident" id="5874197">empty</span><span class="op" id="5874202">(</span><span class="op" id="5874203">)</span>&nbsp;<span class="op" id="5874205">||</span>&nbsp;<span class="ident" id="5874208">p</span><span class="op" id="5874209">.</span><span class="ident" id="5874210">peek</span><span class="op" id="5874214">(</span><span class="op" id="5874215">)</span>&nbsp;<span class="op" id="5874217">!=</span>&nbsp;<span class="ident" id="5874220">c</span>&nbsp;<span class="op" id="5874222">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5874226">return</span>&nbsp;<span class="builtintype" id="5874233">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5874240">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5874243">*</span><span class="ident" id="5874244">p</span>&nbsp;<span class="op" id="5874246">=</span>&nbsp;<span class="op" id="5874248">(</span><span class="op" id="5874249">*</span><span class="ident" id="5874250">p</span><span class="op" id="5874251">)</span><span class="op" id="5874252">[</span><span class="num" id="5874253">1</span><span class="op" id="5874254">:</span><span class="op" id="5874255">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5874258">return</span>&nbsp;<span class="builtintype" id="5874265">true</span><br>
<span class="lineno"></span><span class="op" id="5874270">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span><span class="comment" id="5874273">//&nbsp;skipSpace&nbsp;skips&nbsp;the&nbsp;leading&nbsp;space&nbsp;and&nbsp;tab&nbsp;characters.</span><br>
<span class="lineno"></span><span class="keyword" id="5874330">func</span>&nbsp;<span class="op" id="5874335">(</span><span class="ident" id="5874336">p</span>&nbsp;<span class="op" id="5874338">*</span><span class="ident" id="5874339">addrParser</span><span class="op" id="5874349">)</span>&nbsp;<span class="ident" id="5874351">skipSpace</span><span class="op" id="5874360">(</span><span class="op" id="5874361">)</span>&nbsp;<span class="op" id="5874363">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5874366">*</span><span class="ident" id="5874367">p</span>&nbsp;<span class="op" id="5874369">=</span>&nbsp;<span class="ident" id="5874371">bytes</span><span class="op" id="5874376">.</span><span class="ident" id="5874377">TrimLeft</span><span class="op" id="5874385">(</span><span class="op" id="5874386">*</span><span class="ident" id="5874387">p</span><span class="op" id="5874388">,</span>&nbsp;<span class="string" id="5874390">&#34;&nbsp;\t&#34;</span><span class="op" id="5874395">)</span><br>
<span class="lineno"></span><span class="op" id="5874397">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span><span class="keyword" id="5874400">func</span>&nbsp;<span class="op" id="5874405">(</span><span class="ident" id="5874406">p</span>&nbsp;<span class="op" id="5874408">*</span><span class="ident" id="5874409">addrParser</span><span class="op" id="5874419">)</span>&nbsp;<span class="ident" id="5874421">peek</span><span class="op" id="5874425">(</span><span class="op" id="5874426">)</span>&nbsp;<span class="builtintype" id="5874428">byte</span>&nbsp;<span class="op" id="5874433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5874436">return</span>&nbsp;<span class="op" id="5874443">(</span><span class="op" id="5874444">*</span><span class="ident" id="5874445">p</span><span class="op" id="5874446">)</span><span class="op" id="5874447">[</span><span class="num" id="5874448">0</span><span class="op" id="5874449">]</span><br>
<span class="lineno"></span><span class="op" id="5874451">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">435</span><span class="keyword" id="5874454">func</span>&nbsp;<span class="op" id="5874459">(</span><span class="ident" id="5874460">p</span>&nbsp;<span class="op" id="5874462">*</span><span class="ident" id="5874463">addrParser</span><span class="op" id="5874473">)</span>&nbsp;<span class="ident" id="5874475">empty</span><span class="op" id="5874480">(</span><span class="op" id="5874481">)</span>&nbsp;<span class="builtintype" id="5874483">bool</span>&nbsp;<span class="op" id="5874488">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5874491">return</span>&nbsp;<span class="ident" id="5874498">p</span><span class="op" id="5874499">.</span><span class="builtinfunc" id="5874500">len</span><span class="op" id="5874503">(</span><span class="op" id="5874504">)</span>&nbsp;<span class="op" id="5874506">==</span>&nbsp;<span class="num" id="5874509">0</span><br>
<span class="lineno"></span><span class="op" id="5874511">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5874514">func</span>&nbsp;<span class="op" id="5874519">(</span><span class="ident" id="5874520">p</span>&nbsp;<span class="op" id="5874522">*</span><span class="ident" id="5874523">addrParser</span><span class="op" id="5874533">)</span>&nbsp;<span class="builtinfunc" id="5874535">len</span><span class="op" id="5874538">(</span><span class="op" id="5874539">)</span>&nbsp;<span class="builtintype" id="5874541">int</span>&nbsp;<span class="op" id="5874545">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5874548">return</span>&nbsp;<span class="builtinfunc" id="5874555">len</span><span class="op" id="5874558">(</span><span class="op" id="5874559">*</span><span class="ident" id="5874560">p</span><span class="op" id="5874561">)</span><br>
<span class="lineno"></span><span class="op" id="5874563">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5874566">func</span>&nbsp;<span class="ident" id="5874571">decodeRFC2047Word</span><span class="op" id="5874588">(</span><span class="ident" id="5874589">s</span>&nbsp;<span class="builtintype" id="5874591">string</span><span class="op" id="5874597">)</span>&nbsp;<span class="op" id="5874599">(</span><span class="builtintype" id="5874600">string</span><span class="op" id="5874606">,</span>&nbsp;<span class="builtintype" id="5874608">error</span><span class="op" id="5874613">)</span>&nbsp;<span class="op" id="5874615">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5874618">fields</span>&nbsp;<span class="op" id="5874625">:=</span>&nbsp;<span class="ident" id="5874628">strings</span><span class="op" id="5874635">.</span><span class="ident" id="5874636">Split</span><span class="op" id="5874641">(</span><span class="ident" id="5874642">s</span><span class="op" id="5874643">,</span>&nbsp;<span class="string" id="5874645">&#34;?&#34;</span><span class="op" id="5874648">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5874651">if</span>&nbsp;<span class="builtinfunc" id="5874654">len</span><span class="op" id="5874657">(</span><span class="ident" id="5874658">fields</span><span class="op" id="5874664">)</span>&nbsp;<span class="op" id="5874666">!=</span>&nbsp;<span class="num" id="5874669">5</span>&nbsp;<span class="op" id="5874671">||</span>&nbsp;<span class="ident" id="5874674">fields</span><span class="op" id="5874680">[</span><span class="num" id="5874681">0</span><span class="op" id="5874682">]</span>&nbsp;<span class="op" id="5874684">!=</span>&nbsp;<span class="string" id="5874687">&#34;=&#34;</span>&nbsp;<span class="op" id="5874691">||</span>&nbsp;<span class="ident" id="5874694">fields</span><span class="op" id="5874700">[</span><span class="num" id="5874701">4</span><span class="op" id="5874702">]</span>&nbsp;<span class="op" id="5874704">!=</span>&nbsp;<span class="string" id="5874707">&#34;=&#34;</span>&nbsp;<span class="op" id="5874711">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5874715">return</span>&nbsp;<span class="string" id="5874722">&#34;&#34;</span><span class="op" id="5874724">,</span>&nbsp;<span class="ident" id="5874726">errors</span><span class="op" id="5874732">.</span><span class="ident" id="5874733">New</span><span class="op" id="5874736">(</span><span class="string" id="5874737">&#34;address&nbsp;not&nbsp;RFC&nbsp;2047&nbsp;encoded&#34;</span><span class="op" id="5874767">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5874770">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5874773">charset</span><span class="op" id="5874780">,</span>&nbsp;<span class="ident" id="5874782">enc</span>&nbsp;<span class="op" id="5874786">:=</span>&nbsp;<span class="ident" id="5874789">strings</span><span class="op" id="5874796">.</span><span class="ident" id="5874797">ToLower</span><span class="op" id="5874804">(</span><span class="ident" id="5874805">fields</span><span class="op" id="5874811">[</span><span class="num" id="5874812">1</span><span class="op" id="5874813">]</span><span class="op" id="5874814">)</span><span class="op" id="5874815">,</span>&nbsp;<span class="ident" id="5874817">strings</span><span class="op" id="5874824">.</span><span class="ident" id="5874825">ToLower</span><span class="op" id="5874832">(</span><span class="ident" id="5874833">fields</span><span class="op" id="5874839">[</span><span class="num" id="5874840">2</span><span class="op" id="5874841">]</span><span class="op" id="5874842">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5874845">if</span>&nbsp;<span class="ident" id="5874848">charset</span>&nbsp;<span class="op" id="5874856">!=</span>&nbsp;<span class="string" id="5874859">&#34;us-ascii&#34;</span>&nbsp;<span class="op" id="5874870">&amp;&amp;</span>&nbsp;<span class="ident" id="5874873">charset</span>&nbsp;<span class="op" id="5874881">!=</span>&nbsp;<span class="string" id="5874884">&#34;iso-8859-1&#34;</span>&nbsp;<span class="op" id="5874897">&amp;&amp;</span>&nbsp;<span class="ident" id="5874900">charset</span>&nbsp;<span class="op" id="5874908">!=</span>&nbsp;<span class="string" id="5874911">&#34;utf-8&#34;</span>&nbsp;<span class="op" id="5874919">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5874923">return</span>&nbsp;<span class="string" id="5874930">&#34;&#34;</span><span class="op" id="5874932">,</span>&nbsp;<span class="ident" id="5874934">fmt</span><span class="op" id="5874937">.</span><span class="ident" id="5874938">Errorf</span><span class="op" id="5874944">(</span><span class="string" id="5874945">&#34;charset&nbsp;not&nbsp;supported:&nbsp;%q&#34;</span><span class="op" id="5874972">,</span>&nbsp;<span class="ident" id="5874974">charset</span><span class="op" id="5874981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5874984">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5874988">in</span>&nbsp;<span class="op" id="5874991">:=</span>&nbsp;<span class="ident" id="5874994">bytes</span><span class="op" id="5874999">.</span><span class="ident" id="5875000">NewBufferString</span><span class="op" id="5875015">(</span><span class="ident" id="5875016">fields</span><span class="op" id="5875022">[</span><span class="num" id="5875023">3</span><span class="op" id="5875024">]</span><span class="op" id="5875025">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5875028">var</span>&nbsp;<span class="ident" id="5875032">r</span>&nbsp;<span class="ident" id="5875034">io</span><span class="op" id="5875036">.</span><span class="ident" id="5875037">Reader</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5875045">switch</span>&nbsp;<span class="ident" id="5875052">enc</span>&nbsp;<span class="op" id="5875056">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5875059">case</span>&nbsp;<span class="string" id="5875064">&#34;b&#34;</span><span class="op" id="5875067">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5875071">r</span>&nbsp;<span class="op" id="5875073">=</span>&nbsp;<span class="ident" id="5875075">base64</span><span class="op" id="5875081">.</span><span class="ident" id="5875082">NewDecoder</span><span class="op" id="5875092">(</span><span class="ident" id="5875093">base64</span><span class="op" id="5875099">.</span><span class="ident" id="5875100">StdEncoding</span><span class="op" id="5875111">,</span>&nbsp;<span class="ident" id="5875113">in</span><span class="op" id="5875115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5875118">case</span>&nbsp;<span class="string" id="5875123">&#34;q&#34;</span><span class="op" id="5875126">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5875130">r</span>&nbsp;<span class="op" id="5875132">=</span>&nbsp;<span class="ident" id="5875134">qDecoder</span><span class="op" id="5875142">{</span><span class="ident" id="5875143">r</span><span class="op" id="5875144">:</span>&nbsp;<span class="ident" id="5875146">in</span><span class="op" id="5875148">}</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5875151">default</span><span class="op" id="5875158">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5875162">return</span>&nbsp;<span class="string" id="5875169">&#34;&#34;</span><span class="op" id="5875171">,</span>&nbsp;<span class="ident" id="5875173">fmt</span><span class="op" id="5875176">.</span><span class="ident" id="5875177">Errorf</span><span class="op" id="5875183">(</span><span class="string" id="5875184">&#34;RFC&nbsp;2047&nbsp;encoding&nbsp;not&nbsp;supported:&nbsp;%q&#34;</span><span class="op" id="5875221">,</span>&nbsp;<span class="ident" id="5875223">enc</span><span class="op" id="5875226">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5875229">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5875233">dec</span><span class="op" id="5875236">,</span>&nbsp;<span class="ident" id="5875238">err</span>&nbsp;<span class="op" id="5875242">:=</span>&nbsp;<span class="ident" id="5875245">ioutil</span><span class="op" id="5875251">.</span><span class="ident" id="5875252">ReadAll</span><span class="op" id="5875259">(</span><span class="ident" id="5875260">r</span><span class="op" id="5875261">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5875264">if</span>&nbsp;<span class="ident" id="5875267">err</span>&nbsp;<span class="op" id="5875271">!=</span>&nbsp;<span class="builtintype" id="5875274">nil</span>&nbsp;<span class="op" id="5875278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5875282">return</span>&nbsp;<span class="string" id="5875289">&#34;&#34;</span><span class="op" id="5875291">,</span>&nbsp;<span class="ident" id="5875293">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5875298">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5875302">switch</span>&nbsp;<span class="ident" id="5875309">charset</span>&nbsp;<span class="op" id="5875317">{</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5875320">case</span>&nbsp;<span class="string" id="5875325">&#34;us-ascii&#34;</span><span class="op" id="5875335">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5875339">b</span>&nbsp;<span class="op" id="5875341">:=</span>&nbsp;<span class="builtinfunc" id="5875344">new</span><span class="op" id="5875347">(</span><span class="ident" id="5875348">bytes</span><span class="op" id="5875353">.</span><span class="ident" id="5875354">Buffer</span><span class="op" id="5875360">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5875364">for</span>&nbsp;<span class="ident" id="5875368">_</span><span class="op" id="5875369">,</span>&nbsp;<span class="ident" id="5875371">c</span>&nbsp;<span class="op" id="5875373">:=</span>&nbsp;<span class="keyword" id="5875376">range</span>&nbsp;<span class="ident" id="5875382">dec</span>&nbsp;<span class="op" id="5875386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5875391">if</span>&nbsp;<span class="ident" id="5875394">c</span>&nbsp;<span class="op" id="5875396">&gt;=</span>&nbsp;<span class="num" id="5875399">0x80</span>&nbsp;<span class="op" id="5875404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5875410">b</span><span class="op" id="5875411">.</span><span class="ident" id="5875412">WriteRune</span><span class="op" id="5875421">(</span><span class="ident" id="5875422">unicode</span><span class="op" id="5875429">.</span><span class="ident" id="5875430">ReplacementChar</span><span class="op" id="5875445">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5875450">}</span>&nbsp;<span class="keyword" id="5875452">else</span>&nbsp;<span class="op" id="5875457">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5875463">b</span><span class="op" id="5875464">.</span><span class="ident" id="5875465">WriteRune</span><span class="op" id="5875474">(</span><span class="builtintype" id="5875475">rune</span><span class="op" id="5875479">(</span><span class="ident" id="5875480">c</span><span class="op" id="5875481">)</span><span class="op" id="5875482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5875487">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5875491">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5875495">return</span>&nbsp;<span class="ident" id="5875502">b</span><span class="op" id="5875503">.</span><span class="ident" id="5875504">String</span><span class="op" id="5875510">(</span><span class="op" id="5875511">)</span><span class="op" id="5875512">,</span>&nbsp;<span class="builtintype" id="5875514">nil</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5875519">case</span>&nbsp;<span class="string" id="5875524">&#34;iso-8859-1&#34;</span><span class="op" id="5875536">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5875540">b</span>&nbsp;<span class="op" id="5875542">:=</span>&nbsp;<span class="builtinfunc" id="5875545">new</span><span class="op" id="5875548">(</span><span class="ident" id="5875549">bytes</span><span class="op" id="5875554">.</span><span class="ident" id="5875555">Buffer</span><span class="op" id="5875561">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5875565">for</span>&nbsp;<span class="ident" id="5875569">_</span><span class="op" id="5875570">,</span>&nbsp;<span class="ident" id="5875572">c</span>&nbsp;<span class="op" id="5875574">:=</span>&nbsp;<span class="keyword" id="5875577">range</span>&nbsp;<span class="ident" id="5875583">dec</span>&nbsp;<span class="op" id="5875587">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5875592">b</span><span class="op" id="5875593">.</span><span class="ident" id="5875594">WriteRune</span><span class="op" id="5875603">(</span><span class="builtintype" id="5875604">rune</span><span class="op" id="5875608">(</span><span class="ident" id="5875609">c</span><span class="op" id="5875610">)</span><span class="op" id="5875611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5875615">}</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5875619">return</span>&nbsp;<span class="ident" id="5875626">b</span><span class="op" id="5875627">.</span><span class="ident" id="5875628">String</span><span class="op" id="5875634">(</span><span class="op" id="5875635">)</span><span class="op" id="5875636">,</span>&nbsp;<span class="builtintype" id="5875638">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5875643">case</span>&nbsp;<span class="string" id="5875648">&#34;utf-8&#34;</span><span class="op" id="5875655">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5875659">return</span>&nbsp;<span class="builtintype" id="5875666">string</span><span class="op" id="5875672">(</span><span class="ident" id="5875673">dec</span><span class="op" id="5875676">)</span><span class="op" id="5875677">,</span>&nbsp;<span class="builtintype" id="5875679">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5875684">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="5875687">panic</span><span class="op" id="5875692">(</span><span class="string" id="5875693">&#34;unreachable&#34;</span><span class="op" id="5875706">)</span><br>
<span class="lineno">490</span><span class="op" id="5875708">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5875711">type</span>&nbsp;<span class="ident" id="5875716">qDecoder</span>&nbsp;<span class="keyword" id="5875725">struct</span>&nbsp;<span class="op" id="5875732">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5875735">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5875743">io</span><span class="op" id="5875745">.</span><span class="ident" id="5875746">Reader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5875754">scratch</span>&nbsp;<span class="op" id="5875762">[</span><span class="num" id="5875763">2</span><span class="op" id="5875764">]</span><span class="builtintype" id="5875765">byte</span><br>
<span class="lineno">495</span><span class="op" id="5875770">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5875773">func</span>&nbsp;<span class="op" id="5875778">(</span><span class="ident" id="5875779">qd</span>&nbsp;<span class="ident" id="5875782">qDecoder</span><span class="op" id="5875790">)</span>&nbsp;<span class="ident" id="5875792">Read</span><span class="op" id="5875796">(</span><span class="ident" id="5875797">p</span>&nbsp;<span class="op" id="5875799">[</span><span class="op" id="5875800">]</span><span class="builtintype" id="5875801">byte</span><span class="op" id="5875805">)</span>&nbsp;<span class="op" id="5875807">(</span><span class="ident" id="5875808">n</span>&nbsp;<span class="builtintype" id="5875810">int</span><span class="op" id="5875813">,</span>&nbsp;<span class="ident" id="5875815">err</span>&nbsp;<span class="builtintype" id="5875819">error</span><span class="op" id="5875824">)</span>&nbsp;<span class="op" id="5875826">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5875829">//&nbsp;This&nbsp;method&nbsp;writes&nbsp;at&nbsp;most&nbsp;one&nbsp;byte&nbsp;into&nbsp;p.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5875877">if</span>&nbsp;<span class="builtinfunc" id="5875880">len</span><span class="op" id="5875883">(</span><span class="ident" id="5875884">p</span><span class="op" id="5875885">)</span>&nbsp;<span class="op" id="5875887">==</span>&nbsp;<span class="num" id="5875890">0</span>&nbsp;<span class="op" id="5875892">{</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5875896">return</span>&nbsp;<span class="num" id="5875903">0</span><span class="op" id="5875904">,</span>&nbsp;<span class="builtintype" id="5875906">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5875911">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5875914">if</span>&nbsp;<span class="ident" id="5875917">_</span><span class="op" id="5875918">,</span>&nbsp;<span class="ident" id="5875920">err</span>&nbsp;<span class="op" id="5875924">:=</span>&nbsp;<span class="ident" id="5875927">qd</span><span class="op" id="5875929">.</span><span class="ident" id="5875930">r</span><span class="op" id="5875931">.</span><span class="ident" id="5875932">Read</span><span class="op" id="5875936">(</span><span class="ident" id="5875937">qd</span><span class="op" id="5875939">.</span><span class="ident" id="5875940">scratch</span><span class="op" id="5875947">[</span><span class="op" id="5875948">:</span><span class="num" id="5875949">1</span><span class="op" id="5875950">]</span><span class="op" id="5875951">)</span><span class="op" id="5875952">;</span>&nbsp;<span class="ident" id="5875954">err</span>&nbsp;<span class="op" id="5875958">!=</span>&nbsp;<span class="builtintype" id="5875961">nil</span>&nbsp;<span class="op" id="5875965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5875969">return</span>&nbsp;<span class="num" id="5875976">0</span><span class="op" id="5875977">,</span>&nbsp;<span class="ident" id="5875979">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5875984">}</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5875987">switch</span>&nbsp;<span class="ident" id="5875994">c</span>&nbsp;<span class="op" id="5875996">:=</span>&nbsp;<span class="ident" id="5875999">qd</span><span class="op" id="5876001">.</span><span class="ident" id="5876002">scratch</span><span class="op" id="5876009">[</span><span class="num" id="5876010">0</span><span class="op" id="5876011">]</span><span class="op" id="5876012">;</span>&nbsp;<span class="op" id="5876014">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5876017">case</span>&nbsp;<span class="ident" id="5876022">c</span>&nbsp;<span class="op" id="5876024">==</span>&nbsp;<span class="string" id="5876027">&#39;=&#39;</span><span class="op" id="5876030">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5876034">if</span>&nbsp;<span class="ident" id="5876037">_</span><span class="op" id="5876038">,</span>&nbsp;<span class="ident" id="5876040">err</span>&nbsp;<span class="op" id="5876044">:=</span>&nbsp;<span class="ident" id="5876047">io</span><span class="op" id="5876049">.</span><span class="ident" id="5876050">ReadFull</span><span class="op" id="5876058">(</span><span class="ident" id="5876059">qd</span><span class="op" id="5876061">.</span><span class="ident" id="5876062">r</span><span class="op" id="5876063">,</span>&nbsp;<span class="ident" id="5876065">qd</span><span class="op" id="5876067">.</span><span class="ident" id="5876068">scratch</span><span class="op" id="5876075">[</span><span class="op" id="5876076">:</span><span class="num" id="5876077">2</span><span class="op" id="5876078">]</span><span class="op" id="5876079">)</span><span class="op" id="5876080">;</span>&nbsp;<span class="ident" id="5876082">err</span>&nbsp;<span class="op" id="5876086">!=</span>&nbsp;<span class="builtintype" id="5876089">nil</span>&nbsp;<span class="op" id="5876093">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5876098">return</span>&nbsp;<span class="num" id="5876105">0</span><span class="op" id="5876106">,</span>&nbsp;<span class="ident" id="5876108">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5876114">}</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5876118">x</span><span class="op" id="5876119">,</span>&nbsp;<span class="ident" id="5876121">err</span>&nbsp;<span class="op" id="5876125">:=</span>&nbsp;<span class="ident" id="5876128">strconv</span><span class="op" id="5876135">.</span><span class="ident" id="5876136">ParseInt</span><span class="op" id="5876144">(</span><span class="builtintype" id="5876145">string</span><span class="op" id="5876151">(</span><span class="ident" id="5876152">qd</span><span class="op" id="5876154">.</span><span class="ident" id="5876155">scratch</span><span class="op" id="5876162">[</span><span class="op" id="5876163">:</span><span class="num" id="5876164">2</span><span class="op" id="5876165">]</span><span class="op" id="5876166">)</span><span class="op" id="5876167">,</span>&nbsp;<span class="num" id="5876169">16</span><span class="op" id="5876171">,</span>&nbsp;<span class="num" id="5876173">64</span><span class="op" id="5876175">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5876179">if</span>&nbsp;<span class="ident" id="5876182">err</span>&nbsp;<span class="op" id="5876186">!=</span>&nbsp;<span class="builtintype" id="5876189">nil</span>&nbsp;<span class="op" id="5876193">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5876198">return</span>&nbsp;<span class="num" id="5876205">0</span><span class="op" id="5876206">,</span>&nbsp;<span class="ident" id="5876208">fmt</span><span class="op" id="5876211">.</span><span class="ident" id="5876212">Errorf</span><span class="op" id="5876218">(</span><span class="string" id="5876219">&#34;mail:&nbsp;invalid&nbsp;RFC&nbsp;2047&nbsp;encoding:&nbsp;%q&#34;</span><span class="op" id="5876256">,</span>&nbsp;<span class="ident" id="5876258">qd</span><span class="op" id="5876260">.</span><span class="ident" id="5876261">scratch</span><span class="op" id="5876268">[</span><span class="op" id="5876269">:</span><span class="num" id="5876270">2</span><span class="op" id="5876271">]</span><span class="op" id="5876272">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5876276">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5876280">p</span><span class="op" id="5876281">[</span><span class="num" id="5876282">0</span><span class="op" id="5876283">]</span>&nbsp;<span class="op" id="5876285">=</span>&nbsp;<span class="builtintype" id="5876287">byte</span><span class="op" id="5876291">(</span><span class="ident" id="5876292">x</span><span class="op" id="5876293">)</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5876296">case</span>&nbsp;<span class="ident" id="5876301">c</span>&nbsp;<span class="op" id="5876303">==</span>&nbsp;<span class="string" id="5876306">&#39;_&#39;</span><span class="op" id="5876309">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5876313">p</span><span class="op" id="5876314">[</span><span class="num" id="5876315">0</span><span class="op" id="5876316">]</span>&nbsp;<span class="op" id="5876318">=</span>&nbsp;<span class="string" id="5876320">&#39;&nbsp;&#39;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5876325">default</span><span class="op" id="5876332">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5876336">p</span><span class="op" id="5876337">[</span><span class="num" id="5876338">0</span><span class="op" id="5876339">]</span>&nbsp;<span class="op" id="5876341">=</span>&nbsp;<span class="ident" id="5876343">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5876346">}</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5876349">return</span>&nbsp;<span class="num" id="5876356">1</span><span class="op" id="5876357">,</span>&nbsp;<span class="builtintype" id="5876359">nil</span><br>
<span class="lineno"></span><span class="op" id="5876363">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5876366">var</span>&nbsp;<span class="ident" id="5876370">atextChars</span>&nbsp;<span class="op" id="5876381">=</span>&nbsp;<span class="op" id="5876383">[</span><span class="op" id="5876384">]</span><span class="builtintype" id="5876385">byte</span><span class="op" id="5876389">(</span><span class="string" id="5876390">&#34;ABCDEFGHIJKLMNOPQRSTUVWXYZ&#34;</span>&nbsp;<span class="op" id="5876419">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5876422">&#34;abcdefghijklmnopqrstuvwxyz&#34;</span>&nbsp;<span class="op" id="5876451">+</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5876454">&#34;0123456789&#34;</span>&nbsp;<span class="op" id="5876467">+</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="5876470">&#34;!#$%&amp;&#39;*+-/=?^_`{|}~&#34;</span><span class="op" id="5876491">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5876494">//&nbsp;isAtext&nbsp;returns&nbsp;true&nbsp;if&nbsp;c&nbsp;is&nbsp;an&nbsp;RFC&nbsp;5322&nbsp;atext&nbsp;character.</span><br>
<span class="lineno"></span><span class="comment" id="5876555">//&nbsp;If&nbsp;dot&nbsp;is&nbsp;true,&nbsp;period&nbsp;is&nbsp;included.</span><br>
<span class="lineno">530</span><span class="keyword" id="5876594">func</span>&nbsp;<span class="ident" id="5876599">isAtext</span><span class="op" id="5876606">(</span><span class="ident" id="5876607">c</span>&nbsp;<span class="builtintype" id="5876609">byte</span><span class="op" id="5876613">,</span>&nbsp;<span class="ident" id="5876615">dot</span>&nbsp;<span class="builtintype" id="5876619">bool</span><span class="op" id="5876623">)</span>&nbsp;<span class="builtintype" id="5876625">bool</span>&nbsp;<span class="op" id="5876630">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5876633">if</span>&nbsp;<span class="ident" id="5876636">dot</span>&nbsp;<span class="op" id="5876640">&amp;&amp;</span>&nbsp;<span class="ident" id="5876643">c</span>&nbsp;<span class="op" id="5876645">==</span>&nbsp;<span class="string" id="5876648">&#39;.&#39;</span>&nbsp;<span class="op" id="5876652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5876656">return</span>&nbsp;<span class="builtintype" id="5876663">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5876669">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5876672">return</span>&nbsp;<span class="ident" id="5876679">bytes</span><span class="op" id="5876684">.</span><span class="ident" id="5876685">IndexByte</span><span class="op" id="5876694">(</span><span class="ident" id="5876695">atextChars</span><span class="op" id="5876705">,</span>&nbsp;<span class="ident" id="5876707">c</span><span class="op" id="5876708">)</span>&nbsp;<span class="op" id="5876710">&gt;=</span>&nbsp;<span class="num" id="5876713">0</span><br>
<span class="lineno">535</span><span class="op" id="5876715">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5876718">//&nbsp;isQtext&nbsp;returns&nbsp;true&nbsp;if&nbsp;c&nbsp;is&nbsp;an&nbsp;RFC&nbsp;5322&nbsp;qtext&nbsp;character.</span><br>
<span class="lineno"></span><span class="keyword" id="5876779">func</span>&nbsp;<span class="ident" id="5876784">isQtext</span><span class="op" id="5876791">(</span><span class="ident" id="5876792">c</span>&nbsp;<span class="builtintype" id="5876794">byte</span><span class="op" id="5876798">)</span>&nbsp;<span class="builtintype" id="5876800">bool</span>&nbsp;<span class="op" id="5876805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5876808">//&nbsp;Printable&nbsp;US-ASCII,&nbsp;excluding&nbsp;backslash&nbsp;or&nbsp;quote.</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5876862">if</span>&nbsp;<span class="ident" id="5876865">c</span>&nbsp;<span class="op" id="5876867">==</span>&nbsp;<span class="string" id="5876870">&#39;\\&#39;</span>&nbsp;<span class="op" id="5876875">||</span>&nbsp;<span class="ident" id="5876878">c</span>&nbsp;<span class="op" id="5876880">==</span>&nbsp;<span class="string" id="5876883">&#39;&#34;&#39;</span>&nbsp;<span class="op" id="5876887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5876891">return</span>&nbsp;<span class="builtintype" id="5876898">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5876905">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5876908">return</span>&nbsp;<span class="string" id="5876915">&#39;!&#39;</span>&nbsp;<span class="op" id="5876919">&lt;=</span>&nbsp;<span class="ident" id="5876922">c</span>&nbsp;<span class="op" id="5876924">&amp;&amp;</span>&nbsp;<span class="ident" id="5876927">c</span>&nbsp;<span class="op" id="5876929">&lt;=</span>&nbsp;<span class="string" id="5876932">&#39;~&#39;</span><br>
<span class="lineno"></span><span class="op" id="5876936">}</span><br>
<span class="lineno">545</span><br>
<span class="lineno"></span><span class="comment" id="5876939">//&nbsp;isVchar&nbsp;returns&nbsp;true&nbsp;if&nbsp;c&nbsp;is&nbsp;an&nbsp;RFC&nbsp;5322&nbsp;VCHAR&nbsp;character.</span><br>
<span class="lineno"></span><span class="keyword" id="5877000">func</span>&nbsp;<span class="ident" id="5877005">isVchar</span><span class="op" id="5877012">(</span><span class="ident" id="5877013">c</span>&nbsp;<span class="builtintype" id="5877015">byte</span><span class="op" id="5877019">)</span>&nbsp;<span class="builtintype" id="5877021">bool</span>&nbsp;<span class="op" id="5877026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5877029">//&nbsp;Visible&nbsp;(printing)&nbsp;characters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5877064">return</span>&nbsp;<span class="string" id="5877071">&#39;!&#39;</span>&nbsp;<span class="op" id="5877075">&lt;=</span>&nbsp;<span class="ident" id="5877078">c</span>&nbsp;<span class="op" id="5877080">&amp;&amp;</span>&nbsp;<span class="ident" id="5877083">c</span>&nbsp;<span class="op" id="5877085">&lt;=</span>&nbsp;<span class="string" id="5877088">&#39;~&#39;</span><br>
<span class="lineno">550</span><span class="op" id="5877092">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5877095">//&nbsp;isWSP&nbsp;returns&nbsp;true&nbsp;if&nbsp;c&nbsp;is&nbsp;a&nbsp;WSP&nbsp;(white&nbsp;space).</span><br>
<span class="lineno"></span><span class="comment" id="5877146">//&nbsp;WSP&nbsp;is&nbsp;a&nbsp;space&nbsp;or&nbsp;horizontal&nbsp;tab&nbsp;(RFC5234&nbsp;Appendix&nbsp;B).</span><br>
<span class="lineno"></span><span class="keyword" id="5877204">func</span>&nbsp;<span class="ident" id="5877209">isWSP</span><span class="op" id="5877214">(</span><span class="ident" id="5877215">c</span>&nbsp;<span class="builtintype" id="5877217">byte</span><span class="op" id="5877221">)</span>&nbsp;<span class="builtintype" id="5877223">bool</span>&nbsp;<span class="op" id="5877228">{</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5877231">return</span>&nbsp;<span class="ident" id="5877238">c</span>&nbsp;<span class="op" id="5877240">==</span>&nbsp;<span class="string" id="5877243">&#39;&nbsp;&#39;</span>&nbsp;<span class="op" id="5877247">||</span>&nbsp;<span class="ident" id="5877250">c</span>&nbsp;<span class="op" id="5877252">==</span>&nbsp;<span class="string" id="5877255">&#39;\t&#39;</span><br>
<span class="lineno"></span><span class="op" id="5877260">}</span>
</div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-19116218-3', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
