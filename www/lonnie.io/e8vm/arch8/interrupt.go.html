<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="keyword" id="4869183">package</span>&nbsp;<span class="ident" id="4869191">arch8</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4869198">//&nbsp;Interrupt&nbsp;defines&nbsp;the&nbsp;interrupt&nbsp;page</span><br>
<span class="lineno"></span><span class="keyword" id="4869238">type</span>&nbsp;<span class="ident" id="4869243">interrupt</span>&nbsp;<span class="keyword" id="4869253">struct</span>&nbsp;<span class="op" id="4869260">{</span><br>
<span class="lineno">5</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4869263">p</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4869268">*</span><span class="ident" id="4869269">page</span>&nbsp;&nbsp;<span class="comment" id="4869275">//&nbsp;the&nbsp;dma&nbsp;page&nbsp;for&nbsp;interrupt&nbsp;handler</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4869314">base</span>&nbsp;<span class="builtintype" id="4869319">uint32</span>&nbsp;<span class="comment" id="4869326">//&nbsp;dma&nbsp;offset</span><br>
<span class="lineno"></span><span class="op" id="4869340">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4869343">//&nbsp;Number&nbsp;of&nbsp;interrupts</span><br>
<span class="lineno">10</span><span class="keyword" id="4869367">const</span>&nbsp;<span class="ident" id="4869373">Ninterrupt</span>&nbsp;<span class="op" id="4869384">=</span>&nbsp;<span class="num" id="4869386">256</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4869391">const</span>&nbsp;<span class="op" id="4869397">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4869400">intFlags</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4869413">=</span>&nbsp;<span class="num" id="4869415">0</span>&nbsp;&nbsp;<span class="comment" id="4869418">//&nbsp;flags,&nbsp;bit&nbsp;0&nbsp;is&nbsp;master&nbsp;enabling&nbsp;switch</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4869461">intKernelSP</span>&nbsp;&nbsp;<span class="op" id="4869474">=</span>&nbsp;<span class="num" id="4869476">4</span>&nbsp;&nbsp;<span class="comment" id="4869479">//&nbsp;position&nbsp;of&nbsp;the&nbsp;handler&nbsp;stack&nbsp;base&nbsp;pointer</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4869526">intHandlerPC</span>&nbsp;<span class="op" id="4869539">=</span>&nbsp;<span class="num" id="4869541">8</span>&nbsp;&nbsp;<span class="comment" id="4869544">//&nbsp;position&nbsp;of&nbsp;the&nbsp;handler&nbsp;start&nbsp;PC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4869581">intSyscallPC</span>&nbsp;<span class="op" id="4869594">=</span>&nbsp;<span class="num" id="4869596">12</span>&nbsp;<span class="comment" id="4869599">//&nbsp;position&nbsp;of&nbsp;the&nbsp;syscall&nbsp;start&nbsp;PC</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4869636">intMask</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4869649">=</span>&nbsp;<span class="num" id="4869651">32</span>&nbsp;<span class="comment" id="4869654">//&nbsp;interrupt&nbsp;enable&nbsp;mask&nbsp;bits&nbsp;offset&nbsp;(32&nbsp;bytes)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4869703">intPending</span>&nbsp;&nbsp;&nbsp;<span class="op" id="4869716">=</span>&nbsp;<span class="num" id="4869718">64</span>&nbsp;<span class="comment" id="4869721">//&nbsp;interrupt&nbsp;pending&nbsp;bits&nbsp;offset&nbsp;(32&nbsp;bytes)</span><br>
<span class="lineno"></span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4869767">intCtrlSize</span>&nbsp;<span class="op" id="4869779">=</span>&nbsp;<span class="num" id="4869781">128</span><br>
<span class="lineno"></span><span class="op" id="4869785">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4869788">//&nbsp;NewInterrupt&nbsp;creates&nbsp;a&nbsp;interrupt&nbsp;on&nbsp;the&nbsp;given&nbsp;DMA&nbsp;page.</span><br>
<span class="lineno"></span><span class="keyword" id="4869847">func</span>&nbsp;<span class="ident" id="4869852">newInterrupt</span><span class="op" id="4869864">(</span><span class="ident" id="4869865">p</span>&nbsp;<span class="op" id="4869867">*</span><span class="ident" id="4869868">page</span><span class="op" id="4869872">,</span>&nbsp;<span class="ident" id="4869874">core</span>&nbsp;<span class="builtintype" id="4869879">byte</span><span class="op" id="4869883">)</span>&nbsp;<span class="op" id="4869885">*</span><span class="ident" id="4869886">interrupt</span>&nbsp;<span class="op" id="4869896">{</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4869899">ret</span>&nbsp;<span class="op" id="4869903">:=</span>&nbsp;<span class="builtinfunc" id="4869906">new</span><span class="op" id="4869909">(</span><span class="ident" id="4869910">interrupt</span><span class="op" id="4869919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4869922">ret</span><span class="op" id="4869925">.</span><span class="ident" id="4869926">p</span>&nbsp;<span class="op" id="4869928">=</span>&nbsp;<span class="ident" id="4869930">p</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4869933">ret</span><span class="op" id="4869936">.</span><span class="ident" id="4869937">base</span>&nbsp;<span class="op" id="4869942">=</span>&nbsp;<span class="builtintype" id="4869944">uint32</span><span class="op" id="4869950">(</span><span class="ident" id="4869951">core</span><span class="op" id="4869955">)</span>&nbsp;<span class="op" id="4869957">*</span>&nbsp;<span class="ident" id="4869959">intCtrlSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4869972">if</span>&nbsp;<span class="ident" id="4869975">ret</span><span class="op" id="4869978">.</span><span class="ident" id="4869979">base</span><span class="op" id="4869983">+</span><span class="ident" id="4869984">intCtrlSize</span>&nbsp;<span class="op" id="4869996">&gt;</span>&nbsp;<span class="ident" id="4869998">PageSize</span>&nbsp;<span class="op" id="4870007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4870011">panic</span><span class="op" id="4870016">(</span><span class="string" id="4870017">&#34;bug&#34;</span><span class="op" id="4870022">)</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4870025">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4870029">return</span>&nbsp;<span class="ident" id="4870036">ret</span><br>
<span class="lineno"></span><span class="op" id="4870040">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">35</span><span class="keyword" id="4870043">func</span>&nbsp;<span class="op" id="4870048">(</span><span class="ident" id="4870049">in</span>&nbsp;<span class="op" id="4870052">*</span><span class="ident" id="4870053">interrupt</span><span class="op" id="4870062">)</span>&nbsp;<span class="ident" id="4870064">readWord</span><span class="op" id="4870072">(</span><span class="ident" id="4870073">off</span>&nbsp;<span class="builtintype" id="4870077">uint32</span><span class="op" id="4870083">)</span>&nbsp;<span class="builtintype" id="4870085">uint32</span>&nbsp;<span class="op" id="4870092">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4870095">return</span>&nbsp;<span class="ident" id="4870102">in</span><span class="op" id="4870104">.</span><span class="ident" id="4870105">p</span><span class="op" id="4870106">.</span><span class="ident" id="4870107">ReadWord</span><span class="op" id="4870115">(</span><span class="ident" id="4870116">in</span><span class="op" id="4870118">.</span><span class="ident" id="4870119">base</span>&nbsp;<span class="op" id="4870124">+</span>&nbsp;<span class="ident" id="4870126">off</span><span class="op" id="4870129">)</span><br>
<span class="lineno"></span><span class="op" id="4870131">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4870134">func</span>&nbsp;<span class="op" id="4870139">(</span><span class="ident" id="4870140">in</span>&nbsp;<span class="op" id="4870143">*</span><span class="ident" id="4870144">interrupt</span><span class="op" id="4870153">)</span>&nbsp;<span class="ident" id="4870155">readByte</span><span class="op" id="4870163">(</span><span class="ident" id="4870164">off</span>&nbsp;<span class="builtintype" id="4870168">uint32</span><span class="op" id="4870174">)</span>&nbsp;<span class="builtintype" id="4870176">byte</span>&nbsp;<span class="op" id="4870181">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4870184">return</span>&nbsp;<span class="ident" id="4870191">in</span><span class="op" id="4870193">.</span><span class="ident" id="4870194">p</span><span class="op" id="4870195">.</span><span class="ident" id="4870196">ReadByte</span><span class="op" id="4870204">(</span><span class="ident" id="4870205">in</span><span class="op" id="4870207">.</span><span class="ident" id="4870208">base</span>&nbsp;<span class="op" id="4870213">+</span>&nbsp;<span class="ident" id="4870215">off</span><span class="op" id="4870218">)</span><br>
<span class="lineno"></span><span class="op" id="4870220">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4870223">func</span>&nbsp;<span class="op" id="4870228">(</span><span class="ident" id="4870229">in</span>&nbsp;<span class="op" id="4870232">*</span><span class="ident" id="4870233">interrupt</span><span class="op" id="4870242">)</span>&nbsp;<span class="ident" id="4870244">writeWord</span><span class="op" id="4870253">(</span><span class="ident" id="4870254">off</span>&nbsp;<span class="builtintype" id="4870258">uint32</span><span class="op" id="4870264">,</span>&nbsp;<span class="ident" id="4870266">v</span>&nbsp;<span class="builtintype" id="4870268">uint32</span><span class="op" id="4870274">)</span>&nbsp;<span class="op" id="4870276">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4870279">in</span><span class="op" id="4870281">.</span><span class="ident" id="4870282">p</span><span class="op" id="4870283">.</span><span class="ident" id="4870284">WriteWord</span><span class="op" id="4870293">(</span><span class="ident" id="4870294">in</span><span class="op" id="4870296">.</span><span class="ident" id="4870297">base</span><span class="op" id="4870301">+</span><span class="ident" id="4870302">off</span><span class="op" id="4870305">,</span>&nbsp;<span class="ident" id="4870307">v</span><span class="op" id="4870308">)</span><br>
<span class="lineno">45</span><span class="op" id="4870310">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4870313">func</span>&nbsp;<span class="op" id="4870318">(</span><span class="ident" id="4870319">in</span>&nbsp;<span class="op" id="4870322">*</span><span class="ident" id="4870323">interrupt</span><span class="op" id="4870332">)</span>&nbsp;<span class="ident" id="4870334">writeByte</span><span class="op" id="4870343">(</span><span class="ident" id="4870344">off</span>&nbsp;<span class="builtintype" id="4870348">uint32</span><span class="op" id="4870354">,</span>&nbsp;<span class="ident" id="4870356">v</span>&nbsp;<span class="builtintype" id="4870358">byte</span><span class="op" id="4870362">)</span>&nbsp;<span class="op" id="4870364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4870367">in</span><span class="op" id="4870369">.</span><span class="ident" id="4870370">p</span><span class="op" id="4870371">.</span><span class="ident" id="4870372">WriteByte</span><span class="op" id="4870381">(</span><span class="ident" id="4870382">in</span><span class="op" id="4870384">.</span><span class="ident" id="4870385">base</span><span class="op" id="4870389">+</span><span class="ident" id="4870390">off</span><span class="op" id="4870393">,</span>&nbsp;<span class="ident" id="4870395">v</span><span class="op" id="4870396">)</span><br>
<span class="lineno"></span><span class="op" id="4870398">}</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="keyword" id="4870401">func</span>&nbsp;<span class="op" id="4870406">(</span><span class="ident" id="4870407">in</span>&nbsp;<span class="op" id="4870410">*</span><span class="ident" id="4870411">interrupt</span><span class="op" id="4870420">)</span>&nbsp;<span class="ident" id="4870422">kernelSP</span><span class="op" id="4870430">(</span><span class="op" id="4870431">)</span>&nbsp;<span class="builtintype" id="4870433">uint32</span>&nbsp;<span class="op" id="4870440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4870443">return</span>&nbsp;<span class="ident" id="4870450">in</span><span class="op" id="4870452">.</span><span class="ident" id="4870453">readWord</span><span class="op" id="4870461">(</span><span class="ident" id="4870462">intKernelSP</span><span class="op" id="4870473">)</span><br>
<span class="lineno"></span><span class="op" id="4870475">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="keyword" id="4870478">func</span>&nbsp;<span class="op" id="4870483">(</span><span class="ident" id="4870484">in</span>&nbsp;<span class="op" id="4870487">*</span><span class="ident" id="4870488">interrupt</span><span class="op" id="4870497">)</span>&nbsp;<span class="ident" id="4870499">handlerPC</span><span class="op" id="4870508">(</span><span class="op" id="4870509">)</span>&nbsp;<span class="builtintype" id="4870511">uint32</span>&nbsp;<span class="op" id="4870518">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4870521">return</span>&nbsp;<span class="ident" id="4870528">in</span><span class="op" id="4870530">.</span><span class="ident" id="4870531">readWord</span><span class="op" id="4870539">(</span><span class="ident" id="4870540">intHandlerPC</span><span class="op" id="4870552">)</span><br>
<span class="lineno"></span><span class="op" id="4870554">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4870557">func</span>&nbsp;<span class="op" id="4870562">(</span><span class="ident" id="4870563">in</span>&nbsp;<span class="op" id="4870566">*</span><span class="ident" id="4870567">interrupt</span><span class="op" id="4870576">)</span>&nbsp;<span class="ident" id="4870578">syscallPC</span><span class="op" id="4870587">(</span><span class="op" id="4870588">)</span>&nbsp;<span class="builtintype" id="4870590">uint32</span>&nbsp;<span class="op" id="4870597">{</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4870600">return</span>&nbsp;<span class="ident" id="4870607">in</span><span class="op" id="4870609">.</span><span class="ident" id="4870610">readWord</span><span class="op" id="4870618">(</span><span class="ident" id="4870619">intSyscallPC</span><span class="op" id="4870631">)</span><br>
<span class="lineno"></span><span class="op" id="4870633">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4870636">//&nbsp;Issue&nbsp;issues&nbsp;an&nbsp;interrupt.&nbsp;If&nbsp;the&nbsp;interrupt&nbsp;is&nbsp;already&nbsp;issued,</span><br>
<span class="lineno"></span><span class="comment" id="4870702">//&nbsp;this&nbsp;has&nbsp;no&nbsp;effect.</span><br>
<span class="lineno">65</span><span class="keyword" id="4870725">func</span>&nbsp;<span class="op" id="4870730">(</span><span class="ident" id="4870731">in</span>&nbsp;<span class="op" id="4870734">*</span><span class="ident" id="4870735">interrupt</span><span class="op" id="4870744">)</span>&nbsp;<span class="ident" id="4870746">Issue</span><span class="op" id="4870751">(</span><span class="ident" id="4870752">i</span>&nbsp;<span class="builtintype" id="4870754">byte</span><span class="op" id="4870758">)</span>&nbsp;<span class="op" id="4870760">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4870763">off</span>&nbsp;<span class="op" id="4870767">:=</span>&nbsp;<span class="builtintype" id="4870770">uint32</span><span class="op" id="4870776">(</span><span class="ident" id="4870777">i</span><span class="op" id="4870778">/</span><span class="num" id="4870779">8</span><span class="op" id="4870780">)</span>&nbsp;<span class="op" id="4870782">+</span>&nbsp;<span class="ident" id="4870784">intPending</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4870796">b</span>&nbsp;<span class="op" id="4870798">:=</span>&nbsp;<span class="ident" id="4870801">in</span><span class="op" id="4870803">.</span><span class="ident" id="4870804">readByte</span><span class="op" id="4870812">(</span><span class="ident" id="4870813">off</span><span class="op" id="4870816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4870819">b</span>&nbsp;<span class="op" id="4870821">|=</span>&nbsp;<span class="num" id="4870824">0x1</span>&nbsp;<span class="op" id="4870828">&lt;&lt;</span>&nbsp;<span class="op" id="4870831">(</span><span class="ident" id="4870832">i</span>&nbsp;<span class="op" id="4870834">%</span>&nbsp;<span class="num" id="4870836">8</span><span class="op" id="4870837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4870840">in</span><span class="op" id="4870842">.</span><span class="ident" id="4870843">writeByte</span><span class="op" id="4870852">(</span><span class="ident" id="4870853">off</span><span class="op" id="4870856">,</span>&nbsp;<span class="ident" id="4870858">b</span><span class="op" id="4870859">)</span><br>
<span class="lineno">70</span><span class="op" id="4870861">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4870864">//&nbsp;Clear&nbsp;clears&nbsp;an&nbsp;interrupt.&nbsp;If&nbsp;the&nbsp;interrupt&nbsp;is&nbsp;already&nbsp;cleared,</span><br>
<span class="lineno"></span><span class="comment" id="4870931">//&nbsp;this&nbsp;has&nbsp;no&nbsp;effect.</span><br>
<span class="lineno"></span><span class="keyword" id="4870954">func</span>&nbsp;<span class="op" id="4870959">(</span><span class="ident" id="4870960">in</span>&nbsp;<span class="op" id="4870963">*</span><span class="ident" id="4870964">interrupt</span><span class="op" id="4870973">)</span>&nbsp;<span class="ident" id="4870975">Clear</span><span class="op" id="4870980">(</span><span class="ident" id="4870981">i</span>&nbsp;<span class="builtintype" id="4870983">byte</span><span class="op" id="4870987">)</span>&nbsp;<span class="op" id="4870989">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4870992">off</span>&nbsp;<span class="op" id="4870996">:=</span>&nbsp;<span class="builtintype" id="4870999">uint32</span><span class="op" id="4871005">(</span><span class="ident" id="4871006">i</span><span class="op" id="4871007">/</span><span class="num" id="4871008">8</span><span class="op" id="4871009">)</span>&nbsp;<span class="op" id="4871011">+</span>&nbsp;<span class="ident" id="4871013">intPending</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4871025">b</span>&nbsp;<span class="op" id="4871027">:=</span>&nbsp;<span class="ident" id="4871030">in</span><span class="op" id="4871032">.</span><span class="ident" id="4871033">readByte</span><span class="op" id="4871041">(</span><span class="ident" id="4871042">off</span><span class="op" id="4871045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4871048">b</span>&nbsp;<span class="op" id="4871050">&amp;=</span>&nbsp;<span class="op" id="4871053">^</span><span class="op" id="4871054">(</span><span class="num" id="4871055">0x1</span>&nbsp;<span class="op" id="4871059">&lt;&lt;</span>&nbsp;<span class="op" id="4871062">(</span><span class="ident" id="4871063">i</span>&nbsp;<span class="op" id="4871065">%</span>&nbsp;<span class="num" id="4871067">8</span><span class="op" id="4871068">)</span><span class="op" id="4871069">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4871072">in</span><span class="op" id="4871074">.</span><span class="ident" id="4871075">writeByte</span><span class="op" id="4871084">(</span><span class="ident" id="4871085">off</span><span class="op" id="4871088">,</span>&nbsp;<span class="ident" id="4871090">b</span><span class="op" id="4871091">)</span><br>
<span class="lineno"></span><span class="op" id="4871093">}</span><br>
<span class="lineno">80</span><br>
<span class="lineno"></span><span class="comment" id="4871096">//&nbsp;Enable&nbsp;sets&nbsp;the&nbsp;interrupt&nbsp;enable&nbsp;bit&nbsp;in&nbsp;the&nbsp;flags.</span><br>
<span class="lineno"></span><span class="keyword" id="4871150">func</span>&nbsp;<span class="op" id="4871155">(</span><span class="ident" id="4871156">in</span>&nbsp;<span class="op" id="4871159">*</span><span class="ident" id="4871160">interrupt</span><span class="op" id="4871169">)</span>&nbsp;<span class="ident" id="4871171">Enable</span><span class="op" id="4871177">(</span><span class="op" id="4871178">)</span>&nbsp;<span class="op" id="4871180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4871183">b</span>&nbsp;<span class="op" id="4871185">:=</span>&nbsp;<span class="ident" id="4871188">in</span><span class="op" id="4871190">.</span><span class="ident" id="4871191">readByte</span><span class="op" id="4871199">(</span><span class="ident" id="4871200">intFlags</span><span class="op" id="4871208">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4871211">b</span>&nbsp;<span class="op" id="4871213">|=</span>&nbsp;<span class="num" id="4871216">0x1</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4871221">in</span><span class="op" id="4871223">.</span><span class="ident" id="4871224">writeByte</span><span class="op" id="4871233">(</span><span class="ident" id="4871234">intFlags</span><span class="op" id="4871242">,</span>&nbsp;<span class="ident" id="4871244">b</span><span class="op" id="4871245">)</span><br>
<span class="lineno"></span><span class="op" id="4871247">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4871250">//&nbsp;Enabled&nbsp;tests&nbsp;if&nbsp;interrupt&nbsp;is&nbsp;enabled</span><br>
<span class="lineno"></span><span class="keyword" id="4871291">func</span>&nbsp;<span class="op" id="4871296">(</span><span class="ident" id="4871297">in</span>&nbsp;<span class="op" id="4871300">*</span><span class="ident" id="4871301">interrupt</span><span class="op" id="4871310">)</span>&nbsp;<span class="ident" id="4871312">Enabled</span><span class="op" id="4871319">(</span><span class="op" id="4871320">)</span>&nbsp;<span class="builtintype" id="4871322">bool</span>&nbsp;<span class="op" id="4871327">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4871330">b</span>&nbsp;<span class="op" id="4871332">:=</span>&nbsp;<span class="ident" id="4871335">in</span><span class="op" id="4871337">.</span><span class="ident" id="4871338">readByte</span><span class="op" id="4871346">(</span><span class="ident" id="4871347">intFlags</span><span class="op" id="4871355">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4871358">return</span>&nbsp;<span class="op" id="4871365">(</span><span class="ident" id="4871366">b</span>&nbsp;<span class="op" id="4871368">&amp;</span>&nbsp;<span class="num" id="4871370">0x1</span><span class="op" id="4871373">)</span>&nbsp;<span class="op" id="4871375">!=</span>&nbsp;<span class="num" id="4871378">0</span><br>
<span class="lineno"></span><span class="op" id="4871380">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4871383">//&nbsp;Disable&nbsp;clears&nbsp;the&nbsp;interrupt&nbsp;enable&nbsp;bit&nbsp;in&nbsp;the&nbsp;flags.</span><br>
<span class="lineno">95</span><span class="keyword" id="4871440">func</span>&nbsp;<span class="op" id="4871445">(</span><span class="ident" id="4871446">in</span>&nbsp;<span class="op" id="4871449">*</span><span class="ident" id="4871450">interrupt</span><span class="op" id="4871459">)</span>&nbsp;<span class="ident" id="4871461">Disable</span><span class="op" id="4871468">(</span><span class="op" id="4871469">)</span>&nbsp;<span class="op" id="4871471">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4871474">b</span>&nbsp;<span class="op" id="4871476">:=</span>&nbsp;<span class="ident" id="4871479">in</span><span class="op" id="4871481">.</span><span class="ident" id="4871482">readByte</span><span class="op" id="4871490">(</span><span class="ident" id="4871491">intFlags</span><span class="op" id="4871499">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4871502">b</span>&nbsp;<span class="op" id="4871504">&amp;=</span>&nbsp;<span class="op" id="4871507">^</span><span class="builtintype" id="4871508">byte</span><span class="op" id="4871512">(</span><span class="num" id="4871513">0x1</span><span class="op" id="4871516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4871519">in</span><span class="op" id="4871521">.</span><span class="ident" id="4871522">writeByte</span><span class="op" id="4871531">(</span><span class="ident" id="4871532">intFlags</span><span class="op" id="4871540">,</span>&nbsp;<span class="ident" id="4871542">b</span><span class="op" id="4871543">)</span><br>
<span class="lineno"></span><span class="op" id="4871545">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span><span class="comment" id="4871548">//&nbsp;EnableInt&nbsp;enables&nbsp;a&nbsp;particular&nbsp;interrupt&nbsp;by&nbsp;clearing&nbsp;the&nbsp;mask.</span><br>
<span class="lineno"></span><span class="keyword" id="4871614">func</span>&nbsp;<span class="op" id="4871619">(</span><span class="ident" id="4871620">in</span>&nbsp;<span class="op" id="4871623">*</span><span class="ident" id="4871624">interrupt</span><span class="op" id="4871633">)</span>&nbsp;<span class="ident" id="4871635">EnableInt</span><span class="op" id="4871644">(</span><span class="ident" id="4871645">i</span>&nbsp;<span class="builtintype" id="4871647">byte</span><span class="op" id="4871651">)</span>&nbsp;<span class="op" id="4871653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4871656">off</span>&nbsp;<span class="op" id="4871660">:=</span>&nbsp;<span class="builtintype" id="4871663">uint32</span><span class="op" id="4871669">(</span><span class="ident" id="4871670">i</span><span class="op" id="4871671">/</span><span class="num" id="4871672">8</span><span class="op" id="4871673">)</span>&nbsp;<span class="op" id="4871675">+</span>&nbsp;<span class="ident" id="4871677">intMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4871686">b</span>&nbsp;<span class="op" id="4871688">:=</span>&nbsp;<span class="ident" id="4871691">in</span><span class="op" id="4871693">.</span><span class="ident" id="4871694">readByte</span><span class="op" id="4871702">(</span><span class="ident" id="4871703">off</span><span class="op" id="4871706">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4871709">b</span>&nbsp;<span class="op" id="4871711">|=</span>&nbsp;<span class="num" id="4871714">0x1</span>&nbsp;<span class="op" id="4871718">&lt;&lt;</span>&nbsp;<span class="op" id="4871721">(</span><span class="ident" id="4871722">i</span>&nbsp;<span class="op" id="4871724">%</span>&nbsp;<span class="num" id="4871726">8</span><span class="op" id="4871727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4871730">in</span><span class="op" id="4871732">.</span><span class="ident" id="4871733">writeByte</span><span class="op" id="4871742">(</span><span class="ident" id="4871743">off</span><span class="op" id="4871746">,</span>&nbsp;<span class="ident" id="4871748">b</span><span class="op" id="4871749">)</span><br>
<span class="lineno"></span><span class="op" id="4871751">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4871754">//&nbsp;DisableInt&nbsp;disables&nbsp;a&nbsp;particular&nbsp;interrupt&nbsp;by&nbsp;setting&nbsp;the&nbsp;mask.</span><br>
<span class="lineno">110</span><span class="keyword" id="4871821">func</span>&nbsp;<span class="op" id="4871826">(</span><span class="ident" id="4871827">in</span>&nbsp;<span class="op" id="4871830">*</span><span class="ident" id="4871831">interrupt</span><span class="op" id="4871840">)</span>&nbsp;<span class="ident" id="4871842">DisableInt</span><span class="op" id="4871852">(</span><span class="ident" id="4871853">i</span>&nbsp;<span class="builtintype" id="4871855">byte</span><span class="op" id="4871859">)</span>&nbsp;<span class="op" id="4871861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4871864">off</span>&nbsp;<span class="op" id="4871868">:=</span>&nbsp;<span class="builtintype" id="4871871">uint32</span><span class="op" id="4871877">(</span><span class="ident" id="4871878">i</span><span class="op" id="4871879">/</span><span class="num" id="4871880">8</span><span class="op" id="4871881">)</span>&nbsp;<span class="op" id="4871883">+</span>&nbsp;<span class="ident" id="4871885">intMask</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4871894">b</span>&nbsp;<span class="op" id="4871896">:=</span>&nbsp;<span class="ident" id="4871899">in</span><span class="op" id="4871901">.</span><span class="ident" id="4871902">readByte</span><span class="op" id="4871910">(</span><span class="ident" id="4871911">off</span><span class="op" id="4871914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4871917">b</span>&nbsp;<span class="op" id="4871919">&amp;=</span>&nbsp;<span class="op" id="4871922">^</span><span class="op" id="4871923">(</span><span class="num" id="4871924">0x1</span>&nbsp;<span class="op" id="4871928">&lt;&lt;</span>&nbsp;<span class="op" id="4871931">(</span><span class="ident" id="4871932">i</span>&nbsp;<span class="op" id="4871934">%</span>&nbsp;<span class="num" id="4871936">8</span><span class="op" id="4871937">)</span><span class="op" id="4871938">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4871941">in</span><span class="op" id="4871943">.</span><span class="ident" id="4871944">writeByte</span><span class="op" id="4871953">(</span><span class="ident" id="4871954">off</span><span class="op" id="4871957">,</span>&nbsp;<span class="ident" id="4871959">b</span><span class="op" id="4871960">)</span><br>
<span class="lineno">115</span><span class="op" id="4871962">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4871965">//&nbsp;Flags&nbsp;returns&nbsp;the&nbsp;flags&nbsp;byte.</span><br>
<span class="lineno"></span><span class="keyword" id="4871998">func</span>&nbsp;<span class="op" id="4872003">(</span><span class="ident" id="4872004">in</span>&nbsp;<span class="op" id="4872007">*</span><span class="ident" id="4872008">interrupt</span><span class="op" id="4872017">)</span>&nbsp;<span class="ident" id="4872019">Flags</span><span class="op" id="4872024">(</span><span class="op" id="4872025">)</span>&nbsp;<span class="builtintype" id="4872027">byte</span>&nbsp;<span class="op" id="4872032">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4872035">return</span>&nbsp;<span class="ident" id="4872042">in</span><span class="op" id="4872044">.</span><span class="ident" id="4872045">readByte</span><span class="op" id="4872053">(</span><span class="ident" id="4872054">intFlags</span><span class="op" id="4872062">)</span><br>
<span class="lineno">120</span><span class="op" id="4872064">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4872067">//&nbsp;Poll&nbsp;looks&nbsp;for&nbsp;the&nbsp;next&nbsp;pending&nbsp;interrupt.</span><br>
<span class="lineno"></span><span class="keyword" id="4872113">func</span>&nbsp;<span class="op" id="4872118">(</span><span class="ident" id="4872119">in</span>&nbsp;<span class="op" id="4872122">*</span><span class="ident" id="4872123">interrupt</span><span class="op" id="4872132">)</span>&nbsp;<span class="ident" id="4872134">Poll</span><span class="op" id="4872138">(</span><span class="op" id="4872139">)</span>&nbsp;<span class="op" id="4872141">(</span><span class="builtintype" id="4872142">bool</span><span class="op" id="4872146">,</span>&nbsp;<span class="builtintype" id="4872148">byte</span><span class="op" id="4872152">)</span>&nbsp;<span class="op" id="4872154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4872157">flag</span>&nbsp;<span class="op" id="4872162">:=</span>&nbsp;<span class="ident" id="4872165">in</span><span class="op" id="4872167">.</span><span class="ident" id="4872168">Flags</span><span class="op" id="4872173">(</span><span class="op" id="4872174">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4872177">if</span>&nbsp;<span class="ident" id="4872180">flag</span><span class="op" id="4872184">&amp;</span><span class="num" id="4872185">0x1</span>&nbsp;<span class="op" id="4872189">==</span>&nbsp;<span class="num" id="4872192">0</span>&nbsp;<span class="op" id="4872194">{</span>&nbsp;<span class="comment" id="4872196">//&nbsp;interrupt&nbsp;is&nbsp;disabled</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4872223">return</span>&nbsp;<span class="ident" id="4872230">false</span><span class="op" id="4872235">,</span>&nbsp;<span class="num" id="4872237">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4872240">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4872244">//&nbsp;search&nbsp;bits&nbsp;based&nbsp;on&nbsp;priorities.</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4872281">//&nbsp;smaller&nbsp;is&nbsp;higher</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4872303">for</span>&nbsp;<span class="ident" id="4872307">i</span>&nbsp;<span class="op" id="4872309">:=</span>&nbsp;<span class="builtintype" id="4872312">uint32</span><span class="op" id="4872318">(</span><span class="num" id="4872319">0</span><span class="op" id="4872320">)</span><span class="op" id="4872321">;</span>&nbsp;<span class="ident" id="4872323">i</span>&nbsp;<span class="op" id="4872325">&lt;</span>&nbsp;<span class="ident" id="4872327">Ninterrupt</span><span class="op" id="4872337">/</span><span class="num" id="4872338">8</span><span class="op" id="4872339">;</span>&nbsp;<span class="ident" id="4872341">i</span><span class="op" id="4872342">++</span>&nbsp;<span class="op" id="4872345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4872349">pending</span>&nbsp;<span class="op" id="4872357">:=</span>&nbsp;<span class="ident" id="4872360">in</span><span class="op" id="4872362">.</span><span class="ident" id="4872363">readByte</span><span class="op" id="4872371">(</span><span class="ident" id="4872372">intPending</span>&nbsp;<span class="op" id="4872383">+</span>&nbsp;<span class="ident" id="4872385">i</span><span class="op" id="4872386">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4872390">mask</span>&nbsp;<span class="op" id="4872395">:=</span>&nbsp;<span class="ident" id="4872398">in</span><span class="op" id="4872400">.</span><span class="ident" id="4872401">readByte</span><span class="op" id="4872409">(</span><span class="ident" id="4872410">intMask</span>&nbsp;<span class="op" id="4872418">+</span>&nbsp;<span class="ident" id="4872420">i</span><span class="op" id="4872421">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4872425">pending</span>&nbsp;<span class="op" id="4872433">&amp;=</span>&nbsp;<span class="ident" id="4872436">mask</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4872443">if</span>&nbsp;<span class="ident" id="4872446">pending</span>&nbsp;<span class="op" id="4872454">==</span>&nbsp;<span class="num" id="4872457">0</span>&nbsp;<span class="op" id="4872459">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4872464">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4872475">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4872480">for</span>&nbsp;<span class="ident" id="4872484">b</span>&nbsp;<span class="op" id="4872486">:=</span>&nbsp;<span class="builtintype" id="4872489">byte</span><span class="op" id="4872493">(</span><span class="num" id="4872494">0</span><span class="op" id="4872495">)</span><span class="op" id="4872496">;</span>&nbsp;<span class="ident" id="4872498">b</span>&nbsp;<span class="op" id="4872500">&lt;</span>&nbsp;<span class="num" id="4872502">8</span><span class="op" id="4872503">;</span>&nbsp;<span class="ident" id="4872505">b</span><span class="op" id="4872506">++</span>&nbsp;<span class="op" id="4872509">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4872514">if</span>&nbsp;<span class="ident" id="4872517">pending</span><span class="op" id="4872524">&amp;</span><span class="op" id="4872525">(</span><span class="num" id="4872526">0x1</span><span class="op" id="4872529">&lt;&lt;</span><span class="ident" id="4872531">b</span><span class="op" id="4872532">)</span>&nbsp;<span class="op" id="4872534">==</span>&nbsp;<span class="num" id="4872537">0</span>&nbsp;<span class="op" id="4872539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4872545">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4872557">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4872563">return</span>&nbsp;<span class="ident" id="4872570">true</span><span class="op" id="4872574">,</span>&nbsp;<span class="builtintype" id="4872576">byte</span><span class="op" id="4872580">(</span><span class="ident" id="4872581">i</span><span class="op" id="4872582">*</span><span class="num" id="4872583">8</span><span class="op" id="4872584">)</span>&nbsp;<span class="op" id="4872586">+</span>&nbsp;<span class="ident" id="4872588">b</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4872592">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4872595">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4872599">return</span>&nbsp;<span class="ident" id="4872606">false</span><span class="op" id="4872611">,</span>&nbsp;<span class="num" id="4872613">0</span><br>
<span class="lineno"></span><span class="op" id="4872615">}</span>
</div>
</body>
</html>
