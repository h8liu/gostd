<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>sync</h2>
<ul>
<li><a href="/gostd/sync/cond.go.html">cond.go</a></li>
<li><a href="/gostd/sync/cond_test.go.html">cond_test.go</a></li>
<li><a href="/gostd/sync/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/sync/export_test.go.html">export_test.go</a></li>
<li><a href="/gostd/sync/mutex.go.html">mutex.go</a></li>
<li><a href="/gostd/sync/mutex_test.go.html">mutex_test.go</a></li>
<li><a href="/gostd/sync/once.go.html">once.go</a></li>
<li><a href="/gostd/sync/once_test.go.html">once_test.go</a></li>
<li><a href="/gostd/sync/pool.go.html">pool.go</a></li>
<li><a href="/gostd/sync/pool_test.go.html">pool_test.go</a></li>
<li><a href="/gostd/sync/race0.go.html">race0.go</a></li>
<li><a href="/gostd/sync/runtime.go.html">runtime.go</a></li>
<li><a href="/gostd/sync/runtime_sema_test.go.html">runtime_sema_test.go</a></li>
<li><a href="/gostd/sync/rwmutex.go.html">rwmutex.go</a></li>
<li><a href="/gostd/sync/rwmutex_test.go.html">rwmutex_test.go</a></li>
<li><a href="/gostd/sync/waitgroup.go.html">waitgroup.go</a></li>
<li><a href="/gostd/sync/waitgroup_test.go.html">waitgroup_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="1377206">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="1377261">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="1377315">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="1377366">package</span>&nbsp;<span class="ident" id="1377374">sync</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1377380">import</span>&nbsp;<span class="op" id="1377387">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1377390">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="1377405">&#34;unsafe&#34;</span><br>
<span class="lineno">10</span><span class="op" id="1377414">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1377417">//&nbsp;An&nbsp;RWMutex&nbsp;is&nbsp;a&nbsp;reader/writer&nbsp;mutual&nbsp;exclusion&nbsp;lock.</span><br>
<span class="lineno"></span><span class="comment" id="1377473">//&nbsp;The&nbsp;lock&nbsp;can&nbsp;be&nbsp;held&nbsp;by&nbsp;an&nbsp;arbitrary&nbsp;number&nbsp;of&nbsp;readers</span><br>
<span class="lineno"></span><span class="comment" id="1377531">//&nbsp;or&nbsp;a&nbsp;single&nbsp;writer.</span><br>
<span class="lineno">15</span><span class="comment" id="1377554">//&nbsp;RWMutexes&nbsp;can&nbsp;be&nbsp;created&nbsp;as&nbsp;part&nbsp;of&nbsp;other</span><br>
<span class="lineno"></span><span class="comment" id="1377599">//&nbsp;structures;&nbsp;the&nbsp;zero&nbsp;value&nbsp;for&nbsp;a&nbsp;RWMutex&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1377646">//&nbsp;an&nbsp;unlocked&nbsp;mutex.</span><br>
<span class="lineno"></span><span class="keyword" id="1377668">type</span>&nbsp;<span class="ident" id="1377673">RWMutex</span>&nbsp;<span class="keyword" id="1377681">struct</span>&nbsp;<span class="op" id="1377688">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1377691">w</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="1377703">Mutex</span>&nbsp;&nbsp;<span class="comment" id="1377710">//&nbsp;held&nbsp;if&nbsp;there&nbsp;are&nbsp;pending&nbsp;writers</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1377748">writerSem</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1377760">uint32</span>&nbsp;<span class="comment" id="1377767">//&nbsp;semaphore&nbsp;for&nbsp;writers&nbsp;to&nbsp;wait&nbsp;for&nbsp;completing&nbsp;readers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1377824">readerSem</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="1377836">uint32</span>&nbsp;<span class="comment" id="1377843">//&nbsp;semaphore&nbsp;for&nbsp;readers&nbsp;to&nbsp;wait&nbsp;for&nbsp;completing&nbsp;writers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1377900">readerCount</span>&nbsp;<span class="builtintype" id="1377912">int32</span>&nbsp;&nbsp;<span class="comment" id="1377919">//&nbsp;number&nbsp;of&nbsp;pending&nbsp;readers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1377949">readerWait</span>&nbsp;&nbsp;<span class="builtintype" id="1377961">int32</span>&nbsp;&nbsp;<span class="comment" id="1377968">//&nbsp;number&nbsp;of&nbsp;departing&nbsp;readers</span><br>
<span class="lineno"></span><span class="op" id="1377999">}</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="1378002">const</span>&nbsp;<span class="ident" id="1378008">rwmutexMaxReaders</span>&nbsp;<span class="op" id="1378026">=</span>&nbsp;<span class="num" id="1378028">1</span>&nbsp;<span class="op" id="1378030">&lt;&lt;</span>&nbsp;<span class="num" id="1378033">30</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1378037">//&nbsp;RLock&nbsp;locks&nbsp;rw&nbsp;for&nbsp;reading.</span><br>
<span class="lineno"></span><span class="keyword" id="1378068">func</span>&nbsp;<span class="op" id="1378073">(</span><span class="ident" id="1378074">rw</span>&nbsp;<span class="op" id="1378077">*</span><span class="ident" id="1378078">RWMutex</span><span class="op" id="1378085">)</span>&nbsp;<span class="ident" id="1378087">RLock</span><span class="op" id="1378092">(</span><span class="op" id="1378093">)</span>&nbsp;<span class="op" id="1378095">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1378098">if</span>&nbsp;<span class="ident" id="1378101">raceenabled</span>&nbsp;<span class="op" id="1378113">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1378117">_</span>&nbsp;<span class="op" id="1378119">=</span>&nbsp;<span class="ident" id="1378121">rw</span><span class="op" id="1378123">.</span><span class="ident" id="1378124">w</span><span class="op" id="1378125">.</span><span class="ident" id="1378126">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1378134">raceDisable</span><span class="op" id="1378145">(</span><span class="op" id="1378146">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1378149">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1378152">if</span>&nbsp;<span class="ident" id="1378155">atomic</span><span class="op" id="1378161">.</span><span class="ident" id="1378162">AddInt32</span><span class="op" id="1378170">(</span><span class="op" id="1378171">&amp;</span><span class="ident" id="1378172">rw</span><span class="op" id="1378174">.</span><span class="ident" id="1378175">readerCount</span><span class="op" id="1378186">,</span>&nbsp;<span class="num" id="1378188">1</span><span class="op" id="1378189">)</span>&nbsp;<span class="op" id="1378191">&lt;</span>&nbsp;<span class="num" id="1378193">0</span>&nbsp;<span class="op" id="1378195">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1378199">//&nbsp;A&nbsp;writer&nbsp;is&nbsp;pending,&nbsp;wait&nbsp;for&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1378238">runtime_Semacquire</span><span class="op" id="1378256">(</span><span class="op" id="1378257">&amp;</span><span class="ident" id="1378258">rw</span><span class="op" id="1378260">.</span><span class="ident" id="1378261">readerSem</span><span class="op" id="1378270">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1378273">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1378276">if</span>&nbsp;<span class="ident" id="1378279">raceenabled</span>&nbsp;<span class="op" id="1378291">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1378295">raceEnable</span><span class="op" id="1378305">(</span><span class="op" id="1378306">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1378310">raceAcquire</span><span class="op" id="1378321">(</span><span class="ident" id="1378322">unsafe</span><span class="op" id="1378328">.</span><span class="ident" id="1378329">Pointer</span><span class="op" id="1378336">(</span><span class="op" id="1378337">&amp;</span><span class="ident" id="1378338">rw</span><span class="op" id="1378340">.</span><span class="ident" id="1378341">readerSem</span><span class="op" id="1378350">)</span><span class="op" id="1378351">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1378354">}</span><br>
<span class="lineno"></span><span class="op" id="1378356">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1378359">//&nbsp;RUnlock&nbsp;undoes&nbsp;a&nbsp;single&nbsp;RLock&nbsp;call;</span><br>
<span class="lineno">45</span><span class="comment" id="1378398">//&nbsp;it&nbsp;does&nbsp;not&nbsp;affect&nbsp;other&nbsp;simultaneous&nbsp;readers.</span><br>
<span class="lineno"></span><span class="comment" id="1378448">//&nbsp;It&nbsp;is&nbsp;a&nbsp;run-time&nbsp;error&nbsp;if&nbsp;rw&nbsp;is&nbsp;not&nbsp;locked&nbsp;for&nbsp;reading</span><br>
<span class="lineno"></span><span class="comment" id="1378506">//&nbsp;on&nbsp;entry&nbsp;to&nbsp;RUnlock.</span><br>
<span class="lineno"></span><span class="keyword" id="1378530">func</span>&nbsp;<span class="op" id="1378535">(</span><span class="ident" id="1378536">rw</span>&nbsp;<span class="op" id="1378539">*</span><span class="ident" id="1378540">RWMutex</span><span class="op" id="1378547">)</span>&nbsp;<span class="ident" id="1378549">RUnlock</span><span class="op" id="1378556">(</span><span class="op" id="1378557">)</span>&nbsp;<span class="op" id="1378559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1378562">if</span>&nbsp;<span class="ident" id="1378565">raceenabled</span>&nbsp;<span class="op" id="1378577">{</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1378581">_</span>&nbsp;<span class="op" id="1378583">=</span>&nbsp;<span class="ident" id="1378585">rw</span><span class="op" id="1378587">.</span><span class="ident" id="1378588">w</span><span class="op" id="1378589">.</span><span class="ident" id="1378590">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1378598">raceReleaseMerge</span><span class="op" id="1378614">(</span><span class="ident" id="1378615">unsafe</span><span class="op" id="1378621">.</span><span class="ident" id="1378622">Pointer</span><span class="op" id="1378629">(</span><span class="op" id="1378630">&amp;</span><span class="ident" id="1378631">rw</span><span class="op" id="1378633">.</span><span class="ident" id="1378634">writerSem</span><span class="op" id="1378643">)</span><span class="op" id="1378644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1378648">raceDisable</span><span class="op" id="1378659">(</span><span class="op" id="1378660">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1378663">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1378666">if</span>&nbsp;<span class="ident" id="1378669">r</span>&nbsp;<span class="op" id="1378671">:=</span>&nbsp;<span class="ident" id="1378674">atomic</span><span class="op" id="1378680">.</span><span class="ident" id="1378681">AddInt32</span><span class="op" id="1378689">(</span><span class="op" id="1378690">&amp;</span><span class="ident" id="1378691">rw</span><span class="op" id="1378693">.</span><span class="ident" id="1378694">readerCount</span><span class="op" id="1378705">,</span>&nbsp;<span class="op" id="1378707">-</span><span class="num" id="1378708">1</span><span class="op" id="1378709">)</span><span class="op" id="1378710">;</span>&nbsp;<span class="ident" id="1378712">r</span>&nbsp;<span class="op" id="1378714">&lt;</span>&nbsp;<span class="num" id="1378716">0</span>&nbsp;<span class="op" id="1378718">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1378722">if</span>&nbsp;<span class="ident" id="1378725">r</span><span class="op" id="1378726">+</span><span class="num" id="1378727">1</span>&nbsp;<span class="op" id="1378729">==</span>&nbsp;<span class="num" id="1378732">0</span>&nbsp;<span class="op" id="1378734">||</span>&nbsp;<span class="ident" id="1378737">r</span><span class="op" id="1378738">+</span><span class="num" id="1378739">1</span>&nbsp;<span class="op" id="1378741">==</span>&nbsp;<span class="op" id="1378744">-</span><span class="ident" id="1378745">rwmutexMaxReaders</span>&nbsp;<span class="op" id="1378763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1378768">raceEnable</span><span class="op" id="1378778">(</span><span class="op" id="1378779">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1378784">panic</span><span class="op" id="1378789">(</span><span class="string" id="1378790">&#34;sync:&nbsp;RUnlock&nbsp;of&nbsp;unlocked&nbsp;RWMutex&#34;</span><span class="op" id="1378825">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1378829">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1378833">//&nbsp;A&nbsp;writer&nbsp;is&nbsp;pending.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1378859">if</span>&nbsp;<span class="ident" id="1378862">atomic</span><span class="op" id="1378868">.</span><span class="ident" id="1378869">AddInt32</span><span class="op" id="1378877">(</span><span class="op" id="1378878">&amp;</span><span class="ident" id="1378879">rw</span><span class="op" id="1378881">.</span><span class="ident" id="1378882">readerWait</span><span class="op" id="1378892">,</span>&nbsp;<span class="op" id="1378894">-</span><span class="num" id="1378895">1</span><span class="op" id="1378896">)</span>&nbsp;<span class="op" id="1378898">==</span>&nbsp;<span class="num" id="1378901">0</span>&nbsp;<span class="op" id="1378903">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1378908">//&nbsp;The&nbsp;last&nbsp;reader&nbsp;unblocks&nbsp;the&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1378951">runtime_Semrelease</span><span class="op" id="1378969">(</span><span class="op" id="1378970">&amp;</span><span class="ident" id="1378971">rw</span><span class="op" id="1378973">.</span><span class="ident" id="1378974">writerSem</span><span class="op" id="1378983">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1378987">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1378990">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1378993">if</span>&nbsp;<span class="ident" id="1378996">raceenabled</span>&nbsp;<span class="op" id="1379008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1379012">raceEnable</span><span class="op" id="1379022">(</span><span class="op" id="1379023">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1379026">}</span><br>
<span class="lineno"></span><span class="op" id="1379028">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">70</span><span class="comment" id="1379031">//&nbsp;Lock&nbsp;locks&nbsp;rw&nbsp;for&nbsp;writing.</span><br>
<span class="lineno"></span><span class="comment" id="1379061">//&nbsp;If&nbsp;the&nbsp;lock&nbsp;is&nbsp;already&nbsp;locked&nbsp;for&nbsp;reading&nbsp;or&nbsp;writing,</span><br>
<span class="lineno"></span><span class="comment" id="1379118">//&nbsp;Lock&nbsp;blocks&nbsp;until&nbsp;the&nbsp;lock&nbsp;is&nbsp;available.</span><br>
<span class="lineno"></span><span class="comment" id="1379162">//&nbsp;To&nbsp;ensure&nbsp;that&nbsp;the&nbsp;lock&nbsp;eventually&nbsp;becomes&nbsp;available,</span><br>
<span class="lineno"></span><span class="comment" id="1379219">//&nbsp;a&nbsp;blocked&nbsp;Lock&nbsp;call&nbsp;excludes&nbsp;new&nbsp;readers&nbsp;from&nbsp;acquiring</span><br>
<span class="lineno">75</span><span class="comment" id="1379278">//&nbsp;the&nbsp;lock.</span><br>
<span class="lineno"></span><span class="keyword" id="1379291">func</span>&nbsp;<span class="op" id="1379296">(</span><span class="ident" id="1379297">rw</span>&nbsp;<span class="op" id="1379300">*</span><span class="ident" id="1379301">RWMutex</span><span class="op" id="1379308">)</span>&nbsp;<span class="ident" id="1379310">Lock</span><span class="op" id="1379314">(</span><span class="op" id="1379315">)</span>&nbsp;<span class="op" id="1379317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1379320">if</span>&nbsp;<span class="ident" id="1379323">raceenabled</span>&nbsp;<span class="op" id="1379335">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1379339">_</span>&nbsp;<span class="op" id="1379341">=</span>&nbsp;<span class="ident" id="1379343">rw</span><span class="op" id="1379345">.</span><span class="ident" id="1379346">w</span><span class="op" id="1379347">.</span><span class="ident" id="1379348">state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1379356">raceDisable</span><span class="op" id="1379367">(</span><span class="op" id="1379368">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1379371">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1379374">//&nbsp;First,&nbsp;resolve&nbsp;competition&nbsp;with&nbsp;other&nbsp;writers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1379425">rw</span><span class="op" id="1379427">.</span><span class="ident" id="1379428">w</span><span class="op" id="1379429">.</span><span class="ident" id="1379430">Lock</span><span class="op" id="1379434">(</span><span class="op" id="1379435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1379438">//&nbsp;Announce&nbsp;to&nbsp;readers&nbsp;there&nbsp;is&nbsp;a&nbsp;pending&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1379489">r</span>&nbsp;<span class="op" id="1379491">:=</span>&nbsp;<span class="ident" id="1379494">atomic</span><span class="op" id="1379500">.</span><span class="ident" id="1379501">AddInt32</span><span class="op" id="1379509">(</span><span class="op" id="1379510">&amp;</span><span class="ident" id="1379511">rw</span><span class="op" id="1379513">.</span><span class="ident" id="1379514">readerCount</span><span class="op" id="1379525">,</span>&nbsp;<span class="op" id="1379527">-</span><span class="ident" id="1379528">rwmutexMaxReaders</span><span class="op" id="1379545">)</span>&nbsp;<span class="op" id="1379547">+</span>&nbsp;<span class="ident" id="1379549">rwmutexMaxReaders</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1379568">//&nbsp;Wait&nbsp;for&nbsp;active&nbsp;readers.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1379597">if</span>&nbsp;<span class="ident" id="1379600">r</span>&nbsp;<span class="op" id="1379602">!=</span>&nbsp;<span class="num" id="1379605">0</span>&nbsp;<span class="op" id="1379607">&amp;&amp;</span>&nbsp;<span class="ident" id="1379610">atomic</span><span class="op" id="1379616">.</span><span class="ident" id="1379617">AddInt32</span><span class="op" id="1379625">(</span><span class="op" id="1379626">&amp;</span><span class="ident" id="1379627">rw</span><span class="op" id="1379629">.</span><span class="ident" id="1379630">readerWait</span><span class="op" id="1379640">,</span>&nbsp;<span class="ident" id="1379642">r</span><span class="op" id="1379643">)</span>&nbsp;<span class="op" id="1379645">!=</span>&nbsp;<span class="num" id="1379648">0</span>&nbsp;<span class="op" id="1379650">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1379654">runtime_Semacquire</span><span class="op" id="1379672">(</span><span class="op" id="1379673">&amp;</span><span class="ident" id="1379674">rw</span><span class="op" id="1379676">.</span><span class="ident" id="1379677">writerSem</span><span class="op" id="1379686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1379689">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1379692">if</span>&nbsp;<span class="ident" id="1379695">raceenabled</span>&nbsp;<span class="op" id="1379707">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1379711">raceEnable</span><span class="op" id="1379721">(</span><span class="op" id="1379722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1379726">raceAcquire</span><span class="op" id="1379737">(</span><span class="ident" id="1379738">unsafe</span><span class="op" id="1379744">.</span><span class="ident" id="1379745">Pointer</span><span class="op" id="1379752">(</span><span class="op" id="1379753">&amp;</span><span class="ident" id="1379754">rw</span><span class="op" id="1379756">.</span><span class="ident" id="1379757">readerSem</span><span class="op" id="1379766">)</span><span class="op" id="1379767">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1379771">raceAcquire</span><span class="op" id="1379782">(</span><span class="ident" id="1379783">unsafe</span><span class="op" id="1379789">.</span><span class="ident" id="1379790">Pointer</span><span class="op" id="1379797">(</span><span class="op" id="1379798">&amp;</span><span class="ident" id="1379799">rw</span><span class="op" id="1379801">.</span><span class="ident" id="1379802">writerSem</span><span class="op" id="1379811">)</span><span class="op" id="1379812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1379815">}</span><br>
<span class="lineno"></span><span class="op" id="1379817">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="comment" id="1379820">//&nbsp;Unlock&nbsp;unlocks&nbsp;rw&nbsp;for&nbsp;writing.&nbsp;&nbsp;It&nbsp;is&nbsp;a&nbsp;run-time&nbsp;error&nbsp;if&nbsp;rw&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="1379887">//&nbsp;not&nbsp;locked&nbsp;for&nbsp;writing&nbsp;on&nbsp;entry&nbsp;to&nbsp;Unlock.</span><br>
<span class="lineno"></span><span class="comment" id="1379933">//</span><br>
<span class="lineno"></span><span class="comment" id="1379936">//&nbsp;As&nbsp;with&nbsp;Mutexes,&nbsp;a&nbsp;locked&nbsp;RWMutex&nbsp;is&nbsp;not&nbsp;associated&nbsp;with&nbsp;a&nbsp;particular</span><br>
<span class="lineno">100</span><span class="comment" id="1380009">//&nbsp;goroutine.&nbsp;&nbsp;One&nbsp;goroutine&nbsp;may&nbsp;RLock&nbsp;(Lock)&nbsp;an&nbsp;RWMutex&nbsp;and&nbsp;then</span><br>
<span class="lineno"></span><span class="comment" id="1380075">//&nbsp;arrange&nbsp;for&nbsp;another&nbsp;goroutine&nbsp;to&nbsp;RUnlock&nbsp;(Unlock)&nbsp;it.</span><br>
<span class="lineno"></span><span class="keyword" id="1380132">func</span>&nbsp;<span class="op" id="1380137">(</span><span class="ident" id="1380138">rw</span>&nbsp;<span class="op" id="1380141">*</span><span class="ident" id="1380142">RWMutex</span><span class="op" id="1380149">)</span>&nbsp;<span class="ident" id="1380151">Unlock</span><span class="op" id="1380157">(</span><span class="op" id="1380158">)</span>&nbsp;<span class="op" id="1380160">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1380163">if</span>&nbsp;<span class="ident" id="1380166">raceenabled</span>&nbsp;<span class="op" id="1380178">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1380182">_</span>&nbsp;<span class="op" id="1380184">=</span>&nbsp;<span class="ident" id="1380186">rw</span><span class="op" id="1380188">.</span><span class="ident" id="1380189">w</span><span class="op" id="1380190">.</span><span class="ident" id="1380191">state</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1380199">raceRelease</span><span class="op" id="1380210">(</span><span class="ident" id="1380211">unsafe</span><span class="op" id="1380217">.</span><span class="ident" id="1380218">Pointer</span><span class="op" id="1380225">(</span><span class="op" id="1380226">&amp;</span><span class="ident" id="1380227">rw</span><span class="op" id="1380229">.</span><span class="ident" id="1380230">readerSem</span><span class="op" id="1380239">)</span><span class="op" id="1380240">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1380244">raceRelease</span><span class="op" id="1380255">(</span><span class="ident" id="1380256">unsafe</span><span class="op" id="1380262">.</span><span class="ident" id="1380263">Pointer</span><span class="op" id="1380270">(</span><span class="op" id="1380271">&amp;</span><span class="ident" id="1380272">rw</span><span class="op" id="1380274">.</span><span class="ident" id="1380275">writerSem</span><span class="op" id="1380284">)</span><span class="op" id="1380285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1380289">raceDisable</span><span class="op" id="1380300">(</span><span class="op" id="1380301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1380304">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1380308">//&nbsp;Announce&nbsp;to&nbsp;readers&nbsp;there&nbsp;is&nbsp;no&nbsp;active&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1380359">r</span>&nbsp;<span class="op" id="1380361">:=</span>&nbsp;<span class="ident" id="1380364">atomic</span><span class="op" id="1380370">.</span><span class="ident" id="1380371">AddInt32</span><span class="op" id="1380379">(</span><span class="op" id="1380380">&amp;</span><span class="ident" id="1380381">rw</span><span class="op" id="1380383">.</span><span class="ident" id="1380384">readerCount</span><span class="op" id="1380395">,</span>&nbsp;<span class="ident" id="1380397">rwmutexMaxReaders</span><span class="op" id="1380414">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1380417">if</span>&nbsp;<span class="ident" id="1380420">r</span>&nbsp;<span class="op" id="1380422">&gt;=</span>&nbsp;<span class="ident" id="1380425">rwmutexMaxReaders</span>&nbsp;<span class="op" id="1380443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1380447">raceEnable</span><span class="op" id="1380457">(</span><span class="op" id="1380458">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="1380462">panic</span><span class="op" id="1380467">(</span><span class="string" id="1380468">&#34;sync:&nbsp;Unlock&nbsp;of&nbsp;unlocked&nbsp;RWMutex&#34;</span><span class="op" id="1380502">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1380505">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1380508">//&nbsp;Unblock&nbsp;blocked&nbsp;readers,&nbsp;if&nbsp;any.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1380545">for</span>&nbsp;<span class="ident" id="1380549">i</span>&nbsp;<span class="op" id="1380551">:=</span>&nbsp;<span class="num" id="1380554">0</span><span class="op" id="1380555">;</span>&nbsp;<span class="ident" id="1380557">i</span>&nbsp;<span class="op" id="1380559">&lt;</span>&nbsp;<span class="builtintype" id="1380561">int</span><span class="op" id="1380564">(</span><span class="ident" id="1380565">r</span><span class="op" id="1380566">)</span><span class="op" id="1380567">;</span>&nbsp;<span class="ident" id="1380569">i</span><span class="op" id="1380570">++</span>&nbsp;<span class="op" id="1380573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1380577">runtime_Semrelease</span><span class="op" id="1380595">(</span><span class="op" id="1380596">&amp;</span><span class="ident" id="1380597">rw</span><span class="op" id="1380599">.</span><span class="ident" id="1380600">readerSem</span><span class="op" id="1380609">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1380612">}</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="1380615">//&nbsp;Allow&nbsp;other&nbsp;writers&nbsp;to&nbsp;proceed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1380651">rw</span><span class="op" id="1380653">.</span><span class="ident" id="1380654">w</span><span class="op" id="1380655">.</span><span class="ident" id="1380656">Unlock</span><span class="op" id="1380662">(</span><span class="op" id="1380663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1380666">if</span>&nbsp;<span class="ident" id="1380669">raceenabled</span>&nbsp;<span class="op" id="1380681">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="1380685">raceEnable</span><span class="op" id="1380695">(</span><span class="op" id="1380696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="1380699">}</span><br>
<span class="lineno">125</span><span class="op" id="1380701">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="1380704">//&nbsp;RLocker&nbsp;returns&nbsp;a&nbsp;Locker&nbsp;interface&nbsp;that&nbsp;implements</span><br>
<span class="lineno"></span><span class="comment" id="1380758">//&nbsp;the&nbsp;Lock&nbsp;and&nbsp;Unlock&nbsp;methods&nbsp;by&nbsp;calling&nbsp;rw.RLock&nbsp;and&nbsp;rw.RUnlock.</span><br>
<span class="lineno"></span><span class="keyword" id="1380825">func</span>&nbsp;<span class="op" id="1380830">(</span><span class="ident" id="1380831">rw</span>&nbsp;<span class="op" id="1380834">*</span><span class="ident" id="1380835">RWMutex</span><span class="op" id="1380842">)</span>&nbsp;<span class="ident" id="1380844">RLocker</span><span class="op" id="1380851">(</span><span class="op" id="1380852">)</span>&nbsp;<span class="ident" id="1380854">Locker</span>&nbsp;<span class="op" id="1380861">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="1380864">return</span>&nbsp;<span class="op" id="1380871">(</span><span class="op" id="1380872">*</span><span class="ident" id="1380873">rlocker</span><span class="op" id="1380880">)</span><span class="op" id="1380881">(</span><span class="ident" id="1380882">rw</span><span class="op" id="1380884">)</span><br>
<span class="lineno"></span><span class="op" id="1380886">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="1380889">type</span>&nbsp;<span class="ident" id="1380894">rlocker</span>&nbsp;<span class="ident" id="1380902">RWMutex</span><br>
<span class="lineno"></span><br>
<span class="lineno">135</span><span class="keyword" id="1380911">func</span>&nbsp;<span class="op" id="1380916">(</span><span class="ident" id="1380917">r</span>&nbsp;<span class="op" id="1380919">*</span><span class="ident" id="1380920">rlocker</span><span class="op" id="1380927">)</span>&nbsp;<span class="ident" id="1380929">Lock</span><span class="op" id="1380933">(</span><span class="op" id="1380934">)</span>&nbsp;&nbsp;&nbsp;<span class="op" id="1380938">{</span>&nbsp;<span class="op" id="1380940">(</span><span class="op" id="1380941">*</span><span class="ident" id="1380942">RWMutex</span><span class="op" id="1380949">)</span><span class="op" id="1380950">(</span><span class="ident" id="1380951">r</span><span class="op" id="1380952">)</span><span class="op" id="1380953">.</span><span class="ident" id="1380954">RLock</span><span class="op" id="1380959">(</span><span class="op" id="1380960">)</span>&nbsp;<span class="op" id="1380962">}</span><br>
<span class="lineno"></span><span class="keyword" id="1380964">func</span>&nbsp;<span class="op" id="1380969">(</span><span class="ident" id="1380970">r</span>&nbsp;<span class="op" id="1380972">*</span><span class="ident" id="1380973">rlocker</span><span class="op" id="1380980">)</span>&nbsp;<span class="ident" id="1380982">Unlock</span><span class="op" id="1380988">(</span><span class="op" id="1380989">)</span>&nbsp;<span class="op" id="1380991">{</span>&nbsp;<span class="op" id="1380993">(</span><span class="op" id="1380994">*</span><span class="ident" id="1380995">RWMutex</span><span class="op" id="1381002">)</span><span class="op" id="1381003">(</span><span class="ident" id="1381004">r</span><span class="op" id="1381005">)</span><span class="op" id="1381006">.</span><span class="ident" id="1381007">RUnlock</span><span class="op" id="1381014">(</span><span class="op" id="1381015">)</span>&nbsp;<span class="op" id="1381017">}</span>
</div>
</body>
</html>
