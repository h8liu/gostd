<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net/http/httputil</h2>
<ul>
<li><a href="/gostd/net/http/httputil/dump.go.html" class="current">dump.go</a></li>
<li><a href="/gostd/net/http/httputil/dump_test.go.html">dump_test.go</a></li>
<li><a href="/gostd/net/http/httputil/httputil.go.html">httputil.go</a></li>
<li><a href="/gostd/net/http/httputil/persist.go.html">persist.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy.go.html">reverseproxy.go</a></li>
<li><a href="/gostd/net/http/httputil/reverseproxy_test.go.html">reverseproxy_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="6175448">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="6175503">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="6175557">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="6175608">package</span>&nbsp;<span class="ident" id="6175616">httputil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6175626">import</span>&nbsp;<span class="op" id="6175633">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6175636">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6175645">&#34;bytes&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6175654">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6175664">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6175671">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6175677">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6175690">&#34;net&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6175697">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6175709">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6175720">&#34;strings&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6175731">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="6175738">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="comment" id="6175741">//&nbsp;One&nbsp;of&nbsp;the&nbsp;copies,&nbsp;say&nbsp;from&nbsp;b&nbsp;to&nbsp;r2,&nbsp;could&nbsp;be&nbsp;avoided&nbsp;by&nbsp;using&nbsp;a&nbsp;more</span><br>
<span class="lineno"></span><span class="comment" id="6175814">//&nbsp;elaborate&nbsp;trick&nbsp;where&nbsp;the&nbsp;other&nbsp;copy&nbsp;is&nbsp;made&nbsp;during&nbsp;Request/Response.Write.</span><br>
<span class="lineno"></span><span class="comment" id="6175893">//&nbsp;This&nbsp;would&nbsp;complicate&nbsp;things&nbsp;too&nbsp;much,&nbsp;given&nbsp;that&nbsp;these&nbsp;functions&nbsp;are&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="6175970">//&nbsp;debugging&nbsp;only.</span><br>
<span class="lineno">25</span><span class="keyword" id="6175989">func</span>&nbsp;<span class="ident" id="6175994">drainBody</span><span class="op" id="6176003">(</span><span class="ident" id="6176004">b</span>&nbsp;<span class="ident" id="6176006">io</span><span class="op" id="6176008">.</span><span class="ident" id="6176009">ReadCloser</span><span class="op" id="6176019">)</span>&nbsp;<span class="op" id="6176021">(</span><span class="ident" id="6176022">r1</span><span class="op" id="6176024">,</span>&nbsp;<span class="ident" id="6176026">r2</span>&nbsp;<span class="ident" id="6176029">io</span><span class="op" id="6176031">.</span><span class="ident" id="6176032">ReadCloser</span><span class="op" id="6176042">,</span>&nbsp;<span class="ident" id="6176044">err</span>&nbsp;<span class="builtintype" id="6176048">error</span><span class="op" id="6176053">)</span>&nbsp;<span class="op" id="6176055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6176058">var</span>&nbsp;<span class="ident" id="6176062">buf</span>&nbsp;<span class="ident" id="6176066">bytes</span><span class="op" id="6176071">.</span><span class="ident" id="6176072">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6176080">if</span>&nbsp;<span class="ident" id="6176083">_</span><span class="op" id="6176084">,</span>&nbsp;<span class="ident" id="6176086">err</span>&nbsp;<span class="op" id="6176090">=</span>&nbsp;<span class="ident" id="6176092">buf</span><span class="op" id="6176095">.</span><span class="ident" id="6176096">ReadFrom</span><span class="op" id="6176104">(</span><span class="ident" id="6176105">b</span><span class="op" id="6176106">)</span><span class="op" id="6176107">;</span>&nbsp;<span class="ident" id="6176109">err</span>&nbsp;<span class="op" id="6176113">!=</span>&nbsp;<span class="builtintype" id="6176116">nil</span>&nbsp;<span class="op" id="6176120">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6176124">return</span>&nbsp;<span class="builtintype" id="6176131">nil</span><span class="op" id="6176134">,</span>&nbsp;<span class="builtintype" id="6176136">nil</span><span class="op" id="6176139">,</span>&nbsp;<span class="ident" id="6176141">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6176146">}</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6176149">if</span>&nbsp;<span class="ident" id="6176152">err</span>&nbsp;<span class="op" id="6176156">=</span>&nbsp;<span class="ident" id="6176158">b</span><span class="op" id="6176159">.</span><span class="ident" id="6176160">Close</span><span class="op" id="6176165">(</span><span class="op" id="6176166">)</span><span class="op" id="6176167">;</span>&nbsp;<span class="ident" id="6176169">err</span>&nbsp;<span class="op" id="6176173">!=</span>&nbsp;<span class="builtintype" id="6176176">nil</span>&nbsp;<span class="op" id="6176180">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6176184">return</span>&nbsp;<span class="builtintype" id="6176191">nil</span><span class="op" id="6176194">,</span>&nbsp;<span class="builtintype" id="6176196">nil</span><span class="op" id="6176199">,</span>&nbsp;<span class="ident" id="6176201">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6176206">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6176209">return</span>&nbsp;<span class="ident" id="6176216">ioutil</span><span class="op" id="6176222">.</span><span class="ident" id="6176223">NopCloser</span><span class="op" id="6176232">(</span><span class="op" id="6176233">&amp;</span><span class="ident" id="6176234">buf</span><span class="op" id="6176237">)</span><span class="op" id="6176238">,</span>&nbsp;<span class="ident" id="6176240">ioutil</span><span class="op" id="6176246">.</span><span class="ident" id="6176247">NopCloser</span><span class="op" id="6176256">(</span><span class="ident" id="6176257">bytes</span><span class="op" id="6176262">.</span><span class="ident" id="6176263">NewReader</span><span class="op" id="6176272">(</span><span class="ident" id="6176273">buf</span><span class="op" id="6176276">.</span><span class="ident" id="6176277">Bytes</span><span class="op" id="6176282">(</span><span class="op" id="6176283">)</span><span class="op" id="6176284">)</span><span class="op" id="6176285">)</span><span class="op" id="6176286">,</span>&nbsp;<span class="builtintype" id="6176288">nil</span><br>
<span class="lineno"></span><span class="op" id="6176292">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="comment" id="6176295">//&nbsp;dumpConn&nbsp;is&nbsp;a&nbsp;net.Conn&nbsp;which&nbsp;writes&nbsp;to&nbsp;Writer&nbsp;and&nbsp;reads&nbsp;from&nbsp;Reader</span><br>
<span class="lineno"></span><span class="keyword" id="6176366">type</span>&nbsp;<span class="ident" id="6176371">dumpConn</span>&nbsp;<span class="keyword" id="6176380">struct</span>&nbsp;<span class="op" id="6176387">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6176390">io</span><span class="op" id="6176392">.</span><span class="ident" id="6176393">Writer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6176401">io</span><span class="op" id="6176403">.</span><span class="ident" id="6176404">Reader</span><br>
<span class="lineno">40</span><span class="op" id="6176411">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6176414">func</span>&nbsp;<span class="op" id="6176419">(</span><span class="ident" id="6176420">c</span>&nbsp;<span class="op" id="6176422">*</span><span class="ident" id="6176423">dumpConn</span><span class="op" id="6176431">)</span>&nbsp;<span class="ident" id="6176433">Close</span><span class="op" id="6176438">(</span><span class="op" id="6176439">)</span>&nbsp;<span class="builtintype" id="6176441">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6176469">{</span>&nbsp;<span class="keyword" id="6176471">return</span>&nbsp;<span class="builtintype" id="6176478">nil</span>&nbsp;<span class="op" id="6176482">}</span><br>
<span class="lineno"></span><span class="keyword" id="6176484">func</span>&nbsp;<span class="op" id="6176489">(</span><span class="ident" id="6176490">c</span>&nbsp;<span class="op" id="6176492">*</span><span class="ident" id="6176493">dumpConn</span><span class="op" id="6176501">)</span>&nbsp;<span class="ident" id="6176503">LocalAddr</span><span class="op" id="6176512">(</span><span class="op" id="6176513">)</span>&nbsp;<span class="ident" id="6176515">net</span><span class="op" id="6176518">.</span><span class="ident" id="6176519">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6176539">{</span>&nbsp;<span class="keyword" id="6176541">return</span>&nbsp;<span class="builtintype" id="6176548">nil</span>&nbsp;<span class="op" id="6176552">}</span><br>
<span class="lineno"></span><span class="keyword" id="6176554">func</span>&nbsp;<span class="op" id="6176559">(</span><span class="ident" id="6176560">c</span>&nbsp;<span class="op" id="6176562">*</span><span class="ident" id="6176563">dumpConn</span><span class="op" id="6176571">)</span>&nbsp;<span class="ident" id="6176573">RemoteAddr</span><span class="op" id="6176583">(</span><span class="op" id="6176584">)</span>&nbsp;<span class="ident" id="6176586">net</span><span class="op" id="6176589">.</span><span class="ident" id="6176590">Addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6176609">{</span>&nbsp;<span class="keyword" id="6176611">return</span>&nbsp;<span class="builtintype" id="6176618">nil</span>&nbsp;<span class="op" id="6176622">}</span><br>
<span class="lineno">45</span><span class="keyword" id="6176624">func</span>&nbsp;<span class="op" id="6176629">(</span><span class="ident" id="6176630">c</span>&nbsp;<span class="op" id="6176632">*</span><span class="ident" id="6176633">dumpConn</span><span class="op" id="6176641">)</span>&nbsp;<span class="ident" id="6176643">SetDeadline</span><span class="op" id="6176654">(</span><span class="ident" id="6176655">t</span>&nbsp;<span class="ident" id="6176657">time</span><span class="op" id="6176661">.</span><span class="ident" id="6176662">Time</span><span class="op" id="6176666">)</span>&nbsp;<span class="builtintype" id="6176668">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6176679">{</span>&nbsp;<span class="keyword" id="6176681">return</span>&nbsp;<span class="builtintype" id="6176688">nil</span>&nbsp;<span class="op" id="6176692">}</span><br>
<span class="lineno"></span><span class="keyword" id="6176694">func</span>&nbsp;<span class="op" id="6176699">(</span><span class="ident" id="6176700">c</span>&nbsp;<span class="op" id="6176702">*</span><span class="ident" id="6176703">dumpConn</span><span class="op" id="6176711">)</span>&nbsp;<span class="ident" id="6176713">SetReadDeadline</span><span class="op" id="6176728">(</span><span class="ident" id="6176729">t</span>&nbsp;<span class="ident" id="6176731">time</span><span class="op" id="6176735">.</span><span class="ident" id="6176736">Time</span><span class="op" id="6176740">)</span>&nbsp;<span class="builtintype" id="6176742">error</span>&nbsp;&nbsp;<span class="op" id="6176749">{</span>&nbsp;<span class="keyword" id="6176751">return</span>&nbsp;<span class="builtintype" id="6176758">nil</span>&nbsp;<span class="op" id="6176762">}</span><br>
<span class="lineno"></span><span class="keyword" id="6176764">func</span>&nbsp;<span class="op" id="6176769">(</span><span class="ident" id="6176770">c</span>&nbsp;<span class="op" id="6176772">*</span><span class="ident" id="6176773">dumpConn</span><span class="op" id="6176781">)</span>&nbsp;<span class="ident" id="6176783">SetWriteDeadline</span><span class="op" id="6176799">(</span><span class="ident" id="6176800">t</span>&nbsp;<span class="ident" id="6176802">time</span><span class="op" id="6176806">.</span><span class="ident" id="6176807">Time</span><span class="op" id="6176811">)</span>&nbsp;<span class="builtintype" id="6176813">error</span>&nbsp;<span class="op" id="6176819">{</span>&nbsp;<span class="keyword" id="6176821">return</span>&nbsp;<span class="builtintype" id="6176828">nil</span>&nbsp;<span class="op" id="6176832">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6176835">type</span>&nbsp;<span class="ident" id="6176840">neverEnding</span>&nbsp;<span class="builtintype" id="6176852">byte</span><br>
<span class="lineno">50</span><br>
<span class="lineno"></span><span class="keyword" id="6176858">func</span>&nbsp;<span class="op" id="6176863">(</span><span class="ident" id="6176864">b</span>&nbsp;<span class="ident" id="6176866">neverEnding</span><span class="op" id="6176877">)</span>&nbsp;<span class="ident" id="6176879">Read</span><span class="op" id="6176883">(</span><span class="ident" id="6176884">p</span>&nbsp;<span class="op" id="6176886">[</span><span class="op" id="6176887">]</span><span class="builtintype" id="6176888">byte</span><span class="op" id="6176892">)</span>&nbsp;<span class="op" id="6176894">(</span><span class="ident" id="6176895">n</span>&nbsp;<span class="builtintype" id="6176897">int</span><span class="op" id="6176900">,</span>&nbsp;<span class="ident" id="6176902">err</span>&nbsp;<span class="builtintype" id="6176906">error</span><span class="op" id="6176911">)</span>&nbsp;<span class="op" id="6176913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6176916">for</span>&nbsp;<span class="ident" id="6176920">i</span>&nbsp;<span class="op" id="6176922">:=</span>&nbsp;<span class="keyword" id="6176925">range</span>&nbsp;<span class="ident" id="6176931">p</span>&nbsp;<span class="op" id="6176933">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6176937">p</span><span class="op" id="6176938">[</span><span class="ident" id="6176939">i</span><span class="op" id="6176940">]</span>&nbsp;<span class="op" id="6176942">=</span>&nbsp;<span class="builtintype" id="6176944">byte</span><span class="op" id="6176948">(</span><span class="ident" id="6176949">b</span><span class="op" id="6176950">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6176953">}</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6176956">return</span>&nbsp;<span class="builtinfunc" id="6176963">len</span><span class="op" id="6176966">(</span><span class="ident" id="6176967">p</span><span class="op" id="6176968">)</span><span class="op" id="6176969">,</span>&nbsp;<span class="builtintype" id="6176971">nil</span><br>
<span class="lineno"></span><span class="op" id="6176975">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6176978">//&nbsp;DumpRequestOut&nbsp;is&nbsp;like&nbsp;DumpRequest&nbsp;but&nbsp;includes</span><br>
<span class="lineno"></span><span class="comment" id="6177029">//&nbsp;headers&nbsp;that&nbsp;the&nbsp;standard&nbsp;http.Transport&nbsp;adds,</span><br>
<span class="lineno">60</span><span class="comment" id="6177079">//&nbsp;such&nbsp;as&nbsp;User-Agent.</span><br>
<span class="lineno"></span><span class="keyword" id="6177102">func</span>&nbsp;<span class="ident" id="6177107">DumpRequestOut</span><span class="op" id="6177121">(</span><span class="ident" id="6177122">req</span>&nbsp;<span class="op" id="6177126">*</span><span class="ident" id="6177127">http</span><span class="op" id="6177131">.</span><span class="ident" id="6177132">Request</span><span class="op" id="6177139">,</span>&nbsp;<span class="ident" id="6177141">body</span>&nbsp;<span class="builtintype" id="6177146">bool</span><span class="op" id="6177150">)</span>&nbsp;<span class="op" id="6177152">(</span><span class="op" id="6177153">[</span><span class="op" id="6177154">]</span><span class="builtintype" id="6177155">byte</span><span class="op" id="6177159">,</span>&nbsp;<span class="builtintype" id="6177161">error</span><span class="op" id="6177166">)</span>&nbsp;<span class="op" id="6177168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6177171">save</span>&nbsp;<span class="op" id="6177176">:=</span>&nbsp;<span class="ident" id="6177179">req</span><span class="op" id="6177182">.</span><span class="ident" id="6177183">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6177189">dummyBody</span>&nbsp;<span class="op" id="6177199">:=</span>&nbsp;<span class="builtintype" id="6177202">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6177209">if</span>&nbsp;<span class="op" id="6177212">!</span><span class="ident" id="6177213">body</span>&nbsp;<span class="op" id="6177218">||</span>&nbsp;<span class="ident" id="6177221">req</span><span class="op" id="6177224">.</span><span class="ident" id="6177225">Body</span>&nbsp;<span class="op" id="6177230">==</span>&nbsp;<span class="builtintype" id="6177233">nil</span>&nbsp;<span class="op" id="6177237">{</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6177241">req</span><span class="op" id="6177244">.</span><span class="ident" id="6177245">Body</span>&nbsp;<span class="op" id="6177250">=</span>&nbsp;<span class="builtintype" id="6177252">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6177258">if</span>&nbsp;<span class="ident" id="6177261">req</span><span class="op" id="6177264">.</span><span class="ident" id="6177265">ContentLength</span>&nbsp;<span class="op" id="6177279">!=</span>&nbsp;<span class="num" id="6177282">0</span>&nbsp;<span class="op" id="6177284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6177289">req</span><span class="op" id="6177292">.</span><span class="ident" id="6177293">Body</span>&nbsp;<span class="op" id="6177298">=</span>&nbsp;<span class="ident" id="6177300">ioutil</span><span class="op" id="6177306">.</span><span class="ident" id="6177307">NopCloser</span><span class="op" id="6177316">(</span><span class="ident" id="6177317">io</span><span class="op" id="6177319">.</span><span class="ident" id="6177320">LimitReader</span><span class="op" id="6177331">(</span><span class="ident" id="6177332">neverEnding</span><span class="op" id="6177343">(</span><span class="string" id="6177344">&#39;x&#39;</span><span class="op" id="6177347">)</span><span class="op" id="6177348">,</span>&nbsp;<span class="ident" id="6177350">req</span><span class="op" id="6177353">.</span><span class="ident" id="6177354">ContentLength</span><span class="op" id="6177367">)</span><span class="op" id="6177368">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6177373">dummyBody</span>&nbsp;<span class="op" id="6177383">=</span>&nbsp;<span class="builtintype" id="6177385">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6177392">}</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6177395">}</span>&nbsp;<span class="keyword" id="6177397">else</span>&nbsp;<span class="op" id="6177402">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6177406">var</span>&nbsp;<span class="ident" id="6177410">err</span>&nbsp;<span class="builtintype" id="6177414">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6177422">save</span><span class="op" id="6177426">,</span>&nbsp;<span class="ident" id="6177428">req</span><span class="op" id="6177431">.</span><span class="ident" id="6177432">Body</span><span class="op" id="6177436">,</span>&nbsp;<span class="ident" id="6177438">err</span>&nbsp;<span class="op" id="6177442">=</span>&nbsp;<span class="ident" id="6177444">drainBody</span><span class="op" id="6177453">(</span><span class="ident" id="6177454">req</span><span class="op" id="6177457">.</span><span class="ident" id="6177458">Body</span><span class="op" id="6177462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6177466">if</span>&nbsp;<span class="ident" id="6177469">err</span>&nbsp;<span class="op" id="6177473">!=</span>&nbsp;<span class="builtintype" id="6177476">nil</span>&nbsp;<span class="op" id="6177480">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6177485">return</span>&nbsp;<span class="builtintype" id="6177492">nil</span><span class="op" id="6177495">,</span>&nbsp;<span class="ident" id="6177497">err</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6177503">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6177506">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6177510">//&nbsp;Since&nbsp;we&#39;re&nbsp;using&nbsp;the&nbsp;actual&nbsp;Transport&nbsp;code&nbsp;to&nbsp;write&nbsp;the&nbsp;request,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6177580">//&nbsp;switch&nbsp;to&nbsp;http&nbsp;so&nbsp;the&nbsp;Transport&nbsp;doesn&#39;t&nbsp;try&nbsp;to&nbsp;do&nbsp;an&nbsp;SSL</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6177641">//&nbsp;negotiation&nbsp;with&nbsp;our&nbsp;dumpConn&nbsp;and&nbsp;its&nbsp;bytes.Buffer&nbsp;&amp;&nbsp;pipe.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6177704">//&nbsp;The&nbsp;wire&nbsp;format&nbsp;for&nbsp;https&nbsp;and&nbsp;http&nbsp;are&nbsp;the&nbsp;same,&nbsp;anyway.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6177765">reqSend</span>&nbsp;<span class="op" id="6177773">:=</span>&nbsp;<span class="ident" id="6177776">req</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6177781">if</span>&nbsp;<span class="ident" id="6177784">req</span><span class="op" id="6177787">.</span><span class="ident" id="6177788">URL</span><span class="op" id="6177791">.</span><span class="ident" id="6177792">Scheme</span>&nbsp;<span class="op" id="6177799">==</span>&nbsp;<span class="string" id="6177802">&#34;https&#34;</span>&nbsp;<span class="op" id="6177810">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6177814">reqSend</span>&nbsp;<span class="op" id="6177822">=</span>&nbsp;<span class="builtinfunc" id="6177824">new</span><span class="op" id="6177827">(</span><span class="ident" id="6177828">http</span><span class="op" id="6177832">.</span><span class="ident" id="6177833">Request</span><span class="op" id="6177840">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6177844">*</span><span class="ident" id="6177845">reqSend</span>&nbsp;<span class="op" id="6177853">=</span>&nbsp;<span class="op" id="6177855">*</span><span class="ident" id="6177856">req</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6177862">reqSend</span><span class="op" id="6177869">.</span><span class="ident" id="6177870">URL</span>&nbsp;<span class="op" id="6177874">=</span>&nbsp;<span class="builtinfunc" id="6177876">new</span><span class="op" id="6177879">(</span><span class="ident" id="6177880">url</span><span class="op" id="6177883">.</span><span class="ident" id="6177884">URL</span><span class="op" id="6177887">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6177891">*</span><span class="ident" id="6177892">reqSend</span><span class="op" id="6177899">.</span><span class="ident" id="6177900">URL</span>&nbsp;<span class="op" id="6177904">=</span>&nbsp;<span class="op" id="6177906">*</span><span class="ident" id="6177907">req</span><span class="op" id="6177910">.</span><span class="ident" id="6177911">URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6177917">reqSend</span><span class="op" id="6177924">.</span><span class="ident" id="6177925">URL</span><span class="op" id="6177928">.</span><span class="ident" id="6177929">Scheme</span>&nbsp;<span class="op" id="6177936">=</span>&nbsp;<span class="string" id="6177938">&#34;http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6177946">}</span><br>
<span class="lineno">90</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6177950">//&nbsp;Use&nbsp;the&nbsp;actual&nbsp;Transport&nbsp;code&nbsp;to&nbsp;record&nbsp;what&nbsp;we&nbsp;would&nbsp;send</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6178013">//&nbsp;on&nbsp;the&nbsp;wire,&nbsp;but&nbsp;not&nbsp;using&nbsp;TCP.&nbsp;&nbsp;Use&nbsp;a&nbsp;Transport&nbsp;with&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6178073">//&nbsp;custom&nbsp;dialer&nbsp;that&nbsp;returns&nbsp;a&nbsp;fake&nbsp;net.Conn&nbsp;that&nbsp;waits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6178131">//&nbsp;for&nbsp;the&nbsp;full&nbsp;input&nbsp;(and&nbsp;recording&nbsp;it),&nbsp;and&nbsp;then&nbsp;responds</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6178192">//&nbsp;with&nbsp;a&nbsp;dummy&nbsp;response.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6178219">var</span>&nbsp;<span class="ident" id="6178223">buf</span>&nbsp;<span class="ident" id="6178227">bytes</span><span class="op" id="6178232">.</span><span class="ident" id="6178233">Buffer</span>&nbsp;<span class="comment" id="6178240">//&nbsp;records&nbsp;the&nbsp;output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6178263">pr</span><span class="op" id="6178265">,</span>&nbsp;<span class="ident" id="6178267">pw</span>&nbsp;<span class="op" id="6178270">:=</span>&nbsp;<span class="ident" id="6178273">io</span><span class="op" id="6178275">.</span><span class="ident" id="6178276">Pipe</span><span class="op" id="6178280">(</span><span class="op" id="6178281">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6178284">defer</span>&nbsp;<span class="ident" id="6178290">pr</span><span class="op" id="6178292">.</span><span class="ident" id="6178293">Close</span><span class="op" id="6178298">(</span><span class="op" id="6178299">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6178302">defer</span>&nbsp;<span class="ident" id="6178308">pw</span><span class="op" id="6178310">.</span><span class="ident" id="6178311">Close</span><span class="op" id="6178316">(</span><span class="op" id="6178317">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6178320">dr</span>&nbsp;<span class="op" id="6178323">:=</span>&nbsp;<span class="op" id="6178326">&amp;</span><span class="ident" id="6178327">delegateReader</span><span class="op" id="6178341">{</span><span class="ident" id="6178342">c</span><span class="op" id="6178343">:</span>&nbsp;<span class="builtinfunc" id="6178345">make</span><span class="op" id="6178349">(</span><span class="keyword" id="6178350">chan</span>&nbsp;<span class="ident" id="6178355">io</span><span class="op" id="6178357">.</span><span class="ident" id="6178358">Reader</span><span class="op" id="6178364">)</span><span class="op" id="6178365">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6178368">//&nbsp;Wait&nbsp;for&nbsp;the&nbsp;request&nbsp;before&nbsp;replying&nbsp;with&nbsp;a&nbsp;dummy&nbsp;response:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6178432">go</span>&nbsp;<span class="keyword" id="6178435">func</span><span class="op" id="6178439">(</span><span class="op" id="6178440">)</span>&nbsp;<span class="op" id="6178442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6178446">req</span><span class="op" id="6178449">,</span>&nbsp;<span class="ident" id="6178451">err</span>&nbsp;<span class="op" id="6178455">:=</span>&nbsp;<span class="ident" id="6178458">http</span><span class="op" id="6178462">.</span><span class="ident" id="6178463">ReadRequest</span><span class="op" id="6178474">(</span><span class="ident" id="6178475">bufio</span><span class="op" id="6178480">.</span><span class="ident" id="6178481">NewReader</span><span class="op" id="6178490">(</span><span class="ident" id="6178491">pr</span><span class="op" id="6178493">)</span><span class="op" id="6178494">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6178498">if</span>&nbsp;<span class="ident" id="6178501">err</span>&nbsp;<span class="op" id="6178505">==</span>&nbsp;<span class="builtintype" id="6178508">nil</span>&nbsp;<span class="op" id="6178512">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6178517">//&nbsp;Ensure&nbsp;all&nbsp;the&nbsp;body&nbsp;is&nbsp;read;&nbsp;otherwise</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6178562">//&nbsp;we&#39;ll&nbsp;get&nbsp;a&nbsp;partial&nbsp;dump.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6178594">io</span><span class="op" id="6178596">.</span><span class="ident" id="6178597">Copy</span><span class="op" id="6178601">(</span><span class="ident" id="6178602">ioutil</span><span class="op" id="6178608">.</span><span class="ident" id="6178609">Discard</span><span class="op" id="6178616">,</span>&nbsp;<span class="ident" id="6178618">req</span><span class="op" id="6178621">.</span><span class="ident" id="6178622">Body</span><span class="op" id="6178626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6178631">req</span><span class="op" id="6178634">.</span><span class="ident" id="6178635">Body</span><span class="op" id="6178639">.</span><span class="ident" id="6178640">Close</span><span class="op" id="6178645">(</span><span class="op" id="6178646">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6178650">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6178654">dr</span><span class="op" id="6178656">.</span><span class="ident" id="6178657">c</span>&nbsp;<span class="op" id="6178659">&lt;-</span>&nbsp;<span class="ident" id="6178662">strings</span><span class="op" id="6178669">.</span><span class="ident" id="6178670">NewReader</span><span class="op" id="6178679">(</span><span class="string" id="6178680">&#34;HTTP/1.1&nbsp;204&nbsp;No&nbsp;Content\r\n\r\n&#34;</span><span class="op" id="6178713">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6178716">}</span><span class="op" id="6178717">(</span><span class="op" id="6178718">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6178722">t</span>&nbsp;<span class="op" id="6178724">:=</span>&nbsp;<span class="op" id="6178727">&amp;</span><span class="ident" id="6178728">http</span><span class="op" id="6178732">.</span><span class="ident" id="6178733">Transport</span><span class="op" id="6178742">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6178746">DisableKeepAlives</span><span class="op" id="6178763">:</span>&nbsp;<span class="builtintype" id="6178765">true</span><span class="op" id="6178769">,</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6178773">Dial</span><span class="op" id="6178777">:</span>&nbsp;<span class="keyword" id="6178779">func</span><span class="op" id="6178783">(</span><span class="ident" id="6178784">net</span><span class="op" id="6178787">,</span>&nbsp;<span class="ident" id="6178789">addr</span>&nbsp;<span class="builtintype" id="6178794">string</span><span class="op" id="6178800">)</span>&nbsp;<span class="op" id="6178802">(</span><span class="ident" id="6178803">net</span><span class="op" id="6178806">.</span><span class="ident" id="6178807">Conn</span><span class="op" id="6178811">,</span>&nbsp;<span class="builtintype" id="6178813">error</span><span class="op" id="6178818">)</span>&nbsp;<span class="op" id="6178820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6178825">return</span>&nbsp;<span class="op" id="6178832">&amp;</span><span class="ident" id="6178833">dumpConn</span><span class="op" id="6178841">{</span><span class="ident" id="6178842">io</span><span class="op" id="6178844">.</span><span class="ident" id="6178845">MultiWriter</span><span class="op" id="6178856">(</span><span class="op" id="6178857">&amp;</span><span class="ident" id="6178858">buf</span><span class="op" id="6178861">,</span>&nbsp;<span class="ident" id="6178863">pw</span><span class="op" id="6178865">)</span><span class="op" id="6178866">,</span>&nbsp;<span class="ident" id="6178868">dr</span><span class="op" id="6178870">}</span><span class="op" id="6178871">,</span>&nbsp;<span class="builtintype" id="6178873">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6178879">}</span><span class="op" id="6178880">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6178883">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6178887">_</span><span class="op" id="6178888">,</span>&nbsp;<span class="ident" id="6178890">err</span>&nbsp;<span class="op" id="6178894">:=</span>&nbsp;<span class="ident" id="6178897">t</span><span class="op" id="6178898">.</span><span class="ident" id="6178899">RoundTrip</span><span class="op" id="6178908">(</span><span class="ident" id="6178909">reqSend</span><span class="op" id="6178916">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6178920">req</span><span class="op" id="6178923">.</span><span class="ident" id="6178924">Body</span>&nbsp;<span class="op" id="6178929">=</span>&nbsp;<span class="ident" id="6178931">save</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6178937">if</span>&nbsp;<span class="ident" id="6178940">err</span>&nbsp;<span class="op" id="6178944">!=</span>&nbsp;<span class="builtintype" id="6178947">nil</span>&nbsp;<span class="op" id="6178951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6178955">return</span>&nbsp;<span class="builtintype" id="6178962">nil</span><span class="op" id="6178965">,</span>&nbsp;<span class="ident" id="6178967">err</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6178972">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6178975">dump</span>&nbsp;<span class="op" id="6178980">:=</span>&nbsp;<span class="ident" id="6178983">buf</span><span class="op" id="6178986">.</span><span class="ident" id="6178987">Bytes</span><span class="op" id="6178992">(</span><span class="op" id="6178993">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6178997">//&nbsp;If&nbsp;we&nbsp;used&nbsp;a&nbsp;dummy&nbsp;body&nbsp;above,&nbsp;remove&nbsp;it&nbsp;now.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6179047">//&nbsp;TODO:&nbsp;if&nbsp;the&nbsp;req.ContentLength&nbsp;is&nbsp;large,&nbsp;we&nbsp;allocate&nbsp;memory</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6179111">//&nbsp;unnecessarily&nbsp;just&nbsp;to&nbsp;slice&nbsp;it&nbsp;off&nbsp;here.&nbsp;&nbsp;But&nbsp;this&nbsp;is&nbsp;just</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6179174">//&nbsp;a&nbsp;debug&nbsp;function,&nbsp;so&nbsp;this&nbsp;is&nbsp;acceptable&nbsp;for&nbsp;now.&nbsp;We&nbsp;could</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="6179236">//&nbsp;discard&nbsp;the&nbsp;body&nbsp;earlier&nbsp;if&nbsp;this&nbsp;matters.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6179282">if</span>&nbsp;<span class="ident" id="6179285">dummyBody</span>&nbsp;<span class="op" id="6179295">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6179299">if</span>&nbsp;<span class="ident" id="6179302">i</span>&nbsp;<span class="op" id="6179304">:=</span>&nbsp;<span class="ident" id="6179307">bytes</span><span class="op" id="6179312">.</span><span class="ident" id="6179313">Index</span><span class="op" id="6179318">(</span><span class="ident" id="6179319">dump</span><span class="op" id="6179323">,</span>&nbsp;<span class="op" id="6179325">[</span><span class="op" id="6179326">]</span><span class="builtintype" id="6179327">byte</span><span class="op" id="6179331">(</span><span class="string" id="6179332">&#34;\r\n\r\n&#34;</span><span class="op" id="6179342">)</span><span class="op" id="6179343">)</span><span class="op" id="6179344">;</span>&nbsp;<span class="ident" id="6179346">i</span>&nbsp;<span class="op" id="6179348">&gt;=</span>&nbsp;<span class="num" id="6179351">0</span>&nbsp;<span class="op" id="6179353">{</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6179358">dump</span>&nbsp;<span class="op" id="6179363">=</span>&nbsp;<span class="ident" id="6179365">dump</span><span class="op" id="6179369">[</span><span class="op" id="6179370">:</span><span class="ident" id="6179371">i</span><span class="op" id="6179372">+</span><span class="num" id="6179373">4</span><span class="op" id="6179374">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6179378">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6179381">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6179384">return</span>&nbsp;<span class="ident" id="6179391">dump</span><span class="op" id="6179395">,</span>&nbsp;<span class="builtintype" id="6179397">nil</span><br>
<span class="lineno"></span><span class="op" id="6179401">}</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span><span class="comment" id="6179404">//&nbsp;delegateReader&nbsp;is&nbsp;a&nbsp;reader&nbsp;that&nbsp;delegates&nbsp;to&nbsp;another&nbsp;reader,</span><br>
<span class="lineno"></span><span class="comment" id="6179468">//&nbsp;once&nbsp;it&nbsp;arrives&nbsp;on&nbsp;a&nbsp;channel.</span><br>
<span class="lineno"></span><span class="keyword" id="6179501">type</span>&nbsp;<span class="ident" id="6179506">delegateReader</span>&nbsp;<span class="keyword" id="6179521">struct</span>&nbsp;<span class="op" id="6179528">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6179531">c</span>&nbsp;<span class="keyword" id="6179533">chan</span>&nbsp;<span class="ident" id="6179538">io</span><span class="op" id="6179540">.</span><span class="ident" id="6179541">Reader</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6179549">r</span>&nbsp;<span class="ident" id="6179551">io</span><span class="op" id="6179553">.</span><span class="ident" id="6179554">Reader</span>&nbsp;<span class="comment" id="6179561">//&nbsp;nil&nbsp;until&nbsp;received&nbsp;from&nbsp;c</span><br>
<span class="lineno"></span><span class="op" id="6179590">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6179593">func</span>&nbsp;<span class="op" id="6179598">(</span><span class="ident" id="6179599">r</span>&nbsp;<span class="op" id="6179601">*</span><span class="ident" id="6179602">delegateReader</span><span class="op" id="6179616">)</span>&nbsp;<span class="ident" id="6179618">Read</span><span class="op" id="6179622">(</span><span class="ident" id="6179623">p</span>&nbsp;<span class="op" id="6179625">[</span><span class="op" id="6179626">]</span><span class="builtintype" id="6179627">byte</span><span class="op" id="6179631">)</span>&nbsp;<span class="op" id="6179633">(</span><span class="builtintype" id="6179634">int</span><span class="op" id="6179637">,</span>&nbsp;<span class="builtintype" id="6179639">error</span><span class="op" id="6179644">)</span>&nbsp;<span class="op" id="6179646">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6179649">if</span>&nbsp;<span class="ident" id="6179652">r</span><span class="op" id="6179653">.</span><span class="ident" id="6179654">r</span>&nbsp;<span class="op" id="6179656">==</span>&nbsp;<span class="builtintype" id="6179659">nil</span>&nbsp;<span class="op" id="6179663">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6179667">r</span><span class="op" id="6179668">.</span><span class="ident" id="6179669">r</span>&nbsp;<span class="op" id="6179671">=</span>&nbsp;<span class="op" id="6179673">&lt;-</span><span class="ident" id="6179675">r</span><span class="op" id="6179676">.</span><span class="ident" id="6179677">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6179680">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6179683">return</span>&nbsp;<span class="ident" id="6179690">r</span><span class="op" id="6179691">.</span><span class="ident" id="6179692">r</span><span class="op" id="6179693">.</span><span class="ident" id="6179694">Read</span><span class="op" id="6179698">(</span><span class="ident" id="6179699">p</span><span class="op" id="6179700">)</span><br>
<span class="lineno"></span><span class="op" id="6179702">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">155</span><span class="comment" id="6179705">//&nbsp;Return&nbsp;value&nbsp;if&nbsp;nonempty,&nbsp;def&nbsp;otherwise.</span><br>
<span class="lineno"></span><span class="keyword" id="6179749">func</span>&nbsp;<span class="ident" id="6179754">valueOrDefault</span><span class="op" id="6179768">(</span><span class="ident" id="6179769">value</span><span class="op" id="6179774">,</span>&nbsp;<span class="ident" id="6179776">def</span>&nbsp;<span class="builtintype" id="6179780">string</span><span class="op" id="6179786">)</span>&nbsp;<span class="builtintype" id="6179788">string</span>&nbsp;<span class="op" id="6179795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6179798">if</span>&nbsp;<span class="ident" id="6179801">value</span>&nbsp;<span class="op" id="6179807">!=</span>&nbsp;<span class="string" id="6179810">&#34;&#34;</span>&nbsp;<span class="op" id="6179813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6179817">return</span>&nbsp;<span class="ident" id="6179824">value</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6179831">}</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6179834">return</span>&nbsp;<span class="ident" id="6179841">def</span><br>
<span class="lineno"></span><span class="op" id="6179845">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6179848">var</span>&nbsp;<span class="ident" id="6179852">reqWriteExcludeHeaderDump</span>&nbsp;<span class="op" id="6179878">=</span>&nbsp;<span class="keyword" id="6179880">map</span><span class="op" id="6179883">[</span><span class="builtintype" id="6179884">string</span><span class="op" id="6179890">]</span><span class="builtintype" id="6179891">bool</span><span class="op" id="6179895">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6179898">&#34;Host&#34;</span><span class="op" id="6179904">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6179919">true</span><span class="op" id="6179923">,</span>&nbsp;<span class="comment" id="6179925">//&nbsp;not&nbsp;in&nbsp;Header&nbsp;map&nbsp;anyway</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6179954">&#34;Content-Length&#34;</span><span class="op" id="6179970">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6179975">true</span><span class="op" id="6179979">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6179982">&#34;Transfer-Encoding&#34;</span><span class="op" id="6180001">:</span>&nbsp;<span class="builtintype" id="6180003">true</span><span class="op" id="6180007">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="6180010">&#34;Trailer&#34;</span><span class="op" id="6180019">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="6180031">true</span><span class="op" id="6180035">,</span><br>
<span class="lineno"></span><span class="op" id="6180037">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">170</span><span class="comment" id="6180040">//&nbsp;dumpAsReceived&nbsp;writes&nbsp;req&nbsp;to&nbsp;w&nbsp;in&nbsp;the&nbsp;form&nbsp;as&nbsp;it&nbsp;was&nbsp;received,&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="6180109">//&nbsp;at&nbsp;least&nbsp;as&nbsp;accurately&nbsp;as&nbsp;possible&nbsp;from&nbsp;the&nbsp;information&nbsp;retained&nbsp;in</span><br>
<span class="lineno"></span><span class="comment" id="6180180">//&nbsp;the&nbsp;request.</span><br>
<span class="lineno"></span><span class="keyword" id="6180196">func</span>&nbsp;<span class="ident" id="6180201">dumpAsReceived</span><span class="op" id="6180215">(</span><span class="ident" id="6180216">req</span>&nbsp;<span class="op" id="6180220">*</span><span class="ident" id="6180221">http</span><span class="op" id="6180225">.</span><span class="ident" id="6180226">Request</span><span class="op" id="6180233">,</span>&nbsp;<span class="ident" id="6180235">w</span>&nbsp;<span class="ident" id="6180237">io</span><span class="op" id="6180239">.</span><span class="ident" id="6180240">Writer</span><span class="op" id="6180246">)</span>&nbsp;<span class="builtintype" id="6180248">error</span>&nbsp;<span class="op" id="6180254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6180257">return</span>&nbsp;<span class="builtintype" id="6180264">nil</span><br>
<span class="lineno">175</span><span class="op" id="6180268">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6180271">//&nbsp;DumpRequest&nbsp;returns&nbsp;the&nbsp;as-received&nbsp;wire&nbsp;representation&nbsp;of&nbsp;req,</span><br>
<span class="lineno"></span><span class="comment" id="6180338">//&nbsp;optionally&nbsp;including&nbsp;the&nbsp;request&nbsp;body,&nbsp;for&nbsp;debugging.</span><br>
<span class="lineno"></span><span class="comment" id="6180395">//&nbsp;DumpRequest&nbsp;is&nbsp;semantically&nbsp;a&nbsp;no-op,&nbsp;but&nbsp;in&nbsp;order&nbsp;to</span><br>
<span class="lineno">180</span><span class="comment" id="6180451">//&nbsp;dump&nbsp;the&nbsp;body,&nbsp;it&nbsp;reads&nbsp;the&nbsp;body&nbsp;data&nbsp;into&nbsp;memory&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="6180508">//&nbsp;changes&nbsp;req.Body&nbsp;to&nbsp;refer&nbsp;to&nbsp;the&nbsp;in-memory&nbsp;copy.</span><br>
<span class="lineno"></span><span class="comment" id="6180560">//&nbsp;The&nbsp;documentation&nbsp;for&nbsp;http.Request.Write&nbsp;details&nbsp;which&nbsp;fields</span><br>
<span class="lineno"></span><span class="comment" id="6180625">//&nbsp;of&nbsp;req&nbsp;are&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="6180645">func</span>&nbsp;<span class="ident" id="6180650">DumpRequest</span><span class="op" id="6180661">(</span><span class="ident" id="6180662">req</span>&nbsp;<span class="op" id="6180666">*</span><span class="ident" id="6180667">http</span><span class="op" id="6180671">.</span><span class="ident" id="6180672">Request</span><span class="op" id="6180679">,</span>&nbsp;<span class="ident" id="6180681">body</span>&nbsp;<span class="builtintype" id="6180686">bool</span><span class="op" id="6180690">)</span>&nbsp;<span class="op" id="6180692">(</span><span class="ident" id="6180693">dump</span>&nbsp;<span class="op" id="6180698">[</span><span class="op" id="6180699">]</span><span class="builtintype" id="6180700">byte</span><span class="op" id="6180704">,</span>&nbsp;<span class="ident" id="6180706">err</span>&nbsp;<span class="builtintype" id="6180710">error</span><span class="op" id="6180715">)</span>&nbsp;<span class="op" id="6180717">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6180720">save</span>&nbsp;<span class="op" id="6180725">:=</span>&nbsp;<span class="ident" id="6180728">req</span><span class="op" id="6180731">.</span><span class="ident" id="6180732">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6180738">if</span>&nbsp;<span class="op" id="6180741">!</span><span class="ident" id="6180742">body</span>&nbsp;<span class="op" id="6180747">||</span>&nbsp;<span class="ident" id="6180750">req</span><span class="op" id="6180753">.</span><span class="ident" id="6180754">Body</span>&nbsp;<span class="op" id="6180759">==</span>&nbsp;<span class="builtintype" id="6180762">nil</span>&nbsp;<span class="op" id="6180766">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6180770">req</span><span class="op" id="6180773">.</span><span class="ident" id="6180774">Body</span>&nbsp;<span class="op" id="6180779">=</span>&nbsp;<span class="builtintype" id="6180781">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6180786">}</span>&nbsp;<span class="keyword" id="6180788">else</span>&nbsp;<span class="op" id="6180793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6180797">save</span><span class="op" id="6180801">,</span>&nbsp;<span class="ident" id="6180803">req</span><span class="op" id="6180806">.</span><span class="ident" id="6180807">Body</span><span class="op" id="6180811">,</span>&nbsp;<span class="ident" id="6180813">err</span>&nbsp;<span class="op" id="6180817">=</span>&nbsp;<span class="ident" id="6180819">drainBody</span><span class="op" id="6180828">(</span><span class="ident" id="6180829">req</span><span class="op" id="6180832">.</span><span class="ident" id="6180833">Body</span><span class="op" id="6180837">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6180841">if</span>&nbsp;<span class="ident" id="6180844">err</span>&nbsp;<span class="op" id="6180848">!=</span>&nbsp;<span class="builtintype" id="6180851">nil</span>&nbsp;<span class="op" id="6180855">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6180860">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6180869">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6180872">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6180876">var</span>&nbsp;<span class="ident" id="6180880">b</span>&nbsp;<span class="ident" id="6180882">bytes</span><span class="op" id="6180887">.</span><span class="ident" id="6180888">Buffer</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6180897">fmt</span><span class="op" id="6180900">.</span><span class="ident" id="6180901">Fprintf</span><span class="op" id="6180908">(</span><span class="op" id="6180909">&amp;</span><span class="ident" id="6180910">b</span><span class="op" id="6180911">,</span>&nbsp;<span class="string" id="6180913">&#34;%s&nbsp;%s&nbsp;HTTP/%d.%d\r\n&#34;</span><span class="op" id="6180935">,</span>&nbsp;<span class="ident" id="6180937">valueOrDefault</span><span class="op" id="6180951">(</span><span class="ident" id="6180952">req</span><span class="op" id="6180955">.</span><span class="ident" id="6180956">Method</span><span class="op" id="6180962">,</span>&nbsp;<span class="string" id="6180964">&#34;GET&#34;</span><span class="op" id="6180969">)</span><span class="op" id="6180970">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6180974">req</span><span class="op" id="6180977">.</span><span class="ident" id="6180978">URL</span><span class="op" id="6180981">.</span><span class="ident" id="6180982">RequestURI</span><span class="op" id="6180992">(</span><span class="op" id="6180993">)</span><span class="op" id="6180994">,</span>&nbsp;<span class="ident" id="6180996">req</span><span class="op" id="6180999">.</span><span class="ident" id="6181000">ProtoMajor</span><span class="op" id="6181010">,</span>&nbsp;<span class="ident" id="6181012">req</span><span class="op" id="6181015">.</span><span class="ident" id="6181016">ProtoMinor</span><span class="op" id="6181026">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6181030">host</span>&nbsp;<span class="op" id="6181035">:=</span>&nbsp;<span class="ident" id="6181038">req</span><span class="op" id="6181041">.</span><span class="ident" id="6181042">Host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6181048">if</span>&nbsp;<span class="ident" id="6181051">host</span>&nbsp;<span class="op" id="6181056">==</span>&nbsp;<span class="string" id="6181059">&#34;&#34;</span>&nbsp;<span class="op" id="6181062">&amp;&amp;</span>&nbsp;<span class="ident" id="6181065">req</span><span class="op" id="6181068">.</span><span class="ident" id="6181069">URL</span>&nbsp;<span class="op" id="6181073">!=</span>&nbsp;<span class="builtintype" id="6181076">nil</span>&nbsp;<span class="op" id="6181080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6181084">host</span>&nbsp;<span class="op" id="6181089">=</span>&nbsp;<span class="ident" id="6181091">req</span><span class="op" id="6181094">.</span><span class="ident" id="6181095">URL</span><span class="op" id="6181098">.</span><span class="ident" id="6181099">Host</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6181105">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6181108">if</span>&nbsp;<span class="ident" id="6181111">host</span>&nbsp;<span class="op" id="6181116">!=</span>&nbsp;<span class="string" id="6181119">&#34;&#34;</span>&nbsp;<span class="op" id="6181122">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6181126">fmt</span><span class="op" id="6181129">.</span><span class="ident" id="6181130">Fprintf</span><span class="op" id="6181137">(</span><span class="op" id="6181138">&amp;</span><span class="ident" id="6181139">b</span><span class="op" id="6181140">,</span>&nbsp;<span class="string" id="6181142">&#34;Host:&nbsp;%s\r\n&#34;</span><span class="op" id="6181156">,</span>&nbsp;<span class="ident" id="6181158">host</span><span class="op" id="6181162">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6181165">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6181169">chunked</span>&nbsp;<span class="op" id="6181177">:=</span>&nbsp;<span class="builtinfunc" id="6181180">len</span><span class="op" id="6181183">(</span><span class="ident" id="6181184">req</span><span class="op" id="6181187">.</span><span class="ident" id="6181188">TransferEncoding</span><span class="op" id="6181204">)</span>&nbsp;<span class="op" id="6181206">&gt;</span>&nbsp;<span class="num" id="6181208">0</span>&nbsp;<span class="op" id="6181210">&amp;&amp;</span>&nbsp;<span class="ident" id="6181213">req</span><span class="op" id="6181216">.</span><span class="ident" id="6181217">TransferEncoding</span><span class="op" id="6181233">[</span><span class="num" id="6181234">0</span><span class="op" id="6181235">]</span>&nbsp;<span class="op" id="6181237">==</span>&nbsp;<span class="string" id="6181240">&#34;chunked&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6181251">if</span>&nbsp;<span class="builtinfunc" id="6181254">len</span><span class="op" id="6181257">(</span><span class="ident" id="6181258">req</span><span class="op" id="6181261">.</span><span class="ident" id="6181262">TransferEncoding</span><span class="op" id="6181278">)</span>&nbsp;<span class="op" id="6181280">&gt;</span>&nbsp;<span class="num" id="6181282">0</span>&nbsp;<span class="op" id="6181284">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6181288">fmt</span><span class="op" id="6181291">.</span><span class="ident" id="6181292">Fprintf</span><span class="op" id="6181299">(</span><span class="op" id="6181300">&amp;</span><span class="ident" id="6181301">b</span><span class="op" id="6181302">,</span>&nbsp;<span class="string" id="6181304">&#34;Transfer-Encoding:&nbsp;%s\r\n&#34;</span><span class="op" id="6181331">,</span>&nbsp;<span class="ident" id="6181333">strings</span><span class="op" id="6181340">.</span><span class="ident" id="6181341">Join</span><span class="op" id="6181345">(</span><span class="ident" id="6181346">req</span><span class="op" id="6181349">.</span><span class="ident" id="6181350">TransferEncoding</span><span class="op" id="6181366">,</span>&nbsp;<span class="string" id="6181368">&#34;,&#34;</span><span class="op" id="6181371">)</span><span class="op" id="6181372">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6181375">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6181378">if</span>&nbsp;<span class="ident" id="6181381">req</span><span class="op" id="6181384">.</span><span class="ident" id="6181385">Close</span>&nbsp;<span class="op" id="6181391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6181395">fmt</span><span class="op" id="6181398">.</span><span class="ident" id="6181399">Fprintf</span><span class="op" id="6181406">(</span><span class="op" id="6181407">&amp;</span><span class="ident" id="6181408">b</span><span class="op" id="6181409">,</span>&nbsp;<span class="string" id="6181411">&#34;Connection:&nbsp;close\r\n&#34;</span><span class="op" id="6181434">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6181437">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6181441">err</span>&nbsp;<span class="op" id="6181445">=</span>&nbsp;<span class="ident" id="6181447">req</span><span class="op" id="6181450">.</span><span class="ident" id="6181451">Header</span><span class="op" id="6181457">.</span><span class="ident" id="6181458">WriteSubset</span><span class="op" id="6181469">(</span><span class="op" id="6181470">&amp;</span><span class="ident" id="6181471">b</span><span class="op" id="6181472">,</span>&nbsp;<span class="ident" id="6181474">reqWriteExcludeHeaderDump</span><span class="op" id="6181499">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6181502">if</span>&nbsp;<span class="ident" id="6181505">err</span>&nbsp;<span class="op" id="6181509">!=</span>&nbsp;<span class="builtintype" id="6181512">nil</span>&nbsp;<span class="op" id="6181516">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6181520">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6181528">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6181532">io</span><span class="op" id="6181534">.</span><span class="ident" id="6181535">WriteString</span><span class="op" id="6181546">(</span><span class="op" id="6181547">&amp;</span><span class="ident" id="6181548">b</span><span class="op" id="6181549">,</span>&nbsp;<span class="string" id="6181551">&#34;\r\n&#34;</span><span class="op" id="6181557">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6181561">if</span>&nbsp;<span class="ident" id="6181564">req</span><span class="op" id="6181567">.</span><span class="ident" id="6181568">Body</span>&nbsp;<span class="op" id="6181573">!=</span>&nbsp;<span class="builtintype" id="6181576">nil</span>&nbsp;<span class="op" id="6181580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6181584">var</span>&nbsp;<span class="ident" id="6181588">dest</span>&nbsp;<span class="ident" id="6181593">io</span><span class="op" id="6181595">.</span><span class="ident" id="6181596">Writer</span>&nbsp;<span class="op" id="6181603">=</span>&nbsp;<span class="op" id="6181605">&amp;</span><span class="ident" id="6181606">b</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6181610">if</span>&nbsp;<span class="ident" id="6181613">chunked</span>&nbsp;<span class="op" id="6181621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6181626">dest</span>&nbsp;<span class="op" id="6181631">=</span>&nbsp;<span class="ident" id="6181633">NewChunkedWriter</span><span class="op" id="6181649">(</span><span class="ident" id="6181650">dest</span><span class="op" id="6181654">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6181658">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6181662">_</span><span class="op" id="6181663">,</span>&nbsp;<span class="ident" id="6181665">err</span>&nbsp;<span class="op" id="6181669">=</span>&nbsp;<span class="ident" id="6181671">io</span><span class="op" id="6181673">.</span><span class="ident" id="6181674">Copy</span><span class="op" id="6181678">(</span><span class="ident" id="6181679">dest</span><span class="op" id="6181683">,</span>&nbsp;<span class="ident" id="6181685">req</span><span class="op" id="6181688">.</span><span class="ident" id="6181689">Body</span><span class="op" id="6181693">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6181697">if</span>&nbsp;<span class="ident" id="6181700">chunked</span>&nbsp;<span class="op" id="6181708">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6181713">dest</span><span class="op" id="6181717">.</span><span class="op" id="6181718">(</span><span class="ident" id="6181719">io</span><span class="op" id="6181721">.</span><span class="ident" id="6181722">Closer</span><span class="op" id="6181728">)</span><span class="op" id="6181729">.</span><span class="ident" id="6181730">Close</span><span class="op" id="6181735">(</span><span class="op" id="6181736">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6181741">io</span><span class="op" id="6181743">.</span><span class="ident" id="6181744">WriteString</span><span class="op" id="6181755">(</span><span class="op" id="6181756">&amp;</span><span class="ident" id="6181757">b</span><span class="op" id="6181758">,</span>&nbsp;<span class="string" id="6181760">&#34;\r\n&#34;</span><span class="op" id="6181766">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6181770">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6181773">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6181777">req</span><span class="op" id="6181780">.</span><span class="ident" id="6181781">Body</span>&nbsp;<span class="op" id="6181786">=</span>&nbsp;<span class="ident" id="6181788">save</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6181794">if</span>&nbsp;<span class="ident" id="6181797">err</span>&nbsp;<span class="op" id="6181801">!=</span>&nbsp;<span class="builtintype" id="6181804">nil</span>&nbsp;<span class="op" id="6181808">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6181812">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6181820">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6181823">dump</span>&nbsp;<span class="op" id="6181828">=</span>&nbsp;<span class="ident" id="6181830">b</span><span class="op" id="6181831">.</span><span class="ident" id="6181832">Bytes</span><span class="op" id="6181837">(</span><span class="op" id="6181838">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6181841">return</span><br>
<span class="lineno"></span><span class="op" id="6181848">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6181851">//&nbsp;errNoBody&nbsp;is&nbsp;a&nbsp;sentinel&nbsp;error&nbsp;value&nbsp;used&nbsp;by&nbsp;failureToReadBody&nbsp;so&nbsp;we&nbsp;can&nbsp;detect</span><br>
<span class="lineno"></span><span class="comment" id="6181933">//&nbsp;that&nbsp;the&nbsp;lack&nbsp;of&nbsp;body&nbsp;was&nbsp;intentional.</span><br>
<span class="lineno">245</span><span class="keyword" id="6181975">var</span>&nbsp;<span class="ident" id="6181979">errNoBody</span>&nbsp;<span class="op" id="6181989">=</span>&nbsp;<span class="ident" id="6181991">errors</span><span class="op" id="6181997">.</span><span class="ident" id="6181998">New</span><span class="op" id="6182001">(</span><span class="string" id="6182002">&#34;sentinel&nbsp;error&nbsp;value&#34;</span><span class="op" id="6182024">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6182027">//&nbsp;failureToReadBody&nbsp;is&nbsp;a&nbsp;io.ReadCloser&nbsp;that&nbsp;just&nbsp;returns&nbsp;errNoBody&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="6182098">//&nbsp;Read.&nbsp;&nbsp;It&#39;s&nbsp;swapped&nbsp;in&nbsp;when&nbsp;we&nbsp;don&#39;t&nbsp;actually&nbsp;want&nbsp;to&nbsp;consume&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="6182167">//&nbsp;body,&nbsp;but&nbsp;need&nbsp;a&nbsp;non-nil&nbsp;one,&nbsp;and&nbsp;want&nbsp;to&nbsp;distinguish&nbsp;the&nbsp;error</span><br>
<span class="lineno">250</span><span class="comment" id="6182234">//&nbsp;from&nbsp;reading&nbsp;the&nbsp;dummy&nbsp;body.</span><br>
<span class="lineno"></span><span class="keyword" id="6182266">type</span>&nbsp;<span class="ident" id="6182271">failureToReadBody</span>&nbsp;<span class="keyword" id="6182289">struct</span><span class="op" id="6182295">{</span><span class="op" id="6182296">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="6182299">func</span>&nbsp;<span class="op" id="6182304">(</span><span class="ident" id="6182305">failureToReadBody</span><span class="op" id="6182322">)</span>&nbsp;<span class="ident" id="6182324">Read</span><span class="op" id="6182328">(</span><span class="op" id="6182329">[</span><span class="op" id="6182330">]</span><span class="builtintype" id="6182331">byte</span><span class="op" id="6182335">)</span>&nbsp;<span class="op" id="6182337">(</span><span class="builtintype" id="6182338">int</span><span class="op" id="6182341">,</span>&nbsp;<span class="builtintype" id="6182343">error</span><span class="op" id="6182348">)</span>&nbsp;<span class="op" id="6182350">{</span>&nbsp;<span class="keyword" id="6182352">return</span>&nbsp;<span class="num" id="6182359">0</span><span class="op" id="6182360">,</span>&nbsp;<span class="ident" id="6182362">errNoBody</span>&nbsp;<span class="op" id="6182372">}</span><br>
<span class="lineno"></span><span class="keyword" id="6182374">func</span>&nbsp;<span class="op" id="6182379">(</span><span class="ident" id="6182380">failureToReadBody</span><span class="op" id="6182397">)</span>&nbsp;<span class="ident" id="6182399">Close</span><span class="op" id="6182404">(</span><span class="op" id="6182405">)</span>&nbsp;<span class="builtintype" id="6182407">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6182425">{</span>&nbsp;<span class="keyword" id="6182427">return</span>&nbsp;<span class="builtintype" id="6182434">nil</span>&nbsp;<span class="op" id="6182438">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span><span class="keyword" id="6182441">var</span>&nbsp;<span class="ident" id="6182445">emptyBody</span>&nbsp;<span class="op" id="6182455">=</span>&nbsp;<span class="ident" id="6182457">ioutil</span><span class="op" id="6182463">.</span><span class="ident" id="6182464">NopCloser</span><span class="op" id="6182473">(</span><span class="ident" id="6182474">strings</span><span class="op" id="6182481">.</span><span class="ident" id="6182482">NewReader</span><span class="op" id="6182491">(</span><span class="string" id="6182492">&#34;&#34;</span><span class="op" id="6182494">)</span><span class="op" id="6182495">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="6182498">//&nbsp;DumpResponse&nbsp;is&nbsp;like&nbsp;DumpRequest&nbsp;but&nbsp;dumps&nbsp;a&nbsp;response.</span><br>
<span class="lineno"></span><span class="keyword" id="6182556">func</span>&nbsp;<span class="ident" id="6182561">DumpResponse</span><span class="op" id="6182573">(</span><span class="ident" id="6182574">resp</span>&nbsp;<span class="op" id="6182579">*</span><span class="ident" id="6182580">http</span><span class="op" id="6182584">.</span><span class="ident" id="6182585">Response</span><span class="op" id="6182593">,</span>&nbsp;<span class="ident" id="6182595">body</span>&nbsp;<span class="builtintype" id="6182600">bool</span><span class="op" id="6182604">)</span>&nbsp;<span class="op" id="6182606">(</span><span class="ident" id="6182607">dump</span>&nbsp;<span class="op" id="6182612">[</span><span class="op" id="6182613">]</span><span class="builtintype" id="6182614">byte</span><span class="op" id="6182618">,</span>&nbsp;<span class="ident" id="6182620">err</span>&nbsp;<span class="builtintype" id="6182624">error</span><span class="op" id="6182629">)</span>&nbsp;<span class="op" id="6182631">{</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6182634">var</span>&nbsp;<span class="ident" id="6182638">b</span>&nbsp;<span class="ident" id="6182640">bytes</span><span class="op" id="6182645">.</span><span class="ident" id="6182646">Buffer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6182654">save</span>&nbsp;<span class="op" id="6182659">:=</span>&nbsp;<span class="ident" id="6182662">resp</span><span class="op" id="6182666">.</span><span class="ident" id="6182667">Body</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6182673">savecl</span>&nbsp;<span class="op" id="6182680">:=</span>&nbsp;<span class="ident" id="6182683">resp</span><span class="op" id="6182687">.</span><span class="ident" id="6182688">ContentLength</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6182704">if</span>&nbsp;<span class="op" id="6182707">!</span><span class="ident" id="6182708">body</span>&nbsp;<span class="op" id="6182713">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6182717">resp</span><span class="op" id="6182721">.</span><span class="ident" id="6182722">Body</span>&nbsp;<span class="op" id="6182727">=</span>&nbsp;<span class="ident" id="6182729">failureToReadBody</span><span class="op" id="6182746">{</span><span class="op" id="6182747">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6182750">}</span>&nbsp;<span class="keyword" id="6182752">else</span>&nbsp;<span class="keyword" id="6182757">if</span>&nbsp;<span class="ident" id="6182760">resp</span><span class="op" id="6182764">.</span><span class="ident" id="6182765">Body</span>&nbsp;<span class="op" id="6182770">==</span>&nbsp;<span class="builtintype" id="6182773">nil</span>&nbsp;<span class="op" id="6182777">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6182781">resp</span><span class="op" id="6182785">.</span><span class="ident" id="6182786">Body</span>&nbsp;<span class="op" id="6182791">=</span>&nbsp;<span class="ident" id="6182793">emptyBody</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6182804">}</span>&nbsp;<span class="keyword" id="6182806">else</span>&nbsp;<span class="op" id="6182811">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6182815">save</span><span class="op" id="6182819">,</span>&nbsp;<span class="ident" id="6182821">resp</span><span class="op" id="6182825">.</span><span class="ident" id="6182826">Body</span><span class="op" id="6182830">,</span>&nbsp;<span class="ident" id="6182832">err</span>&nbsp;<span class="op" id="6182836">=</span>&nbsp;<span class="ident" id="6182838">drainBody</span><span class="op" id="6182847">(</span><span class="ident" id="6182848">resp</span><span class="op" id="6182852">.</span><span class="ident" id="6182853">Body</span><span class="op" id="6182857">)</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6182861">if</span>&nbsp;<span class="ident" id="6182864">err</span>&nbsp;<span class="op" id="6182868">!=</span>&nbsp;<span class="builtintype" id="6182871">nil</span>&nbsp;<span class="op" id="6182875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6182880">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6182889">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6182892">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6182895">err</span>&nbsp;<span class="op" id="6182899">=</span>&nbsp;<span class="ident" id="6182901">resp</span><span class="op" id="6182905">.</span><span class="ident" id="6182906">Write</span><span class="op" id="6182911">(</span><span class="op" id="6182912">&amp;</span><span class="ident" id="6182913">b</span><span class="op" id="6182914">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6182917">if</span>&nbsp;<span class="ident" id="6182920">err</span>&nbsp;<span class="op" id="6182924">==</span>&nbsp;<span class="ident" id="6182927">errNoBody</span>&nbsp;<span class="op" id="6182937">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6182941">err</span>&nbsp;<span class="op" id="6182945">=</span>&nbsp;<span class="builtintype" id="6182947">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6182952">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6182955">resp</span><span class="op" id="6182959">.</span><span class="ident" id="6182960">Body</span>&nbsp;<span class="op" id="6182965">=</span>&nbsp;<span class="ident" id="6182967">save</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="6182973">resp</span><span class="op" id="6182977">.</span><span class="ident" id="6182978">ContentLength</span>&nbsp;<span class="op" id="6182992">=</span>&nbsp;<span class="ident" id="6182994">savecl</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6183002">if</span>&nbsp;<span class="ident" id="6183005">err</span>&nbsp;<span class="op" id="6183009">!=</span>&nbsp;<span class="builtintype" id="6183012">nil</span>&nbsp;<span class="op" id="6183016">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6183020">return</span>&nbsp;<span class="builtintype" id="6183027">nil</span><span class="op" id="6183030">,</span>&nbsp;<span class="ident" id="6183032">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="6183037">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="6183040">return</span>&nbsp;<span class="ident" id="6183047">b</span><span class="op" id="6183048">.</span><span class="ident" id="6183049">Bytes</span><span class="op" id="6183054">(</span><span class="op" id="6183055">)</span><span class="op" id="6183056">,</span>&nbsp;<span class="builtintype" id="6183058">nil</span><br>
<span class="lineno"></span><span class="op" id="6183062">}</span>
</div>
</body>
</html>
