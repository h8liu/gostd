<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>compress/lzw</h2>
<ul>
<li><a href="/gostd/compress/lzw/reader.go.html" class="current">reader.go</a></li>
<li><a href="/gostd/compress/lzw/reader_test.go.html">reader_test.go</a></li>
<li><a href="/gostd/compress/lzw/writer.go.html">writer.go</a></li>
<li><a href="/gostd/compress/lzw/writer_test.go.html">writer_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="5347242">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="5347297">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="5347351">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="5347402">//&nbsp;Package&nbsp;lzw&nbsp;implements&nbsp;the&nbsp;Lempel-Ziv-Welch&nbsp;compressed&nbsp;data&nbsp;format,</span><br>
<span class="lineno"></span><span class="comment" id="5347473">//&nbsp;described&nbsp;in&nbsp;T.&nbsp;A.&nbsp;Welch,&nbsp;``A&nbsp;Technique&nbsp;for&nbsp;High-Performance&nbsp;Data</span><br>
<span class="lineno"></span><span class="comment" id="5347542">//&nbsp;Compression&#39;&#39;,&nbsp;Computer,&nbsp;17(6)&nbsp;(June&nbsp;1984),&nbsp;pp&nbsp;8-19.</span><br>
<span class="lineno"></span><span class="comment" id="5347598">//</span><br>
<span class="lineno"></span><span class="comment" id="5347601">//&nbsp;In&nbsp;particular,&nbsp;it&nbsp;implements&nbsp;LZW&nbsp;as&nbsp;used&nbsp;by&nbsp;the&nbsp;GIF&nbsp;and&nbsp;PDF&nbsp;file</span><br>
<span class="lineno">10</span><span class="comment" id="5347669">//&nbsp;formats,&nbsp;which&nbsp;means&nbsp;variable-width&nbsp;codes&nbsp;up&nbsp;to&nbsp;12&nbsp;bits&nbsp;and&nbsp;the&nbsp;first</span><br>
<span class="lineno"></span><span class="comment" id="5347742">//&nbsp;two&nbsp;non-literal&nbsp;codes&nbsp;are&nbsp;a&nbsp;clear&nbsp;code&nbsp;and&nbsp;an&nbsp;EOF&nbsp;code.</span><br>
<span class="lineno"></span><span class="comment" id="5347801">//</span><br>
<span class="lineno"></span><span class="comment" id="5347804">//&nbsp;The&nbsp;TIFF&nbsp;file&nbsp;format&nbsp;uses&nbsp;a&nbsp;similar&nbsp;but&nbsp;incompatible&nbsp;version&nbsp;of&nbsp;the&nbsp;LZW</span><br>
<span class="lineno"></span><span class="comment" id="5347879">//&nbsp;algorithm.&nbsp;See&nbsp;the&nbsp;golang.org/x/image/tiff/lzw&nbsp;package&nbsp;for&nbsp;an</span><br>
<span class="lineno">15</span><span class="comment" id="5347944">//&nbsp;implementation.</span><br>
<span class="lineno"></span><span class="keyword" id="5347963">package</span>&nbsp;<span class="ident" id="5347971">lzw</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5347976">//&nbsp;TODO(nigeltao):&nbsp;check&nbsp;that&nbsp;PDF&nbsp;uses&nbsp;LZW&nbsp;in&nbsp;the&nbsp;same&nbsp;way&nbsp;as&nbsp;GIF,</span><br>
<span class="lineno"></span><span class="comment" id="5348043">//&nbsp;modulo&nbsp;LSB/MSB&nbsp;packing&nbsp;order.</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="5348077">import</span>&nbsp;<span class="op" id="5348084">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5348087">&#34;bufio&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5348096">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5348106">&#34;fmt&#34;</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="5348113">&#34;io&#34;</span><br>
<span class="lineno"></span><span class="op" id="5348118">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5348121">//&nbsp;Order&nbsp;specifies&nbsp;the&nbsp;bit&nbsp;ordering&nbsp;in&nbsp;an&nbsp;LZW&nbsp;data&nbsp;stream.</span><br>
<span class="lineno"></span><span class="keyword" id="5348180">type</span>&nbsp;<span class="ident" id="5348185">Order</span>&nbsp;<span class="builtintype" id="5348191">int</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="keyword" id="5348196">const</span>&nbsp;<span class="op" id="5348202">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5348205">//&nbsp;LSB&nbsp;means&nbsp;Least&nbsp;Significant&nbsp;Bits&nbsp;first,&nbsp;as&nbsp;used&nbsp;in&nbsp;the&nbsp;GIF&nbsp;file&nbsp;format.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5348281">LSB</span>&nbsp;<span class="ident" id="5348285">Order</span>&nbsp;<span class="op" id="5348291">=</span>&nbsp;<span class="ident" id="5348293">iota</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5348299">//&nbsp;MSB&nbsp;means&nbsp;Most&nbsp;Significant&nbsp;Bits&nbsp;first,&nbsp;as&nbsp;used&nbsp;in&nbsp;the&nbsp;TIFF&nbsp;and&nbsp;PDF</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5348370">//&nbsp;file&nbsp;formats.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5348388">MSB</span><br>
<span class="lineno"></span><span class="op" id="5348392">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5348395">const</span>&nbsp;<span class="op" id="5348401">(</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5348404">maxWidth</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5348423">=</span>&nbsp;<span class="num" id="5348425">12</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5348429">decoderInvalidCode</span>&nbsp;<span class="op" id="5348448">=</span>&nbsp;<span class="num" id="5348450">0xffff</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5348458">flushBuffer</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="5348477">=</span>&nbsp;<span class="num" id="5348479">1</span>&nbsp;<span class="op" id="5348481">&lt;&lt;</span>&nbsp;<span class="ident" id="5348484">maxWidth</span><br>
<span class="lineno"></span><span class="op" id="5348493">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="5348496">//&nbsp;decoder&nbsp;is&nbsp;the&nbsp;state&nbsp;from&nbsp;which&nbsp;the&nbsp;readXxx&nbsp;method&nbsp;converts&nbsp;a&nbsp;byte</span><br>
<span class="lineno"></span><span class="comment" id="5348566">//&nbsp;stream&nbsp;into&nbsp;a&nbsp;code&nbsp;stream.</span><br>
<span class="lineno"></span><span class="keyword" id="5348596">type</span>&nbsp;<span class="ident" id="5348601">decoder</span>&nbsp;<span class="keyword" id="5348609">struct</span>&nbsp;<span class="op" id="5348616">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5348619">r</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="5348628">io</span><span class="op" id="5348630">.</span><span class="ident" id="5348631">ByteReader</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5348643">bits</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5348652">uint32</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5348660">nBits</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5348669">uint</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5348675">width</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5348684">uint</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5348690">read</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="5348699">func</span><span class="op" id="5348703">(</span><span class="op" id="5348704">*</span><span class="ident" id="5348705">decoder</span><span class="op" id="5348712">)</span>&nbsp;<span class="op" id="5348714">(</span><span class="builtintype" id="5348715">uint16</span><span class="op" id="5348721">,</span>&nbsp;<span class="builtintype" id="5348723">error</span><span class="op" id="5348728">)</span>&nbsp;<span class="comment" id="5348730">//&nbsp;readLSB&nbsp;or&nbsp;readMSB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5348753">litWidth</span>&nbsp;<span class="builtintype" id="5348762">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5348793">//&nbsp;width&nbsp;in&nbsp;bits&nbsp;of&nbsp;literal&nbsp;codes</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5348828">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5348837">error</span><br>
<span class="lineno">55</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5348845">//&nbsp;The&nbsp;first&nbsp;1&lt;&lt;litWidth&nbsp;codes&nbsp;are&nbsp;literal&nbsp;codes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5348896">//&nbsp;The&nbsp;next&nbsp;two&nbsp;codes&nbsp;mean&nbsp;clear&nbsp;and&nbsp;EOF.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5348939">//&nbsp;Other&nbsp;valid&nbsp;codes&nbsp;are&nbsp;in&nbsp;the&nbsp;range&nbsp;[lo,&nbsp;hi]&nbsp;where&nbsp;lo&nbsp;:=&nbsp;clear&nbsp;+&nbsp;2,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5349010">//&nbsp;with&nbsp;the&nbsp;upper&nbsp;bound&nbsp;incrementing&nbsp;on&nbsp;each&nbsp;code&nbsp;seen.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5349067">//&nbsp;overflow&nbsp;is&nbsp;the&nbsp;code&nbsp;at&nbsp;which&nbsp;hi&nbsp;overflows&nbsp;the&nbsp;code&nbsp;width.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5349130">//&nbsp;last&nbsp;is&nbsp;the&nbsp;most&nbsp;recently&nbsp;seen&nbsp;code,&nbsp;or&nbsp;decoderInvalidCode.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5349194">clear</span><span class="op" id="5349199">,</span>&nbsp;<span class="ident" id="5349201">eof</span><span class="op" id="5349204">,</span>&nbsp;<span class="ident" id="5349206">hi</span><span class="op" id="5349208">,</span>&nbsp;<span class="ident" id="5349210">overflow</span><span class="op" id="5349218">,</span>&nbsp;<span class="ident" id="5349220">last</span>&nbsp;<span class="builtintype" id="5349225">uint16</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5349234">//&nbsp;Each&nbsp;code&nbsp;c&nbsp;in&nbsp;[lo,&nbsp;hi]&nbsp;expands&nbsp;to&nbsp;two&nbsp;or&nbsp;more&nbsp;bytes.&nbsp;For&nbsp;c&nbsp;!=&nbsp;hi:</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5349305">//&nbsp;&nbsp;&nbsp;suffix[c]&nbsp;is&nbsp;the&nbsp;last&nbsp;of&nbsp;these&nbsp;bytes.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5349349">//&nbsp;&nbsp;&nbsp;prefix[c]&nbsp;is&nbsp;the&nbsp;code&nbsp;for&nbsp;all&nbsp;but&nbsp;the&nbsp;last&nbsp;byte.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5349404">//&nbsp;&nbsp;&nbsp;This&nbsp;code&nbsp;can&nbsp;either&nbsp;be&nbsp;a&nbsp;literal&nbsp;code&nbsp;or&nbsp;another&nbsp;code&nbsp;in&nbsp;[lo,&nbsp;c).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5349477">//&nbsp;The&nbsp;c&nbsp;==&nbsp;hi&nbsp;case&nbsp;is&nbsp;a&nbsp;special&nbsp;case.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5349517">suffix</span>&nbsp;<span class="op" id="5349524">[</span><span class="num" id="5349525">1</span>&nbsp;<span class="op" id="5349527">&lt;&lt;</span>&nbsp;<span class="ident" id="5349530">maxWidth</span><span class="op" id="5349538">]</span><span class="builtintype" id="5349539">uint8</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5349546">prefix</span>&nbsp;<span class="op" id="5349553">[</span><span class="num" id="5349554">1</span>&nbsp;<span class="op" id="5349556">&lt;&lt;</span>&nbsp;<span class="ident" id="5349559">maxWidth</span><span class="op" id="5349567">]</span><span class="builtintype" id="5349568">uint16</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5349577">//&nbsp;output&nbsp;is&nbsp;the&nbsp;temporary&nbsp;output&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5349620">//&nbsp;Literal&nbsp;codes&nbsp;are&nbsp;accumulated&nbsp;from&nbsp;the&nbsp;start&nbsp;of&nbsp;the&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5349684">//&nbsp;Non-literal&nbsp;codes&nbsp;decode&nbsp;to&nbsp;a&nbsp;sequence&nbsp;of&nbsp;suffixes&nbsp;that&nbsp;are&nbsp;first</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5349754">//&nbsp;written&nbsp;right-to-left&nbsp;from&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;buffer&nbsp;before&nbsp;being&nbsp;copied</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5349827">//&nbsp;to&nbsp;the&nbsp;start&nbsp;of&nbsp;the&nbsp;buffer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5349859">//&nbsp;It&nbsp;is&nbsp;flushed&nbsp;when&nbsp;it&nbsp;contains&nbsp;&gt;=&nbsp;1&lt;&lt;maxWidth&nbsp;bytes,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5349916">//&nbsp;so&nbsp;that&nbsp;there&nbsp;is&nbsp;always&nbsp;room&nbsp;to&nbsp;decode&nbsp;an&nbsp;entire&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5349975">output</span>&nbsp;<span class="op" id="5349982">[</span><span class="num" id="5349983">2</span>&nbsp;<span class="op" id="5349985">*</span>&nbsp;<span class="num" id="5349987">1</span>&nbsp;<span class="op" id="5349989">&lt;&lt;</span>&nbsp;<span class="ident" id="5349992">maxWidth</span><span class="op" id="5350000">]</span><span class="builtintype" id="5350001">byte</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5350007">o</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="5350014">int</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="5350021">//&nbsp;write&nbsp;index&nbsp;into&nbsp;output</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5350049">toRead</span>&nbsp;<span class="op" id="5350056">[</span><span class="op" id="5350057">]</span><span class="builtintype" id="5350058">byte</span>&nbsp;<span class="comment" id="5350063">//&nbsp;bytes&nbsp;to&nbsp;return&nbsp;from&nbsp;Read</span><br>
<span class="lineno"></span><span class="op" id="5350092">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5350095">//&nbsp;readLSB&nbsp;returns&nbsp;the&nbsp;next&nbsp;code&nbsp;for&nbsp;&#34;Least&nbsp;Significant&nbsp;Bits&nbsp;first&#34;&nbsp;data.</span><br>
<span class="lineno">85</span><span class="keyword" id="5350169">func</span>&nbsp;<span class="op" id="5350174">(</span><span class="ident" id="5350175">d</span>&nbsp;<span class="op" id="5350177">*</span><span class="ident" id="5350178">decoder</span><span class="op" id="5350185">)</span>&nbsp;<span class="ident" id="5350187">readLSB</span><span class="op" id="5350194">(</span><span class="op" id="5350195">)</span>&nbsp;<span class="op" id="5350197">(</span><span class="builtintype" id="5350198">uint16</span><span class="op" id="5350204">,</span>&nbsp;<span class="builtintype" id="5350206">error</span><span class="op" id="5350211">)</span>&nbsp;<span class="op" id="5350213">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5350216">for</span>&nbsp;<span class="ident" id="5350220">d</span><span class="op" id="5350221">.</span><span class="ident" id="5350222">nBits</span>&nbsp;<span class="op" id="5350228">&lt;</span>&nbsp;<span class="ident" id="5350230">d</span><span class="op" id="5350231">.</span><span class="ident" id="5350232">width</span>&nbsp;<span class="op" id="5350238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5350242">x</span><span class="op" id="5350243">,</span>&nbsp;<span class="ident" id="5350245">err</span>&nbsp;<span class="op" id="5350249">:=</span>&nbsp;<span class="ident" id="5350252">d</span><span class="op" id="5350253">.</span><span class="ident" id="5350254">r</span><span class="op" id="5350255">.</span><span class="ident" id="5350256">ReadByte</span><span class="op" id="5350264">(</span><span class="op" id="5350265">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5350269">if</span>&nbsp;<span class="ident" id="5350272">err</span>&nbsp;<span class="op" id="5350276">!=</span>&nbsp;<span class="ident" id="5350279">nil</span>&nbsp;<span class="op" id="5350283">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5350288">return</span>&nbsp;<span class="num" id="5350295">0</span><span class="op" id="5350296">,</span>&nbsp;<span class="ident" id="5350298">err</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5350304">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5350308">d</span><span class="op" id="5350309">.</span><span class="ident" id="5350310">bits</span>&nbsp;<span class="op" id="5350315">|=</span>&nbsp;<span class="builtintype" id="5350318">uint32</span><span class="op" id="5350324">(</span><span class="ident" id="5350325">x</span><span class="op" id="5350326">)</span>&nbsp;<span class="op" id="5350328">&lt;&lt;</span>&nbsp;<span class="ident" id="5350331">d</span><span class="op" id="5350332">.</span><span class="ident" id="5350333">nBits</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5350341">d</span><span class="op" id="5350342">.</span><span class="ident" id="5350343">nBits</span>&nbsp;<span class="op" id="5350349">+=</span>&nbsp;<span class="num" id="5350352">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5350355">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5350358">code</span>&nbsp;<span class="op" id="5350363">:=</span>&nbsp;<span class="builtintype" id="5350366">uint16</span><span class="op" id="5350372">(</span><span class="ident" id="5350373">d</span><span class="op" id="5350374">.</span><span class="ident" id="5350375">bits</span>&nbsp;<span class="op" id="5350380">&amp;</span>&nbsp;<span class="op" id="5350382">(</span><span class="num" id="5350383">1</span><span class="op" id="5350384">&lt;&lt;</span><span class="ident" id="5350386">d</span><span class="op" id="5350387">.</span><span class="ident" id="5350388">width</span>&nbsp;<span class="op" id="5350394">-</span>&nbsp;<span class="num" id="5350396">1</span><span class="op" id="5350397">)</span><span class="op" id="5350398">)</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5350401">d</span><span class="op" id="5350402">.</span><span class="ident" id="5350403">bits</span>&nbsp;<span class="op" id="5350408">&gt;&gt;=</span>&nbsp;<span class="ident" id="5350412">d</span><span class="op" id="5350413">.</span><span class="ident" id="5350414">width</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5350421">d</span><span class="op" id="5350422">.</span><span class="ident" id="5350423">nBits</span>&nbsp;<span class="op" id="5350429">-=</span>&nbsp;<span class="ident" id="5350432">d</span><span class="op" id="5350433">.</span><span class="ident" id="5350434">width</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5350441">return</span>&nbsp;<span class="ident" id="5350448">code</span><span class="op" id="5350452">,</span>&nbsp;<span class="ident" id="5350454">nil</span><br>
<span class="lineno"></span><span class="op" id="5350458">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">100</span><span class="comment" id="5350461">//&nbsp;readMSB&nbsp;returns&nbsp;the&nbsp;next&nbsp;code&nbsp;for&nbsp;&#34;Most&nbsp;Significant&nbsp;Bits&nbsp;first&#34;&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="5350534">func</span>&nbsp;<span class="op" id="5350539">(</span><span class="ident" id="5350540">d</span>&nbsp;<span class="op" id="5350542">*</span><span class="ident" id="5350543">decoder</span><span class="op" id="5350550">)</span>&nbsp;<span class="ident" id="5350552">readMSB</span><span class="op" id="5350559">(</span><span class="op" id="5350560">)</span>&nbsp;<span class="op" id="5350562">(</span><span class="builtintype" id="5350563">uint16</span><span class="op" id="5350569">,</span>&nbsp;<span class="builtintype" id="5350571">error</span><span class="op" id="5350576">)</span>&nbsp;<span class="op" id="5350578">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5350581">for</span>&nbsp;<span class="ident" id="5350585">d</span><span class="op" id="5350586">.</span><span class="ident" id="5350587">nBits</span>&nbsp;<span class="op" id="5350593">&lt;</span>&nbsp;<span class="ident" id="5350595">d</span><span class="op" id="5350596">.</span><span class="ident" id="5350597">width</span>&nbsp;<span class="op" id="5350603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5350607">x</span><span class="op" id="5350608">,</span>&nbsp;<span class="ident" id="5350610">err</span>&nbsp;<span class="op" id="5350614">:=</span>&nbsp;<span class="ident" id="5350617">d</span><span class="op" id="5350618">.</span><span class="ident" id="5350619">r</span><span class="op" id="5350620">.</span><span class="ident" id="5350621">ReadByte</span><span class="op" id="5350629">(</span><span class="op" id="5350630">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5350634">if</span>&nbsp;<span class="ident" id="5350637">err</span>&nbsp;<span class="op" id="5350641">!=</span>&nbsp;<span class="ident" id="5350644">nil</span>&nbsp;<span class="op" id="5350648">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5350653">return</span>&nbsp;<span class="num" id="5350660">0</span><span class="op" id="5350661">,</span>&nbsp;<span class="ident" id="5350663">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5350669">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5350673">d</span><span class="op" id="5350674">.</span><span class="ident" id="5350675">bits</span>&nbsp;<span class="op" id="5350680">|=</span>&nbsp;<span class="builtintype" id="5350683">uint32</span><span class="op" id="5350689">(</span><span class="ident" id="5350690">x</span><span class="op" id="5350691">)</span>&nbsp;<span class="op" id="5350693">&lt;&lt;</span>&nbsp;<span class="op" id="5350696">(</span><span class="num" id="5350697">24</span>&nbsp;<span class="op" id="5350700">-</span>&nbsp;<span class="ident" id="5350702">d</span><span class="op" id="5350703">.</span><span class="ident" id="5350704">nBits</span><span class="op" id="5350709">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5350713">d</span><span class="op" id="5350714">.</span><span class="ident" id="5350715">nBits</span>&nbsp;<span class="op" id="5350721">+=</span>&nbsp;<span class="num" id="5350724">8</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5350727">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5350730">code</span>&nbsp;<span class="op" id="5350735">:=</span>&nbsp;<span class="builtintype" id="5350738">uint16</span><span class="op" id="5350744">(</span><span class="ident" id="5350745">d</span><span class="op" id="5350746">.</span><span class="ident" id="5350747">bits</span>&nbsp;<span class="op" id="5350752">&gt;&gt;</span>&nbsp;<span class="op" id="5350755">(</span><span class="num" id="5350756">32</span>&nbsp;<span class="op" id="5350759">-</span>&nbsp;<span class="ident" id="5350761">d</span><span class="op" id="5350762">.</span><span class="ident" id="5350763">width</span><span class="op" id="5350768">)</span><span class="op" id="5350769">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5350772">d</span><span class="op" id="5350773">.</span><span class="ident" id="5350774">bits</span>&nbsp;<span class="op" id="5350779">&lt;&lt;=</span>&nbsp;<span class="ident" id="5350783">d</span><span class="op" id="5350784">.</span><span class="ident" id="5350785">width</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5350792">d</span><span class="op" id="5350793">.</span><span class="ident" id="5350794">nBits</span>&nbsp;<span class="op" id="5350800">-=</span>&nbsp;<span class="ident" id="5350803">d</span><span class="op" id="5350804">.</span><span class="ident" id="5350805">width</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5350812">return</span>&nbsp;<span class="ident" id="5350819">code</span><span class="op" id="5350823">,</span>&nbsp;<span class="ident" id="5350825">nil</span><br>
<span class="lineno"></span><span class="op" id="5350829">}</span><br>
<span class="lineno">115</span><br>
<span class="lineno"></span><span class="keyword" id="5350832">func</span>&nbsp;<span class="op" id="5350837">(</span><span class="ident" id="5350838">d</span>&nbsp;<span class="op" id="5350840">*</span><span class="ident" id="5350841">decoder</span><span class="op" id="5350848">)</span>&nbsp;<span class="ident" id="5350850">Read</span><span class="op" id="5350854">(</span><span class="ident" id="5350855">b</span>&nbsp;<span class="op" id="5350857">[</span><span class="op" id="5350858">]</span><span class="builtintype" id="5350859">byte</span><span class="op" id="5350863">)</span>&nbsp;<span class="op" id="5350865">(</span><span class="builtintype" id="5350866">int</span><span class="op" id="5350869">,</span>&nbsp;<span class="builtintype" id="5350871">error</span><span class="op" id="5350876">)</span>&nbsp;<span class="op" id="5350878">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5350881">for</span>&nbsp;<span class="op" id="5350885">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5350889">if</span>&nbsp;<span class="builtinfunc" id="5350892">len</span><span class="op" id="5350895">(</span><span class="ident" id="5350896">d</span><span class="op" id="5350897">.</span><span class="ident" id="5350898">toRead</span><span class="op" id="5350904">)</span>&nbsp;<span class="op" id="5350906">&gt;</span>&nbsp;<span class="num" id="5350908">0</span>&nbsp;<span class="op" id="5350910">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5350915">n</span>&nbsp;<span class="op" id="5350917">:=</span>&nbsp;<span class="builtinfunc" id="5350920">copy</span><span class="op" id="5350924">(</span><span class="ident" id="5350925">b</span><span class="op" id="5350926">,</span>&nbsp;<span class="ident" id="5350928">d</span><span class="op" id="5350929">.</span><span class="ident" id="5350930">toRead</span><span class="op" id="5350936">)</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5350941">d</span><span class="op" id="5350942">.</span><span class="ident" id="5350943">toRead</span>&nbsp;<span class="op" id="5350950">=</span>&nbsp;<span class="ident" id="5350952">d</span><span class="op" id="5350953">.</span><span class="ident" id="5350954">toRead</span><span class="op" id="5350960">[</span><span class="ident" id="5350961">n</span><span class="op" id="5350962">:</span><span class="op" id="5350963">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5350968">return</span>&nbsp;<span class="ident" id="5350975">n</span><span class="op" id="5350976">,</span>&nbsp;<span class="ident" id="5350978">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5350984">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5350988">if</span>&nbsp;<span class="ident" id="5350991">d</span><span class="op" id="5350992">.</span><span class="ident" id="5350993">err</span>&nbsp;<span class="op" id="5350997">!=</span>&nbsp;<span class="ident" id="5351000">nil</span>&nbsp;<span class="op" id="5351004">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5351009">return</span>&nbsp;<span class="num" id="5351016">0</span><span class="op" id="5351017">,</span>&nbsp;<span class="ident" id="5351019">d</span><span class="op" id="5351020">.</span><span class="ident" id="5351021">err</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5351027">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5351031">d</span><span class="op" id="5351032">.</span><span class="ident" id="5351033">decode</span><span class="op" id="5351039">(</span><span class="op" id="5351040">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5351043">}</span><br>
<span class="lineno"></span><span class="op" id="5351045">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="comment" id="5351048">//&nbsp;decode&nbsp;decompresses&nbsp;bytes&nbsp;from&nbsp;r&nbsp;and&nbsp;leaves&nbsp;them&nbsp;in&nbsp;d.toRead.</span><br>
<span class="lineno"></span><span class="comment" id="5351113">//&nbsp;read&nbsp;specifies&nbsp;how&nbsp;to&nbsp;decode&nbsp;bytes&nbsp;into&nbsp;codes.</span><br>
<span class="lineno"></span><span class="comment" id="5351163">//&nbsp;litWidth&nbsp;is&nbsp;the&nbsp;width&nbsp;in&nbsp;bits&nbsp;of&nbsp;literal&nbsp;codes.</span><br>
<span class="lineno"></span><span class="keyword" id="5351214">func</span>&nbsp;<span class="op" id="5351219">(</span><span class="ident" id="5351220">d</span>&nbsp;<span class="op" id="5351222">*</span><span class="ident" id="5351223">decoder</span><span class="op" id="5351230">)</span>&nbsp;<span class="ident" id="5351232">decode</span><span class="op" id="5351238">(</span><span class="op" id="5351239">)</span>&nbsp;<span class="op" id="5351241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5351244">//&nbsp;Loop&nbsp;over&nbsp;the&nbsp;code&nbsp;stream,&nbsp;converting&nbsp;codes&nbsp;into&nbsp;decompressed&nbsp;bytes.</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5351317">for</span>&nbsp;<span class="op" id="5351321">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5351325">code</span><span class="op" id="5351329">,</span>&nbsp;<span class="ident" id="5351331">err</span>&nbsp;<span class="op" id="5351335">:=</span>&nbsp;<span class="ident" id="5351338">d</span><span class="op" id="5351339">.</span><span class="ident" id="5351340">read</span><span class="op" id="5351344">(</span><span class="ident" id="5351345">d</span><span class="op" id="5351346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5351350">if</span>&nbsp;<span class="ident" id="5351353">err</span>&nbsp;<span class="op" id="5351357">!=</span>&nbsp;<span class="ident" id="5351360">nil</span>&nbsp;<span class="op" id="5351364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5351369">if</span>&nbsp;<span class="ident" id="5351372">err</span>&nbsp;<span class="op" id="5351376">==</span>&nbsp;<span class="ident" id="5351379">io</span><span class="op" id="5351381">.</span><span class="ident" id="5351382">EOF</span>&nbsp;<span class="op" id="5351386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5351392">err</span>&nbsp;<span class="op" id="5351396">=</span>&nbsp;<span class="ident" id="5351398">io</span><span class="op" id="5351400">.</span><span class="ident" id="5351401">ErrUnexpectedEOF</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5351421">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5351426">d</span><span class="op" id="5351427">.</span><span class="ident" id="5351428">err</span>&nbsp;<span class="op" id="5351432">=</span>&nbsp;<span class="ident" id="5351434">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5351441">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5351450">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5351454">switch</span>&nbsp;<span class="op" id="5351461">{</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5351465">case</span>&nbsp;<span class="ident" id="5351470">code</span>&nbsp;<span class="op" id="5351475">&lt;</span>&nbsp;<span class="ident" id="5351477">d</span><span class="op" id="5351478">.</span><span class="ident" id="5351479">clear</span><span class="op" id="5351484">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5351489">//&nbsp;We&nbsp;have&nbsp;a&nbsp;literal&nbsp;code.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5351519">d</span><span class="op" id="5351520">.</span><span class="ident" id="5351521">output</span><span class="op" id="5351527">[</span><span class="ident" id="5351528">d</span><span class="op" id="5351529">.</span><span class="ident" id="5351530">o</span><span class="op" id="5351531">]</span>&nbsp;<span class="op" id="5351533">=</span>&nbsp;<span class="builtintype" id="5351535">uint8</span><span class="op" id="5351540">(</span><span class="ident" id="5351541">code</span><span class="op" id="5351545">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5351550">d</span><span class="op" id="5351551">.</span><span class="ident" id="5351552">o</span><span class="op" id="5351553">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5351559">if</span>&nbsp;<span class="ident" id="5351562">d</span><span class="op" id="5351563">.</span><span class="ident" id="5351564">last</span>&nbsp;<span class="op" id="5351569">!=</span>&nbsp;<span class="ident" id="5351572">decoderInvalidCode</span>&nbsp;<span class="op" id="5351591">{</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5351597">//&nbsp;Save&nbsp;what&nbsp;the&nbsp;hi&nbsp;code&nbsp;expands&nbsp;to.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5351638">d</span><span class="op" id="5351639">.</span><span class="ident" id="5351640">suffix</span><span class="op" id="5351646">[</span><span class="ident" id="5351647">d</span><span class="op" id="5351648">.</span><span class="ident" id="5351649">hi</span><span class="op" id="5351651">]</span>&nbsp;<span class="op" id="5351653">=</span>&nbsp;<span class="builtintype" id="5351655">uint8</span><span class="op" id="5351660">(</span><span class="ident" id="5351661">code</span><span class="op" id="5351665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5351671">d</span><span class="op" id="5351672">.</span><span class="ident" id="5351673">prefix</span><span class="op" id="5351679">[</span><span class="ident" id="5351680">d</span><span class="op" id="5351681">.</span><span class="ident" id="5351682">hi</span><span class="op" id="5351684">]</span>&nbsp;<span class="op" id="5351686">=</span>&nbsp;<span class="ident" id="5351688">d</span><span class="op" id="5351689">.</span><span class="ident" id="5351690">last</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5351698">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5351702">case</span>&nbsp;<span class="ident" id="5351707">code</span>&nbsp;<span class="op" id="5351712">==</span>&nbsp;<span class="ident" id="5351715">d</span><span class="op" id="5351716">.</span><span class="ident" id="5351717">clear</span><span class="op" id="5351722">:</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5351727">d</span><span class="op" id="5351728">.</span><span class="ident" id="5351729">width</span>&nbsp;<span class="op" id="5351735">=</span>&nbsp;<span class="num" id="5351737">1</span>&nbsp;<span class="op" id="5351739">+</span>&nbsp;<span class="builtintype" id="5351741">uint</span><span class="op" id="5351745">(</span><span class="ident" id="5351746">d</span><span class="op" id="5351747">.</span><span class="ident" id="5351748">litWidth</span><span class="op" id="5351756">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5351761">d</span><span class="op" id="5351762">.</span><span class="ident" id="5351763">hi</span>&nbsp;<span class="op" id="5351766">=</span>&nbsp;<span class="ident" id="5351768">d</span><span class="op" id="5351769">.</span><span class="ident" id="5351770">eof</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5351777">d</span><span class="op" id="5351778">.</span><span class="ident" id="5351779">overflow</span>&nbsp;<span class="op" id="5351788">=</span>&nbsp;<span class="num" id="5351790">1</span>&nbsp;<span class="op" id="5351792">&lt;&lt;</span>&nbsp;<span class="ident" id="5351795">d</span><span class="op" id="5351796">.</span><span class="ident" id="5351797">width</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5351806">d</span><span class="op" id="5351807">.</span><span class="ident" id="5351808">last</span>&nbsp;<span class="op" id="5351813">=</span>&nbsp;<span class="ident" id="5351815">decoderInvalidCode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5351837">continue</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5351848">case</span>&nbsp;<span class="ident" id="5351853">code</span>&nbsp;<span class="op" id="5351858">==</span>&nbsp;<span class="ident" id="5351861">d</span><span class="op" id="5351862">.</span><span class="ident" id="5351863">eof</span><span class="op" id="5351866">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5351871">d</span><span class="op" id="5351872">.</span><span class="ident" id="5351873">flush</span><span class="op" id="5351878">(</span><span class="op" id="5351879">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5351884">d</span><span class="op" id="5351885">.</span><span class="ident" id="5351886">err</span>&nbsp;<span class="op" id="5351890">=</span>&nbsp;<span class="ident" id="5351892">io</span><span class="op" id="5351894">.</span><span class="ident" id="5351895">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5351902">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5351911">case</span>&nbsp;<span class="ident" id="5351916">code</span>&nbsp;<span class="op" id="5351921">&lt;=</span>&nbsp;<span class="ident" id="5351924">d</span><span class="op" id="5351925">.</span><span class="ident" id="5351926">hi</span><span class="op" id="5351928">:</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5351933">c</span><span class="op" id="5351934">,</span>&nbsp;<span class="ident" id="5351936">i</span>&nbsp;<span class="op" id="5351938">:=</span>&nbsp;<span class="ident" id="5351941">code</span><span class="op" id="5351945">,</span>&nbsp;<span class="builtinfunc" id="5351947">len</span><span class="op" id="5351950">(</span><span class="ident" id="5351951">d</span><span class="op" id="5351952">.</span><span class="ident" id="5351953">output</span><span class="op" id="5351959">)</span><span class="op" id="5351960">-</span><span class="num" id="5351961">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5351966">if</span>&nbsp;<span class="ident" id="5351969">code</span>&nbsp;<span class="op" id="5351974">==</span>&nbsp;<span class="ident" id="5351977">d</span><span class="op" id="5351978">.</span><span class="ident" id="5351979">hi</span>&nbsp;<span class="op" id="5351982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5351988">//&nbsp;code&nbsp;==&nbsp;hi&nbsp;is&nbsp;a&nbsp;special&nbsp;case&nbsp;which&nbsp;expands&nbsp;to&nbsp;the&nbsp;last&nbsp;expansion</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5352060">//&nbsp;followed&nbsp;by&nbsp;the&nbsp;head&nbsp;of&nbsp;the&nbsp;last&nbsp;expansion.&nbsp;To&nbsp;find&nbsp;the&nbsp;head,&nbsp;we&nbsp;walk</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5352137">//&nbsp;the&nbsp;prefix&nbsp;chain&nbsp;until&nbsp;we&nbsp;find&nbsp;a&nbsp;literal&nbsp;code.</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5352191">c</span>&nbsp;<span class="op" id="5352193">=</span>&nbsp;<span class="ident" id="5352195">d</span><span class="op" id="5352196">.</span><span class="ident" id="5352197">last</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5352206">for</span>&nbsp;<span class="ident" id="5352210">c</span>&nbsp;<span class="op" id="5352212">&gt;=</span>&nbsp;<span class="ident" id="5352215">d</span><span class="op" id="5352216">.</span><span class="ident" id="5352217">clear</span>&nbsp;<span class="op" id="5352223">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5352230">c</span>&nbsp;<span class="op" id="5352232">=</span>&nbsp;<span class="ident" id="5352234">d</span><span class="op" id="5352235">.</span><span class="ident" id="5352236">prefix</span><span class="op" id="5352242">[</span><span class="ident" id="5352243">c</span><span class="op" id="5352244">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5352250">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5352256">d</span><span class="op" id="5352257">.</span><span class="ident" id="5352258">output</span><span class="op" id="5352264">[</span><span class="ident" id="5352265">i</span><span class="op" id="5352266">]</span>&nbsp;<span class="op" id="5352268">=</span>&nbsp;<span class="builtintype" id="5352270">uint8</span><span class="op" id="5352275">(</span><span class="ident" id="5352276">c</span><span class="op" id="5352277">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5352283">i</span><span class="op" id="5352284">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5352291">c</span>&nbsp;<span class="op" id="5352293">=</span>&nbsp;<span class="ident" id="5352295">d</span><span class="op" id="5352296">.</span><span class="ident" id="5352297">last</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5352305">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5352310">//&nbsp;Copy&nbsp;the&nbsp;suffix&nbsp;chain&nbsp;into&nbsp;output&nbsp;and&nbsp;then&nbsp;write&nbsp;that&nbsp;to&nbsp;w.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5352376">for</span>&nbsp;<span class="ident" id="5352380">c</span>&nbsp;<span class="op" id="5352382">&gt;=</span>&nbsp;<span class="ident" id="5352385">d</span><span class="op" id="5352386">.</span><span class="ident" id="5352387">clear</span>&nbsp;<span class="op" id="5352393">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5352399">d</span><span class="op" id="5352400">.</span><span class="ident" id="5352401">output</span><span class="op" id="5352407">[</span><span class="ident" id="5352408">i</span><span class="op" id="5352409">]</span>&nbsp;<span class="op" id="5352411">=</span>&nbsp;<span class="ident" id="5352413">d</span><span class="op" id="5352414">.</span><span class="ident" id="5352415">suffix</span><span class="op" id="5352421">[</span><span class="ident" id="5352422">c</span><span class="op" id="5352423">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5352429">i</span><span class="op" id="5352430">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5352437">c</span>&nbsp;<span class="op" id="5352439">=</span>&nbsp;<span class="ident" id="5352441">d</span><span class="op" id="5352442">.</span><span class="ident" id="5352443">prefix</span><span class="op" id="5352449">[</span><span class="ident" id="5352450">c</span><span class="op" id="5352451">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5352456">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5352461">d</span><span class="op" id="5352462">.</span><span class="ident" id="5352463">output</span><span class="op" id="5352469">[</span><span class="ident" id="5352470">i</span><span class="op" id="5352471">]</span>&nbsp;<span class="op" id="5352473">=</span>&nbsp;<span class="builtintype" id="5352475">uint8</span><span class="op" id="5352480">(</span><span class="ident" id="5352481">c</span><span class="op" id="5352482">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5352487">d</span><span class="op" id="5352488">.</span><span class="ident" id="5352489">o</span>&nbsp;<span class="op" id="5352491">+=</span>&nbsp;<span class="builtinfunc" id="5352494">copy</span><span class="op" id="5352498">(</span><span class="ident" id="5352499">d</span><span class="op" id="5352500">.</span><span class="ident" id="5352501">output</span><span class="op" id="5352507">[</span><span class="ident" id="5352508">d</span><span class="op" id="5352509">.</span><span class="ident" id="5352510">o</span><span class="op" id="5352511">:</span><span class="op" id="5352512">]</span><span class="op" id="5352513">,</span>&nbsp;<span class="ident" id="5352515">d</span><span class="op" id="5352516">.</span><span class="ident" id="5352517">output</span><span class="op" id="5352523">[</span><span class="ident" id="5352524">i</span><span class="op" id="5352525">:</span><span class="op" id="5352526">]</span><span class="op" id="5352527">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5352532">if</span>&nbsp;<span class="ident" id="5352535">d</span><span class="op" id="5352536">.</span><span class="ident" id="5352537">last</span>&nbsp;<span class="op" id="5352542">!=</span>&nbsp;<span class="ident" id="5352545">decoderInvalidCode</span>&nbsp;<span class="op" id="5352564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="5352570">//&nbsp;Save&nbsp;what&nbsp;the&nbsp;hi&nbsp;code&nbsp;expands&nbsp;to.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5352611">d</span><span class="op" id="5352612">.</span><span class="ident" id="5352613">suffix</span><span class="op" id="5352619">[</span><span class="ident" id="5352620">d</span><span class="op" id="5352621">.</span><span class="ident" id="5352622">hi</span><span class="op" id="5352624">]</span>&nbsp;<span class="op" id="5352626">=</span>&nbsp;<span class="builtintype" id="5352628">uint8</span><span class="op" id="5352633">(</span><span class="ident" id="5352634">c</span><span class="op" id="5352635">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5352641">d</span><span class="op" id="5352642">.</span><span class="ident" id="5352643">prefix</span><span class="op" id="5352649">[</span><span class="ident" id="5352650">d</span><span class="op" id="5352651">.</span><span class="ident" id="5352652">hi</span><span class="op" id="5352654">]</span>&nbsp;<span class="op" id="5352656">=</span>&nbsp;<span class="ident" id="5352658">d</span><span class="op" id="5352659">.</span><span class="ident" id="5352660">last</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5352668">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5352672">default</span><span class="op" id="5352679">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5352684">d</span><span class="op" id="5352685">.</span><span class="ident" id="5352686">err</span>&nbsp;<span class="op" id="5352690">=</span>&nbsp;<span class="ident" id="5352692">errors</span><span class="op" id="5352698">.</span><span class="ident" id="5352699">New</span><span class="op" id="5352702">(</span><span class="string" id="5352703">&#34;lzw:&nbsp;invalid&nbsp;code&#34;</span><span class="op" id="5352722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5352727">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5352736">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5352740">d</span><span class="op" id="5352741">.</span><span class="ident" id="5352742">last</span><span class="op" id="5352746">,</span>&nbsp;<span class="ident" id="5352748">d</span><span class="op" id="5352749">.</span><span class="ident" id="5352750">hi</span>&nbsp;<span class="op" id="5352753">=</span>&nbsp;<span class="ident" id="5352755">code</span><span class="op" id="5352759">,</span>&nbsp;<span class="ident" id="5352761">d</span><span class="op" id="5352762">.</span><span class="ident" id="5352763">hi</span><span class="op" id="5352765">+</span><span class="num" id="5352766">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5352770">if</span>&nbsp;<span class="ident" id="5352773">d</span><span class="op" id="5352774">.</span><span class="ident" id="5352775">hi</span>&nbsp;<span class="op" id="5352778">&gt;=</span>&nbsp;<span class="ident" id="5352781">d</span><span class="op" id="5352782">.</span><span class="ident" id="5352783">overflow</span>&nbsp;<span class="op" id="5352792">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5352797">if</span>&nbsp;<span class="ident" id="5352800">d</span><span class="op" id="5352801">.</span><span class="ident" id="5352802">width</span>&nbsp;<span class="op" id="5352808">==</span>&nbsp;<span class="ident" id="5352811">maxWidth</span>&nbsp;<span class="op" id="5352820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5352826">d</span><span class="op" id="5352827">.</span><span class="ident" id="5352828">last</span>&nbsp;<span class="op" id="5352833">=</span>&nbsp;<span class="ident" id="5352835">decoderInvalidCode</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5352857">}</span>&nbsp;<span class="keyword" id="5352859">else</span>&nbsp;<span class="op" id="5352864">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5352870">d</span><span class="op" id="5352871">.</span><span class="ident" id="5352872">width</span><span class="op" id="5352877">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5352884">d</span><span class="op" id="5352885">.</span><span class="ident" id="5352886">overflow</span>&nbsp;<span class="op" id="5352895">&lt;&lt;=</span>&nbsp;<span class="num" id="5352899">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5352904">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5352908">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5352912">if</span>&nbsp;<span class="ident" id="5352915">d</span><span class="op" id="5352916">.</span><span class="ident" id="5352917">o</span>&nbsp;<span class="op" id="5352919">&gt;=</span>&nbsp;<span class="ident" id="5352922">flushBuffer</span>&nbsp;<span class="op" id="5352934">{</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5352939">d</span><span class="op" id="5352940">.</span><span class="ident" id="5352941">flush</span><span class="op" id="5352946">(</span><span class="op" id="5352947">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5352952">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5352961">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5352964">}</span><br>
<span class="lineno"></span><span class="op" id="5352966">}</span><br>
<span class="lineno">210</span><br>
<span class="lineno"></span><span class="keyword" id="5352969">func</span>&nbsp;<span class="op" id="5352974">(</span><span class="ident" id="5352975">d</span>&nbsp;<span class="op" id="5352977">*</span><span class="ident" id="5352978">decoder</span><span class="op" id="5352985">)</span>&nbsp;<span class="ident" id="5352987">flush</span><span class="op" id="5352992">(</span><span class="op" id="5352993">)</span>&nbsp;<span class="op" id="5352995">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5352998">d</span><span class="op" id="5352999">.</span><span class="ident" id="5353000">toRead</span>&nbsp;<span class="op" id="5353007">=</span>&nbsp;<span class="ident" id="5353009">d</span><span class="op" id="5353010">.</span><span class="ident" id="5353011">output</span><span class="op" id="5353017">[</span><span class="op" id="5353018">:</span><span class="ident" id="5353019">d</span><span class="op" id="5353020">.</span><span class="ident" id="5353021">o</span><span class="op" id="5353022">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5353025">d</span><span class="op" id="5353026">.</span><span class="ident" id="5353027">o</span>&nbsp;<span class="op" id="5353029">=</span>&nbsp;<span class="num" id="5353031">0</span><br>
<span class="lineno"></span><span class="op" id="5353033">}</span><br>
<span class="lineno">215</span><br>
<span class="lineno"></span><span class="keyword" id="5353036">var</span>&nbsp;<span class="ident" id="5353040">errClosed</span>&nbsp;<span class="op" id="5353050">=</span>&nbsp;<span class="ident" id="5353052">errors</span><span class="op" id="5353058">.</span><span class="ident" id="5353059">New</span><span class="op" id="5353062">(</span><span class="string" id="5353063">&#34;compress/lzw:&nbsp;reader/writer&nbsp;is&nbsp;closed&#34;</span><span class="op" id="5353102">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="5353105">func</span>&nbsp;<span class="op" id="5353110">(</span><span class="ident" id="5353111">d</span>&nbsp;<span class="op" id="5353113">*</span><span class="ident" id="5353114">decoder</span><span class="op" id="5353121">)</span>&nbsp;<span class="ident" id="5353123">Close</span><span class="op" id="5353128">(</span><span class="op" id="5353129">)</span>&nbsp;<span class="builtintype" id="5353131">error</span>&nbsp;<span class="op" id="5353137">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5353140">d</span><span class="op" id="5353141">.</span><span class="ident" id="5353142">err</span>&nbsp;<span class="op" id="5353146">=</span>&nbsp;<span class="ident" id="5353148">errClosed</span>&nbsp;<span class="comment" id="5353158">//&nbsp;in&nbsp;case&nbsp;any&nbsp;Reads&nbsp;come&nbsp;along</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5353191">return</span>&nbsp;<span class="ident" id="5353198">nil</span><br>
<span class="lineno"></span><span class="op" id="5353202">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="5353205">//&nbsp;NewReader&nbsp;creates&nbsp;a&nbsp;new&nbsp;io.ReadCloser.</span><br>
<span class="lineno"></span><span class="comment" id="5353247">//&nbsp;Reads&nbsp;from&nbsp;the&nbsp;returned&nbsp;io.ReadCloser&nbsp;read&nbsp;and&nbsp;decompress&nbsp;data&nbsp;from&nbsp;r.</span><br>
<span class="lineno">225</span><span class="comment" id="5353321">//&nbsp;If&nbsp;r&nbsp;does&nbsp;not&nbsp;also&nbsp;implement&nbsp;io.ByteReader,</span><br>
<span class="lineno"></span><span class="comment" id="5353368">//&nbsp;the&nbsp;decompressor&nbsp;may&nbsp;read&nbsp;more&nbsp;data&nbsp;than&nbsp;necessary&nbsp;from&nbsp;r.</span><br>
<span class="lineno"></span><span class="comment" id="5353430">//&nbsp;It&nbsp;is&nbsp;the&nbsp;caller&#39;s&nbsp;responsibility&nbsp;to&nbsp;call&nbsp;Close&nbsp;on&nbsp;the&nbsp;ReadCloser&nbsp;when</span><br>
<span class="lineno"></span><span class="comment" id="5353504">//&nbsp;finished&nbsp;reading.</span><br>
<span class="lineno"></span><span class="comment" id="5353525">//&nbsp;The&nbsp;number&nbsp;of&nbsp;bits&nbsp;to&nbsp;use&nbsp;for&nbsp;literal&nbsp;codes,&nbsp;litWidth,&nbsp;must&nbsp;be&nbsp;in&nbsp;the</span><br>
<span class="lineno">230</span><span class="comment" id="5353598">//&nbsp;range&nbsp;[2,8]&nbsp;and&nbsp;is&nbsp;typically&nbsp;8.</span><br>
<span class="lineno"></span><span class="keyword" id="5353633">func</span>&nbsp;<span class="ident" id="5353638">NewReader</span><span class="op" id="5353647">(</span><span class="ident" id="5353648">r</span>&nbsp;<span class="ident" id="5353650">io</span><span class="op" id="5353652">.</span><span class="ident" id="5353653">Reader</span><span class="op" id="5353659">,</span>&nbsp;<span class="ident" id="5353661">order</span>&nbsp;<span class="ident" id="5353667">Order</span><span class="op" id="5353672">,</span>&nbsp;<span class="ident" id="5353674">litWidth</span>&nbsp;<span class="builtintype" id="5353683">int</span><span class="op" id="5353686">)</span>&nbsp;<span class="ident" id="5353688">io</span><span class="op" id="5353690">.</span><span class="ident" id="5353691">ReadCloser</span>&nbsp;<span class="op" id="5353702">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5353705">d</span>&nbsp;<span class="op" id="5353707">:=</span>&nbsp;<span class="builtinfunc" id="5353710">new</span><span class="op" id="5353713">(</span><span class="ident" id="5353714">decoder</span><span class="op" id="5353721">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5353724">switch</span>&nbsp;<span class="ident" id="5353731">order</span>&nbsp;<span class="op" id="5353737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5353740">case</span>&nbsp;<span class="ident" id="5353745">LSB</span><span class="op" id="5353748">:</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5353752">d</span><span class="op" id="5353753">.</span><span class="ident" id="5353754">read</span>&nbsp;<span class="op" id="5353759">=</span>&nbsp;<span class="op" id="5353761">(</span><span class="op" id="5353762">*</span><span class="ident" id="5353763">decoder</span><span class="op" id="5353770">)</span><span class="op" id="5353771">.</span><span class="ident" id="5353772">readLSB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5353781">case</span>&nbsp;<span class="ident" id="5353786">MSB</span><span class="op" id="5353789">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5353793">d</span><span class="op" id="5353794">.</span><span class="ident" id="5353795">read</span>&nbsp;<span class="op" id="5353800">=</span>&nbsp;<span class="op" id="5353802">(</span><span class="op" id="5353803">*</span><span class="ident" id="5353804">decoder</span><span class="op" id="5353811">)</span><span class="op" id="5353812">.</span><span class="ident" id="5353813">readMSB</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5353822">default</span><span class="op" id="5353829">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5353833">d</span><span class="op" id="5353834">.</span><span class="ident" id="5353835">err</span>&nbsp;<span class="op" id="5353839">=</span>&nbsp;<span class="ident" id="5353841">errors</span><span class="op" id="5353847">.</span><span class="ident" id="5353848">New</span><span class="op" id="5353851">(</span><span class="string" id="5353852">&#34;lzw:&nbsp;unknown&nbsp;order&#34;</span><span class="op" id="5353872">)</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5353876">return</span>&nbsp;<span class="ident" id="5353883">d</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5353886">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5353889">if</span>&nbsp;<span class="ident" id="5353892">litWidth</span>&nbsp;<span class="op" id="5353901">&lt;</span>&nbsp;<span class="num" id="5353903">2</span>&nbsp;<span class="op" id="5353905">||</span>&nbsp;<span class="num" id="5353908">8</span>&nbsp;<span class="op" id="5353910">&lt;</span>&nbsp;<span class="ident" id="5353912">litWidth</span>&nbsp;<span class="op" id="5353921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5353925">d</span><span class="op" id="5353926">.</span><span class="ident" id="5353927">err</span>&nbsp;<span class="op" id="5353931">=</span>&nbsp;<span class="ident" id="5353933">fmt</span><span class="op" id="5353936">.</span><span class="ident" id="5353937">Errorf</span><span class="op" id="5353943">(</span><span class="string" id="5353944">&#34;lzw:&nbsp;litWidth&nbsp;%d&nbsp;out&nbsp;of&nbsp;range&#34;</span><span class="op" id="5353975">,</span>&nbsp;<span class="ident" id="5353977">litWidth</span><span class="op" id="5353985">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5353989">return</span>&nbsp;<span class="ident" id="5353996">d</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5353999">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5354002">if</span>&nbsp;<span class="ident" id="5354005">br</span><span class="op" id="5354007">,</span>&nbsp;<span class="ident" id="5354009">ok</span>&nbsp;<span class="op" id="5354012">:=</span>&nbsp;<span class="ident" id="5354015">r</span><span class="op" id="5354016">.</span><span class="op" id="5354017">(</span><span class="ident" id="5354018">io</span><span class="op" id="5354020">.</span><span class="ident" id="5354021">ByteReader</span><span class="op" id="5354031">)</span><span class="op" id="5354032">;</span>&nbsp;<span class="ident" id="5354034">ok</span>&nbsp;<span class="op" id="5354037">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5354041">d</span><span class="op" id="5354042">.</span><span class="ident" id="5354043">r</span>&nbsp;<span class="op" id="5354045">=</span>&nbsp;<span class="ident" id="5354047">br</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5354051">}</span>&nbsp;<span class="keyword" id="5354053">else</span>&nbsp;<span class="op" id="5354058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5354062">d</span><span class="op" id="5354063">.</span><span class="ident" id="5354064">r</span>&nbsp;<span class="op" id="5354066">=</span>&nbsp;<span class="ident" id="5354068">bufio</span><span class="op" id="5354073">.</span><span class="ident" id="5354074">NewReader</span><span class="op" id="5354083">(</span><span class="ident" id="5354084">r</span><span class="op" id="5354085">)</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="5354088">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5354091">d</span><span class="op" id="5354092">.</span><span class="ident" id="5354093">litWidth</span>&nbsp;<span class="op" id="5354102">=</span>&nbsp;<span class="ident" id="5354104">litWidth</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5354114">d</span><span class="op" id="5354115">.</span><span class="ident" id="5354116">width</span>&nbsp;<span class="op" id="5354122">=</span>&nbsp;<span class="num" id="5354124">1</span>&nbsp;<span class="op" id="5354126">+</span>&nbsp;<span class="builtintype" id="5354128">uint</span><span class="op" id="5354132">(</span><span class="ident" id="5354133">litWidth</span><span class="op" id="5354141">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5354144">d</span><span class="op" id="5354145">.</span><span class="ident" id="5354146">clear</span>&nbsp;<span class="op" id="5354152">=</span>&nbsp;<span class="builtintype" id="5354154">uint16</span><span class="op" id="5354160">(</span><span class="num" id="5354161">1</span><span class="op" id="5354162">)</span>&nbsp;<span class="op" id="5354164">&lt;&lt;</span>&nbsp;<span class="builtintype" id="5354167">uint</span><span class="op" id="5354171">(</span><span class="ident" id="5354172">litWidth</span><span class="op" id="5354180">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5354183">d</span><span class="op" id="5354184">.</span><span class="ident" id="5354185">eof</span><span class="op" id="5354188">,</span>&nbsp;<span class="ident" id="5354190">d</span><span class="op" id="5354191">.</span><span class="ident" id="5354192">hi</span>&nbsp;<span class="op" id="5354195">=</span>&nbsp;<span class="ident" id="5354197">d</span><span class="op" id="5354198">.</span><span class="ident" id="5354199">clear</span><span class="op" id="5354204">+</span><span class="num" id="5354205">1</span><span class="op" id="5354206">,</span>&nbsp;<span class="ident" id="5354208">d</span><span class="op" id="5354209">.</span><span class="ident" id="5354210">clear</span><span class="op" id="5354215">+</span><span class="num" id="5354216">1</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5354219">d</span><span class="op" id="5354220">.</span><span class="ident" id="5354221">overflow</span>&nbsp;<span class="op" id="5354230">=</span>&nbsp;<span class="builtintype" id="5354232">uint16</span><span class="op" id="5354238">(</span><span class="num" id="5354239">1</span><span class="op" id="5354240">)</span>&nbsp;<span class="op" id="5354242">&lt;&lt;</span>&nbsp;<span class="ident" id="5354245">d</span><span class="op" id="5354246">.</span><span class="ident" id="5354247">width</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="5354254">d</span><span class="op" id="5354255">.</span><span class="ident" id="5354256">last</span>&nbsp;<span class="op" id="5354261">=</span>&nbsp;<span class="ident" id="5354263">decoderInvalidCode</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="5354284">return</span>&nbsp;<span class="ident" id="5354291">d</span><br>
<span class="lineno"></span><span class="op" id="5354293">}</span>
</div>
</body>
</html>
