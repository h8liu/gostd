<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/tls</h2>
<ul>
<li><a href="/gostd/crypto/tls/alert.go.html">alert.go</a></li>
<li><a href="/gostd/crypto/tls/cipher_suites.go.html">cipher_suites.go</a></li>
<li><a href="/gostd/crypto/tls/common.go.html">common.go</a></li>
<li><a href="/gostd/crypto/tls/conn.go.html">conn.go</a></li>
<li><a href="/gostd/crypto/tls/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/crypto/tls/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client.go.html">handshake_client.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_client_test.go.html">handshake_client_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages.go.html">handshake_messages.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_messages_test.go.html">handshake_messages_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server.go.html">handshake_server.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_server_test.go.html">handshake_server_test.go</a></li>
<li><a href="/gostd/crypto/tls/handshake_test.go.html">handshake_test.go</a></li>
<li><a href="/gostd/crypto/tls/key_agreement.go.html">key_agreement.go</a></li>
<li><a href="/gostd/crypto/tls/prf.go.html">prf.go</a></li>
<li><a href="/gostd/crypto/tls/prf_test.go.html">prf_test.go</a></li>
<li><a href="/gostd/crypto/tls/ticket.go.html">ticket.go</a></li>
<li><a href="/gostd/crypto/tls/tls.go.html">tls.go</a></li>
<li><a href="/gostd/crypto/tls/tls_test.go.html">tls_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4117670">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4117725">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4117779">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="4117830">package</span>&nbsp;<span class="ident" id="4117838">tls</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4117843">import</span>&nbsp;<span class="op" id="4117850">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4117853">&#34;bytes&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4117862">&#34;crypto&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4117872">&#34;crypto/ecdsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4117888">&#34;crypto/rsa&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4117902">&#34;crypto/subtle&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4117919">&#34;crypto/x509&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4117934">&#34;errors&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4117944">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4117951">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4117957">&#34;net&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4117964">&#34;strconv&#34;</span><br>
<span class="lineno"></span><span class="op" id="4117974">)</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="4117977">type</span>&nbsp;<span class="ident" id="4117982">clientHandshakeState</span>&nbsp;<span class="keyword" id="4118003">struct</span>&nbsp;<span class="op" id="4118010">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4118013">c</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4118026">*</span><span class="ident" id="4118027">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4118033">serverHello</span>&nbsp;&nbsp;<span class="op" id="4118046">*</span><span class="ident" id="4118047">serverHelloMsg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4118063">hello</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4118076">*</span><span class="ident" id="4118077">clientHelloMsg</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4118093">suite</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4118106">*</span><span class="ident" id="4118107">cipherSuite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4118120">finishedHash</span>&nbsp;<span class="ident" id="4118133">finishedHash</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4118147">masterSecret</span>&nbsp;<span class="op" id="4118160">[</span><span class="op" id="4118161">]</span><span class="builtintype" id="4118162">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4118168">session</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4118181">*</span><span class="ident" id="4118182">ClientSessionState</span><br>
<span class="lineno"></span><span class="op" id="4118201">}</span><br>
<span class="lineno">30</span><br>
<span class="lineno"></span><span class="keyword" id="4118204">func</span>&nbsp;<span class="op" id="4118209">(</span><span class="ident" id="4118210">c</span>&nbsp;<span class="op" id="4118212">*</span><span class="ident" id="4118213">Conn</span><span class="op" id="4118217">)</span>&nbsp;<span class="ident" id="4118219">clientHandshake</span><span class="op" id="4118234">(</span><span class="op" id="4118235">)</span>&nbsp;<span class="builtintype" id="4118237">error</span>&nbsp;<span class="op" id="4118243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4118246">if</span>&nbsp;<span class="ident" id="4118249">c</span><span class="op" id="4118250">.</span><span class="ident" id="4118251">config</span>&nbsp;<span class="op" id="4118258">==</span>&nbsp;<span class="ident" id="4118261">nil</span>&nbsp;<span class="op" id="4118265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4118269">c</span><span class="op" id="4118270">.</span><span class="ident" id="4118271">config</span>&nbsp;<span class="op" id="4118278">=</span>&nbsp;<span class="ident" id="4118280">defaultConfig</span><span class="op" id="4118293">(</span><span class="op" id="4118294">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4118297">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4118301">if</span>&nbsp;<span class="builtinfunc" id="4118304">len</span><span class="op" id="4118307">(</span><span class="ident" id="4118308">c</span><span class="op" id="4118309">.</span><span class="ident" id="4118310">config</span><span class="op" id="4118316">.</span><span class="ident" id="4118317">ServerName</span><span class="op" id="4118327">)</span>&nbsp;<span class="op" id="4118329">==</span>&nbsp;<span class="num" id="4118332">0</span>&nbsp;<span class="op" id="4118334">&amp;&amp;</span>&nbsp;<span class="op" id="4118337">!</span><span class="ident" id="4118338">c</span><span class="op" id="4118339">.</span><span class="ident" id="4118340">config</span><span class="op" id="4118346">.</span><span class="ident" id="4118347">InsecureSkipVerify</span>&nbsp;<span class="op" id="4118366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4118370">return</span>&nbsp;<span class="ident" id="4118377">errors</span><span class="op" id="4118383">.</span><span class="ident" id="4118384">New</span><span class="op" id="4118387">(</span><span class="string" id="4118388">&#34;tls:&nbsp;either&nbsp;ServerName&nbsp;or&nbsp;InsecureSkipVerify&nbsp;must&nbsp;be&nbsp;specified&nbsp;in&nbsp;the&nbsp;tls.Config&#34;</span><span class="op" id="4118470">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4118473">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4118477">nextProtosLength</span>&nbsp;<span class="op" id="4118494">:=</span>&nbsp;<span class="num" id="4118497">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4118500">for</span>&nbsp;<span class="ident" id="4118504">_</span><span class="op" id="4118505">,</span>&nbsp;<span class="ident" id="4118507">proto</span>&nbsp;<span class="op" id="4118513">:=</span>&nbsp;<span class="keyword" id="4118516">range</span>&nbsp;<span class="ident" id="4118522">c</span><span class="op" id="4118523">.</span><span class="ident" id="4118524">config</span><span class="op" id="4118530">.</span><span class="ident" id="4118531">NextProtos</span>&nbsp;<span class="op" id="4118542">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4118546">if</span>&nbsp;<span class="ident" id="4118549">l</span>&nbsp;<span class="op" id="4118551">:=</span>&nbsp;<span class="builtinfunc" id="4118554">len</span><span class="op" id="4118557">(</span><span class="ident" id="4118558">proto</span><span class="op" id="4118563">)</span><span class="op" id="4118564">;</span>&nbsp;<span class="ident" id="4118566">l</span>&nbsp;<span class="op" id="4118568">==</span>&nbsp;<span class="num" id="4118571">0</span>&nbsp;<span class="op" id="4118573">||</span>&nbsp;<span class="ident" id="4118576">l</span>&nbsp;<span class="op" id="4118578">&gt;</span>&nbsp;<span class="num" id="4118580">255</span>&nbsp;<span class="op" id="4118584">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4118589">return</span>&nbsp;<span class="ident" id="4118596">errors</span><span class="op" id="4118602">.</span><span class="ident" id="4118603">New</span><span class="op" id="4118606">(</span><span class="string" id="4118607">&#34;tls:&nbsp;invalid&nbsp;NextProtos&nbsp;value&#34;</span><span class="op" id="4118638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4118642">}</span>&nbsp;<span class="keyword" id="4118644">else</span>&nbsp;<span class="op" id="4118649">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4118654">nextProtosLength</span>&nbsp;<span class="op" id="4118671">+=</span>&nbsp;<span class="num" id="4118674">1</span>&nbsp;<span class="op" id="4118676">+</span>&nbsp;<span class="ident" id="4118678">l</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4118682">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4118685">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4118688">if</span>&nbsp;<span class="ident" id="4118691">nextProtosLength</span>&nbsp;<span class="op" id="4118708">&gt;</span>&nbsp;<span class="num" id="4118710">0xffff</span>&nbsp;<span class="op" id="4118717">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4118721">return</span>&nbsp;<span class="ident" id="4118728">errors</span><span class="op" id="4118734">.</span><span class="ident" id="4118735">New</span><span class="op" id="4118738">(</span><span class="string" id="4118739">&#34;tls:&nbsp;NextProtos&nbsp;values&nbsp;too&nbsp;large&#34;</span><span class="op" id="4118773">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4118776">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4118780">hello</span>&nbsp;<span class="op" id="4118786">:=</span>&nbsp;<span class="op" id="4118789">&amp;</span><span class="ident" id="4118790">clientHelloMsg</span><span class="op" id="4118804">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4118808">vers</span><span class="op" id="4118812">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4118829">c</span><span class="op" id="4118830">.</span><span class="ident" id="4118831">config</span><span class="op" id="4118837">.</span><span class="ident" id="4118838">maxVersion</span><span class="op" id="4118848">(</span><span class="op" id="4118849">)</span><span class="op" id="4118850">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4118854">compressionMethods</span><span class="op" id="4118872">:</span>&nbsp;&nbsp;<span class="op" id="4118875">[</span><span class="op" id="4118876">]</span><span class="builtintype" id="4118877">uint8</span><span class="op" id="4118882">{</span><span class="ident" id="4118883">compressionNone</span><span class="op" id="4118898">}</span><span class="op" id="4118899">,</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4118903">random</span><span class="op" id="4118909">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4118924">make</span><span class="op" id="4118928">(</span><span class="op" id="4118929">[</span><span class="op" id="4118930">]</span><span class="builtintype" id="4118931">byte</span><span class="op" id="4118935">,</span>&nbsp;<span class="num" id="4118937">32</span><span class="op" id="4118939">)</span><span class="op" id="4118940">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4118944">ocspStapling</span><span class="op" id="4118956">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="4118965">true</span><span class="op" id="4118969">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4118973">serverName</span><span class="op" id="4118983">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4118994">c</span><span class="op" id="4118995">.</span><span class="ident" id="4118996">config</span><span class="op" id="4119002">.</span><span class="ident" id="4119003">ServerName</span><span class="op" id="4119013">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4119017">supportedCurves</span><span class="op" id="4119032">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4119038">c</span><span class="op" id="4119039">.</span><span class="ident" id="4119040">config</span><span class="op" id="4119046">.</span><span class="ident" id="4119047">curvePreferences</span><span class="op" id="4119063">(</span><span class="op" id="4119064">)</span><span class="op" id="4119065">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4119069">supportedPoints</span><span class="op" id="4119084">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="4119090">[</span><span class="op" id="4119091">]</span><span class="builtintype" id="4119092">uint8</span><span class="op" id="4119097">{</span><span class="ident" id="4119098">pointFormatUncompressed</span><span class="op" id="4119121">}</span><span class="op" id="4119122">,</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4119126">nextProtoNeg</span><span class="op" id="4119138">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="4119147">len</span><span class="op" id="4119150">(</span><span class="ident" id="4119151">c</span><span class="op" id="4119152">.</span><span class="ident" id="4119153">config</span><span class="op" id="4119159">.</span><span class="ident" id="4119160">NextProtos</span><span class="op" id="4119170">)</span>&nbsp;<span class="op" id="4119172">&gt;</span>&nbsp;<span class="num" id="4119174">0</span><span class="op" id="4119175">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4119179">secureRenegotiation</span><span class="op" id="4119198">:</span>&nbsp;<span class="builtintype" id="4119200">true</span><span class="op" id="4119204">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4119208">alpnProtocols</span><span class="op" id="4119221">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4119229">c</span><span class="op" id="4119230">.</span><span class="ident" id="4119231">config</span><span class="op" id="4119237">.</span><span class="ident" id="4119238">NextProtos</span><span class="op" id="4119248">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4119251">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4119255">possibleCipherSuites</span>&nbsp;<span class="op" id="4119276">:=</span>&nbsp;<span class="ident" id="4119279">c</span><span class="op" id="4119280">.</span><span class="ident" id="4119281">config</span><span class="op" id="4119287">.</span><span class="ident" id="4119288">cipherSuites</span><span class="op" id="4119300">(</span><span class="op" id="4119301">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4119304">hello</span><span class="op" id="4119309">.</span><span class="ident" id="4119310">cipherSuites</span>&nbsp;<span class="op" id="4119323">=</span>&nbsp;<span class="builtinfunc" id="4119325">make</span><span class="op" id="4119329">(</span><span class="op" id="4119330">[</span><span class="op" id="4119331">]</span><span class="builtintype" id="4119332">uint16</span><span class="op" id="4119338">,</span>&nbsp;<span class="num" id="4119340">0</span><span class="op" id="4119341">,</span>&nbsp;<span class="builtinfunc" id="4119343">len</span><span class="op" id="4119346">(</span><span class="ident" id="4119347">possibleCipherSuites</span><span class="op" id="4119367">)</span><span class="op" id="4119368">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="ident" id="4119371">NextCipherSuite</span><span class="op" id="4119386">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4119389">for</span>&nbsp;<span class="ident" id="4119393">_</span><span class="op" id="4119394">,</span>&nbsp;<span class="ident" id="4119396">suiteId</span>&nbsp;<span class="op" id="4119404">:=</span>&nbsp;<span class="keyword" id="4119407">range</span>&nbsp;<span class="ident" id="4119413">possibleCipherSuites</span>&nbsp;<span class="op" id="4119434">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4119438">for</span>&nbsp;<span class="ident" id="4119442">_</span><span class="op" id="4119443">,</span>&nbsp;<span class="ident" id="4119445">suite</span>&nbsp;<span class="op" id="4119451">:=</span>&nbsp;<span class="keyword" id="4119454">range</span>&nbsp;<span class="ident" id="4119460">cipherSuites</span>&nbsp;<span class="op" id="4119473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4119478">if</span>&nbsp;<span class="ident" id="4119481">suite</span><span class="op" id="4119486">.</span><span class="ident" id="4119487">id</span>&nbsp;<span class="op" id="4119490">!=</span>&nbsp;<span class="ident" id="4119493">suiteId</span>&nbsp;<span class="op" id="4119501">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4119507">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4119519">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4119524">//&nbsp;Don&#39;t&nbsp;advertise&nbsp;TLS&nbsp;1.2-only&nbsp;cipher&nbsp;suites&nbsp;unless</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4119580">//&nbsp;we&#39;re&nbsp;attempting&nbsp;TLS&nbsp;1.2.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4119612">if</span>&nbsp;<span class="ident" id="4119615">hello</span><span class="op" id="4119620">.</span><span class="ident" id="4119621">vers</span>&nbsp;<span class="op" id="4119626">&lt;</span>&nbsp;<span class="ident" id="4119628">VersionTLS12</span>&nbsp;<span class="op" id="4119641">&amp;&amp;</span>&nbsp;<span class="ident" id="4119644">suite</span><span class="op" id="4119649">.</span><span class="ident" id="4119650">flags</span><span class="op" id="4119655">&amp;</span><span class="ident" id="4119656">suiteTLS12</span>&nbsp;<span class="op" id="4119667">!=</span>&nbsp;<span class="num" id="4119670">0</span>&nbsp;<span class="op" id="4119672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4119678">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4119690">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4119695">hello</span><span class="op" id="4119700">.</span><span class="ident" id="4119701">cipherSuites</span>&nbsp;<span class="op" id="4119714">=</span>&nbsp;<span class="builtinfunc" id="4119716">append</span><span class="op" id="4119722">(</span><span class="ident" id="4119723">hello</span><span class="op" id="4119728">.</span><span class="ident" id="4119729">cipherSuites</span><span class="op" id="4119741">,</span>&nbsp;<span class="ident" id="4119743">suiteId</span><span class="op" id="4119750">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4119755">continue</span>&nbsp;<span class="ident" id="4119764">NextCipherSuite</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4119782">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4119785">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4119789">_</span><span class="op" id="4119790">,</span>&nbsp;<span class="ident" id="4119792">err</span>&nbsp;<span class="op" id="4119796">:=</span>&nbsp;<span class="ident" id="4119799">io</span><span class="op" id="4119801">.</span><span class="ident" id="4119802">ReadFull</span><span class="op" id="4119810">(</span><span class="ident" id="4119811">c</span><span class="op" id="4119812">.</span><span class="ident" id="4119813">config</span><span class="op" id="4119819">.</span><span class="ident" id="4119820">rand</span><span class="op" id="4119824">(</span><span class="op" id="4119825">)</span><span class="op" id="4119826">,</span>&nbsp;<span class="ident" id="4119828">hello</span><span class="op" id="4119833">.</span><span class="ident" id="4119834">random</span><span class="op" id="4119840">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4119843">if</span>&nbsp;<span class="ident" id="4119846">err</span>&nbsp;<span class="op" id="4119850">!=</span>&nbsp;<span class="ident" id="4119853">nil</span>&nbsp;<span class="op" id="4119857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4119861">c</span><span class="op" id="4119862">.</span><span class="ident" id="4119863">sendAlert</span><span class="op" id="4119872">(</span><span class="ident" id="4119873">alertInternalError</span><span class="op" id="4119891">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4119895">return</span>&nbsp;<span class="ident" id="4119902">errors</span><span class="op" id="4119908">.</span><span class="ident" id="4119909">New</span><span class="op" id="4119912">(</span><span class="string" id="4119913">&#34;tls:&nbsp;short&nbsp;read&nbsp;from&nbsp;Rand:&nbsp;&#34;</span>&nbsp;<span class="op" id="4119943">+</span>&nbsp;<span class="ident" id="4119945">err</span><span class="op" id="4119948">.</span><span class="ident" id="4119949">Error</span><span class="op" id="4119954">(</span><span class="op" id="4119955">)</span><span class="op" id="4119956">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4119959">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4119963">if</span>&nbsp;<span class="ident" id="4119966">hello</span><span class="op" id="4119971">.</span><span class="ident" id="4119972">vers</span>&nbsp;<span class="op" id="4119977">&gt;=</span>&nbsp;<span class="ident" id="4119980">VersionTLS12</span>&nbsp;<span class="op" id="4119993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4119997">hello</span><span class="op" id="4120002">.</span><span class="ident" id="4120003">signatureAndHashes</span>&nbsp;<span class="op" id="4120022">=</span>&nbsp;<span class="ident" id="4120024">supportedSKXSignatureAlgorithms</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4120057">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4120061">var</span>&nbsp;<span class="ident" id="4120065">session</span>&nbsp;<span class="op" id="4120073">*</span><span class="ident" id="4120074">ClientSessionState</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4120094">var</span>&nbsp;<span class="ident" id="4120098">cacheKey</span>&nbsp;<span class="builtintype" id="4120107">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4120115">sessionCache</span>&nbsp;<span class="op" id="4120128">:=</span>&nbsp;<span class="ident" id="4120131">c</span><span class="op" id="4120132">.</span><span class="ident" id="4120133">config</span><span class="op" id="4120139">.</span><span class="ident" id="4120140">ClientSessionCache</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4120160">if</span>&nbsp;<span class="ident" id="4120163">c</span><span class="op" id="4120164">.</span><span class="ident" id="4120165">config</span><span class="op" id="4120171">.</span><span class="ident" id="4120172">SessionTicketsDisabled</span>&nbsp;<span class="op" id="4120195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4120199">sessionCache</span>&nbsp;<span class="op" id="4120212">=</span>&nbsp;<span class="ident" id="4120214">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4120219">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4120223">if</span>&nbsp;<span class="ident" id="4120226">sessionCache</span>&nbsp;<span class="op" id="4120239">!=</span>&nbsp;<span class="ident" id="4120242">nil</span>&nbsp;<span class="op" id="4120246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4120250">hello</span><span class="op" id="4120255">.</span><span class="ident" id="4120256">ticketSupported</span>&nbsp;<span class="op" id="4120272">=</span>&nbsp;<span class="builtintype" id="4120274">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4120282">//&nbsp;Try&nbsp;to&nbsp;resume&nbsp;a&nbsp;previously&nbsp;negotiated&nbsp;TLS&nbsp;session,&nbsp;if</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4120341">//&nbsp;available.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4120357">cacheKey</span>&nbsp;<span class="op" id="4120366">=</span>&nbsp;<span class="ident" id="4120368">clientSessionCacheKey</span><span class="op" id="4120389">(</span><span class="ident" id="4120390">c</span><span class="op" id="4120391">.</span><span class="ident" id="4120392">conn</span><span class="op" id="4120396">.</span><span class="ident" id="4120397">RemoteAddr</span><span class="op" id="4120407">(</span><span class="op" id="4120408">)</span><span class="op" id="4120409">,</span>&nbsp;<span class="ident" id="4120411">c</span><span class="op" id="4120412">.</span><span class="ident" id="4120413">config</span><span class="op" id="4120419">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4120423">candidateSession</span><span class="op" id="4120439">,</span>&nbsp;<span class="ident" id="4120441">ok</span>&nbsp;<span class="op" id="4120444">:=</span>&nbsp;<span class="ident" id="4120447">sessionCache</span><span class="op" id="4120459">.</span><span class="ident" id="4120460">Get</span><span class="op" id="4120463">(</span><span class="ident" id="4120464">cacheKey</span><span class="op" id="4120472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4120476">if</span>&nbsp;<span class="ident" id="4120479">ok</span>&nbsp;<span class="op" id="4120482">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4120487">//&nbsp;Check&nbsp;that&nbsp;the&nbsp;ciphersuite/version&nbsp;used&nbsp;for&nbsp;the</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4120541">//&nbsp;previous&nbsp;session&nbsp;are&nbsp;still&nbsp;valid.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4120581">cipherSuiteOk</span>&nbsp;<span class="op" id="4120595">:=</span>&nbsp;<span class="builtintype" id="4120598">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4120607">for</span>&nbsp;<span class="ident" id="4120611">_</span><span class="op" id="4120612">,</span>&nbsp;<span class="ident" id="4120614">id</span>&nbsp;<span class="op" id="4120617">:=</span>&nbsp;<span class="keyword" id="4120620">range</span>&nbsp;<span class="ident" id="4120626">hello</span><span class="op" id="4120631">.</span><span class="ident" id="4120632">cipherSuites</span>&nbsp;<span class="op" id="4120645">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4120651">if</span>&nbsp;<span class="ident" id="4120654">id</span>&nbsp;<span class="op" id="4120657">==</span>&nbsp;<span class="ident" id="4120660">candidateSession</span><span class="op" id="4120676">.</span><span class="ident" id="4120677">cipherSuite</span>&nbsp;<span class="op" id="4120689">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4120696">cipherSuiteOk</span>&nbsp;<span class="op" id="4120710">=</span>&nbsp;<span class="builtintype" id="4120712">true</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4120722">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4120732">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4120737">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4120743">versOk</span>&nbsp;<span class="op" id="4120750">:=</span>&nbsp;<span class="ident" id="4120753">candidateSession</span><span class="op" id="4120769">.</span><span class="ident" id="4120770">vers</span>&nbsp;<span class="op" id="4120775">&gt;=</span>&nbsp;<span class="ident" id="4120778">c</span><span class="op" id="4120779">.</span><span class="ident" id="4120780">config</span><span class="op" id="4120786">.</span><span class="ident" id="4120787">minVersion</span><span class="op" id="4120797">(</span><span class="op" id="4120798">)</span>&nbsp;<span class="op" id="4120800">&amp;&amp;</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4120807">candidateSession</span><span class="op" id="4120823">.</span><span class="ident" id="4120824">vers</span>&nbsp;<span class="op" id="4120829">&lt;=</span>&nbsp;<span class="ident" id="4120832">c</span><span class="op" id="4120833">.</span><span class="ident" id="4120834">config</span><span class="op" id="4120840">.</span><span class="ident" id="4120841">maxVersion</span><span class="op" id="4120851">(</span><span class="op" id="4120852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4120857">if</span>&nbsp;<span class="ident" id="4120860">versOk</span>&nbsp;<span class="op" id="4120867">&amp;&amp;</span>&nbsp;<span class="ident" id="4120870">cipherSuiteOk</span>&nbsp;<span class="op" id="4120884">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4120890">session</span>&nbsp;<span class="op" id="4120898">=</span>&nbsp;<span class="ident" id="4120900">candidateSession</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4120920">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4120924">}</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4120927">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4120931">if</span>&nbsp;<span class="ident" id="4120934">session</span>&nbsp;<span class="op" id="4120942">!=</span>&nbsp;<span class="ident" id="4120945">nil</span>&nbsp;<span class="op" id="4120949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4120953">hello</span><span class="op" id="4120958">.</span><span class="ident" id="4120959">sessionTicket</span>&nbsp;<span class="op" id="4120973">=</span>&nbsp;<span class="ident" id="4120975">session</span><span class="op" id="4120982">.</span><span class="ident" id="4120983">sessionTicket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4120999">//&nbsp;A&nbsp;random&nbsp;session&nbsp;ID&nbsp;is&nbsp;used&nbsp;to&nbsp;detect&nbsp;when&nbsp;the</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4121051">//&nbsp;server&nbsp;accepted&nbsp;the&nbsp;ticket&nbsp;and&nbsp;is&nbsp;resuming&nbsp;a&nbsp;session</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4121109">//&nbsp;(see&nbsp;RFC&nbsp;5077).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4121130">hello</span><span class="op" id="4121135">.</span><span class="ident" id="4121136">sessionId</span>&nbsp;<span class="op" id="4121146">=</span>&nbsp;<span class="builtinfunc" id="4121148">make</span><span class="op" id="4121152">(</span><span class="op" id="4121153">[</span><span class="op" id="4121154">]</span><span class="builtintype" id="4121155">byte</span><span class="op" id="4121159">,</span>&nbsp;<span class="num" id="4121161">16</span><span class="op" id="4121163">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4121167">if</span>&nbsp;<span class="ident" id="4121170">_</span><span class="op" id="4121171">,</span>&nbsp;<span class="ident" id="4121173">err</span>&nbsp;<span class="op" id="4121177">:=</span>&nbsp;<span class="ident" id="4121180">io</span><span class="op" id="4121182">.</span><span class="ident" id="4121183">ReadFull</span><span class="op" id="4121191">(</span><span class="ident" id="4121192">c</span><span class="op" id="4121193">.</span><span class="ident" id="4121194">config</span><span class="op" id="4121200">.</span><span class="ident" id="4121201">rand</span><span class="op" id="4121205">(</span><span class="op" id="4121206">)</span><span class="op" id="4121207">,</span>&nbsp;<span class="ident" id="4121209">hello</span><span class="op" id="4121214">.</span><span class="ident" id="4121215">sessionId</span><span class="op" id="4121224">)</span><span class="op" id="4121225">;</span>&nbsp;<span class="ident" id="4121227">err</span>&nbsp;<span class="op" id="4121231">!=</span>&nbsp;<span class="ident" id="4121234">nil</span>&nbsp;<span class="op" id="4121238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4121243">c</span><span class="op" id="4121244">.</span><span class="ident" id="4121245">sendAlert</span><span class="op" id="4121254">(</span><span class="ident" id="4121255">alertInternalError</span><span class="op" id="4121273">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4121278">return</span>&nbsp;<span class="ident" id="4121285">errors</span><span class="op" id="4121291">.</span><span class="ident" id="4121292">New</span><span class="op" id="4121295">(</span><span class="string" id="4121296">&#34;tls:&nbsp;short&nbsp;read&nbsp;from&nbsp;Rand:&nbsp;&#34;</span>&nbsp;<span class="op" id="4121326">+</span>&nbsp;<span class="ident" id="4121328">err</span><span class="op" id="4121331">.</span><span class="ident" id="4121332">Error</span><span class="op" id="4121337">(</span><span class="op" id="4121338">)</span><span class="op" id="4121339">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4121343">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4121346">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4121350">c</span><span class="op" id="4121351">.</span><span class="ident" id="4121352">writeRecord</span><span class="op" id="4121363">(</span><span class="ident" id="4121364">recordTypeHandshake</span><span class="op" id="4121383">,</span>&nbsp;<span class="ident" id="4121385">hello</span><span class="op" id="4121390">.</span><span class="ident" id="4121391">marshal</span><span class="op" id="4121398">(</span><span class="op" id="4121399">)</span><span class="op" id="4121400">)</span><br>
<span class="lineno">140</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4121404">msg</span><span class="op" id="4121407">,</span>&nbsp;<span class="ident" id="4121409">err</span>&nbsp;<span class="op" id="4121413">:=</span>&nbsp;<span class="ident" id="4121416">c</span><span class="op" id="4121417">.</span><span class="ident" id="4121418">readHandshake</span><span class="op" id="4121431">(</span><span class="op" id="4121432">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4121435">if</span>&nbsp;<span class="ident" id="4121438">err</span>&nbsp;<span class="op" id="4121442">!=</span>&nbsp;<span class="ident" id="4121445">nil</span>&nbsp;<span class="op" id="4121449">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4121453">return</span>&nbsp;<span class="ident" id="4121460">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4121465">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4121468">serverHello</span><span class="op" id="4121479">,</span>&nbsp;<span class="ident" id="4121481">ok</span>&nbsp;<span class="op" id="4121484">:=</span>&nbsp;<span class="ident" id="4121487">msg</span><span class="op" id="4121490">.</span><span class="op" id="4121491">(</span><span class="op" id="4121492">*</span><span class="ident" id="4121493">serverHelloMsg</span><span class="op" id="4121507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4121510">if</span>&nbsp;<span class="op" id="4121513">!</span><span class="ident" id="4121514">ok</span>&nbsp;<span class="op" id="4121517">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4121521">c</span><span class="op" id="4121522">.</span><span class="ident" id="4121523">sendAlert</span><span class="op" id="4121532">(</span><span class="ident" id="4121533">alertUnexpectedMessage</span><span class="op" id="4121555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4121559">return</span>&nbsp;<span class="ident" id="4121566">unexpectedMessageError</span><span class="op" id="4121588">(</span><span class="ident" id="4121589">serverHello</span><span class="op" id="4121600">,</span>&nbsp;<span class="ident" id="4121602">msg</span><span class="op" id="4121605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4121608">}</span><br>
<span class="lineno">150</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4121612">vers</span><span class="op" id="4121616">,</span>&nbsp;<span class="ident" id="4121618">ok</span>&nbsp;<span class="op" id="4121621">:=</span>&nbsp;<span class="ident" id="4121624">c</span><span class="op" id="4121625">.</span><span class="ident" id="4121626">config</span><span class="op" id="4121632">.</span><span class="ident" id="4121633">mutualVersion</span><span class="op" id="4121646">(</span><span class="ident" id="4121647">serverHello</span><span class="op" id="4121658">.</span><span class="ident" id="4121659">vers</span><span class="op" id="4121663">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4121666">if</span>&nbsp;<span class="op" id="4121669">!</span><span class="ident" id="4121670">ok</span>&nbsp;<span class="op" id="4121673">||</span>&nbsp;<span class="ident" id="4121676">vers</span>&nbsp;<span class="op" id="4121681">&lt;</span>&nbsp;<span class="ident" id="4121683">VersionTLS10</span>&nbsp;<span class="op" id="4121696">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4121700">//&nbsp;TLS&nbsp;1.0&nbsp;is&nbsp;the&nbsp;minimum&nbsp;version&nbsp;supported&nbsp;as&nbsp;a&nbsp;client.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4121759">c</span><span class="op" id="4121760">.</span><span class="ident" id="4121761">sendAlert</span><span class="op" id="4121770">(</span><span class="ident" id="4121771">alertProtocolVersion</span><span class="op" id="4121791">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4121795">return</span>&nbsp;<span class="ident" id="4121802">fmt</span><span class="op" id="4121805">.</span><span class="ident" id="4121806">Errorf</span><span class="op" id="4121812">(</span><span class="string" id="4121813">&#34;tls:&nbsp;server&nbsp;selected&nbsp;unsupported&nbsp;protocol&nbsp;version&nbsp;%x&#34;</span><span class="op" id="4121867">,</span>&nbsp;<span class="ident" id="4121869">serverHello</span><span class="op" id="4121880">.</span><span class="ident" id="4121881">vers</span><span class="op" id="4121885">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4121888">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4121891">c</span><span class="op" id="4121892">.</span><span class="ident" id="4121893">vers</span>&nbsp;<span class="op" id="4121898">=</span>&nbsp;<span class="ident" id="4121900">vers</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4121906">c</span><span class="op" id="4121907">.</span><span class="ident" id="4121908">haveVers</span>&nbsp;<span class="op" id="4121917">=</span>&nbsp;<span class="builtintype" id="4121919">true</span><br>
<span class="lineno"></span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4121926">suite</span>&nbsp;<span class="op" id="4121932">:=</span>&nbsp;<span class="ident" id="4121935">mutualCipherSuite</span><span class="op" id="4121952">(</span><span class="ident" id="4121953">c</span><span class="op" id="4121954">.</span><span class="ident" id="4121955">config</span><span class="op" id="4121961">.</span><span class="ident" id="4121962">cipherSuites</span><span class="op" id="4121974">(</span><span class="op" id="4121975">)</span><span class="op" id="4121976">,</span>&nbsp;<span class="ident" id="4121978">serverHello</span><span class="op" id="4121989">.</span><span class="ident" id="4121990">cipherSuite</span><span class="op" id="4122001">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4122004">if</span>&nbsp;<span class="ident" id="4122007">suite</span>&nbsp;<span class="op" id="4122013">==</span>&nbsp;<span class="ident" id="4122016">nil</span>&nbsp;<span class="op" id="4122020">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4122024">c</span><span class="op" id="4122025">.</span><span class="ident" id="4122026">sendAlert</span><span class="op" id="4122035">(</span><span class="ident" id="4122036">alertHandshakeFailure</span><span class="op" id="4122057">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4122061">return</span>&nbsp;<span class="ident" id="4122068">fmt</span><span class="op" id="4122071">.</span><span class="ident" id="4122072">Errorf</span><span class="op" id="4122078">(</span><span class="string" id="4122079">&#34;tls:&nbsp;server&nbsp;selected&nbsp;an&nbsp;unsupported&nbsp;cipher&nbsp;suite&#34;</span><span class="op" id="4122129">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4122132">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4122136">hs</span>&nbsp;<span class="op" id="4122139">:=</span>&nbsp;<span class="op" id="4122142">&amp;</span><span class="ident" id="4122143">clientHandshakeState</span><span class="op" id="4122163">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4122167">c</span><span class="op" id="4122168">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4122181">c</span><span class="op" id="4122182">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4122186">serverHello</span><span class="op" id="4122197">:</span>&nbsp;&nbsp;<span class="ident" id="4122200">serverHello</span><span class="op" id="4122211">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4122215">hello</span><span class="op" id="4122220">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4122229">hello</span><span class="op" id="4122234">,</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4122238">suite</span><span class="op" id="4122243">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4122252">suite</span><span class="op" id="4122257">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4122261">finishedHash</span><span class="op" id="4122273">:</span>&nbsp;<span class="ident" id="4122275">newFinishedHash</span><span class="op" id="4122290">(</span><span class="ident" id="4122291">c</span><span class="op" id="4122292">.</span><span class="ident" id="4122293">vers</span><span class="op" id="4122297">)</span><span class="op" id="4122298">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4122302">session</span><span class="op" id="4122309">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4122316">session</span><span class="op" id="4122323">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4122326">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4122330">hs</span><span class="op" id="4122332">.</span><span class="ident" id="4122333">finishedHash</span><span class="op" id="4122345">.</span><span class="ident" id="4122346">Write</span><span class="op" id="4122351">(</span><span class="ident" id="4122352">hs</span><span class="op" id="4122354">.</span><span class="ident" id="4122355">hello</span><span class="op" id="4122360">.</span><span class="ident" id="4122361">marshal</span><span class="op" id="4122368">(</span><span class="op" id="4122369">)</span><span class="op" id="4122370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4122373">hs</span><span class="op" id="4122375">.</span><span class="ident" id="4122376">finishedHash</span><span class="op" id="4122388">.</span><span class="ident" id="4122389">Write</span><span class="op" id="4122394">(</span><span class="ident" id="4122395">hs</span><span class="op" id="4122397">.</span><span class="ident" id="4122398">serverHello</span><span class="op" id="4122409">.</span><span class="ident" id="4122410">marshal</span><span class="op" id="4122417">(</span><span class="op" id="4122418">)</span><span class="op" id="4122419">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4122423">isResume</span><span class="op" id="4122431">,</span>&nbsp;<span class="ident" id="4122433">err</span>&nbsp;<span class="op" id="4122437">:=</span>&nbsp;<span class="ident" id="4122440">hs</span><span class="op" id="4122442">.</span><span class="ident" id="4122443">processServerHello</span><span class="op" id="4122461">(</span><span class="op" id="4122462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4122465">if</span>&nbsp;<span class="ident" id="4122468">err</span>&nbsp;<span class="op" id="4122472">!=</span>&nbsp;<span class="ident" id="4122475">nil</span>&nbsp;<span class="op" id="4122479">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4122483">return</span>&nbsp;<span class="ident" id="4122490">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4122495">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4122499">if</span>&nbsp;<span class="ident" id="4122502">isResume</span>&nbsp;<span class="op" id="4122511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4122515">if</span>&nbsp;<span class="ident" id="4122518">err</span>&nbsp;<span class="op" id="4122522">:=</span>&nbsp;<span class="ident" id="4122525">hs</span><span class="op" id="4122527">.</span><span class="ident" id="4122528">establishKeys</span><span class="op" id="4122541">(</span><span class="op" id="4122542">)</span><span class="op" id="4122543">;</span>&nbsp;<span class="ident" id="4122545">err</span>&nbsp;<span class="op" id="4122549">!=</span>&nbsp;<span class="ident" id="4122552">nil</span>&nbsp;<span class="op" id="4122556">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4122561">return</span>&nbsp;<span class="ident" id="4122568">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4122574">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4122578">if</span>&nbsp;<span class="ident" id="4122581">err</span>&nbsp;<span class="op" id="4122585">:=</span>&nbsp;<span class="ident" id="4122588">hs</span><span class="op" id="4122590">.</span><span class="ident" id="4122591">readSessionTicket</span><span class="op" id="4122608">(</span><span class="op" id="4122609">)</span><span class="op" id="4122610">;</span>&nbsp;<span class="ident" id="4122612">err</span>&nbsp;<span class="op" id="4122616">!=</span>&nbsp;<span class="ident" id="4122619">nil</span>&nbsp;<span class="op" id="4122623">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4122628">return</span>&nbsp;<span class="ident" id="4122635">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4122641">}</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4122645">if</span>&nbsp;<span class="ident" id="4122648">err</span>&nbsp;<span class="op" id="4122652">:=</span>&nbsp;<span class="ident" id="4122655">hs</span><span class="op" id="4122657">.</span><span class="ident" id="4122658">readFinished</span><span class="op" id="4122670">(</span><span class="ident" id="4122671">c</span><span class="op" id="4122672">.</span><span class="ident" id="4122673">firstFinished</span><span class="op" id="4122686">[</span><span class="op" id="4122687">:</span><span class="op" id="4122688">]</span><span class="op" id="4122689">)</span><span class="op" id="4122690">;</span>&nbsp;<span class="ident" id="4122692">err</span>&nbsp;<span class="op" id="4122696">!=</span>&nbsp;<span class="ident" id="4122699">nil</span>&nbsp;<span class="op" id="4122703">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4122708">return</span>&nbsp;<span class="ident" id="4122715">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4122721">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4122725">if</span>&nbsp;<span class="ident" id="4122728">err</span>&nbsp;<span class="op" id="4122732">:=</span>&nbsp;<span class="ident" id="4122735">hs</span><span class="op" id="4122737">.</span><span class="ident" id="4122738">sendFinished</span><span class="op" id="4122750">(</span><span class="ident" id="4122751">nil</span><span class="op" id="4122754">)</span><span class="op" id="4122755">;</span>&nbsp;<span class="ident" id="4122757">err</span>&nbsp;<span class="op" id="4122761">!=</span>&nbsp;<span class="ident" id="4122764">nil</span>&nbsp;<span class="op" id="4122768">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4122773">return</span>&nbsp;<span class="ident" id="4122780">err</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4122786">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4122789">}</span>&nbsp;<span class="keyword" id="4122791">else</span>&nbsp;<span class="op" id="4122796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4122800">if</span>&nbsp;<span class="ident" id="4122803">err</span>&nbsp;<span class="op" id="4122807">:=</span>&nbsp;<span class="ident" id="4122810">hs</span><span class="op" id="4122812">.</span><span class="ident" id="4122813">doFullHandshake</span><span class="op" id="4122828">(</span><span class="op" id="4122829">)</span><span class="op" id="4122830">;</span>&nbsp;<span class="ident" id="4122832">err</span>&nbsp;<span class="op" id="4122836">!=</span>&nbsp;<span class="ident" id="4122839">nil</span>&nbsp;<span class="op" id="4122843">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4122848">return</span>&nbsp;<span class="ident" id="4122855">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4122861">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4122865">if</span>&nbsp;<span class="ident" id="4122868">err</span>&nbsp;<span class="op" id="4122872">:=</span>&nbsp;<span class="ident" id="4122875">hs</span><span class="op" id="4122877">.</span><span class="ident" id="4122878">establishKeys</span><span class="op" id="4122891">(</span><span class="op" id="4122892">)</span><span class="op" id="4122893">;</span>&nbsp;<span class="ident" id="4122895">err</span>&nbsp;<span class="op" id="4122899">!=</span>&nbsp;<span class="ident" id="4122902">nil</span>&nbsp;<span class="op" id="4122906">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4122911">return</span>&nbsp;<span class="ident" id="4122918">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4122924">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4122928">if</span>&nbsp;<span class="ident" id="4122931">err</span>&nbsp;<span class="op" id="4122935">:=</span>&nbsp;<span class="ident" id="4122938">hs</span><span class="op" id="4122940">.</span><span class="ident" id="4122941">sendFinished</span><span class="op" id="4122953">(</span><span class="ident" id="4122954">c</span><span class="op" id="4122955">.</span><span class="ident" id="4122956">firstFinished</span><span class="op" id="4122969">[</span><span class="op" id="4122970">:</span><span class="op" id="4122971">]</span><span class="op" id="4122972">)</span><span class="op" id="4122973">;</span>&nbsp;<span class="ident" id="4122975">err</span>&nbsp;<span class="op" id="4122979">!=</span>&nbsp;<span class="ident" id="4122982">nil</span>&nbsp;<span class="op" id="4122986">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4122991">return</span>&nbsp;<span class="ident" id="4122998">err</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4123004">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4123008">if</span>&nbsp;<span class="ident" id="4123011">err</span>&nbsp;<span class="op" id="4123015">:=</span>&nbsp;<span class="ident" id="4123018">hs</span><span class="op" id="4123020">.</span><span class="ident" id="4123021">readSessionTicket</span><span class="op" id="4123038">(</span><span class="op" id="4123039">)</span><span class="op" id="4123040">;</span>&nbsp;<span class="ident" id="4123042">err</span>&nbsp;<span class="op" id="4123046">!=</span>&nbsp;<span class="ident" id="4123049">nil</span>&nbsp;<span class="op" id="4123053">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4123058">return</span>&nbsp;<span class="ident" id="4123065">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4123071">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4123075">if</span>&nbsp;<span class="ident" id="4123078">err</span>&nbsp;<span class="op" id="4123082">:=</span>&nbsp;<span class="ident" id="4123085">hs</span><span class="op" id="4123087">.</span><span class="ident" id="4123088">readFinished</span><span class="op" id="4123100">(</span><span class="ident" id="4123101">nil</span><span class="op" id="4123104">)</span><span class="op" id="4123105">;</span>&nbsp;<span class="ident" id="4123107">err</span>&nbsp;<span class="op" id="4123111">!=</span>&nbsp;<span class="ident" id="4123114">nil</span>&nbsp;<span class="op" id="4123118">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4123123">return</span>&nbsp;<span class="ident" id="4123130">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4123136">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4123139">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4123143">if</span>&nbsp;<span class="ident" id="4123146">sessionCache</span>&nbsp;<span class="op" id="4123159">!=</span>&nbsp;<span class="ident" id="4123162">nil</span>&nbsp;<span class="op" id="4123166">&amp;&amp;</span>&nbsp;<span class="ident" id="4123169">hs</span><span class="op" id="4123171">.</span><span class="ident" id="4123172">session</span>&nbsp;<span class="op" id="4123180">!=</span>&nbsp;<span class="ident" id="4123183">nil</span>&nbsp;<span class="op" id="4123187">&amp;&amp;</span>&nbsp;<span class="ident" id="4123190">session</span>&nbsp;<span class="op" id="4123198">!=</span>&nbsp;<span class="ident" id="4123201">hs</span><span class="op" id="4123203">.</span><span class="ident" id="4123204">session</span>&nbsp;<span class="op" id="4123212">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4123216">sessionCache</span><span class="op" id="4123228">.</span><span class="ident" id="4123229">Put</span><span class="op" id="4123232">(</span><span class="ident" id="4123233">cacheKey</span><span class="op" id="4123241">,</span>&nbsp;<span class="ident" id="4123243">hs</span><span class="op" id="4123245">.</span><span class="ident" id="4123246">session</span><span class="op" id="4123253">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4123256">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4123260">c</span><span class="op" id="4123261">.</span><span class="ident" id="4123262">didResume</span>&nbsp;<span class="op" id="4123272">=</span>&nbsp;<span class="ident" id="4123274">isResume</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4123284">c</span><span class="op" id="4123285">.</span><span class="ident" id="4123286">handshakeComplete</span>&nbsp;<span class="op" id="4123304">=</span>&nbsp;<span class="builtintype" id="4123306">true</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4123312">c</span><span class="op" id="4123313">.</span><span class="ident" id="4123314">cipherSuite</span>&nbsp;<span class="op" id="4123326">=</span>&nbsp;<span class="ident" id="4123328">suite</span><span class="op" id="4123333">.</span><span class="ident" id="4123334">id</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4123338">return</span>&nbsp;<span class="ident" id="4123345">nil</span><br>
<span class="lineno"></span><span class="op" id="4123349">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4123352">func</span>&nbsp;<span class="op" id="4123357">(</span><span class="ident" id="4123358">hs</span>&nbsp;<span class="op" id="4123361">*</span><span class="ident" id="4123362">clientHandshakeState</span><span class="op" id="4123382">)</span>&nbsp;<span class="ident" id="4123384">doFullHandshake</span><span class="op" id="4123399">(</span><span class="op" id="4123400">)</span>&nbsp;<span class="builtintype" id="4123402">error</span>&nbsp;<span class="op" id="4123408">{</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4123411">c</span>&nbsp;<span class="op" id="4123413">:=</span>&nbsp;<span class="ident" id="4123416">hs</span><span class="op" id="4123418">.</span><span class="ident" id="4123419">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4123423">msg</span><span class="op" id="4123426">,</span>&nbsp;<span class="ident" id="4123428">err</span>&nbsp;<span class="op" id="4123432">:=</span>&nbsp;<span class="ident" id="4123435">c</span><span class="op" id="4123436">.</span><span class="ident" id="4123437">readHandshake</span><span class="op" id="4123450">(</span><span class="op" id="4123451">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4123454">if</span>&nbsp;<span class="ident" id="4123457">err</span>&nbsp;<span class="op" id="4123461">!=</span>&nbsp;<span class="ident" id="4123464">nil</span>&nbsp;<span class="op" id="4123468">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4123472">return</span>&nbsp;<span class="ident" id="4123479">err</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4123484">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4123487">certMsg</span><span class="op" id="4123494">,</span>&nbsp;<span class="ident" id="4123496">ok</span>&nbsp;<span class="op" id="4123499">:=</span>&nbsp;<span class="ident" id="4123502">msg</span><span class="op" id="4123505">.</span><span class="op" id="4123506">(</span><span class="op" id="4123507">*</span><span class="ident" id="4123508">certificateMsg</span><span class="op" id="4123522">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4123525">if</span>&nbsp;<span class="op" id="4123528">!</span><span class="ident" id="4123529">ok</span>&nbsp;<span class="op" id="4123532">||</span>&nbsp;<span class="builtinfunc" id="4123535">len</span><span class="op" id="4123538">(</span><span class="ident" id="4123539">certMsg</span><span class="op" id="4123546">.</span><span class="ident" id="4123547">certificates</span><span class="op" id="4123559">)</span>&nbsp;<span class="op" id="4123561">==</span>&nbsp;<span class="num" id="4123564">0</span>&nbsp;<span class="op" id="4123566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4123570">c</span><span class="op" id="4123571">.</span><span class="ident" id="4123572">sendAlert</span><span class="op" id="4123581">(</span><span class="ident" id="4123582">alertUnexpectedMessage</span><span class="op" id="4123604">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4123608">return</span>&nbsp;<span class="ident" id="4123615">unexpectedMessageError</span><span class="op" id="4123637">(</span><span class="ident" id="4123638">certMsg</span><span class="op" id="4123645">,</span>&nbsp;<span class="ident" id="4123647">msg</span><span class="op" id="4123650">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4123653">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4123656">hs</span><span class="op" id="4123658">.</span><span class="ident" id="4123659">finishedHash</span><span class="op" id="4123671">.</span><span class="ident" id="4123672">Write</span><span class="op" id="4123677">(</span><span class="ident" id="4123678">certMsg</span><span class="op" id="4123685">.</span><span class="ident" id="4123686">marshal</span><span class="op" id="4123693">(</span><span class="op" id="4123694">)</span><span class="op" id="4123695">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4123699">certs</span>&nbsp;<span class="op" id="4123705">:=</span>&nbsp;<span class="builtinfunc" id="4123708">make</span><span class="op" id="4123712">(</span><span class="op" id="4123713">[</span><span class="op" id="4123714">]</span><span class="op" id="4123715">*</span><span class="ident" id="4123716">x509</span><span class="op" id="4123720">.</span><span class="ident" id="4123721">Certificate</span><span class="op" id="4123732">,</span>&nbsp;<span class="builtinfunc" id="4123734">len</span><span class="op" id="4123737">(</span><span class="ident" id="4123738">certMsg</span><span class="op" id="4123745">.</span><span class="ident" id="4123746">certificates</span><span class="op" id="4123758">)</span><span class="op" id="4123759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4123762">for</span>&nbsp;<span class="ident" id="4123766">i</span><span class="op" id="4123767">,</span>&nbsp;<span class="ident" id="4123769">asn1Data</span>&nbsp;<span class="op" id="4123778">:=</span>&nbsp;<span class="keyword" id="4123781">range</span>&nbsp;<span class="ident" id="4123787">certMsg</span><span class="op" id="4123794">.</span><span class="ident" id="4123795">certificates</span>&nbsp;<span class="op" id="4123808">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4123812">cert</span><span class="op" id="4123816">,</span>&nbsp;<span class="ident" id="4123818">err</span>&nbsp;<span class="op" id="4123822">:=</span>&nbsp;<span class="ident" id="4123825">x509</span><span class="op" id="4123829">.</span><span class="ident" id="4123830">ParseCertificate</span><span class="op" id="4123846">(</span><span class="ident" id="4123847">asn1Data</span><span class="op" id="4123855">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4123859">if</span>&nbsp;<span class="ident" id="4123862">err</span>&nbsp;<span class="op" id="4123866">!=</span>&nbsp;<span class="ident" id="4123869">nil</span>&nbsp;<span class="op" id="4123873">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4123878">c</span><span class="op" id="4123879">.</span><span class="ident" id="4123880">sendAlert</span><span class="op" id="4123889">(</span><span class="ident" id="4123890">alertBadCertificate</span><span class="op" id="4123909">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4123914">return</span>&nbsp;<span class="ident" id="4123921">errors</span><span class="op" id="4123927">.</span><span class="ident" id="4123928">New</span><span class="op" id="4123931">(</span><span class="string" id="4123932">&#34;tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;certificate&nbsp;from&nbsp;server:&nbsp;&#34;</span>&nbsp;<span class="op" id="4123981">+</span>&nbsp;<span class="ident" id="4123983">err</span><span class="op" id="4123986">.</span><span class="ident" id="4123987">Error</span><span class="op" id="4123992">(</span><span class="op" id="4123993">)</span><span class="op" id="4123994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4123998">}</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4124002">certs</span><span class="op" id="4124007">[</span><span class="ident" id="4124008">i</span><span class="op" id="4124009">]</span>&nbsp;<span class="op" id="4124011">=</span>&nbsp;<span class="ident" id="4124013">cert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4124019">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4124023">if</span>&nbsp;<span class="op" id="4124026">!</span><span class="ident" id="4124027">c</span><span class="op" id="4124028">.</span><span class="ident" id="4124029">config</span><span class="op" id="4124035">.</span><span class="ident" id="4124036">InsecureSkipVerify</span>&nbsp;<span class="op" id="4124055">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4124059">opts</span>&nbsp;<span class="op" id="4124064">:=</span>&nbsp;<span class="ident" id="4124067">x509</span><span class="op" id="4124071">.</span><span class="ident" id="4124072">VerifyOptions</span><span class="op" id="4124085">{</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4124090">Roots</span><span class="op" id="4124095">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4124105">c</span><span class="op" id="4124106">.</span><span class="ident" id="4124107">config</span><span class="op" id="4124113">.</span><span class="ident" id="4124114">RootCAs</span><span class="op" id="4124121">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4124126">CurrentTime</span><span class="op" id="4124137">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="4124141">c</span><span class="op" id="4124142">.</span><span class="ident" id="4124143">config</span><span class="op" id="4124149">.</span><span class="ident" id="4124150">time</span><span class="op" id="4124154">(</span><span class="op" id="4124155">)</span><span class="op" id="4124156">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4124161">DNSName</span><span class="op" id="4124168">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4124176">c</span><span class="op" id="4124177">.</span><span class="ident" id="4124178">config</span><span class="op" id="4124184">.</span><span class="ident" id="4124185">ServerName</span><span class="op" id="4124195">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4124200">Intermediates</span><span class="op" id="4124213">:</span>&nbsp;<span class="ident" id="4124215">x509</span><span class="op" id="4124219">.</span><span class="ident" id="4124220">NewCertPool</span><span class="op" id="4124231">(</span><span class="op" id="4124232">)</span><span class="op" id="4124233">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4124237">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4124242">for</span>&nbsp;<span class="ident" id="4124246">i</span><span class="op" id="4124247">,</span>&nbsp;<span class="ident" id="4124249">cert</span>&nbsp;<span class="op" id="4124254">:=</span>&nbsp;<span class="keyword" id="4124257">range</span>&nbsp;<span class="ident" id="4124263">certs</span>&nbsp;<span class="op" id="4124269">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4124274">if</span>&nbsp;<span class="ident" id="4124277">i</span>&nbsp;<span class="op" id="4124279">==</span>&nbsp;<span class="num" id="4124282">0</span>&nbsp;<span class="op" id="4124284">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4124290">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4124302">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4124307">opts</span><span class="op" id="4124311">.</span><span class="ident" id="4124312">Intermediates</span><span class="op" id="4124325">.</span><span class="ident" id="4124326">AddCert</span><span class="op" id="4124333">(</span><span class="ident" id="4124334">cert</span><span class="op" id="4124338">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4124342">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4124346">c</span><span class="op" id="4124347">.</span><span class="ident" id="4124348">verifiedChains</span><span class="op" id="4124362">,</span>&nbsp;<span class="ident" id="4124364">err</span>&nbsp;<span class="op" id="4124368">=</span>&nbsp;<span class="ident" id="4124370">certs</span><span class="op" id="4124375">[</span><span class="num" id="4124376">0</span><span class="op" id="4124377">]</span><span class="op" id="4124378">.</span><span class="ident" id="4124379">Verify</span><span class="op" id="4124385">(</span><span class="ident" id="4124386">opts</span><span class="op" id="4124390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4124394">if</span>&nbsp;<span class="ident" id="4124397">err</span>&nbsp;<span class="op" id="4124401">!=</span>&nbsp;<span class="ident" id="4124404">nil</span>&nbsp;<span class="op" id="4124408">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4124413">c</span><span class="op" id="4124414">.</span><span class="ident" id="4124415">sendAlert</span><span class="op" id="4124424">(</span><span class="ident" id="4124425">alertBadCertificate</span><span class="op" id="4124444">)</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4124449">return</span>&nbsp;<span class="ident" id="4124456">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4124462">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4124465">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4124469">switch</span>&nbsp;<span class="ident" id="4124476">certs</span><span class="op" id="4124481">[</span><span class="num" id="4124482">0</span><span class="op" id="4124483">]</span><span class="op" id="4124484">.</span><span class="ident" id="4124485">PublicKey</span><span class="op" id="4124494">.</span><span class="op" id="4124495">(</span><span class="keyword" id="4124496">type</span><span class="op" id="4124500">)</span>&nbsp;<span class="op" id="4124502">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4124505">case</span>&nbsp;<span class="op" id="4124510">*</span><span class="ident" id="4124511">rsa</span><span class="op" id="4124514">.</span><span class="ident" id="4124515">PublicKey</span><span class="op" id="4124524">,</span>&nbsp;<span class="op" id="4124526">*</span><span class="ident" id="4124527">ecdsa</span><span class="op" id="4124532">.</span><span class="ident" id="4124533">PublicKey</span><span class="op" id="4124542">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4124546">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4124553">default</span><span class="op" id="4124560">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4124564">c</span><span class="op" id="4124565">.</span><span class="ident" id="4124566">sendAlert</span><span class="op" id="4124575">(</span><span class="ident" id="4124576">alertUnsupportedCertificate</span><span class="op" id="4124603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4124607">return</span>&nbsp;<span class="ident" id="4124614">fmt</span><span class="op" id="4124617">.</span><span class="ident" id="4124618">Errorf</span><span class="op" id="4124624">(</span><span class="string" id="4124625">&#34;tls:&nbsp;server&#39;s&nbsp;certificate&nbsp;contains&nbsp;an&nbsp;unsupported&nbsp;type&nbsp;of&nbsp;public&nbsp;key:&nbsp;%T&#34;</span><span class="op" id="4124699">,</span>&nbsp;<span class="ident" id="4124701">certs</span><span class="op" id="4124706">[</span><span class="num" id="4124707">0</span><span class="op" id="4124708">]</span><span class="op" id="4124709">.</span><span class="ident" id="4124710">PublicKey</span><span class="op" id="4124719">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4124722">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4124726">c</span><span class="op" id="4124727">.</span><span class="ident" id="4124728">peerCertificates</span>&nbsp;<span class="op" id="4124745">=</span>&nbsp;<span class="ident" id="4124747">certs</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4124755">if</span>&nbsp;<span class="ident" id="4124758">hs</span><span class="op" id="4124760">.</span><span class="ident" id="4124761">serverHello</span><span class="op" id="4124772">.</span><span class="ident" id="4124773">ocspStapling</span>&nbsp;<span class="op" id="4124786">{</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4124790">msg</span><span class="op" id="4124793">,</span>&nbsp;<span class="ident" id="4124795">err</span>&nbsp;<span class="op" id="4124799">=</span>&nbsp;<span class="ident" id="4124801">c</span><span class="op" id="4124802">.</span><span class="ident" id="4124803">readHandshake</span><span class="op" id="4124816">(</span><span class="op" id="4124817">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4124821">if</span>&nbsp;<span class="ident" id="4124824">err</span>&nbsp;<span class="op" id="4124828">!=</span>&nbsp;<span class="ident" id="4124831">nil</span>&nbsp;<span class="op" id="4124835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4124840">return</span>&nbsp;<span class="ident" id="4124847">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4124853">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4124857">cs</span><span class="op" id="4124859">,</span>&nbsp;<span class="ident" id="4124861">ok</span>&nbsp;<span class="op" id="4124864">:=</span>&nbsp;<span class="ident" id="4124867">msg</span><span class="op" id="4124870">.</span><span class="op" id="4124871">(</span><span class="op" id="4124872">*</span><span class="ident" id="4124873">certificateStatusMsg</span><span class="op" id="4124893">)</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4124897">if</span>&nbsp;<span class="op" id="4124900">!</span><span class="ident" id="4124901">ok</span>&nbsp;<span class="op" id="4124904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4124909">c</span><span class="op" id="4124910">.</span><span class="ident" id="4124911">sendAlert</span><span class="op" id="4124920">(</span><span class="ident" id="4124921">alertUnexpectedMessage</span><span class="op" id="4124943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4124948">return</span>&nbsp;<span class="ident" id="4124955">unexpectedMessageError</span><span class="op" id="4124977">(</span><span class="ident" id="4124978">cs</span><span class="op" id="4124980">,</span>&nbsp;<span class="ident" id="4124982">msg</span><span class="op" id="4124985">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4124989">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4124993">hs</span><span class="op" id="4124995">.</span><span class="ident" id="4124996">finishedHash</span><span class="op" id="4125008">.</span><span class="ident" id="4125009">Write</span><span class="op" id="4125014">(</span><span class="ident" id="4125015">cs</span><span class="op" id="4125017">.</span><span class="ident" id="4125018">marshal</span><span class="op" id="4125025">(</span><span class="op" id="4125026">)</span><span class="op" id="4125027">)</span><br>
<span class="lineno">290</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4125032">if</span>&nbsp;<span class="ident" id="4125035">cs</span><span class="op" id="4125037">.</span><span class="ident" id="4125038">statusType</span>&nbsp;<span class="op" id="4125049">==</span>&nbsp;<span class="ident" id="4125052">statusTypeOCSP</span>&nbsp;<span class="op" id="4125067">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4125072">c</span><span class="op" id="4125073">.</span><span class="ident" id="4125074">ocspResponse</span>&nbsp;<span class="op" id="4125087">=</span>&nbsp;<span class="ident" id="4125089">cs</span><span class="op" id="4125091">.</span><span class="ident" id="4125092">response</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4125103">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4125106">}</span><br>
<span class="lineno">295</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4125110">msg</span><span class="op" id="4125113">,</span>&nbsp;<span class="ident" id="4125115">err</span>&nbsp;<span class="op" id="4125119">=</span>&nbsp;<span class="ident" id="4125121">c</span><span class="op" id="4125122">.</span><span class="ident" id="4125123">readHandshake</span><span class="op" id="4125136">(</span><span class="op" id="4125137">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4125140">if</span>&nbsp;<span class="ident" id="4125143">err</span>&nbsp;<span class="op" id="4125147">!=</span>&nbsp;<span class="ident" id="4125150">nil</span>&nbsp;<span class="op" id="4125154">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4125158">return</span>&nbsp;<span class="ident" id="4125165">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4125170">}</span><br>
<span class="lineno">300</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4125174">keyAgreement</span>&nbsp;<span class="op" id="4125187">:=</span>&nbsp;<span class="ident" id="4125190">hs</span><span class="op" id="4125192">.</span><span class="ident" id="4125193">suite</span><span class="op" id="4125198">.</span><span class="ident" id="4125199">ka</span><span class="op" id="4125201">(</span><span class="ident" id="4125202">c</span><span class="op" id="4125203">.</span><span class="ident" id="4125204">vers</span><span class="op" id="4125208">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4125212">skx</span><span class="op" id="4125215">,</span>&nbsp;<span class="ident" id="4125217">ok</span>&nbsp;<span class="op" id="4125220">:=</span>&nbsp;<span class="ident" id="4125223">msg</span><span class="op" id="4125226">.</span><span class="op" id="4125227">(</span><span class="op" id="4125228">*</span><span class="ident" id="4125229">serverKeyExchangeMsg</span><span class="op" id="4125249">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4125252">if</span>&nbsp;<span class="ident" id="4125255">ok</span>&nbsp;<span class="op" id="4125258">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4125262">hs</span><span class="op" id="4125264">.</span><span class="ident" id="4125265">finishedHash</span><span class="op" id="4125277">.</span><span class="ident" id="4125278">Write</span><span class="op" id="4125283">(</span><span class="ident" id="4125284">skx</span><span class="op" id="4125287">.</span><span class="ident" id="4125288">marshal</span><span class="op" id="4125295">(</span><span class="op" id="4125296">)</span><span class="op" id="4125297">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4125301">err</span>&nbsp;<span class="op" id="4125305">=</span>&nbsp;<span class="ident" id="4125307">keyAgreement</span><span class="op" id="4125319">.</span><span class="ident" id="4125320">processServerKeyExchange</span><span class="op" id="4125344">(</span><span class="ident" id="4125345">c</span><span class="op" id="4125346">.</span><span class="ident" id="4125347">config</span><span class="op" id="4125353">,</span>&nbsp;<span class="ident" id="4125355">hs</span><span class="op" id="4125357">.</span><span class="ident" id="4125358">hello</span><span class="op" id="4125363">,</span>&nbsp;<span class="ident" id="4125365">hs</span><span class="op" id="4125367">.</span><span class="ident" id="4125368">serverHello</span><span class="op" id="4125379">,</span>&nbsp;<span class="ident" id="4125381">certs</span><span class="op" id="4125386">[</span><span class="num" id="4125387">0</span><span class="op" id="4125388">]</span><span class="op" id="4125389">,</span>&nbsp;<span class="ident" id="4125391">skx</span><span class="op" id="4125394">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4125398">if</span>&nbsp;<span class="ident" id="4125401">err</span>&nbsp;<span class="op" id="4125405">!=</span>&nbsp;<span class="ident" id="4125408">nil</span>&nbsp;<span class="op" id="4125412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4125417">c</span><span class="op" id="4125418">.</span><span class="ident" id="4125419">sendAlert</span><span class="op" id="4125428">(</span><span class="ident" id="4125429">alertUnexpectedMessage</span><span class="op" id="4125451">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4125456">return</span>&nbsp;<span class="ident" id="4125463">err</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4125469">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4125474">msg</span><span class="op" id="4125477">,</span>&nbsp;<span class="ident" id="4125479">err</span>&nbsp;<span class="op" id="4125483">=</span>&nbsp;<span class="ident" id="4125485">c</span><span class="op" id="4125486">.</span><span class="ident" id="4125487">readHandshake</span><span class="op" id="4125500">(</span><span class="op" id="4125501">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4125505">if</span>&nbsp;<span class="ident" id="4125508">err</span>&nbsp;<span class="op" id="4125512">!=</span>&nbsp;<span class="ident" id="4125515">nil</span>&nbsp;<span class="op" id="4125519">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4125524">return</span>&nbsp;<span class="ident" id="4125531">err</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4125537">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4125540">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4125544">var</span>&nbsp;<span class="ident" id="4125548">chainToSend</span>&nbsp;<span class="op" id="4125560">*</span><span class="ident" id="4125561">Certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4125574">var</span>&nbsp;<span class="ident" id="4125578">certRequested</span>&nbsp;<span class="builtintype" id="4125592">bool</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4125598">certReq</span><span class="op" id="4125605">,</span>&nbsp;<span class="ident" id="4125607">ok</span>&nbsp;<span class="op" id="4125610">:=</span>&nbsp;<span class="ident" id="4125613">msg</span><span class="op" id="4125616">.</span><span class="op" id="4125617">(</span><span class="op" id="4125618">*</span><span class="ident" id="4125619">certificateRequestMsg</span><span class="op" id="4125640">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4125643">if</span>&nbsp;<span class="ident" id="4125646">ok</span>&nbsp;<span class="op" id="4125649">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4125653">certRequested</span>&nbsp;<span class="op" id="4125667">=</span>&nbsp;<span class="builtintype" id="4125669">true</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4125677">//&nbsp;RFC&nbsp;4346&nbsp;on&nbsp;the&nbsp;certificateAuthorities&nbsp;field:</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4125728">//&nbsp;A&nbsp;list&nbsp;of&nbsp;the&nbsp;distinguished&nbsp;names&nbsp;of&nbsp;acceptable&nbsp;certificate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4125793">//&nbsp;authorities.&nbsp;These&nbsp;distinguished&nbsp;names&nbsp;may&nbsp;specify&nbsp;a&nbsp;desired</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4125859">//&nbsp;distinguished&nbsp;name&nbsp;for&nbsp;a&nbsp;root&nbsp;CA&nbsp;or&nbsp;for&nbsp;a&nbsp;subordinate&nbsp;CA;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4125922">//&nbsp;thus,&nbsp;this&nbsp;message&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;describe&nbsp;both&nbsp;known&nbsp;roots</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4125987">//&nbsp;and&nbsp;a&nbsp;desired&nbsp;authorization&nbsp;space.&nbsp;If&nbsp;the</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4126034">//&nbsp;certificate_authorities&nbsp;list&nbsp;is&nbsp;empty&nbsp;then&nbsp;the&nbsp;client&nbsp;MAY</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4126097">//&nbsp;send&nbsp;any&nbsp;certificate&nbsp;of&nbsp;the&nbsp;appropriate</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4126142">//&nbsp;ClientCertificateType,&nbsp;unless&nbsp;there&nbsp;is&nbsp;some&nbsp;external</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4126200">//&nbsp;arrangement&nbsp;to&nbsp;the&nbsp;contrary.</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4126235">hs</span><span class="op" id="4126237">.</span><span class="ident" id="4126238">finishedHash</span><span class="op" id="4126250">.</span><span class="ident" id="4126251">Write</span><span class="op" id="4126256">(</span><span class="ident" id="4126257">certReq</span><span class="op" id="4126264">.</span><span class="ident" id="4126265">marshal</span><span class="op" id="4126272">(</span><span class="op" id="4126273">)</span><span class="op" id="4126274">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4126279">var</span>&nbsp;<span class="ident" id="4126283">rsaAvail</span><span class="op" id="4126291">,</span>&nbsp;<span class="ident" id="4126293">ecdsaAvail</span>&nbsp;<span class="builtintype" id="4126304">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4126311">for</span>&nbsp;<span class="ident" id="4126315">_</span><span class="op" id="4126316">,</span>&nbsp;<span class="ident" id="4126318">certType</span>&nbsp;<span class="op" id="4126327">:=</span>&nbsp;<span class="keyword" id="4126330">range</span>&nbsp;<span class="ident" id="4126336">certReq</span><span class="op" id="4126343">.</span><span class="ident" id="4126344">certificateTypes</span>&nbsp;<span class="op" id="4126361">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4126366">switch</span>&nbsp;<span class="ident" id="4126373">certType</span>&nbsp;<span class="op" id="4126382">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4126387">case</span>&nbsp;<span class="ident" id="4126392">certTypeRSASign</span><span class="op" id="4126407">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4126413">rsaAvail</span>&nbsp;<span class="op" id="4126422">=</span>&nbsp;<span class="builtintype" id="4126424">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4126432">case</span>&nbsp;<span class="ident" id="4126437">certTypeECDSASign</span><span class="op" id="4126454">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4126460">ecdsaAvail</span>&nbsp;<span class="op" id="4126471">=</span>&nbsp;<span class="builtintype" id="4126473">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4126481">}</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4126485">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4126490">//&nbsp;We&nbsp;need&nbsp;to&nbsp;search&nbsp;our&nbsp;list&nbsp;of&nbsp;client&nbsp;certs&nbsp;for&nbsp;one</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4126546">//&nbsp;where&nbsp;SignatureAlgorithm&nbsp;is&nbsp;acceptable&nbsp;to&nbsp;the&nbsp;server&nbsp;and&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4126612">//&nbsp;Issuer&nbsp;is&nbsp;in&nbsp;certReq.certificateAuthorities</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4126660">findCert</span><span class="op" id="4126668">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4126672">for</span>&nbsp;<span class="ident" id="4126676">i</span><span class="op" id="4126677">,</span>&nbsp;<span class="ident" id="4126679">chain</span>&nbsp;<span class="op" id="4126685">:=</span>&nbsp;<span class="keyword" id="4126688">range</span>&nbsp;<span class="ident" id="4126694">c</span><span class="op" id="4126695">.</span><span class="ident" id="4126696">config</span><span class="op" id="4126702">.</span><span class="ident" id="4126703">Certificates</span>&nbsp;<span class="op" id="4126716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4126721">if</span>&nbsp;<span class="op" id="4126724">!</span><span class="ident" id="4126725">rsaAvail</span>&nbsp;<span class="op" id="4126734">&amp;&amp;</span>&nbsp;<span class="op" id="4126737">!</span><span class="ident" id="4126738">ecdsaAvail</span>&nbsp;<span class="op" id="4126749">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4126755">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4126767">}</span><br>
<span class="lineno">355</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4126773">for</span>&nbsp;<span class="ident" id="4126777">j</span><span class="op" id="4126778">,</span>&nbsp;<span class="ident" id="4126780">cert</span>&nbsp;<span class="op" id="4126785">:=</span>&nbsp;<span class="keyword" id="4126788">range</span>&nbsp;<span class="ident" id="4126794">chain</span><span class="op" id="4126799">.</span><span class="ident" id="4126800">Certificate</span>&nbsp;<span class="op" id="4126812">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4126818">x509Cert</span>&nbsp;<span class="op" id="4126827">:=</span>&nbsp;<span class="ident" id="4126830">chain</span><span class="op" id="4126835">.</span><span class="ident" id="4126836">Leaf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4126845">//&nbsp;parse&nbsp;the&nbsp;certificate&nbsp;if&nbsp;this&nbsp;isn&#39;t&nbsp;the&nbsp;leaf</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4126897">//&nbsp;node,&nbsp;or&nbsp;if&nbsp;chain.Leaf&nbsp;was&nbsp;nil</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4126935">if</span>&nbsp;<span class="ident" id="4126938">j</span>&nbsp;<span class="op" id="4126940">!=</span>&nbsp;<span class="num" id="4126943">0</span>&nbsp;<span class="op" id="4126945">||</span>&nbsp;<span class="ident" id="4126948">x509Cert</span>&nbsp;<span class="op" id="4126957">==</span>&nbsp;<span class="ident" id="4126960">nil</span>&nbsp;<span class="op" id="4126964">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4126971">if</span>&nbsp;<span class="ident" id="4126974">x509Cert</span><span class="op" id="4126982">,</span>&nbsp;<span class="ident" id="4126984">err</span>&nbsp;<span class="op" id="4126988">=</span>&nbsp;<span class="ident" id="4126990">x509</span><span class="op" id="4126994">.</span><span class="ident" id="4126995">ParseCertificate</span><span class="op" id="4127011">(</span><span class="ident" id="4127012">cert</span><span class="op" id="4127016">)</span><span class="op" id="4127017">;</span>&nbsp;<span class="ident" id="4127019">err</span>&nbsp;<span class="op" id="4127023">!=</span>&nbsp;<span class="ident" id="4127026">nil</span>&nbsp;<span class="op" id="4127030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4127038">c</span><span class="op" id="4127039">.</span><span class="ident" id="4127040">sendAlert</span><span class="op" id="4127049">(</span><span class="ident" id="4127050">alertInternalError</span><span class="op" id="4127068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4127076">return</span>&nbsp;<span class="ident" id="4127083">errors</span><span class="op" id="4127089">.</span><span class="ident" id="4127090">New</span><span class="op" id="4127093">(</span><span class="string" id="4127094">&#34;tls:&nbsp;failed&nbsp;to&nbsp;parse&nbsp;client&nbsp;certificate&nbsp;#&#34;</span>&nbsp;<span class="op" id="4127138">+</span>&nbsp;<span class="ident" id="4127140">strconv</span><span class="op" id="4127147">.</span><span class="ident" id="4127148">Itoa</span><span class="op" id="4127152">(</span><span class="ident" id="4127153">i</span><span class="op" id="4127154">)</span>&nbsp;<span class="op" id="4127156">+</span>&nbsp;<span class="string" id="4127158">&#34;:&nbsp;&#34;</span>&nbsp;<span class="op" id="4127163">+</span>&nbsp;<span class="ident" id="4127165">err</span><span class="op" id="4127168">.</span><span class="ident" id="4127169">Error</span><span class="op" id="4127174">(</span><span class="op" id="4127175">)</span><span class="op" id="4127176">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4127183">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4127189">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4127196">switch</span>&nbsp;<span class="op" id="4127203">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4127209">case</span>&nbsp;<span class="ident" id="4127214">rsaAvail</span>&nbsp;<span class="op" id="4127223">&amp;&amp;</span>&nbsp;<span class="ident" id="4127226">x509Cert</span><span class="op" id="4127234">.</span><span class="ident" id="4127235">PublicKeyAlgorithm</span>&nbsp;<span class="op" id="4127254">==</span>&nbsp;<span class="ident" id="4127257">x509</span><span class="op" id="4127261">.</span><span class="ident" id="4127262">RSA</span><span class="op" id="4127265">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4127271">case</span>&nbsp;<span class="ident" id="4127276">ecdsaAvail</span>&nbsp;<span class="op" id="4127287">&amp;&amp;</span>&nbsp;<span class="ident" id="4127290">x509Cert</span><span class="op" id="4127298">.</span><span class="ident" id="4127299">PublicKeyAlgorithm</span>&nbsp;<span class="op" id="4127318">==</span>&nbsp;<span class="ident" id="4127321">x509</span><span class="op" id="4127325">.</span><span class="ident" id="4127326">ECDSA</span><span class="op" id="4127331">:</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4127337">default</span><span class="op" id="4127344">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4127351">continue</span>&nbsp;<span class="ident" id="4127360">findCert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4127373">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4127380">if</span>&nbsp;<span class="builtinfunc" id="4127383">len</span><span class="op" id="4127386">(</span><span class="ident" id="4127387">certReq</span><span class="op" id="4127394">.</span><span class="ident" id="4127395">certificateAuthorities</span><span class="op" id="4127417">)</span>&nbsp;<span class="op" id="4127419">==</span>&nbsp;<span class="num" id="4127422">0</span>&nbsp;<span class="op" id="4127424">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4127431">//&nbsp;they&nbsp;gave&nbsp;us&nbsp;an&nbsp;empty&nbsp;list,&nbsp;so&nbsp;just&nbsp;take&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4127484">//&nbsp;first&nbsp;cert&nbsp;from&nbsp;c.config.Certificates</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4127530">chainToSend</span>&nbsp;<span class="op" id="4127542">=</span>&nbsp;<span class="op" id="4127544">&amp;</span><span class="ident" id="4127545">chain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4127556">break</span>&nbsp;<span class="ident" id="4127562">findCert</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4127575">}</span><br>
<span class="lineno">380</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4127582">for</span>&nbsp;<span class="ident" id="4127586">_</span><span class="op" id="4127587">,</span>&nbsp;<span class="ident" id="4127589">ca</span>&nbsp;<span class="op" id="4127592">:=</span>&nbsp;<span class="keyword" id="4127595">range</span>&nbsp;<span class="ident" id="4127601">certReq</span><span class="op" id="4127608">.</span><span class="ident" id="4127609">certificateAuthorities</span>&nbsp;<span class="op" id="4127632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4127639">if</span>&nbsp;<span class="ident" id="4127642">bytes</span><span class="op" id="4127647">.</span><span class="ident" id="4127648">Equal</span><span class="op" id="4127653">(</span><span class="ident" id="4127654">x509Cert</span><span class="op" id="4127662">.</span><span class="ident" id="4127663">RawIssuer</span><span class="op" id="4127672">,</span>&nbsp;<span class="ident" id="4127674">ca</span><span class="op" id="4127676">)</span>&nbsp;<span class="op" id="4127678">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4127686">chainToSend</span>&nbsp;<span class="op" id="4127698">=</span>&nbsp;<span class="op" id="4127700">&amp;</span><span class="ident" id="4127701">chain</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4127713">break</span>&nbsp;<span class="ident" id="4127719">findCert</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4127733">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4127739">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4127744">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4127748">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4127753">msg</span><span class="op" id="4127756">,</span>&nbsp;<span class="ident" id="4127758">err</span>&nbsp;<span class="op" id="4127762">=</span>&nbsp;<span class="ident" id="4127764">c</span><span class="op" id="4127765">.</span><span class="ident" id="4127766">readHandshake</span><span class="op" id="4127779">(</span><span class="op" id="4127780">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4127784">if</span>&nbsp;<span class="ident" id="4127787">err</span>&nbsp;<span class="op" id="4127791">!=</span>&nbsp;<span class="ident" id="4127794">nil</span>&nbsp;<span class="op" id="4127798">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4127803">return</span>&nbsp;<span class="ident" id="4127810">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4127816">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4127819">}</span><br>
<span class="lineno">395</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4127823">shd</span><span class="op" id="4127826">,</span>&nbsp;<span class="ident" id="4127828">ok</span>&nbsp;<span class="op" id="4127831">:=</span>&nbsp;<span class="ident" id="4127834">msg</span><span class="op" id="4127837">.</span><span class="op" id="4127838">(</span><span class="op" id="4127839">*</span><span class="ident" id="4127840">serverHelloDoneMsg</span><span class="op" id="4127858">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4127861">if</span>&nbsp;<span class="op" id="4127864">!</span><span class="ident" id="4127865">ok</span>&nbsp;<span class="op" id="4127868">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4127872">c</span><span class="op" id="4127873">.</span><span class="ident" id="4127874">sendAlert</span><span class="op" id="4127883">(</span><span class="ident" id="4127884">alertUnexpectedMessage</span><span class="op" id="4127906">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4127910">return</span>&nbsp;<span class="ident" id="4127917">unexpectedMessageError</span><span class="op" id="4127939">(</span><span class="ident" id="4127940">shd</span><span class="op" id="4127943">,</span>&nbsp;<span class="ident" id="4127945">msg</span><span class="op" id="4127948">)</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4127951">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4127954">hs</span><span class="op" id="4127956">.</span><span class="ident" id="4127957">finishedHash</span><span class="op" id="4127969">.</span><span class="ident" id="4127970">Write</span><span class="op" id="4127975">(</span><span class="ident" id="4127976">shd</span><span class="op" id="4127979">.</span><span class="ident" id="4127980">marshal</span><span class="op" id="4127987">(</span><span class="op" id="4127988">)</span><span class="op" id="4127989">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4127993">//&nbsp;If&nbsp;the&nbsp;server&nbsp;requested&nbsp;a&nbsp;certificate&nbsp;then&nbsp;we&nbsp;have&nbsp;to&nbsp;send&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4128058">//&nbsp;Certificate&nbsp;message,&nbsp;even&nbsp;if&nbsp;it&#39;s&nbsp;empty&nbsp;because&nbsp;we&nbsp;don&#39;t&nbsp;have&nbsp;a</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4128126">//&nbsp;certificate&nbsp;to&nbsp;send.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4128151">if</span>&nbsp;<span class="ident" id="4128154">certRequested</span>&nbsp;<span class="op" id="4128168">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4128172">certMsg</span>&nbsp;<span class="op" id="4128180">=</span>&nbsp;<span class="builtinfunc" id="4128182">new</span><span class="op" id="4128185">(</span><span class="ident" id="4128186">certificateMsg</span><span class="op" id="4128200">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4128204">if</span>&nbsp;<span class="ident" id="4128207">chainToSend</span>&nbsp;<span class="op" id="4128219">!=</span>&nbsp;<span class="ident" id="4128222">nil</span>&nbsp;<span class="op" id="4128226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4128231">certMsg</span><span class="op" id="4128238">.</span><span class="ident" id="4128239">certificates</span>&nbsp;<span class="op" id="4128252">=</span>&nbsp;<span class="ident" id="4128254">chainToSend</span><span class="op" id="4128265">.</span><span class="ident" id="4128266">Certificate</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4128280">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4128284">hs</span><span class="op" id="4128286">.</span><span class="ident" id="4128287">finishedHash</span><span class="op" id="4128299">.</span><span class="ident" id="4128300">Write</span><span class="op" id="4128305">(</span><span class="ident" id="4128306">certMsg</span><span class="op" id="4128313">.</span><span class="ident" id="4128314">marshal</span><span class="op" id="4128321">(</span><span class="op" id="4128322">)</span><span class="op" id="4128323">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4128327">c</span><span class="op" id="4128328">.</span><span class="ident" id="4128329">writeRecord</span><span class="op" id="4128340">(</span><span class="ident" id="4128341">recordTypeHandshake</span><span class="op" id="4128360">,</span>&nbsp;<span class="ident" id="4128362">certMsg</span><span class="op" id="4128369">.</span><span class="ident" id="4128370">marshal</span><span class="op" id="4128377">(</span><span class="op" id="4128378">)</span><span class="op" id="4128379">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4128382">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4128386">preMasterSecret</span><span class="op" id="4128401">,</span>&nbsp;<span class="ident" id="4128403">ckx</span><span class="op" id="4128406">,</span>&nbsp;<span class="ident" id="4128408">err</span>&nbsp;<span class="op" id="4128412">:=</span>&nbsp;<span class="ident" id="4128415">keyAgreement</span><span class="op" id="4128427">.</span><span class="ident" id="4128428">generateClientKeyExchange</span><span class="op" id="4128453">(</span><span class="ident" id="4128454">c</span><span class="op" id="4128455">.</span><span class="ident" id="4128456">config</span><span class="op" id="4128462">,</span>&nbsp;<span class="ident" id="4128464">hs</span><span class="op" id="4128466">.</span><span class="ident" id="4128467">hello</span><span class="op" id="4128472">,</span>&nbsp;<span class="ident" id="4128474">certs</span><span class="op" id="4128479">[</span><span class="num" id="4128480">0</span><span class="op" id="4128481">]</span><span class="op" id="4128482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4128485">if</span>&nbsp;<span class="ident" id="4128488">err</span>&nbsp;<span class="op" id="4128492">!=</span>&nbsp;<span class="ident" id="4128495">nil</span>&nbsp;<span class="op" id="4128499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4128503">c</span><span class="op" id="4128504">.</span><span class="ident" id="4128505">sendAlert</span><span class="op" id="4128514">(</span><span class="ident" id="4128515">alertInternalError</span><span class="op" id="4128533">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4128537">return</span>&nbsp;<span class="ident" id="4128544">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4128549">}</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4128552">if</span>&nbsp;<span class="ident" id="4128555">ckx</span>&nbsp;<span class="op" id="4128559">!=</span>&nbsp;<span class="ident" id="4128562">nil</span>&nbsp;<span class="op" id="4128566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4128570">hs</span><span class="op" id="4128572">.</span><span class="ident" id="4128573">finishedHash</span><span class="op" id="4128585">.</span><span class="ident" id="4128586">Write</span><span class="op" id="4128591">(</span><span class="ident" id="4128592">ckx</span><span class="op" id="4128595">.</span><span class="ident" id="4128596">marshal</span><span class="op" id="4128603">(</span><span class="op" id="4128604">)</span><span class="op" id="4128605">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4128609">c</span><span class="op" id="4128610">.</span><span class="ident" id="4128611">writeRecord</span><span class="op" id="4128622">(</span><span class="ident" id="4128623">recordTypeHandshake</span><span class="op" id="4128642">,</span>&nbsp;<span class="ident" id="4128644">ckx</span><span class="op" id="4128647">.</span><span class="ident" id="4128648">marshal</span><span class="op" id="4128655">(</span><span class="op" id="4128656">)</span><span class="op" id="4128657">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4128660">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4128664">if</span>&nbsp;<span class="ident" id="4128667">chainToSend</span>&nbsp;<span class="op" id="4128679">!=</span>&nbsp;<span class="ident" id="4128682">nil</span>&nbsp;<span class="op" id="4128686">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4128690">var</span>&nbsp;<span class="ident" id="4128694">signed</span>&nbsp;<span class="op" id="4128701">[</span><span class="op" id="4128702">]</span><span class="builtintype" id="4128703">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4128710">certVerify</span>&nbsp;<span class="op" id="4128721">:=</span>&nbsp;<span class="op" id="4128724">&amp;</span><span class="ident" id="4128725">certificateVerifyMsg</span><span class="op" id="4128745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4128750">hasSignatureAndHash</span><span class="op" id="4128769">:</span>&nbsp;<span class="ident" id="4128771">c</span><span class="op" id="4128772">.</span><span class="ident" id="4128773">vers</span>&nbsp;<span class="op" id="4128778">&gt;=</span>&nbsp;<span class="ident" id="4128781">VersionTLS12</span><span class="op" id="4128793">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4128797">}</span><br>
<span class="lineno">430</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4128802">key</span><span class="op" id="4128805">,</span>&nbsp;<span class="ident" id="4128807">ok</span>&nbsp;<span class="op" id="4128810">:=</span>&nbsp;<span class="ident" id="4128813">chainToSend</span><span class="op" id="4128824">.</span><span class="ident" id="4128825">PrivateKey</span><span class="op" id="4128835">.</span><span class="op" id="4128836">(</span><span class="ident" id="4128837">crypto</span><span class="op" id="4128843">.</span><span class="ident" id="4128844">Signer</span><span class="op" id="4128850">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4128854">if</span>&nbsp;<span class="op" id="4128857">!</span><span class="ident" id="4128858">ok</span>&nbsp;<span class="op" id="4128861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4128866">c</span><span class="op" id="4128867">.</span><span class="ident" id="4128868">sendAlert</span><span class="op" id="4128877">(</span><span class="ident" id="4128878">alertInternalError</span><span class="op" id="4128896">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4128901">return</span>&nbsp;<span class="ident" id="4128908">fmt</span><span class="op" id="4128911">.</span><span class="ident" id="4128912">Errorf</span><span class="op" id="4128918">(</span><span class="string" id="4128919">&#34;tls:&nbsp;client&nbsp;certificate&nbsp;private&nbsp;key&nbsp;of&nbsp;type&nbsp;%T&nbsp;does&nbsp;not&nbsp;implement&nbsp;crypto.Signer&#34;</span><span class="op" id="4129000">,</span>&nbsp;<span class="ident" id="4129002">chainToSend</span><span class="op" id="4129013">.</span><span class="ident" id="4129014">PrivateKey</span><span class="op" id="4129024">)</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4129028">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4129032">switch</span>&nbsp;<span class="ident" id="4129039">key</span><span class="op" id="4129042">.</span><span class="ident" id="4129043">Public</span><span class="op" id="4129049">(</span><span class="op" id="4129050">)</span><span class="op" id="4129051">.</span><span class="op" id="4129052">(</span><span class="keyword" id="4129053">type</span><span class="op" id="4129057">)</span>&nbsp;<span class="op" id="4129059">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4129063">case</span>&nbsp;<span class="op" id="4129068">*</span><span class="ident" id="4129069">ecdsa</span><span class="op" id="4129074">.</span><span class="ident" id="4129075">PublicKey</span><span class="op" id="4129084">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4129089">digest</span><span class="op" id="4129095">,</span>&nbsp;<span class="ident" id="4129097">hashFunc</span><span class="op" id="4129105">,</span>&nbsp;<span class="ident" id="4129107">hashId</span>&nbsp;<span class="op" id="4129114">:=</span>&nbsp;<span class="ident" id="4129117">hs</span><span class="op" id="4129119">.</span><span class="ident" id="4129120">finishedHash</span><span class="op" id="4129132">.</span><span class="ident" id="4129133">hashForClientCertificate</span><span class="op" id="4129157">(</span><span class="ident" id="4129158">signatureECDSA</span><span class="op" id="4129172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4129177">signed</span><span class="op" id="4129183">,</span>&nbsp;<span class="ident" id="4129185">err</span>&nbsp;<span class="op" id="4129189">=</span>&nbsp;<span class="ident" id="4129191">key</span><span class="op" id="4129194">.</span><span class="ident" id="4129195">Sign</span><span class="op" id="4129199">(</span><span class="ident" id="4129200">c</span><span class="op" id="4129201">.</span><span class="ident" id="4129202">config</span><span class="op" id="4129208">.</span><span class="ident" id="4129209">rand</span><span class="op" id="4129213">(</span><span class="op" id="4129214">)</span><span class="op" id="4129215">,</span>&nbsp;<span class="ident" id="4129217">digest</span><span class="op" id="4129223">,</span>&nbsp;<span class="ident" id="4129225">hashFunc</span><span class="op" id="4129233">)</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4129238">certVerify</span><span class="op" id="4129248">.</span><span class="ident" id="4129249">signatureAndHash</span><span class="op" id="4129265">.</span><span class="ident" id="4129266">signature</span>&nbsp;<span class="op" id="4129276">=</span>&nbsp;<span class="ident" id="4129278">signatureECDSA</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4129296">certVerify</span><span class="op" id="4129306">.</span><span class="ident" id="4129307">signatureAndHash</span><span class="op" id="4129323">.</span><span class="ident" id="4129324">hash</span>&nbsp;<span class="op" id="4129329">=</span>&nbsp;<span class="ident" id="4129331">hashId</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4129340">case</span>&nbsp;<span class="op" id="4129345">*</span><span class="ident" id="4129346">rsa</span><span class="op" id="4129349">.</span><span class="ident" id="4129350">PublicKey</span><span class="op" id="4129359">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4129364">digest</span><span class="op" id="4129370">,</span>&nbsp;<span class="ident" id="4129372">hashFunc</span><span class="op" id="4129380">,</span>&nbsp;<span class="ident" id="4129382">hashId</span>&nbsp;<span class="op" id="4129389">:=</span>&nbsp;<span class="ident" id="4129392">hs</span><span class="op" id="4129394">.</span><span class="ident" id="4129395">finishedHash</span><span class="op" id="4129407">.</span><span class="ident" id="4129408">hashForClientCertificate</span><span class="op" id="4129432">(</span><span class="ident" id="4129433">signatureRSA</span><span class="op" id="4129445">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4129450">signed</span><span class="op" id="4129456">,</span>&nbsp;<span class="ident" id="4129458">err</span>&nbsp;<span class="op" id="4129462">=</span>&nbsp;<span class="ident" id="4129464">key</span><span class="op" id="4129467">.</span><span class="ident" id="4129468">Sign</span><span class="op" id="4129472">(</span><span class="ident" id="4129473">c</span><span class="op" id="4129474">.</span><span class="ident" id="4129475">config</span><span class="op" id="4129481">.</span><span class="ident" id="4129482">rand</span><span class="op" id="4129486">(</span><span class="op" id="4129487">)</span><span class="op" id="4129488">,</span>&nbsp;<span class="ident" id="4129490">digest</span><span class="op" id="4129496">,</span>&nbsp;<span class="ident" id="4129498">hashFunc</span><span class="op" id="4129506">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4129511">certVerify</span><span class="op" id="4129521">.</span><span class="ident" id="4129522">signatureAndHash</span><span class="op" id="4129538">.</span><span class="ident" id="4129539">signature</span>&nbsp;<span class="op" id="4129549">=</span>&nbsp;<span class="ident" id="4129551">signatureRSA</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4129567">certVerify</span><span class="op" id="4129577">.</span><span class="ident" id="4129578">signatureAndHash</span><span class="op" id="4129594">.</span><span class="ident" id="4129595">hash</span>&nbsp;<span class="op" id="4129600">=</span>&nbsp;<span class="ident" id="4129602">hashId</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4129611">default</span><span class="op" id="4129618">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4129623">err</span>&nbsp;<span class="op" id="4129627">=</span>&nbsp;<span class="ident" id="4129629">fmt</span><span class="op" id="4129632">.</span><span class="ident" id="4129633">Errorf</span><span class="op" id="4129639">(</span><span class="string" id="4129640">&#34;tls:&nbsp;unknown&nbsp;client&nbsp;certificate&nbsp;key&nbsp;type:&nbsp;%T&#34;</span><span class="op" id="4129686">,</span>&nbsp;<span class="ident" id="4129688">key</span><span class="op" id="4129691">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4129695">}</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4129699">if</span>&nbsp;<span class="ident" id="4129702">err</span>&nbsp;<span class="op" id="4129706">!=</span>&nbsp;<span class="ident" id="4129709">nil</span>&nbsp;<span class="op" id="4129713">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4129718">c</span><span class="op" id="4129719">.</span><span class="ident" id="4129720">sendAlert</span><span class="op" id="4129729">(</span><span class="ident" id="4129730">alertInternalError</span><span class="op" id="4129748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4129753">return</span>&nbsp;<span class="ident" id="4129760">errors</span><span class="op" id="4129766">.</span><span class="ident" id="4129767">New</span><span class="op" id="4129770">(</span><span class="string" id="4129771">&#34;tls:&nbsp;failed&nbsp;to&nbsp;sign&nbsp;handshake&nbsp;with&nbsp;client&nbsp;certificate:&nbsp;&#34;</span>&nbsp;<span class="op" id="4129829">+</span>&nbsp;<span class="ident" id="4129831">err</span><span class="op" id="4129834">.</span><span class="ident" id="4129835">Error</span><span class="op" id="4129840">(</span><span class="op" id="4129841">)</span><span class="op" id="4129842">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4129846">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4129850">certVerify</span><span class="op" id="4129860">.</span><span class="ident" id="4129861">signature</span>&nbsp;<span class="op" id="4129871">=</span>&nbsp;<span class="ident" id="4129873">signed</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4129883">hs</span><span class="op" id="4129885">.</span><span class="ident" id="4129886">finishedHash</span><span class="op" id="4129898">.</span><span class="ident" id="4129899">Write</span><span class="op" id="4129904">(</span><span class="ident" id="4129905">certVerify</span><span class="op" id="4129915">.</span><span class="ident" id="4129916">marshal</span><span class="op" id="4129923">(</span><span class="op" id="4129924">)</span><span class="op" id="4129925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4129929">c</span><span class="op" id="4129930">.</span><span class="ident" id="4129931">writeRecord</span><span class="op" id="4129942">(</span><span class="ident" id="4129943">recordTypeHandshake</span><span class="op" id="4129962">,</span>&nbsp;<span class="ident" id="4129964">certVerify</span><span class="op" id="4129974">.</span><span class="ident" id="4129975">marshal</span><span class="op" id="4129982">(</span><span class="op" id="4129983">)</span><span class="op" id="4129984">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4129987">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4129991">hs</span><span class="op" id="4129993">.</span><span class="ident" id="4129994">masterSecret</span>&nbsp;<span class="op" id="4130007">=</span>&nbsp;<span class="ident" id="4130009">masterFromPreMasterSecret</span><span class="op" id="4130034">(</span><span class="ident" id="4130035">c</span><span class="op" id="4130036">.</span><span class="ident" id="4130037">vers</span><span class="op" id="4130041">,</span>&nbsp;<span class="ident" id="4130043">preMasterSecret</span><span class="op" id="4130058">,</span>&nbsp;<span class="ident" id="4130060">hs</span><span class="op" id="4130062">.</span><span class="ident" id="4130063">hello</span><span class="op" id="4130068">.</span><span class="ident" id="4130069">random</span><span class="op" id="4130075">,</span>&nbsp;<span class="ident" id="4130077">hs</span><span class="op" id="4130079">.</span><span class="ident" id="4130080">serverHello</span><span class="op" id="4130091">.</span><span class="ident" id="4130092">random</span><span class="op" id="4130098">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4130101">return</span>&nbsp;<span class="ident" id="4130108">nil</span><br>
<span class="lineno"></span><span class="op" id="4130112">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4130115">func</span>&nbsp;<span class="op" id="4130120">(</span><span class="ident" id="4130121">hs</span>&nbsp;<span class="op" id="4130124">*</span><span class="ident" id="4130125">clientHandshakeState</span><span class="op" id="4130145">)</span>&nbsp;<span class="ident" id="4130147">establishKeys</span><span class="op" id="4130160">(</span><span class="op" id="4130161">)</span>&nbsp;<span class="builtintype" id="4130163">error</span>&nbsp;<span class="op" id="4130169">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4130172">c</span>&nbsp;<span class="op" id="4130174">:=</span>&nbsp;<span class="ident" id="4130177">hs</span><span class="op" id="4130179">.</span><span class="ident" id="4130180">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4130184">clientMAC</span><span class="op" id="4130193">,</span>&nbsp;<span class="ident" id="4130195">serverMAC</span><span class="op" id="4130204">,</span>&nbsp;<span class="ident" id="4130206">clientKey</span><span class="op" id="4130215">,</span>&nbsp;<span class="ident" id="4130217">serverKey</span><span class="op" id="4130226">,</span>&nbsp;<span class="ident" id="4130228">clientIV</span><span class="op" id="4130236">,</span>&nbsp;<span class="ident" id="4130238">serverIV</span>&nbsp;<span class="op" id="4130247">:=</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4130252">keysFromMasterSecret</span><span class="op" id="4130272">(</span><span class="ident" id="4130273">c</span><span class="op" id="4130274">.</span><span class="ident" id="4130275">vers</span><span class="op" id="4130279">,</span>&nbsp;<span class="ident" id="4130281">hs</span><span class="op" id="4130283">.</span><span class="ident" id="4130284">masterSecret</span><span class="op" id="4130296">,</span>&nbsp;<span class="ident" id="4130298">hs</span><span class="op" id="4130300">.</span><span class="ident" id="4130301">hello</span><span class="op" id="4130306">.</span><span class="ident" id="4130307">random</span><span class="op" id="4130313">,</span>&nbsp;<span class="ident" id="4130315">hs</span><span class="op" id="4130317">.</span><span class="ident" id="4130318">serverHello</span><span class="op" id="4130329">.</span><span class="ident" id="4130330">random</span><span class="op" id="4130336">,</span>&nbsp;<span class="ident" id="4130338">hs</span><span class="op" id="4130340">.</span><span class="ident" id="4130341">suite</span><span class="op" id="4130346">.</span><span class="ident" id="4130347">macLen</span><span class="op" id="4130353">,</span>&nbsp;<span class="ident" id="4130355">hs</span><span class="op" id="4130357">.</span><span class="ident" id="4130358">suite</span><span class="op" id="4130363">.</span><span class="ident" id="4130364">keyLen</span><span class="op" id="4130370">,</span>&nbsp;<span class="ident" id="4130372">hs</span><span class="op" id="4130374">.</span><span class="ident" id="4130375">suite</span><span class="op" id="4130380">.</span><span class="ident" id="4130381">ivLen</span><span class="op" id="4130386">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4130389">var</span>&nbsp;<span class="ident" id="4130393">clientCipher</span><span class="op" id="4130405">,</span>&nbsp;<span class="ident" id="4130407">serverCipher</span>&nbsp;<span class="keyword" id="4130420">interface</span><span class="op" id="4130429">{</span><span class="op" id="4130430">}</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4130433">var</span>&nbsp;<span class="ident" id="4130437">clientHash</span><span class="op" id="4130447">,</span>&nbsp;<span class="ident" id="4130449">serverHash</span>&nbsp;<span class="ident" id="4130460">macFunction</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4130473">if</span>&nbsp;<span class="ident" id="4130476">hs</span><span class="op" id="4130478">.</span><span class="ident" id="4130479">suite</span><span class="op" id="4130484">.</span><span class="ident" id="4130485">cipher</span>&nbsp;<span class="op" id="4130492">!=</span>&nbsp;<span class="ident" id="4130495">nil</span>&nbsp;<span class="op" id="4130499">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4130503">clientCipher</span>&nbsp;<span class="op" id="4130516">=</span>&nbsp;<span class="ident" id="4130518">hs</span><span class="op" id="4130520">.</span><span class="ident" id="4130521">suite</span><span class="op" id="4130526">.</span><span class="ident" id="4130527">cipher</span><span class="op" id="4130533">(</span><span class="ident" id="4130534">clientKey</span><span class="op" id="4130543">,</span>&nbsp;<span class="ident" id="4130545">clientIV</span><span class="op" id="4130553">,</span>&nbsp;<span class="builtintype" id="4130555">false</span>&nbsp;<span class="comment" id="4130561">/*&nbsp;not&nbsp;for&nbsp;reading&nbsp;*/</span><span class="op" id="4130582">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4130586">clientHash</span>&nbsp;<span class="op" id="4130597">=</span>&nbsp;<span class="ident" id="4130599">hs</span><span class="op" id="4130601">.</span><span class="ident" id="4130602">suite</span><span class="op" id="4130607">.</span><span class="ident" id="4130608">mac</span><span class="op" id="4130611">(</span><span class="ident" id="4130612">c</span><span class="op" id="4130613">.</span><span class="ident" id="4130614">vers</span><span class="op" id="4130618">,</span>&nbsp;<span class="ident" id="4130620">clientMAC</span><span class="op" id="4130629">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4130633">serverCipher</span>&nbsp;<span class="op" id="4130646">=</span>&nbsp;<span class="ident" id="4130648">hs</span><span class="op" id="4130650">.</span><span class="ident" id="4130651">suite</span><span class="op" id="4130656">.</span><span class="ident" id="4130657">cipher</span><span class="op" id="4130663">(</span><span class="ident" id="4130664">serverKey</span><span class="op" id="4130673">,</span>&nbsp;<span class="ident" id="4130675">serverIV</span><span class="op" id="4130683">,</span>&nbsp;<span class="builtintype" id="4130685">true</span>&nbsp;<span class="comment" id="4130690">/*&nbsp;for&nbsp;reading&nbsp;*/</span><span class="op" id="4130707">)</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4130711">serverHash</span>&nbsp;<span class="op" id="4130722">=</span>&nbsp;<span class="ident" id="4130724">hs</span><span class="op" id="4130726">.</span><span class="ident" id="4130727">suite</span><span class="op" id="4130732">.</span><span class="ident" id="4130733">mac</span><span class="op" id="4130736">(</span><span class="ident" id="4130737">c</span><span class="op" id="4130738">.</span><span class="ident" id="4130739">vers</span><span class="op" id="4130743">,</span>&nbsp;<span class="ident" id="4130745">serverMAC</span><span class="op" id="4130754">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4130757">}</span>&nbsp;<span class="keyword" id="4130759">else</span>&nbsp;<span class="op" id="4130764">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4130768">clientCipher</span>&nbsp;<span class="op" id="4130781">=</span>&nbsp;<span class="ident" id="4130783">hs</span><span class="op" id="4130785">.</span><span class="ident" id="4130786">suite</span><span class="op" id="4130791">.</span><span class="ident" id="4130792">aead</span><span class="op" id="4130796">(</span><span class="ident" id="4130797">clientKey</span><span class="op" id="4130806">,</span>&nbsp;<span class="ident" id="4130808">clientIV</span><span class="op" id="4130816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4130820">serverCipher</span>&nbsp;<span class="op" id="4130833">=</span>&nbsp;<span class="ident" id="4130835">hs</span><span class="op" id="4130837">.</span><span class="ident" id="4130838">suite</span><span class="op" id="4130843">.</span><span class="ident" id="4130844">aead</span><span class="op" id="4130848">(</span><span class="ident" id="4130849">serverKey</span><span class="op" id="4130858">,</span>&nbsp;<span class="ident" id="4130860">serverIV</span><span class="op" id="4130868">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4130871">}</span><br>
<span class="lineno">480</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4130875">c</span><span class="op" id="4130876">.</span><span class="ident" id="4130877">in</span><span class="op" id="4130879">.</span><span class="ident" id="4130880">prepareCipherSpec</span><span class="op" id="4130897">(</span><span class="ident" id="4130898">c</span><span class="op" id="4130899">.</span><span class="ident" id="4130900">vers</span><span class="op" id="4130904">,</span>&nbsp;<span class="ident" id="4130906">serverCipher</span><span class="op" id="4130918">,</span>&nbsp;<span class="ident" id="4130920">serverHash</span><span class="op" id="4130930">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4130933">c</span><span class="op" id="4130934">.</span><span class="ident" id="4130935">out</span><span class="op" id="4130938">.</span><span class="ident" id="4130939">prepareCipherSpec</span><span class="op" id="4130956">(</span><span class="ident" id="4130957">c</span><span class="op" id="4130958">.</span><span class="ident" id="4130959">vers</span><span class="op" id="4130963">,</span>&nbsp;<span class="ident" id="4130965">clientCipher</span><span class="op" id="4130977">,</span>&nbsp;<span class="ident" id="4130979">clientHash</span><span class="op" id="4130989">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4130992">return</span>&nbsp;<span class="ident" id="4130999">nil</span><br>
<span class="lineno"></span><span class="op" id="4131003">}</span><br>
<span class="lineno">485</span><br>
<span class="lineno"></span><span class="keyword" id="4131006">func</span>&nbsp;<span class="op" id="4131011">(</span><span class="ident" id="4131012">hs</span>&nbsp;<span class="op" id="4131015">*</span><span class="ident" id="4131016">clientHandshakeState</span><span class="op" id="4131036">)</span>&nbsp;<span class="ident" id="4131038">serverResumedSession</span><span class="op" id="4131058">(</span><span class="op" id="4131059">)</span>&nbsp;<span class="builtintype" id="4131061">bool</span>&nbsp;<span class="op" id="4131066">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4131069">//&nbsp;If&nbsp;the&nbsp;server&nbsp;responded&nbsp;with&nbsp;the&nbsp;same&nbsp;sessionId&nbsp;then&nbsp;it&nbsp;means&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4131139">//&nbsp;sessionTicket&nbsp;is&nbsp;being&nbsp;used&nbsp;to&nbsp;resume&nbsp;a&nbsp;TLS&nbsp;session.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4131196">return</span>&nbsp;<span class="ident" id="4131203">hs</span><span class="op" id="4131205">.</span><span class="ident" id="4131206">session</span>&nbsp;<span class="op" id="4131214">!=</span>&nbsp;<span class="ident" id="4131217">nil</span>&nbsp;<span class="op" id="4131221">&amp;&amp;</span>&nbsp;<span class="ident" id="4131224">hs</span><span class="op" id="4131226">.</span><span class="ident" id="4131227">hello</span><span class="op" id="4131232">.</span><span class="ident" id="4131233">sessionId</span>&nbsp;<span class="op" id="4131243">!=</span>&nbsp;<span class="ident" id="4131246">nil</span>&nbsp;<span class="op" id="4131250">&amp;&amp;</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4131255">bytes</span><span class="op" id="4131260">.</span><span class="ident" id="4131261">Equal</span><span class="op" id="4131266">(</span><span class="ident" id="4131267">hs</span><span class="op" id="4131269">.</span><span class="ident" id="4131270">serverHello</span><span class="op" id="4131281">.</span><span class="ident" id="4131282">sessionId</span><span class="op" id="4131291">,</span>&nbsp;<span class="ident" id="4131293">hs</span><span class="op" id="4131295">.</span><span class="ident" id="4131296">hello</span><span class="op" id="4131301">.</span><span class="ident" id="4131302">sessionId</span><span class="op" id="4131311">)</span><br>
<span class="lineno"></span><span class="op" id="4131313">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4131316">func</span>&nbsp;<span class="op" id="4131321">(</span><span class="ident" id="4131322">hs</span>&nbsp;<span class="op" id="4131325">*</span><span class="ident" id="4131326">clientHandshakeState</span><span class="op" id="4131346">)</span>&nbsp;<span class="ident" id="4131348">processServerHello</span><span class="op" id="4131366">(</span><span class="op" id="4131367">)</span>&nbsp;<span class="op" id="4131369">(</span><span class="builtintype" id="4131370">bool</span><span class="op" id="4131374">,</span>&nbsp;<span class="builtintype" id="4131376">error</span><span class="op" id="4131381">)</span>&nbsp;<span class="op" id="4131383">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4131386">c</span>&nbsp;<span class="op" id="4131388">:=</span>&nbsp;<span class="ident" id="4131391">hs</span><span class="op" id="4131393">.</span><span class="ident" id="4131394">c</span><br>
<span class="lineno">495</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4131398">if</span>&nbsp;<span class="ident" id="4131401">hs</span><span class="op" id="4131403">.</span><span class="ident" id="4131404">serverHello</span><span class="op" id="4131415">.</span><span class="ident" id="4131416">compressionMethod</span>&nbsp;<span class="op" id="4131434">!=</span>&nbsp;<span class="ident" id="4131437">compressionNone</span>&nbsp;<span class="op" id="4131453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4131457">c</span><span class="op" id="4131458">.</span><span class="ident" id="4131459">sendAlert</span><span class="op" id="4131468">(</span><span class="ident" id="4131469">alertUnexpectedMessage</span><span class="op" id="4131491">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4131495">return</span>&nbsp;<span class="builtintype" id="4131502">false</span><span class="op" id="4131507">,</span>&nbsp;<span class="ident" id="4131509">errors</span><span class="op" id="4131515">.</span><span class="ident" id="4131516">New</span><span class="op" id="4131519">(</span><span class="string" id="4131520">&#34;tls:&nbsp;server&nbsp;selected&nbsp;unsupported&nbsp;compression&nbsp;format&#34;</span><span class="op" id="4131573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4131576">}</span><br>
<span class="lineno">500</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4131580">clientDidNPN</span>&nbsp;<span class="op" id="4131593">:=</span>&nbsp;<span class="ident" id="4131596">hs</span><span class="op" id="4131598">.</span><span class="ident" id="4131599">hello</span><span class="op" id="4131604">.</span><span class="ident" id="4131605">nextProtoNeg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4131619">clientDidALPN</span>&nbsp;<span class="op" id="4131633">:=</span>&nbsp;<span class="builtinfunc" id="4131636">len</span><span class="op" id="4131639">(</span><span class="ident" id="4131640">hs</span><span class="op" id="4131642">.</span><span class="ident" id="4131643">hello</span><span class="op" id="4131648">.</span><span class="ident" id="4131649">alpnProtocols</span><span class="op" id="4131662">)</span>&nbsp;<span class="op" id="4131664">&gt;</span>&nbsp;<span class="num" id="4131666">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4131669">serverHasNPN</span>&nbsp;<span class="op" id="4131682">:=</span>&nbsp;<span class="ident" id="4131685">hs</span><span class="op" id="4131687">.</span><span class="ident" id="4131688">serverHello</span><span class="op" id="4131699">.</span><span class="ident" id="4131700">nextProtoNeg</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4131714">serverHasALPN</span>&nbsp;<span class="op" id="4131728">:=</span>&nbsp;<span class="builtinfunc" id="4131731">len</span><span class="op" id="4131734">(</span><span class="ident" id="4131735">hs</span><span class="op" id="4131737">.</span><span class="ident" id="4131738">serverHello</span><span class="op" id="4131749">.</span><span class="ident" id="4131750">alpnProtocol</span><span class="op" id="4131762">)</span>&nbsp;<span class="op" id="4131764">&gt;</span>&nbsp;<span class="num" id="4131766">0</span><br>
<span class="lineno">505</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4131770">if</span>&nbsp;<span class="op" id="4131773">!</span><span class="ident" id="4131774">clientDidNPN</span>&nbsp;<span class="op" id="4131787">&amp;&amp;</span>&nbsp;<span class="ident" id="4131790">serverHasNPN</span>&nbsp;<span class="op" id="4131803">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4131807">c</span><span class="op" id="4131808">.</span><span class="ident" id="4131809">sendAlert</span><span class="op" id="4131818">(</span><span class="ident" id="4131819">alertHandshakeFailure</span><span class="op" id="4131840">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4131844">return</span>&nbsp;<span class="builtintype" id="4131851">false</span><span class="op" id="4131856">,</span>&nbsp;<span class="ident" id="4131858">errors</span><span class="op" id="4131864">.</span><span class="ident" id="4131865">New</span><span class="op" id="4131868">(</span><span class="string" id="4131869">&#34;server&nbsp;advertised&nbsp;unrequested&nbsp;NPN&nbsp;extension&#34;</span><span class="op" id="4131914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4131917">}</span><br>
<span class="lineno">510</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4131921">if</span>&nbsp;<span class="op" id="4131924">!</span><span class="ident" id="4131925">clientDidALPN</span>&nbsp;<span class="op" id="4131939">&amp;&amp;</span>&nbsp;<span class="ident" id="4131942">serverHasALPN</span>&nbsp;<span class="op" id="4131956">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4131960">c</span><span class="op" id="4131961">.</span><span class="ident" id="4131962">sendAlert</span><span class="op" id="4131971">(</span><span class="ident" id="4131972">alertHandshakeFailure</span><span class="op" id="4131993">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4131997">return</span>&nbsp;<span class="builtintype" id="4132004">false</span><span class="op" id="4132009">,</span>&nbsp;<span class="ident" id="4132011">errors</span><span class="op" id="4132017">.</span><span class="ident" id="4132018">New</span><span class="op" id="4132021">(</span><span class="string" id="4132022">&#34;server&nbsp;advertised&nbsp;unrequested&nbsp;ALPN&nbsp;extension&#34;</span><span class="op" id="4132068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4132071">}</span><br>
<span class="lineno">515</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4132075">if</span>&nbsp;<span class="ident" id="4132078">serverHasNPN</span>&nbsp;<span class="op" id="4132091">&amp;&amp;</span>&nbsp;<span class="ident" id="4132094">serverHasALPN</span>&nbsp;<span class="op" id="4132108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4132112">c</span><span class="op" id="4132113">.</span><span class="ident" id="4132114">sendAlert</span><span class="op" id="4132123">(</span><span class="ident" id="4132124">alertHandshakeFailure</span><span class="op" id="4132145">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4132149">return</span>&nbsp;<span class="builtintype" id="4132156">false</span><span class="op" id="4132161">,</span>&nbsp;<span class="ident" id="4132163">errors</span><span class="op" id="4132169">.</span><span class="ident" id="4132170">New</span><span class="op" id="4132173">(</span><span class="string" id="4132174">&#34;server&nbsp;advertised&nbsp;both&nbsp;NPN&nbsp;and&nbsp;ALPN&nbsp;extensions&#34;</span><span class="op" id="4132222">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4132225">}</span><br>
<span class="lineno">520</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4132229">if</span>&nbsp;<span class="ident" id="4132232">serverHasALPN</span>&nbsp;<span class="op" id="4132246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4132250">c</span><span class="op" id="4132251">.</span><span class="ident" id="4132252">clientProtocol</span>&nbsp;<span class="op" id="4132267">=</span>&nbsp;<span class="ident" id="4132269">hs</span><span class="op" id="4132271">.</span><span class="ident" id="4132272">serverHello</span><span class="op" id="4132283">.</span><span class="ident" id="4132284">alpnProtocol</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4132299">c</span><span class="op" id="4132300">.</span><span class="ident" id="4132301">clientProtocolFallback</span>&nbsp;<span class="op" id="4132324">=</span>&nbsp;<span class="builtintype" id="4132326">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4132333">}</span><br>
<span class="lineno">525</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4132337">if</span>&nbsp;<span class="ident" id="4132340">hs</span><span class="op" id="4132342">.</span><span class="ident" id="4132343">serverResumedSession</span><span class="op" id="4132363">(</span><span class="op" id="4132364">)</span>&nbsp;<span class="op" id="4132366">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4132370">//&nbsp;Restore&nbsp;masterSecret&nbsp;and&nbsp;peerCerts&nbsp;from&nbsp;previous&nbsp;state</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4132430">hs</span><span class="op" id="4132432">.</span><span class="ident" id="4132433">masterSecret</span>&nbsp;<span class="op" id="4132446">=</span>&nbsp;<span class="ident" id="4132448">hs</span><span class="op" id="4132450">.</span><span class="ident" id="4132451">session</span><span class="op" id="4132458">.</span><span class="ident" id="4132459">masterSecret</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4132474">c</span><span class="op" id="4132475">.</span><span class="ident" id="4132476">peerCertificates</span>&nbsp;<span class="op" id="4132493">=</span>&nbsp;<span class="ident" id="4132495">hs</span><span class="op" id="4132497">.</span><span class="ident" id="4132498">session</span><span class="op" id="4132505">.</span><span class="ident" id="4132506">serverCertificates</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4132527">return</span>&nbsp;<span class="builtintype" id="4132534">true</span><span class="op" id="4132538">,</span>&nbsp;<span class="ident" id="4132540">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4132545">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4132548">return</span>&nbsp;<span class="builtintype" id="4132555">false</span><span class="op" id="4132560">,</span>&nbsp;<span class="ident" id="4132562">nil</span><br>
<span class="lineno"></span><span class="op" id="4132566">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="keyword" id="4132569">func</span>&nbsp;<span class="op" id="4132574">(</span><span class="ident" id="4132575">hs</span>&nbsp;<span class="op" id="4132578">*</span><span class="ident" id="4132579">clientHandshakeState</span><span class="op" id="4132599">)</span>&nbsp;<span class="ident" id="4132601">readFinished</span><span class="op" id="4132613">(</span><span class="ident" id="4132614">out</span>&nbsp;<span class="op" id="4132618">[</span><span class="op" id="4132619">]</span><span class="builtintype" id="4132620">byte</span><span class="op" id="4132624">)</span>&nbsp;<span class="builtintype" id="4132626">error</span>&nbsp;<span class="op" id="4132632">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4132635">c</span>&nbsp;<span class="op" id="4132637">:=</span>&nbsp;<span class="ident" id="4132640">hs</span><span class="op" id="4132642">.</span><span class="ident" id="4132643">c</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4132647">c</span><span class="op" id="4132648">.</span><span class="ident" id="4132649">readRecord</span><span class="op" id="4132659">(</span><span class="ident" id="4132660">recordTypeChangeCipherSpec</span><span class="op" id="4132686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4132689">if</span>&nbsp;<span class="ident" id="4132692">err</span>&nbsp;<span class="op" id="4132696">:=</span>&nbsp;<span class="ident" id="4132699">c</span><span class="op" id="4132700">.</span><span class="ident" id="4132701">in</span><span class="op" id="4132703">.</span><span class="builtintype" id="4132704">error</span><span class="op" id="4132709">(</span><span class="op" id="4132710">)</span><span class="op" id="4132711">;</span>&nbsp;<span class="ident" id="4132713">err</span>&nbsp;<span class="op" id="4132717">!=</span>&nbsp;<span class="ident" id="4132720">nil</span>&nbsp;<span class="op" id="4132724">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4132728">return</span>&nbsp;<span class="ident" id="4132735">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4132740">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4132744">msg</span><span class="op" id="4132747">,</span>&nbsp;<span class="ident" id="4132749">err</span>&nbsp;<span class="op" id="4132753">:=</span>&nbsp;<span class="ident" id="4132756">c</span><span class="op" id="4132757">.</span><span class="ident" id="4132758">readHandshake</span><span class="op" id="4132771">(</span><span class="op" id="4132772">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4132775">if</span>&nbsp;<span class="ident" id="4132778">err</span>&nbsp;<span class="op" id="4132782">!=</span>&nbsp;<span class="ident" id="4132785">nil</span>&nbsp;<span class="op" id="4132789">{</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4132793">return</span>&nbsp;<span class="ident" id="4132800">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4132805">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4132808">serverFinished</span><span class="op" id="4132822">,</span>&nbsp;<span class="ident" id="4132824">ok</span>&nbsp;<span class="op" id="4132827">:=</span>&nbsp;<span class="ident" id="4132830">msg</span><span class="op" id="4132833">.</span><span class="op" id="4132834">(</span><span class="op" id="4132835">*</span><span class="ident" id="4132836">finishedMsg</span><span class="op" id="4132847">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4132850">if</span>&nbsp;<span class="op" id="4132853">!</span><span class="ident" id="4132854">ok</span>&nbsp;<span class="op" id="4132857">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4132861">c</span><span class="op" id="4132862">.</span><span class="ident" id="4132863">sendAlert</span><span class="op" id="4132872">(</span><span class="ident" id="4132873">alertUnexpectedMessage</span><span class="op" id="4132895">)</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4132899">return</span>&nbsp;<span class="ident" id="4132906">unexpectedMessageError</span><span class="op" id="4132928">(</span><span class="ident" id="4132929">serverFinished</span><span class="op" id="4132943">,</span>&nbsp;<span class="ident" id="4132945">msg</span><span class="op" id="4132948">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4132951">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4132955">verify</span>&nbsp;<span class="op" id="4132962">:=</span>&nbsp;<span class="ident" id="4132965">hs</span><span class="op" id="4132967">.</span><span class="ident" id="4132968">finishedHash</span><span class="op" id="4132980">.</span><span class="ident" id="4132981">serverSum</span><span class="op" id="4132990">(</span><span class="ident" id="4132991">hs</span><span class="op" id="4132993">.</span><span class="ident" id="4132994">masterSecret</span><span class="op" id="4133006">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4133009">if</span>&nbsp;<span class="builtinfunc" id="4133012">len</span><span class="op" id="4133015">(</span><span class="ident" id="4133016">verify</span><span class="op" id="4133022">)</span>&nbsp;<span class="op" id="4133024">!=</span>&nbsp;<span class="builtinfunc" id="4133027">len</span><span class="op" id="4133030">(</span><span class="ident" id="4133031">serverFinished</span><span class="op" id="4133045">.</span><span class="ident" id="4133046">verifyData</span><span class="op" id="4133056">)</span>&nbsp;<span class="op" id="4133058">||</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4133063">subtle</span><span class="op" id="4133069">.</span><span class="ident" id="4133070">ConstantTimeCompare</span><span class="op" id="4133089">(</span><span class="ident" id="4133090">verify</span><span class="op" id="4133096">,</span>&nbsp;<span class="ident" id="4133098">serverFinished</span><span class="op" id="4133112">.</span><span class="ident" id="4133113">verifyData</span><span class="op" id="4133123">)</span>&nbsp;<span class="op" id="4133125">!=</span>&nbsp;<span class="num" id="4133128">1</span>&nbsp;<span class="op" id="4133130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4133134">c</span><span class="op" id="4133135">.</span><span class="ident" id="4133136">sendAlert</span><span class="op" id="4133145">(</span><span class="ident" id="4133146">alertHandshakeFailure</span><span class="op" id="4133167">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4133171">return</span>&nbsp;<span class="ident" id="4133178">errors</span><span class="op" id="4133184">.</span><span class="ident" id="4133185">New</span><span class="op" id="4133188">(</span><span class="string" id="4133189">&#34;tls:&nbsp;server&#39;s&nbsp;Finished&nbsp;message&nbsp;was&nbsp;incorrect&#34;</span><span class="op" id="4133235">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4133238">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4133241">hs</span><span class="op" id="4133243">.</span><span class="ident" id="4133244">finishedHash</span><span class="op" id="4133256">.</span><span class="ident" id="4133257">Write</span><span class="op" id="4133262">(</span><span class="ident" id="4133263">serverFinished</span><span class="op" id="4133277">.</span><span class="ident" id="4133278">marshal</span><span class="op" id="4133285">(</span><span class="op" id="4133286">)</span><span class="op" id="4133287">)</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4133290">copy</span><span class="op" id="4133294">(</span><span class="ident" id="4133295">out</span><span class="op" id="4133298">,</span>&nbsp;<span class="ident" id="4133300">verify</span><span class="op" id="4133306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4133309">return</span>&nbsp;<span class="ident" id="4133316">nil</span><br>
<span class="lineno"></span><span class="op" id="4133320">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4133323">func</span>&nbsp;<span class="op" id="4133328">(</span><span class="ident" id="4133329">hs</span>&nbsp;<span class="op" id="4133332">*</span><span class="ident" id="4133333">clientHandshakeState</span><span class="op" id="4133353">)</span>&nbsp;<span class="ident" id="4133355">readSessionTicket</span><span class="op" id="4133372">(</span><span class="op" id="4133373">)</span>&nbsp;<span class="builtintype" id="4133375">error</span>&nbsp;<span class="op" id="4133381">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4133384">if</span>&nbsp;<span class="op" id="4133387">!</span><span class="ident" id="4133388">hs</span><span class="op" id="4133390">.</span><span class="ident" id="4133391">serverHello</span><span class="op" id="4133402">.</span><span class="ident" id="4133403">ticketSupported</span>&nbsp;<span class="op" id="4133419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4133423">return</span>&nbsp;<span class="ident" id="4133430">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4133435">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4133439">c</span>&nbsp;<span class="op" id="4133441">:=</span>&nbsp;<span class="ident" id="4133444">hs</span><span class="op" id="4133446">.</span><span class="ident" id="4133447">c</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4133450">msg</span><span class="op" id="4133453">,</span>&nbsp;<span class="ident" id="4133455">err</span>&nbsp;<span class="op" id="4133459">:=</span>&nbsp;<span class="ident" id="4133462">c</span><span class="op" id="4133463">.</span><span class="ident" id="4133464">readHandshake</span><span class="op" id="4133477">(</span><span class="op" id="4133478">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4133481">if</span>&nbsp;<span class="ident" id="4133484">err</span>&nbsp;<span class="op" id="4133488">!=</span>&nbsp;<span class="ident" id="4133491">nil</span>&nbsp;<span class="op" id="4133495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4133499">return</span>&nbsp;<span class="ident" id="4133506">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4133511">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4133514">sessionTicketMsg</span><span class="op" id="4133530">,</span>&nbsp;<span class="ident" id="4133532">ok</span>&nbsp;<span class="op" id="4133535">:=</span>&nbsp;<span class="ident" id="4133538">msg</span><span class="op" id="4133541">.</span><span class="op" id="4133542">(</span><span class="op" id="4133543">*</span><span class="ident" id="4133544">newSessionTicketMsg</span><span class="op" id="4133563">)</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4133566">if</span>&nbsp;<span class="op" id="4133569">!</span><span class="ident" id="4133570">ok</span>&nbsp;<span class="op" id="4133573">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4133577">c</span><span class="op" id="4133578">.</span><span class="ident" id="4133579">sendAlert</span><span class="op" id="4133588">(</span><span class="ident" id="4133589">alertUnexpectedMessage</span><span class="op" id="4133611">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4133615">return</span>&nbsp;<span class="ident" id="4133622">unexpectedMessageError</span><span class="op" id="4133644">(</span><span class="ident" id="4133645">sessionTicketMsg</span><span class="op" id="4133661">,</span>&nbsp;<span class="ident" id="4133663">msg</span><span class="op" id="4133666">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4133669">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4133672">hs</span><span class="op" id="4133674">.</span><span class="ident" id="4133675">finishedHash</span><span class="op" id="4133687">.</span><span class="ident" id="4133688">Write</span><span class="op" id="4133693">(</span><span class="ident" id="4133694">sessionTicketMsg</span><span class="op" id="4133710">.</span><span class="ident" id="4133711">marshal</span><span class="op" id="4133718">(</span><span class="op" id="4133719">)</span><span class="op" id="4133720">)</span><br>
<span class="lineno">580</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4133724">hs</span><span class="op" id="4133726">.</span><span class="ident" id="4133727">session</span>&nbsp;<span class="op" id="4133735">=</span>&nbsp;<span class="op" id="4133737">&amp;</span><span class="ident" id="4133738">ClientSessionState</span><span class="op" id="4133756">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4133760">sessionTicket</span><span class="op" id="4133773">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4133780">sessionTicketMsg</span><span class="op" id="4133796">.</span><span class="ident" id="4133797">ticket</span><span class="op" id="4133803">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4133807">vers</span><span class="op" id="4133811">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4133827">c</span><span class="op" id="4133828">.</span><span class="ident" id="4133829">vers</span><span class="op" id="4133833">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4133837">cipherSuite</span><span class="op" id="4133848">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4133857">hs</span><span class="op" id="4133859">.</span><span class="ident" id="4133860">suite</span><span class="op" id="4133865">.</span><span class="ident" id="4133866">id</span><span class="op" id="4133868">,</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4133872">masterSecret</span><span class="op" id="4133884">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="4133892">hs</span><span class="op" id="4133894">.</span><span class="ident" id="4133895">masterSecret</span><span class="op" id="4133907">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4133911">serverCertificates</span><span class="op" id="4133929">:</span>&nbsp;<span class="ident" id="4133931">c</span><span class="op" id="4133932">.</span><span class="ident" id="4133933">peerCertificates</span><span class="op" id="4133949">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4133952">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4133956">return</span>&nbsp;<span class="ident" id="4133963">nil</span><br>
<span class="lineno">590</span><span class="op" id="4133967">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4133970">func</span>&nbsp;<span class="op" id="4133975">(</span><span class="ident" id="4133976">hs</span>&nbsp;<span class="op" id="4133979">*</span><span class="ident" id="4133980">clientHandshakeState</span><span class="op" id="4134000">)</span>&nbsp;<span class="ident" id="4134002">sendFinished</span><span class="op" id="4134014">(</span><span class="ident" id="4134015">out</span>&nbsp;<span class="op" id="4134019">[</span><span class="op" id="4134020">]</span><span class="builtintype" id="4134021">byte</span><span class="op" id="4134025">)</span>&nbsp;<span class="builtintype" id="4134027">error</span>&nbsp;<span class="op" id="4134033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4134036">c</span>&nbsp;<span class="op" id="4134038">:=</span>&nbsp;<span class="ident" id="4134041">hs</span><span class="op" id="4134043">.</span><span class="ident" id="4134044">c</span><br>
<span class="lineno"></span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4134048">c</span><span class="op" id="4134049">.</span><span class="ident" id="4134050">writeRecord</span><span class="op" id="4134061">(</span><span class="ident" id="4134062">recordTypeChangeCipherSpec</span><span class="op" id="4134088">,</span>&nbsp;<span class="op" id="4134090">[</span><span class="op" id="4134091">]</span><span class="builtintype" id="4134092">byte</span><span class="op" id="4134096">{</span><span class="num" id="4134097">1</span><span class="op" id="4134098">}</span><span class="op" id="4134099">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4134102">if</span>&nbsp;<span class="ident" id="4134105">hs</span><span class="op" id="4134107">.</span><span class="ident" id="4134108">serverHello</span><span class="op" id="4134119">.</span><span class="ident" id="4134120">nextProtoNeg</span>&nbsp;<span class="op" id="4134133">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4134137">nextProto</span>&nbsp;<span class="op" id="4134147">:=</span>&nbsp;<span class="builtinfunc" id="4134150">new</span><span class="op" id="4134153">(</span><span class="ident" id="4134154">nextProtoMsg</span><span class="op" id="4134166">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4134170">proto</span><span class="op" id="4134175">,</span>&nbsp;<span class="ident" id="4134177">fallback</span>&nbsp;<span class="op" id="4134186">:=</span>&nbsp;<span class="ident" id="4134189">mutualProtocol</span><span class="op" id="4134203">(</span><span class="ident" id="4134204">c</span><span class="op" id="4134205">.</span><span class="ident" id="4134206">config</span><span class="op" id="4134212">.</span><span class="ident" id="4134213">NextProtos</span><span class="op" id="4134223">,</span>&nbsp;<span class="ident" id="4134225">hs</span><span class="op" id="4134227">.</span><span class="ident" id="4134228">serverHello</span><span class="op" id="4134239">.</span><span class="ident" id="4134240">nextProtos</span><span class="op" id="4134250">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4134254">nextProto</span><span class="op" id="4134263">.</span><span class="ident" id="4134264">proto</span>&nbsp;<span class="op" id="4134270">=</span>&nbsp;<span class="ident" id="4134272">proto</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4134280">c</span><span class="op" id="4134281">.</span><span class="ident" id="4134282">clientProtocol</span>&nbsp;<span class="op" id="4134297">=</span>&nbsp;<span class="ident" id="4134299">proto</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4134307">c</span><span class="op" id="4134308">.</span><span class="ident" id="4134309">clientProtocolFallback</span>&nbsp;<span class="op" id="4134332">=</span>&nbsp;<span class="ident" id="4134334">fallback</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4134346">hs</span><span class="op" id="4134348">.</span><span class="ident" id="4134349">finishedHash</span><span class="op" id="4134361">.</span><span class="ident" id="4134362">Write</span><span class="op" id="4134367">(</span><span class="ident" id="4134368">nextProto</span><span class="op" id="4134377">.</span><span class="ident" id="4134378">marshal</span><span class="op" id="4134385">(</span><span class="op" id="4134386">)</span><span class="op" id="4134387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4134391">c</span><span class="op" id="4134392">.</span><span class="ident" id="4134393">writeRecord</span><span class="op" id="4134404">(</span><span class="ident" id="4134405">recordTypeHandshake</span><span class="op" id="4134424">,</span>&nbsp;<span class="ident" id="4134426">nextProto</span><span class="op" id="4134435">.</span><span class="ident" id="4134436">marshal</span><span class="op" id="4134443">(</span><span class="op" id="4134444">)</span><span class="op" id="4134445">)</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4134448">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4134452">finished</span>&nbsp;<span class="op" id="4134461">:=</span>&nbsp;<span class="builtinfunc" id="4134464">new</span><span class="op" id="4134467">(</span><span class="ident" id="4134468">finishedMsg</span><span class="op" id="4134479">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4134482">finished</span><span class="op" id="4134490">.</span><span class="ident" id="4134491">verifyData</span>&nbsp;<span class="op" id="4134502">=</span>&nbsp;<span class="ident" id="4134504">hs</span><span class="op" id="4134506">.</span><span class="ident" id="4134507">finishedHash</span><span class="op" id="4134519">.</span><span class="ident" id="4134520">clientSum</span><span class="op" id="4134529">(</span><span class="ident" id="4134530">hs</span><span class="op" id="4134532">.</span><span class="ident" id="4134533">masterSecret</span><span class="op" id="4134545">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4134548">hs</span><span class="op" id="4134550">.</span><span class="ident" id="4134551">finishedHash</span><span class="op" id="4134563">.</span><span class="ident" id="4134564">Write</span><span class="op" id="4134569">(</span><span class="ident" id="4134570">finished</span><span class="op" id="4134578">.</span><span class="ident" id="4134579">marshal</span><span class="op" id="4134586">(</span><span class="op" id="4134587">)</span><span class="op" id="4134588">)</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4134591">c</span><span class="op" id="4134592">.</span><span class="ident" id="4134593">writeRecord</span><span class="op" id="4134604">(</span><span class="ident" id="4134605">recordTypeHandshake</span><span class="op" id="4134624">,</span>&nbsp;<span class="ident" id="4134626">finished</span><span class="op" id="4134634">.</span><span class="ident" id="4134635">marshal</span><span class="op" id="4134642">(</span><span class="op" id="4134643">)</span><span class="op" id="4134644">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4134647">copy</span><span class="op" id="4134651">(</span><span class="ident" id="4134652">out</span><span class="op" id="4134655">,</span>&nbsp;<span class="ident" id="4134657">finished</span><span class="op" id="4134665">.</span><span class="ident" id="4134666">verifyData</span><span class="op" id="4134676">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4134679">return</span>&nbsp;<span class="ident" id="4134686">nil</span><br>
<span class="lineno"></span><span class="op" id="4134690">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">615</span><span class="comment" id="4134693">//&nbsp;clientSessionCacheKey&nbsp;returns&nbsp;a&nbsp;key&nbsp;used&nbsp;to&nbsp;cache&nbsp;sessionTickets&nbsp;that&nbsp;could</span><br>
<span class="lineno"></span><span class="comment" id="4134772">//&nbsp;be&nbsp;used&nbsp;to&nbsp;resume&nbsp;previously&nbsp;negotiated&nbsp;TLS&nbsp;sessions&nbsp;with&nbsp;a&nbsp;server.</span><br>
<span class="lineno"></span><span class="keyword" id="4134843">func</span>&nbsp;<span class="ident" id="4134848">clientSessionCacheKey</span><span class="op" id="4134869">(</span><span class="ident" id="4134870">serverAddr</span>&nbsp;<span class="ident" id="4134881">net</span><span class="op" id="4134884">.</span><span class="ident" id="4134885">Addr</span><span class="op" id="4134889">,</span>&nbsp;<span class="ident" id="4134891">config</span>&nbsp;<span class="op" id="4134898">*</span><span class="ident" id="4134899">Config</span><span class="op" id="4134905">)</span>&nbsp;<span class="builtintype" id="4134907">string</span>&nbsp;<span class="op" id="4134914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4134917">if</span>&nbsp;<span class="builtinfunc" id="4134920">len</span><span class="op" id="4134923">(</span><span class="ident" id="4134924">config</span><span class="op" id="4134930">.</span><span class="ident" id="4134931">ServerName</span><span class="op" id="4134941">)</span>&nbsp;<span class="op" id="4134943">&gt;</span>&nbsp;<span class="num" id="4134945">0</span>&nbsp;<span class="op" id="4134947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4134951">return</span>&nbsp;<span class="ident" id="4134958">config</span><span class="op" id="4134964">.</span><span class="ident" id="4134965">ServerName</span><br>
<span class="lineno">620</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4134977">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4134980">return</span>&nbsp;<span class="ident" id="4134987">serverAddr</span><span class="op" id="4134997">.</span><span class="ident" id="4134998">String</span><span class="op" id="4135004">(</span><span class="op" id="4135005">)</span><br>
<span class="lineno"></span><span class="op" id="4135007">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4135010">//&nbsp;mutualProtocol&nbsp;finds&nbsp;the&nbsp;mutual&nbsp;Next&nbsp;Protocol&nbsp;Negotiation&nbsp;or&nbsp;ALPN&nbsp;protocol</span><br>
<span class="lineno">625</span><span class="comment" id="4135088">//&nbsp;given&nbsp;list&nbsp;of&nbsp;possible&nbsp;protocols&nbsp;and&nbsp;a&nbsp;list&nbsp;of&nbsp;the&nbsp;preference&nbsp;order.&nbsp;The</span><br>
<span class="lineno"></span><span class="comment" id="4135164">//&nbsp;first&nbsp;list&nbsp;must&nbsp;not&nbsp;be&nbsp;empty.&nbsp;It&nbsp;returns&nbsp;the&nbsp;resulting&nbsp;protocol&nbsp;and&nbsp;flag</span><br>
<span class="lineno"></span><span class="comment" id="4135240">//&nbsp;indicating&nbsp;if&nbsp;the&nbsp;fallback&nbsp;case&nbsp;was&nbsp;reached.</span><br>
<span class="lineno"></span><span class="keyword" id="4135288">func</span>&nbsp;<span class="ident" id="4135293">mutualProtocol</span><span class="op" id="4135307">(</span><span class="ident" id="4135308">protos</span><span class="op" id="4135314">,</span>&nbsp;<span class="ident" id="4135316">preferenceProtos</span>&nbsp;<span class="op" id="4135333">[</span><span class="op" id="4135334">]</span><span class="builtintype" id="4135335">string</span><span class="op" id="4135341">)</span>&nbsp;<span class="op" id="4135343">(</span><span class="builtintype" id="4135344">string</span><span class="op" id="4135350">,</span>&nbsp;<span class="builtintype" id="4135352">bool</span><span class="op" id="4135356">)</span>&nbsp;<span class="op" id="4135358">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4135361">for</span>&nbsp;<span class="ident" id="4135365">_</span><span class="op" id="4135366">,</span>&nbsp;<span class="ident" id="4135368">s</span>&nbsp;<span class="op" id="4135370">:=</span>&nbsp;<span class="keyword" id="4135373">range</span>&nbsp;<span class="ident" id="4135379">preferenceProtos</span>&nbsp;<span class="op" id="4135396">{</span><br>
<span class="lineno">630</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4135400">for</span>&nbsp;<span class="ident" id="4135404">_</span><span class="op" id="4135405">,</span>&nbsp;<span class="ident" id="4135407">c</span>&nbsp;<span class="op" id="4135409">:=</span>&nbsp;<span class="keyword" id="4135412">range</span>&nbsp;<span class="ident" id="4135418">protos</span>&nbsp;<span class="op" id="4135425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4135430">if</span>&nbsp;<span class="ident" id="4135433">s</span>&nbsp;<span class="op" id="4135435">==</span>&nbsp;<span class="ident" id="4135438">c</span>&nbsp;<span class="op" id="4135440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4135446">return</span>&nbsp;<span class="ident" id="4135453">s</span><span class="op" id="4135454">,</span>&nbsp;<span class="builtintype" id="4135456">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4135465">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4135469">}</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4135472">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4135476">return</span>&nbsp;<span class="ident" id="4135483">protos</span><span class="op" id="4135489">[</span><span class="num" id="4135490">0</span><span class="op" id="4135491">]</span><span class="op" id="4135492">,</span>&nbsp;<span class="builtintype" id="4135494">true</span><br>
<span class="lineno"></span><span class="op" id="4135499">}</span>
</div>
</body>
</html>
