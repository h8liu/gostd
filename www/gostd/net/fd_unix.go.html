<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html" class="current">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3244381">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3244436">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3244490">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3244541">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;nacl&nbsp;netbsd&nbsp;openbsd&nbsp;solaris</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3244611">package</span>&nbsp;<span class="ident" id="3244619">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3244624">import</span>&nbsp;<span class="op" id="3244631">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3244634">&#34;io&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3244640">&#34;os&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3244646">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3244657">&#34;sync/atomic&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3244672">&#34;syscall&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="string" id="3244683">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="3244690">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3244693">//&nbsp;Network&nbsp;file&nbsp;descriptor.</span><br>
<span class="lineno"></span><span class="keyword" id="3244721">type</span>&nbsp;<span class="ident" id="3244726">netFD</span>&nbsp;<span class="keyword" id="3244732">struct</span>&nbsp;<span class="op" id="3244739">{</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3244742">//&nbsp;locking/lifetime&nbsp;of&nbsp;sysfd&nbsp;+&nbsp;serialize&nbsp;access&nbsp;to&nbsp;Read&nbsp;and&nbsp;Write&nbsp;methods</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3244817">fdmu</span>&nbsp;<span class="ident" id="3244822">fdMutex</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3244832">//&nbsp;immutable&nbsp;until&nbsp;Close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3244858">sysfd</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3244870">int</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3244875">family</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3244887">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3244892">sotype</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3244904">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3244909">isConnected</span>&nbsp;<span class="builtintype" id="3244921">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3244927">net</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3244939">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3244947">laddr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3244959">Addr</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3244965">raddr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3244977">Addr</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3244984">//&nbsp;wait&nbsp;server</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3245000">pd</span>&nbsp;<span class="ident" id="3245003">pollDesc</span><br>
<span class="lineno"></span><span class="op" id="3245012">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="3245015">func</span>&nbsp;<span class="ident" id="3245020">sysInit</span><span class="op" id="3245027">(</span><span class="op" id="3245028">)</span>&nbsp;<span class="op" id="3245030">{</span><br>
<span class="lineno"></span><span class="op" id="3245032">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3245035">func</span>&nbsp;<span class="ident" id="3245040">dial</span><span class="op" id="3245044">(</span><span class="ident" id="3245045">network</span>&nbsp;<span class="builtintype" id="3245053">string</span><span class="op" id="3245059">,</span>&nbsp;<span class="ident" id="3245061">ra</span>&nbsp;<span class="ident" id="3245064">Addr</span><span class="op" id="3245068">,</span>&nbsp;<span class="ident" id="3245070">dialer</span>&nbsp;<span class="keyword" id="3245077">func</span><span class="op" id="3245081">(</span><span class="ident" id="3245082">time</span><span class="op" id="3245086">.</span><span class="ident" id="3245087">Time</span><span class="op" id="3245091">)</span>&nbsp;<span class="op" id="3245093">(</span><span class="ident" id="3245094">Conn</span><span class="op" id="3245098">,</span>&nbsp;<span class="builtintype" id="3245100">error</span><span class="op" id="3245105">)</span><span class="op" id="3245106">,</span>&nbsp;<span class="ident" id="3245108">deadline</span>&nbsp;<span class="ident" id="3245117">time</span><span class="op" id="3245121">.</span><span class="ident" id="3245122">Time</span><span class="op" id="3245126">)</span>&nbsp;<span class="op" id="3245128">(</span><span class="ident" id="3245129">Conn</span><span class="op" id="3245133">,</span>&nbsp;<span class="builtintype" id="3245135">error</span><span class="op" id="3245140">)</span>&nbsp;<span class="op" id="3245142">{</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3245145">return</span>&nbsp;<span class="ident" id="3245152">dialer</span><span class="op" id="3245158">(</span><span class="ident" id="3245159">deadline</span><span class="op" id="3245167">)</span><br>
<span class="lineno"></span><span class="op" id="3245169">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3245172">func</span>&nbsp;<span class="ident" id="3245177">newFD</span><span class="op" id="3245182">(</span><span class="ident" id="3245183">sysfd</span><span class="op" id="3245188">,</span>&nbsp;<span class="ident" id="3245190">family</span><span class="op" id="3245196">,</span>&nbsp;<span class="ident" id="3245198">sotype</span>&nbsp;<span class="builtintype" id="3245205">int</span><span class="op" id="3245208">,</span>&nbsp;<span class="ident" id="3245210">net</span>&nbsp;<span class="builtintype" id="3245214">string</span><span class="op" id="3245220">)</span>&nbsp;<span class="op" id="3245222">(</span><span class="op" id="3245223">*</span><span class="ident" id="3245224">netFD</span><span class="op" id="3245229">,</span>&nbsp;<span class="builtintype" id="3245231">error</span><span class="op" id="3245236">)</span>&nbsp;<span class="op" id="3245238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3245241">return</span>&nbsp;<span class="op" id="3245248">&amp;</span><span class="ident" id="3245249">netFD</span><span class="op" id="3245254">{</span><span class="ident" id="3245255">sysfd</span><span class="op" id="3245260">:</span>&nbsp;<span class="ident" id="3245262">sysfd</span><span class="op" id="3245267">,</span>&nbsp;<span class="ident" id="3245269">family</span><span class="op" id="3245275">:</span>&nbsp;<span class="ident" id="3245277">family</span><span class="op" id="3245283">,</span>&nbsp;<span class="ident" id="3245285">sotype</span><span class="op" id="3245291">:</span>&nbsp;<span class="ident" id="3245293">sotype</span><span class="op" id="3245299">,</span>&nbsp;<span class="ident" id="3245301">net</span><span class="op" id="3245304">:</span>&nbsp;<span class="ident" id="3245306">net</span><span class="op" id="3245309">}</span><span class="op" id="3245310">,</span>&nbsp;<span class="builtintype" id="3245312">nil</span><br>
<span class="lineno">45</span><span class="op" id="3245316">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3245319">func</span>&nbsp;<span class="op" id="3245324">(</span><span class="ident" id="3245325">fd</span>&nbsp;<span class="op" id="3245328">*</span><span class="ident" id="3245329">netFD</span><span class="op" id="3245334">)</span>&nbsp;<span class="ident" id="3245336">init</span><span class="op" id="3245340">(</span><span class="op" id="3245341">)</span>&nbsp;<span class="builtintype" id="3245343">error</span>&nbsp;<span class="op" id="3245349">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3245352">if</span>&nbsp;<span class="ident" id="3245355">err</span>&nbsp;<span class="op" id="3245359">:=</span>&nbsp;<span class="ident" id="3245362">fd</span><span class="op" id="3245364">.</span><span class="ident" id="3245365">pd</span><span class="op" id="3245367">.</span><span class="ident" id="3245368">Init</span><span class="op" id="3245372">(</span><span class="ident" id="3245373">fd</span><span class="op" id="3245375">)</span><span class="op" id="3245376">;</span>&nbsp;<span class="ident" id="3245378">err</span>&nbsp;<span class="op" id="3245382">!=</span>&nbsp;<span class="builtintype" id="3245385">nil</span>&nbsp;<span class="op" id="3245389">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3245393">return</span>&nbsp;<span class="ident" id="3245400">err</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3245405">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3245408">return</span>&nbsp;<span class="builtintype" id="3245415">nil</span><br>
<span class="lineno"></span><span class="op" id="3245419">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3245422">func</span>&nbsp;<span class="op" id="3245427">(</span><span class="ident" id="3245428">fd</span>&nbsp;<span class="op" id="3245431">*</span><span class="ident" id="3245432">netFD</span><span class="op" id="3245437">)</span>&nbsp;<span class="ident" id="3245439">setAddr</span><span class="op" id="3245446">(</span><span class="ident" id="3245447">laddr</span><span class="op" id="3245452">,</span>&nbsp;<span class="ident" id="3245454">raddr</span>&nbsp;<span class="ident" id="3245460">Addr</span><span class="op" id="3245464">)</span>&nbsp;<span class="op" id="3245466">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3245469">fd</span><span class="op" id="3245471">.</span><span class="ident" id="3245472">laddr</span>&nbsp;<span class="op" id="3245478">=</span>&nbsp;<span class="ident" id="3245480">laddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3245487">fd</span><span class="op" id="3245489">.</span><span class="ident" id="3245490">raddr</span>&nbsp;<span class="op" id="3245496">=</span>&nbsp;<span class="ident" id="3245498">raddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3245505">runtime</span><span class="op" id="3245512">.</span><span class="ident" id="3245513">SetFinalizer</span><span class="op" id="3245525">(</span><span class="ident" id="3245526">fd</span><span class="op" id="3245528">,</span>&nbsp;<span class="op" id="3245530">(</span><span class="op" id="3245531">*</span><span class="ident" id="3245532">netFD</span><span class="op" id="3245537">)</span><span class="op" id="3245538">.</span><span class="ident" id="3245539">Close</span><span class="op" id="3245544">)</span><br>
<span class="lineno"></span><span class="op" id="3245546">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="keyword" id="3245549">func</span>&nbsp;<span class="op" id="3245554">(</span><span class="ident" id="3245555">fd</span>&nbsp;<span class="op" id="3245558">*</span><span class="ident" id="3245559">netFD</span><span class="op" id="3245564">)</span>&nbsp;<span class="ident" id="3245566">name</span><span class="op" id="3245570">(</span><span class="op" id="3245571">)</span>&nbsp;<span class="builtintype" id="3245573">string</span>&nbsp;<span class="op" id="3245580">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3245583">var</span>&nbsp;<span class="ident" id="3245587">ls</span><span class="op" id="3245589">,</span>&nbsp;<span class="ident" id="3245591">rs</span>&nbsp;<span class="builtintype" id="3245594">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3245602">if</span>&nbsp;<span class="ident" id="3245605">fd</span><span class="op" id="3245607">.</span><span class="ident" id="3245608">laddr</span>&nbsp;<span class="op" id="3245614">!=</span>&nbsp;<span class="builtintype" id="3245617">nil</span>&nbsp;<span class="op" id="3245621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3245625">ls</span>&nbsp;<span class="op" id="3245628">=</span>&nbsp;<span class="ident" id="3245630">fd</span><span class="op" id="3245632">.</span><span class="ident" id="3245633">laddr</span><span class="op" id="3245638">.</span><span class="ident" id="3245639">String</span><span class="op" id="3245645">(</span><span class="op" id="3245646">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3245649">}</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3245652">if</span>&nbsp;<span class="ident" id="3245655">fd</span><span class="op" id="3245657">.</span><span class="ident" id="3245658">raddr</span>&nbsp;<span class="op" id="3245664">!=</span>&nbsp;<span class="builtintype" id="3245667">nil</span>&nbsp;<span class="op" id="3245671">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3245675">rs</span>&nbsp;<span class="op" id="3245678">=</span>&nbsp;<span class="ident" id="3245680">fd</span><span class="op" id="3245682">.</span><span class="ident" id="3245683">raddr</span><span class="op" id="3245688">.</span><span class="ident" id="3245689">String</span><span class="op" id="3245695">(</span><span class="op" id="3245696">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3245699">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3245702">return</span>&nbsp;<span class="ident" id="3245709">fd</span><span class="op" id="3245711">.</span><span class="ident" id="3245712">net</span>&nbsp;<span class="op" id="3245716">+</span>&nbsp;<span class="string" id="3245718">&#34;:&#34;</span>&nbsp;<span class="op" id="3245722">+</span>&nbsp;<span class="ident" id="3245724">ls</span>&nbsp;<span class="op" id="3245727">+</span>&nbsp;<span class="string" id="3245729">&#34;-&gt;&#34;</span>&nbsp;<span class="op" id="3245734">+</span>&nbsp;<span class="ident" id="3245736">rs</span><br>
<span class="lineno"></span><span class="op" id="3245739">}</span><br>
<span class="lineno">70</span><br>
<span class="lineno"></span><span class="keyword" id="3245742">func</span>&nbsp;<span class="op" id="3245747">(</span><span class="ident" id="3245748">fd</span>&nbsp;<span class="op" id="3245751">*</span><span class="ident" id="3245752">netFD</span><span class="op" id="3245757">)</span>&nbsp;<span class="ident" id="3245759">connect</span><span class="op" id="3245766">(</span><span class="ident" id="3245767">la</span><span class="op" id="3245769">,</span>&nbsp;<span class="ident" id="3245771">ra</span>&nbsp;<span class="ident" id="3245774">syscall</span><span class="op" id="3245781">.</span><span class="ident" id="3245782">Sockaddr</span><span class="op" id="3245790">,</span>&nbsp;<span class="ident" id="3245792">deadline</span>&nbsp;<span class="ident" id="3245801">time</span><span class="op" id="3245805">.</span><span class="ident" id="3245806">Time</span><span class="op" id="3245810">)</span>&nbsp;<span class="builtintype" id="3245812">error</span>&nbsp;<span class="op" id="3245818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3245821">//&nbsp;Do&nbsp;not&nbsp;need&nbsp;to&nbsp;call&nbsp;fd.writeLock&nbsp;here,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3245864">//&nbsp;because&nbsp;fd&nbsp;is&nbsp;not&nbsp;yet&nbsp;accessible&nbsp;to&nbsp;user,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3245910">//&nbsp;so&nbsp;no&nbsp;concurrent&nbsp;operations&nbsp;are&nbsp;possible.</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3245956">switch</span>&nbsp;<span class="ident" id="3245963">err</span>&nbsp;<span class="op" id="3245967">:=</span>&nbsp;<span class="ident" id="3245970">syscall</span><span class="op" id="3245977">.</span><span class="ident" id="3245978">Connect</span><span class="op" id="3245985">(</span><span class="ident" id="3245986">fd</span><span class="op" id="3245988">.</span><span class="ident" id="3245989">sysfd</span><span class="op" id="3245994">,</span>&nbsp;<span class="ident" id="3245996">ra</span><span class="op" id="3245998">)</span><span class="op" id="3245999">;</span>&nbsp;<span class="ident" id="3246001">err</span>&nbsp;<span class="op" id="3246005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3246008">case</span>&nbsp;<span class="ident" id="3246013">syscall</span><span class="op" id="3246020">.</span><span class="ident" id="3246021">EINPROGRESS</span><span class="op" id="3246032">,</span>&nbsp;<span class="ident" id="3246034">syscall</span><span class="op" id="3246041">.</span><span class="ident" id="3246042">EALREADY</span><span class="op" id="3246050">,</span>&nbsp;<span class="ident" id="3246052">syscall</span><span class="op" id="3246059">.</span><span class="ident" id="3246060">EINTR</span><span class="op" id="3246065">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3246068">case</span>&nbsp;<span class="builtintype" id="3246073">nil</span><span class="op" id="3246076">,</span>&nbsp;<span class="ident" id="3246078">syscall</span><span class="op" id="3246085">.</span><span class="ident" id="3246086">EISCONN</span><span class="op" id="3246093">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3246097">if</span>&nbsp;<span class="op" id="3246100">!</span><span class="ident" id="3246101">deadline</span><span class="op" id="3246109">.</span><span class="ident" id="3246110">IsZero</span><span class="op" id="3246116">(</span><span class="op" id="3246117">)</span>&nbsp;<span class="op" id="3246119">&amp;&amp;</span>&nbsp;<span class="ident" id="3246122">deadline</span><span class="op" id="3246130">.</span><span class="ident" id="3246131">Before</span><span class="op" id="3246137">(</span><span class="ident" id="3246138">time</span><span class="op" id="3246142">.</span><span class="ident" id="3246143">Now</span><span class="op" id="3246146">(</span><span class="op" id="3246147">)</span><span class="op" id="3246148">)</span>&nbsp;<span class="op" id="3246150">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3246155">return</span>&nbsp;<span class="ident" id="3246162">errTimeout</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3246175">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3246179">if</span>&nbsp;<span class="ident" id="3246182">err</span>&nbsp;<span class="op" id="3246186">:=</span>&nbsp;<span class="ident" id="3246189">fd</span><span class="op" id="3246191">.</span><span class="ident" id="3246192">init</span><span class="op" id="3246196">(</span><span class="op" id="3246197">)</span><span class="op" id="3246198">;</span>&nbsp;<span class="ident" id="3246200">err</span>&nbsp;<span class="op" id="3246204">!=</span>&nbsp;<span class="builtintype" id="3246207">nil</span>&nbsp;<span class="op" id="3246211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3246216">return</span>&nbsp;<span class="ident" id="3246223">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3246229">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3246233">return</span>&nbsp;<span class="builtintype" id="3246240">nil</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3246245">case</span>&nbsp;<span class="ident" id="3246250">syscall</span><span class="op" id="3246257">.</span><span class="ident" id="3246258">EINVAL</span><span class="op" id="3246264">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3246268">//&nbsp;On&nbsp;Solaris&nbsp;we&nbsp;can&nbsp;see&nbsp;EINVAL&nbsp;if&nbsp;the&nbsp;socket&nbsp;has</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3246320">//&nbsp;already&nbsp;been&nbsp;accepted&nbsp;and&nbsp;closed&nbsp;by&nbsp;the&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3246373">//&nbsp;Treat&nbsp;this&nbsp;as&nbsp;a&nbsp;successful&nbsp;connection--writes&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3246427">//&nbsp;the&nbsp;socket&nbsp;will&nbsp;see&nbsp;EOF.&nbsp;&nbsp;For&nbsp;details&nbsp;and&nbsp;a&nbsp;test</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3246481">//&nbsp;case&nbsp;in&nbsp;C&nbsp;see&nbsp;http://golang.org/issue/6828.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3246530">if</span>&nbsp;<span class="ident" id="3246533">runtime</span><span class="op" id="3246540">.</span><span class="ident" id="3246541">GOOS</span>&nbsp;<span class="op" id="3246546">==</span>&nbsp;<span class="string" id="3246549">&#34;solaris&#34;</span>&nbsp;<span class="op" id="3246559">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3246564">return</span>&nbsp;<span class="builtintype" id="3246571">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3246577">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3246581">fallthrough</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3246594">default</span><span class="op" id="3246601">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3246605">return</span>&nbsp;<span class="ident" id="3246612">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3246617">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3246620">if</span>&nbsp;<span class="ident" id="3246623">err</span>&nbsp;<span class="op" id="3246627">:=</span>&nbsp;<span class="ident" id="3246630">fd</span><span class="op" id="3246632">.</span><span class="ident" id="3246633">init</span><span class="op" id="3246637">(</span><span class="op" id="3246638">)</span><span class="op" id="3246639">;</span>&nbsp;<span class="ident" id="3246641">err</span>&nbsp;<span class="op" id="3246645">!=</span>&nbsp;<span class="builtintype" id="3246648">nil</span>&nbsp;<span class="op" id="3246652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3246656">return</span>&nbsp;<span class="ident" id="3246663">err</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3246668">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3246671">if</span>&nbsp;<span class="op" id="3246674">!</span><span class="ident" id="3246675">deadline</span><span class="op" id="3246683">.</span><span class="ident" id="3246684">IsZero</span><span class="op" id="3246690">(</span><span class="op" id="3246691">)</span>&nbsp;<span class="op" id="3246693">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3246697">fd</span><span class="op" id="3246699">.</span><span class="ident" id="3246700">setWriteDeadline</span><span class="op" id="3246716">(</span><span class="ident" id="3246717">deadline</span><span class="op" id="3246725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3246729">defer</span>&nbsp;<span class="ident" id="3246735">fd</span><span class="op" id="3246737">.</span><span class="ident" id="3246738">setWriteDeadline</span><span class="op" id="3246754">(</span><span class="ident" id="3246755">noDeadline</span><span class="op" id="3246765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3246768">}</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3246771">for</span>&nbsp;<span class="op" id="3246775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3246779">//&nbsp;Performing&nbsp;multiple&nbsp;connect&nbsp;system&nbsp;calls&nbsp;on&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3246830">//&nbsp;non-blocking&nbsp;socket&nbsp;under&nbsp;Unix&nbsp;variants&nbsp;does&nbsp;not</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3246884">//&nbsp;necessarily&nbsp;result&nbsp;in&nbsp;earlier&nbsp;errors&nbsp;being</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3246932">//&nbsp;returned.&nbsp;Instead,&nbsp;once&nbsp;runtime-integrated&nbsp;network</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3246988">//&nbsp;poller&nbsp;tells&nbsp;us&nbsp;that&nbsp;the&nbsp;socket&nbsp;is&nbsp;ready,&nbsp;get&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3247043">//&nbsp;SO_ERROR&nbsp;socket&nbsp;option&nbsp;to&nbsp;see&nbsp;if&nbsp;the&nbsp;connection</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3247096">//&nbsp;succeeded&nbsp;or&nbsp;failed.&nbsp;See&nbsp;issue&nbsp;7474&nbsp;for&nbsp;further</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3247149">//&nbsp;details.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3247163">if</span>&nbsp;<span class="ident" id="3247166">err</span>&nbsp;<span class="op" id="3247170">:=</span>&nbsp;<span class="ident" id="3247173">fd</span><span class="op" id="3247175">.</span><span class="ident" id="3247176">pd</span><span class="op" id="3247178">.</span><span class="ident" id="3247179">WaitWrite</span><span class="op" id="3247188">(</span><span class="op" id="3247189">)</span><span class="op" id="3247190">;</span>&nbsp;<span class="ident" id="3247192">err</span>&nbsp;<span class="op" id="3247196">!=</span>&nbsp;<span class="builtintype" id="3247199">nil</span>&nbsp;<span class="op" id="3247203">{</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3247208">return</span>&nbsp;<span class="ident" id="3247215">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3247221">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3247225">nerr</span><span class="op" id="3247229">,</span>&nbsp;<span class="ident" id="3247231">err</span>&nbsp;<span class="op" id="3247235">:=</span>&nbsp;<span class="ident" id="3247238">syscall</span><span class="op" id="3247245">.</span><span class="ident" id="3247246">GetsockoptInt</span><span class="op" id="3247259">(</span><span class="ident" id="3247260">fd</span><span class="op" id="3247262">.</span><span class="ident" id="3247263">sysfd</span><span class="op" id="3247268">,</span>&nbsp;<span class="ident" id="3247270">syscall</span><span class="op" id="3247277">.</span><span class="ident" id="3247278">SOL_SOCKET</span><span class="op" id="3247288">,</span>&nbsp;<span class="ident" id="3247290">syscall</span><span class="op" id="3247297">.</span><span class="ident" id="3247298">SO_ERROR</span><span class="op" id="3247306">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3247310">if</span>&nbsp;<span class="ident" id="3247313">err</span>&nbsp;<span class="op" id="3247317">!=</span>&nbsp;<span class="builtintype" id="3247320">nil</span>&nbsp;<span class="op" id="3247324">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3247329">return</span>&nbsp;<span class="ident" id="3247336">err</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3247342">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3247346">switch</span>&nbsp;<span class="ident" id="3247353">err</span>&nbsp;<span class="op" id="3247357">:=</span>&nbsp;<span class="ident" id="3247360">syscall</span><span class="op" id="3247367">.</span><span class="ident" id="3247368">Errno</span><span class="op" id="3247373">(</span><span class="ident" id="3247374">nerr</span><span class="op" id="3247378">)</span><span class="op" id="3247379">;</span>&nbsp;<span class="ident" id="3247381">err</span>&nbsp;<span class="op" id="3247385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3247389">case</span>&nbsp;<span class="ident" id="3247394">syscall</span><span class="op" id="3247401">.</span><span class="ident" id="3247402">EINPROGRESS</span><span class="op" id="3247413">,</span>&nbsp;<span class="ident" id="3247415">syscall</span><span class="op" id="3247422">.</span><span class="ident" id="3247423">EALREADY</span><span class="op" id="3247431">,</span>&nbsp;<span class="ident" id="3247433">syscall</span><span class="op" id="3247440">.</span><span class="ident" id="3247441">EINTR</span><span class="op" id="3247446">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3247450">case</span>&nbsp;<span class="ident" id="3247455">syscall</span><span class="op" id="3247462">.</span><span class="ident" id="3247463">Errno</span><span class="op" id="3247468">(</span><span class="num" id="3247469">0</span><span class="op" id="3247470">)</span><span class="op" id="3247471">,</span>&nbsp;<span class="ident" id="3247473">syscall</span><span class="op" id="3247480">.</span><span class="ident" id="3247481">EISCONN</span><span class="op" id="3247488">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3247493">return</span>&nbsp;<span class="builtintype" id="3247500">nil</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3247506">default</span><span class="op" id="3247513">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3247518">return</span>&nbsp;<span class="ident" id="3247525">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3247531">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3247534">}</span><br>
<span class="lineno"></span><span class="op" id="3247536">}</span><br>
<span class="lineno">130</span><br>
<span class="lineno"></span><span class="keyword" id="3247539">func</span>&nbsp;<span class="op" id="3247544">(</span><span class="ident" id="3247545">fd</span>&nbsp;<span class="op" id="3247548">*</span><span class="ident" id="3247549">netFD</span><span class="op" id="3247554">)</span>&nbsp;<span class="ident" id="3247556">destroy</span><span class="op" id="3247563">(</span><span class="op" id="3247564">)</span>&nbsp;<span class="op" id="3247566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3247569">//&nbsp;Poller&nbsp;may&nbsp;want&nbsp;to&nbsp;unregister&nbsp;fd&nbsp;in&nbsp;readiness&nbsp;notification&nbsp;mechanism,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3247643">//&nbsp;so&nbsp;this&nbsp;must&nbsp;be&nbsp;executed&nbsp;before&nbsp;closesocket.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3247692">fd</span><span class="op" id="3247694">.</span><span class="ident" id="3247695">pd</span><span class="op" id="3247697">.</span><span class="ident" id="3247698">Close</span><span class="op" id="3247703">(</span><span class="op" id="3247704">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3247707">closesocket</span><span class="op" id="3247718">(</span><span class="ident" id="3247719">fd</span><span class="op" id="3247721">.</span><span class="ident" id="3247722">sysfd</span><span class="op" id="3247727">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3247730">fd</span><span class="op" id="3247732">.</span><span class="ident" id="3247733">sysfd</span>&nbsp;<span class="op" id="3247739">=</span>&nbsp;<span class="op" id="3247741">-</span><span class="num" id="3247742">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3247745">runtime</span><span class="op" id="3247752">.</span><span class="ident" id="3247753">SetFinalizer</span><span class="op" id="3247765">(</span><span class="ident" id="3247766">fd</span><span class="op" id="3247768">,</span>&nbsp;<span class="builtintype" id="3247770">nil</span><span class="op" id="3247773">)</span><br>
<span class="lineno"></span><span class="op" id="3247775">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="comment" id="3247778">//&nbsp;Add&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;fd.</span><br>
<span class="lineno"></span><span class="comment" id="3247809">//&nbsp;Returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;fd&nbsp;cannot&nbsp;be&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="3247855">func</span>&nbsp;<span class="op" id="3247860">(</span><span class="ident" id="3247861">fd</span>&nbsp;<span class="op" id="3247864">*</span><span class="ident" id="3247865">netFD</span><span class="op" id="3247870">)</span>&nbsp;<span class="ident" id="3247872">incref</span><span class="op" id="3247878">(</span><span class="op" id="3247879">)</span>&nbsp;<span class="builtintype" id="3247881">error</span>&nbsp;<span class="op" id="3247887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3247890">if</span>&nbsp;<span class="op" id="3247893">!</span><span class="ident" id="3247894">fd</span><span class="op" id="3247896">.</span><span class="ident" id="3247897">fdmu</span><span class="op" id="3247901">.</span><span class="ident" id="3247902">Incref</span><span class="op" id="3247908">(</span><span class="op" id="3247909">)</span>&nbsp;<span class="op" id="3247911">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3247915">return</span>&nbsp;<span class="ident" id="3247922">errClosing</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3247934">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3247937">return</span>&nbsp;<span class="builtintype" id="3247944">nil</span><br>
<span class="lineno"></span><span class="op" id="3247948">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3247951">//&nbsp;Remove&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;FD&nbsp;and&nbsp;close&nbsp;if&nbsp;we&#39;ve&nbsp;been&nbsp;asked&nbsp;to&nbsp;do&nbsp;so</span><br>
<span class="lineno">150</span><span class="comment" id="3248023">//&nbsp;(and&nbsp;there&nbsp;are&nbsp;no&nbsp;references&nbsp;left).</span><br>
<span class="lineno"></span><span class="keyword" id="3248062">func</span>&nbsp;<span class="op" id="3248067">(</span><span class="ident" id="3248068">fd</span>&nbsp;<span class="op" id="3248071">*</span><span class="ident" id="3248072">netFD</span><span class="op" id="3248077">)</span>&nbsp;<span class="ident" id="3248079">decref</span><span class="op" id="3248085">(</span><span class="op" id="3248086">)</span>&nbsp;<span class="op" id="3248088">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3248091">if</span>&nbsp;<span class="ident" id="3248094">fd</span><span class="op" id="3248096">.</span><span class="ident" id="3248097">fdmu</span><span class="op" id="3248101">.</span><span class="ident" id="3248102">Decref</span><span class="op" id="3248108">(</span><span class="op" id="3248109">)</span>&nbsp;<span class="op" id="3248111">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3248115">fd</span><span class="op" id="3248117">.</span><span class="ident" id="3248118">destroy</span><span class="op" id="3248125">(</span><span class="op" id="3248126">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3248129">}</span><br>
<span class="lineno">155</span><span class="op" id="3248131">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3248134">//&nbsp;Add&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;fd&nbsp;and&nbsp;lock&nbsp;for&nbsp;reading.</span><br>
<span class="lineno"></span><span class="comment" id="3248186">//&nbsp;Returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;fd&nbsp;cannot&nbsp;be&nbsp;used.</span><br>
<span class="lineno"></span><span class="keyword" id="3248232">func</span>&nbsp;<span class="op" id="3248237">(</span><span class="ident" id="3248238">fd</span>&nbsp;<span class="op" id="3248241">*</span><span class="ident" id="3248242">netFD</span><span class="op" id="3248247">)</span>&nbsp;<span class="ident" id="3248249">readLock</span><span class="op" id="3248257">(</span><span class="op" id="3248258">)</span>&nbsp;<span class="builtintype" id="3248260">error</span>&nbsp;<span class="op" id="3248266">{</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3248269">if</span>&nbsp;<span class="op" id="3248272">!</span><span class="ident" id="3248273">fd</span><span class="op" id="3248275">.</span><span class="ident" id="3248276">fdmu</span><span class="op" id="3248280">.</span><span class="ident" id="3248281">RWLock</span><span class="op" id="3248287">(</span><span class="builtintype" id="3248288">true</span><span class="op" id="3248292">)</span>&nbsp;<span class="op" id="3248294">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3248298">return</span>&nbsp;<span class="ident" id="3248305">errClosing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3248317">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3248320">return</span>&nbsp;<span class="builtintype" id="3248327">nil</span><br>
<span class="lineno"></span><span class="op" id="3248331">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="comment" id="3248334">//&nbsp;Unlock&nbsp;for&nbsp;reading&nbsp;and&nbsp;remove&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;FD.</span><br>
<span class="lineno"></span><span class="keyword" id="3248391">func</span>&nbsp;<span class="op" id="3248396">(</span><span class="ident" id="3248397">fd</span>&nbsp;<span class="op" id="3248400">*</span><span class="ident" id="3248401">netFD</span><span class="op" id="3248406">)</span>&nbsp;<span class="ident" id="3248408">readUnlock</span><span class="op" id="3248418">(</span><span class="op" id="3248419">)</span>&nbsp;<span class="op" id="3248421">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3248424">if</span>&nbsp;<span class="ident" id="3248427">fd</span><span class="op" id="3248429">.</span><span class="ident" id="3248430">fdmu</span><span class="op" id="3248434">.</span><span class="ident" id="3248435">RWUnlock</span><span class="op" id="3248443">(</span><span class="builtintype" id="3248444">true</span><span class="op" id="3248448">)</span>&nbsp;<span class="op" id="3248450">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3248454">fd</span><span class="op" id="3248456">.</span><span class="ident" id="3248457">destroy</span><span class="op" id="3248464">(</span><span class="op" id="3248465">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3248468">}</span><br>
<span class="lineno"></span><span class="op" id="3248470">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3248473">//&nbsp;Add&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;fd&nbsp;and&nbsp;lock&nbsp;for&nbsp;writing.</span><br>
<span class="lineno"></span><span class="comment" id="3248525">//&nbsp;Returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;fd&nbsp;cannot&nbsp;be&nbsp;used.</span><br>
<span class="lineno">175</span><span class="keyword" id="3248571">func</span>&nbsp;<span class="op" id="3248576">(</span><span class="ident" id="3248577">fd</span>&nbsp;<span class="op" id="3248580">*</span><span class="ident" id="3248581">netFD</span><span class="op" id="3248586">)</span>&nbsp;<span class="ident" id="3248588">writeLock</span><span class="op" id="3248597">(</span><span class="op" id="3248598">)</span>&nbsp;<span class="builtintype" id="3248600">error</span>&nbsp;<span class="op" id="3248606">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3248609">if</span>&nbsp;<span class="op" id="3248612">!</span><span class="ident" id="3248613">fd</span><span class="op" id="3248615">.</span><span class="ident" id="3248616">fdmu</span><span class="op" id="3248620">.</span><span class="ident" id="3248621">RWLock</span><span class="op" id="3248627">(</span><span class="builtintype" id="3248628">false</span><span class="op" id="3248633">)</span>&nbsp;<span class="op" id="3248635">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3248639">return</span>&nbsp;<span class="ident" id="3248646">errClosing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3248658">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3248661">return</span>&nbsp;<span class="builtintype" id="3248668">nil</span><br>
<span class="lineno">180</span><span class="op" id="3248672">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3248675">//&nbsp;Unlock&nbsp;for&nbsp;writing&nbsp;and&nbsp;remove&nbsp;a&nbsp;reference&nbsp;to&nbsp;this&nbsp;FD.</span><br>
<span class="lineno"></span><span class="keyword" id="3248732">func</span>&nbsp;<span class="op" id="3248737">(</span><span class="ident" id="3248738">fd</span>&nbsp;<span class="op" id="3248741">*</span><span class="ident" id="3248742">netFD</span><span class="op" id="3248747">)</span>&nbsp;<span class="ident" id="3248749">writeUnlock</span><span class="op" id="3248760">(</span><span class="op" id="3248761">)</span>&nbsp;<span class="op" id="3248763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3248766">if</span>&nbsp;<span class="ident" id="3248769">fd</span><span class="op" id="3248771">.</span><span class="ident" id="3248772">fdmu</span><span class="op" id="3248776">.</span><span class="ident" id="3248777">RWUnlock</span><span class="op" id="3248785">(</span><span class="builtintype" id="3248786">false</span><span class="op" id="3248791">)</span>&nbsp;<span class="op" id="3248793">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3248797">fd</span><span class="op" id="3248799">.</span><span class="ident" id="3248800">destroy</span><span class="op" id="3248807">(</span><span class="op" id="3248808">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3248811">}</span><br>
<span class="lineno"></span><span class="op" id="3248813">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3248816">func</span>&nbsp;<span class="op" id="3248821">(</span><span class="ident" id="3248822">fd</span>&nbsp;<span class="op" id="3248825">*</span><span class="ident" id="3248826">netFD</span><span class="op" id="3248831">)</span>&nbsp;<span class="ident" id="3248833">Close</span><span class="op" id="3248838">(</span><span class="op" id="3248839">)</span>&nbsp;<span class="builtintype" id="3248841">error</span>&nbsp;<span class="op" id="3248847">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3248850">fd</span><span class="op" id="3248852">.</span><span class="ident" id="3248853">pd</span><span class="op" id="3248855">.</span><span class="ident" id="3248856">Lock</span><span class="op" id="3248860">(</span><span class="op" id="3248861">)</span>&nbsp;<span class="comment" id="3248863">//&nbsp;needed&nbsp;for&nbsp;both&nbsp;fd.incref(true)&nbsp;and&nbsp;pollDesc.Evict</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3248918">if</span>&nbsp;<span class="op" id="3248921">!</span><span class="ident" id="3248922">fd</span><span class="op" id="3248924">.</span><span class="ident" id="3248925">fdmu</span><span class="op" id="3248929">.</span><span class="ident" id="3248930">IncrefAndClose</span><span class="op" id="3248944">(</span><span class="op" id="3248945">)</span>&nbsp;<span class="op" id="3248947">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3248951">fd</span><span class="op" id="3248953">.</span><span class="ident" id="3248954">pd</span><span class="op" id="3248956">.</span><span class="ident" id="3248957">Unlock</span><span class="op" id="3248963">(</span><span class="op" id="3248964">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3248968">return</span>&nbsp;<span class="ident" id="3248975">errClosing</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3248987">}</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3248990">//&nbsp;Unblock&nbsp;any&nbsp;I/O.&nbsp;&nbsp;Once&nbsp;it&nbsp;all&nbsp;unblocks&nbsp;and&nbsp;returns,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3249046">//&nbsp;so&nbsp;that&nbsp;it&nbsp;cannot&nbsp;be&nbsp;referring&nbsp;to&nbsp;fd.sysfd&nbsp;anymore,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3249102">//&nbsp;the&nbsp;final&nbsp;decref&nbsp;will&nbsp;close&nbsp;fd.sysfd.&nbsp;&nbsp;This&nbsp;should&nbsp;happen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3249164">//&nbsp;fairly&nbsp;quickly,&nbsp;since&nbsp;all&nbsp;the&nbsp;I/O&nbsp;is&nbsp;non-blocking,&nbsp;and&nbsp;any</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3249227">//&nbsp;attempts&nbsp;to&nbsp;block&nbsp;in&nbsp;the&nbsp;pollDesc&nbsp;will&nbsp;return&nbsp;errClosing.</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3249289">doWakeup</span>&nbsp;<span class="op" id="3249298">:=</span>&nbsp;<span class="ident" id="3249301">fd</span><span class="op" id="3249303">.</span><span class="ident" id="3249304">pd</span><span class="op" id="3249306">.</span><span class="ident" id="3249307">Evict</span><span class="op" id="3249312">(</span><span class="op" id="3249313">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3249316">fd</span><span class="op" id="3249318">.</span><span class="ident" id="3249319">pd</span><span class="op" id="3249321">.</span><span class="ident" id="3249322">Unlock</span><span class="op" id="3249328">(</span><span class="op" id="3249329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3249332">fd</span><span class="op" id="3249334">.</span><span class="ident" id="3249335">decref</span><span class="op" id="3249341">(</span><span class="op" id="3249342">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3249345">if</span>&nbsp;<span class="ident" id="3249348">doWakeup</span>&nbsp;<span class="op" id="3249357">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3249361">fd</span><span class="op" id="3249363">.</span><span class="ident" id="3249364">pd</span><span class="op" id="3249366">.</span><span class="ident" id="3249367">Wakeup</span><span class="op" id="3249373">(</span><span class="op" id="3249374">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3249377">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3249380">return</span>&nbsp;<span class="builtintype" id="3249387">nil</span><br>
<span class="lineno"></span><span class="op" id="3249391">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3249394">func</span>&nbsp;<span class="op" id="3249399">(</span><span class="ident" id="3249400">fd</span>&nbsp;<span class="op" id="3249403">*</span><span class="ident" id="3249404">netFD</span><span class="op" id="3249409">)</span>&nbsp;<span class="ident" id="3249411">shutdown</span><span class="op" id="3249419">(</span><span class="ident" id="3249420">how</span>&nbsp;<span class="builtintype" id="3249424">int</span><span class="op" id="3249427">)</span>&nbsp;<span class="builtintype" id="3249429">error</span>&nbsp;<span class="op" id="3249435">{</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3249438">if</span>&nbsp;<span class="ident" id="3249441">err</span>&nbsp;<span class="op" id="3249445">:=</span>&nbsp;<span class="ident" id="3249448">fd</span><span class="op" id="3249450">.</span><span class="ident" id="3249451">incref</span><span class="op" id="3249457">(</span><span class="op" id="3249458">)</span><span class="op" id="3249459">;</span>&nbsp;<span class="ident" id="3249461">err</span>&nbsp;<span class="op" id="3249465">!=</span>&nbsp;<span class="builtintype" id="3249468">nil</span>&nbsp;<span class="op" id="3249472">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3249476">return</span>&nbsp;<span class="ident" id="3249483">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3249488">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3249491">defer</span>&nbsp;<span class="ident" id="3249497">fd</span><span class="op" id="3249499">.</span><span class="ident" id="3249500">decref</span><span class="op" id="3249506">(</span><span class="op" id="3249507">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3249510">err</span>&nbsp;<span class="op" id="3249514">:=</span>&nbsp;<span class="ident" id="3249517">syscall</span><span class="op" id="3249524">.</span><span class="ident" id="3249525">Shutdown</span><span class="op" id="3249533">(</span><span class="ident" id="3249534">fd</span><span class="op" id="3249536">.</span><span class="ident" id="3249537">sysfd</span><span class="op" id="3249542">,</span>&nbsp;<span class="ident" id="3249544">how</span><span class="op" id="3249547">)</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3249550">if</span>&nbsp;<span class="ident" id="3249553">err</span>&nbsp;<span class="op" id="3249557">!=</span>&nbsp;<span class="builtintype" id="3249560">nil</span>&nbsp;<span class="op" id="3249564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3249568">return</span>&nbsp;<span class="op" id="3249575">&amp;</span><span class="ident" id="3249576">OpError</span><span class="op" id="3249583">{</span><span class="string" id="3249584">&#34;shutdown&#34;</span><span class="op" id="3249594">,</span>&nbsp;<span class="ident" id="3249596">fd</span><span class="op" id="3249598">.</span><span class="ident" id="3249599">net</span><span class="op" id="3249602">,</span>&nbsp;<span class="ident" id="3249604">fd</span><span class="op" id="3249606">.</span><span class="ident" id="3249607">laddr</span><span class="op" id="3249612">,</span>&nbsp;<span class="ident" id="3249614">err</span><span class="op" id="3249617">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3249620">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3249623">return</span>&nbsp;<span class="builtintype" id="3249630">nil</span><br>
<span class="lineno"></span><span class="op" id="3249634">}</span><br>
<span class="lineno">220</span><br>
<span class="lineno"></span><span class="keyword" id="3249637">func</span>&nbsp;<span class="op" id="3249642">(</span><span class="ident" id="3249643">fd</span>&nbsp;<span class="op" id="3249646">*</span><span class="ident" id="3249647">netFD</span><span class="op" id="3249652">)</span>&nbsp;<span class="ident" id="3249654">closeRead</span><span class="op" id="3249663">(</span><span class="op" id="3249664">)</span>&nbsp;<span class="builtintype" id="3249666">error</span>&nbsp;<span class="op" id="3249672">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3249675">return</span>&nbsp;<span class="ident" id="3249682">fd</span><span class="op" id="3249684">.</span><span class="ident" id="3249685">shutdown</span><span class="op" id="3249693">(</span><span class="ident" id="3249694">syscall</span><span class="op" id="3249701">.</span><span class="ident" id="3249702">SHUT_RD</span><span class="op" id="3249709">)</span><br>
<span class="lineno"></span><span class="op" id="3249711">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">225</span><span class="keyword" id="3249714">func</span>&nbsp;<span class="op" id="3249719">(</span><span class="ident" id="3249720">fd</span>&nbsp;<span class="op" id="3249723">*</span><span class="ident" id="3249724">netFD</span><span class="op" id="3249729">)</span>&nbsp;<span class="ident" id="3249731">closeWrite</span><span class="op" id="3249741">(</span><span class="op" id="3249742">)</span>&nbsp;<span class="builtintype" id="3249744">error</span>&nbsp;<span class="op" id="3249750">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3249753">return</span>&nbsp;<span class="ident" id="3249760">fd</span><span class="op" id="3249762">.</span><span class="ident" id="3249763">shutdown</span><span class="op" id="3249771">(</span><span class="ident" id="3249772">syscall</span><span class="op" id="3249779">.</span><span class="ident" id="3249780">SHUT_WR</span><span class="op" id="3249787">)</span><br>
<span class="lineno"></span><span class="op" id="3249789">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3249792">func</span>&nbsp;<span class="op" id="3249797">(</span><span class="ident" id="3249798">fd</span>&nbsp;<span class="op" id="3249801">*</span><span class="ident" id="3249802">netFD</span><span class="op" id="3249807">)</span>&nbsp;<span class="ident" id="3249809">Read</span><span class="op" id="3249813">(</span><span class="ident" id="3249814">p</span>&nbsp;<span class="op" id="3249816">[</span><span class="op" id="3249817">]</span><span class="builtintype" id="3249818">byte</span><span class="op" id="3249822">)</span>&nbsp;<span class="op" id="3249824">(</span><span class="ident" id="3249825">n</span>&nbsp;<span class="builtintype" id="3249827">int</span><span class="op" id="3249830">,</span>&nbsp;<span class="ident" id="3249832">err</span>&nbsp;<span class="builtintype" id="3249836">error</span><span class="op" id="3249841">)</span>&nbsp;<span class="op" id="3249843">{</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3249846">if</span>&nbsp;<span class="ident" id="3249849">err</span>&nbsp;<span class="op" id="3249853">:=</span>&nbsp;<span class="ident" id="3249856">fd</span><span class="op" id="3249858">.</span><span class="ident" id="3249859">readLock</span><span class="op" id="3249867">(</span><span class="op" id="3249868">)</span><span class="op" id="3249869">;</span>&nbsp;<span class="ident" id="3249871">err</span>&nbsp;<span class="op" id="3249875">!=</span>&nbsp;<span class="builtintype" id="3249878">nil</span>&nbsp;<span class="op" id="3249882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3249886">return</span>&nbsp;<span class="num" id="3249893">0</span><span class="op" id="3249894">,</span>&nbsp;<span class="ident" id="3249896">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3249901">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3249904">defer</span>&nbsp;<span class="ident" id="3249910">fd</span><span class="op" id="3249912">.</span><span class="ident" id="3249913">readUnlock</span><span class="op" id="3249923">(</span><span class="op" id="3249924">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3249927">if</span>&nbsp;<span class="ident" id="3249930">err</span>&nbsp;<span class="op" id="3249934">:=</span>&nbsp;<span class="ident" id="3249937">fd</span><span class="op" id="3249939">.</span><span class="ident" id="3249940">pd</span><span class="op" id="3249942">.</span><span class="ident" id="3249943">PrepareRead</span><span class="op" id="3249954">(</span><span class="op" id="3249955">)</span><span class="op" id="3249956">;</span>&nbsp;<span class="ident" id="3249958">err</span>&nbsp;<span class="op" id="3249962">!=</span>&nbsp;<span class="builtintype" id="3249965">nil</span>&nbsp;<span class="op" id="3249969">{</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3249973">return</span>&nbsp;<span class="num" id="3249980">0</span><span class="op" id="3249981">,</span>&nbsp;<span class="op" id="3249983">&amp;</span><span class="ident" id="3249984">OpError</span><span class="op" id="3249991">{</span><span class="string" id="3249992">&#34;read&#34;</span><span class="op" id="3249998">,</span>&nbsp;<span class="ident" id="3250000">fd</span><span class="op" id="3250002">.</span><span class="ident" id="3250003">net</span><span class="op" id="3250006">,</span>&nbsp;<span class="ident" id="3250008">fd</span><span class="op" id="3250010">.</span><span class="ident" id="3250011">raddr</span><span class="op" id="3250016">,</span>&nbsp;<span class="ident" id="3250018">err</span><span class="op" id="3250021">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3250024">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3250027">for</span>&nbsp;<span class="op" id="3250031">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3250035">n</span><span class="op" id="3250036">,</span>&nbsp;<span class="ident" id="3250038">err</span>&nbsp;<span class="op" id="3250042">=</span>&nbsp;<span class="ident" id="3250044">syscall</span><span class="op" id="3250051">.</span><span class="ident" id="3250052">Read</span><span class="op" id="3250056">(</span><span class="builtintype" id="3250057">int</span><span class="op" id="3250060">(</span><span class="ident" id="3250061">fd</span><span class="op" id="3250063">.</span><span class="ident" id="3250064">sysfd</span><span class="op" id="3250069">)</span><span class="op" id="3250070">,</span>&nbsp;<span class="ident" id="3250072">p</span><span class="op" id="3250073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3250077">if</span>&nbsp;<span class="ident" id="3250080">err</span>&nbsp;<span class="op" id="3250084">!=</span>&nbsp;<span class="builtintype" id="3250087">nil</span>&nbsp;<span class="op" id="3250091">{</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3250096">n</span>&nbsp;<span class="op" id="3250098">=</span>&nbsp;<span class="num" id="3250100">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3250105">if</span>&nbsp;<span class="ident" id="3250108">err</span>&nbsp;<span class="op" id="3250112">==</span>&nbsp;<span class="ident" id="3250115">syscall</span><span class="op" id="3250122">.</span><span class="ident" id="3250123">EAGAIN</span>&nbsp;<span class="op" id="3250130">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3250136">if</span>&nbsp;<span class="ident" id="3250139">err</span>&nbsp;<span class="op" id="3250143">=</span>&nbsp;<span class="ident" id="3250145">fd</span><span class="op" id="3250147">.</span><span class="ident" id="3250148">pd</span><span class="op" id="3250150">.</span><span class="ident" id="3250151">WaitRead</span><span class="op" id="3250159">(</span><span class="op" id="3250160">)</span><span class="op" id="3250161">;</span>&nbsp;<span class="ident" id="3250163">err</span>&nbsp;<span class="op" id="3250167">==</span>&nbsp;<span class="builtintype" id="3250170">nil</span>&nbsp;<span class="op" id="3250174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3250181">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3250194">}</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3250199">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3250203">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3250207">err</span>&nbsp;<span class="op" id="3250211">=</span>&nbsp;<span class="ident" id="3250213">chkReadErr</span><span class="op" id="3250223">(</span><span class="ident" id="3250224">n</span><span class="op" id="3250225">,</span>&nbsp;<span class="ident" id="3250227">err</span><span class="op" id="3250230">,</span>&nbsp;<span class="ident" id="3250232">fd</span><span class="op" id="3250234">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3250238">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3250245">}</span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3250248">if</span>&nbsp;<span class="ident" id="3250251">err</span>&nbsp;<span class="op" id="3250255">!=</span>&nbsp;<span class="builtintype" id="3250258">nil</span>&nbsp;<span class="op" id="3250262">&amp;&amp;</span>&nbsp;<span class="ident" id="3250265">err</span>&nbsp;<span class="op" id="3250269">!=</span>&nbsp;<span class="ident" id="3250272">io</span><span class="op" id="3250274">.</span><span class="ident" id="3250275">EOF</span>&nbsp;<span class="op" id="3250279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3250283">err</span>&nbsp;<span class="op" id="3250287">=</span>&nbsp;<span class="op" id="3250289">&amp;</span><span class="ident" id="3250290">OpError</span><span class="op" id="3250297">{</span><span class="string" id="3250298">&#34;read&#34;</span><span class="op" id="3250304">,</span>&nbsp;<span class="ident" id="3250306">fd</span><span class="op" id="3250308">.</span><span class="ident" id="3250309">net</span><span class="op" id="3250312">,</span>&nbsp;<span class="ident" id="3250314">fd</span><span class="op" id="3250316">.</span><span class="ident" id="3250317">raddr</span><span class="op" id="3250322">,</span>&nbsp;<span class="ident" id="3250324">err</span><span class="op" id="3250327">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3250330">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3250333">return</span><br>
<span class="lineno"></span><span class="op" id="3250340">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span><span class="keyword" id="3250343">func</span>&nbsp;<span class="op" id="3250348">(</span><span class="ident" id="3250349">fd</span>&nbsp;<span class="op" id="3250352">*</span><span class="ident" id="3250353">netFD</span><span class="op" id="3250358">)</span>&nbsp;<span class="ident" id="3250360">readFrom</span><span class="op" id="3250368">(</span><span class="ident" id="3250369">p</span>&nbsp;<span class="op" id="3250371">[</span><span class="op" id="3250372">]</span><span class="builtintype" id="3250373">byte</span><span class="op" id="3250377">)</span>&nbsp;<span class="op" id="3250379">(</span><span class="ident" id="3250380">n</span>&nbsp;<span class="builtintype" id="3250382">int</span><span class="op" id="3250385">,</span>&nbsp;<span class="ident" id="3250387">sa</span>&nbsp;<span class="ident" id="3250390">syscall</span><span class="op" id="3250397">.</span><span class="ident" id="3250398">Sockaddr</span><span class="op" id="3250406">,</span>&nbsp;<span class="ident" id="3250408">err</span>&nbsp;<span class="builtintype" id="3250412">error</span><span class="op" id="3250417">)</span>&nbsp;<span class="op" id="3250419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3250422">if</span>&nbsp;<span class="ident" id="3250425">err</span>&nbsp;<span class="op" id="3250429">:=</span>&nbsp;<span class="ident" id="3250432">fd</span><span class="op" id="3250434">.</span><span class="ident" id="3250435">readLock</span><span class="op" id="3250443">(</span><span class="op" id="3250444">)</span><span class="op" id="3250445">;</span>&nbsp;<span class="ident" id="3250447">err</span>&nbsp;<span class="op" id="3250451">!=</span>&nbsp;<span class="builtintype" id="3250454">nil</span>&nbsp;<span class="op" id="3250458">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3250462">return</span>&nbsp;<span class="num" id="3250469">0</span><span class="op" id="3250470">,</span>&nbsp;<span class="builtintype" id="3250472">nil</span><span class="op" id="3250475">,</span>&nbsp;<span class="ident" id="3250477">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3250482">}</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3250485">defer</span>&nbsp;<span class="ident" id="3250491">fd</span><span class="op" id="3250493">.</span><span class="ident" id="3250494">readUnlock</span><span class="op" id="3250504">(</span><span class="op" id="3250505">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3250508">if</span>&nbsp;<span class="ident" id="3250511">err</span>&nbsp;<span class="op" id="3250515">:=</span>&nbsp;<span class="ident" id="3250518">fd</span><span class="op" id="3250520">.</span><span class="ident" id="3250521">pd</span><span class="op" id="3250523">.</span><span class="ident" id="3250524">PrepareRead</span><span class="op" id="3250535">(</span><span class="op" id="3250536">)</span><span class="op" id="3250537">;</span>&nbsp;<span class="ident" id="3250539">err</span>&nbsp;<span class="op" id="3250543">!=</span>&nbsp;<span class="builtintype" id="3250546">nil</span>&nbsp;<span class="op" id="3250550">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3250554">return</span>&nbsp;<span class="num" id="3250561">0</span><span class="op" id="3250562">,</span>&nbsp;<span class="builtintype" id="3250564">nil</span><span class="op" id="3250567">,</span>&nbsp;<span class="op" id="3250569">&amp;</span><span class="ident" id="3250570">OpError</span><span class="op" id="3250577">{</span><span class="string" id="3250578">&#34;read&#34;</span><span class="op" id="3250584">,</span>&nbsp;<span class="ident" id="3250586">fd</span><span class="op" id="3250588">.</span><span class="ident" id="3250589">net</span><span class="op" id="3250592">,</span>&nbsp;<span class="ident" id="3250594">fd</span><span class="op" id="3250596">.</span><span class="ident" id="3250597">laddr</span><span class="op" id="3250602">,</span>&nbsp;<span class="ident" id="3250604">err</span><span class="op" id="3250607">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3250610">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3250613">for</span>&nbsp;<span class="op" id="3250617">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3250621">n</span><span class="op" id="3250622">,</span>&nbsp;<span class="ident" id="3250624">sa</span><span class="op" id="3250626">,</span>&nbsp;<span class="ident" id="3250628">err</span>&nbsp;<span class="op" id="3250632">=</span>&nbsp;<span class="ident" id="3250634">syscall</span><span class="op" id="3250641">.</span><span class="ident" id="3250642">Recvfrom</span><span class="op" id="3250650">(</span><span class="ident" id="3250651">fd</span><span class="op" id="3250653">.</span><span class="ident" id="3250654">sysfd</span><span class="op" id="3250659">,</span>&nbsp;<span class="ident" id="3250661">p</span><span class="op" id="3250662">,</span>&nbsp;<span class="num" id="3250664">0</span><span class="op" id="3250665">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3250669">if</span>&nbsp;<span class="ident" id="3250672">err</span>&nbsp;<span class="op" id="3250676">!=</span>&nbsp;<span class="builtintype" id="3250679">nil</span>&nbsp;<span class="op" id="3250683">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3250688">n</span>&nbsp;<span class="op" id="3250690">=</span>&nbsp;<span class="num" id="3250692">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3250697">if</span>&nbsp;<span class="ident" id="3250700">err</span>&nbsp;<span class="op" id="3250704">==</span>&nbsp;<span class="ident" id="3250707">syscall</span><span class="op" id="3250714">.</span><span class="ident" id="3250715">EAGAIN</span>&nbsp;<span class="op" id="3250722">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3250728">if</span>&nbsp;<span class="ident" id="3250731">err</span>&nbsp;<span class="op" id="3250735">=</span>&nbsp;<span class="ident" id="3250737">fd</span><span class="op" id="3250739">.</span><span class="ident" id="3250740">pd</span><span class="op" id="3250742">.</span><span class="ident" id="3250743">WaitRead</span><span class="op" id="3250751">(</span><span class="op" id="3250752">)</span><span class="op" id="3250753">;</span>&nbsp;<span class="ident" id="3250755">err</span>&nbsp;<span class="op" id="3250759">==</span>&nbsp;<span class="builtintype" id="3250762">nil</span>&nbsp;<span class="op" id="3250766">{</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3250773">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3250786">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3250791">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3250795">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3250799">err</span>&nbsp;<span class="op" id="3250803">=</span>&nbsp;<span class="ident" id="3250805">chkReadErr</span><span class="op" id="3250815">(</span><span class="ident" id="3250816">n</span><span class="op" id="3250817">,</span>&nbsp;<span class="ident" id="3250819">err</span><span class="op" id="3250822">,</span>&nbsp;<span class="ident" id="3250824">fd</span><span class="op" id="3250826">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3250830">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3250837">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3250840">if</span>&nbsp;<span class="ident" id="3250843">err</span>&nbsp;<span class="op" id="3250847">!=</span>&nbsp;<span class="builtintype" id="3250850">nil</span>&nbsp;<span class="op" id="3250854">&amp;&amp;</span>&nbsp;<span class="ident" id="3250857">err</span>&nbsp;<span class="op" id="3250861">!=</span>&nbsp;<span class="ident" id="3250864">io</span><span class="op" id="3250866">.</span><span class="ident" id="3250867">EOF</span>&nbsp;<span class="op" id="3250871">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3250875">err</span>&nbsp;<span class="op" id="3250879">=</span>&nbsp;<span class="op" id="3250881">&amp;</span><span class="ident" id="3250882">OpError</span><span class="op" id="3250889">{</span><span class="string" id="3250890">&#34;read&#34;</span><span class="op" id="3250896">,</span>&nbsp;<span class="ident" id="3250898">fd</span><span class="op" id="3250900">.</span><span class="ident" id="3250901">net</span><span class="op" id="3250904">,</span>&nbsp;<span class="ident" id="3250906">fd</span><span class="op" id="3250908">.</span><span class="ident" id="3250909">laddr</span><span class="op" id="3250914">,</span>&nbsp;<span class="ident" id="3250916">err</span><span class="op" id="3250919">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3250922">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3250925">return</span><br>
<span class="lineno"></span><span class="op" id="3250932">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3250935">func</span>&nbsp;<span class="op" id="3250940">(</span><span class="ident" id="3250941">fd</span>&nbsp;<span class="op" id="3250944">*</span><span class="ident" id="3250945">netFD</span><span class="op" id="3250950">)</span>&nbsp;<span class="ident" id="3250952">readMsg</span><span class="op" id="3250959">(</span><span class="ident" id="3250960">p</span>&nbsp;<span class="op" id="3250962">[</span><span class="op" id="3250963">]</span><span class="builtintype" id="3250964">byte</span><span class="op" id="3250968">,</span>&nbsp;<span class="ident" id="3250970">oob</span>&nbsp;<span class="op" id="3250974">[</span><span class="op" id="3250975">]</span><span class="builtintype" id="3250976">byte</span><span class="op" id="3250980">)</span>&nbsp;<span class="op" id="3250982">(</span><span class="ident" id="3250983">n</span><span class="op" id="3250984">,</span>&nbsp;<span class="ident" id="3250986">oobn</span><span class="op" id="3250990">,</span>&nbsp;<span class="ident" id="3250992">flags</span>&nbsp;<span class="builtintype" id="3250998">int</span><span class="op" id="3251001">,</span>&nbsp;<span class="ident" id="3251003">sa</span>&nbsp;<span class="ident" id="3251006">syscall</span><span class="op" id="3251013">.</span><span class="ident" id="3251014">Sockaddr</span><span class="op" id="3251022">,</span>&nbsp;<span class="ident" id="3251024">err</span>&nbsp;<span class="builtintype" id="3251028">error</span><span class="op" id="3251033">)</span>&nbsp;<span class="op" id="3251035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3251038">if</span>&nbsp;<span class="ident" id="3251041">err</span>&nbsp;<span class="op" id="3251045">:=</span>&nbsp;<span class="ident" id="3251048">fd</span><span class="op" id="3251050">.</span><span class="ident" id="3251051">readLock</span><span class="op" id="3251059">(</span><span class="op" id="3251060">)</span><span class="op" id="3251061">;</span>&nbsp;<span class="ident" id="3251063">err</span>&nbsp;<span class="op" id="3251067">!=</span>&nbsp;<span class="builtintype" id="3251070">nil</span>&nbsp;<span class="op" id="3251074">{</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3251078">return</span>&nbsp;<span class="num" id="3251085">0</span><span class="op" id="3251086">,</span>&nbsp;<span class="num" id="3251088">0</span><span class="op" id="3251089">,</span>&nbsp;<span class="num" id="3251091">0</span><span class="op" id="3251092">,</span>&nbsp;<span class="builtintype" id="3251094">nil</span><span class="op" id="3251097">,</span>&nbsp;<span class="ident" id="3251099">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3251104">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3251107">defer</span>&nbsp;<span class="ident" id="3251113">fd</span><span class="op" id="3251115">.</span><span class="ident" id="3251116">readUnlock</span><span class="op" id="3251126">(</span><span class="op" id="3251127">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3251130">if</span>&nbsp;<span class="ident" id="3251133">err</span>&nbsp;<span class="op" id="3251137">:=</span>&nbsp;<span class="ident" id="3251140">fd</span><span class="op" id="3251142">.</span><span class="ident" id="3251143">pd</span><span class="op" id="3251145">.</span><span class="ident" id="3251146">PrepareRead</span><span class="op" id="3251157">(</span><span class="op" id="3251158">)</span><span class="op" id="3251159">;</span>&nbsp;<span class="ident" id="3251161">err</span>&nbsp;<span class="op" id="3251165">!=</span>&nbsp;<span class="builtintype" id="3251168">nil</span>&nbsp;<span class="op" id="3251172">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3251176">return</span>&nbsp;<span class="num" id="3251183">0</span><span class="op" id="3251184">,</span>&nbsp;<span class="num" id="3251186">0</span><span class="op" id="3251187">,</span>&nbsp;<span class="num" id="3251189">0</span><span class="op" id="3251190">,</span>&nbsp;<span class="builtintype" id="3251192">nil</span><span class="op" id="3251195">,</span>&nbsp;<span class="op" id="3251197">&amp;</span><span class="ident" id="3251198">OpError</span><span class="op" id="3251205">{</span><span class="string" id="3251206">&#34;read&#34;</span><span class="op" id="3251212">,</span>&nbsp;<span class="ident" id="3251214">fd</span><span class="op" id="3251216">.</span><span class="ident" id="3251217">net</span><span class="op" id="3251220">,</span>&nbsp;<span class="ident" id="3251222">fd</span><span class="op" id="3251224">.</span><span class="ident" id="3251225">laddr</span><span class="op" id="3251230">,</span>&nbsp;<span class="ident" id="3251232">err</span><span class="op" id="3251235">}</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3251238">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3251241">for</span>&nbsp;<span class="op" id="3251245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3251249">n</span><span class="op" id="3251250">,</span>&nbsp;<span class="ident" id="3251252">oobn</span><span class="op" id="3251256">,</span>&nbsp;<span class="ident" id="3251258">flags</span><span class="op" id="3251263">,</span>&nbsp;<span class="ident" id="3251265">sa</span><span class="op" id="3251267">,</span>&nbsp;<span class="ident" id="3251269">err</span>&nbsp;<span class="op" id="3251273">=</span>&nbsp;<span class="ident" id="3251275">syscall</span><span class="op" id="3251282">.</span><span class="ident" id="3251283">Recvmsg</span><span class="op" id="3251290">(</span><span class="ident" id="3251291">fd</span><span class="op" id="3251293">.</span><span class="ident" id="3251294">sysfd</span><span class="op" id="3251299">,</span>&nbsp;<span class="ident" id="3251301">p</span><span class="op" id="3251302">,</span>&nbsp;<span class="ident" id="3251304">oob</span><span class="op" id="3251307">,</span>&nbsp;<span class="num" id="3251309">0</span><span class="op" id="3251310">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3251314">if</span>&nbsp;<span class="ident" id="3251317">err</span>&nbsp;<span class="op" id="3251321">!=</span>&nbsp;<span class="builtintype" id="3251324">nil</span>&nbsp;<span class="op" id="3251328">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3251333">//&nbsp;TODO(dfc)&nbsp;should&nbsp;n&nbsp;and&nbsp;oobn&nbsp;be&nbsp;set&nbsp;to&nbsp;0</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3251379">if</span>&nbsp;<span class="ident" id="3251382">err</span>&nbsp;<span class="op" id="3251386">==</span>&nbsp;<span class="ident" id="3251389">syscall</span><span class="op" id="3251396">.</span><span class="ident" id="3251397">EAGAIN</span>&nbsp;<span class="op" id="3251404">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3251410">if</span>&nbsp;<span class="ident" id="3251413">err</span>&nbsp;<span class="op" id="3251417">=</span>&nbsp;<span class="ident" id="3251419">fd</span><span class="op" id="3251421">.</span><span class="ident" id="3251422">pd</span><span class="op" id="3251424">.</span><span class="ident" id="3251425">WaitRead</span><span class="op" id="3251433">(</span><span class="op" id="3251434">)</span><span class="op" id="3251435">;</span>&nbsp;<span class="ident" id="3251437">err</span>&nbsp;<span class="op" id="3251441">==</span>&nbsp;<span class="builtintype" id="3251444">nil</span>&nbsp;<span class="op" id="3251448">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3251455">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3251468">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3251473">}</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3251477">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3251481">err</span>&nbsp;<span class="op" id="3251485">=</span>&nbsp;<span class="ident" id="3251487">chkReadErr</span><span class="op" id="3251497">(</span><span class="ident" id="3251498">n</span><span class="op" id="3251499">,</span>&nbsp;<span class="ident" id="3251501">err</span><span class="op" id="3251504">,</span>&nbsp;<span class="ident" id="3251506">fd</span><span class="op" id="3251508">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3251512">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3251519">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3251522">if</span>&nbsp;<span class="ident" id="3251525">err</span>&nbsp;<span class="op" id="3251529">!=</span>&nbsp;<span class="builtintype" id="3251532">nil</span>&nbsp;<span class="op" id="3251536">&amp;&amp;</span>&nbsp;<span class="ident" id="3251539">err</span>&nbsp;<span class="op" id="3251543">!=</span>&nbsp;<span class="ident" id="3251546">io</span><span class="op" id="3251548">.</span><span class="ident" id="3251549">EOF</span>&nbsp;<span class="op" id="3251553">{</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3251557">err</span>&nbsp;<span class="op" id="3251561">=</span>&nbsp;<span class="op" id="3251563">&amp;</span><span class="ident" id="3251564">OpError</span><span class="op" id="3251571">{</span><span class="string" id="3251572">&#34;read&#34;</span><span class="op" id="3251578">,</span>&nbsp;<span class="ident" id="3251580">fd</span><span class="op" id="3251582">.</span><span class="ident" id="3251583">net</span><span class="op" id="3251586">,</span>&nbsp;<span class="ident" id="3251588">fd</span><span class="op" id="3251590">.</span><span class="ident" id="3251591">laddr</span><span class="op" id="3251596">,</span>&nbsp;<span class="ident" id="3251598">err</span><span class="op" id="3251601">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3251604">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3251607">return</span><br>
<span class="lineno"></span><span class="op" id="3251614">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">310</span><span class="keyword" id="3251617">func</span>&nbsp;<span class="ident" id="3251622">chkReadErr</span><span class="op" id="3251632">(</span><span class="ident" id="3251633">n</span>&nbsp;<span class="builtintype" id="3251635">int</span><span class="op" id="3251638">,</span>&nbsp;<span class="ident" id="3251640">err</span>&nbsp;<span class="builtintype" id="3251644">error</span><span class="op" id="3251649">,</span>&nbsp;<span class="ident" id="3251651">fd</span>&nbsp;<span class="op" id="3251654">*</span><span class="ident" id="3251655">netFD</span><span class="op" id="3251660">)</span>&nbsp;<span class="builtintype" id="3251662">error</span>&nbsp;<span class="op" id="3251668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3251671">if</span>&nbsp;<span class="ident" id="3251674">n</span>&nbsp;<span class="op" id="3251676">==</span>&nbsp;<span class="num" id="3251679">0</span>&nbsp;<span class="op" id="3251681">&amp;&amp;</span>&nbsp;<span class="ident" id="3251684">err</span>&nbsp;<span class="op" id="3251688">==</span>&nbsp;<span class="builtintype" id="3251691">nil</span>&nbsp;<span class="op" id="3251695">&amp;&amp;</span>&nbsp;<span class="ident" id="3251698">fd</span><span class="op" id="3251700">.</span><span class="ident" id="3251701">sotype</span>&nbsp;<span class="op" id="3251708">!=</span>&nbsp;<span class="ident" id="3251711">syscall</span><span class="op" id="3251718">.</span><span class="ident" id="3251719">SOCK_DGRAM</span>&nbsp;<span class="op" id="3251730">&amp;&amp;</span>&nbsp;<span class="ident" id="3251733">fd</span><span class="op" id="3251735">.</span><span class="ident" id="3251736">sotype</span>&nbsp;<span class="op" id="3251743">!=</span>&nbsp;<span class="ident" id="3251746">syscall</span><span class="op" id="3251753">.</span><span class="ident" id="3251754">SOCK_RAW</span>&nbsp;<span class="op" id="3251763">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3251767">return</span>&nbsp;<span class="ident" id="3251774">io</span><span class="op" id="3251776">.</span><span class="ident" id="3251777">EOF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3251782">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3251785">return</span>&nbsp;<span class="ident" id="3251792">err</span><br>
<span class="lineno">315</span><span class="op" id="3251796">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3251799">func</span>&nbsp;<span class="op" id="3251804">(</span><span class="ident" id="3251805">fd</span>&nbsp;<span class="op" id="3251808">*</span><span class="ident" id="3251809">netFD</span><span class="op" id="3251814">)</span>&nbsp;<span class="ident" id="3251816">Write</span><span class="op" id="3251821">(</span><span class="ident" id="3251822">p</span>&nbsp;<span class="op" id="3251824">[</span><span class="op" id="3251825">]</span><span class="builtintype" id="3251826">byte</span><span class="op" id="3251830">)</span>&nbsp;<span class="op" id="3251832">(</span><span class="ident" id="3251833">nn</span>&nbsp;<span class="builtintype" id="3251836">int</span><span class="op" id="3251839">,</span>&nbsp;<span class="ident" id="3251841">err</span>&nbsp;<span class="builtintype" id="3251845">error</span><span class="op" id="3251850">)</span>&nbsp;<span class="op" id="3251852">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3251855">if</span>&nbsp;<span class="ident" id="3251858">err</span>&nbsp;<span class="op" id="3251862">:=</span>&nbsp;<span class="ident" id="3251865">fd</span><span class="op" id="3251867">.</span><span class="ident" id="3251868">writeLock</span><span class="op" id="3251877">(</span><span class="op" id="3251878">)</span><span class="op" id="3251879">;</span>&nbsp;<span class="ident" id="3251881">err</span>&nbsp;<span class="op" id="3251885">!=</span>&nbsp;<span class="builtintype" id="3251888">nil</span>&nbsp;<span class="op" id="3251892">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3251896">return</span>&nbsp;<span class="num" id="3251903">0</span><span class="op" id="3251904">,</span>&nbsp;<span class="ident" id="3251906">err</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3251911">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3251914">defer</span>&nbsp;<span class="ident" id="3251920">fd</span><span class="op" id="3251922">.</span><span class="ident" id="3251923">writeUnlock</span><span class="op" id="3251934">(</span><span class="op" id="3251935">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3251938">if</span>&nbsp;<span class="ident" id="3251941">err</span>&nbsp;<span class="op" id="3251945">:=</span>&nbsp;<span class="ident" id="3251948">fd</span><span class="op" id="3251950">.</span><span class="ident" id="3251951">pd</span><span class="op" id="3251953">.</span><span class="ident" id="3251954">PrepareWrite</span><span class="op" id="3251966">(</span><span class="op" id="3251967">)</span><span class="op" id="3251968">;</span>&nbsp;<span class="ident" id="3251970">err</span>&nbsp;<span class="op" id="3251974">!=</span>&nbsp;<span class="builtintype" id="3251977">nil</span>&nbsp;<span class="op" id="3251981">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3251985">return</span>&nbsp;<span class="num" id="3251992">0</span><span class="op" id="3251993">,</span>&nbsp;<span class="op" id="3251995">&amp;</span><span class="ident" id="3251996">OpError</span><span class="op" id="3252003">{</span><span class="string" id="3252004">&#34;write&#34;</span><span class="op" id="3252011">,</span>&nbsp;<span class="ident" id="3252013">fd</span><span class="op" id="3252015">.</span><span class="ident" id="3252016">net</span><span class="op" id="3252019">,</span>&nbsp;<span class="ident" id="3252021">fd</span><span class="op" id="3252023">.</span><span class="ident" id="3252024">raddr</span><span class="op" id="3252029">,</span>&nbsp;<span class="ident" id="3252031">err</span><span class="op" id="3252034">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3252037">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3252040">for</span>&nbsp;<span class="op" id="3252044">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3252048">var</span>&nbsp;<span class="ident" id="3252052">n</span>&nbsp;<span class="builtintype" id="3252054">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3252060">n</span><span class="op" id="3252061">,</span>&nbsp;<span class="ident" id="3252063">err</span>&nbsp;<span class="op" id="3252067">=</span>&nbsp;<span class="ident" id="3252069">syscall</span><span class="op" id="3252076">.</span><span class="ident" id="3252077">Write</span><span class="op" id="3252082">(</span><span class="builtintype" id="3252083">int</span><span class="op" id="3252086">(</span><span class="ident" id="3252087">fd</span><span class="op" id="3252089">.</span><span class="ident" id="3252090">sysfd</span><span class="op" id="3252095">)</span><span class="op" id="3252096">,</span>&nbsp;<span class="ident" id="3252098">p</span><span class="op" id="3252099">[</span><span class="ident" id="3252100">nn</span><span class="op" id="3252102">:</span><span class="op" id="3252103">]</span><span class="op" id="3252104">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3252108">if</span>&nbsp;<span class="ident" id="3252111">n</span>&nbsp;<span class="op" id="3252113">&gt;</span>&nbsp;<span class="num" id="3252115">0</span>&nbsp;<span class="op" id="3252117">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3252122">nn</span>&nbsp;<span class="op" id="3252125">+=</span>&nbsp;<span class="ident" id="3252128">n</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3252132">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3252136">if</span>&nbsp;<span class="ident" id="3252139">nn</span>&nbsp;<span class="op" id="3252142">==</span>&nbsp;<span class="builtinfunc" id="3252145">len</span><span class="op" id="3252148">(</span><span class="ident" id="3252149">p</span><span class="op" id="3252150">)</span>&nbsp;<span class="op" id="3252152">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3252157">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3252165">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3252169">if</span>&nbsp;<span class="ident" id="3252172">err</span>&nbsp;<span class="op" id="3252176">==</span>&nbsp;<span class="ident" id="3252179">syscall</span><span class="op" id="3252186">.</span><span class="ident" id="3252187">EAGAIN</span>&nbsp;<span class="op" id="3252194">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3252199">if</span>&nbsp;<span class="ident" id="3252202">err</span>&nbsp;<span class="op" id="3252206">=</span>&nbsp;<span class="ident" id="3252208">fd</span><span class="op" id="3252210">.</span><span class="ident" id="3252211">pd</span><span class="op" id="3252213">.</span><span class="ident" id="3252214">WaitWrite</span><span class="op" id="3252223">(</span><span class="op" id="3252224">)</span><span class="op" id="3252225">;</span>&nbsp;<span class="ident" id="3252227">err</span>&nbsp;<span class="op" id="3252231">==</span>&nbsp;<span class="builtintype" id="3252234">nil</span>&nbsp;<span class="op" id="3252238">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3252244">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3252256">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3252260">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3252264">if</span>&nbsp;<span class="ident" id="3252267">err</span>&nbsp;<span class="op" id="3252271">!=</span>&nbsp;<span class="builtintype" id="3252274">nil</span>&nbsp;<span class="op" id="3252278">{</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3252283">n</span>&nbsp;<span class="op" id="3252285">=</span>&nbsp;<span class="num" id="3252287">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3252292">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3252300">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3252304">if</span>&nbsp;<span class="ident" id="3252307">n</span>&nbsp;<span class="op" id="3252309">==</span>&nbsp;<span class="num" id="3252312">0</span>&nbsp;<span class="op" id="3252314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3252319">err</span>&nbsp;<span class="op" id="3252323">=</span>&nbsp;<span class="ident" id="3252325">io</span><span class="op" id="3252327">.</span><span class="ident" id="3252328">ErrUnexpectedEOF</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3252348">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3252356">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3252359">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3252362">if</span>&nbsp;<span class="ident" id="3252365">err</span>&nbsp;<span class="op" id="3252369">!=</span>&nbsp;<span class="builtintype" id="3252372">nil</span>&nbsp;<span class="op" id="3252376">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3252380">err</span>&nbsp;<span class="op" id="3252384">=</span>&nbsp;<span class="op" id="3252386">&amp;</span><span class="ident" id="3252387">OpError</span><span class="op" id="3252394">{</span><span class="string" id="3252395">&#34;write&#34;</span><span class="op" id="3252402">,</span>&nbsp;<span class="ident" id="3252404">fd</span><span class="op" id="3252406">.</span><span class="ident" id="3252407">net</span><span class="op" id="3252410">,</span>&nbsp;<span class="ident" id="3252412">fd</span><span class="op" id="3252414">.</span><span class="ident" id="3252415">raddr</span><span class="op" id="3252420">,</span>&nbsp;<span class="ident" id="3252422">err</span><span class="op" id="3252425">}</span><br>
<span class="lineno">350</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3252428">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3252431">return</span>&nbsp;<span class="ident" id="3252438">nn</span><span class="op" id="3252440">,</span>&nbsp;<span class="ident" id="3252442">err</span><br>
<span class="lineno"></span><span class="op" id="3252446">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3252449">func</span>&nbsp;<span class="op" id="3252454">(</span><span class="ident" id="3252455">fd</span>&nbsp;<span class="op" id="3252458">*</span><span class="ident" id="3252459">netFD</span><span class="op" id="3252464">)</span>&nbsp;<span class="ident" id="3252466">writeTo</span><span class="op" id="3252473">(</span><span class="ident" id="3252474">p</span>&nbsp;<span class="op" id="3252476">[</span><span class="op" id="3252477">]</span><span class="builtintype" id="3252478">byte</span><span class="op" id="3252482">,</span>&nbsp;<span class="ident" id="3252484">sa</span>&nbsp;<span class="ident" id="3252487">syscall</span><span class="op" id="3252494">.</span><span class="ident" id="3252495">Sockaddr</span><span class="op" id="3252503">)</span>&nbsp;<span class="op" id="3252505">(</span><span class="ident" id="3252506">n</span>&nbsp;<span class="builtintype" id="3252508">int</span><span class="op" id="3252511">,</span>&nbsp;<span class="ident" id="3252513">err</span>&nbsp;<span class="builtintype" id="3252517">error</span><span class="op" id="3252522">)</span>&nbsp;<span class="op" id="3252524">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3252527">if</span>&nbsp;<span class="ident" id="3252530">err</span>&nbsp;<span class="op" id="3252534">:=</span>&nbsp;<span class="ident" id="3252537">fd</span><span class="op" id="3252539">.</span><span class="ident" id="3252540">writeLock</span><span class="op" id="3252549">(</span><span class="op" id="3252550">)</span><span class="op" id="3252551">;</span>&nbsp;<span class="ident" id="3252553">err</span>&nbsp;<span class="op" id="3252557">!=</span>&nbsp;<span class="builtintype" id="3252560">nil</span>&nbsp;<span class="op" id="3252564">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3252568">return</span>&nbsp;<span class="num" id="3252575">0</span><span class="op" id="3252576">,</span>&nbsp;<span class="ident" id="3252578">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3252583">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3252586">defer</span>&nbsp;<span class="ident" id="3252592">fd</span><span class="op" id="3252594">.</span><span class="ident" id="3252595">writeUnlock</span><span class="op" id="3252606">(</span><span class="op" id="3252607">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3252610">if</span>&nbsp;<span class="ident" id="3252613">err</span>&nbsp;<span class="op" id="3252617">:=</span>&nbsp;<span class="ident" id="3252620">fd</span><span class="op" id="3252622">.</span><span class="ident" id="3252623">pd</span><span class="op" id="3252625">.</span><span class="ident" id="3252626">PrepareWrite</span><span class="op" id="3252638">(</span><span class="op" id="3252639">)</span><span class="op" id="3252640">;</span>&nbsp;<span class="ident" id="3252642">err</span>&nbsp;<span class="op" id="3252646">!=</span>&nbsp;<span class="builtintype" id="3252649">nil</span>&nbsp;<span class="op" id="3252653">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3252657">return</span>&nbsp;<span class="num" id="3252664">0</span><span class="op" id="3252665">,</span>&nbsp;<span class="op" id="3252667">&amp;</span><span class="ident" id="3252668">OpError</span><span class="op" id="3252675">{</span><span class="string" id="3252676">&#34;write&#34;</span><span class="op" id="3252683">,</span>&nbsp;<span class="ident" id="3252685">fd</span><span class="op" id="3252687">.</span><span class="ident" id="3252688">net</span><span class="op" id="3252691">,</span>&nbsp;<span class="ident" id="3252693">fd</span><span class="op" id="3252695">.</span><span class="ident" id="3252696">raddr</span><span class="op" id="3252701">,</span>&nbsp;<span class="ident" id="3252703">err</span><span class="op" id="3252706">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3252709">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3252712">for</span>&nbsp;<span class="op" id="3252716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3252720">err</span>&nbsp;<span class="op" id="3252724">=</span>&nbsp;<span class="ident" id="3252726">syscall</span><span class="op" id="3252733">.</span><span class="ident" id="3252734">Sendto</span><span class="op" id="3252740">(</span><span class="ident" id="3252741">fd</span><span class="op" id="3252743">.</span><span class="ident" id="3252744">sysfd</span><span class="op" id="3252749">,</span>&nbsp;<span class="ident" id="3252751">p</span><span class="op" id="3252752">,</span>&nbsp;<span class="num" id="3252754">0</span><span class="op" id="3252755">,</span>&nbsp;<span class="ident" id="3252757">sa</span><span class="op" id="3252759">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3252763">if</span>&nbsp;<span class="ident" id="3252766">err</span>&nbsp;<span class="op" id="3252770">==</span>&nbsp;<span class="ident" id="3252773">syscall</span><span class="op" id="3252780">.</span><span class="ident" id="3252781">EAGAIN</span>&nbsp;<span class="op" id="3252788">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3252793">if</span>&nbsp;<span class="ident" id="3252796">err</span>&nbsp;<span class="op" id="3252800">=</span>&nbsp;<span class="ident" id="3252802">fd</span><span class="op" id="3252804">.</span><span class="ident" id="3252805">pd</span><span class="op" id="3252807">.</span><span class="ident" id="3252808">WaitWrite</span><span class="op" id="3252817">(</span><span class="op" id="3252818">)</span><span class="op" id="3252819">;</span>&nbsp;<span class="ident" id="3252821">err</span>&nbsp;<span class="op" id="3252825">==</span>&nbsp;<span class="builtintype" id="3252828">nil</span>&nbsp;<span class="op" id="3252832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3252838">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3252850">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3252854">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3252858">break</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3252865">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3252868">if</span>&nbsp;<span class="ident" id="3252871">err</span>&nbsp;<span class="op" id="3252875">==</span>&nbsp;<span class="builtintype" id="3252878">nil</span>&nbsp;<span class="op" id="3252882">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3252886">n</span>&nbsp;<span class="op" id="3252888">=</span>&nbsp;<span class="builtinfunc" id="3252890">len</span><span class="op" id="3252893">(</span><span class="ident" id="3252894">p</span><span class="op" id="3252895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3252898">}</span>&nbsp;<span class="keyword" id="3252900">else</span>&nbsp;<span class="op" id="3252905">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3252909">err</span>&nbsp;<span class="op" id="3252913">=</span>&nbsp;<span class="op" id="3252915">&amp;</span><span class="ident" id="3252916">OpError</span><span class="op" id="3252923">{</span><span class="string" id="3252924">&#34;write&#34;</span><span class="op" id="3252931">,</span>&nbsp;<span class="ident" id="3252933">fd</span><span class="op" id="3252935">.</span><span class="ident" id="3252936">net</span><span class="op" id="3252939">,</span>&nbsp;<span class="ident" id="3252941">fd</span><span class="op" id="3252943">.</span><span class="ident" id="3252944">raddr</span><span class="op" id="3252949">,</span>&nbsp;<span class="ident" id="3252951">err</span><span class="op" id="3252954">}</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3252957">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3252960">return</span><br>
<span class="lineno"></span><span class="op" id="3252967">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3252970">func</span>&nbsp;<span class="op" id="3252975">(</span><span class="ident" id="3252976">fd</span>&nbsp;<span class="op" id="3252979">*</span><span class="ident" id="3252980">netFD</span><span class="op" id="3252985">)</span>&nbsp;<span class="ident" id="3252987">writeMsg</span><span class="op" id="3252995">(</span><span class="ident" id="3252996">p</span>&nbsp;<span class="op" id="3252998">[</span><span class="op" id="3252999">]</span><span class="builtintype" id="3253000">byte</span><span class="op" id="3253004">,</span>&nbsp;<span class="ident" id="3253006">oob</span>&nbsp;<span class="op" id="3253010">[</span><span class="op" id="3253011">]</span><span class="builtintype" id="3253012">byte</span><span class="op" id="3253016">,</span>&nbsp;<span class="ident" id="3253018">sa</span>&nbsp;<span class="ident" id="3253021">syscall</span><span class="op" id="3253028">.</span><span class="ident" id="3253029">Sockaddr</span><span class="op" id="3253037">)</span>&nbsp;<span class="op" id="3253039">(</span><span class="ident" id="3253040">n</span>&nbsp;<span class="builtintype" id="3253042">int</span><span class="op" id="3253045">,</span>&nbsp;<span class="ident" id="3253047">oobn</span>&nbsp;<span class="builtintype" id="3253052">int</span><span class="op" id="3253055">,</span>&nbsp;<span class="ident" id="3253057">err</span>&nbsp;<span class="builtintype" id="3253061">error</span><span class="op" id="3253066">)</span>&nbsp;<span class="op" id="3253068">{</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3253071">if</span>&nbsp;<span class="ident" id="3253074">err</span>&nbsp;<span class="op" id="3253078">:=</span>&nbsp;<span class="ident" id="3253081">fd</span><span class="op" id="3253083">.</span><span class="ident" id="3253084">writeLock</span><span class="op" id="3253093">(</span><span class="op" id="3253094">)</span><span class="op" id="3253095">;</span>&nbsp;<span class="ident" id="3253097">err</span>&nbsp;<span class="op" id="3253101">!=</span>&nbsp;<span class="builtintype" id="3253104">nil</span>&nbsp;<span class="op" id="3253108">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3253112">return</span>&nbsp;<span class="num" id="3253119">0</span><span class="op" id="3253120">,</span>&nbsp;<span class="num" id="3253122">0</span><span class="op" id="3253123">,</span>&nbsp;<span class="ident" id="3253125">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3253130">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3253133">defer</span>&nbsp;<span class="ident" id="3253139">fd</span><span class="op" id="3253141">.</span><span class="ident" id="3253142">writeUnlock</span><span class="op" id="3253153">(</span><span class="op" id="3253154">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3253157">if</span>&nbsp;<span class="ident" id="3253160">err</span>&nbsp;<span class="op" id="3253164">:=</span>&nbsp;<span class="ident" id="3253167">fd</span><span class="op" id="3253169">.</span><span class="ident" id="3253170">pd</span><span class="op" id="3253172">.</span><span class="ident" id="3253173">PrepareWrite</span><span class="op" id="3253185">(</span><span class="op" id="3253186">)</span><span class="op" id="3253187">;</span>&nbsp;<span class="ident" id="3253189">err</span>&nbsp;<span class="op" id="3253193">!=</span>&nbsp;<span class="builtintype" id="3253196">nil</span>&nbsp;<span class="op" id="3253200">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3253204">return</span>&nbsp;<span class="num" id="3253211">0</span><span class="op" id="3253212">,</span>&nbsp;<span class="num" id="3253214">0</span><span class="op" id="3253215">,</span>&nbsp;<span class="op" id="3253217">&amp;</span><span class="ident" id="3253218">OpError</span><span class="op" id="3253225">{</span><span class="string" id="3253226">&#34;write&#34;</span><span class="op" id="3253233">,</span>&nbsp;<span class="ident" id="3253235">fd</span><span class="op" id="3253237">.</span><span class="ident" id="3253238">net</span><span class="op" id="3253241">,</span>&nbsp;<span class="ident" id="3253243">fd</span><span class="op" id="3253245">.</span><span class="ident" id="3253246">raddr</span><span class="op" id="3253251">,</span>&nbsp;<span class="ident" id="3253253">err</span><span class="op" id="3253256">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3253259">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3253262">for</span>&nbsp;<span class="op" id="3253266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3253270">n</span><span class="op" id="3253271">,</span>&nbsp;<span class="ident" id="3253273">err</span>&nbsp;<span class="op" id="3253277">=</span>&nbsp;<span class="ident" id="3253279">syscall</span><span class="op" id="3253286">.</span><span class="ident" id="3253287">SendmsgN</span><span class="op" id="3253295">(</span><span class="ident" id="3253296">fd</span><span class="op" id="3253298">.</span><span class="ident" id="3253299">sysfd</span><span class="op" id="3253304">,</span>&nbsp;<span class="ident" id="3253306">p</span><span class="op" id="3253307">,</span>&nbsp;<span class="ident" id="3253309">oob</span><span class="op" id="3253312">,</span>&nbsp;<span class="ident" id="3253314">sa</span><span class="op" id="3253316">,</span>&nbsp;<span class="num" id="3253318">0</span><span class="op" id="3253319">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3253323">if</span>&nbsp;<span class="ident" id="3253326">err</span>&nbsp;<span class="op" id="3253330">==</span>&nbsp;<span class="ident" id="3253333">syscall</span><span class="op" id="3253340">.</span><span class="ident" id="3253341">EAGAIN</span>&nbsp;<span class="op" id="3253348">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3253353">if</span>&nbsp;<span class="ident" id="3253356">err</span>&nbsp;<span class="op" id="3253360">=</span>&nbsp;<span class="ident" id="3253362">fd</span><span class="op" id="3253364">.</span><span class="ident" id="3253365">pd</span><span class="op" id="3253367">.</span><span class="ident" id="3253368">WaitWrite</span><span class="op" id="3253377">(</span><span class="op" id="3253378">)</span><span class="op" id="3253379">;</span>&nbsp;<span class="ident" id="3253381">err</span>&nbsp;<span class="op" id="3253385">==</span>&nbsp;<span class="builtintype" id="3253388">nil</span>&nbsp;<span class="op" id="3253392">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3253398">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3253410">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3253414">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3253418">break</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3253425">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3253428">if</span>&nbsp;<span class="ident" id="3253431">err</span>&nbsp;<span class="op" id="3253435">==</span>&nbsp;<span class="builtintype" id="3253438">nil</span>&nbsp;<span class="op" id="3253442">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3253446">oobn</span>&nbsp;<span class="op" id="3253451">=</span>&nbsp;<span class="builtinfunc" id="3253453">len</span><span class="op" id="3253456">(</span><span class="ident" id="3253457">oob</span><span class="op" id="3253460">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3253463">}</span>&nbsp;<span class="keyword" id="3253465">else</span>&nbsp;<span class="op" id="3253470">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3253474">err</span>&nbsp;<span class="op" id="3253478">=</span>&nbsp;<span class="op" id="3253480">&amp;</span><span class="ident" id="3253481">OpError</span><span class="op" id="3253488">{</span><span class="string" id="3253489">&#34;write&#34;</span><span class="op" id="3253496">,</span>&nbsp;<span class="ident" id="3253498">fd</span><span class="op" id="3253500">.</span><span class="ident" id="3253501">net</span><span class="op" id="3253504">,</span>&nbsp;<span class="ident" id="3253506">fd</span><span class="op" id="3253508">.</span><span class="ident" id="3253509">raddr</span><span class="op" id="3253514">,</span>&nbsp;<span class="ident" id="3253516">err</span><span class="op" id="3253519">}</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3253522">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3253525">return</span><br>
<span class="lineno"></span><span class="op" id="3253532">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3253535">func</span>&nbsp;<span class="op" id="3253540">(</span><span class="ident" id="3253541">fd</span>&nbsp;<span class="op" id="3253544">*</span><span class="ident" id="3253545">netFD</span><span class="op" id="3253550">)</span>&nbsp;<span class="ident" id="3253552">accept</span><span class="op" id="3253558">(</span><span class="op" id="3253559">)</span>&nbsp;<span class="op" id="3253561">(</span><span class="ident" id="3253562">netfd</span>&nbsp;<span class="op" id="3253568">*</span><span class="ident" id="3253569">netFD</span><span class="op" id="3253574">,</span>&nbsp;<span class="ident" id="3253576">err</span>&nbsp;<span class="builtintype" id="3253580">error</span><span class="op" id="3253585">)</span>&nbsp;<span class="op" id="3253587">{</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3253590">if</span>&nbsp;<span class="ident" id="3253593">err</span>&nbsp;<span class="op" id="3253597">:=</span>&nbsp;<span class="ident" id="3253600">fd</span><span class="op" id="3253602">.</span><span class="ident" id="3253603">readLock</span><span class="op" id="3253611">(</span><span class="op" id="3253612">)</span><span class="op" id="3253613">;</span>&nbsp;<span class="ident" id="3253615">err</span>&nbsp;<span class="op" id="3253619">!=</span>&nbsp;<span class="builtintype" id="3253622">nil</span>&nbsp;<span class="op" id="3253626">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3253630">return</span>&nbsp;<span class="builtintype" id="3253637">nil</span><span class="op" id="3253640">,</span>&nbsp;<span class="ident" id="3253642">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3253647">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3253650">defer</span>&nbsp;<span class="ident" id="3253656">fd</span><span class="op" id="3253658">.</span><span class="ident" id="3253659">readUnlock</span><span class="op" id="3253669">(</span><span class="op" id="3253670">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3253674">var</span>&nbsp;<span class="ident" id="3253678">s</span>&nbsp;<span class="builtintype" id="3253680">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3253685">var</span>&nbsp;<span class="ident" id="3253689">rsa</span>&nbsp;<span class="ident" id="3253693">syscall</span><span class="op" id="3253700">.</span><span class="ident" id="3253701">Sockaddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3253711">if</span>&nbsp;<span class="ident" id="3253714">err</span>&nbsp;<span class="op" id="3253718">=</span>&nbsp;<span class="ident" id="3253720">fd</span><span class="op" id="3253722">.</span><span class="ident" id="3253723">pd</span><span class="op" id="3253725">.</span><span class="ident" id="3253726">PrepareRead</span><span class="op" id="3253737">(</span><span class="op" id="3253738">)</span><span class="op" id="3253739">;</span>&nbsp;<span class="ident" id="3253741">err</span>&nbsp;<span class="op" id="3253745">!=</span>&nbsp;<span class="builtintype" id="3253748">nil</span>&nbsp;<span class="op" id="3253752">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3253756">return</span>&nbsp;<span class="builtintype" id="3253763">nil</span><span class="op" id="3253766">,</span>&nbsp;<span class="op" id="3253768">&amp;</span><span class="ident" id="3253769">OpError</span><span class="op" id="3253776">{</span><span class="string" id="3253777">&#34;accept&#34;</span><span class="op" id="3253785">,</span>&nbsp;<span class="ident" id="3253787">fd</span><span class="op" id="3253789">.</span><span class="ident" id="3253790">net</span><span class="op" id="3253793">,</span>&nbsp;<span class="ident" id="3253795">fd</span><span class="op" id="3253797">.</span><span class="ident" id="3253798">laddr</span><span class="op" id="3253803">,</span>&nbsp;<span class="ident" id="3253805">err</span><span class="op" id="3253808">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3253811">}</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3253814">for</span>&nbsp;<span class="op" id="3253818">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3253822">s</span><span class="op" id="3253823">,</span>&nbsp;<span class="ident" id="3253825">rsa</span><span class="op" id="3253828">,</span>&nbsp;<span class="ident" id="3253830">err</span>&nbsp;<span class="op" id="3253834">=</span>&nbsp;<span class="ident" id="3253836">accept</span><span class="op" id="3253842">(</span><span class="ident" id="3253843">fd</span><span class="op" id="3253845">.</span><span class="ident" id="3253846">sysfd</span><span class="op" id="3253851">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3253855">if</span>&nbsp;<span class="ident" id="3253858">err</span>&nbsp;<span class="op" id="3253862">!=</span>&nbsp;<span class="builtintype" id="3253865">nil</span>&nbsp;<span class="op" id="3253869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3253874">if</span>&nbsp;<span class="ident" id="3253877">err</span>&nbsp;<span class="op" id="3253881">==</span>&nbsp;<span class="ident" id="3253884">syscall</span><span class="op" id="3253891">.</span><span class="ident" id="3253892">EAGAIN</span>&nbsp;<span class="op" id="3253899">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3253905">if</span>&nbsp;<span class="ident" id="3253908">err</span>&nbsp;<span class="op" id="3253912">=</span>&nbsp;<span class="ident" id="3253914">fd</span><span class="op" id="3253916">.</span><span class="ident" id="3253917">pd</span><span class="op" id="3253919">.</span><span class="ident" id="3253920">WaitRead</span><span class="op" id="3253928">(</span><span class="op" id="3253929">)</span><span class="op" id="3253930">;</span>&nbsp;<span class="ident" id="3253932">err</span>&nbsp;<span class="op" id="3253936">==</span>&nbsp;<span class="builtintype" id="3253939">nil</span>&nbsp;<span class="op" id="3253943">{</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3253950">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3253963">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3253968">}</span>&nbsp;<span class="keyword" id="3253970">else</span>&nbsp;<span class="keyword" id="3253975">if</span>&nbsp;<span class="ident" id="3253978">err</span>&nbsp;<span class="op" id="3253982">==</span>&nbsp;<span class="ident" id="3253985">syscall</span><span class="op" id="3253992">.</span><span class="ident" id="3253993">ECONNABORTED</span>&nbsp;<span class="op" id="3254006">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3254012">//&nbsp;This&nbsp;means&nbsp;that&nbsp;a&nbsp;socket&nbsp;on&nbsp;the&nbsp;listen&nbsp;queue&nbsp;was&nbsp;closed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3254075">//&nbsp;before&nbsp;we&nbsp;Accept()ed&nbsp;it;&nbsp;it&#39;s&nbsp;a&nbsp;silly&nbsp;error,&nbsp;so&nbsp;try&nbsp;again.</span><br>
<span class="lineno">425</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3254141">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3254153">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3254158">return</span>&nbsp;<span class="builtintype" id="3254165">nil</span><span class="op" id="3254168">,</span>&nbsp;<span class="op" id="3254170">&amp;</span><span class="ident" id="3254171">OpError</span><span class="op" id="3254178">{</span><span class="string" id="3254179">&#34;accept&#34;</span><span class="op" id="3254187">,</span>&nbsp;<span class="ident" id="3254189">fd</span><span class="op" id="3254191">.</span><span class="ident" id="3254192">net</span><span class="op" id="3254195">,</span>&nbsp;<span class="ident" id="3254197">fd</span><span class="op" id="3254199">.</span><span class="ident" id="3254200">laddr</span><span class="op" id="3254205">,</span>&nbsp;<span class="ident" id="3254207">err</span><span class="op" id="3254210">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3254214">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3254218">break</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3254225">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3254229">if</span>&nbsp;<span class="ident" id="3254232">netfd</span><span class="op" id="3254237">,</span>&nbsp;<span class="ident" id="3254239">err</span>&nbsp;<span class="op" id="3254243">=</span>&nbsp;<span class="ident" id="3254245">newFD</span><span class="op" id="3254250">(</span><span class="ident" id="3254251">s</span><span class="op" id="3254252">,</span>&nbsp;<span class="ident" id="3254254">fd</span><span class="op" id="3254256">.</span><span class="ident" id="3254257">family</span><span class="op" id="3254263">,</span>&nbsp;<span class="ident" id="3254265">fd</span><span class="op" id="3254267">.</span><span class="ident" id="3254268">sotype</span><span class="op" id="3254274">,</span>&nbsp;<span class="ident" id="3254276">fd</span><span class="op" id="3254278">.</span><span class="ident" id="3254279">net</span><span class="op" id="3254282">)</span><span class="op" id="3254283">;</span>&nbsp;<span class="ident" id="3254285">err</span>&nbsp;<span class="op" id="3254289">!=</span>&nbsp;<span class="builtintype" id="3254292">nil</span>&nbsp;<span class="op" id="3254296">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3254300">closesocket</span><span class="op" id="3254311">(</span><span class="ident" id="3254312">s</span><span class="op" id="3254313">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3254317">return</span>&nbsp;<span class="builtintype" id="3254324">nil</span><span class="op" id="3254327">,</span>&nbsp;<span class="ident" id="3254329">err</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3254334">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3254337">if</span>&nbsp;<span class="ident" id="3254340">err</span>&nbsp;<span class="op" id="3254344">=</span>&nbsp;<span class="ident" id="3254346">netfd</span><span class="op" id="3254351">.</span><span class="ident" id="3254352">init</span><span class="op" id="3254356">(</span><span class="op" id="3254357">)</span><span class="op" id="3254358">;</span>&nbsp;<span class="ident" id="3254360">err</span>&nbsp;<span class="op" id="3254364">!=</span>&nbsp;<span class="builtintype" id="3254367">nil</span>&nbsp;<span class="op" id="3254371">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3254375">fd</span><span class="op" id="3254377">.</span><span class="ident" id="3254378">Close</span><span class="op" id="3254383">(</span><span class="op" id="3254384">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3254388">return</span>&nbsp;<span class="builtintype" id="3254395">nil</span><span class="op" id="3254398">,</span>&nbsp;<span class="ident" id="3254400">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3254405">}</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3254408">lsa</span><span class="op" id="3254411">,</span>&nbsp;<span class="ident" id="3254413">_</span>&nbsp;<span class="op" id="3254415">:=</span>&nbsp;<span class="ident" id="3254418">syscall</span><span class="op" id="3254425">.</span><span class="ident" id="3254426">Getsockname</span><span class="op" id="3254437">(</span><span class="ident" id="3254438">netfd</span><span class="op" id="3254443">.</span><span class="ident" id="3254444">sysfd</span><span class="op" id="3254449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3254452">netfd</span><span class="op" id="3254457">.</span><span class="ident" id="3254458">setAddr</span><span class="op" id="3254465">(</span><span class="ident" id="3254466">netfd</span><span class="op" id="3254471">.</span><span class="ident" id="3254472">addrFunc</span><span class="op" id="3254480">(</span><span class="op" id="3254481">)</span><span class="op" id="3254482">(</span><span class="ident" id="3254483">lsa</span><span class="op" id="3254486">)</span><span class="op" id="3254487">,</span>&nbsp;<span class="ident" id="3254489">netfd</span><span class="op" id="3254494">.</span><span class="ident" id="3254495">addrFunc</span><span class="op" id="3254503">(</span><span class="op" id="3254504">)</span><span class="op" id="3254505">(</span><span class="ident" id="3254506">rsa</span><span class="op" id="3254509">)</span><span class="op" id="3254510">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3254513">return</span>&nbsp;<span class="ident" id="3254520">netfd</span><span class="op" id="3254525">,</span>&nbsp;<span class="builtintype" id="3254527">nil</span><br>
<span class="lineno"></span><span class="op" id="3254531">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">445</span><span class="comment" id="3254534">//&nbsp;tryDupCloexec&nbsp;indicates&nbsp;whether&nbsp;F_DUPFD_CLOEXEC&nbsp;should&nbsp;be&nbsp;used.</span><br>
<span class="lineno"></span><span class="comment" id="3254601">//&nbsp;If&nbsp;the&nbsp;kernel&nbsp;doesn&#39;t&nbsp;support&nbsp;it,&nbsp;this&nbsp;is&nbsp;set&nbsp;to&nbsp;0.</span><br>
<span class="lineno"></span><span class="keyword" id="3254656">var</span>&nbsp;<span class="ident" id="3254660">tryDupCloexec</span>&nbsp;<span class="op" id="3254674">=</span>&nbsp;<span class="builtintype" id="3254676">int32</span><span class="op" id="3254681">(</span><span class="num" id="3254682">1</span><span class="op" id="3254683">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3254686">func</span>&nbsp;<span class="ident" id="3254691">dupCloseOnExec</span><span class="op" id="3254705">(</span><span class="ident" id="3254706">fd</span>&nbsp;<span class="builtintype" id="3254709">int</span><span class="op" id="3254712">)</span>&nbsp;<span class="op" id="3254714">(</span><span class="ident" id="3254715">newfd</span>&nbsp;<span class="builtintype" id="3254721">int</span><span class="op" id="3254724">,</span>&nbsp;<span class="ident" id="3254726">err</span>&nbsp;<span class="builtintype" id="3254730">error</span><span class="op" id="3254735">)</span>&nbsp;<span class="op" id="3254737">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3254740">if</span>&nbsp;<span class="ident" id="3254743">atomic</span><span class="op" id="3254749">.</span><span class="ident" id="3254750">LoadInt32</span><span class="op" id="3254759">(</span><span class="op" id="3254760">&amp;</span><span class="ident" id="3254761">tryDupCloexec</span><span class="op" id="3254774">)</span>&nbsp;<span class="op" id="3254776">==</span>&nbsp;<span class="num" id="3254779">1</span>&nbsp;<span class="op" id="3254781">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3254785">r0</span><span class="op" id="3254787">,</span>&nbsp;<span class="ident" id="3254789">_</span><span class="op" id="3254790">,</span>&nbsp;<span class="ident" id="3254792">e1</span>&nbsp;<span class="op" id="3254795">:=</span>&nbsp;<span class="ident" id="3254798">syscall</span><span class="op" id="3254805">.</span><span class="ident" id="3254806">Syscall</span><span class="op" id="3254813">(</span><span class="ident" id="3254814">syscall</span><span class="op" id="3254821">.</span><span class="ident" id="3254822">SYS_FCNTL</span><span class="op" id="3254831">,</span>&nbsp;<span class="builtintype" id="3254833">uintptr</span><span class="op" id="3254840">(</span><span class="ident" id="3254841">fd</span><span class="op" id="3254843">)</span><span class="op" id="3254844">,</span>&nbsp;<span class="ident" id="3254846">syscall</span><span class="op" id="3254853">.</span><span class="ident" id="3254854">F_DUPFD_CLOEXEC</span><span class="op" id="3254869">,</span>&nbsp;<span class="num" id="3254871">0</span><span class="op" id="3254872">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3254876">if</span>&nbsp;<span class="ident" id="3254879">runtime</span><span class="op" id="3254886">.</span><span class="ident" id="3254887">GOOS</span>&nbsp;<span class="op" id="3254892">==</span>&nbsp;<span class="string" id="3254895">&#34;darwin&#34;</span>&nbsp;<span class="op" id="3254904">&amp;&amp;</span>&nbsp;<span class="ident" id="3254907">e1</span>&nbsp;<span class="op" id="3254910">==</span>&nbsp;<span class="ident" id="3254913">syscall</span><span class="op" id="3254920">.</span><span class="ident" id="3254921">EBADF</span>&nbsp;<span class="op" id="3254927">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3254932">//&nbsp;On&nbsp;OS&nbsp;X&nbsp;10.6&nbsp;and&nbsp;below&nbsp;(but&nbsp;we&nbsp;only&nbsp;support</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3254982">//&nbsp;&gt;=&nbsp;10.6),&nbsp;F_DUPFD_CLOEXEC&nbsp;is&nbsp;unsupported</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3255029">//&nbsp;and&nbsp;fcntl&nbsp;there&nbsp;falls&nbsp;back&nbsp;(undocumented)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3255077">//&nbsp;to&nbsp;doing&nbsp;an&nbsp;ioctl&nbsp;instead,&nbsp;returning&nbsp;EBADF</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3255126">//&nbsp;in&nbsp;this&nbsp;case&nbsp;because&nbsp;fd&nbsp;is&nbsp;not&nbsp;of&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3255170">//&nbsp;expected&nbsp;device&nbsp;fd&nbsp;type.&nbsp;&nbsp;Treat&nbsp;it&nbsp;as</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3255214">//&nbsp;EINVAL&nbsp;instead,&nbsp;so&nbsp;we&nbsp;fall&nbsp;back&nbsp;to&nbsp;the</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3255259">//&nbsp;normal&nbsp;dup&nbsp;path.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3255282">//&nbsp;TODO:&nbsp;only&nbsp;do&nbsp;this&nbsp;on&nbsp;10.6&nbsp;if&nbsp;we&nbsp;can&nbsp;detect&nbsp;10.6</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3255337">//&nbsp;cheaply.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3255352">e1</span>&nbsp;<span class="op" id="3255355">=</span>&nbsp;<span class="ident" id="3255357">syscall</span><span class="op" id="3255364">.</span><span class="ident" id="3255365">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3255374">}</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3255378">switch</span>&nbsp;<span class="ident" id="3255385">e1</span>&nbsp;<span class="op" id="3255388">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3255392">case</span>&nbsp;<span class="num" id="3255397">0</span><span class="op" id="3255398">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3255403">return</span>&nbsp;<span class="builtintype" id="3255410">int</span><span class="op" id="3255413">(</span><span class="ident" id="3255414">r0</span><span class="op" id="3255416">)</span><span class="op" id="3255417">,</span>&nbsp;<span class="builtintype" id="3255419">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3255425">case</span>&nbsp;<span class="ident" id="3255430">syscall</span><span class="op" id="3255437">.</span><span class="ident" id="3255438">EINVAL</span><span class="op" id="3255444">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3255449">//&nbsp;Old&nbsp;kernel.&nbsp;Fall&nbsp;back&nbsp;to&nbsp;the&nbsp;portable&nbsp;way</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3255497">//&nbsp;from&nbsp;now&nbsp;on.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3255516">atomic</span><span class="op" id="3255522">.</span><span class="ident" id="3255523">StoreInt32</span><span class="op" id="3255533">(</span><span class="op" id="3255534">&amp;</span><span class="ident" id="3255535">tryDupCloexec</span><span class="op" id="3255548">,</span>&nbsp;<span class="num" id="3255550">0</span><span class="op" id="3255551">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3255555">default</span><span class="op" id="3255562">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3255567">return</span>&nbsp;<span class="op" id="3255574">-</span><span class="num" id="3255575">1</span><span class="op" id="3255576">,</span>&nbsp;<span class="ident" id="3255578">e1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3255583">}</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3255586">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3255589">return</span>&nbsp;<span class="ident" id="3255596">dupCloseOnExecOld</span><span class="op" id="3255613">(</span><span class="ident" id="3255614">fd</span><span class="op" id="3255616">)</span><br>
<span class="lineno"></span><span class="op" id="3255618">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3255621">//&nbsp;dupCloseOnExecUnixOld&nbsp;is&nbsp;the&nbsp;traditional&nbsp;way&nbsp;to&nbsp;dup&nbsp;an&nbsp;fd&nbsp;and</span><br>
<span class="lineno">480</span><span class="comment" id="3255686">//&nbsp;set&nbsp;its&nbsp;O_CLOEXEC&nbsp;bit,&nbsp;using&nbsp;two&nbsp;system&nbsp;calls.</span><br>
<span class="lineno"></span><span class="keyword" id="3255736">func</span>&nbsp;<span class="ident" id="3255741">dupCloseOnExecOld</span><span class="op" id="3255758">(</span><span class="ident" id="3255759">fd</span>&nbsp;<span class="builtintype" id="3255762">int</span><span class="op" id="3255765">)</span>&nbsp;<span class="op" id="3255767">(</span><span class="ident" id="3255768">newfd</span>&nbsp;<span class="builtintype" id="3255774">int</span><span class="op" id="3255777">,</span>&nbsp;<span class="ident" id="3255779">err</span>&nbsp;<span class="builtintype" id="3255783">error</span><span class="op" id="3255788">)</span>&nbsp;<span class="op" id="3255790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3255793">syscall</span><span class="op" id="3255800">.</span><span class="ident" id="3255801">ForkLock</span><span class="op" id="3255809">.</span><span class="ident" id="3255810">RLock</span><span class="op" id="3255815">(</span><span class="op" id="3255816">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3255819">defer</span>&nbsp;<span class="ident" id="3255825">syscall</span><span class="op" id="3255832">.</span><span class="ident" id="3255833">ForkLock</span><span class="op" id="3255841">.</span><span class="ident" id="3255842">RUnlock</span><span class="op" id="3255849">(</span><span class="op" id="3255850">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3255853">newfd</span><span class="op" id="3255858">,</span>&nbsp;<span class="ident" id="3255860">err</span>&nbsp;<span class="op" id="3255864">=</span>&nbsp;<span class="ident" id="3255866">syscall</span><span class="op" id="3255873">.</span><span class="ident" id="3255874">Dup</span><span class="op" id="3255877">(</span><span class="ident" id="3255878">fd</span><span class="op" id="3255880">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3255883">if</span>&nbsp;<span class="ident" id="3255886">err</span>&nbsp;<span class="op" id="3255890">!=</span>&nbsp;<span class="builtintype" id="3255893">nil</span>&nbsp;<span class="op" id="3255897">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3255901">return</span>&nbsp;<span class="op" id="3255908">-</span><span class="num" id="3255909">1</span><span class="op" id="3255910">,</span>&nbsp;<span class="ident" id="3255912">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3255917">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3255920">syscall</span><span class="op" id="3255927">.</span><span class="ident" id="3255928">CloseOnExec</span><span class="op" id="3255939">(</span><span class="ident" id="3255940">newfd</span><span class="op" id="3255945">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3255948">return</span><br>
<span class="lineno">490</span><span class="op" id="3255955">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3255958">func</span>&nbsp;<span class="op" id="3255963">(</span><span class="ident" id="3255964">fd</span>&nbsp;<span class="op" id="3255967">*</span><span class="ident" id="3255968">netFD</span><span class="op" id="3255973">)</span>&nbsp;<span class="ident" id="3255975">dup</span><span class="op" id="3255978">(</span><span class="op" id="3255979">)</span>&nbsp;<span class="op" id="3255981">(</span><span class="ident" id="3255982">f</span>&nbsp;<span class="op" id="3255984">*</span><span class="ident" id="3255985">os</span><span class="op" id="3255987">.</span><span class="ident" id="3255988">File</span><span class="op" id="3255992">,</span>&nbsp;<span class="ident" id="3255994">err</span>&nbsp;<span class="builtintype" id="3255998">error</span><span class="op" id="3256003">)</span>&nbsp;<span class="op" id="3256005">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3256008">ns</span><span class="op" id="3256010">,</span>&nbsp;<span class="ident" id="3256012">err</span>&nbsp;<span class="op" id="3256016">:=</span>&nbsp;<span class="ident" id="3256019">dupCloseOnExec</span><span class="op" id="3256033">(</span><span class="ident" id="3256034">fd</span><span class="op" id="3256036">.</span><span class="ident" id="3256037">sysfd</span><span class="op" id="3256042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3256045">if</span>&nbsp;<span class="ident" id="3256048">err</span>&nbsp;<span class="op" id="3256052">!=</span>&nbsp;<span class="builtintype" id="3256055">nil</span>&nbsp;<span class="op" id="3256059">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3256063">return</span>&nbsp;<span class="builtintype" id="3256070">nil</span><span class="op" id="3256073">,</span>&nbsp;<span class="op" id="3256075">&amp;</span><span class="ident" id="3256076">OpError</span><span class="op" id="3256083">{</span><span class="string" id="3256084">&#34;dup&#34;</span><span class="op" id="3256089">,</span>&nbsp;<span class="ident" id="3256091">fd</span><span class="op" id="3256093">.</span><span class="ident" id="3256094">net</span><span class="op" id="3256097">,</span>&nbsp;<span class="ident" id="3256099">fd</span><span class="op" id="3256101">.</span><span class="ident" id="3256102">laddr</span><span class="op" id="3256107">,</span>&nbsp;<span class="ident" id="3256109">err</span><span class="op" id="3256112">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3256115">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3256119">//&nbsp;We&nbsp;want&nbsp;blocking&nbsp;mode&nbsp;for&nbsp;the&nbsp;new&nbsp;fd,&nbsp;hence&nbsp;the&nbsp;double&nbsp;negative.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3256188">//&nbsp;This&nbsp;also&nbsp;puts&nbsp;the&nbsp;old&nbsp;fd&nbsp;into&nbsp;blocking&nbsp;mode,&nbsp;meaning&nbsp;that</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3256251">//&nbsp;I/O&nbsp;will&nbsp;block&nbsp;the&nbsp;thread&nbsp;instead&nbsp;of&nbsp;letting&nbsp;us&nbsp;use&nbsp;the&nbsp;epoll&nbsp;server.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3256325">//&nbsp;Everything&nbsp;will&nbsp;still&nbsp;work,&nbsp;just&nbsp;with&nbsp;more&nbsp;threads.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3256381">if</span>&nbsp;<span class="ident" id="3256384">err</span>&nbsp;<span class="op" id="3256388">=</span>&nbsp;<span class="ident" id="3256390">syscall</span><span class="op" id="3256397">.</span><span class="ident" id="3256398">SetNonblock</span><span class="op" id="3256409">(</span><span class="ident" id="3256410">ns</span><span class="op" id="3256412">,</span>&nbsp;<span class="builtintype" id="3256414">false</span><span class="op" id="3256419">)</span><span class="op" id="3256420">;</span>&nbsp;<span class="ident" id="3256422">err</span>&nbsp;<span class="op" id="3256426">!=</span>&nbsp;<span class="builtintype" id="3256429">nil</span>&nbsp;<span class="op" id="3256433">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3256437">return</span>&nbsp;<span class="builtintype" id="3256444">nil</span><span class="op" id="3256447">,</span>&nbsp;<span class="op" id="3256449">&amp;</span><span class="ident" id="3256450">OpError</span><span class="op" id="3256457">{</span><span class="string" id="3256458">&#34;setnonblock&#34;</span><span class="op" id="3256471">,</span>&nbsp;<span class="ident" id="3256473">fd</span><span class="op" id="3256475">.</span><span class="ident" id="3256476">net</span><span class="op" id="3256479">,</span>&nbsp;<span class="ident" id="3256481">fd</span><span class="op" id="3256483">.</span><span class="ident" id="3256484">laddr</span><span class="op" id="3256489">,</span>&nbsp;<span class="ident" id="3256491">err</span><span class="op" id="3256494">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3256497">}</span><br>
<span class="lineno">505</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3256501">return</span>&nbsp;<span class="ident" id="3256508">os</span><span class="op" id="3256510">.</span><span class="ident" id="3256511">NewFile</span><span class="op" id="3256518">(</span><span class="builtintype" id="3256519">uintptr</span><span class="op" id="3256526">(</span><span class="ident" id="3256527">ns</span><span class="op" id="3256529">)</span><span class="op" id="3256530">,</span>&nbsp;<span class="ident" id="3256532">fd</span><span class="op" id="3256534">.</span><span class="ident" id="3256535">name</span><span class="op" id="3256539">(</span><span class="op" id="3256540">)</span><span class="op" id="3256541">)</span><span class="op" id="3256542">,</span>&nbsp;<span class="builtintype" id="3256544">nil</span><br>
<span class="lineno"></span><span class="op" id="3256548">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3256551">func</span>&nbsp;<span class="ident" id="3256556">closesocket</span><span class="op" id="3256567">(</span><span class="ident" id="3256568">s</span>&nbsp;<span class="builtintype" id="3256570">int</span><span class="op" id="3256573">)</span>&nbsp;<span class="builtintype" id="3256575">error</span>&nbsp;<span class="op" id="3256581">{</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3256584">return</span>&nbsp;<span class="ident" id="3256591">syscall</span><span class="op" id="3256598">.</span><span class="ident" id="3256599">Close</span><span class="op" id="3256604">(</span><span class="ident" id="3256605">s</span><span class="op" id="3256606">)</span><br>
<span class="lineno"></span><span class="op" id="3256608">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3256611">func</span>&nbsp;<span class="ident" id="3256616">skipRawSocketTests</span><span class="op" id="3256634">(</span><span class="op" id="3256635">)</span>&nbsp;<span class="op" id="3256637">(</span><span class="ident" id="3256638">skip</span>&nbsp;<span class="builtintype" id="3256643">bool</span><span class="op" id="3256647">,</span>&nbsp;<span class="ident" id="3256649">skipmsg</span>&nbsp;<span class="builtintype" id="3256657">string</span><span class="op" id="3256663">,</span>&nbsp;<span class="ident" id="3256665">err</span>&nbsp;<span class="builtintype" id="3256669">error</span><span class="op" id="3256674">)</span>&nbsp;<span class="op" id="3256676">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3256679">if</span>&nbsp;<span class="ident" id="3256682">os</span><span class="op" id="3256684">.</span><span class="ident" id="3256685">Getuid</span><span class="op" id="3256691">(</span><span class="op" id="3256692">)</span>&nbsp;<span class="op" id="3256694">!=</span>&nbsp;<span class="num" id="3256697">0</span>&nbsp;<span class="op" id="3256699">{</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3256703">return</span>&nbsp;<span class="builtintype" id="3256710">true</span><span class="op" id="3256714">,</span>&nbsp;<span class="string" id="3256716">&#34;skipping&nbsp;test;&nbsp;must&nbsp;be&nbsp;root&#34;</span><span class="op" id="3256745">,</span>&nbsp;<span class="builtintype" id="3256747">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3256752">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3256755">return</span>&nbsp;<span class="builtintype" id="3256762">false</span><span class="op" id="3256767">,</span>&nbsp;<span class="string" id="3256769">&#34;&#34;</span><span class="op" id="3256771">,</span>&nbsp;<span class="builtintype" id="3256773">nil</span><br>
<span class="lineno"></span><span class="op" id="3256777">}</span>
</div>
</body>
</html>
