<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>crypto/cipher</h2>
<ul>
<li><a href="/gostd/crypto/cipher/benchmark_test.go.html">benchmark_test.go</a></li>
<li><a href="/gostd/crypto/cipher/cbc.go.html">cbc.go</a></li>
<li><a href="/gostd/crypto/cipher/cbc_aes_test.go.html">cbc_aes_test.go</a></li>
<li><a href="/gostd/crypto/cipher/cfb.go.html">cfb.go</a></li>
<li><a href="/gostd/crypto/cipher/cfb_test.go.html">cfb_test.go</a></li>
<li><a href="/gostd/crypto/cipher/cipher.go.html">cipher.go</a></li>
<li><a href="/gostd/crypto/cipher/cipher_test.go.html">cipher_test.go</a></li>
<li><a href="/gostd/crypto/cipher/common_test.go.html">common_test.go</a></li>
<li><a href="/gostd/crypto/cipher/ctr.go.html">ctr.go</a></li>
<li><a href="/gostd/crypto/cipher/ctr_aes_test.go.html">ctr_aes_test.go</a></li>
<li><a href="/gostd/crypto/cipher/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/crypto/cipher/gcm.go.html">gcm.go</a></li>
<li><a href="/gostd/crypto/cipher/gcm_test.go.html">gcm_test.go</a></li>
<li><a href="/gostd/crypto/cipher/io.go.html">io.go</a></li>
<li><a href="/gostd/crypto/cipher/ofb.go.html">ofb.go</a></li>
<li><a href="/gostd/crypto/cipher/ofb_test.go.html">ofb_test.go</a></li>
<li><a href="/gostd/crypto/cipher/xor.go.html">xor.go</a></li>
<li><a href="/gostd/crypto/cipher/xor_test.go.html">xor_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3809130">//&nbsp;Copyright&nbsp;2009&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3809185">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3809239">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3809290">//&nbsp;Cipher&nbsp;block&nbsp;chaining&nbsp;(CBC)&nbsp;mode.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3809328">//&nbsp;CBC&nbsp;provides&nbsp;confidentiality&nbsp;by&nbsp;xoring&nbsp;(chaining)&nbsp;each&nbsp;plaintext&nbsp;block</span><br>
<span class="lineno"></span><span class="comment" id="3809402">//&nbsp;with&nbsp;the&nbsp;previous&nbsp;ciphertext&nbsp;block&nbsp;before&nbsp;applying&nbsp;the&nbsp;block&nbsp;cipher.</span><br>
<span class="lineno"></span><br>
<span class="lineno">10</span><span class="comment" id="3809475">//&nbsp;See&nbsp;NIST&nbsp;SP&nbsp;800-38A,&nbsp;pp&nbsp;10-11</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3809509">package</span>&nbsp;<span class="ident" id="3809517">cipher</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3809525">type</span>&nbsp;<span class="ident" id="3809530">cbc</span>&nbsp;<span class="keyword" id="3809534">struct</span>&nbsp;<span class="op" id="3809541">{</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3809544">b</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3809554">Block</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3809561">blockSize</span>&nbsp;<span class="builtintype" id="3809571">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3809576">iv</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3809586">[</span><span class="op" id="3809587">]</span><span class="builtintype" id="3809588">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3809594">tmp</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3809604">[</span><span class="op" id="3809605">]</span><span class="builtintype" id="3809606">byte</span><br>
<span class="lineno"></span><span class="op" id="3809611">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="3809614">func</span>&nbsp;<span class="ident" id="3809619">newCBC</span><span class="op" id="3809625">(</span><span class="ident" id="3809626">b</span>&nbsp;<span class="ident" id="3809628">Block</span><span class="op" id="3809633">,</span>&nbsp;<span class="ident" id="3809635">iv</span>&nbsp;<span class="op" id="3809638">[</span><span class="op" id="3809639">]</span><span class="builtintype" id="3809640">byte</span><span class="op" id="3809644">)</span>&nbsp;<span class="op" id="3809646">*</span><span class="ident" id="3809647">cbc</span>&nbsp;<span class="op" id="3809651">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3809654">return</span>&nbsp;<span class="op" id="3809661">&amp;</span><span class="ident" id="3809662">cbc</span><span class="op" id="3809665">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3809669">b</span><span class="op" id="3809670">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3809680">b</span><span class="op" id="3809681">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3809685">blockSize</span><span class="op" id="3809694">:</span>&nbsp;<span class="ident" id="3809696">b</span><span class="op" id="3809697">.</span><span class="ident" id="3809698">BlockSize</span><span class="op" id="3809707">(</span><span class="op" id="3809708">)</span><span class="op" id="3809709">,</span><br>
<span class="lineno">25</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3809713">iv</span><span class="op" id="3809715">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3809724">dup</span><span class="op" id="3809727">(</span><span class="ident" id="3809728">iv</span><span class="op" id="3809730">)</span><span class="op" id="3809731">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3809735">tmp</span><span class="op" id="3809738">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtinfunc" id="3809746">make</span><span class="op" id="3809750">(</span><span class="op" id="3809751">[</span><span class="op" id="3809752">]</span><span class="builtintype" id="3809753">byte</span><span class="op" id="3809757">,</span>&nbsp;<span class="ident" id="3809759">b</span><span class="op" id="3809760">.</span><span class="ident" id="3809761">BlockSize</span><span class="op" id="3809770">(</span><span class="op" id="3809771">)</span><span class="op" id="3809772">)</span><span class="op" id="3809773">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3809776">}</span><br>
<span class="lineno"></span><span class="op" id="3809778">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span><span class="keyword" id="3809781">type</span>&nbsp;<span class="ident" id="3809786">cbcEncrypter</span>&nbsp;<span class="ident" id="3809799">cbc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3809804">//&nbsp;NewCBCEncrypter&nbsp;returns&nbsp;a&nbsp;BlockMode&nbsp;which&nbsp;encrypts&nbsp;in&nbsp;cipher&nbsp;block&nbsp;chaining</span><br>
<span class="lineno"></span><span class="comment" id="3809883">//&nbsp;mode,&nbsp;using&nbsp;the&nbsp;given&nbsp;Block.&nbsp;The&nbsp;length&nbsp;of&nbsp;iv&nbsp;must&nbsp;be&nbsp;the&nbsp;same&nbsp;as&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3809956">//&nbsp;Block&#39;s&nbsp;block&nbsp;size.</span><br>
<span class="lineno">35</span><span class="keyword" id="3809979">func</span>&nbsp;<span class="ident" id="3809984">NewCBCEncrypter</span><span class="op" id="3809999">(</span><span class="ident" id="3810000">b</span>&nbsp;<span class="ident" id="3810002">Block</span><span class="op" id="3810007">,</span>&nbsp;<span class="ident" id="3810009">iv</span>&nbsp;<span class="op" id="3810012">[</span><span class="op" id="3810013">]</span><span class="builtintype" id="3810014">byte</span><span class="op" id="3810018">)</span>&nbsp;<span class="ident" id="3810020">BlockMode</span>&nbsp;<span class="op" id="3810030">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3810033">if</span>&nbsp;<span class="builtinfunc" id="3810036">len</span><span class="op" id="3810039">(</span><span class="ident" id="3810040">iv</span><span class="op" id="3810042">)</span>&nbsp;<span class="op" id="3810044">!=</span>&nbsp;<span class="ident" id="3810047">b</span><span class="op" id="3810048">.</span><span class="ident" id="3810049">BlockSize</span><span class="op" id="3810058">(</span><span class="op" id="3810059">)</span>&nbsp;<span class="op" id="3810061">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3810065">panic</span><span class="op" id="3810070">(</span><span class="string" id="3810071">&#34;cipher.NewCBCEncrypter:&nbsp;IV&nbsp;length&nbsp;must&nbsp;equal&nbsp;block&nbsp;size&#34;</span><span class="op" id="3810128">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3810131">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3810134">return</span>&nbsp;<span class="op" id="3810141">(</span><span class="op" id="3810142">*</span><span class="ident" id="3810143">cbcEncrypter</span><span class="op" id="3810155">)</span><span class="op" id="3810156">(</span><span class="ident" id="3810157">newCBC</span><span class="op" id="3810163">(</span><span class="ident" id="3810164">b</span><span class="op" id="3810165">,</span>&nbsp;<span class="ident" id="3810167">iv</span><span class="op" id="3810169">)</span><span class="op" id="3810170">)</span><br>
<span class="lineno">40</span><span class="op" id="3810172">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3810175">func</span>&nbsp;<span class="op" id="3810180">(</span><span class="ident" id="3810181">x</span>&nbsp;<span class="op" id="3810183">*</span><span class="ident" id="3810184">cbcEncrypter</span><span class="op" id="3810196">)</span>&nbsp;<span class="ident" id="3810198">BlockSize</span><span class="op" id="3810207">(</span><span class="op" id="3810208">)</span>&nbsp;<span class="builtintype" id="3810210">int</span>&nbsp;<span class="op" id="3810214">{</span>&nbsp;<span class="keyword" id="3810216">return</span>&nbsp;<span class="ident" id="3810223">x</span><span class="op" id="3810224">.</span><span class="ident" id="3810225">blockSize</span>&nbsp;<span class="op" id="3810235">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3810238">func</span>&nbsp;<span class="op" id="3810243">(</span><span class="ident" id="3810244">x</span>&nbsp;<span class="op" id="3810246">*</span><span class="ident" id="3810247">cbcEncrypter</span><span class="op" id="3810259">)</span>&nbsp;<span class="ident" id="3810261">CryptBlocks</span><span class="op" id="3810272">(</span><span class="ident" id="3810273">dst</span><span class="op" id="3810276">,</span>&nbsp;<span class="ident" id="3810278">src</span>&nbsp;<span class="op" id="3810282">[</span><span class="op" id="3810283">]</span><span class="builtintype" id="3810284">byte</span><span class="op" id="3810288">)</span>&nbsp;<span class="op" id="3810290">{</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3810293">if</span>&nbsp;<span class="builtinfunc" id="3810296">len</span><span class="op" id="3810299">(</span><span class="ident" id="3810300">src</span><span class="op" id="3810303">)</span><span class="op" id="3810304">%</span><span class="ident" id="3810305">x</span><span class="op" id="3810306">.</span><span class="ident" id="3810307">blockSize</span>&nbsp;<span class="op" id="3810317">!=</span>&nbsp;<span class="num" id="3810320">0</span>&nbsp;<span class="op" id="3810322">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3810326">panic</span><span class="op" id="3810331">(</span><span class="string" id="3810332">&#34;crypto/cipher:&nbsp;input&nbsp;not&nbsp;full&nbsp;blocks&#34;</span><span class="op" id="3810370">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3810373">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3810376">if</span>&nbsp;<span class="builtinfunc" id="3810379">len</span><span class="op" id="3810382">(</span><span class="ident" id="3810383">dst</span><span class="op" id="3810386">)</span>&nbsp;<span class="op" id="3810388">&lt;</span>&nbsp;<span class="builtinfunc" id="3810390">len</span><span class="op" id="3810393">(</span><span class="ident" id="3810394">src</span><span class="op" id="3810397">)</span>&nbsp;<span class="op" id="3810399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3810403">panic</span><span class="op" id="3810408">(</span><span class="string" id="3810409">&#34;crypto/cipher:&nbsp;output&nbsp;smaller&nbsp;than&nbsp;input&#34;</span><span class="op" id="3810451">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3810454">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3810458">iv</span>&nbsp;<span class="op" id="3810461">:=</span>&nbsp;<span class="ident" id="3810464">x</span><span class="op" id="3810465">.</span><span class="ident" id="3810466">iv</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3810471">for</span>&nbsp;<span class="builtinfunc" id="3810475">len</span><span class="op" id="3810478">(</span><span class="ident" id="3810479">src</span><span class="op" id="3810482">)</span>&nbsp;<span class="op" id="3810484">&gt;</span>&nbsp;<span class="num" id="3810486">0</span>&nbsp;<span class="op" id="3810488">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3810492">//&nbsp;Write&nbsp;the&nbsp;xor&nbsp;to&nbsp;dst,&nbsp;then&nbsp;encrypt&nbsp;in&nbsp;place.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3810542">xorBytes</span><span class="op" id="3810550">(</span><span class="ident" id="3810551">dst</span><span class="op" id="3810554">[</span><span class="op" id="3810555">:</span><span class="ident" id="3810556">x</span><span class="op" id="3810557">.</span><span class="ident" id="3810558">blockSize</span><span class="op" id="3810567">]</span><span class="op" id="3810568">,</span>&nbsp;<span class="ident" id="3810570">src</span><span class="op" id="3810573">[</span><span class="op" id="3810574">:</span><span class="ident" id="3810575">x</span><span class="op" id="3810576">.</span><span class="ident" id="3810577">blockSize</span><span class="op" id="3810586">]</span><span class="op" id="3810587">,</span>&nbsp;<span class="ident" id="3810589">iv</span><span class="op" id="3810591">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3810595">x</span><span class="op" id="3810596">.</span><span class="ident" id="3810597">b</span><span class="op" id="3810598">.</span><span class="ident" id="3810599">Encrypt</span><span class="op" id="3810606">(</span><span class="ident" id="3810607">dst</span><span class="op" id="3810610">[</span><span class="op" id="3810611">:</span><span class="ident" id="3810612">x</span><span class="op" id="3810613">.</span><span class="ident" id="3810614">blockSize</span><span class="op" id="3810623">]</span><span class="op" id="3810624">,</span>&nbsp;<span class="ident" id="3810626">dst</span><span class="op" id="3810629">[</span><span class="op" id="3810630">:</span><span class="ident" id="3810631">x</span><span class="op" id="3810632">.</span><span class="ident" id="3810633">blockSize</span><span class="op" id="3810642">]</span><span class="op" id="3810643">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3810648">//&nbsp;Move&nbsp;to&nbsp;the&nbsp;next&nbsp;block&nbsp;with&nbsp;this&nbsp;block&nbsp;as&nbsp;the&nbsp;next&nbsp;iv.</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3810708">iv</span>&nbsp;<span class="op" id="3810711">=</span>&nbsp;<span class="ident" id="3810713">dst</span><span class="op" id="3810716">[</span><span class="op" id="3810717">:</span><span class="ident" id="3810718">x</span><span class="op" id="3810719">.</span><span class="ident" id="3810720">blockSize</span><span class="op" id="3810729">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3810733">src</span>&nbsp;<span class="op" id="3810737">=</span>&nbsp;<span class="ident" id="3810739">src</span><span class="op" id="3810742">[</span><span class="ident" id="3810743">x</span><span class="op" id="3810744">.</span><span class="ident" id="3810745">blockSize</span><span class="op" id="3810754">:</span><span class="op" id="3810755">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3810759">dst</span>&nbsp;<span class="op" id="3810763">=</span>&nbsp;<span class="ident" id="3810765">dst</span><span class="op" id="3810768">[</span><span class="ident" id="3810769">x</span><span class="op" id="3810770">.</span><span class="ident" id="3810771">blockSize</span><span class="op" id="3810780">:</span><span class="op" id="3810781">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3810784">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3810788">//&nbsp;Save&nbsp;the&nbsp;iv&nbsp;for&nbsp;the&nbsp;next&nbsp;CryptBlocks&nbsp;call.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3810835">copy</span><span class="op" id="3810839">(</span><span class="ident" id="3810840">x</span><span class="op" id="3810841">.</span><span class="ident" id="3810842">iv</span><span class="op" id="3810844">,</span>&nbsp;<span class="ident" id="3810846">iv</span><span class="op" id="3810848">)</span><br>
<span class="lineno"></span><span class="op" id="3810850">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3810853">func</span>&nbsp;<span class="op" id="3810858">(</span><span class="ident" id="3810859">x</span>&nbsp;<span class="op" id="3810861">*</span><span class="ident" id="3810862">cbcEncrypter</span><span class="op" id="3810874">)</span>&nbsp;<span class="ident" id="3810876">SetIV</span><span class="op" id="3810881">(</span><span class="ident" id="3810882">iv</span>&nbsp;<span class="op" id="3810885">[</span><span class="op" id="3810886">]</span><span class="builtintype" id="3810887">byte</span><span class="op" id="3810891">)</span>&nbsp;<span class="op" id="3810893">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3810896">if</span>&nbsp;<span class="builtinfunc" id="3810899">len</span><span class="op" id="3810902">(</span><span class="ident" id="3810903">iv</span><span class="op" id="3810905">)</span>&nbsp;<span class="op" id="3810907">!=</span>&nbsp;<span class="builtinfunc" id="3810910">len</span><span class="op" id="3810913">(</span><span class="ident" id="3810914">x</span><span class="op" id="3810915">.</span><span class="ident" id="3810916">iv</span><span class="op" id="3810918">)</span>&nbsp;<span class="op" id="3810920">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3810924">panic</span><span class="op" id="3810929">(</span><span class="string" id="3810930">&#34;cipher:&nbsp;incorrect&nbsp;length&nbsp;IV&#34;</span><span class="op" id="3810959">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3810962">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3810965">copy</span><span class="op" id="3810969">(</span><span class="ident" id="3810970">x</span><span class="op" id="3810971">.</span><span class="ident" id="3810972">iv</span><span class="op" id="3810974">,</span>&nbsp;<span class="ident" id="3810976">iv</span><span class="op" id="3810978">)</span><br>
<span class="lineno"></span><span class="op" id="3810980">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span><span class="keyword" id="3810983">type</span>&nbsp;<span class="ident" id="3810988">cbcDecrypter</span>&nbsp;<span class="ident" id="3811001">cbc</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3811006">//&nbsp;NewCBCDecrypter&nbsp;returns&nbsp;a&nbsp;BlockMode&nbsp;which&nbsp;decrypts&nbsp;in&nbsp;cipher&nbsp;block&nbsp;chaining</span><br>
<span class="lineno"></span><span class="comment" id="3811085">//&nbsp;mode,&nbsp;using&nbsp;the&nbsp;given&nbsp;Block.&nbsp;The&nbsp;length&nbsp;of&nbsp;iv&nbsp;must&nbsp;be&nbsp;the&nbsp;same&nbsp;as&nbsp;the</span><br>
<span class="lineno">80</span><span class="comment" id="3811158">//&nbsp;Block&#39;s&nbsp;block&nbsp;size&nbsp;and&nbsp;must&nbsp;match&nbsp;the&nbsp;iv&nbsp;used&nbsp;to&nbsp;encrypt&nbsp;the&nbsp;data.</span><br>
<span class="lineno"></span><span class="keyword" id="3811228">func</span>&nbsp;<span class="ident" id="3811233">NewCBCDecrypter</span><span class="op" id="3811248">(</span><span class="ident" id="3811249">b</span>&nbsp;<span class="ident" id="3811251">Block</span><span class="op" id="3811256">,</span>&nbsp;<span class="ident" id="3811258">iv</span>&nbsp;<span class="op" id="3811261">[</span><span class="op" id="3811262">]</span><span class="builtintype" id="3811263">byte</span><span class="op" id="3811267">)</span>&nbsp;<span class="ident" id="3811269">BlockMode</span>&nbsp;<span class="op" id="3811279">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3811282">if</span>&nbsp;<span class="builtinfunc" id="3811285">len</span><span class="op" id="3811288">(</span><span class="ident" id="3811289">iv</span><span class="op" id="3811291">)</span>&nbsp;<span class="op" id="3811293">!=</span>&nbsp;<span class="ident" id="3811296">b</span><span class="op" id="3811297">.</span><span class="ident" id="3811298">BlockSize</span><span class="op" id="3811307">(</span><span class="op" id="3811308">)</span>&nbsp;<span class="op" id="3811310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3811314">panic</span><span class="op" id="3811319">(</span><span class="string" id="3811320">&#34;cipher.NewCBCDecrypter:&nbsp;IV&nbsp;length&nbsp;must&nbsp;equal&nbsp;block&nbsp;size&#34;</span><span class="op" id="3811377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3811380">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3811383">return</span>&nbsp;<span class="op" id="3811390">(</span><span class="op" id="3811391">*</span><span class="ident" id="3811392">cbcDecrypter</span><span class="op" id="3811404">)</span><span class="op" id="3811405">(</span><span class="ident" id="3811406">newCBC</span><span class="op" id="3811412">(</span><span class="ident" id="3811413">b</span><span class="op" id="3811414">,</span>&nbsp;<span class="ident" id="3811416">iv</span><span class="op" id="3811418">)</span><span class="op" id="3811419">)</span><br>
<span class="lineno"></span><span class="op" id="3811421">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3811424">func</span>&nbsp;<span class="op" id="3811429">(</span><span class="ident" id="3811430">x</span>&nbsp;<span class="op" id="3811432">*</span><span class="ident" id="3811433">cbcDecrypter</span><span class="op" id="3811445">)</span>&nbsp;<span class="ident" id="3811447">BlockSize</span><span class="op" id="3811456">(</span><span class="op" id="3811457">)</span>&nbsp;<span class="builtintype" id="3811459">int</span>&nbsp;<span class="op" id="3811463">{</span>&nbsp;<span class="keyword" id="3811465">return</span>&nbsp;<span class="ident" id="3811472">x</span><span class="op" id="3811473">.</span><span class="ident" id="3811474">blockSize</span>&nbsp;<span class="op" id="3811484">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">90</span><span class="keyword" id="3811487">func</span>&nbsp;<span class="op" id="3811492">(</span><span class="ident" id="3811493">x</span>&nbsp;<span class="op" id="3811495">*</span><span class="ident" id="3811496">cbcDecrypter</span><span class="op" id="3811508">)</span>&nbsp;<span class="ident" id="3811510">CryptBlocks</span><span class="op" id="3811521">(</span><span class="ident" id="3811522">dst</span><span class="op" id="3811525">,</span>&nbsp;<span class="ident" id="3811527">src</span>&nbsp;<span class="op" id="3811531">[</span><span class="op" id="3811532">]</span><span class="builtintype" id="3811533">byte</span><span class="op" id="3811537">)</span>&nbsp;<span class="op" id="3811539">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3811542">if</span>&nbsp;<span class="builtinfunc" id="3811545">len</span><span class="op" id="3811548">(</span><span class="ident" id="3811549">src</span><span class="op" id="3811552">)</span><span class="op" id="3811553">%</span><span class="ident" id="3811554">x</span><span class="op" id="3811555">.</span><span class="ident" id="3811556">blockSize</span>&nbsp;<span class="op" id="3811566">!=</span>&nbsp;<span class="num" id="3811569">0</span>&nbsp;<span class="op" id="3811571">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3811575">panic</span><span class="op" id="3811580">(</span><span class="string" id="3811581">&#34;crypto/cipher:&nbsp;input&nbsp;not&nbsp;full&nbsp;blocks&#34;</span><span class="op" id="3811619">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3811622">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3811625">if</span>&nbsp;<span class="builtinfunc" id="3811628">len</span><span class="op" id="3811631">(</span><span class="ident" id="3811632">dst</span><span class="op" id="3811635">)</span>&nbsp;<span class="op" id="3811637">&lt;</span>&nbsp;<span class="builtinfunc" id="3811639">len</span><span class="op" id="3811642">(</span><span class="ident" id="3811643">src</span><span class="op" id="3811646">)</span>&nbsp;<span class="op" id="3811648">{</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3811652">panic</span><span class="op" id="3811657">(</span><span class="string" id="3811658">&#34;crypto/cipher:&nbsp;output&nbsp;smaller&nbsp;than&nbsp;input&#34;</span><span class="op" id="3811700">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3811703">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3811706">if</span>&nbsp;<span class="builtinfunc" id="3811709">len</span><span class="op" id="3811712">(</span><span class="ident" id="3811713">src</span><span class="op" id="3811716">)</span>&nbsp;<span class="op" id="3811718">==</span>&nbsp;<span class="num" id="3811721">0</span>&nbsp;<span class="op" id="3811723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3811727">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3811735">}</span><br>
<span class="lineno">100</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3811739">//&nbsp;For&nbsp;each&nbsp;block,&nbsp;we&nbsp;need&nbsp;to&nbsp;xor&nbsp;the&nbsp;decrypted&nbsp;data&nbsp;with&nbsp;the&nbsp;previous&nbsp;block&#39;s&nbsp;ciphertext&nbsp;(the&nbsp;iv).</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3811840">//&nbsp;To&nbsp;avoid&nbsp;making&nbsp;a&nbsp;copy&nbsp;each&nbsp;time,&nbsp;we&nbsp;loop&nbsp;over&nbsp;the&nbsp;blocks&nbsp;BACKWARDS.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3811913">end</span>&nbsp;<span class="op" id="3811917">:=</span>&nbsp;<span class="builtinfunc" id="3811920">len</span><span class="op" id="3811923">(</span><span class="ident" id="3811924">src</span><span class="op" id="3811927">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3811930">start</span>&nbsp;<span class="op" id="3811936">:=</span>&nbsp;<span class="ident" id="3811939">end</span>&nbsp;<span class="op" id="3811943">-</span>&nbsp;<span class="ident" id="3811945">x</span><span class="op" id="3811946">.</span><span class="ident" id="3811947">blockSize</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3811958">prev</span>&nbsp;<span class="op" id="3811963">:=</span>&nbsp;<span class="ident" id="3811966">start</span>&nbsp;<span class="op" id="3811972">-</span>&nbsp;<span class="ident" id="3811974">x</span><span class="op" id="3811975">.</span><span class="ident" id="3811976">blockSize</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3811988">//&nbsp;Copy&nbsp;the&nbsp;last&nbsp;block&nbsp;of&nbsp;ciphertext&nbsp;in&nbsp;preparation&nbsp;as&nbsp;the&nbsp;new&nbsp;iv.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3812056">copy</span><span class="op" id="3812060">(</span><span class="ident" id="3812061">x</span><span class="op" id="3812062">.</span><span class="ident" id="3812063">tmp</span><span class="op" id="3812066">,</span>&nbsp;<span class="ident" id="3812068">src</span><span class="op" id="3812071">[</span><span class="ident" id="3812072">start</span><span class="op" id="3812077">:</span><span class="ident" id="3812078">end</span><span class="op" id="3812081">]</span><span class="op" id="3812082">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3812086">//&nbsp;Loop&nbsp;over&nbsp;all&nbsp;but&nbsp;the&nbsp;first&nbsp;block.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3812125">for</span>&nbsp;<span class="ident" id="3812129">start</span>&nbsp;<span class="op" id="3812135">&gt;</span>&nbsp;<span class="num" id="3812137">0</span>&nbsp;<span class="op" id="3812139">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3812143">x</span><span class="op" id="3812144">.</span><span class="ident" id="3812145">b</span><span class="op" id="3812146">.</span><span class="ident" id="3812147">Decrypt</span><span class="op" id="3812154">(</span><span class="ident" id="3812155">dst</span><span class="op" id="3812158">[</span><span class="ident" id="3812159">start</span><span class="op" id="3812164">:</span><span class="ident" id="3812165">end</span><span class="op" id="3812168">]</span><span class="op" id="3812169">,</span>&nbsp;<span class="ident" id="3812171">src</span><span class="op" id="3812174">[</span><span class="ident" id="3812175">start</span><span class="op" id="3812180">:</span><span class="ident" id="3812181">end</span><span class="op" id="3812184">]</span><span class="op" id="3812185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3812189">xorBytes</span><span class="op" id="3812197">(</span><span class="ident" id="3812198">dst</span><span class="op" id="3812201">[</span><span class="ident" id="3812202">start</span><span class="op" id="3812207">:</span><span class="ident" id="3812208">end</span><span class="op" id="3812211">]</span><span class="op" id="3812212">,</span>&nbsp;<span class="ident" id="3812214">dst</span><span class="op" id="3812217">[</span><span class="ident" id="3812218">start</span><span class="op" id="3812223">:</span><span class="ident" id="3812224">end</span><span class="op" id="3812227">]</span><span class="op" id="3812228">,</span>&nbsp;<span class="ident" id="3812230">src</span><span class="op" id="3812233">[</span><span class="ident" id="3812234">prev</span><span class="op" id="3812238">:</span><span class="ident" id="3812239">start</span><span class="op" id="3812244">]</span><span class="op" id="3812245">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3812250">end</span>&nbsp;<span class="op" id="3812254">=</span>&nbsp;<span class="ident" id="3812256">start</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3812264">start</span>&nbsp;<span class="op" id="3812270">=</span>&nbsp;<span class="ident" id="3812272">prev</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3812279">prev</span>&nbsp;<span class="op" id="3812284">-=</span>&nbsp;<span class="ident" id="3812287">x</span><span class="op" id="3812288">.</span><span class="ident" id="3812289">blockSize</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3812300">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3812304">//&nbsp;The&nbsp;first&nbsp;block&nbsp;is&nbsp;special&nbsp;because&nbsp;it&nbsp;uses&nbsp;the&nbsp;saved&nbsp;iv.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3812365">x</span><span class="op" id="3812366">.</span><span class="ident" id="3812367">b</span><span class="op" id="3812368">.</span><span class="ident" id="3812369">Decrypt</span><span class="op" id="3812376">(</span><span class="ident" id="3812377">dst</span><span class="op" id="3812380">[</span><span class="ident" id="3812381">start</span><span class="op" id="3812386">:</span><span class="ident" id="3812387">end</span><span class="op" id="3812390">]</span><span class="op" id="3812391">,</span>&nbsp;<span class="ident" id="3812393">src</span><span class="op" id="3812396">[</span><span class="ident" id="3812397">start</span><span class="op" id="3812402">:</span><span class="ident" id="3812403">end</span><span class="op" id="3812406">]</span><span class="op" id="3812407">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3812410">xorBytes</span><span class="op" id="3812418">(</span><span class="ident" id="3812419">dst</span><span class="op" id="3812422">[</span><span class="ident" id="3812423">start</span><span class="op" id="3812428">:</span><span class="ident" id="3812429">end</span><span class="op" id="3812432">]</span><span class="op" id="3812433">,</span>&nbsp;<span class="ident" id="3812435">dst</span><span class="op" id="3812438">[</span><span class="ident" id="3812439">start</span><span class="op" id="3812444">:</span><span class="ident" id="3812445">end</span><span class="op" id="3812448">]</span><span class="op" id="3812449">,</span>&nbsp;<span class="ident" id="3812451">x</span><span class="op" id="3812452">.</span><span class="ident" id="3812453">iv</span><span class="op" id="3812455">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3812459">//&nbsp;Set&nbsp;the&nbsp;new&nbsp;iv&nbsp;to&nbsp;the&nbsp;first&nbsp;block&nbsp;we&nbsp;copied&nbsp;earlier.</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3812516">x</span><span class="op" id="3812517">.</span><span class="ident" id="3812518">iv</span><span class="op" id="3812520">,</span>&nbsp;<span class="ident" id="3812522">x</span><span class="op" id="3812523">.</span><span class="ident" id="3812524">tmp</span>&nbsp;<span class="op" id="3812528">=</span>&nbsp;<span class="ident" id="3812530">x</span><span class="op" id="3812531">.</span><span class="ident" id="3812532">tmp</span><span class="op" id="3812535">,</span>&nbsp;<span class="ident" id="3812537">x</span><span class="op" id="3812538">.</span><span class="ident" id="3812539">iv</span><br>
<span class="lineno"></span><span class="op" id="3812542">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3812545">func</span>&nbsp;<span class="op" id="3812550">(</span><span class="ident" id="3812551">x</span>&nbsp;<span class="op" id="3812553">*</span><span class="ident" id="3812554">cbcDecrypter</span><span class="op" id="3812566">)</span>&nbsp;<span class="ident" id="3812568">SetIV</span><span class="op" id="3812573">(</span><span class="ident" id="3812574">iv</span>&nbsp;<span class="op" id="3812577">[</span><span class="op" id="3812578">]</span><span class="builtintype" id="3812579">byte</span><span class="op" id="3812583">)</span>&nbsp;<span class="op" id="3812585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3812588">if</span>&nbsp;<span class="builtinfunc" id="3812591">len</span><span class="op" id="3812594">(</span><span class="ident" id="3812595">iv</span><span class="op" id="3812597">)</span>&nbsp;<span class="op" id="3812599">!=</span>&nbsp;<span class="builtinfunc" id="3812602">len</span><span class="op" id="3812605">(</span><span class="ident" id="3812606">x</span><span class="op" id="3812607">.</span><span class="ident" id="3812608">iv</span><span class="op" id="3812610">)</span>&nbsp;<span class="op" id="3812612">{</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3812616">panic</span><span class="op" id="3812621">(</span><span class="string" id="3812622">&#34;cipher:&nbsp;incorrect&nbsp;length&nbsp;IV&#34;</span><span class="op" id="3812651">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3812654">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3812657">copy</span><span class="op" id="3812661">(</span><span class="ident" id="3812662">x</span><span class="op" id="3812663">.</span><span class="ident" id="3812664">iv</span><span class="op" id="3812666">,</span>&nbsp;<span class="ident" id="3812668">iv</span><span class="op" id="3812670">)</span><br>
<span class="lineno"></span><span class="op" id="3812672">}</span>
</div>
</body>
</html>
