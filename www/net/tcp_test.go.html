<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="7535001">//&nbsp;Copyright&nbsp;2012&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="7535056">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="7535110">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="keyword" id="7535161">package</span>&nbsp;<span class="ident" id="7535169">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7535174">import</span>&nbsp;<span class="op" id="7535181">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7535184">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7535191">&#34;io&#34;</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7535197">&#34;reflect&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7535208">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7535219">&#34;sync&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7535227">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="7535238">&#34;time&#34;</span><br>
<span class="lineno">15</span><span class="op" id="7535245">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7535248">func</span>&nbsp;<span class="ident" id="7535253">BenchmarkTCP4OneShot</span><span class="op" id="7535273">(</span><span class="ident" id="7535274">b</span>&nbsp;<span class="op" id="7535276">*</span><span class="ident" id="7535277">testing</span><span class="op" id="7535284">.</span><span class="ident" id="7535285">B</span><span class="op" id="7535286">)</span>&nbsp;<span class="op" id="7535288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7535291">benchmarkTCP</span><span class="op" id="7535303">(</span><span class="ident" id="7535304">b</span><span class="op" id="7535305">,</span>&nbsp;<span class="ident" id="7535307">false</span><span class="op" id="7535312">,</span>&nbsp;<span class="ident" id="7535314">false</span><span class="op" id="7535319">,</span>&nbsp;<span class="string" id="7535321">&#34;127.0.0.1:0&#34;</span><span class="op" id="7535334">)</span><br>
<span class="lineno"></span><span class="op" id="7535336">}</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="7535339">func</span>&nbsp;<span class="ident" id="7535344">BenchmarkTCP4OneShotTimeout</span><span class="op" id="7535371">(</span><span class="ident" id="7535372">b</span>&nbsp;<span class="op" id="7535374">*</span><span class="ident" id="7535375">testing</span><span class="op" id="7535382">.</span><span class="ident" id="7535383">B</span><span class="op" id="7535384">)</span>&nbsp;<span class="op" id="7535386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7535389">benchmarkTCP</span><span class="op" id="7535401">(</span><span class="ident" id="7535402">b</span><span class="op" id="7535403">,</span>&nbsp;<span class="ident" id="7535405">false</span><span class="op" id="7535410">,</span>&nbsp;<span class="ident" id="7535412">true</span><span class="op" id="7535416">,</span>&nbsp;<span class="string" id="7535418">&#34;127.0.0.1:0&#34;</span><span class="op" id="7535431">)</span><br>
<span class="lineno"></span><span class="op" id="7535433">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="7535436">func</span>&nbsp;<span class="ident" id="7535441">BenchmarkTCP4Persistent</span><span class="op" id="7535464">(</span><span class="ident" id="7535465">b</span>&nbsp;<span class="op" id="7535467">*</span><span class="ident" id="7535468">testing</span><span class="op" id="7535475">.</span><span class="ident" id="7535476">B</span><span class="op" id="7535477">)</span>&nbsp;<span class="op" id="7535479">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7535482">benchmarkTCP</span><span class="op" id="7535494">(</span><span class="ident" id="7535495">b</span><span class="op" id="7535496">,</span>&nbsp;<span class="ident" id="7535498">true</span><span class="op" id="7535502">,</span>&nbsp;<span class="ident" id="7535504">false</span><span class="op" id="7535509">,</span>&nbsp;<span class="string" id="7535511">&#34;127.0.0.1:0&#34;</span><span class="op" id="7535524">)</span><br>
<span class="lineno"></span><span class="op" id="7535526">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7535529">func</span>&nbsp;<span class="ident" id="7535534">BenchmarkTCP4PersistentTimeout</span><span class="op" id="7535564">(</span><span class="ident" id="7535565">b</span>&nbsp;<span class="op" id="7535567">*</span><span class="ident" id="7535568">testing</span><span class="op" id="7535575">.</span><span class="ident" id="7535576">B</span><span class="op" id="7535577">)</span>&nbsp;<span class="op" id="7535579">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7535582">benchmarkTCP</span><span class="op" id="7535594">(</span><span class="ident" id="7535595">b</span><span class="op" id="7535596">,</span>&nbsp;<span class="ident" id="7535598">true</span><span class="op" id="7535602">,</span>&nbsp;<span class="ident" id="7535604">true</span><span class="op" id="7535608">,</span>&nbsp;<span class="string" id="7535610">&#34;127.0.0.1:0&#34;</span><span class="op" id="7535623">)</span><br>
<span class="lineno"></span><span class="op" id="7535625">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7535628">func</span>&nbsp;<span class="ident" id="7535633">BenchmarkTCP6OneShot</span><span class="op" id="7535653">(</span><span class="ident" id="7535654">b</span>&nbsp;<span class="op" id="7535656">*</span><span class="ident" id="7535657">testing</span><span class="op" id="7535664">.</span><span class="ident" id="7535665">B</span><span class="op" id="7535666">)</span>&nbsp;<span class="op" id="7535668">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7535671">if</span>&nbsp;<span class="op" id="7535674">!</span><span class="ident" id="7535675">supportsIPv6</span>&nbsp;<span class="op" id="7535688">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7535692">b</span><span class="op" id="7535693">.</span><span class="ident" id="7535694">Skip</span><span class="op" id="7535698">(</span><span class="string" id="7535699">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="7535722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7535725">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7535728">benchmarkTCP</span><span class="op" id="7535740">(</span><span class="ident" id="7535741">b</span><span class="op" id="7535742">,</span>&nbsp;<span class="ident" id="7535744">false</span><span class="op" id="7535749">,</span>&nbsp;<span class="ident" id="7535751">false</span><span class="op" id="7535756">,</span>&nbsp;<span class="string" id="7535758">&#34;[::1]:0&#34;</span><span class="op" id="7535767">)</span><br>
<span class="lineno"></span><span class="op" id="7535769">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="7535772">func</span>&nbsp;<span class="ident" id="7535777">BenchmarkTCP6OneShotTimeout</span><span class="op" id="7535804">(</span><span class="ident" id="7535805">b</span>&nbsp;<span class="op" id="7535807">*</span><span class="ident" id="7535808">testing</span><span class="op" id="7535815">.</span><span class="ident" id="7535816">B</span><span class="op" id="7535817">)</span>&nbsp;<span class="op" id="7535819">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7535822">if</span>&nbsp;<span class="op" id="7535825">!</span><span class="ident" id="7535826">supportsIPv6</span>&nbsp;<span class="op" id="7535839">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7535843">b</span><span class="op" id="7535844">.</span><span class="ident" id="7535845">Skip</span><span class="op" id="7535849">(</span><span class="string" id="7535850">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="7535873">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7535876">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7535879">benchmarkTCP</span><span class="op" id="7535891">(</span><span class="ident" id="7535892">b</span><span class="op" id="7535893">,</span>&nbsp;<span class="ident" id="7535895">false</span><span class="op" id="7535900">,</span>&nbsp;<span class="ident" id="7535902">true</span><span class="op" id="7535906">,</span>&nbsp;<span class="string" id="7535908">&#34;[::1]:0&#34;</span><span class="op" id="7535917">)</span><br>
<span class="lineno">45</span><span class="op" id="7535919">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7535922">func</span>&nbsp;<span class="ident" id="7535927">BenchmarkTCP6Persistent</span><span class="op" id="7535950">(</span><span class="ident" id="7535951">b</span>&nbsp;<span class="op" id="7535953">*</span><span class="ident" id="7535954">testing</span><span class="op" id="7535961">.</span><span class="ident" id="7535962">B</span><span class="op" id="7535963">)</span>&nbsp;<span class="op" id="7535965">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7535968">if</span>&nbsp;<span class="op" id="7535971">!</span><span class="ident" id="7535972">supportsIPv6</span>&nbsp;<span class="op" id="7535985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7535989">b</span><span class="op" id="7535990">.</span><span class="ident" id="7535991">Skip</span><span class="op" id="7535995">(</span><span class="string" id="7535996">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="7536019">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7536022">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7536025">benchmarkTCP</span><span class="op" id="7536037">(</span><span class="ident" id="7536038">b</span><span class="op" id="7536039">,</span>&nbsp;<span class="ident" id="7536041">true</span><span class="op" id="7536045">,</span>&nbsp;<span class="ident" id="7536047">false</span><span class="op" id="7536052">,</span>&nbsp;<span class="string" id="7536054">&#34;[::1]:0&#34;</span><span class="op" id="7536063">)</span><br>
<span class="lineno"></span><span class="op" id="7536065">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7536068">func</span>&nbsp;<span class="ident" id="7536073">BenchmarkTCP6PersistentTimeout</span><span class="op" id="7536103">(</span><span class="ident" id="7536104">b</span>&nbsp;<span class="op" id="7536106">*</span><span class="ident" id="7536107">testing</span><span class="op" id="7536114">.</span><span class="ident" id="7536115">B</span><span class="op" id="7536116">)</span>&nbsp;<span class="op" id="7536118">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7536121">if</span>&nbsp;<span class="op" id="7536124">!</span><span class="ident" id="7536125">supportsIPv6</span>&nbsp;<span class="op" id="7536138">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7536142">b</span><span class="op" id="7536143">.</span><span class="ident" id="7536144">Skip</span><span class="op" id="7536148">(</span><span class="string" id="7536149">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="7536172">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7536175">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7536178">benchmarkTCP</span><span class="op" id="7536190">(</span><span class="ident" id="7536191">b</span><span class="op" id="7536192">,</span>&nbsp;<span class="ident" id="7536194">true</span><span class="op" id="7536198">,</span>&nbsp;<span class="ident" id="7536200">true</span><span class="op" id="7536204">,</span>&nbsp;<span class="string" id="7536206">&#34;[::1]:0&#34;</span><span class="op" id="7536215">)</span><br>
<span class="lineno"></span><span class="op" id="7536217">}</span><br>
<span class="lineno">60</span><br>
<span class="lineno"></span><span class="keyword" id="7536220">func</span>&nbsp;<span class="ident" id="7536225">benchmarkTCP</span><span class="op" id="7536237">(</span><span class="ident" id="7536238">b</span>&nbsp;<span class="op" id="7536240">*</span><span class="ident" id="7536241">testing</span><span class="op" id="7536248">.</span><span class="ident" id="7536249">B</span><span class="op" id="7536250">,</span>&nbsp;<span class="ident" id="7536252">persistent</span><span class="op" id="7536262">,</span>&nbsp;<span class="ident" id="7536264">timeout</span>&nbsp;<span class="builtintype" id="7536272">bool</span><span class="op" id="7536276">,</span>&nbsp;<span class="ident" id="7536278">laddr</span>&nbsp;<span class="builtintype" id="7536284">string</span><span class="op" id="7536290">)</span>&nbsp;<span class="op" id="7536292">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7536295">const</span>&nbsp;<span class="ident" id="7536301">msgLen</span>&nbsp;<span class="op" id="7536308">=</span>&nbsp;<span class="num" id="7536310">512</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7536315">conns</span>&nbsp;<span class="op" id="7536321">:=</span>&nbsp;<span class="ident" id="7536324">b</span><span class="op" id="7536325">.</span><span class="ident" id="7536326">N</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7536329">numConcurrent</span>&nbsp;<span class="op" id="7536343">:=</span>&nbsp;<span class="ident" id="7536346">runtime</span><span class="op" id="7536353">.</span><span class="ident" id="7536354">GOMAXPROCS</span><span class="op" id="7536364">(</span><span class="op" id="7536365">-</span><span class="num" id="7536366">1</span><span class="op" id="7536367">)</span>&nbsp;<span class="op" id="7536369">*</span>&nbsp;<span class="num" id="7536371">2</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7536374">msgs</span>&nbsp;<span class="op" id="7536379">:=</span>&nbsp;<span class="num" id="7536382">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7536385">if</span>&nbsp;<span class="ident" id="7536388">persistent</span>&nbsp;<span class="op" id="7536399">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7536403">conns</span>&nbsp;<span class="op" id="7536409">=</span>&nbsp;<span class="ident" id="7536411">numConcurrent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7536427">msgs</span>&nbsp;<span class="op" id="7536432">=</span>&nbsp;<span class="ident" id="7536434">b</span><span class="op" id="7536435">.</span><span class="ident" id="7536436">N</span>&nbsp;<span class="op" id="7536438">/</span>&nbsp;<span class="ident" id="7536440">conns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7536448">if</span>&nbsp;<span class="ident" id="7536451">msgs</span>&nbsp;<span class="op" id="7536456">==</span>&nbsp;<span class="num" id="7536459">0</span>&nbsp;<span class="op" id="7536461">{</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7536466">msgs</span>&nbsp;<span class="op" id="7536471">=</span>&nbsp;<span class="num" id="7536473">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7536477">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7536481">if</span>&nbsp;<span class="ident" id="7536484">conns</span>&nbsp;<span class="op" id="7536490">&gt;</span>&nbsp;<span class="ident" id="7536492">b</span><span class="op" id="7536493">.</span><span class="ident" id="7536494">N</span>&nbsp;<span class="op" id="7536496">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7536501">conns</span>&nbsp;<span class="op" id="7536507">=</span>&nbsp;<span class="ident" id="7536509">b</span><span class="op" id="7536510">.</span><span class="ident" id="7536511">N</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7536515">}</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7536518">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7536521">sendMsg</span>&nbsp;<span class="op" id="7536529">:=</span>&nbsp;<span class="keyword" id="7536532">func</span><span class="op" id="7536536">(</span><span class="ident" id="7536537">c</span>&nbsp;<span class="ident" id="7536539">Conn</span><span class="op" id="7536543">,</span>&nbsp;<span class="ident" id="7536545">buf</span>&nbsp;<span class="op" id="7536549">[</span><span class="op" id="7536550">]</span><span class="builtintype" id="7536551">byte</span><span class="op" id="7536555">)</span>&nbsp;<span class="builtintype" id="7536557">bool</span>&nbsp;<span class="op" id="7536562">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7536566">n</span><span class="op" id="7536567">,</span>&nbsp;<span class="ident" id="7536569">err</span>&nbsp;<span class="op" id="7536573">:=</span>&nbsp;<span class="ident" id="7536576">c</span><span class="op" id="7536577">.</span><span class="ident" id="7536578">Write</span><span class="op" id="7536583">(</span><span class="ident" id="7536584">buf</span><span class="op" id="7536587">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7536591">if</span>&nbsp;<span class="ident" id="7536594">n</span>&nbsp;<span class="op" id="7536596">!=</span>&nbsp;<span class="builtinfunc" id="7536599">len</span><span class="op" id="7536602">(</span><span class="ident" id="7536603">buf</span><span class="op" id="7536606">)</span>&nbsp;<span class="op" id="7536608">||</span>&nbsp;<span class="ident" id="7536611">err</span>&nbsp;<span class="op" id="7536615">!=</span>&nbsp;<span class="ident" id="7536618">nil</span>&nbsp;<span class="op" id="7536622">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7536627">b</span><span class="op" id="7536628">.</span><span class="ident" id="7536629">Logf</span><span class="op" id="7536633">(</span><span class="string" id="7536634">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7536652">,</span>&nbsp;<span class="ident" id="7536654">err</span><span class="op" id="7536657">)</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7536662">return</span>&nbsp;<span class="ident" id="7536669">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7536677">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7536681">return</span>&nbsp;<span class="ident" id="7536688">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7536694">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7536697">recvMsg</span>&nbsp;<span class="op" id="7536705">:=</span>&nbsp;<span class="keyword" id="7536708">func</span><span class="op" id="7536712">(</span><span class="ident" id="7536713">c</span>&nbsp;<span class="ident" id="7536715">Conn</span><span class="op" id="7536719">,</span>&nbsp;<span class="ident" id="7536721">buf</span>&nbsp;<span class="op" id="7536725">[</span><span class="op" id="7536726">]</span><span class="builtintype" id="7536727">byte</span><span class="op" id="7536731">)</span>&nbsp;<span class="builtintype" id="7536733">bool</span>&nbsp;<span class="op" id="7536738">{</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7536742">for</span>&nbsp;<span class="ident" id="7536746">read</span>&nbsp;<span class="op" id="7536751">:=</span>&nbsp;<span class="num" id="7536754">0</span><span class="op" id="7536755">;</span>&nbsp;<span class="ident" id="7536757">read</span>&nbsp;<span class="op" id="7536762">!=</span>&nbsp;<span class="builtinfunc" id="7536765">len</span><span class="op" id="7536768">(</span><span class="ident" id="7536769">buf</span><span class="op" id="7536772">)</span><span class="op" id="7536773">;</span>&nbsp;<span class="op" id="7536775">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7536780">n</span><span class="op" id="7536781">,</span>&nbsp;<span class="ident" id="7536783">err</span>&nbsp;<span class="op" id="7536787">:=</span>&nbsp;<span class="ident" id="7536790">c</span><span class="op" id="7536791">.</span><span class="ident" id="7536792">Read</span><span class="op" id="7536796">(</span><span class="ident" id="7536797">buf</span><span class="op" id="7536800">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7536805">read</span>&nbsp;<span class="op" id="7536810">+=</span>&nbsp;<span class="ident" id="7536813">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7536818">if</span>&nbsp;<span class="ident" id="7536821">err</span>&nbsp;<span class="op" id="7536825">!=</span>&nbsp;<span class="ident" id="7536828">nil</span>&nbsp;<span class="op" id="7536832">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7536838">b</span><span class="op" id="7536839">.</span><span class="ident" id="7536840">Logf</span><span class="op" id="7536844">(</span><span class="string" id="7536845">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7536862">,</span>&nbsp;<span class="ident" id="7536864">err</span><span class="op" id="7536867">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7536873">return</span>&nbsp;<span class="ident" id="7536880">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7536889">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7536893">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7536897">return</span>&nbsp;<span class="ident" id="7536904">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7536910">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7536913">ln</span><span class="op" id="7536915">,</span>&nbsp;<span class="ident" id="7536917">err</span>&nbsp;<span class="op" id="7536921">:=</span>&nbsp;<span class="ident" id="7536924">Listen</span><span class="op" id="7536930">(</span><span class="string" id="7536931">&#34;tcp&#34;</span><span class="op" id="7536936">,</span>&nbsp;<span class="ident" id="7536938">laddr</span><span class="op" id="7536943">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7536946">if</span>&nbsp;<span class="ident" id="7536949">err</span>&nbsp;<span class="op" id="7536953">!=</span>&nbsp;<span class="ident" id="7536956">nil</span>&nbsp;<span class="op" id="7536960">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7536964">b</span><span class="op" id="7536965">.</span><span class="ident" id="7536966">Fatalf</span><span class="op" id="7536972">(</span><span class="string" id="7536973">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7536992">,</span>&nbsp;<span class="ident" id="7536994">err</span><span class="op" id="7536997">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7537000">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7537003">defer</span>&nbsp;<span class="ident" id="7537009">ln</span><span class="op" id="7537011">.</span><span class="ident" id="7537012">Close</span><span class="op" id="7537017">(</span><span class="op" id="7537018">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7537021">serverSem</span>&nbsp;<span class="op" id="7537031">:=</span>&nbsp;<span class="builtinfunc" id="7537034">make</span><span class="op" id="7537038">(</span><span class="keyword" id="7537039">chan</span>&nbsp;<span class="builtintype" id="7537044">bool</span><span class="op" id="7537048">,</span>&nbsp;<span class="ident" id="7537050">numConcurrent</span><span class="op" id="7537063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7537066">//&nbsp;Acceptor.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7537080">go</span>&nbsp;<span class="keyword" id="7537083">func</span><span class="op" id="7537087">(</span><span class="op" id="7537088">)</span>&nbsp;<span class="op" id="7537090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7537094">for</span>&nbsp;<span class="op" id="7537098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7537103">c</span><span class="op" id="7537104">,</span>&nbsp;<span class="ident" id="7537106">err</span>&nbsp;<span class="op" id="7537110">:=</span>&nbsp;<span class="ident" id="7537113">ln</span><span class="op" id="7537115">.</span><span class="ident" id="7537116">Accept</span><span class="op" id="7537122">(</span><span class="op" id="7537123">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7537128">if</span>&nbsp;<span class="ident" id="7537131">err</span>&nbsp;<span class="op" id="7537135">!=</span>&nbsp;<span class="ident" id="7537138">nil</span>&nbsp;<span class="op" id="7537142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7537148">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7537157">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7537162">serverSem</span>&nbsp;<span class="op" id="7537172">&lt;-</span>&nbsp;<span class="ident" id="7537175">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7537183">//&nbsp;Server&nbsp;connection.</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7537208">go</span>&nbsp;<span class="keyword" id="7537211">func</span><span class="op" id="7537215">(</span><span class="ident" id="7537216">c</span>&nbsp;<span class="ident" id="7537218">Conn</span><span class="op" id="7537222">)</span>&nbsp;<span class="op" id="7537224">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7537230">defer</span>&nbsp;<span class="keyword" id="7537236">func</span><span class="op" id="7537240">(</span><span class="op" id="7537241">)</span>&nbsp;<span class="op" id="7537243">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7537250">c</span><span class="op" id="7537251">.</span><span class="ident" id="7537252">Close</span><span class="op" id="7537257">(</span><span class="op" id="7537258">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7537265">&lt;-</span><span class="ident" id="7537267">serverSem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7537281">}</span><span class="op" id="7537282">(</span><span class="op" id="7537283">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7537289">if</span>&nbsp;<span class="ident" id="7537292">timeout</span>&nbsp;<span class="op" id="7537300">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7537307">c</span><span class="op" id="7537308">.</span><span class="ident" id="7537309">SetDeadline</span><span class="op" id="7537320">(</span><span class="ident" id="7537321">time</span><span class="op" id="7537325">.</span><span class="ident" id="7537326">Now</span><span class="op" id="7537329">(</span><span class="op" id="7537330">)</span><span class="op" id="7537331">.</span><span class="ident" id="7537332">Add</span><span class="op" id="7537335">(</span><span class="ident" id="7537336">time</span><span class="op" id="7537340">.</span><span class="ident" id="7537341">Hour</span><span class="op" id="7537345">)</span><span class="op" id="7537346">)</span>&nbsp;<span class="comment" id="7537348">//&nbsp;Not&nbsp;intended&nbsp;to&nbsp;fire.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7537377">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7537383">var</span>&nbsp;<span class="ident" id="7537387">buf</span>&nbsp;<span class="op" id="7537391">[</span><span class="ident" id="7537392">msgLen</span><span class="op" id="7537398">]</span><span class="builtintype" id="7537399">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7537408">for</span>&nbsp;<span class="ident" id="7537412">m</span>&nbsp;<span class="op" id="7537414">:=</span>&nbsp;<span class="num" id="7537417">0</span><span class="op" id="7537418">;</span>&nbsp;<span class="ident" id="7537420">m</span>&nbsp;<span class="op" id="7537422">&lt;</span>&nbsp;<span class="ident" id="7537424">msgs</span><span class="op" id="7537428">;</span>&nbsp;<span class="ident" id="7537430">m</span><span class="op" id="7537431">++</span>&nbsp;<span class="op" id="7537434">{</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7537441">if</span>&nbsp;<span class="op" id="7537444">!</span><span class="ident" id="7537445">recvMsg</span><span class="op" id="7537452">(</span><span class="ident" id="7537453">c</span><span class="op" id="7537454">,</span>&nbsp;<span class="ident" id="7537456">buf</span><span class="op" id="7537459">[</span><span class="op" id="7537460">:</span><span class="op" id="7537461">]</span><span class="op" id="7537462">)</span>&nbsp;<span class="op" id="7537464">||</span>&nbsp;<span class="op" id="7537467">!</span><span class="ident" id="7537468">sendMsg</span><span class="op" id="7537475">(</span><span class="ident" id="7537476">c</span><span class="op" id="7537477">,</span>&nbsp;<span class="ident" id="7537479">buf</span><span class="op" id="7537482">[</span><span class="op" id="7537483">:</span><span class="op" id="7537484">]</span><span class="op" id="7537485">)</span>&nbsp;<span class="op" id="7537487">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7537495">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7537506">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7537512">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7537517">}</span><span class="op" id="7537518">(</span><span class="ident" id="7537519">c</span><span class="op" id="7537520">)</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7537524">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7537527">}</span><span class="op" id="7537528">(</span><span class="op" id="7537529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7537532">clientSem</span>&nbsp;<span class="op" id="7537542">:=</span>&nbsp;<span class="builtinfunc" id="7537545">make</span><span class="op" id="7537549">(</span><span class="keyword" id="7537550">chan</span>&nbsp;<span class="builtintype" id="7537555">bool</span><span class="op" id="7537559">,</span>&nbsp;<span class="ident" id="7537561">numConcurrent</span><span class="op" id="7537574">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7537577">for</span>&nbsp;<span class="ident" id="7537581">i</span>&nbsp;<span class="op" id="7537583">:=</span>&nbsp;<span class="num" id="7537586">0</span><span class="op" id="7537587">;</span>&nbsp;<span class="ident" id="7537589">i</span>&nbsp;<span class="op" id="7537591">&lt;</span>&nbsp;<span class="ident" id="7537593">conns</span><span class="op" id="7537598">;</span>&nbsp;<span class="ident" id="7537600">i</span><span class="op" id="7537601">++</span>&nbsp;<span class="op" id="7537604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7537608">clientSem</span>&nbsp;<span class="op" id="7537618">&lt;-</span>&nbsp;<span class="ident" id="7537621">true</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7537628">//&nbsp;Client&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7537652">go</span>&nbsp;<span class="keyword" id="7537655">func</span><span class="op" id="7537659">(</span><span class="op" id="7537660">)</span>&nbsp;<span class="op" id="7537662">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7537667">defer</span>&nbsp;<span class="keyword" id="7537673">func</span><span class="op" id="7537677">(</span><span class="op" id="7537678">)</span>&nbsp;<span class="op" id="7537680">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7537686">&lt;-</span><span class="ident" id="7537688">clientSem</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7537701">}</span><span class="op" id="7537702">(</span><span class="op" id="7537703">)</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7537708">c</span><span class="op" id="7537709">,</span>&nbsp;<span class="ident" id="7537711">err</span>&nbsp;<span class="op" id="7537715">:=</span>&nbsp;<span class="ident" id="7537718">Dial</span><span class="op" id="7537722">(</span><span class="string" id="7537723">&#34;tcp&#34;</span><span class="op" id="7537728">,</span>&nbsp;<span class="ident" id="7537730">ln</span><span class="op" id="7537732">.</span><span class="ident" id="7537733">Addr</span><span class="op" id="7537737">(</span><span class="op" id="7537738">)</span><span class="op" id="7537739">.</span><span class="ident" id="7537740">String</span><span class="op" id="7537746">(</span><span class="op" id="7537747">)</span><span class="op" id="7537748">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7537753">if</span>&nbsp;<span class="ident" id="7537756">err</span>&nbsp;<span class="op" id="7537760">!=</span>&nbsp;<span class="ident" id="7537763">nil</span>&nbsp;<span class="op" id="7537767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7537773">b</span><span class="op" id="7537774">.</span><span class="ident" id="7537775">Logf</span><span class="op" id="7537779">(</span><span class="string" id="7537780">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7537797">,</span>&nbsp;<span class="ident" id="7537799">err</span><span class="op" id="7537802">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7537808">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7537818">}</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7537823">defer</span>&nbsp;<span class="ident" id="7537829">c</span><span class="op" id="7537830">.</span><span class="ident" id="7537831">Close</span><span class="op" id="7537836">(</span><span class="op" id="7537837">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7537842">if</span>&nbsp;<span class="ident" id="7537845">timeout</span>&nbsp;<span class="op" id="7537853">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7537859">c</span><span class="op" id="7537860">.</span><span class="ident" id="7537861">SetDeadline</span><span class="op" id="7537872">(</span><span class="ident" id="7537873">time</span><span class="op" id="7537877">.</span><span class="ident" id="7537878">Now</span><span class="op" id="7537881">(</span><span class="op" id="7537882">)</span><span class="op" id="7537883">.</span><span class="ident" id="7537884">Add</span><span class="op" id="7537887">(</span><span class="ident" id="7537888">time</span><span class="op" id="7537892">.</span><span class="ident" id="7537893">Hour</span><span class="op" id="7537897">)</span><span class="op" id="7537898">)</span>&nbsp;<span class="comment" id="7537900">//&nbsp;Not&nbsp;intended&nbsp;to&nbsp;fire.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7537928">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7537933">var</span>&nbsp;<span class="ident" id="7537937">buf</span>&nbsp;<span class="op" id="7537941">[</span><span class="ident" id="7537942">msgLen</span><span class="op" id="7537948">]</span><span class="builtintype" id="7537949">byte</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7537957">for</span>&nbsp;<span class="ident" id="7537961">m</span>&nbsp;<span class="op" id="7537963">:=</span>&nbsp;<span class="num" id="7537966">0</span><span class="op" id="7537967">;</span>&nbsp;<span class="ident" id="7537969">m</span>&nbsp;<span class="op" id="7537971">&lt;</span>&nbsp;<span class="ident" id="7537973">msgs</span><span class="op" id="7537977">;</span>&nbsp;<span class="ident" id="7537979">m</span><span class="op" id="7537980">++</span>&nbsp;<span class="op" id="7537983">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7537989">if</span>&nbsp;<span class="op" id="7537992">!</span><span class="ident" id="7537993">sendMsg</span><span class="op" id="7538000">(</span><span class="ident" id="7538001">c</span><span class="op" id="7538002">,</span>&nbsp;<span class="ident" id="7538004">buf</span><span class="op" id="7538007">[</span><span class="op" id="7538008">:</span><span class="op" id="7538009">]</span><span class="op" id="7538010">)</span>&nbsp;<span class="op" id="7538012">||</span>&nbsp;<span class="op" id="7538015">!</span><span class="ident" id="7538016">recvMsg</span><span class="op" id="7538023">(</span><span class="ident" id="7538024">c</span><span class="op" id="7538025">,</span>&nbsp;<span class="ident" id="7538027">buf</span><span class="op" id="7538030">[</span><span class="op" id="7538031">:</span><span class="op" id="7538032">]</span><span class="op" id="7538033">)</span>&nbsp;<span class="op" id="7538035">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7538042">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7538052">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7538057">}</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7538061">}</span><span class="op" id="7538062">(</span><span class="op" id="7538063">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7538066">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7538069">for</span>&nbsp;<span class="ident" id="7538073">i</span>&nbsp;<span class="op" id="7538075">:=</span>&nbsp;<span class="num" id="7538078">0</span><span class="op" id="7538079">;</span>&nbsp;<span class="ident" id="7538081">i</span>&nbsp;<span class="op" id="7538083">&lt;</span>&nbsp;<span class="ident" id="7538085">numConcurrent</span><span class="op" id="7538098">;</span>&nbsp;<span class="ident" id="7538100">i</span><span class="op" id="7538101">++</span>&nbsp;<span class="op" id="7538104">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7538108">clientSem</span>&nbsp;<span class="op" id="7538118">&lt;-</span>&nbsp;<span class="ident" id="7538121">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7538128">serverSem</span>&nbsp;<span class="op" id="7538138">&lt;-</span>&nbsp;<span class="ident" id="7538141">true</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7538147">}</span><br>
<span class="lineno"></span><span class="op" id="7538149">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7538152">func</span>&nbsp;<span class="ident" id="7538157">BenchmarkTCP4ConcurrentReadWrite</span><span class="op" id="7538189">(</span><span class="ident" id="7538190">b</span>&nbsp;<span class="op" id="7538192">*</span><span class="ident" id="7538193">testing</span><span class="op" id="7538200">.</span><span class="ident" id="7538201">B</span><span class="op" id="7538202">)</span>&nbsp;<span class="op" id="7538204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7538207">benchmarkTCPConcurrentReadWrite</span><span class="op" id="7538238">(</span><span class="ident" id="7538239">b</span><span class="op" id="7538240">,</span>&nbsp;<span class="string" id="7538242">&#34;127.0.0.1:0&#34;</span><span class="op" id="7538255">)</span><br>
<span class="lineno">160</span><span class="op" id="7538257">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7538260">func</span>&nbsp;<span class="ident" id="7538265">BenchmarkTCP6ConcurrentReadWrite</span><span class="op" id="7538297">(</span><span class="ident" id="7538298">b</span>&nbsp;<span class="op" id="7538300">*</span><span class="ident" id="7538301">testing</span><span class="op" id="7538308">.</span><span class="ident" id="7538309">B</span><span class="op" id="7538310">)</span>&nbsp;<span class="op" id="7538312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7538315">if</span>&nbsp;<span class="op" id="7538318">!</span><span class="ident" id="7538319">supportsIPv6</span>&nbsp;<span class="op" id="7538332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7538336">b</span><span class="op" id="7538337">.</span><span class="ident" id="7538338">Skip</span><span class="op" id="7538342">(</span><span class="string" id="7538343">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="7538366">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7538369">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7538372">benchmarkTCPConcurrentReadWrite</span><span class="op" id="7538403">(</span><span class="ident" id="7538404">b</span><span class="op" id="7538405">,</span>&nbsp;<span class="string" id="7538407">&#34;[::1]:0&#34;</span><span class="op" id="7538416">)</span><br>
<span class="lineno"></span><span class="op" id="7538418">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7538421">func</span>&nbsp;<span class="ident" id="7538426">benchmarkTCPConcurrentReadWrite</span><span class="op" id="7538457">(</span><span class="ident" id="7538458">b</span>&nbsp;<span class="op" id="7538460">*</span><span class="ident" id="7538461">testing</span><span class="op" id="7538468">.</span><span class="ident" id="7538469">B</span><span class="op" id="7538470">,</span>&nbsp;<span class="ident" id="7538472">laddr</span>&nbsp;<span class="builtintype" id="7538478">string</span><span class="op" id="7538484">)</span>&nbsp;<span class="op" id="7538486">{</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7538489">//&nbsp;The&nbsp;benchmark&nbsp;creates&nbsp;GOMAXPROCS&nbsp;client/server&nbsp;pairs.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7538547">//&nbsp;Each&nbsp;pair&nbsp;creates&nbsp;4&nbsp;goroutines:&nbsp;client&nbsp;reader/writer&nbsp;and&nbsp;server&nbsp;reader/writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7538630">//&nbsp;The&nbsp;benchmark&nbsp;stresses&nbsp;concurrent&nbsp;reading&nbsp;and&nbsp;writing&nbsp;to&nbsp;the&nbsp;same&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7538712">//&nbsp;Such&nbsp;pattern&nbsp;is&nbsp;used&nbsp;in&nbsp;net/http&nbsp;and&nbsp;net/rpc.</span><br>
<span class="lineno"></span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7538763">b</span><span class="op" id="7538764">.</span><span class="ident" id="7538765">StopTimer</span><span class="op" id="7538774">(</span><span class="op" id="7538775">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7538779">P</span>&nbsp;<span class="op" id="7538781">:=</span>&nbsp;<span class="ident" id="7538784">runtime</span><span class="op" id="7538791">.</span><span class="ident" id="7538792">GOMAXPROCS</span><span class="op" id="7538802">(</span><span class="num" id="7538803">0</span><span class="op" id="7538804">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7538807">N</span>&nbsp;<span class="op" id="7538809">:=</span>&nbsp;<span class="ident" id="7538812">b</span><span class="op" id="7538813">.</span><span class="ident" id="7538814">N</span>&nbsp;<span class="op" id="7538816">/</span>&nbsp;<span class="ident" id="7538818">P</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7538821">W</span>&nbsp;<span class="op" id="7538823">:=</span>&nbsp;<span class="num" id="7538826">1000</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7538833">//&nbsp;Setup&nbsp;P&nbsp;client/server&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7538872">clients</span>&nbsp;<span class="op" id="7538880">:=</span>&nbsp;<span class="builtinfunc" id="7538883">make</span><span class="op" id="7538887">(</span><span class="op" id="7538888">[</span><span class="op" id="7538889">]</span><span class="ident" id="7538890">Conn</span><span class="op" id="7538894">,</span>&nbsp;<span class="ident" id="7538896">P</span><span class="op" id="7538897">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7538900">servers</span>&nbsp;<span class="op" id="7538908">:=</span>&nbsp;<span class="builtinfunc" id="7538911">make</span><span class="op" id="7538915">(</span><span class="op" id="7538916">[</span><span class="op" id="7538917">]</span><span class="ident" id="7538918">Conn</span><span class="op" id="7538922">,</span>&nbsp;<span class="ident" id="7538924">P</span><span class="op" id="7538925">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7538928">ln</span><span class="op" id="7538930">,</span>&nbsp;<span class="ident" id="7538932">err</span>&nbsp;<span class="op" id="7538936">:=</span>&nbsp;<span class="ident" id="7538939">Listen</span><span class="op" id="7538945">(</span><span class="string" id="7538946">&#34;tcp&#34;</span><span class="op" id="7538951">,</span>&nbsp;<span class="ident" id="7538953">laddr</span><span class="op" id="7538958">)</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7538961">if</span>&nbsp;<span class="ident" id="7538964">err</span>&nbsp;<span class="op" id="7538968">!=</span>&nbsp;<span class="ident" id="7538971">nil</span>&nbsp;<span class="op" id="7538975">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7538979">b</span><span class="op" id="7538980">.</span><span class="ident" id="7538981">Fatalf</span><span class="op" id="7538987">(</span><span class="string" id="7538988">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7539007">,</span>&nbsp;<span class="ident" id="7539009">err</span><span class="op" id="7539012">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7539015">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7539018">defer</span>&nbsp;<span class="ident" id="7539024">ln</span><span class="op" id="7539026">.</span><span class="ident" id="7539027">Close</span><span class="op" id="7539032">(</span><span class="op" id="7539033">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7539036">done</span>&nbsp;<span class="op" id="7539041">:=</span>&nbsp;<span class="builtinfunc" id="7539044">make</span><span class="op" id="7539048">(</span><span class="keyword" id="7539049">chan</span>&nbsp;<span class="builtintype" id="7539054">bool</span><span class="op" id="7539058">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7539061">go</span>&nbsp;<span class="keyword" id="7539064">func</span><span class="op" id="7539068">(</span><span class="op" id="7539069">)</span>&nbsp;<span class="op" id="7539071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7539075">for</span>&nbsp;<span class="ident" id="7539079">p</span>&nbsp;<span class="op" id="7539081">:=</span>&nbsp;<span class="num" id="7539084">0</span><span class="op" id="7539085">;</span>&nbsp;<span class="ident" id="7539087">p</span>&nbsp;<span class="op" id="7539089">&lt;</span>&nbsp;<span class="ident" id="7539091">P</span><span class="op" id="7539092">;</span>&nbsp;<span class="ident" id="7539094">p</span><span class="op" id="7539095">++</span>&nbsp;<span class="op" id="7539098">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7539103">s</span><span class="op" id="7539104">,</span>&nbsp;<span class="ident" id="7539106">err</span>&nbsp;<span class="op" id="7539110">:=</span>&nbsp;<span class="ident" id="7539113">ln</span><span class="op" id="7539115">.</span><span class="ident" id="7539116">Accept</span><span class="op" id="7539122">(</span><span class="op" id="7539123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7539128">if</span>&nbsp;<span class="ident" id="7539131">err</span>&nbsp;<span class="op" id="7539135">!=</span>&nbsp;<span class="ident" id="7539138">nil</span>&nbsp;<span class="op" id="7539142">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7539148">b</span><span class="op" id="7539149">.</span><span class="ident" id="7539150">Errorf</span><span class="op" id="7539156">(</span><span class="string" id="7539157">&#34;Accept&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7539176">,</span>&nbsp;<span class="ident" id="7539178">err</span><span class="op" id="7539181">)</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7539187">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7539197">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7539202">servers</span><span class="op" id="7539209">[</span><span class="ident" id="7539210">p</span><span class="op" id="7539211">]</span>&nbsp;<span class="op" id="7539213">=</span>&nbsp;<span class="ident" id="7539215">s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7539219">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7539223">done</span>&nbsp;<span class="op" id="7539228">&lt;-</span>&nbsp;<span class="ident" id="7539231">true</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7539237">}</span><span class="op" id="7539238">(</span><span class="op" id="7539239">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7539242">for</span>&nbsp;<span class="ident" id="7539246">p</span>&nbsp;<span class="op" id="7539248">:=</span>&nbsp;<span class="num" id="7539251">0</span><span class="op" id="7539252">;</span>&nbsp;<span class="ident" id="7539254">p</span>&nbsp;<span class="op" id="7539256">&lt;</span>&nbsp;<span class="ident" id="7539258">P</span><span class="op" id="7539259">;</span>&nbsp;<span class="ident" id="7539261">p</span><span class="op" id="7539262">++</span>&nbsp;<span class="op" id="7539265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7539269">c</span><span class="op" id="7539270">,</span>&nbsp;<span class="ident" id="7539272">err</span>&nbsp;<span class="op" id="7539276">:=</span>&nbsp;<span class="ident" id="7539279">Dial</span><span class="op" id="7539283">(</span><span class="string" id="7539284">&#34;tcp&#34;</span><span class="op" id="7539289">,</span>&nbsp;<span class="ident" id="7539291">ln</span><span class="op" id="7539293">.</span><span class="ident" id="7539294">Addr</span><span class="op" id="7539298">(</span><span class="op" id="7539299">)</span><span class="op" id="7539300">.</span><span class="ident" id="7539301">String</span><span class="op" id="7539307">(</span><span class="op" id="7539308">)</span><span class="op" id="7539309">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7539313">if</span>&nbsp;<span class="ident" id="7539316">err</span>&nbsp;<span class="op" id="7539320">!=</span>&nbsp;<span class="ident" id="7539323">nil</span>&nbsp;<span class="op" id="7539327">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7539332">b</span><span class="op" id="7539333">.</span><span class="ident" id="7539334">Fatalf</span><span class="op" id="7539340">(</span><span class="string" id="7539341">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7539358">,</span>&nbsp;<span class="ident" id="7539360">err</span><span class="op" id="7539363">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7539367">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7539371">clients</span><span class="op" id="7539378">[</span><span class="ident" id="7539379">p</span><span class="op" id="7539380">]</span>&nbsp;<span class="op" id="7539382">=</span>&nbsp;<span class="ident" id="7539384">c</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7539387">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7539390">&lt;-</span><span class="ident" id="7539392">done</span><br>
<span class="lineno"></span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7539399">b</span><span class="op" id="7539400">.</span><span class="ident" id="7539401">StartTimer</span><span class="op" id="7539411">(</span><span class="op" id="7539412">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7539416">var</span>&nbsp;<span class="ident" id="7539420">wg</span>&nbsp;<span class="ident" id="7539423">sync</span><span class="op" id="7539427">.</span><span class="ident" id="7539428">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7539439">wg</span><span class="op" id="7539441">.</span><span class="ident" id="7539442">Add</span><span class="op" id="7539445">(</span><span class="num" id="7539446">4</span>&nbsp;<span class="op" id="7539448">*</span>&nbsp;<span class="ident" id="7539450">P</span><span class="op" id="7539451">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7539454">for</span>&nbsp;<span class="ident" id="7539458">p</span>&nbsp;<span class="op" id="7539460">:=</span>&nbsp;<span class="num" id="7539463">0</span><span class="op" id="7539464">;</span>&nbsp;<span class="ident" id="7539466">p</span>&nbsp;<span class="op" id="7539468">&lt;</span>&nbsp;<span class="ident" id="7539470">P</span><span class="op" id="7539471">;</span>&nbsp;<span class="ident" id="7539473">p</span><span class="op" id="7539474">++</span>&nbsp;<span class="op" id="7539477">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7539481">//&nbsp;Client&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7539501">go</span>&nbsp;<span class="keyword" id="7539504">func</span><span class="op" id="7539508">(</span><span class="ident" id="7539509">c</span>&nbsp;<span class="ident" id="7539511">Conn</span><span class="op" id="7539515">)</span>&nbsp;<span class="op" id="7539517">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7539522">defer</span>&nbsp;<span class="ident" id="7539528">wg</span><span class="op" id="7539530">.</span><span class="ident" id="7539531">Done</span><span class="op" id="7539535">(</span><span class="op" id="7539536">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7539541">var</span>&nbsp;<span class="ident" id="7539545">buf</span>&nbsp;<span class="op" id="7539549">[</span><span class="num" id="7539550">1</span><span class="op" id="7539551">]</span><span class="builtintype" id="7539552">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7539560">for</span>&nbsp;<span class="ident" id="7539564">i</span>&nbsp;<span class="op" id="7539566">:=</span>&nbsp;<span class="num" id="7539569">0</span><span class="op" id="7539570">;</span>&nbsp;<span class="ident" id="7539572">i</span>&nbsp;<span class="op" id="7539574">&lt;</span>&nbsp;<span class="ident" id="7539576">N</span><span class="op" id="7539577">;</span>&nbsp;<span class="ident" id="7539579">i</span><span class="op" id="7539580">++</span>&nbsp;<span class="op" id="7539583">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7539589">v</span>&nbsp;<span class="op" id="7539591">:=</span>&nbsp;<span class="builtintype" id="7539594">byte</span><span class="op" id="7539598">(</span><span class="ident" id="7539599">i</span><span class="op" id="7539600">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7539606">for</span>&nbsp;<span class="ident" id="7539610">w</span>&nbsp;<span class="op" id="7539612">:=</span>&nbsp;<span class="num" id="7539615">0</span><span class="op" id="7539616">;</span>&nbsp;<span class="ident" id="7539618">w</span>&nbsp;<span class="op" id="7539620">&lt;</span>&nbsp;<span class="ident" id="7539622">W</span><span class="op" id="7539623">;</span>&nbsp;<span class="ident" id="7539625">w</span><span class="op" id="7539626">++</span>&nbsp;<span class="op" id="7539629">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7539636">v</span>&nbsp;<span class="op" id="7539638">*=</span>&nbsp;<span class="ident" id="7539641">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7539647">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7539653">buf</span><span class="op" id="7539656">[</span><span class="num" id="7539657">0</span><span class="op" id="7539658">]</span>&nbsp;<span class="op" id="7539660">=</span>&nbsp;<span class="ident" id="7539662">v</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7539668">_</span><span class="op" id="7539669">,</span>&nbsp;<span class="ident" id="7539671">err</span>&nbsp;<span class="op" id="7539675">:=</span>&nbsp;<span class="ident" id="7539678">c</span><span class="op" id="7539679">.</span><span class="ident" id="7539680">Write</span><span class="op" id="7539685">(</span><span class="ident" id="7539686">buf</span><span class="op" id="7539689">[</span><span class="op" id="7539690">:</span><span class="op" id="7539691">]</span><span class="op" id="7539692">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7539698">if</span>&nbsp;<span class="ident" id="7539701">err</span>&nbsp;<span class="op" id="7539705">!=</span>&nbsp;<span class="ident" id="7539708">nil</span>&nbsp;<span class="op" id="7539712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7539719">b</span><span class="op" id="7539720">.</span><span class="ident" id="7539721">Errorf</span><span class="op" id="7539727">(</span><span class="string" id="7539728">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7539746">,</span>&nbsp;<span class="ident" id="7539748">err</span><span class="op" id="7539751">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7539758">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7539769">}</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7539774">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7539778">}</span><span class="op" id="7539779">(</span><span class="ident" id="7539780">clients</span><span class="op" id="7539787">[</span><span class="ident" id="7539788">p</span><span class="op" id="7539789">]</span><span class="op" id="7539790">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7539795">//&nbsp;Pipe&nbsp;between&nbsp;server&nbsp;reader&nbsp;and&nbsp;server&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7539846">pipe</span>&nbsp;<span class="op" id="7539851">:=</span>&nbsp;<span class="builtinfunc" id="7539854">make</span><span class="op" id="7539858">(</span><span class="keyword" id="7539859">chan</span>&nbsp;<span class="builtintype" id="7539864">byte</span><span class="op" id="7539868">,</span>&nbsp;<span class="num" id="7539870">128</span><span class="op" id="7539873">)</span><br>
<span class="lineno">235</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7539878">//&nbsp;Server&nbsp;reader.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7539898">go</span>&nbsp;<span class="keyword" id="7539901">func</span><span class="op" id="7539905">(</span><span class="ident" id="7539906">s</span>&nbsp;<span class="ident" id="7539908">Conn</span><span class="op" id="7539912">)</span>&nbsp;<span class="op" id="7539914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7539919">defer</span>&nbsp;<span class="ident" id="7539925">wg</span><span class="op" id="7539927">.</span><span class="ident" id="7539928">Done</span><span class="op" id="7539932">(</span><span class="op" id="7539933">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7539938">var</span>&nbsp;<span class="ident" id="7539942">buf</span>&nbsp;<span class="op" id="7539946">[</span><span class="num" id="7539947">1</span><span class="op" id="7539948">]</span><span class="builtintype" id="7539949">byte</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7539957">for</span>&nbsp;<span class="ident" id="7539961">i</span>&nbsp;<span class="op" id="7539963">:=</span>&nbsp;<span class="num" id="7539966">0</span><span class="op" id="7539967">;</span>&nbsp;<span class="ident" id="7539969">i</span>&nbsp;<span class="op" id="7539971">&lt;</span>&nbsp;<span class="ident" id="7539973">N</span><span class="op" id="7539974">;</span>&nbsp;<span class="ident" id="7539976">i</span><span class="op" id="7539977">++</span>&nbsp;<span class="op" id="7539980">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7539986">_</span><span class="op" id="7539987">,</span>&nbsp;<span class="ident" id="7539989">err</span>&nbsp;<span class="op" id="7539993">:=</span>&nbsp;<span class="ident" id="7539996">s</span><span class="op" id="7539997">.</span><span class="ident" id="7539998">Read</span><span class="op" id="7540002">(</span><span class="ident" id="7540003">buf</span><span class="op" id="7540006">[</span><span class="op" id="7540007">:</span><span class="op" id="7540008">]</span><span class="op" id="7540009">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7540015">if</span>&nbsp;<span class="ident" id="7540018">err</span>&nbsp;<span class="op" id="7540022">!=</span>&nbsp;<span class="ident" id="7540025">nil</span>&nbsp;<span class="op" id="7540029">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7540036">b</span><span class="op" id="7540037">.</span><span class="ident" id="7540038">Errorf</span><span class="op" id="7540044">(</span><span class="string" id="7540045">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7540062">,</span>&nbsp;<span class="ident" id="7540064">err</span><span class="op" id="7540067">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7540074">return</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7540085">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7540091">pipe</span>&nbsp;<span class="op" id="7540096">&lt;-</span>&nbsp;<span class="ident" id="7540099">buf</span><span class="op" id="7540102">[</span><span class="num" id="7540103">0</span><span class="op" id="7540104">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7540109">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7540113">}</span><span class="op" id="7540114">(</span><span class="ident" id="7540115">servers</span><span class="op" id="7540122">[</span><span class="ident" id="7540123">p</span><span class="op" id="7540124">]</span><span class="op" id="7540125">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">250</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7540130">//&nbsp;Server&nbsp;writer.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7540150">go</span>&nbsp;<span class="keyword" id="7540153">func</span><span class="op" id="7540157">(</span><span class="ident" id="7540158">s</span>&nbsp;<span class="ident" id="7540160">Conn</span><span class="op" id="7540164">)</span>&nbsp;<span class="op" id="7540166">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7540171">defer</span>&nbsp;<span class="ident" id="7540177">wg</span><span class="op" id="7540179">.</span><span class="ident" id="7540180">Done</span><span class="op" id="7540184">(</span><span class="op" id="7540185">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7540190">var</span>&nbsp;<span class="ident" id="7540194">buf</span>&nbsp;<span class="op" id="7540198">[</span><span class="num" id="7540199">1</span><span class="op" id="7540200">]</span><span class="builtintype" id="7540201">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7540209">for</span>&nbsp;<span class="ident" id="7540213">i</span>&nbsp;<span class="op" id="7540215">:=</span>&nbsp;<span class="num" id="7540218">0</span><span class="op" id="7540219">;</span>&nbsp;<span class="ident" id="7540221">i</span>&nbsp;<span class="op" id="7540223">&lt;</span>&nbsp;<span class="ident" id="7540225">N</span><span class="op" id="7540226">;</span>&nbsp;<span class="ident" id="7540228">i</span><span class="op" id="7540229">++</span>&nbsp;<span class="op" id="7540232">{</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7540238">v</span>&nbsp;<span class="op" id="7540240">:=</span>&nbsp;<span class="op" id="7540243">&lt;-</span><span class="ident" id="7540245">pipe</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7540254">for</span>&nbsp;<span class="ident" id="7540258">w</span>&nbsp;<span class="op" id="7540260">:=</span>&nbsp;<span class="num" id="7540263">0</span><span class="op" id="7540264">;</span>&nbsp;<span class="ident" id="7540266">w</span>&nbsp;<span class="op" id="7540268">&lt;</span>&nbsp;<span class="ident" id="7540270">W</span><span class="op" id="7540271">;</span>&nbsp;<span class="ident" id="7540273">w</span><span class="op" id="7540274">++</span>&nbsp;<span class="op" id="7540277">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7540284">v</span>&nbsp;<span class="op" id="7540286">*=</span>&nbsp;<span class="ident" id="7540289">v</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7540295">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7540301">buf</span><span class="op" id="7540304">[</span><span class="num" id="7540305">0</span><span class="op" id="7540306">]</span>&nbsp;<span class="op" id="7540308">=</span>&nbsp;<span class="ident" id="7540310">v</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7540316">_</span><span class="op" id="7540317">,</span>&nbsp;<span class="ident" id="7540319">err</span>&nbsp;<span class="op" id="7540323">:=</span>&nbsp;<span class="ident" id="7540326">s</span><span class="op" id="7540327">.</span><span class="ident" id="7540328">Write</span><span class="op" id="7540333">(</span><span class="ident" id="7540334">buf</span><span class="op" id="7540337">[</span><span class="op" id="7540338">:</span><span class="op" id="7540339">]</span><span class="op" id="7540340">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7540346">if</span>&nbsp;<span class="ident" id="7540349">err</span>&nbsp;<span class="op" id="7540353">!=</span>&nbsp;<span class="ident" id="7540356">nil</span>&nbsp;<span class="op" id="7540360">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7540367">b</span><span class="op" id="7540368">.</span><span class="ident" id="7540369">Errorf</span><span class="op" id="7540375">(</span><span class="string" id="7540376">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7540394">,</span>&nbsp;<span class="ident" id="7540396">err</span><span class="op" id="7540399">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7540406">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7540417">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7540422">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7540427">s</span><span class="op" id="7540428">.</span><span class="ident" id="7540429">Close</span><span class="op" id="7540434">(</span><span class="op" id="7540435">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7540439">}</span><span class="op" id="7540440">(</span><span class="ident" id="7540441">servers</span><span class="op" id="7540448">[</span><span class="ident" id="7540449">p</span><span class="op" id="7540450">]</span><span class="op" id="7540451">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7540456">//&nbsp;Client&nbsp;reader.</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7540476">go</span>&nbsp;<span class="keyword" id="7540479">func</span><span class="op" id="7540483">(</span><span class="ident" id="7540484">c</span>&nbsp;<span class="ident" id="7540486">Conn</span><span class="op" id="7540490">)</span>&nbsp;<span class="op" id="7540492">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7540497">defer</span>&nbsp;<span class="ident" id="7540503">wg</span><span class="op" id="7540505">.</span><span class="ident" id="7540506">Done</span><span class="op" id="7540510">(</span><span class="op" id="7540511">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7540516">var</span>&nbsp;<span class="ident" id="7540520">buf</span>&nbsp;<span class="op" id="7540524">[</span><span class="num" id="7540525">1</span><span class="op" id="7540526">]</span><span class="builtintype" id="7540527">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7540535">for</span>&nbsp;<span class="ident" id="7540539">i</span>&nbsp;<span class="op" id="7540541">:=</span>&nbsp;<span class="num" id="7540544">0</span><span class="op" id="7540545">;</span>&nbsp;<span class="ident" id="7540547">i</span>&nbsp;<span class="op" id="7540549">&lt;</span>&nbsp;<span class="ident" id="7540551">N</span><span class="op" id="7540552">;</span>&nbsp;<span class="ident" id="7540554">i</span><span class="op" id="7540555">++</span>&nbsp;<span class="op" id="7540558">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7540564">_</span><span class="op" id="7540565">,</span>&nbsp;<span class="ident" id="7540567">err</span>&nbsp;<span class="op" id="7540571">:=</span>&nbsp;<span class="ident" id="7540574">c</span><span class="op" id="7540575">.</span><span class="ident" id="7540576">Read</span><span class="op" id="7540580">(</span><span class="ident" id="7540581">buf</span><span class="op" id="7540584">[</span><span class="op" id="7540585">:</span><span class="op" id="7540586">]</span><span class="op" id="7540587">)</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7540593">if</span>&nbsp;<span class="ident" id="7540596">err</span>&nbsp;<span class="op" id="7540600">!=</span>&nbsp;<span class="ident" id="7540603">nil</span>&nbsp;<span class="op" id="7540607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7540614">b</span><span class="op" id="7540615">.</span><span class="ident" id="7540616">Errorf</span><span class="op" id="7540622">(</span><span class="string" id="7540623">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7540640">,</span>&nbsp;<span class="ident" id="7540642">err</span><span class="op" id="7540645">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7540652">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7540663">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7540668">}</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7540673">c</span><span class="op" id="7540674">.</span><span class="ident" id="7540675">Close</span><span class="op" id="7540680">(</span><span class="op" id="7540681">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7540685">}</span><span class="op" id="7540686">(</span><span class="ident" id="7540687">clients</span><span class="op" id="7540694">[</span><span class="ident" id="7540695">p</span><span class="op" id="7540696">]</span><span class="op" id="7540697">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7540700">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7540703">wg</span><span class="op" id="7540705">.</span><span class="ident" id="7540706">Wait</span><span class="op" id="7540710">(</span><span class="op" id="7540711">)</span><br>
<span class="lineno"></span><span class="op" id="7540713">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="keyword" id="7540716">type</span>&nbsp;<span class="ident" id="7540721">resolveTCPAddrTest</span>&nbsp;<span class="keyword" id="7540740">struct</span>&nbsp;<span class="op" id="7540747">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7540750">net</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7540764">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7540772">litAddrOrName</span>&nbsp;<span class="builtintype" id="7540786">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7540794">addr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="7540808">*</span><span class="ident" id="7540809">TCPAddr</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7540818">err</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7540832">error</span><br>
<span class="lineno"></span><span class="op" id="7540838">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7540841">var</span>&nbsp;<span class="ident" id="7540845">resolveTCPAddrTests</span>&nbsp;<span class="op" id="7540865">=</span>&nbsp;<span class="op" id="7540867">[</span><span class="op" id="7540868">]</span><span class="ident" id="7540869">resolveTCPAddrTest</span><span class="op" id="7540887">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7540890">{</span><span class="string" id="7540891">&#34;tcp&#34;</span><span class="op" id="7540896">,</span>&nbsp;<span class="string" id="7540898">&#34;127.0.0.1:0&#34;</span><span class="op" id="7540911">,</span>&nbsp;<span class="op" id="7540913">&amp;</span><span class="ident" id="7540914">TCPAddr</span><span class="op" id="7540921">{</span><span class="ident" id="7540922">IP</span><span class="op" id="7540924">:</span>&nbsp;<span class="ident" id="7540926">IPv4</span><span class="op" id="7540930">(</span><span class="num" id="7540931">127</span><span class="op" id="7540934">,</span>&nbsp;<span class="num" id="7540936">0</span><span class="op" id="7540937">,</span>&nbsp;<span class="num" id="7540939">0</span><span class="op" id="7540940">,</span>&nbsp;<span class="num" id="7540942">1</span><span class="op" id="7540943">)</span><span class="op" id="7540944">,</span>&nbsp;<span class="ident" id="7540946">Port</span><span class="op" id="7540950">:</span>&nbsp;<span class="num" id="7540952">0</span><span class="op" id="7540953">}</span><span class="op" id="7540954">,</span>&nbsp;<span class="ident" id="7540956">nil</span><span class="op" id="7540959">}</span><span class="op" id="7540960">,</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7540963">{</span><span class="string" id="7540964">&#34;tcp4&#34;</span><span class="op" id="7540970">,</span>&nbsp;<span class="string" id="7540972">&#34;127.0.0.1:65535&#34;</span><span class="op" id="7540989">,</span>&nbsp;<span class="op" id="7540991">&amp;</span><span class="ident" id="7540992">TCPAddr</span><span class="op" id="7540999">{</span><span class="ident" id="7541000">IP</span><span class="op" id="7541002">:</span>&nbsp;<span class="ident" id="7541004">IPv4</span><span class="op" id="7541008">(</span><span class="num" id="7541009">127</span><span class="op" id="7541012">,</span>&nbsp;<span class="num" id="7541014">0</span><span class="op" id="7541015">,</span>&nbsp;<span class="num" id="7541017">0</span><span class="op" id="7541018">,</span>&nbsp;<span class="num" id="7541020">1</span><span class="op" id="7541021">)</span><span class="op" id="7541022">,</span>&nbsp;<span class="ident" id="7541024">Port</span><span class="op" id="7541028">:</span>&nbsp;<span class="num" id="7541030">65535</span><span class="op" id="7541035">}</span><span class="op" id="7541036">,</span>&nbsp;<span class="ident" id="7541038">nil</span><span class="op" id="7541041">}</span><span class="op" id="7541042">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7541046">{</span><span class="string" id="7541047">&#34;tcp&#34;</span><span class="op" id="7541052">,</span>&nbsp;<span class="string" id="7541054">&#34;[::1]:1&#34;</span><span class="op" id="7541063">,</span>&nbsp;<span class="op" id="7541065">&amp;</span><span class="ident" id="7541066">TCPAddr</span><span class="op" id="7541073">{</span><span class="ident" id="7541074">IP</span><span class="op" id="7541076">:</span>&nbsp;<span class="ident" id="7541078">ParseIP</span><span class="op" id="7541085">(</span><span class="string" id="7541086">&#34;::1&#34;</span><span class="op" id="7541091">)</span><span class="op" id="7541092">,</span>&nbsp;<span class="ident" id="7541094">Port</span><span class="op" id="7541098">:</span>&nbsp;<span class="num" id="7541100">1</span><span class="op" id="7541101">}</span><span class="op" id="7541102">,</span>&nbsp;<span class="ident" id="7541104">nil</span><span class="op" id="7541107">}</span><span class="op" id="7541108">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7541111">{</span><span class="string" id="7541112">&#34;tcp6&#34;</span><span class="op" id="7541118">,</span>&nbsp;<span class="string" id="7541120">&#34;[::1]:65534&#34;</span><span class="op" id="7541133">,</span>&nbsp;<span class="op" id="7541135">&amp;</span><span class="ident" id="7541136">TCPAddr</span><span class="op" id="7541143">{</span><span class="ident" id="7541144">IP</span><span class="op" id="7541146">:</span>&nbsp;<span class="ident" id="7541148">ParseIP</span><span class="op" id="7541155">(</span><span class="string" id="7541156">&#34;::1&#34;</span><span class="op" id="7541161">)</span><span class="op" id="7541162">,</span>&nbsp;<span class="ident" id="7541164">Port</span><span class="op" id="7541168">:</span>&nbsp;<span class="num" id="7541170">65534</span><span class="op" id="7541175">}</span><span class="op" id="7541176">,</span>&nbsp;<span class="ident" id="7541178">nil</span><span class="op" id="7541181">}</span><span class="op" id="7541182">,</span><br>
<span class="lineno"></span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7541186">{</span><span class="string" id="7541187">&#34;tcp&#34;</span><span class="op" id="7541192">,</span>&nbsp;<span class="string" id="7541194">&#34;[::1%en0]:1&#34;</span><span class="op" id="7541207">,</span>&nbsp;<span class="op" id="7541209">&amp;</span><span class="ident" id="7541210">TCPAddr</span><span class="op" id="7541217">{</span><span class="ident" id="7541218">IP</span><span class="op" id="7541220">:</span>&nbsp;<span class="ident" id="7541222">ParseIP</span><span class="op" id="7541229">(</span><span class="string" id="7541230">&#34;::1&#34;</span><span class="op" id="7541235">)</span><span class="op" id="7541236">,</span>&nbsp;<span class="ident" id="7541238">Port</span><span class="op" id="7541242">:</span>&nbsp;<span class="num" id="7541244">1</span><span class="op" id="7541245">,</span>&nbsp;<span class="ident" id="7541247">Zone</span><span class="op" id="7541251">:</span>&nbsp;<span class="string" id="7541253">&#34;en0&#34;</span><span class="op" id="7541258">}</span><span class="op" id="7541259">,</span>&nbsp;<span class="ident" id="7541261">nil</span><span class="op" id="7541264">}</span><span class="op" id="7541265">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7541268">{</span><span class="string" id="7541269">&#34;tcp6&#34;</span><span class="op" id="7541275">,</span>&nbsp;<span class="string" id="7541277">&#34;[::1%911]:2&#34;</span><span class="op" id="7541290">,</span>&nbsp;<span class="op" id="7541292">&amp;</span><span class="ident" id="7541293">TCPAddr</span><span class="op" id="7541300">{</span><span class="ident" id="7541301">IP</span><span class="op" id="7541303">:</span>&nbsp;<span class="ident" id="7541305">ParseIP</span><span class="op" id="7541312">(</span><span class="string" id="7541313">&#34;::1&#34;</span><span class="op" id="7541318">)</span><span class="op" id="7541319">,</span>&nbsp;<span class="ident" id="7541321">Port</span><span class="op" id="7541325">:</span>&nbsp;<span class="num" id="7541327">2</span><span class="op" id="7541328">,</span>&nbsp;<span class="ident" id="7541330">Zone</span><span class="op" id="7541334">:</span>&nbsp;<span class="string" id="7541336">&#34;911&#34;</span><span class="op" id="7541341">}</span><span class="op" id="7541342">,</span>&nbsp;<span class="ident" id="7541344">nil</span><span class="op" id="7541347">}</span><span class="op" id="7541348">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7541352">{</span><span class="string" id="7541353">&#34;&#34;</span><span class="op" id="7541355">,</span>&nbsp;<span class="string" id="7541357">&#34;127.0.0.1:0&#34;</span><span class="op" id="7541370">,</span>&nbsp;<span class="op" id="7541372">&amp;</span><span class="ident" id="7541373">TCPAddr</span><span class="op" id="7541380">{</span><span class="ident" id="7541381">IP</span><span class="op" id="7541383">:</span>&nbsp;<span class="ident" id="7541385">IPv4</span><span class="op" id="7541389">(</span><span class="num" id="7541390">127</span><span class="op" id="7541393">,</span>&nbsp;<span class="num" id="7541395">0</span><span class="op" id="7541396">,</span>&nbsp;<span class="num" id="7541398">0</span><span class="op" id="7541399">,</span>&nbsp;<span class="num" id="7541401">1</span><span class="op" id="7541402">)</span><span class="op" id="7541403">,</span>&nbsp;<span class="ident" id="7541405">Port</span><span class="op" id="7541409">:</span>&nbsp;<span class="num" id="7541411">0</span><span class="op" id="7541412">}</span><span class="op" id="7541413">,</span>&nbsp;<span class="ident" id="7541415">nil</span><span class="op" id="7541418">}</span><span class="op" id="7541419">,</span>&nbsp;<span class="comment" id="7541421">//&nbsp;Go&nbsp;1.0&nbsp;behavior</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7541441">{</span><span class="string" id="7541442">&#34;&#34;</span><span class="op" id="7541444">,</span>&nbsp;<span class="string" id="7541446">&#34;[::1]:0&#34;</span><span class="op" id="7541455">,</span>&nbsp;<span class="op" id="7541457">&amp;</span><span class="ident" id="7541458">TCPAddr</span><span class="op" id="7541465">{</span><span class="ident" id="7541466">IP</span><span class="op" id="7541468">:</span>&nbsp;<span class="ident" id="7541470">ParseIP</span><span class="op" id="7541477">(</span><span class="string" id="7541478">&#34;::1&#34;</span><span class="op" id="7541483">)</span><span class="op" id="7541484">,</span>&nbsp;<span class="ident" id="7541486">Port</span><span class="op" id="7541490">:</span>&nbsp;<span class="num" id="7541492">0</span><span class="op" id="7541493">}</span><span class="op" id="7541494">,</span>&nbsp;<span class="ident" id="7541496">nil</span><span class="op" id="7541499">}</span><span class="op" id="7541500">,</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="7541510">//&nbsp;Go&nbsp;1.0&nbsp;behavior</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7541531">{</span><span class="string" id="7541532">&#34;tcp&#34;</span><span class="op" id="7541537">,</span>&nbsp;<span class="string" id="7541539">&#34;:12345&#34;</span><span class="op" id="7541547">,</span>&nbsp;<span class="op" id="7541549">&amp;</span><span class="ident" id="7541550">TCPAddr</span><span class="op" id="7541557">{</span><span class="ident" id="7541558">Port</span><span class="op" id="7541562">:</span>&nbsp;<span class="num" id="7541564">12345</span><span class="op" id="7541569">}</span><span class="op" id="7541570">,</span>&nbsp;<span class="ident" id="7541572">nil</span><span class="op" id="7541575">}</span><span class="op" id="7541576">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7541580">{</span><span class="string" id="7541581">&#34;http&#34;</span><span class="op" id="7541587">,</span>&nbsp;<span class="string" id="7541589">&#34;127.0.0.1:0&#34;</span><span class="op" id="7541602">,</span>&nbsp;<span class="ident" id="7541604">nil</span><span class="op" id="7541607">,</span>&nbsp;<span class="ident" id="7541609">UnknownNetworkError</span><span class="op" id="7541628">(</span><span class="string" id="7541629">&#34;http&#34;</span><span class="op" id="7541635">)</span><span class="op" id="7541636">}</span><span class="op" id="7541637">,</span><br>
<span class="lineno"></span><span class="op" id="7541639">}</span><br>
<span class="lineno">310</span><br>
<span class="lineno"></span><span class="keyword" id="7541642">func</span>&nbsp;<span class="ident" id="7541647">init</span><span class="op" id="7541651">(</span><span class="op" id="7541652">)</span>&nbsp;<span class="op" id="7541654">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7541657">if</span>&nbsp;<span class="ident" id="7541660">ifi</span>&nbsp;<span class="op" id="7541664">:=</span>&nbsp;<span class="ident" id="7541667">loopbackInterface</span><span class="op" id="7541684">(</span><span class="op" id="7541685">)</span><span class="op" id="7541686">;</span>&nbsp;<span class="ident" id="7541688">ifi</span>&nbsp;<span class="op" id="7541692">!=</span>&nbsp;<span class="ident" id="7541695">nil</span>&nbsp;<span class="op" id="7541699">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7541703">index</span>&nbsp;<span class="op" id="7541709">:=</span>&nbsp;<span class="ident" id="7541712">fmt</span><span class="op" id="7541715">.</span><span class="ident" id="7541716">Sprintf</span><span class="op" id="7541723">(</span><span class="string" id="7541724">&#34;%v&#34;</span><span class="op" id="7541728">,</span>&nbsp;<span class="ident" id="7541730">ifi</span><span class="op" id="7541733">.</span><span class="ident" id="7541734">Index</span><span class="op" id="7541739">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7541743">resolveTCPAddrTests</span>&nbsp;<span class="op" id="7541763">=</span>&nbsp;<span class="builtinfunc" id="7541765">append</span><span class="op" id="7541771">(</span><span class="ident" id="7541772">resolveTCPAddrTests</span><span class="op" id="7541791">,</span>&nbsp;<span class="op" id="7541793">[</span><span class="op" id="7541794">]</span><span class="ident" id="7541795">resolveTCPAddrTest</span><span class="op" id="7541813">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7541818">{</span><span class="string" id="7541819">&#34;tcp6&#34;</span><span class="op" id="7541825">,</span>&nbsp;<span class="string" id="7541827">&#34;[fe80::1%&#34;</span>&nbsp;<span class="op" id="7541839">+</span>&nbsp;<span class="ident" id="7541841">ifi</span><span class="op" id="7541844">.</span><span class="ident" id="7541845">Name</span>&nbsp;<span class="op" id="7541850">+</span>&nbsp;<span class="string" id="7541852">&#34;]:3&#34;</span><span class="op" id="7541857">,</span>&nbsp;<span class="op" id="7541859">&amp;</span><span class="ident" id="7541860">TCPAddr</span><span class="op" id="7541867">{</span><span class="ident" id="7541868">IP</span><span class="op" id="7541870">:</span>&nbsp;<span class="ident" id="7541872">ParseIP</span><span class="op" id="7541879">(</span><span class="string" id="7541880">&#34;fe80::1&#34;</span><span class="op" id="7541889">)</span><span class="op" id="7541890">,</span>&nbsp;<span class="ident" id="7541892">Port</span><span class="op" id="7541896">:</span>&nbsp;<span class="num" id="7541898">3</span><span class="op" id="7541899">,</span>&nbsp;<span class="ident" id="7541901">Zone</span><span class="op" id="7541905">:</span>&nbsp;<span class="ident" id="7541907">zoneToString</span><span class="op" id="7541919">(</span><span class="ident" id="7541920">ifi</span><span class="op" id="7541923">.</span><span class="ident" id="7541924">Index</span><span class="op" id="7541929">)</span><span class="op" id="7541930">}</span><span class="op" id="7541931">,</span>&nbsp;<span class="ident" id="7541933">nil</span><span class="op" id="7541936">}</span><span class="op" id="7541937">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7541942">{</span><span class="string" id="7541943">&#34;tcp6&#34;</span><span class="op" id="7541949">,</span>&nbsp;<span class="string" id="7541951">&#34;[fe80::1%&#34;</span>&nbsp;<span class="op" id="7541963">+</span>&nbsp;<span class="ident" id="7541965">index</span>&nbsp;<span class="op" id="7541971">+</span>&nbsp;<span class="string" id="7541973">&#34;]:4&#34;</span><span class="op" id="7541978">,</span>&nbsp;<span class="op" id="7541980">&amp;</span><span class="ident" id="7541981">TCPAddr</span><span class="op" id="7541988">{</span><span class="ident" id="7541989">IP</span><span class="op" id="7541991">:</span>&nbsp;<span class="ident" id="7541993">ParseIP</span><span class="op" id="7542000">(</span><span class="string" id="7542001">&#34;fe80::1&#34;</span><span class="op" id="7542010">)</span><span class="op" id="7542011">,</span>&nbsp;<span class="ident" id="7542013">Port</span><span class="op" id="7542017">:</span>&nbsp;<span class="num" id="7542019">4</span><span class="op" id="7542020">,</span>&nbsp;<span class="ident" id="7542022">Zone</span><span class="op" id="7542026">:</span>&nbsp;<span class="ident" id="7542028">index</span><span class="op" id="7542033">}</span><span class="op" id="7542034">,</span>&nbsp;<span class="ident" id="7542036">nil</span><span class="op" id="7542039">}</span><span class="op" id="7542040">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7542044">}</span><span class="op" id="7542045">...</span><span class="op" id="7542048">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7542051">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7542054">if</span>&nbsp;<span class="ident" id="7542057">ips</span><span class="op" id="7542060">,</span>&nbsp;<span class="ident" id="7542062">err</span>&nbsp;<span class="op" id="7542066">:=</span>&nbsp;<span class="ident" id="7542069">LookupIP</span><span class="op" id="7542077">(</span><span class="string" id="7542078">&#34;localhost&#34;</span><span class="op" id="7542089">)</span><span class="op" id="7542090">;</span>&nbsp;<span class="ident" id="7542092">err</span>&nbsp;<span class="op" id="7542096">==</span>&nbsp;<span class="ident" id="7542099">nil</span>&nbsp;<span class="op" id="7542103">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="7542106">len</span><span class="op" id="7542109">(</span><span class="ident" id="7542110">ips</span><span class="op" id="7542113">)</span>&nbsp;<span class="op" id="7542115">&gt;</span>&nbsp;<span class="num" id="7542117">1</span>&nbsp;<span class="op" id="7542119">&amp;&amp;</span>&nbsp;<span class="ident" id="7542122">supportsIPv4</span>&nbsp;<span class="op" id="7542135">&amp;&amp;</span>&nbsp;<span class="ident" id="7542138">supportsIPv6</span>&nbsp;<span class="op" id="7542151">{</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7542155">resolveTCPAddrTests</span>&nbsp;<span class="op" id="7542175">=</span>&nbsp;<span class="builtinfunc" id="7542177">append</span><span class="op" id="7542183">(</span><span class="ident" id="7542184">resolveTCPAddrTests</span><span class="op" id="7542203">,</span>&nbsp;<span class="op" id="7542205">[</span><span class="op" id="7542206">]</span><span class="ident" id="7542207">resolveTCPAddrTest</span><span class="op" id="7542225">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7542230">{</span><span class="string" id="7542231">&#34;tcp&#34;</span><span class="op" id="7542236">,</span>&nbsp;<span class="string" id="7542238">&#34;localhost:5&#34;</span><span class="op" id="7542251">,</span>&nbsp;<span class="op" id="7542253">&amp;</span><span class="ident" id="7542254">TCPAddr</span><span class="op" id="7542261">{</span><span class="ident" id="7542262">IP</span><span class="op" id="7542264">:</span>&nbsp;<span class="ident" id="7542266">IPv4</span><span class="op" id="7542270">(</span><span class="num" id="7542271">127</span><span class="op" id="7542274">,</span>&nbsp;<span class="num" id="7542276">0</span><span class="op" id="7542277">,</span>&nbsp;<span class="num" id="7542279">0</span><span class="op" id="7542280">,</span>&nbsp;<span class="num" id="7542282">1</span><span class="op" id="7542283">)</span><span class="op" id="7542284">,</span>&nbsp;<span class="ident" id="7542286">Port</span><span class="op" id="7542290">:</span>&nbsp;<span class="num" id="7542292">5</span><span class="op" id="7542293">}</span><span class="op" id="7542294">,</span>&nbsp;<span class="ident" id="7542296">nil</span><span class="op" id="7542299">}</span><span class="op" id="7542300">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7542305">{</span><span class="string" id="7542306">&#34;tcp4&#34;</span><span class="op" id="7542312">,</span>&nbsp;<span class="string" id="7542314">&#34;localhost:6&#34;</span><span class="op" id="7542327">,</span>&nbsp;<span class="op" id="7542329">&amp;</span><span class="ident" id="7542330">TCPAddr</span><span class="op" id="7542337">{</span><span class="ident" id="7542338">IP</span><span class="op" id="7542340">:</span>&nbsp;<span class="ident" id="7542342">IPv4</span><span class="op" id="7542346">(</span><span class="num" id="7542347">127</span><span class="op" id="7542350">,</span>&nbsp;<span class="num" id="7542352">0</span><span class="op" id="7542353">,</span>&nbsp;<span class="num" id="7542355">0</span><span class="op" id="7542356">,</span>&nbsp;<span class="num" id="7542358">1</span><span class="op" id="7542359">)</span><span class="op" id="7542360">,</span>&nbsp;<span class="ident" id="7542362">Port</span><span class="op" id="7542366">:</span>&nbsp;<span class="num" id="7542368">6</span><span class="op" id="7542369">}</span><span class="op" id="7542370">,</span>&nbsp;<span class="ident" id="7542372">nil</span><span class="op" id="7542375">}</span><span class="op" id="7542376">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7542381">{</span><span class="string" id="7542382">&#34;tcp6&#34;</span><span class="op" id="7542388">,</span>&nbsp;<span class="string" id="7542390">&#34;localhost:7&#34;</span><span class="op" id="7542403">,</span>&nbsp;<span class="op" id="7542405">&amp;</span><span class="ident" id="7542406">TCPAddr</span><span class="op" id="7542413">{</span><span class="ident" id="7542414">IP</span><span class="op" id="7542416">:</span>&nbsp;<span class="ident" id="7542418">IPv6loopback</span><span class="op" id="7542430">,</span>&nbsp;<span class="ident" id="7542432">Port</span><span class="op" id="7542436">:</span>&nbsp;<span class="num" id="7542438">7</span><span class="op" id="7542439">}</span><span class="op" id="7542440">,</span>&nbsp;<span class="ident" id="7542442">nil</span><span class="op" id="7542445">}</span><span class="op" id="7542446">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7542450">}</span><span class="op" id="7542451">...</span><span class="op" id="7542454">)</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7542457">}</span><br>
<span class="lineno"></span><span class="op" id="7542459">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7542462">func</span>&nbsp;<span class="ident" id="7542467">TestResolveTCPAddr</span><span class="op" id="7542485">(</span><span class="ident" id="7542486">t</span>&nbsp;<span class="op" id="7542488">*</span><span class="ident" id="7542489">testing</span><span class="op" id="7542496">.</span><span class="ident" id="7542497">T</span><span class="op" id="7542498">)</span>&nbsp;<span class="op" id="7542500">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7542503">for</span>&nbsp;<span class="ident" id="7542507">_</span><span class="op" id="7542508">,</span>&nbsp;<span class="ident" id="7542510">tt</span>&nbsp;<span class="op" id="7542513">:=</span>&nbsp;<span class="keyword" id="7542516">range</span>&nbsp;<span class="ident" id="7542522">resolveTCPAddrTests</span>&nbsp;<span class="op" id="7542542">{</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7542546">addr</span><span class="op" id="7542550">,</span>&nbsp;<span class="ident" id="7542552">err</span>&nbsp;<span class="op" id="7542556">:=</span>&nbsp;<span class="ident" id="7542559">ResolveTCPAddr</span><span class="op" id="7542573">(</span><span class="ident" id="7542574">tt</span><span class="op" id="7542576">.</span><span class="ident" id="7542577">net</span><span class="op" id="7542580">,</span>&nbsp;<span class="ident" id="7542582">tt</span><span class="op" id="7542584">.</span><span class="ident" id="7542585">litAddrOrName</span><span class="op" id="7542598">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7542602">if</span>&nbsp;<span class="ident" id="7542605">err</span>&nbsp;<span class="op" id="7542609">!=</span>&nbsp;<span class="ident" id="7542612">tt</span><span class="op" id="7542614">.</span><span class="ident" id="7542615">err</span>&nbsp;<span class="op" id="7542619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7542624">t</span><span class="op" id="7542625">.</span><span class="ident" id="7542626">Fatalf</span><span class="op" id="7542632">(</span><span class="string" id="7542633">&#34;ResolveTCPAddr(%q,&nbsp;%q)&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7542668">,</span>&nbsp;<span class="ident" id="7542670">tt</span><span class="op" id="7542672">.</span><span class="ident" id="7542673">net</span><span class="op" id="7542676">,</span>&nbsp;<span class="ident" id="7542678">tt</span><span class="op" id="7542680">.</span><span class="ident" id="7542681">litAddrOrName</span><span class="op" id="7542694">,</span>&nbsp;<span class="ident" id="7542696">err</span><span class="op" id="7542699">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7542703">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7542707">if</span>&nbsp;<span class="op" id="7542710">!</span><span class="ident" id="7542711">reflect</span><span class="op" id="7542718">.</span><span class="ident" id="7542719">DeepEqual</span><span class="op" id="7542728">(</span><span class="ident" id="7542729">addr</span><span class="op" id="7542733">,</span>&nbsp;<span class="ident" id="7542735">tt</span><span class="op" id="7542737">.</span><span class="ident" id="7542738">addr</span><span class="op" id="7542742">)</span>&nbsp;<span class="op" id="7542744">{</span><br>
<span class="lineno">335</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7542749">t</span><span class="op" id="7542750">.</span><span class="ident" id="7542751">Fatalf</span><span class="op" id="7542757">(</span><span class="string" id="7542758">&#34;ResolveTCPAddr(%q,&nbsp;%q)&nbsp;=&nbsp;%#v,&nbsp;want&nbsp;%#v&#34;</span><span class="op" id="7542798">,</span>&nbsp;<span class="ident" id="7542800">tt</span><span class="op" id="7542802">.</span><span class="ident" id="7542803">net</span><span class="op" id="7542806">,</span>&nbsp;<span class="ident" id="7542808">tt</span><span class="op" id="7542810">.</span><span class="ident" id="7542811">litAddrOrName</span><span class="op" id="7542824">,</span>&nbsp;<span class="ident" id="7542826">addr</span><span class="op" id="7542830">,</span>&nbsp;<span class="ident" id="7542832">tt</span><span class="op" id="7542834">.</span><span class="ident" id="7542835">addr</span><span class="op" id="7542839">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7542843">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7542847">if</span>&nbsp;<span class="ident" id="7542850">err</span>&nbsp;<span class="op" id="7542854">==</span>&nbsp;<span class="ident" id="7542857">nil</span>&nbsp;<span class="op" id="7542861">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7542866">str</span>&nbsp;<span class="op" id="7542870">:=</span>&nbsp;<span class="ident" id="7542873">addr</span><span class="op" id="7542877">.</span><span class="ident" id="7542878">String</span><span class="op" id="7542884">(</span><span class="op" id="7542885">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7542890">addr1</span><span class="op" id="7542895">,</span>&nbsp;<span class="ident" id="7542897">err</span>&nbsp;<span class="op" id="7542901">:=</span>&nbsp;<span class="ident" id="7542904">ResolveTCPAddr</span><span class="op" id="7542918">(</span><span class="ident" id="7542919">tt</span><span class="op" id="7542921">.</span><span class="ident" id="7542922">net</span><span class="op" id="7542925">,</span>&nbsp;<span class="ident" id="7542927">str</span><span class="op" id="7542930">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7542935">if</span>&nbsp;<span class="ident" id="7542938">err</span>&nbsp;<span class="op" id="7542942">!=</span>&nbsp;<span class="ident" id="7542945">nil</span>&nbsp;<span class="op" id="7542949">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7542955">t</span><span class="op" id="7542956">.</span><span class="ident" id="7542957">Fatalf</span><span class="op" id="7542963">(</span><span class="string" id="7542964">&#34;ResolveTCPAddr(%q,&nbsp;%q)&nbsp;[from&nbsp;%q]:&nbsp;%v&#34;</span><span class="op" id="7543002">,</span>&nbsp;<span class="ident" id="7543004">tt</span><span class="op" id="7543006">.</span><span class="ident" id="7543007">net</span><span class="op" id="7543010">,</span>&nbsp;<span class="ident" id="7543012">str</span><span class="op" id="7543015">,</span>&nbsp;<span class="ident" id="7543017">tt</span><span class="op" id="7543019">.</span><span class="ident" id="7543020">litAddrOrName</span><span class="op" id="7543033">,</span>&nbsp;<span class="ident" id="7543035">err</span><span class="op" id="7543038">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7543043">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7543048">if</span>&nbsp;<span class="op" id="7543051">!</span><span class="ident" id="7543052">reflect</span><span class="op" id="7543059">.</span><span class="ident" id="7543060">DeepEqual</span><span class="op" id="7543069">(</span><span class="ident" id="7543070">addr1</span><span class="op" id="7543075">,</span>&nbsp;<span class="ident" id="7543077">addr</span><span class="op" id="7543081">)</span>&nbsp;<span class="op" id="7543083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7543089">t</span><span class="op" id="7543090">.</span><span class="ident" id="7543091">Fatalf</span><span class="op" id="7543097">(</span><span class="string" id="7543098">&#34;ResolveTCPAddr(%q,&nbsp;%q)&nbsp;[from&nbsp;%q]&nbsp;=&nbsp;%#v,&nbsp;want&nbsp;%#v&#34;</span><span class="op" id="7543148">,</span>&nbsp;<span class="ident" id="7543150">tt</span><span class="op" id="7543152">.</span><span class="ident" id="7543153">net</span><span class="op" id="7543156">,</span>&nbsp;<span class="ident" id="7543158">str</span><span class="op" id="7543161">,</span>&nbsp;<span class="ident" id="7543163">tt</span><span class="op" id="7543165">.</span><span class="ident" id="7543166">litAddrOrName</span><span class="op" id="7543179">,</span>&nbsp;<span class="ident" id="7543181">addr1</span><span class="op" id="7543186">,</span>&nbsp;<span class="ident" id="7543188">addr</span><span class="op" id="7543192">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7543197">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7543201">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7543204">}</span><br>
<span class="lineno"></span><span class="op" id="7543206">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">350</span><span class="keyword" id="7543209">var</span>&nbsp;<span class="ident" id="7543213">tcpListenerNameTests</span>&nbsp;<span class="op" id="7543234">=</span>&nbsp;<span class="op" id="7543236">[</span><span class="op" id="7543237">]</span><span class="keyword" id="7543238">struct</span>&nbsp;<span class="op" id="7543245">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7543248">net</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="7543254">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7543262">laddr</span>&nbsp;<span class="op" id="7543268">*</span><span class="ident" id="7543269">TCPAddr</span><br>
<span class="lineno"></span><span class="op" id="7543277">}</span><span class="op" id="7543278">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7543281">{</span><span class="string" id="7543282">&#34;tcp4&#34;</span><span class="op" id="7543288">,</span>&nbsp;<span class="op" id="7543290">&amp;</span><span class="ident" id="7543291">TCPAddr</span><span class="op" id="7543298">{</span><span class="ident" id="7543299">IP</span><span class="op" id="7543301">:</span>&nbsp;<span class="ident" id="7543303">IPv4</span><span class="op" id="7543307">(</span><span class="num" id="7543308">127</span><span class="op" id="7543311">,</span>&nbsp;<span class="num" id="7543313">0</span><span class="op" id="7543314">,</span>&nbsp;<span class="num" id="7543316">0</span><span class="op" id="7543317">,</span>&nbsp;<span class="num" id="7543319">1</span><span class="op" id="7543320">)</span><span class="op" id="7543321">}</span><span class="op" id="7543322">}</span><span class="op" id="7543323">,</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7543326">{</span><span class="string" id="7543327">&#34;tcp4&#34;</span><span class="op" id="7543333">,</span>&nbsp;<span class="op" id="7543335">&amp;</span><span class="ident" id="7543336">TCPAddr</span><span class="op" id="7543343">{</span><span class="op" id="7543344">}</span><span class="op" id="7543345">}</span><span class="op" id="7543346">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7543349">{</span><span class="string" id="7543350">&#34;tcp4&#34;</span><span class="op" id="7543356">,</span>&nbsp;<span class="ident" id="7543358">nil</span><span class="op" id="7543361">}</span><span class="op" id="7543362">,</span><br>
<span class="lineno"></span><span class="op" id="7543364">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7543367">func</span>&nbsp;<span class="ident" id="7543372">TestTCPListenerName</span><span class="op" id="7543391">(</span><span class="ident" id="7543392">t</span>&nbsp;<span class="op" id="7543394">*</span><span class="ident" id="7543395">testing</span><span class="op" id="7543402">.</span><span class="ident" id="7543403">T</span><span class="op" id="7543404">)</span>&nbsp;<span class="op" id="7543406">{</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7543409">if</span>&nbsp;<span class="ident" id="7543412">testing</span><span class="op" id="7543419">.</span><span class="ident" id="7543420">Short</span><span class="op" id="7543425">(</span><span class="op" id="7543426">)</span>&nbsp;<span class="op" id="7543428">||</span>&nbsp;<span class="op" id="7543431">!</span><span class="op" id="7543432">*</span><span class="ident" id="7543433">testExternal</span>&nbsp;<span class="op" id="7543446">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7543450">t</span><span class="op" id="7543451">.</span><span class="ident" id="7543452">Skip</span><span class="op" id="7543456">(</span><span class="string" id="7543457">&#34;skipping&nbsp;test&nbsp;to&nbsp;avoid&nbsp;external&nbsp;network&#34;</span><span class="op" id="7543498">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7543501">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7543505">for</span>&nbsp;<span class="ident" id="7543509">_</span><span class="op" id="7543510">,</span>&nbsp;<span class="ident" id="7543512">tt</span>&nbsp;<span class="op" id="7543515">:=</span>&nbsp;<span class="keyword" id="7543518">range</span>&nbsp;<span class="ident" id="7543524">tcpListenerNameTests</span>&nbsp;<span class="op" id="7543545">{</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7543549">ln</span><span class="op" id="7543551">,</span>&nbsp;<span class="ident" id="7543553">err</span>&nbsp;<span class="op" id="7543557">:=</span>&nbsp;<span class="ident" id="7543560">ListenTCP</span><span class="op" id="7543569">(</span><span class="ident" id="7543570">tt</span><span class="op" id="7543572">.</span><span class="ident" id="7543573">net</span><span class="op" id="7543576">,</span>&nbsp;<span class="ident" id="7543578">tt</span><span class="op" id="7543580">.</span><span class="ident" id="7543581">laddr</span><span class="op" id="7543586">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7543590">if</span>&nbsp;<span class="ident" id="7543593">err</span>&nbsp;<span class="op" id="7543597">!=</span>&nbsp;<span class="ident" id="7543600">nil</span>&nbsp;<span class="op" id="7543604">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7543609">t</span><span class="op" id="7543610">.</span><span class="ident" id="7543611">Fatalf</span><span class="op" id="7543617">(</span><span class="string" id="7543618">&#34;ListenTCP&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7543640">,</span>&nbsp;<span class="ident" id="7543642">err</span><span class="op" id="7543645">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7543649">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7543653">defer</span>&nbsp;<span class="ident" id="7543659">ln</span><span class="op" id="7543661">.</span><span class="ident" id="7543662">Close</span><span class="op" id="7543667">(</span><span class="op" id="7543668">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7543672">la</span>&nbsp;<span class="op" id="7543675">:=</span>&nbsp;<span class="ident" id="7543678">ln</span><span class="op" id="7543680">.</span><span class="ident" id="7543681">Addr</span><span class="op" id="7543685">(</span><span class="op" id="7543686">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7543690">if</span>&nbsp;<span class="ident" id="7543693">a</span><span class="op" id="7543694">,</span>&nbsp;<span class="ident" id="7543696">ok</span>&nbsp;<span class="op" id="7543699">:=</span>&nbsp;<span class="ident" id="7543702">la</span><span class="op" id="7543704">.</span><span class="op" id="7543705">(</span><span class="op" id="7543706">*</span><span class="ident" id="7543707">TCPAddr</span><span class="op" id="7543714">)</span><span class="op" id="7543715">;</span>&nbsp;<span class="op" id="7543717">!</span><span class="ident" id="7543718">ok</span>&nbsp;<span class="op" id="7543721">||</span>&nbsp;<span class="ident" id="7543724">a</span><span class="op" id="7543725">.</span><span class="ident" id="7543726">Port</span>&nbsp;<span class="op" id="7543731">==</span>&nbsp;<span class="num" id="7543734">0</span>&nbsp;<span class="op" id="7543736">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7543741">t</span><span class="op" id="7543742">.</span><span class="ident" id="7543743">Fatalf</span><span class="op" id="7543749">(</span><span class="string" id="7543750">&#34;got&nbsp;%v;&nbsp;expected&nbsp;a&nbsp;proper&nbsp;address&nbsp;with&nbsp;non-zero&nbsp;port&nbsp;number&#34;</span><span class="op" id="7543811">,</span>&nbsp;<span class="ident" id="7543813">la</span><span class="op" id="7543815">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7543819">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7543822">}</span><br>
<span class="lineno">375</span><span class="op" id="7543824">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7543827">func</span>&nbsp;<span class="ident" id="7543832">TestIPv6LinkLocalUnicastTCP</span><span class="op" id="7543859">(</span><span class="ident" id="7543860">t</span>&nbsp;<span class="op" id="7543862">*</span><span class="ident" id="7543863">testing</span><span class="op" id="7543870">.</span><span class="ident" id="7543871">T</span><span class="op" id="7543872">)</span>&nbsp;<span class="op" id="7543874">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7543877">if</span>&nbsp;<span class="ident" id="7543880">testing</span><span class="op" id="7543887">.</span><span class="ident" id="7543888">Short</span><span class="op" id="7543893">(</span><span class="op" id="7543894">)</span>&nbsp;<span class="op" id="7543896">||</span>&nbsp;<span class="op" id="7543899">!</span><span class="op" id="7543900">*</span><span class="ident" id="7543901">testExternal</span>&nbsp;<span class="op" id="7543914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7543918">t</span><span class="op" id="7543919">.</span><span class="ident" id="7543920">Skip</span><span class="op" id="7543924">(</span><span class="string" id="7543925">&#34;skipping&nbsp;test&nbsp;to&nbsp;avoid&nbsp;external&nbsp;network&#34;</span><span class="op" id="7543966">)</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7543969">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7543972">if</span>&nbsp;<span class="op" id="7543975">!</span><span class="ident" id="7543976">supportsIPv6</span>&nbsp;<span class="op" id="7543989">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7543993">t</span><span class="op" id="7543994">.</span><span class="ident" id="7543995">Skip</span><span class="op" id="7543999">(</span><span class="string" id="7544000">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op" id="7544023">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7544026">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7544029">ifi</span>&nbsp;<span class="op" id="7544033">:=</span>&nbsp;<span class="ident" id="7544036">loopbackInterface</span><span class="op" id="7544053">(</span><span class="op" id="7544054">)</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7544057">if</span>&nbsp;<span class="ident" id="7544060">ifi</span>&nbsp;<span class="op" id="7544064">==</span>&nbsp;<span class="ident" id="7544067">nil</span>&nbsp;<span class="op" id="7544071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7544075">t</span><span class="op" id="7544076">.</span><span class="ident" id="7544077">Skip</span><span class="op" id="7544081">(</span><span class="string" id="7544082">&#34;loopback&nbsp;interface&nbsp;not&nbsp;found&#34;</span><span class="op" id="7544112">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7544115">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7544118">laddr</span>&nbsp;<span class="op" id="7544124">:=</span>&nbsp;<span class="ident" id="7544127">ipv6LinkLocalUnicastAddr</span><span class="op" id="7544151">(</span><span class="ident" id="7544152">ifi</span><span class="op" id="7544155">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7544158">if</span>&nbsp;<span class="ident" id="7544161">laddr</span>&nbsp;<span class="op" id="7544167">==</span>&nbsp;<span class="string" id="7544170">&#34;&#34;</span>&nbsp;<span class="op" id="7544173">{</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7544177">t</span><span class="op" id="7544178">.</span><span class="ident" id="7544179">Skip</span><span class="op" id="7544183">(</span><span class="string" id="7544184">&#34;ipv6&nbsp;unicast&nbsp;address&nbsp;on&nbsp;loopback&nbsp;not&nbsp;found&#34;</span><span class="op" id="7544228">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7544231">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7544235">type</span>&nbsp;<span class="ident" id="7544240">test</span>&nbsp;<span class="keyword" id="7544245">struct</span>&nbsp;<span class="op" id="7544252">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7544256">net</span><span class="op" id="7544259">,</span>&nbsp;<span class="ident" id="7544261">addr</span>&nbsp;&nbsp;<span class="builtintype" id="7544267">string</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7544276">nameLookup</span>&nbsp;<span class="builtintype" id="7544287">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7544293">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7544296">var</span>&nbsp;<span class="ident" id="7544300">tests</span>&nbsp;<span class="op" id="7544306">=</span>&nbsp;<span class="op" id="7544308">[</span><span class="op" id="7544309">]</span><span class="ident" id="7544310">test</span><span class="op" id="7544314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7544318">{</span><span class="string" id="7544319">&#34;tcp&#34;</span><span class="op" id="7544324">,</span>&nbsp;<span class="string" id="7544326">&#34;[&#34;</span>&nbsp;<span class="op" id="7544330">+</span>&nbsp;<span class="ident" id="7544332">laddr</span>&nbsp;<span class="op" id="7544338">+</span>&nbsp;<span class="string" id="7544340">&#34;%&#34;</span>&nbsp;<span class="op" id="7544344">+</span>&nbsp;<span class="ident" id="7544346">ifi</span><span class="op" id="7544349">.</span><span class="ident" id="7544350">Name</span>&nbsp;<span class="op" id="7544355">+</span>&nbsp;<span class="string" id="7544357">&#34;]:0&#34;</span><span class="op" id="7544362">,</span>&nbsp;<span class="ident" id="7544364">false</span><span class="op" id="7544369">}</span><span class="op" id="7544370">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7544374">{</span><span class="string" id="7544375">&#34;tcp6&#34;</span><span class="op" id="7544381">,</span>&nbsp;<span class="string" id="7544383">&#34;[&#34;</span>&nbsp;<span class="op" id="7544387">+</span>&nbsp;<span class="ident" id="7544389">laddr</span>&nbsp;<span class="op" id="7544395">+</span>&nbsp;<span class="string" id="7544397">&#34;%&#34;</span>&nbsp;<span class="op" id="7544401">+</span>&nbsp;<span class="ident" id="7544403">ifi</span><span class="op" id="7544406">.</span><span class="ident" id="7544407">Name</span>&nbsp;<span class="op" id="7544412">+</span>&nbsp;<span class="string" id="7544414">&#34;]:0&#34;</span><span class="op" id="7544419">,</span>&nbsp;<span class="ident" id="7544421">false</span><span class="op" id="7544426">}</span><span class="op" id="7544427">,</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7544430">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7544433">switch</span>&nbsp;<span class="ident" id="7544440">runtime</span><span class="op" id="7544447">.</span><span class="ident" id="7544448">GOOS</span>&nbsp;<span class="op" id="7544453">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7544456">case</span>&nbsp;<span class="string" id="7544461">&#34;darwin&#34;</span><span class="op" id="7544469">,</span>&nbsp;<span class="string" id="7544471">&#34;freebsd&#34;</span><span class="op" id="7544480">,</span>&nbsp;<span class="string" id="7544482">&#34;openbsd&#34;</span><span class="op" id="7544491">,</span>&nbsp;<span class="string" id="7544493">&#34;netbsd&#34;</span><span class="op" id="7544501">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7544505">tests</span>&nbsp;<span class="op" id="7544511">=</span>&nbsp;<span class="builtinfunc" id="7544513">append</span><span class="op" id="7544519">(</span><span class="ident" id="7544520">tests</span><span class="op" id="7544525">,</span>&nbsp;<span class="op" id="7544527">[</span><span class="op" id="7544528">]</span><span class="ident" id="7544529">test</span><span class="op" id="7544533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7544538">{</span><span class="string" id="7544539">&#34;tcp&#34;</span><span class="op" id="7544544">,</span>&nbsp;<span class="string" id="7544546">&#34;[localhost%&#34;</span>&nbsp;<span class="op" id="7544560">+</span>&nbsp;<span class="ident" id="7544562">ifi</span><span class="op" id="7544565">.</span><span class="ident" id="7544566">Name</span>&nbsp;<span class="op" id="7544571">+</span>&nbsp;<span class="string" id="7544573">&#34;]:0&#34;</span><span class="op" id="7544578">,</span>&nbsp;<span class="ident" id="7544580">true</span><span class="op" id="7544584">}</span><span class="op" id="7544585">,</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7544590">{</span><span class="string" id="7544591">&#34;tcp6&#34;</span><span class="op" id="7544597">,</span>&nbsp;<span class="string" id="7544599">&#34;[localhost%&#34;</span>&nbsp;<span class="op" id="7544613">+</span>&nbsp;<span class="ident" id="7544615">ifi</span><span class="op" id="7544618">.</span><span class="ident" id="7544619">Name</span>&nbsp;<span class="op" id="7544624">+</span>&nbsp;<span class="string" id="7544626">&#34;]:0&#34;</span><span class="op" id="7544631">,</span>&nbsp;<span class="ident" id="7544633">true</span><span class="op" id="7544637">}</span><span class="op" id="7544638">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7544642">}</span><span class="op" id="7544643">...</span><span class="op" id="7544646">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7544649">case</span>&nbsp;<span class="string" id="7544654">&#34;linux&#34;</span><span class="op" id="7544661">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7544665">tests</span>&nbsp;<span class="op" id="7544671">=</span>&nbsp;<span class="builtinfunc" id="7544673">append</span><span class="op" id="7544679">(</span><span class="ident" id="7544680">tests</span><span class="op" id="7544685">,</span>&nbsp;<span class="op" id="7544687">[</span><span class="op" id="7544688">]</span><span class="ident" id="7544689">test</span><span class="op" id="7544693">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7544698">{</span><span class="string" id="7544699">&#34;tcp&#34;</span><span class="op" id="7544704">,</span>&nbsp;<span class="string" id="7544706">&#34;[ip6-localhost%&#34;</span>&nbsp;<span class="op" id="7544724">+</span>&nbsp;<span class="ident" id="7544726">ifi</span><span class="op" id="7544729">.</span><span class="ident" id="7544730">Name</span>&nbsp;<span class="op" id="7544735">+</span>&nbsp;<span class="string" id="7544737">&#34;]:0&#34;</span><span class="op" id="7544742">,</span>&nbsp;<span class="ident" id="7544744">true</span><span class="op" id="7544748">}</span><span class="op" id="7544749">,</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7544754">{</span><span class="string" id="7544755">&#34;tcp6&#34;</span><span class="op" id="7544761">,</span>&nbsp;<span class="string" id="7544763">&#34;[ip6-localhost%&#34;</span>&nbsp;<span class="op" id="7544781">+</span>&nbsp;<span class="ident" id="7544783">ifi</span><span class="op" id="7544786">.</span><span class="ident" id="7544787">Name</span>&nbsp;<span class="op" id="7544792">+</span>&nbsp;<span class="string" id="7544794">&#34;]:0&#34;</span><span class="op" id="7544799">,</span>&nbsp;<span class="ident" id="7544801">true</span><span class="op" id="7544805">}</span><span class="op" id="7544806">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7544810">}</span><span class="op" id="7544811">...</span><span class="op" id="7544814">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7544817">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7544820">for</span>&nbsp;<span class="ident" id="7544824">_</span><span class="op" id="7544825">,</span>&nbsp;<span class="ident" id="7544827">tt</span>&nbsp;<span class="op" id="7544830">:=</span>&nbsp;<span class="keyword" id="7544833">range</span>&nbsp;<span class="ident" id="7544839">tests</span>&nbsp;<span class="op" id="7544845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7544849">ln</span><span class="op" id="7544851">,</span>&nbsp;<span class="ident" id="7544853">err</span>&nbsp;<span class="op" id="7544857">:=</span>&nbsp;<span class="ident" id="7544860">Listen</span><span class="op" id="7544866">(</span><span class="ident" id="7544867">tt</span><span class="op" id="7544869">.</span><span class="ident" id="7544870">net</span><span class="op" id="7544873">,</span>&nbsp;<span class="ident" id="7544875">tt</span><span class="op" id="7544877">.</span><span class="ident" id="7544878">addr</span><span class="op" id="7544882">)</span><br>
<span class="lineno">415</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7544886">if</span>&nbsp;<span class="ident" id="7544889">err</span>&nbsp;<span class="op" id="7544893">!=</span>&nbsp;<span class="ident" id="7544896">nil</span>&nbsp;<span class="op" id="7544900">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7544905">//&nbsp;It&nbsp;might&nbsp;return&nbsp;&#34;LookupHost&nbsp;returned&nbsp;no</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7544951">//&nbsp;suitable&nbsp;address&#34;&nbsp;error&nbsp;on&nbsp;some&nbsp;platforms.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7545000">t</span><span class="op" id="7545001">.</span><span class="ident" id="7545002">Logf</span><span class="op" id="7545006">(</span><span class="string" id="7545007">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7545026">,</span>&nbsp;<span class="ident" id="7545028">err</span><span class="op" id="7545031">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7545036">continue</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7545047">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7545051">defer</span>&nbsp;<span class="ident" id="7545057">ln</span><span class="op" id="7545059">.</span><span class="ident" id="7545060">Close</span><span class="op" id="7545065">(</span><span class="op" id="7545066">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7545070">if</span>&nbsp;<span class="ident" id="7545073">la</span><span class="op" id="7545075">,</span>&nbsp;<span class="ident" id="7545077">ok</span>&nbsp;<span class="op" id="7545080">:=</span>&nbsp;<span class="ident" id="7545083">ln</span><span class="op" id="7545085">.</span><span class="ident" id="7545086">Addr</span><span class="op" id="7545090">(</span><span class="op" id="7545091">)</span><span class="op" id="7545092">.</span><span class="op" id="7545093">(</span><span class="op" id="7545094">*</span><span class="ident" id="7545095">TCPAddr</span><span class="op" id="7545102">)</span><span class="op" id="7545103">;</span>&nbsp;<span class="op" id="7545105">!</span><span class="ident" id="7545106">ok</span>&nbsp;<span class="op" id="7545109">||</span>&nbsp;<span class="op" id="7545112">!</span><span class="ident" id="7545113">tt</span><span class="op" id="7545115">.</span><span class="ident" id="7545116">nameLookup</span>&nbsp;<span class="op" id="7545127">&amp;&amp;</span>&nbsp;<span class="ident" id="7545130">la</span><span class="op" id="7545132">.</span><span class="ident" id="7545133">Zone</span>&nbsp;<span class="op" id="7545138">==</span>&nbsp;<span class="string" id="7545141">&#34;&#34;</span>&nbsp;<span class="op" id="7545144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7545149">t</span><span class="op" id="7545150">.</span><span class="ident" id="7545151">Fatalf</span><span class="op" id="7545157">(</span><span class="string" id="7545158">&#34;got&nbsp;%v;&nbsp;expected&nbsp;a&nbsp;proper&nbsp;address&nbsp;with&nbsp;zone&nbsp;identifier&#34;</span><span class="op" id="7545214">,</span>&nbsp;<span class="ident" id="7545216">la</span><span class="op" id="7545218">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7545222">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7545227">done</span>&nbsp;<span class="op" id="7545232">:=</span>&nbsp;<span class="builtinfunc" id="7545235">make</span><span class="op" id="7545239">(</span><span class="keyword" id="7545240">chan</span>&nbsp;<span class="builtintype" id="7545245">int</span><span class="op" id="7545248">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7545252">go</span>&nbsp;<span class="ident" id="7545255">transponder</span><span class="op" id="7545266">(</span><span class="ident" id="7545267">t</span><span class="op" id="7545268">,</span>&nbsp;<span class="ident" id="7545270">ln</span><span class="op" id="7545272">,</span>&nbsp;<span class="ident" id="7545274">done</span><span class="op" id="7545278">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7545283">c</span><span class="op" id="7545284">,</span>&nbsp;<span class="ident" id="7545286">err</span>&nbsp;<span class="op" id="7545290">:=</span>&nbsp;<span class="ident" id="7545293">Dial</span><span class="op" id="7545297">(</span><span class="ident" id="7545298">tt</span><span class="op" id="7545300">.</span><span class="ident" id="7545301">net</span><span class="op" id="7545304">,</span>&nbsp;<span class="ident" id="7545306">ln</span><span class="op" id="7545308">.</span><span class="ident" id="7545309">Addr</span><span class="op" id="7545313">(</span><span class="op" id="7545314">)</span><span class="op" id="7545315">.</span><span class="ident" id="7545316">String</span><span class="op" id="7545322">(</span><span class="op" id="7545323">)</span><span class="op" id="7545324">)</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7545328">if</span>&nbsp;<span class="ident" id="7545331">err</span>&nbsp;<span class="op" id="7545335">!=</span>&nbsp;<span class="ident" id="7545338">nil</span>&nbsp;<span class="op" id="7545342">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7545347">t</span><span class="op" id="7545348">.</span><span class="ident" id="7545349">Fatalf</span><span class="op" id="7545355">(</span><span class="string" id="7545356">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7545373">,</span>&nbsp;<span class="ident" id="7545375">err</span><span class="op" id="7545378">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7545382">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7545386">defer</span>&nbsp;<span class="ident" id="7545392">c</span><span class="op" id="7545393">.</span><span class="ident" id="7545394">Close</span><span class="op" id="7545399">(</span><span class="op" id="7545400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7545404">if</span>&nbsp;<span class="ident" id="7545407">la</span><span class="op" id="7545409">,</span>&nbsp;<span class="ident" id="7545411">ok</span>&nbsp;<span class="op" id="7545414">:=</span>&nbsp;<span class="ident" id="7545417">c</span><span class="op" id="7545418">.</span><span class="ident" id="7545419">LocalAddr</span><span class="op" id="7545428">(</span><span class="op" id="7545429">)</span><span class="op" id="7545430">.</span><span class="op" id="7545431">(</span><span class="op" id="7545432">*</span><span class="ident" id="7545433">TCPAddr</span><span class="op" id="7545440">)</span><span class="op" id="7545441">;</span>&nbsp;<span class="op" id="7545443">!</span><span class="ident" id="7545444">ok</span>&nbsp;<span class="op" id="7545447">||</span>&nbsp;<span class="op" id="7545450">!</span><span class="ident" id="7545451">tt</span><span class="op" id="7545453">.</span><span class="ident" id="7545454">nameLookup</span>&nbsp;<span class="op" id="7545465">&amp;&amp;</span>&nbsp;<span class="ident" id="7545468">la</span><span class="op" id="7545470">.</span><span class="ident" id="7545471">Zone</span>&nbsp;<span class="op" id="7545476">==</span>&nbsp;<span class="string" id="7545479">&#34;&#34;</span>&nbsp;<span class="op" id="7545482">{</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7545487">t</span><span class="op" id="7545488">.</span><span class="ident" id="7545489">Fatalf</span><span class="op" id="7545495">(</span><span class="string" id="7545496">&#34;got&nbsp;%v;&nbsp;expected&nbsp;a&nbsp;proper&nbsp;address&nbsp;with&nbsp;zone&nbsp;identifier&#34;</span><span class="op" id="7545552">,</span>&nbsp;<span class="ident" id="7545554">la</span><span class="op" id="7545556">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7545560">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7545564">if</span>&nbsp;<span class="ident" id="7545567">ra</span><span class="op" id="7545569">,</span>&nbsp;<span class="ident" id="7545571">ok</span>&nbsp;<span class="op" id="7545574">:=</span>&nbsp;<span class="ident" id="7545577">c</span><span class="op" id="7545578">.</span><span class="ident" id="7545579">RemoteAddr</span><span class="op" id="7545589">(</span><span class="op" id="7545590">)</span><span class="op" id="7545591">.</span><span class="op" id="7545592">(</span><span class="op" id="7545593">*</span><span class="ident" id="7545594">TCPAddr</span><span class="op" id="7545601">)</span><span class="op" id="7545602">;</span>&nbsp;<span class="op" id="7545604">!</span><span class="ident" id="7545605">ok</span>&nbsp;<span class="op" id="7545608">||</span>&nbsp;<span class="op" id="7545611">!</span><span class="ident" id="7545612">tt</span><span class="op" id="7545614">.</span><span class="ident" id="7545615">nameLookup</span>&nbsp;<span class="op" id="7545626">&amp;&amp;</span>&nbsp;<span class="ident" id="7545629">ra</span><span class="op" id="7545631">.</span><span class="ident" id="7545632">Zone</span>&nbsp;<span class="op" id="7545637">==</span>&nbsp;<span class="string" id="7545640">&#34;&#34;</span>&nbsp;<span class="op" id="7545643">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7545648">t</span><span class="op" id="7545649">.</span><span class="ident" id="7545650">Fatalf</span><span class="op" id="7545656">(</span><span class="string" id="7545657">&#34;got&nbsp;%v;&nbsp;expected&nbsp;a&nbsp;proper&nbsp;address&nbsp;with&nbsp;zone&nbsp;identifier&#34;</span><span class="op" id="7545713">,</span>&nbsp;<span class="ident" id="7545715">ra</span><span class="op" id="7545717">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7545721">}</span><br>
<span class="lineno">440</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7545726">if</span>&nbsp;<span class="ident" id="7545729">_</span><span class="op" id="7545730">,</span>&nbsp;<span class="ident" id="7545732">err</span>&nbsp;<span class="op" id="7545736">:=</span>&nbsp;<span class="ident" id="7545739">c</span><span class="op" id="7545740">.</span><span class="ident" id="7545741">Write</span><span class="op" id="7545746">(</span><span class="op" id="7545747">[</span><span class="op" id="7545748">]</span><span class="builtintype" id="7545749">byte</span><span class="op" id="7545753">(</span><span class="string" id="7545754">&#34;TCP&nbsp;OVER&nbsp;IPV6&nbsp;LINKLOCAL&nbsp;TEST&#34;</span><span class="op" id="7545784">)</span><span class="op" id="7545785">)</span><span class="op" id="7545786">;</span>&nbsp;<span class="ident" id="7545788">err</span>&nbsp;<span class="op" id="7545792">!=</span>&nbsp;<span class="ident" id="7545795">nil</span>&nbsp;<span class="op" id="7545799">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7545804">t</span><span class="op" id="7545805">.</span><span class="ident" id="7545806">Fatalf</span><span class="op" id="7545812">(</span><span class="string" id="7545813">&#34;Conn.Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7545836">,</span>&nbsp;<span class="ident" id="7545838">err</span><span class="op" id="7545841">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7545845">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7545849">b</span>&nbsp;<span class="op" id="7545851">:=</span>&nbsp;<span class="builtinfunc" id="7545854">make</span><span class="op" id="7545858">(</span><span class="op" id="7545859">[</span><span class="op" id="7545860">]</span><span class="builtintype" id="7545861">byte</span><span class="op" id="7545865">,</span>&nbsp;<span class="num" id="7545867">32</span><span class="op" id="7545869">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7545873">if</span>&nbsp;<span class="ident" id="7545876">_</span><span class="op" id="7545877">,</span>&nbsp;<span class="ident" id="7545879">err</span>&nbsp;<span class="op" id="7545883">:=</span>&nbsp;<span class="ident" id="7545886">c</span><span class="op" id="7545887">.</span><span class="ident" id="7545888">Read</span><span class="op" id="7545892">(</span><span class="ident" id="7545893">b</span><span class="op" id="7545894">)</span><span class="op" id="7545895">;</span>&nbsp;<span class="ident" id="7545897">err</span>&nbsp;<span class="op" id="7545901">!=</span>&nbsp;<span class="ident" id="7545904">nil</span>&nbsp;<span class="op" id="7545908">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7545913">t</span><span class="op" id="7545914">.</span><span class="ident" id="7545915">Fatalf</span><span class="op" id="7545921">(</span><span class="string" id="7545922">&#34;Conn.Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7545944">,</span>&nbsp;<span class="ident" id="7545946">err</span><span class="op" id="7545949">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7545953">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7545958">&lt;-</span><span class="ident" id="7545960">done</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7545966">}</span><br>
<span class="lineno"></span><span class="op" id="7545968">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="7545971">func</span>&nbsp;<span class="ident" id="7545976">TestTCPConcurrentAccept</span><span class="op" id="7545999">(</span><span class="ident" id="7546000">t</span>&nbsp;<span class="op" id="7546002">*</span><span class="ident" id="7546003">testing</span><span class="op" id="7546010">.</span><span class="ident" id="7546011">T</span><span class="op" id="7546012">)</span>&nbsp;<span class="op" id="7546014">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7546017">defer</span>&nbsp;<span class="ident" id="7546023">runtime</span><span class="op" id="7546030">.</span><span class="ident" id="7546031">GOMAXPROCS</span><span class="op" id="7546041">(</span><span class="ident" id="7546042">runtime</span><span class="op" id="7546049">.</span><span class="ident" id="7546050">GOMAXPROCS</span><span class="op" id="7546060">(</span><span class="num" id="7546061">4</span><span class="op" id="7546062">)</span><span class="op" id="7546063">)</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7546066">ln</span><span class="op" id="7546068">,</span>&nbsp;<span class="ident" id="7546070">err</span>&nbsp;<span class="op" id="7546074">:=</span>&nbsp;<span class="ident" id="7546077">Listen</span><span class="op" id="7546083">(</span><span class="string" id="7546084">&#34;tcp&#34;</span><span class="op" id="7546089">,</span>&nbsp;<span class="string" id="7546091">&#34;127.0.0.1:0&#34;</span><span class="op" id="7546104">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7546107">if</span>&nbsp;<span class="ident" id="7546110">err</span>&nbsp;<span class="op" id="7546114">!=</span>&nbsp;<span class="ident" id="7546117">nil</span>&nbsp;<span class="op" id="7546121">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7546125">t</span><span class="op" id="7546126">.</span><span class="ident" id="7546127">Fatalf</span><span class="op" id="7546133">(</span><span class="string" id="7546134">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7546153">,</span>&nbsp;<span class="ident" id="7546155">err</span><span class="op" id="7546158">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7546161">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7546164">const</span>&nbsp;<span class="ident" id="7546170">N</span>&nbsp;<span class="op" id="7546172">=</span>&nbsp;<span class="num" id="7546174">10</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7546178">var</span>&nbsp;<span class="ident" id="7546182">wg</span>&nbsp;<span class="ident" id="7546185">sync</span><span class="op" id="7546189">.</span><span class="ident" id="7546190">WaitGroup</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7546201">wg</span><span class="op" id="7546203">.</span><span class="ident" id="7546204">Add</span><span class="op" id="7546207">(</span><span class="ident" id="7546208">N</span><span class="op" id="7546209">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7546212">for</span>&nbsp;<span class="ident" id="7546216">i</span>&nbsp;<span class="op" id="7546218">:=</span>&nbsp;<span class="num" id="7546221">0</span><span class="op" id="7546222">;</span>&nbsp;<span class="ident" id="7546224">i</span>&nbsp;<span class="op" id="7546226">&lt;</span>&nbsp;<span class="ident" id="7546228">N</span><span class="op" id="7546229">;</span>&nbsp;<span class="ident" id="7546231">i</span><span class="op" id="7546232">++</span>&nbsp;<span class="op" id="7546235">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7546239">go</span>&nbsp;<span class="keyword" id="7546242">func</span><span class="op" id="7546246">(</span><span class="op" id="7546247">)</span>&nbsp;<span class="op" id="7546249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7546254">for</span>&nbsp;<span class="op" id="7546258">{</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7546264">c</span><span class="op" id="7546265">,</span>&nbsp;<span class="ident" id="7546267">err</span>&nbsp;<span class="op" id="7546271">:=</span>&nbsp;<span class="ident" id="7546274">ln</span><span class="op" id="7546276">.</span><span class="ident" id="7546277">Accept</span><span class="op" id="7546283">(</span><span class="op" id="7546284">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7546290">if</span>&nbsp;<span class="ident" id="7546293">err</span>&nbsp;<span class="op" id="7546297">!=</span>&nbsp;<span class="ident" id="7546300">nil</span>&nbsp;<span class="op" id="7546304">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7546311">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7546321">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7546327">c</span><span class="op" id="7546328">.</span><span class="ident" id="7546329">Close</span><span class="op" id="7546334">(</span><span class="op" id="7546335">)</span><br>
<span class="lineno">470</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7546340">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7546345">wg</span><span class="op" id="7546347">.</span><span class="ident" id="7546348">Done</span><span class="op" id="7546352">(</span><span class="op" id="7546353">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7546357">}</span><span class="op" id="7546358">(</span><span class="op" id="7546359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7546362">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7546365">attempts</span>&nbsp;<span class="op" id="7546374">:=</span>&nbsp;<span class="num" id="7546377">10</span>&nbsp;<span class="op" id="7546380">*</span>&nbsp;<span class="ident" id="7546382">N</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7546385">fails</span>&nbsp;<span class="op" id="7546391">:=</span>&nbsp;<span class="num" id="7546394">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7546397">d</span>&nbsp;<span class="op" id="7546399">:=</span>&nbsp;<span class="op" id="7546402">&amp;</span><span class="ident" id="7546403">Dialer</span><span class="op" id="7546409">{</span><span class="ident" id="7546410">Timeout</span><span class="op" id="7546417">:</span>&nbsp;<span class="num" id="7546419">200</span>&nbsp;<span class="op" id="7546423">*</span>&nbsp;<span class="ident" id="7546425">time</span><span class="op" id="7546429">.</span><span class="ident" id="7546430">Millisecond</span><span class="op" id="7546441">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7546444">for</span>&nbsp;<span class="ident" id="7546448">i</span>&nbsp;<span class="op" id="7546450">:=</span>&nbsp;<span class="num" id="7546453">0</span><span class="op" id="7546454">;</span>&nbsp;<span class="ident" id="7546456">i</span>&nbsp;<span class="op" id="7546458">&lt;</span>&nbsp;<span class="ident" id="7546460">attempts</span><span class="op" id="7546468">;</span>&nbsp;<span class="ident" id="7546470">i</span><span class="op" id="7546471">++</span>&nbsp;<span class="op" id="7546474">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7546478">c</span><span class="op" id="7546479">,</span>&nbsp;<span class="ident" id="7546481">err</span>&nbsp;<span class="op" id="7546485">:=</span>&nbsp;<span class="ident" id="7546488">d</span><span class="op" id="7546489">.</span><span class="ident" id="7546490">Dial</span><span class="op" id="7546494">(</span><span class="string" id="7546495">&#34;tcp&#34;</span><span class="op" id="7546500">,</span>&nbsp;<span class="ident" id="7546502">ln</span><span class="op" id="7546504">.</span><span class="ident" id="7546505">Addr</span><span class="op" id="7546509">(</span><span class="op" id="7546510">)</span><span class="op" id="7546511">.</span><span class="ident" id="7546512">String</span><span class="op" id="7546518">(</span><span class="op" id="7546519">)</span><span class="op" id="7546520">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7546524">if</span>&nbsp;<span class="ident" id="7546527">err</span>&nbsp;<span class="op" id="7546531">!=</span>&nbsp;<span class="ident" id="7546534">nil</span>&nbsp;<span class="op" id="7546538">{</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7546543">fails</span><span class="op" id="7546548">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7546553">}</span>&nbsp;<span class="keyword" id="7546555">else</span>&nbsp;<span class="op" id="7546560">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7546565">c</span><span class="op" id="7546566">.</span><span class="ident" id="7546567">Close</span><span class="op" id="7546572">(</span><span class="op" id="7546573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7546577">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7546580">}</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7546583">ln</span><span class="op" id="7546585">.</span><span class="ident" id="7546586">Close</span><span class="op" id="7546591">(</span><span class="op" id="7546592">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7546595">wg</span><span class="op" id="7546597">.</span><span class="ident" id="7546598">Wait</span><span class="op" id="7546602">(</span><span class="op" id="7546603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7546606">if</span>&nbsp;<span class="ident" id="7546609">fails</span>&nbsp;<span class="op" id="7546615">&gt;</span>&nbsp;<span class="ident" id="7546617">attempts</span><span class="op" id="7546625">/</span><span class="num" id="7546626">9</span>&nbsp;<span class="op" id="7546628">{</span>&nbsp;<span class="comment" id="7546630">//&nbsp;see&nbsp;issues&nbsp;7400&nbsp;and&nbsp;7541</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7546660">t</span><span class="op" id="7546661">.</span><span class="ident" id="7546662">Fatalf</span><span class="op" id="7546668">(</span><span class="string" id="7546669">&#34;too&nbsp;many&nbsp;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7546695">,</span>&nbsp;<span class="ident" id="7546697">fails</span><span class="op" id="7546702">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7546705">}</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7546708">if</span>&nbsp;<span class="ident" id="7546711">fails</span>&nbsp;<span class="op" id="7546717">&gt;</span>&nbsp;<span class="num" id="7546719">0</span>&nbsp;<span class="op" id="7546721">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7546725">t</span><span class="op" id="7546726">.</span><span class="ident" id="7546727">Logf</span><span class="op" id="7546731">(</span><span class="string" id="7546732">&#34;#&nbsp;of&nbsp;failed&nbsp;Dials:&nbsp;%v&#34;</span><span class="op" id="7546755">,</span>&nbsp;<span class="ident" id="7546757">fails</span><span class="op" id="7546762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7546765">}</span><br>
<span class="lineno"></span><span class="op" id="7546767">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">495</span><span class="keyword" id="7546770">func</span>&nbsp;<span class="ident" id="7546775">TestTCPReadWriteMallocs</span><span class="op" id="7546798">(</span><span class="ident" id="7546799">t</span>&nbsp;<span class="op" id="7546801">*</span><span class="ident" id="7546802">testing</span><span class="op" id="7546809">.</span><span class="ident" id="7546810">T</span><span class="op" id="7546811">)</span>&nbsp;<span class="op" id="7546813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7546816">if</span>&nbsp;<span class="ident" id="7546819">testing</span><span class="op" id="7546826">.</span><span class="ident" id="7546827">Short</span><span class="op" id="7546832">(</span><span class="op" id="7546833">)</span>&nbsp;<span class="op" id="7546835">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7546839">t</span><span class="op" id="7546840">.</span><span class="ident" id="7546841">Skip</span><span class="op" id="7546845">(</span><span class="string" id="7546846">&#34;skipping&nbsp;malloc&nbsp;count&nbsp;in&nbsp;short&nbsp;mode&#34;</span><span class="op" id="7546883">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7546886">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7546889">ln</span><span class="op" id="7546891">,</span>&nbsp;<span class="ident" id="7546893">err</span>&nbsp;<span class="op" id="7546897">:=</span>&nbsp;<span class="ident" id="7546900">Listen</span><span class="op" id="7546906">(</span><span class="string" id="7546907">&#34;tcp&#34;</span><span class="op" id="7546912">,</span>&nbsp;<span class="string" id="7546914">&#34;127.0.0.1:0&#34;</span><span class="op" id="7546927">)</span><br>
<span class="lineno">500</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7546930">if</span>&nbsp;<span class="ident" id="7546933">err</span>&nbsp;<span class="op" id="7546937">!=</span>&nbsp;<span class="ident" id="7546940">nil</span>&nbsp;<span class="op" id="7546944">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7546948">t</span><span class="op" id="7546949">.</span><span class="ident" id="7546950">Fatalf</span><span class="op" id="7546956">(</span><span class="string" id="7546957">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7546976">,</span>&nbsp;<span class="ident" id="7546978">err</span><span class="op" id="7546981">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7546984">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7546987">defer</span>&nbsp;<span class="ident" id="7546993">ln</span><span class="op" id="7546995">.</span><span class="ident" id="7546996">Close</span><span class="op" id="7547001">(</span><span class="op" id="7547002">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7547005">var</span>&nbsp;<span class="ident" id="7547009">server</span>&nbsp;<span class="ident" id="7547016">Conn</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7547022">errc</span>&nbsp;<span class="op" id="7547027">:=</span>&nbsp;<span class="builtinfunc" id="7547030">make</span><span class="op" id="7547034">(</span><span class="keyword" id="7547035">chan</span>&nbsp;<span class="builtintype" id="7547040">error</span><span class="op" id="7547045">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7547048">go</span>&nbsp;<span class="keyword" id="7547051">func</span><span class="op" id="7547055">(</span><span class="op" id="7547056">)</span>&nbsp;<span class="op" id="7547058">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7547062">var</span>&nbsp;<span class="ident" id="7547066">err</span>&nbsp;<span class="builtintype" id="7547070">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7547078">server</span><span class="op" id="7547084">,</span>&nbsp;<span class="ident" id="7547086">err</span>&nbsp;<span class="op" id="7547090">=</span>&nbsp;<span class="ident" id="7547092">ln</span><span class="op" id="7547094">.</span><span class="ident" id="7547095">Accept</span><span class="op" id="7547101">(</span><span class="op" id="7547102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7547106">errc</span>&nbsp;<span class="op" id="7547111">&lt;-</span>&nbsp;<span class="ident" id="7547114">err</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7547119">}</span><span class="op" id="7547120">(</span><span class="op" id="7547121">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7547124">client</span><span class="op" id="7547130">,</span>&nbsp;<span class="ident" id="7547132">err</span>&nbsp;<span class="op" id="7547136">:=</span>&nbsp;<span class="ident" id="7547139">Dial</span><span class="op" id="7547143">(</span><span class="string" id="7547144">&#34;tcp&#34;</span><span class="op" id="7547149">,</span>&nbsp;<span class="ident" id="7547151">ln</span><span class="op" id="7547153">.</span><span class="ident" id="7547154">Addr</span><span class="op" id="7547158">(</span><span class="op" id="7547159">)</span><span class="op" id="7547160">.</span><span class="ident" id="7547161">String</span><span class="op" id="7547167">(</span><span class="op" id="7547168">)</span><span class="op" id="7547169">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7547172">if</span>&nbsp;<span class="ident" id="7547175">err</span>&nbsp;<span class="op" id="7547179">!=</span>&nbsp;<span class="ident" id="7547182">nil</span>&nbsp;<span class="op" id="7547186">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7547190">t</span><span class="op" id="7547191">.</span><span class="ident" id="7547192">Fatalf</span><span class="op" id="7547198">(</span><span class="string" id="7547199">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7547216">,</span>&nbsp;<span class="ident" id="7547218">err</span><span class="op" id="7547221">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7547224">}</span><br>
<span class="lineno">515</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7547227">if</span>&nbsp;<span class="ident" id="7547230">err</span>&nbsp;<span class="op" id="7547234">:=</span>&nbsp;<span class="op" id="7547237">&lt;-</span><span class="ident" id="7547239">errc</span><span class="op" id="7547243">;</span>&nbsp;<span class="ident" id="7547245">err</span>&nbsp;<span class="op" id="7547249">!=</span>&nbsp;<span class="ident" id="7547252">nil</span>&nbsp;<span class="op" id="7547256">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7547260">t</span><span class="op" id="7547261">.</span><span class="ident" id="7547262">Fatalf</span><span class="op" id="7547268">(</span><span class="string" id="7547269">&#34;Accept&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7547288">,</span>&nbsp;<span class="ident" id="7547290">err</span><span class="op" id="7547293">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7547296">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7547299">defer</span>&nbsp;<span class="ident" id="7547305">server</span><span class="op" id="7547311">.</span><span class="ident" id="7547312">Close</span><span class="op" id="7547317">(</span><span class="op" id="7547318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7547321">var</span>&nbsp;<span class="ident" id="7547325">buf</span>&nbsp;<span class="op" id="7547329">[</span><span class="num" id="7547330">128</span><span class="op" id="7547333">]</span><span class="builtintype" id="7547334">byte</span><br>
<span class="lineno">520</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7547340">mallocs</span>&nbsp;<span class="op" id="7547348">:=</span>&nbsp;<span class="ident" id="7547351">testing</span><span class="op" id="7547358">.</span><span class="ident" id="7547359">AllocsPerRun</span><span class="op" id="7547371">(</span><span class="num" id="7547372">1000</span><span class="op" id="7547376">,</span>&nbsp;<span class="keyword" id="7547378">func</span><span class="op" id="7547382">(</span><span class="op" id="7547383">)</span>&nbsp;<span class="op" id="7547385">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7547389">_</span><span class="op" id="7547390">,</span>&nbsp;<span class="ident" id="7547392">err</span>&nbsp;<span class="op" id="7547396">:=</span>&nbsp;<span class="ident" id="7547399">server</span><span class="op" id="7547405">.</span><span class="ident" id="7547406">Write</span><span class="op" id="7547411">(</span><span class="ident" id="7547412">buf</span><span class="op" id="7547415">[</span><span class="op" id="7547416">:</span><span class="op" id="7547417">]</span><span class="op" id="7547418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7547422">if</span>&nbsp;<span class="ident" id="7547425">err</span>&nbsp;<span class="op" id="7547429">!=</span>&nbsp;<span class="ident" id="7547432">nil</span>&nbsp;<span class="op" id="7547436">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7547441">t</span><span class="op" id="7547442">.</span><span class="ident" id="7547443">Fatalf</span><span class="op" id="7547449">(</span><span class="string" id="7547450">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7547468">,</span>&nbsp;<span class="ident" id="7547470">err</span><span class="op" id="7547473">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7547477">}</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7547481">_</span><span class="op" id="7547482">,</span>&nbsp;<span class="ident" id="7547484">err</span>&nbsp;<span class="op" id="7547488">=</span>&nbsp;<span class="ident" id="7547490">io</span><span class="op" id="7547492">.</span><span class="ident" id="7547493">ReadFull</span><span class="op" id="7547501">(</span><span class="ident" id="7547502">client</span><span class="op" id="7547508">,</span>&nbsp;<span class="ident" id="7547510">buf</span><span class="op" id="7547513">[</span><span class="op" id="7547514">:</span><span class="op" id="7547515">]</span><span class="op" id="7547516">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7547520">if</span>&nbsp;<span class="ident" id="7547523">err</span>&nbsp;<span class="op" id="7547527">!=</span>&nbsp;<span class="ident" id="7547530">nil</span>&nbsp;<span class="op" id="7547534">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7547539">t</span><span class="op" id="7547540">.</span><span class="ident" id="7547541">Fatalf</span><span class="op" id="7547547">(</span><span class="string" id="7547548">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7547565">,</span>&nbsp;<span class="ident" id="7547567">err</span><span class="op" id="7547570">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7547574">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7547577">}</span><span class="op" id="7547578">)</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7547581">if</span>&nbsp;<span class="ident" id="7547584">mallocs</span>&nbsp;<span class="op" id="7547592">&gt;</span>&nbsp;<span class="num" id="7547594">0</span>&nbsp;<span class="op" id="7547596">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7547600">t</span><span class="op" id="7547601">.</span><span class="ident" id="7547602">Fatalf</span><span class="op" id="7547608">(</span><span class="string" id="7547609">&#34;Got&nbsp;%v&nbsp;allocs,&nbsp;want&nbsp;0&#34;</span><span class="op" id="7547632">,</span>&nbsp;<span class="ident" id="7547634">mallocs</span><span class="op" id="7547641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7547644">}</span><br>
<span class="lineno"></span><span class="op" id="7547646">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">535</span><span class="keyword" id="7547649">func</span>&nbsp;<span class="ident" id="7547654">TestTCPStress</span><span class="op" id="7547667">(</span><span class="ident" id="7547668">t</span>&nbsp;<span class="op" id="7547670">*</span><span class="ident" id="7547671">testing</span><span class="op" id="7547678">.</span><span class="ident" id="7547679">T</span><span class="op" id="7547680">)</span>&nbsp;<span class="op" id="7547682">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7547685">const</span>&nbsp;<span class="ident" id="7547691">conns</span>&nbsp;<span class="op" id="7547697">=</span>&nbsp;<span class="num" id="7547699">2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7547702">const</span>&nbsp;<span class="ident" id="7547708">msgLen</span>&nbsp;<span class="op" id="7547715">=</span>&nbsp;<span class="num" id="7547717">512</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7547722">msgs</span>&nbsp;<span class="op" id="7547727">:=</span>&nbsp;<span class="builtintype" id="7547730">int</span><span class="op" id="7547733">(</span><span class="num" id="7547734">1e4</span><span class="op" id="7547737">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7547740">if</span>&nbsp;<span class="ident" id="7547743">testing</span><span class="op" id="7547750">.</span><span class="ident" id="7547751">Short</span><span class="op" id="7547756">(</span><span class="op" id="7547757">)</span>&nbsp;<span class="op" id="7547759">{</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7547763">msgs</span>&nbsp;<span class="op" id="7547768">=</span>&nbsp;<span class="num" id="7547770">1e2</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7547775">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7547779">sendMsg</span>&nbsp;<span class="op" id="7547787">:=</span>&nbsp;<span class="keyword" id="7547790">func</span><span class="op" id="7547794">(</span><span class="ident" id="7547795">c</span>&nbsp;<span class="ident" id="7547797">Conn</span><span class="op" id="7547801">,</span>&nbsp;<span class="ident" id="7547803">buf</span>&nbsp;<span class="op" id="7547807">[</span><span class="op" id="7547808">]</span><span class="builtintype" id="7547809">byte</span><span class="op" id="7547813">)</span>&nbsp;<span class="builtintype" id="7547815">bool</span>&nbsp;<span class="op" id="7547820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7547824">n</span><span class="op" id="7547825">,</span>&nbsp;<span class="ident" id="7547827">err</span>&nbsp;<span class="op" id="7547831">:=</span>&nbsp;<span class="ident" id="7547834">c</span><span class="op" id="7547835">.</span><span class="ident" id="7547836">Write</span><span class="op" id="7547841">(</span><span class="ident" id="7547842">buf</span><span class="op" id="7547845">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7547849">if</span>&nbsp;<span class="ident" id="7547852">n</span>&nbsp;<span class="op" id="7547854">!=</span>&nbsp;<span class="builtinfunc" id="7547857">len</span><span class="op" id="7547860">(</span><span class="ident" id="7547861">buf</span><span class="op" id="7547864">)</span>&nbsp;<span class="op" id="7547866">||</span>&nbsp;<span class="ident" id="7547869">err</span>&nbsp;<span class="op" id="7547873">!=</span>&nbsp;<span class="ident" id="7547876">nil</span>&nbsp;<span class="op" id="7547880">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7547885">t</span><span class="op" id="7547886">.</span><span class="ident" id="7547887">Logf</span><span class="op" id="7547891">(</span><span class="string" id="7547892">&#34;Write&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7547910">,</span>&nbsp;<span class="ident" id="7547912">err</span><span class="op" id="7547915">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7547920">return</span>&nbsp;<span class="ident" id="7547927">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7547935">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7547939">return</span>&nbsp;<span class="ident" id="7547946">true</span><br>
<span class="lineno">550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7547952">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7547955">recvMsg</span>&nbsp;<span class="op" id="7547963">:=</span>&nbsp;<span class="keyword" id="7547966">func</span><span class="op" id="7547970">(</span><span class="ident" id="7547971">c</span>&nbsp;<span class="ident" id="7547973">Conn</span><span class="op" id="7547977">,</span>&nbsp;<span class="ident" id="7547979">buf</span>&nbsp;<span class="op" id="7547983">[</span><span class="op" id="7547984">]</span><span class="builtintype" id="7547985">byte</span><span class="op" id="7547989">)</span>&nbsp;<span class="builtintype" id="7547991">bool</span>&nbsp;<span class="op" id="7547996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7548000">for</span>&nbsp;<span class="ident" id="7548004">read</span>&nbsp;<span class="op" id="7548009">:=</span>&nbsp;<span class="num" id="7548012">0</span><span class="op" id="7548013">;</span>&nbsp;<span class="ident" id="7548015">read</span>&nbsp;<span class="op" id="7548020">!=</span>&nbsp;<span class="builtinfunc" id="7548023">len</span><span class="op" id="7548026">(</span><span class="ident" id="7548027">buf</span><span class="op" id="7548030">)</span><span class="op" id="7548031">;</span>&nbsp;<span class="op" id="7548033">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7548038">n</span><span class="op" id="7548039">,</span>&nbsp;<span class="ident" id="7548041">err</span>&nbsp;<span class="op" id="7548045">:=</span>&nbsp;<span class="ident" id="7548048">c</span><span class="op" id="7548049">.</span><span class="ident" id="7548050">Read</span><span class="op" id="7548054">(</span><span class="ident" id="7548055">buf</span><span class="op" id="7548058">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7548063">read</span>&nbsp;<span class="op" id="7548068">+=</span>&nbsp;<span class="ident" id="7548071">n</span><br>
<span class="lineno">555</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7548076">if</span>&nbsp;<span class="ident" id="7548079">err</span>&nbsp;<span class="op" id="7548083">!=</span>&nbsp;<span class="ident" id="7548086">nil</span>&nbsp;<span class="op" id="7548090">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7548096">t</span><span class="op" id="7548097">.</span><span class="ident" id="7548098">Logf</span><span class="op" id="7548102">(</span><span class="string" id="7548103">&#34;Read&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7548120">,</span>&nbsp;<span class="ident" id="7548122">err</span><span class="op" id="7548125">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7548131">return</span>&nbsp;<span class="ident" id="7548138">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7548147">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7548151">}</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7548155">return</span>&nbsp;<span class="ident" id="7548162">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7548168">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7548172">ln</span><span class="op" id="7548174">,</span>&nbsp;<span class="ident" id="7548176">err</span>&nbsp;<span class="op" id="7548180">:=</span>&nbsp;<span class="ident" id="7548183">Listen</span><span class="op" id="7548189">(</span><span class="string" id="7548190">&#34;tcp&#34;</span><span class="op" id="7548195">,</span>&nbsp;<span class="string" id="7548197">&#34;127.0.0.1:0&#34;</span><span class="op" id="7548210">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7548213">if</span>&nbsp;<span class="ident" id="7548216">err</span>&nbsp;<span class="op" id="7548220">!=</span>&nbsp;<span class="ident" id="7548223">nil</span>&nbsp;<span class="op" id="7548227">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7548231">t</span><span class="op" id="7548232">.</span><span class="ident" id="7548233">Fatalf</span><span class="op" id="7548239">(</span><span class="string" id="7548240">&#34;Listen&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7548259">,</span>&nbsp;<span class="ident" id="7548261">err</span><span class="op" id="7548264">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7548267">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7548270">defer</span>&nbsp;<span class="ident" id="7548276">ln</span><span class="op" id="7548278">.</span><span class="ident" id="7548279">Close</span><span class="op" id="7548284">(</span><span class="op" id="7548285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7548288">//&nbsp;Acceptor.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7548302">go</span>&nbsp;<span class="keyword" id="7548305">func</span><span class="op" id="7548309">(</span><span class="op" id="7548310">)</span>&nbsp;<span class="op" id="7548312">{</span><br>
<span class="lineno">570</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7548316">for</span>&nbsp;<span class="op" id="7548320">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7548325">c</span><span class="op" id="7548326">,</span>&nbsp;<span class="ident" id="7548328">err</span>&nbsp;<span class="op" id="7548332">:=</span>&nbsp;<span class="ident" id="7548335">ln</span><span class="op" id="7548337">.</span><span class="ident" id="7548338">Accept</span><span class="op" id="7548344">(</span><span class="op" id="7548345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7548350">if</span>&nbsp;<span class="ident" id="7548353">err</span>&nbsp;<span class="op" id="7548357">!=</span>&nbsp;<span class="ident" id="7548360">nil</span>&nbsp;<span class="op" id="7548364">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7548370">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7548379">}</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7548384">//&nbsp;Server&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7548409">go</span>&nbsp;<span class="keyword" id="7548412">func</span><span class="op" id="7548416">(</span><span class="ident" id="7548417">c</span>&nbsp;<span class="ident" id="7548419">Conn</span><span class="op" id="7548423">)</span>&nbsp;<span class="op" id="7548425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7548431">defer</span>&nbsp;<span class="ident" id="7548437">c</span><span class="op" id="7548438">.</span><span class="ident" id="7548439">Close</span><span class="op" id="7548444">(</span><span class="op" id="7548445">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7548451">var</span>&nbsp;<span class="ident" id="7548455">buf</span>&nbsp;<span class="op" id="7548459">[</span><span class="ident" id="7548460">msgLen</span><span class="op" id="7548466">]</span><span class="builtintype" id="7548467">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7548476">for</span>&nbsp;<span class="ident" id="7548480">m</span>&nbsp;<span class="op" id="7548482">:=</span>&nbsp;<span class="num" id="7548485">0</span><span class="op" id="7548486">;</span>&nbsp;<span class="ident" id="7548488">m</span>&nbsp;<span class="op" id="7548490">&lt;</span>&nbsp;<span class="ident" id="7548492">msgs</span><span class="op" id="7548496">;</span>&nbsp;<span class="ident" id="7548498">m</span><span class="op" id="7548499">++</span>&nbsp;<span class="op" id="7548502">{</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7548509">if</span>&nbsp;<span class="op" id="7548512">!</span><span class="ident" id="7548513">recvMsg</span><span class="op" id="7548520">(</span><span class="ident" id="7548521">c</span><span class="op" id="7548522">,</span>&nbsp;<span class="ident" id="7548524">buf</span><span class="op" id="7548527">[</span><span class="op" id="7548528">:</span><span class="op" id="7548529">]</span><span class="op" id="7548530">)</span>&nbsp;<span class="op" id="7548532">||</span>&nbsp;<span class="op" id="7548535">!</span><span class="ident" id="7548536">sendMsg</span><span class="op" id="7548543">(</span><span class="ident" id="7548544">c</span><span class="op" id="7548545">,</span>&nbsp;<span class="ident" id="7548547">buf</span><span class="op" id="7548550">[</span><span class="op" id="7548551">:</span><span class="op" id="7548552">]</span><span class="op" id="7548553">)</span>&nbsp;<span class="op" id="7548555">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7548563">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7548574">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7548580">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7548585">}</span><span class="op" id="7548586">(</span><span class="ident" id="7548587">c</span><span class="op" id="7548588">)</span><br>
<span class="lineno">585</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7548592">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7548595">}</span><span class="op" id="7548596">(</span><span class="op" id="7548597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7548600">done</span>&nbsp;<span class="op" id="7548605">:=</span>&nbsp;<span class="builtinfunc" id="7548608">make</span><span class="op" id="7548612">(</span><span class="keyword" id="7548613">chan</span>&nbsp;<span class="builtintype" id="7548618">bool</span><span class="op" id="7548622">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7548625">for</span>&nbsp;<span class="ident" id="7548629">i</span>&nbsp;<span class="op" id="7548631">:=</span>&nbsp;<span class="num" id="7548634">0</span><span class="op" id="7548635">;</span>&nbsp;<span class="ident" id="7548637">i</span>&nbsp;<span class="op" id="7548639">&lt;</span>&nbsp;<span class="ident" id="7548641">conns</span><span class="op" id="7548646">;</span>&nbsp;<span class="ident" id="7548648">i</span><span class="op" id="7548649">++</span>&nbsp;<span class="op" id="7548652">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="7548656">//&nbsp;Client&nbsp;connection.</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7548680">go</span>&nbsp;<span class="keyword" id="7548683">func</span><span class="op" id="7548687">(</span><span class="op" id="7548688">)</span>&nbsp;<span class="op" id="7548690">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7548695">defer</span>&nbsp;<span class="keyword" id="7548701">func</span><span class="op" id="7548705">(</span><span class="op" id="7548706">)</span>&nbsp;<span class="op" id="7548708">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7548714">done</span>&nbsp;<span class="op" id="7548719">&lt;-</span>&nbsp;<span class="ident" id="7548722">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7548730">}</span><span class="op" id="7548731">(</span><span class="op" id="7548732">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7548737">c</span><span class="op" id="7548738">,</span>&nbsp;<span class="ident" id="7548740">err</span>&nbsp;<span class="op" id="7548744">:=</span>&nbsp;<span class="ident" id="7548747">Dial</span><span class="op" id="7548751">(</span><span class="string" id="7548752">&#34;tcp&#34;</span><span class="op" id="7548757">,</span>&nbsp;<span class="ident" id="7548759">ln</span><span class="op" id="7548761">.</span><span class="ident" id="7548762">Addr</span><span class="op" id="7548766">(</span><span class="op" id="7548767">)</span><span class="op" id="7548768">.</span><span class="ident" id="7548769">String</span><span class="op" id="7548775">(</span><span class="op" id="7548776">)</span><span class="op" id="7548777">)</span><br>
<span class="lineno">595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7548782">if</span>&nbsp;<span class="ident" id="7548785">err</span>&nbsp;<span class="op" id="7548789">!=</span>&nbsp;<span class="ident" id="7548792">nil</span>&nbsp;<span class="op" id="7548796">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="7548802">t</span><span class="op" id="7548803">.</span><span class="ident" id="7548804">Logf</span><span class="op" id="7548808">(</span><span class="string" id="7548809">&#34;Dial&nbsp;failed:&nbsp;%v&#34;</span><span class="op" id="7548826">,</span>&nbsp;<span class="ident" id="7548828">err</span><span class="op" id="7548831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7548837">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7548847">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7548852">defer</span>&nbsp;<span class="ident" id="7548858">c</span><span class="op" id="7548859">.</span><span class="ident" id="7548860">Close</span><span class="op" id="7548865">(</span><span class="op" id="7548866">)</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7548871">var</span>&nbsp;<span class="ident" id="7548875">buf</span>&nbsp;<span class="op" id="7548879">[</span><span class="ident" id="7548880">msgLen</span><span class="op" id="7548886">]</span><span class="builtintype" id="7548887">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7548895">for</span>&nbsp;<span class="ident" id="7548899">m</span>&nbsp;<span class="op" id="7548901">:=</span>&nbsp;<span class="num" id="7548904">0</span><span class="op" id="7548905">;</span>&nbsp;<span class="ident" id="7548907">m</span>&nbsp;<span class="op" id="7548909">&lt;</span>&nbsp;<span class="ident" id="7548911">msgs</span><span class="op" id="7548915">;</span>&nbsp;<span class="ident" id="7548917">m</span><span class="op" id="7548918">++</span>&nbsp;<span class="op" id="7548921">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7548927">if</span>&nbsp;<span class="op" id="7548930">!</span><span class="ident" id="7548931">sendMsg</span><span class="op" id="7548938">(</span><span class="ident" id="7548939">c</span><span class="op" id="7548940">,</span>&nbsp;<span class="ident" id="7548942">buf</span><span class="op" id="7548945">[</span><span class="op" id="7548946">:</span><span class="op" id="7548947">]</span><span class="op" id="7548948">)</span>&nbsp;<span class="op" id="7548950">||</span>&nbsp;<span class="op" id="7548953">!</span><span class="ident" id="7548954">recvMsg</span><span class="op" id="7548961">(</span><span class="ident" id="7548962">c</span><span class="op" id="7548963">,</span>&nbsp;<span class="ident" id="7548965">buf</span><span class="op" id="7548968">[</span><span class="op" id="7548969">:</span><span class="op" id="7548970">]</span><span class="op" id="7548971">)</span>&nbsp;<span class="op" id="7548973">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7548980">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7548990">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7548995">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7548999">}</span><span class="op" id="7549000">(</span><span class="op" id="7549001">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7549004">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="7549007">for</span>&nbsp;<span class="ident" id="7549011">i</span>&nbsp;<span class="op" id="7549013">:=</span>&nbsp;<span class="num" id="7549016">0</span><span class="op" id="7549017">;</span>&nbsp;<span class="ident" id="7549019">i</span>&nbsp;<span class="op" id="7549021">&lt;</span>&nbsp;<span class="ident" id="7549023">conns</span><span class="op" id="7549028">;</span>&nbsp;<span class="ident" id="7549030">i</span><span class="op" id="7549031">++</span>&nbsp;<span class="op" id="7549034">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7549038">&lt;-</span><span class="ident" id="7549040">done</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="7549046">}</span><br>
<span class="lineno"></span><span class="op" id="7549048">}</span>
</div>
</body>
</html>
