<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>net</h2>
<ul>
<li><a href="/gostd/net/cgo_stub.go.html">cgo_stub.go</a></li>
<li><a href="/gostd/net/conn_test.go.html">conn_test.go</a></li>
<li><a href="/gostd/net/dial.go.html">dial.go</a></li>
<li><a href="/gostd/net/dial_test.go.html">dial_test.go</a></li>
<li><a href="/gostd/net/dialgoogle_test.go.html">dialgoogle_test.go</a></li>
<li><a href="/gostd/net/dnsclient.go.html">dnsclient.go</a></li>
<li><a href="/gostd/net/dnsclient_test.go.html">dnsclient_test.go</a></li>
<li><a href="/gostd/net/dnsclient_unix.go.html">dnsclient_unix.go</a></li>
<li><a href="/gostd/net/dnsclient_unix_test.go.html">dnsclient_unix_test.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix.go.html">dnsconfig_unix.go</a></li>
<li><a href="/gostd/net/dnsconfig_unix_test.go.html">dnsconfig_unix_test.go</a></li>
<li><a href="/gostd/net/dnsmsg.go.html">dnsmsg.go</a></li>
<li><a href="/gostd/net/dnsmsg_test.go.html">dnsmsg_test.go</a></li>
<li><a href="/gostd/net/dnsname_test.go.html">dnsname_test.go</a></li>
<li><a href="/gostd/net/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/net/fd_mutex.go.html">fd_mutex.go</a></li>
<li><a href="/gostd/net/fd_mutex_test.go.html">fd_mutex_test.go</a></li>
<li><a href="/gostd/net/fd_poll_runtime.go.html">fd_poll_runtime.go</a></li>
<li><a href="/gostd/net/fd_unix.go.html">fd_unix.go</a></li>
<li><a href="/gostd/net/fd_unix_test.go.html">fd_unix_test.go</a></li>
<li><a href="/gostd/net/file_test.go.html">file_test.go</a></li>
<li><a href="/gostd/net/file_unix.go.html">file_unix.go</a></li>
<li><a href="/gostd/net/hosts.go.html">hosts.go</a></li>
<li><a href="/gostd/net/hosts_test.go.html">hosts_test.go</a></li>
<li><a href="/gostd/net/interface.go.html">interface.go</a></li>
<li><a href="/gostd/net/interface_linux.go.html">interface_linux.go</a></li>
<li><a href="/gostd/net/interface_linux_test.go.html">interface_linux_test.go</a></li>
<li><a href="/gostd/net/interface_test.go.html">interface_test.go</a></li>
<li><a href="/gostd/net/interface_unix_test.go.html">interface_unix_test.go</a></li>
<li><a href="/gostd/net/ip.go.html">ip.go</a></li>
<li><a href="/gostd/net/ip_test.go.html">ip_test.go</a></li>
<li><a href="/gostd/net/ipraw_test.go.html">ipraw_test.go</a></li>
<li><a href="/gostd/net/iprawsock.go.html">iprawsock.go</a></li>
<li><a href="/gostd/net/iprawsock_posix.go.html">iprawsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock.go.html">ipsock.go</a></li>
<li><a href="/gostd/net/ipsock_posix.go.html">ipsock_posix.go</a></li>
<li><a href="/gostd/net/ipsock_test.go.html">ipsock_test.go</a></li>
<li><a href="/gostd/net/lookup.go.html">lookup.go</a></li>
<li><a href="/gostd/net/lookup_test.go.html">lookup_test.go</a></li>
<li><a href="/gostd/net/lookup_unix.go.html">lookup_unix.go</a></li>
<li><a href="/gostd/net/mac.go.html">mac.go</a></li>
<li><a href="/gostd/net/mac_test.go.html">mac_test.go</a></li>
<li><a href="/gostd/net/mockicmp_test.go.html">mockicmp_test.go</a></li>
<li><a href="/gostd/net/mockserver_test.go.html">mockserver_test.go</a></li>
<li><a href="/gostd/net/multicast_test.go.html">multicast_test.go</a></li>
<li><a href="/gostd/net/net.go.html">net.go</a></li>
<li><a href="/gostd/net/net_test.go.html">net_test.go</a></li>
<li><a href="/gostd/net/netgo_unix_test.go.html">netgo_unix_test.go</a></li>
<li><a href="/gostd/net/packetconn_test.go.html">packetconn_test.go</a></li>
<li><a href="/gostd/net/parse.go.html">parse.go</a></li>
<li><a href="/gostd/net/parse_test.go.html">parse_test.go</a></li>
<li><a href="/gostd/net/pipe.go.html">pipe.go</a></li>
<li><a href="/gostd/net/pipe_test.go.html">pipe_test.go</a></li>
<li><a href="/gostd/net/port.go.html">port.go</a></li>
<li><a href="/gostd/net/port_test.go.html">port_test.go</a></li>
<li><a href="/gostd/net/port_unix.go.html">port_unix.go</a></li>
<li><a href="/gostd/net/protoconn_test.go.html">protoconn_test.go</a></li>
<li><a href="/gostd/net/sendfile_linux.go.html">sendfile_linux.go</a></li>
<li><a href="/gostd/net/server_test.go.html">server_test.go</a></li>
<li><a href="/gostd/net/singleflight.go.html">singleflight.go</a></li>
<li><a href="/gostd/net/sock_cloexec.go.html">sock_cloexec.go</a></li>
<li><a href="/gostd/net/sock_linux.go.html">sock_linux.go</a></li>
<li><a href="/gostd/net/sock_posix.go.html">sock_posix.go</a></li>
<li><a href="/gostd/net/sockopt_linux.go.html">sockopt_linux.go</a></li>
<li><a href="/gostd/net/sockopt_posix.go.html">sockopt_posix.go</a></li>
<li><a href="/gostd/net/sockoptip_linux.go.html">sockoptip_linux.go</a></li>
<li><a href="/gostd/net/sockoptip_posix.go.html">sockoptip_posix.go</a></li>
<li><a href="/gostd/net/tcp_test.go.html">tcp_test.go</a></li>
<li><a href="/gostd/net/tcpsock.go.html">tcpsock.go</a></li>
<li><a href="/gostd/net/tcpsock_posix.go.html">tcpsock_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_posix.go.html">tcpsockopt_posix.go</a></li>
<li><a href="/gostd/net/tcpsockopt_unix.go.html">tcpsockopt_unix.go</a></li>
<li><a href="/gostd/net/timeout_test.go.html">timeout_test.go</a></li>
<li><a href="/gostd/net/udp_test.go.html">udp_test.go</a></li>
<li><a href="/gostd/net/udpsock.go.html">udpsock.go</a></li>
<li><a href="/gostd/net/udpsock_posix.go.html">udpsock_posix.go</a></li>
<li><a href="/gostd/net/unicast_posix_test.go.html">unicast_posix_test.go</a></li>
<li><a href="/gostd/net/unix_test.go.html">unix_test.go</a></li>
<li><a href="/gostd/net/unixsock.go.html">unixsock.go</a></li>
<li><a href="/gostd/net/unixsock_posix.go.html">unixsock_posix.go</a></li>
<li><a href="/gostd/net/z_last_test.go.html">z_last_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="4093582">//&nbsp;Copyright&nbsp;2010&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="4093638">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="4093692">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="4093743">//&nbsp;+build&nbsp;darwin&nbsp;dragonfly&nbsp;freebsd&nbsp;linux&nbsp;nacl&nbsp;netbsd&nbsp;openbsd&nbsp;solaris&nbsp;windows</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4093821">package</span>&nbsp;<span class="ident" id="4093829">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4093834">import</span>&nbsp;<span class="op" id="4093841">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4093844">&#34;syscall&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="4093855">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="4093862">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4093865">//&nbsp;BUG(mikio):&nbsp;On&nbsp;every&nbsp;POSIX&nbsp;platform,&nbsp;reads&nbsp;from&nbsp;the&nbsp;&#34;ip4&#34;&nbsp;network</span><br>
<span class="lineno">15</span><span class="comment" id="4093934">//&nbsp;using&nbsp;the&nbsp;ReadFrom&nbsp;or&nbsp;ReadFromIP&nbsp;method&nbsp;might&nbsp;not&nbsp;return&nbsp;a&nbsp;complete</span><br>
<span class="lineno"></span><span class="comment" id="4094005">//&nbsp;IPv4&nbsp;packet,&nbsp;including&nbsp;its&nbsp;header,&nbsp;even&nbsp;if&nbsp;there&nbsp;is&nbsp;space</span><br>
<span class="lineno"></span><span class="comment" id="4094066">//&nbsp;available.&nbsp;This&nbsp;can&nbsp;occur&nbsp;even&nbsp;in&nbsp;cases&nbsp;where&nbsp;Read&nbsp;or&nbsp;ReadMsgIP</span><br>
<span class="lineno"></span><span class="comment" id="4094133">//&nbsp;could&nbsp;return&nbsp;a&nbsp;complete&nbsp;packet.&nbsp;For&nbsp;this&nbsp;reason,&nbsp;it&nbsp;is&nbsp;recommended</span><br>
<span class="lineno"></span><span class="comment" id="4094203">//&nbsp;that&nbsp;you&nbsp;do&nbsp;not&nbsp;uses&nbsp;these&nbsp;methods&nbsp;if&nbsp;it&nbsp;is&nbsp;important&nbsp;to&nbsp;receive&nbsp;a</span><br>
<span class="lineno">20</span><span class="comment" id="4094273">//&nbsp;full&nbsp;packet.</span><br>
<span class="lineno"></span><span class="comment" id="4094289">//</span><br>
<span class="lineno"></span><span class="comment" id="4094292">//&nbsp;The&nbsp;Go&nbsp;1&nbsp;compatibility&nbsp;guidelines&nbsp;make&nbsp;it&nbsp;impossible&nbsp;for&nbsp;us&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="4094358">//&nbsp;change&nbsp;the&nbsp;behavior&nbsp;of&nbsp;these&nbsp;methods;&nbsp;use&nbsp;Read&nbsp;or&nbsp;ReadMsgIP</span><br>
<span class="lineno"></span><span class="comment" id="4094421">//&nbsp;instead.</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span><span class="keyword" id="4094434">func</span>&nbsp;<span class="ident" id="4094439">sockaddrToIP</span><span class="op" id="4094451">(</span><span class="ident" id="4094452">sa</span>&nbsp;<span class="ident" id="4094455">syscall</span><span class="op" id="4094462">.</span><span class="ident" id="4094463">Sockaddr</span><span class="op" id="4094471">)</span>&nbsp;<span class="ident" id="4094473">Addr</span>&nbsp;<span class="op" id="4094478">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4094481">switch</span>&nbsp;<span class="ident" id="4094488">sa</span>&nbsp;<span class="op" id="4094491">:=</span>&nbsp;<span class="ident" id="4094494">sa</span><span class="op" id="4094496">.</span><span class="op" id="4094497">(</span><span class="keyword" id="4094498">type</span><span class="op" id="4094502">)</span>&nbsp;<span class="op" id="4094504">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4094507">case</span>&nbsp;<span class="op" id="4094512">*</span><span class="ident" id="4094513">syscall</span><span class="op" id="4094520">.</span><span class="ident" id="4094521">SockaddrInet4</span><span class="op" id="4094534">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4094538">return</span>&nbsp;<span class="op" id="4094545">&amp;</span><span class="ident" id="4094546">IPAddr</span><span class="op" id="4094552">{</span><span class="ident" id="4094553">IP</span><span class="op" id="4094555">:</span>&nbsp;<span class="ident" id="4094557">sa</span><span class="op" id="4094559">.</span><span class="ident" id="4094560">Addr</span><span class="op" id="4094564">[</span><span class="num" id="4094565">0</span><span class="op" id="4094566">:</span><span class="op" id="4094567">]</span><span class="op" id="4094568">}</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4094571">case</span>&nbsp;<span class="op" id="4094576">*</span><span class="ident" id="4094577">syscall</span><span class="op" id="4094584">.</span><span class="ident" id="4094585">SockaddrInet6</span><span class="op" id="4094598">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4094602">return</span>&nbsp;<span class="op" id="4094609">&amp;</span><span class="ident" id="4094610">IPAddr</span><span class="op" id="4094616">{</span><span class="ident" id="4094617">IP</span><span class="op" id="4094619">:</span>&nbsp;<span class="ident" id="4094621">sa</span><span class="op" id="4094623">.</span><span class="ident" id="4094624">Addr</span><span class="op" id="4094628">[</span><span class="num" id="4094629">0</span><span class="op" id="4094630">:</span><span class="op" id="4094631">]</span><span class="op" id="4094632">,</span>&nbsp;<span class="ident" id="4094634">Zone</span><span class="op" id="4094638">:</span>&nbsp;<span class="ident" id="4094640">zoneToString</span><span class="op" id="4094652">(</span><span class="builtintype" id="4094653">int</span><span class="op" id="4094656">(</span><span class="ident" id="4094657">sa</span><span class="op" id="4094659">.</span><span class="ident" id="4094660">ZoneId</span><span class="op" id="4094666">)</span><span class="op" id="4094667">)</span><span class="op" id="4094668">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4094671">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4094674">return</span>&nbsp;<span class="ident" id="4094681">nil</span><br>
<span class="lineno"></span><span class="op" id="4094685">}</span><br>
<span class="lineno">35</span><br>
<span class="lineno"></span><span class="keyword" id="4094688">func</span>&nbsp;<span class="op" id="4094693">(</span><span class="ident" id="4094694">a</span>&nbsp;<span class="op" id="4094696">*</span><span class="ident" id="4094697">IPAddr</span><span class="op" id="4094703">)</span>&nbsp;<span class="ident" id="4094705">family</span><span class="op" id="4094711">(</span><span class="op" id="4094712">)</span>&nbsp;<span class="builtintype" id="4094714">int</span>&nbsp;<span class="op" id="4094718">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4094721">if</span>&nbsp;<span class="ident" id="4094724">a</span>&nbsp;<span class="op" id="4094726">==</span>&nbsp;<span class="ident" id="4094729">nil</span>&nbsp;<span class="op" id="4094733">||</span>&nbsp;<span class="builtinfunc" id="4094736">len</span><span class="op" id="4094739">(</span><span class="ident" id="4094740">a</span><span class="op" id="4094741">.</span><span class="ident" id="4094742">IP</span><span class="op" id="4094744">)</span>&nbsp;<span class="op" id="4094746">&lt;=</span>&nbsp;<span class="ident" id="4094749">IPv4len</span>&nbsp;<span class="op" id="4094757">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4094761">return</span>&nbsp;<span class="ident" id="4094768">syscall</span><span class="op" id="4094775">.</span><span class="ident" id="4094776">AF_INET</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4094785">}</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4094788">if</span>&nbsp;<span class="ident" id="4094791">a</span><span class="op" id="4094792">.</span><span class="ident" id="4094793">IP</span><span class="op" id="4094795">.</span><span class="ident" id="4094796">To4</span><span class="op" id="4094799">(</span><span class="op" id="4094800">)</span>&nbsp;<span class="op" id="4094802">!=</span>&nbsp;<span class="ident" id="4094805">nil</span>&nbsp;<span class="op" id="4094809">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4094813">return</span>&nbsp;<span class="ident" id="4094820">syscall</span><span class="op" id="4094827">.</span><span class="ident" id="4094828">AF_INET</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4094837">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4094840">return</span>&nbsp;<span class="ident" id="4094847">syscall</span><span class="op" id="4094854">.</span><span class="ident" id="4094855">AF_INET6</span><br>
<span class="lineno"></span><span class="op" id="4094864">}</span><br>
<span class="lineno">45</span><br>
<span class="lineno"></span><span class="keyword" id="4094867">func</span>&nbsp;<span class="op" id="4094872">(</span><span class="ident" id="4094873">a</span>&nbsp;<span class="op" id="4094875">*</span><span class="ident" id="4094876">IPAddr</span><span class="op" id="4094882">)</span>&nbsp;<span class="ident" id="4094884">isWildcard</span><span class="op" id="4094894">(</span><span class="op" id="4094895">)</span>&nbsp;<span class="builtintype" id="4094897">bool</span>&nbsp;<span class="op" id="4094902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4094905">if</span>&nbsp;<span class="ident" id="4094908">a</span>&nbsp;<span class="op" id="4094910">==</span>&nbsp;<span class="ident" id="4094913">nil</span>&nbsp;<span class="op" id="4094917">||</span>&nbsp;<span class="ident" id="4094920">a</span><span class="op" id="4094921">.</span><span class="ident" id="4094922">IP</span>&nbsp;<span class="op" id="4094925">==</span>&nbsp;<span class="ident" id="4094928">nil</span>&nbsp;<span class="op" id="4094932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4094936">return</span>&nbsp;<span class="builtintype" id="4094943">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4094949">}</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4094952">return</span>&nbsp;<span class="ident" id="4094959">a</span><span class="op" id="4094960">.</span><span class="ident" id="4094961">IP</span><span class="op" id="4094963">.</span><span class="ident" id="4094964">IsUnspecified</span><span class="op" id="4094977">(</span><span class="op" id="4094978">)</span><br>
<span class="lineno"></span><span class="op" id="4094980">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4094983">func</span>&nbsp;<span class="op" id="4094988">(</span><span class="ident" id="4094989">a</span>&nbsp;<span class="op" id="4094991">*</span><span class="ident" id="4094992">IPAddr</span><span class="op" id="4094998">)</span>&nbsp;<span class="ident" id="4095000">sockaddr</span><span class="op" id="4095008">(</span><span class="ident" id="4095009">family</span>&nbsp;<span class="builtintype" id="4095016">int</span><span class="op" id="4095019">)</span>&nbsp;<span class="op" id="4095021">(</span><span class="ident" id="4095022">syscall</span><span class="op" id="4095029">.</span><span class="ident" id="4095030">Sockaddr</span><span class="op" id="4095038">,</span>&nbsp;<span class="builtintype" id="4095040">error</span><span class="op" id="4095045">)</span>&nbsp;<span class="op" id="4095047">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4095050">if</span>&nbsp;<span class="ident" id="4095053">a</span>&nbsp;<span class="op" id="4095055">==</span>&nbsp;<span class="ident" id="4095058">nil</span>&nbsp;<span class="op" id="4095062">{</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4095066">return</span>&nbsp;<span class="ident" id="4095073">nil</span><span class="op" id="4095076">,</span>&nbsp;<span class="ident" id="4095078">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4095083">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4095086">return</span>&nbsp;<span class="ident" id="4095093">ipToSockaddr</span><span class="op" id="4095105">(</span><span class="ident" id="4095106">family</span><span class="op" id="4095112">,</span>&nbsp;<span class="ident" id="4095114">a</span><span class="op" id="4095115">.</span><span class="ident" id="4095116">IP</span><span class="op" id="4095118">,</span>&nbsp;<span class="num" id="4095120">0</span><span class="op" id="4095121">,</span>&nbsp;<span class="ident" id="4095123">a</span><span class="op" id="4095124">.</span><span class="ident" id="4095125">Zone</span><span class="op" id="4095129">)</span><br>
<span class="lineno"></span><span class="op" id="4095131">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="4095134">//&nbsp;IPConn&nbsp;is&nbsp;the&nbsp;implementation&nbsp;of&nbsp;the&nbsp;Conn&nbsp;and&nbsp;PacketConn&nbsp;interfaces</span><br>
<span class="lineno"></span><span class="comment" id="4095204">//&nbsp;for&nbsp;IP&nbsp;network&nbsp;connections.</span><br>
<span class="lineno"></span><span class="keyword" id="4095235">type</span>&nbsp;<span class="ident" id="4095240">IPConn</span>&nbsp;<span class="keyword" id="4095247">struct</span>&nbsp;<span class="op" id="4095254">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4095257">conn</span><br>
<span class="lineno"></span><span class="op" id="4095262">}</span><br>
<span class="lineno">65</span><br>
<span class="lineno"></span><span class="keyword" id="4095265">func</span>&nbsp;<span class="ident" id="4095270">newIPConn</span><span class="op" id="4095279">(</span><span class="ident" id="4095280">fd</span>&nbsp;<span class="op" id="4095283">*</span><span class="ident" id="4095284">netFD</span><span class="op" id="4095289">)</span>&nbsp;<span class="op" id="4095291">*</span><span class="ident" id="4095292">IPConn</span>&nbsp;<span class="op" id="4095299">{</span>&nbsp;<span class="keyword" id="4095301">return</span>&nbsp;<span class="op" id="4095308">&amp;</span><span class="ident" id="4095309">IPConn</span><span class="op" id="4095315">{</span><span class="ident" id="4095316">conn</span><span class="op" id="4095320">{</span><span class="ident" id="4095321">fd</span><span class="op" id="4095323">}</span><span class="op" id="4095324">}</span>&nbsp;<span class="op" id="4095326">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4095329">//&nbsp;ReadFromIP&nbsp;reads&nbsp;an&nbsp;IP&nbsp;packet&nbsp;from&nbsp;c,&nbsp;copying&nbsp;the&nbsp;payload&nbsp;into&nbsp;b.</span><br>
<span class="lineno"></span><span class="comment" id="4095398">//&nbsp;It&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;copied&nbsp;into&nbsp;b&nbsp;and&nbsp;the&nbsp;return&nbsp;address</span><br>
<span class="lineno">70</span><span class="comment" id="4095469">//&nbsp;that&nbsp;was&nbsp;on&nbsp;the&nbsp;packet.</span><br>
<span class="lineno"></span><span class="comment" id="4095496">//</span><br>
<span class="lineno"></span><span class="comment" id="4095499">//&nbsp;ReadFromIP&nbsp;can&nbsp;be&nbsp;made&nbsp;to&nbsp;time&nbsp;out&nbsp;and&nbsp;return&nbsp;an&nbsp;error&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="4095562">//&nbsp;Timeout()&nbsp;==&nbsp;true&nbsp;after&nbsp;a&nbsp;fixed&nbsp;time&nbsp;limit;&nbsp;see&nbsp;SetDeadline&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="4095629">//&nbsp;SetReadDeadline.</span><br>
<span class="lineno">75</span><span class="keyword" id="4095649">func</span>&nbsp;<span class="op" id="4095654">(</span><span class="ident" id="4095655">c</span>&nbsp;<span class="op" id="4095657">*</span><span class="ident" id="4095658">IPConn</span><span class="op" id="4095664">)</span>&nbsp;<span class="ident" id="4095666">ReadFromIP</span><span class="op" id="4095676">(</span><span class="ident" id="4095677">b</span>&nbsp;<span class="op" id="4095679">[</span><span class="op" id="4095680">]</span><span class="builtintype" id="4095681">byte</span><span class="op" id="4095685">)</span>&nbsp;<span class="op" id="4095687">(</span><span class="builtintype" id="4095688">int</span><span class="op" id="4095691">,</span>&nbsp;<span class="op" id="4095693">*</span><span class="ident" id="4095694">IPAddr</span><span class="op" id="4095700">,</span>&nbsp;<span class="builtintype" id="4095702">error</span><span class="op" id="4095707">)</span>&nbsp;<span class="op" id="4095709">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4095712">if</span>&nbsp;<span class="op" id="4095715">!</span><span class="ident" id="4095716">c</span><span class="op" id="4095717">.</span><span class="ident" id="4095718">ok</span><span class="op" id="4095720">(</span><span class="op" id="4095721">)</span>&nbsp;<span class="op" id="4095723">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4095727">return</span>&nbsp;<span class="num" id="4095734">0</span><span class="op" id="4095735">,</span>&nbsp;<span class="ident" id="4095737">nil</span><span class="op" id="4095740">,</span>&nbsp;<span class="ident" id="4095742">syscall</span><span class="op" id="4095749">.</span><span class="ident" id="4095750">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4095758">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4095761">//&nbsp;TODO(cw,rsc):&nbsp;consider&nbsp;using&nbsp;readv&nbsp;if&nbsp;we&nbsp;know&nbsp;the&nbsp;family</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="4095822">//&nbsp;type&nbsp;to&nbsp;avoid&nbsp;the&nbsp;header&nbsp;trim/copy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4095861">var</span>&nbsp;<span class="ident" id="4095865">addr</span>&nbsp;<span class="op" id="4095870">*</span><span class="ident" id="4095871">IPAddr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4095879">n</span><span class="op" id="4095880">,</span>&nbsp;<span class="ident" id="4095882">sa</span><span class="op" id="4095884">,</span>&nbsp;<span class="ident" id="4095886">err</span>&nbsp;<span class="op" id="4095890">:=</span>&nbsp;<span class="ident" id="4095893">c</span><span class="op" id="4095894">.</span><span class="ident" id="4095895">fd</span><span class="op" id="4095897">.</span><span class="ident" id="4095898">readFrom</span><span class="op" id="4095906">(</span><span class="ident" id="4095907">b</span><span class="op" id="4095908">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4095911">switch</span>&nbsp;<span class="ident" id="4095918">sa</span>&nbsp;<span class="op" id="4095921">:=</span>&nbsp;<span class="ident" id="4095924">sa</span><span class="op" id="4095926">.</span><span class="op" id="4095927">(</span><span class="keyword" id="4095928">type</span><span class="op" id="4095932">)</span>&nbsp;<span class="op" id="4095934">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4095937">case</span>&nbsp;<span class="op" id="4095942">*</span><span class="ident" id="4095943">syscall</span><span class="op" id="4095950">.</span><span class="ident" id="4095951">SockaddrInet4</span><span class="op" id="4095964">:</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4095968">addr</span>&nbsp;<span class="op" id="4095973">=</span>&nbsp;<span class="op" id="4095975">&amp;</span><span class="ident" id="4095976">IPAddr</span><span class="op" id="4095982">{</span><span class="ident" id="4095983">IP</span><span class="op" id="4095985">:</span>&nbsp;<span class="ident" id="4095987">sa</span><span class="op" id="4095989">.</span><span class="ident" id="4095990">Addr</span><span class="op" id="4095994">[</span><span class="num" id="4095995">0</span><span class="op" id="4095996">:</span><span class="op" id="4095997">]</span><span class="op" id="4095998">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4096002">if</span>&nbsp;<span class="builtinfunc" id="4096005">len</span><span class="op" id="4096008">(</span><span class="ident" id="4096009">b</span><span class="op" id="4096010">)</span>&nbsp;<span class="op" id="4096012">&gt;=</span>&nbsp;<span class="ident" id="4096015">IPv4len</span>&nbsp;<span class="op" id="4096023">{</span>&nbsp;<span class="comment" id="4096025">//&nbsp;discard&nbsp;ipv4&nbsp;header</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4096051">hsize</span>&nbsp;<span class="op" id="4096057">:=</span>&nbsp;<span class="op" id="4096060">(</span><span class="builtintype" id="4096061">int</span><span class="op" id="4096064">(</span><span class="ident" id="4096065">b</span><span class="op" id="4096066">[</span><span class="num" id="4096067">0</span><span class="op" id="4096068">]</span><span class="op" id="4096069">)</span>&nbsp;<span class="op" id="4096071">&amp;</span>&nbsp;<span class="num" id="4096073">0xf</span><span class="op" id="4096076">)</span>&nbsp;<span class="op" id="4096078">*</span>&nbsp;<span class="num" id="4096080">4</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="4096085">copy</span><span class="op" id="4096089">(</span><span class="ident" id="4096090">b</span><span class="op" id="4096091">,</span>&nbsp;<span class="ident" id="4096093">b</span><span class="op" id="4096094">[</span><span class="ident" id="4096095">hsize</span><span class="op" id="4096100">:</span><span class="op" id="4096101">]</span><span class="op" id="4096102">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4096107">n</span>&nbsp;<span class="op" id="4096109">-=</span>&nbsp;<span class="ident" id="4096112">hsize</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4096120">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4096123">case</span>&nbsp;<span class="op" id="4096128">*</span><span class="ident" id="4096129">syscall</span><span class="op" id="4096136">.</span><span class="ident" id="4096137">SockaddrInet6</span><span class="op" id="4096150">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4096154">addr</span>&nbsp;<span class="op" id="4096159">=</span>&nbsp;<span class="op" id="4096161">&amp;</span><span class="ident" id="4096162">IPAddr</span><span class="op" id="4096168">{</span><span class="ident" id="4096169">IP</span><span class="op" id="4096171">:</span>&nbsp;<span class="ident" id="4096173">sa</span><span class="op" id="4096175">.</span><span class="ident" id="4096176">Addr</span><span class="op" id="4096180">[</span><span class="num" id="4096181">0</span><span class="op" id="4096182">:</span><span class="op" id="4096183">]</span><span class="op" id="4096184">,</span>&nbsp;<span class="ident" id="4096186">Zone</span><span class="op" id="4096190">:</span>&nbsp;<span class="ident" id="4096192">zoneToString</span><span class="op" id="4096204">(</span><span class="builtintype" id="4096205">int</span><span class="op" id="4096208">(</span><span class="ident" id="4096209">sa</span><span class="op" id="4096211">.</span><span class="ident" id="4096212">ZoneId</span><span class="op" id="4096218">)</span><span class="op" id="4096219">)</span><span class="op" id="4096220">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4096223">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4096226">return</span>&nbsp;<span class="ident" id="4096233">n</span><span class="op" id="4096234">,</span>&nbsp;<span class="ident" id="4096236">addr</span><span class="op" id="4096240">,</span>&nbsp;<span class="ident" id="4096242">err</span><br>
<span class="lineno">95</span><span class="op" id="4096246">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4096249">//&nbsp;ReadFrom&nbsp;implements&nbsp;the&nbsp;PacketConn&nbsp;ReadFrom&nbsp;method.</span><br>
<span class="lineno"></span><span class="keyword" id="4096304">func</span>&nbsp;<span class="op" id="4096309">(</span><span class="ident" id="4096310">c</span>&nbsp;<span class="op" id="4096312">*</span><span class="ident" id="4096313">IPConn</span><span class="op" id="4096319">)</span>&nbsp;<span class="ident" id="4096321">ReadFrom</span><span class="op" id="4096329">(</span><span class="ident" id="4096330">b</span>&nbsp;<span class="op" id="4096332">[</span><span class="op" id="4096333">]</span><span class="builtintype" id="4096334">byte</span><span class="op" id="4096338">)</span>&nbsp;<span class="op" id="4096340">(</span><span class="builtintype" id="4096341">int</span><span class="op" id="4096344">,</span>&nbsp;<span class="ident" id="4096346">Addr</span><span class="op" id="4096350">,</span>&nbsp;<span class="builtintype" id="4096352">error</span><span class="op" id="4096357">)</span>&nbsp;<span class="op" id="4096359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4096362">if</span>&nbsp;<span class="op" id="4096365">!</span><span class="ident" id="4096366">c</span><span class="op" id="4096367">.</span><span class="ident" id="4096368">ok</span><span class="op" id="4096370">(</span><span class="op" id="4096371">)</span>&nbsp;<span class="op" id="4096373">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4096377">return</span>&nbsp;<span class="num" id="4096384">0</span><span class="op" id="4096385">,</span>&nbsp;<span class="ident" id="4096387">nil</span><span class="op" id="4096390">,</span>&nbsp;<span class="ident" id="4096392">syscall</span><span class="op" id="4096399">.</span><span class="ident" id="4096400">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4096408">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4096411">n</span><span class="op" id="4096412">,</span>&nbsp;<span class="ident" id="4096414">addr</span><span class="op" id="4096418">,</span>&nbsp;<span class="ident" id="4096420">err</span>&nbsp;<span class="op" id="4096424">:=</span>&nbsp;<span class="ident" id="4096427">c</span><span class="op" id="4096428">.</span><span class="ident" id="4096429">ReadFromIP</span><span class="op" id="4096439">(</span><span class="ident" id="4096440">b</span><span class="op" id="4096441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4096444">return</span>&nbsp;<span class="ident" id="4096451">n</span><span class="op" id="4096452">,</span>&nbsp;<span class="ident" id="4096454">addr</span><span class="op" id="4096458">.</span><span class="ident" id="4096459">toAddr</span><span class="op" id="4096465">(</span><span class="op" id="4096466">)</span><span class="op" id="4096467">,</span>&nbsp;<span class="ident" id="4096469">err</span><br>
<span class="lineno"></span><span class="op" id="4096473">}</span><br>
<span class="lineno">105</span><br>
<span class="lineno"></span><span class="comment" id="4096476">//&nbsp;ReadMsgIP&nbsp;reads&nbsp;a&nbsp;packet&nbsp;from&nbsp;c,&nbsp;copying&nbsp;the&nbsp;payload&nbsp;into&nbsp;b&nbsp;and&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4096547">//&nbsp;associated&nbsp;out-of-band&nbsp;data&nbsp;into&nbsp;oob.&nbsp;&nbsp;It&nbsp;returns&nbsp;the&nbsp;number&nbsp;of</span><br>
<span class="lineno"></span><span class="comment" id="4096614">//&nbsp;bytes&nbsp;copied&nbsp;into&nbsp;b,&nbsp;the&nbsp;number&nbsp;of&nbsp;bytes&nbsp;copied&nbsp;into&nbsp;oob,&nbsp;the&nbsp;flags</span><br>
<span class="lineno"></span><span class="comment" id="4096685">//&nbsp;that&nbsp;were&nbsp;set&nbsp;on&nbsp;the&nbsp;packet&nbsp;and&nbsp;the&nbsp;source&nbsp;address&nbsp;of&nbsp;the&nbsp;packet.</span><br>
<span class="lineno">110</span><span class="keyword" id="4096754">func</span>&nbsp;<span class="op" id="4096759">(</span><span class="ident" id="4096760">c</span>&nbsp;<span class="op" id="4096762">*</span><span class="ident" id="4096763">IPConn</span><span class="op" id="4096769">)</span>&nbsp;<span class="ident" id="4096771">ReadMsgIP</span><span class="op" id="4096780">(</span><span class="ident" id="4096781">b</span><span class="op" id="4096782">,</span>&nbsp;<span class="ident" id="4096784">oob</span>&nbsp;<span class="op" id="4096788">[</span><span class="op" id="4096789">]</span><span class="builtintype" id="4096790">byte</span><span class="op" id="4096794">)</span>&nbsp;<span class="op" id="4096796">(</span><span class="ident" id="4096797">n</span><span class="op" id="4096798">,</span>&nbsp;<span class="ident" id="4096800">oobn</span><span class="op" id="4096804">,</span>&nbsp;<span class="ident" id="4096806">flags</span>&nbsp;<span class="builtintype" id="4096812">int</span><span class="op" id="4096815">,</span>&nbsp;<span class="ident" id="4096817">addr</span>&nbsp;<span class="op" id="4096822">*</span><span class="ident" id="4096823">IPAddr</span><span class="op" id="4096829">,</span>&nbsp;<span class="ident" id="4096831">err</span>&nbsp;<span class="builtintype" id="4096835">error</span><span class="op" id="4096840">)</span>&nbsp;<span class="op" id="4096842">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4096845">if</span>&nbsp;<span class="op" id="4096848">!</span><span class="ident" id="4096849">c</span><span class="op" id="4096850">.</span><span class="ident" id="4096851">ok</span><span class="op" id="4096853">(</span><span class="op" id="4096854">)</span>&nbsp;<span class="op" id="4096856">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4096860">return</span>&nbsp;<span class="num" id="4096867">0</span><span class="op" id="4096868">,</span>&nbsp;<span class="num" id="4096870">0</span><span class="op" id="4096871">,</span>&nbsp;<span class="num" id="4096873">0</span><span class="op" id="4096874">,</span>&nbsp;<span class="ident" id="4096876">nil</span><span class="op" id="4096879">,</span>&nbsp;<span class="ident" id="4096881">syscall</span><span class="op" id="4096888">.</span><span class="ident" id="4096889">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4096897">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4096900">var</span>&nbsp;<span class="ident" id="4096904">sa</span>&nbsp;<span class="ident" id="4096907">syscall</span><span class="op" id="4096914">.</span><span class="ident" id="4096915">Sockaddr</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4096925">n</span><span class="op" id="4096926">,</span>&nbsp;<span class="ident" id="4096928">oobn</span><span class="op" id="4096932">,</span>&nbsp;<span class="ident" id="4096934">flags</span><span class="op" id="4096939">,</span>&nbsp;<span class="ident" id="4096941">sa</span><span class="op" id="4096943">,</span>&nbsp;<span class="ident" id="4096945">err</span>&nbsp;<span class="op" id="4096949">=</span>&nbsp;<span class="ident" id="4096951">c</span><span class="op" id="4096952">.</span><span class="ident" id="4096953">fd</span><span class="op" id="4096955">.</span><span class="ident" id="4096956">readMsg</span><span class="op" id="4096963">(</span><span class="ident" id="4096964">b</span><span class="op" id="4096965">,</span>&nbsp;<span class="ident" id="4096967">oob</span><span class="op" id="4096970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4096973">switch</span>&nbsp;<span class="ident" id="4096980">sa</span>&nbsp;<span class="op" id="4096983">:=</span>&nbsp;<span class="ident" id="4096986">sa</span><span class="op" id="4096988">.</span><span class="op" id="4096989">(</span><span class="keyword" id="4096990">type</span><span class="op" id="4096994">)</span>&nbsp;<span class="op" id="4096996">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4096999">case</span>&nbsp;<span class="op" id="4097004">*</span><span class="ident" id="4097005">syscall</span><span class="op" id="4097012">.</span><span class="ident" id="4097013">SockaddrInet4</span><span class="op" id="4097026">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4097030">addr</span>&nbsp;<span class="op" id="4097035">=</span>&nbsp;<span class="op" id="4097037">&amp;</span><span class="ident" id="4097038">IPAddr</span><span class="op" id="4097044">{</span><span class="ident" id="4097045">IP</span><span class="op" id="4097047">:</span>&nbsp;<span class="ident" id="4097049">sa</span><span class="op" id="4097051">.</span><span class="ident" id="4097052">Addr</span><span class="op" id="4097056">[</span><span class="num" id="4097057">0</span><span class="op" id="4097058">:</span><span class="op" id="4097059">]</span><span class="op" id="4097060">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4097063">case</span>&nbsp;<span class="op" id="4097068">*</span><span class="ident" id="4097069">syscall</span><span class="op" id="4097076">.</span><span class="ident" id="4097077">SockaddrInet6</span><span class="op" id="4097090">:</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4097094">addr</span>&nbsp;<span class="op" id="4097099">=</span>&nbsp;<span class="op" id="4097101">&amp;</span><span class="ident" id="4097102">IPAddr</span><span class="op" id="4097108">{</span><span class="ident" id="4097109">IP</span><span class="op" id="4097111">:</span>&nbsp;<span class="ident" id="4097113">sa</span><span class="op" id="4097115">.</span><span class="ident" id="4097116">Addr</span><span class="op" id="4097120">[</span><span class="num" id="4097121">0</span><span class="op" id="4097122">:</span><span class="op" id="4097123">]</span><span class="op" id="4097124">,</span>&nbsp;<span class="ident" id="4097126">Zone</span><span class="op" id="4097130">:</span>&nbsp;<span class="ident" id="4097132">zoneToString</span><span class="op" id="4097144">(</span><span class="builtintype" id="4097145">int</span><span class="op" id="4097148">(</span><span class="ident" id="4097149">sa</span><span class="op" id="4097151">.</span><span class="ident" id="4097152">ZoneId</span><span class="op" id="4097158">)</span><span class="op" id="4097159">)</span><span class="op" id="4097160">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4097163">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4097166">return</span><br>
<span class="lineno"></span><span class="op" id="4097173">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">125</span><span class="comment" id="4097176">//&nbsp;WriteToIP&nbsp;writes&nbsp;an&nbsp;IP&nbsp;packet&nbsp;to&nbsp;addr&nbsp;via&nbsp;c,&nbsp;copying&nbsp;the&nbsp;payload</span><br>
<span class="lineno"></span><span class="comment" id="4097244">//&nbsp;from&nbsp;b.</span><br>
<span class="lineno"></span><span class="comment" id="4097255">//</span><br>
<span class="lineno"></span><span class="comment" id="4097258">//&nbsp;WriteToIP&nbsp;can&nbsp;be&nbsp;made&nbsp;to&nbsp;time&nbsp;out&nbsp;and&nbsp;return&nbsp;an&nbsp;error&nbsp;with</span><br>
<span class="lineno"></span><span class="comment" id="4097320">//&nbsp;Timeout()&nbsp;==&nbsp;true&nbsp;after&nbsp;a&nbsp;fixed&nbsp;time&nbsp;limit;&nbsp;see&nbsp;SetDeadline&nbsp;and</span><br>
<span class="lineno">130</span><span class="comment" id="4097387">//&nbsp;SetWriteDeadline.&nbsp;&nbsp;On&nbsp;packet-oriented&nbsp;connections,&nbsp;write&nbsp;timeouts</span><br>
<span class="lineno"></span><span class="comment" id="4097456">//&nbsp;are&nbsp;rare.</span><br>
<span class="lineno"></span><span class="keyword" id="4097469">func</span>&nbsp;<span class="op" id="4097474">(</span><span class="ident" id="4097475">c</span>&nbsp;<span class="op" id="4097477">*</span><span class="ident" id="4097478">IPConn</span><span class="op" id="4097484">)</span>&nbsp;<span class="ident" id="4097486">WriteToIP</span><span class="op" id="4097495">(</span><span class="ident" id="4097496">b</span>&nbsp;<span class="op" id="4097498">[</span><span class="op" id="4097499">]</span><span class="builtintype" id="4097500">byte</span><span class="op" id="4097504">,</span>&nbsp;<span class="ident" id="4097506">addr</span>&nbsp;<span class="op" id="4097511">*</span><span class="ident" id="4097512">IPAddr</span><span class="op" id="4097518">)</span>&nbsp;<span class="op" id="4097520">(</span><span class="builtintype" id="4097521">int</span><span class="op" id="4097524">,</span>&nbsp;<span class="builtintype" id="4097526">error</span><span class="op" id="4097531">)</span>&nbsp;<span class="op" id="4097533">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4097536">if</span>&nbsp;<span class="op" id="4097539">!</span><span class="ident" id="4097540">c</span><span class="op" id="4097541">.</span><span class="ident" id="4097542">ok</span><span class="op" id="4097544">(</span><span class="op" id="4097545">)</span>&nbsp;<span class="op" id="4097547">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4097551">return</span>&nbsp;<span class="num" id="4097558">0</span><span class="op" id="4097559">,</span>&nbsp;<span class="ident" id="4097561">syscall</span><span class="op" id="4097568">.</span><span class="ident" id="4097569">EINVAL</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4097577">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4097580">if</span>&nbsp;<span class="ident" id="4097583">c</span><span class="op" id="4097584">.</span><span class="ident" id="4097585">fd</span><span class="op" id="4097587">.</span><span class="ident" id="4097588">isConnected</span>&nbsp;<span class="op" id="4097600">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4097604">return</span>&nbsp;<span class="num" id="4097611">0</span><span class="op" id="4097612">,</span>&nbsp;<span class="op" id="4097614">&amp;</span><span class="ident" id="4097615">OpError</span><span class="op" id="4097622">{</span><span class="ident" id="4097623">Op</span><span class="op" id="4097625">:</span>&nbsp;<span class="string" id="4097627">&#34;write&#34;</span><span class="op" id="4097634">,</span>&nbsp;<span class="ident" id="4097636">Net</span><span class="op" id="4097639">:</span>&nbsp;<span class="ident" id="4097641">c</span><span class="op" id="4097642">.</span><span class="ident" id="4097643">fd</span><span class="op" id="4097645">.</span><span class="ident" id="4097646">net</span><span class="op" id="4097649">,</span>&nbsp;<span class="ident" id="4097651">Addr</span><span class="op" id="4097655">:</span>&nbsp;<span class="ident" id="4097657">addr</span><span class="op" id="4097661">,</span>&nbsp;<span class="ident" id="4097663">Err</span><span class="op" id="4097666">:</span>&nbsp;<span class="ident" id="4097668">ErrWriteToConnected</span><span class="op" id="4097687">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4097690">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4097693">if</span>&nbsp;<span class="ident" id="4097696">addr</span>&nbsp;<span class="op" id="4097701">==</span>&nbsp;<span class="ident" id="4097704">nil</span>&nbsp;<span class="op" id="4097708">{</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4097712">return</span>&nbsp;<span class="num" id="4097719">0</span><span class="op" id="4097720">,</span>&nbsp;<span class="op" id="4097722">&amp;</span><span class="ident" id="4097723">OpError</span><span class="op" id="4097730">{</span><span class="ident" id="4097731">Op</span><span class="op" id="4097733">:</span>&nbsp;<span class="string" id="4097735">&#34;write&#34;</span><span class="op" id="4097742">,</span>&nbsp;<span class="ident" id="4097744">Net</span><span class="op" id="4097747">:</span>&nbsp;<span class="ident" id="4097749">c</span><span class="op" id="4097750">.</span><span class="ident" id="4097751">fd</span><span class="op" id="4097753">.</span><span class="ident" id="4097754">net</span><span class="op" id="4097757">,</span>&nbsp;<span class="ident" id="4097759">Addr</span><span class="op" id="4097763">:</span>&nbsp;<span class="ident" id="4097765">nil</span><span class="op" id="4097768">,</span>&nbsp;<span class="ident" id="4097770">Err</span><span class="op" id="4097773">:</span>&nbsp;<span class="ident" id="4097775">errMissingAddress</span><span class="op" id="4097792">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4097795">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4097798">sa</span><span class="op" id="4097800">,</span>&nbsp;<span class="ident" id="4097802">err</span>&nbsp;<span class="op" id="4097806">:=</span>&nbsp;<span class="ident" id="4097809">addr</span><span class="op" id="4097813">.</span><span class="ident" id="4097814">sockaddr</span><span class="op" id="4097822">(</span><span class="ident" id="4097823">c</span><span class="op" id="4097824">.</span><span class="ident" id="4097825">fd</span><span class="op" id="4097827">.</span><span class="ident" id="4097828">family</span><span class="op" id="4097834">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4097837">if</span>&nbsp;<span class="ident" id="4097840">err</span>&nbsp;<span class="op" id="4097844">!=</span>&nbsp;<span class="ident" id="4097847">nil</span>&nbsp;<span class="op" id="4097851">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4097855">return</span>&nbsp;<span class="num" id="4097862">0</span><span class="op" id="4097863">,</span>&nbsp;<span class="op" id="4097865">&amp;</span><span class="ident" id="4097866">OpError</span><span class="op" id="4097873">{</span><span class="string" id="4097874">&#34;write&#34;</span><span class="op" id="4097881">,</span>&nbsp;<span class="ident" id="4097883">c</span><span class="op" id="4097884">.</span><span class="ident" id="4097885">fd</span><span class="op" id="4097887">.</span><span class="ident" id="4097888">net</span><span class="op" id="4097891">,</span>&nbsp;<span class="ident" id="4097893">addr</span><span class="op" id="4097897">,</span>&nbsp;<span class="ident" id="4097899">err</span><span class="op" id="4097902">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4097905">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4097908">return</span>&nbsp;<span class="ident" id="4097915">c</span><span class="op" id="4097916">.</span><span class="ident" id="4097917">fd</span><span class="op" id="4097919">.</span><span class="ident" id="4097920">writeTo</span><span class="op" id="4097927">(</span><span class="ident" id="4097928">b</span><span class="op" id="4097929">,</span>&nbsp;<span class="ident" id="4097931">sa</span><span class="op" id="4097933">)</span><br>
<span class="lineno"></span><span class="op" id="4097935">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4097938">//&nbsp;WriteTo&nbsp;implements&nbsp;the&nbsp;PacketConn&nbsp;WriteTo&nbsp;method.</span><br>
<span class="lineno">150</span><span class="keyword" id="4097991">func</span>&nbsp;<span class="op" id="4097996">(</span><span class="ident" id="4097997">c</span>&nbsp;<span class="op" id="4097999">*</span><span class="ident" id="4098000">IPConn</span><span class="op" id="4098006">)</span>&nbsp;<span class="ident" id="4098008">WriteTo</span><span class="op" id="4098015">(</span><span class="ident" id="4098016">b</span>&nbsp;<span class="op" id="4098018">[</span><span class="op" id="4098019">]</span><span class="builtintype" id="4098020">byte</span><span class="op" id="4098024">,</span>&nbsp;<span class="ident" id="4098026">addr</span>&nbsp;<span class="ident" id="4098031">Addr</span><span class="op" id="4098035">)</span>&nbsp;<span class="op" id="4098037">(</span><span class="builtintype" id="4098038">int</span><span class="op" id="4098041">,</span>&nbsp;<span class="builtintype" id="4098043">error</span><span class="op" id="4098048">)</span>&nbsp;<span class="op" id="4098050">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4098053">if</span>&nbsp;<span class="op" id="4098056">!</span><span class="ident" id="4098057">c</span><span class="op" id="4098058">.</span><span class="ident" id="4098059">ok</span><span class="op" id="4098061">(</span><span class="op" id="4098062">)</span>&nbsp;<span class="op" id="4098064">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4098068">return</span>&nbsp;<span class="num" id="4098075">0</span><span class="op" id="4098076">,</span>&nbsp;<span class="ident" id="4098078">syscall</span><span class="op" id="4098085">.</span><span class="ident" id="4098086">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4098094">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4098097">a</span><span class="op" id="4098098">,</span>&nbsp;<span class="ident" id="4098100">ok</span>&nbsp;<span class="op" id="4098103">:=</span>&nbsp;<span class="ident" id="4098106">addr</span><span class="op" id="4098110">.</span><span class="op" id="4098111">(</span><span class="op" id="4098112">*</span><span class="ident" id="4098113">IPAddr</span><span class="op" id="4098119">)</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4098122">if</span>&nbsp;<span class="op" id="4098125">!</span><span class="ident" id="4098126">ok</span>&nbsp;<span class="op" id="4098129">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4098133">return</span>&nbsp;<span class="num" id="4098140">0</span><span class="op" id="4098141">,</span>&nbsp;<span class="op" id="4098143">&amp;</span><span class="ident" id="4098144">OpError</span><span class="op" id="4098151">{</span><span class="string" id="4098152">&#34;write&#34;</span><span class="op" id="4098159">,</span>&nbsp;<span class="ident" id="4098161">c</span><span class="op" id="4098162">.</span><span class="ident" id="4098163">fd</span><span class="op" id="4098165">.</span><span class="ident" id="4098166">net</span><span class="op" id="4098169">,</span>&nbsp;<span class="ident" id="4098171">addr</span><span class="op" id="4098175">,</span>&nbsp;<span class="ident" id="4098177">syscall</span><span class="op" id="4098184">.</span><span class="ident" id="4098185">EINVAL</span><span class="op" id="4098191">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4098194">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4098197">return</span>&nbsp;<span class="ident" id="4098204">c</span><span class="op" id="4098205">.</span><span class="ident" id="4098206">WriteToIP</span><span class="op" id="4098215">(</span><span class="ident" id="4098216">b</span><span class="op" id="4098217">,</span>&nbsp;<span class="ident" id="4098219">a</span><span class="op" id="4098220">)</span><br>
<span class="lineno"></span><span class="op" id="4098222">}</span><br>
<span class="lineno">160</span><br>
<span class="lineno"></span><span class="comment" id="4098225">//&nbsp;WriteMsgIP&nbsp;writes&nbsp;a&nbsp;packet&nbsp;to&nbsp;addr&nbsp;via&nbsp;c,&nbsp;copying&nbsp;the&nbsp;payload&nbsp;from</span><br>
<span class="lineno"></span><span class="comment" id="4098295">//&nbsp;b&nbsp;and&nbsp;the&nbsp;associated&nbsp;out-of-band&nbsp;data&nbsp;from&nbsp;oob.&nbsp;&nbsp;It&nbsp;returns&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="4098362">//&nbsp;number&nbsp;of&nbsp;payload&nbsp;and&nbsp;out-of-band&nbsp;bytes&nbsp;written.</span><br>
<span class="lineno"></span><span class="keyword" id="4098414">func</span>&nbsp;<span class="op" id="4098419">(</span><span class="ident" id="4098420">c</span>&nbsp;<span class="op" id="4098422">*</span><span class="ident" id="4098423">IPConn</span><span class="op" id="4098429">)</span>&nbsp;<span class="ident" id="4098431">WriteMsgIP</span><span class="op" id="4098441">(</span><span class="ident" id="4098442">b</span><span class="op" id="4098443">,</span>&nbsp;<span class="ident" id="4098445">oob</span>&nbsp;<span class="op" id="4098449">[</span><span class="op" id="4098450">]</span><span class="builtintype" id="4098451">byte</span><span class="op" id="4098455">,</span>&nbsp;<span class="ident" id="4098457">addr</span>&nbsp;<span class="op" id="4098462">*</span><span class="ident" id="4098463">IPAddr</span><span class="op" id="4098469">)</span>&nbsp;<span class="op" id="4098471">(</span><span class="ident" id="4098472">n</span><span class="op" id="4098473">,</span>&nbsp;<span class="ident" id="4098475">oobn</span>&nbsp;<span class="builtintype" id="4098480">int</span><span class="op" id="4098483">,</span>&nbsp;<span class="ident" id="4098485">err</span>&nbsp;<span class="builtintype" id="4098489">error</span><span class="op" id="4098494">)</span>&nbsp;<span class="op" id="4098496">{</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4098499">if</span>&nbsp;<span class="op" id="4098502">!</span><span class="ident" id="4098503">c</span><span class="op" id="4098504">.</span><span class="ident" id="4098505">ok</span><span class="op" id="4098507">(</span><span class="op" id="4098508">)</span>&nbsp;<span class="op" id="4098510">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4098514">return</span>&nbsp;<span class="num" id="4098521">0</span><span class="op" id="4098522">,</span>&nbsp;<span class="num" id="4098524">0</span><span class="op" id="4098525">,</span>&nbsp;<span class="ident" id="4098527">syscall</span><span class="op" id="4098534">.</span><span class="ident" id="4098535">EINVAL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4098543">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4098546">if</span>&nbsp;<span class="ident" id="4098549">c</span><span class="op" id="4098550">.</span><span class="ident" id="4098551">fd</span><span class="op" id="4098553">.</span><span class="ident" id="4098554">isConnected</span>&nbsp;<span class="op" id="4098566">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4098570">return</span>&nbsp;<span class="num" id="4098577">0</span><span class="op" id="4098578">,</span>&nbsp;<span class="num" id="4098580">0</span><span class="op" id="4098581">,</span>&nbsp;<span class="op" id="4098583">&amp;</span><span class="ident" id="4098584">OpError</span><span class="op" id="4098591">{</span><span class="ident" id="4098592">Op</span><span class="op" id="4098594">:</span>&nbsp;<span class="string" id="4098596">&#34;write&#34;</span><span class="op" id="4098603">,</span>&nbsp;<span class="ident" id="4098605">Net</span><span class="op" id="4098608">:</span>&nbsp;<span class="ident" id="4098610">c</span><span class="op" id="4098611">.</span><span class="ident" id="4098612">fd</span><span class="op" id="4098614">.</span><span class="ident" id="4098615">net</span><span class="op" id="4098618">,</span>&nbsp;<span class="ident" id="4098620">Addr</span><span class="op" id="4098624">:</span>&nbsp;<span class="ident" id="4098626">addr</span><span class="op" id="4098630">,</span>&nbsp;<span class="ident" id="4098632">Err</span><span class="op" id="4098635">:</span>&nbsp;<span class="ident" id="4098637">ErrWriteToConnected</span><span class="op" id="4098656">}</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4098659">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4098662">if</span>&nbsp;<span class="ident" id="4098665">addr</span>&nbsp;<span class="op" id="4098670">==</span>&nbsp;<span class="ident" id="4098673">nil</span>&nbsp;<span class="op" id="4098677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4098681">return</span>&nbsp;<span class="num" id="4098688">0</span><span class="op" id="4098689">,</span>&nbsp;<span class="num" id="4098691">0</span><span class="op" id="4098692">,</span>&nbsp;<span class="op" id="4098694">&amp;</span><span class="ident" id="4098695">OpError</span><span class="op" id="4098702">{</span><span class="ident" id="4098703">Op</span><span class="op" id="4098705">:</span>&nbsp;<span class="string" id="4098707">&#34;write&#34;</span><span class="op" id="4098714">,</span>&nbsp;<span class="ident" id="4098716">Net</span><span class="op" id="4098719">:</span>&nbsp;<span class="ident" id="4098721">c</span><span class="op" id="4098722">.</span><span class="ident" id="4098723">fd</span><span class="op" id="4098725">.</span><span class="ident" id="4098726">net</span><span class="op" id="4098729">,</span>&nbsp;<span class="ident" id="4098731">Addr</span><span class="op" id="4098735">:</span>&nbsp;<span class="ident" id="4098737">nil</span><span class="op" id="4098740">,</span>&nbsp;<span class="ident" id="4098742">Err</span><span class="op" id="4098745">:</span>&nbsp;<span class="ident" id="4098747">errMissingAddress</span><span class="op" id="4098764">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4098767">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4098770">sa</span><span class="op" id="4098772">,</span>&nbsp;<span class="ident" id="4098774">err</span>&nbsp;<span class="op" id="4098778">:=</span>&nbsp;<span class="ident" id="4098781">addr</span><span class="op" id="4098785">.</span><span class="ident" id="4098786">sockaddr</span><span class="op" id="4098794">(</span><span class="ident" id="4098795">c</span><span class="op" id="4098796">.</span><span class="ident" id="4098797">fd</span><span class="op" id="4098799">.</span><span class="ident" id="4098800">family</span><span class="op" id="4098806">)</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4098809">if</span>&nbsp;<span class="ident" id="4098812">err</span>&nbsp;<span class="op" id="4098816">!=</span>&nbsp;<span class="ident" id="4098819">nil</span>&nbsp;<span class="op" id="4098823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4098827">return</span>&nbsp;<span class="num" id="4098834">0</span><span class="op" id="4098835">,</span>&nbsp;<span class="num" id="4098837">0</span><span class="op" id="4098838">,</span>&nbsp;<span class="op" id="4098840">&amp;</span><span class="ident" id="4098841">OpError</span><span class="op" id="4098848">{</span><span class="string" id="4098849">&#34;write&#34;</span><span class="op" id="4098856">,</span>&nbsp;<span class="ident" id="4098858">c</span><span class="op" id="4098859">.</span><span class="ident" id="4098860">fd</span><span class="op" id="4098862">.</span><span class="ident" id="4098863">net</span><span class="op" id="4098866">,</span>&nbsp;<span class="ident" id="4098868">addr</span><span class="op" id="4098872">,</span>&nbsp;<span class="ident" id="4098874">err</span><span class="op" id="4098877">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4098880">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4098883">return</span>&nbsp;<span class="ident" id="4098890">c</span><span class="op" id="4098891">.</span><span class="ident" id="4098892">fd</span><span class="op" id="4098894">.</span><span class="ident" id="4098895">writeMsg</span><span class="op" id="4098903">(</span><span class="ident" id="4098904">b</span><span class="op" id="4098905">,</span>&nbsp;<span class="ident" id="4098907">oob</span><span class="op" id="4098910">,</span>&nbsp;<span class="ident" id="4098912">sa</span><span class="op" id="4098914">)</span><br>
<span class="lineno"></span><span class="op" id="4098916">}</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span><span class="comment" id="4098919">//&nbsp;DialIP&nbsp;connects&nbsp;to&nbsp;the&nbsp;remote&nbsp;address&nbsp;raddr&nbsp;on&nbsp;the&nbsp;network&nbsp;protocol</span><br>
<span class="lineno"></span><span class="comment" id="4098990">//&nbsp;netProto,&nbsp;which&nbsp;must&nbsp;be&nbsp;&#34;ip&#34;,&nbsp;&#34;ip4&#34;,&nbsp;or&nbsp;&#34;ip6&#34;&nbsp;followed&nbsp;by&nbsp;a&nbsp;colon</span><br>
<span class="lineno"></span><span class="comment" id="4099059">//&nbsp;and&nbsp;a&nbsp;protocol&nbsp;number&nbsp;or&nbsp;name.</span><br>
<span class="lineno"></span><span class="keyword" id="4099093">func</span>&nbsp;<span class="ident" id="4099098">DialIP</span><span class="op" id="4099104">(</span><span class="ident" id="4099105">netProto</span>&nbsp;<span class="builtintype" id="4099114">string</span><span class="op" id="4099120">,</span>&nbsp;<span class="ident" id="4099122">laddr</span><span class="op" id="4099127">,</span>&nbsp;<span class="ident" id="4099129">raddr</span>&nbsp;<span class="op" id="4099135">*</span><span class="ident" id="4099136">IPAddr</span><span class="op" id="4099142">)</span>&nbsp;<span class="op" id="4099144">(</span><span class="op" id="4099145">*</span><span class="ident" id="4099146">IPConn</span><span class="op" id="4099152">,</span>&nbsp;<span class="builtintype" id="4099154">error</span><span class="op" id="4099159">)</span>&nbsp;<span class="op" id="4099161">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4099164">return</span>&nbsp;<span class="ident" id="4099171">dialIP</span><span class="op" id="4099177">(</span><span class="ident" id="4099178">netProto</span><span class="op" id="4099186">,</span>&nbsp;<span class="ident" id="4099188">laddr</span><span class="op" id="4099193">,</span>&nbsp;<span class="ident" id="4099195">raddr</span><span class="op" id="4099200">,</span>&nbsp;<span class="ident" id="4099202">noDeadline</span><span class="op" id="4099212">)</span><br>
<span class="lineno"></span><span class="op" id="4099214">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="4099217">func</span>&nbsp;<span class="ident" id="4099222">dialIP</span><span class="op" id="4099228">(</span><span class="ident" id="4099229">netProto</span>&nbsp;<span class="builtintype" id="4099238">string</span><span class="op" id="4099244">,</span>&nbsp;<span class="ident" id="4099246">laddr</span><span class="op" id="4099251">,</span>&nbsp;<span class="ident" id="4099253">raddr</span>&nbsp;<span class="op" id="4099259">*</span><span class="ident" id="4099260">IPAddr</span><span class="op" id="4099266">,</span>&nbsp;<span class="ident" id="4099268">deadline</span>&nbsp;<span class="ident" id="4099277">time</span><span class="op" id="4099281">.</span><span class="ident" id="4099282">Time</span><span class="op" id="4099286">)</span>&nbsp;<span class="op" id="4099288">(</span><span class="op" id="4099289">*</span><span class="ident" id="4099290">IPConn</span><span class="op" id="4099296">,</span>&nbsp;<span class="builtintype" id="4099298">error</span><span class="op" id="4099303">)</span>&nbsp;<span class="op" id="4099305">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4099308">net</span><span class="op" id="4099311">,</span>&nbsp;<span class="ident" id="4099313">proto</span><span class="op" id="4099318">,</span>&nbsp;<span class="ident" id="4099320">err</span>&nbsp;<span class="op" id="4099324">:=</span>&nbsp;<span class="ident" id="4099327">parseNetwork</span><span class="op" id="4099339">(</span><span class="ident" id="4099340">netProto</span><span class="op" id="4099348">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4099351">if</span>&nbsp;<span class="ident" id="4099354">err</span>&nbsp;<span class="op" id="4099358">!=</span>&nbsp;<span class="ident" id="4099361">nil</span>&nbsp;<span class="op" id="4099365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4099369">return</span>&nbsp;<span class="ident" id="4099376">nil</span><span class="op" id="4099379">,</span>&nbsp;<span class="op" id="4099381">&amp;</span><span class="ident" id="4099382">OpError</span><span class="op" id="4099389">{</span><span class="ident" id="4099390">Op</span><span class="op" id="4099392">:</span>&nbsp;<span class="string" id="4099394">&#34;dial&#34;</span><span class="op" id="4099400">,</span>&nbsp;<span class="ident" id="4099402">Net</span><span class="op" id="4099405">:</span>&nbsp;<span class="ident" id="4099407">netProto</span><span class="op" id="4099415">,</span>&nbsp;<span class="ident" id="4099417">Addr</span><span class="op" id="4099421">:</span>&nbsp;<span class="ident" id="4099423">raddr</span><span class="op" id="4099428">,</span>&nbsp;<span class="ident" id="4099430">Err</span><span class="op" id="4099433">:</span>&nbsp;<span class="ident" id="4099435">err</span><span class="op" id="4099438">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4099441">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4099444">switch</span>&nbsp;<span class="ident" id="4099451">net</span>&nbsp;<span class="op" id="4099455">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4099458">case</span>&nbsp;<span class="string" id="4099463">&#34;ip&#34;</span><span class="op" id="4099467">,</span>&nbsp;<span class="string" id="4099469">&#34;ip4&#34;</span><span class="op" id="4099474">,</span>&nbsp;<span class="string" id="4099476">&#34;ip6&#34;</span><span class="op" id="4099481">:</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4099484">default</span><span class="op" id="4099491">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4099495">return</span>&nbsp;<span class="ident" id="4099502">nil</span><span class="op" id="4099505">,</span>&nbsp;<span class="op" id="4099507">&amp;</span><span class="ident" id="4099508">OpError</span><span class="op" id="4099515">{</span><span class="ident" id="4099516">Op</span><span class="op" id="4099518">:</span>&nbsp;<span class="string" id="4099520">&#34;dial&#34;</span><span class="op" id="4099526">,</span>&nbsp;<span class="ident" id="4099528">Net</span><span class="op" id="4099531">:</span>&nbsp;<span class="ident" id="4099533">netProto</span><span class="op" id="4099541">,</span>&nbsp;<span class="ident" id="4099543">Addr</span><span class="op" id="4099547">:</span>&nbsp;<span class="ident" id="4099549">raddr</span><span class="op" id="4099554">,</span>&nbsp;<span class="ident" id="4099556">Err</span><span class="op" id="4099559">:</span>&nbsp;<span class="ident" id="4099561">UnknownNetworkError</span><span class="op" id="4099580">(</span><span class="ident" id="4099581">netProto</span><span class="op" id="4099589">)</span><span class="op" id="4099590">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4099593">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4099596">if</span>&nbsp;<span class="ident" id="4099599">raddr</span>&nbsp;<span class="op" id="4099605">==</span>&nbsp;<span class="ident" id="4099608">nil</span>&nbsp;<span class="op" id="4099612">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4099616">return</span>&nbsp;<span class="ident" id="4099623">nil</span><span class="op" id="4099626">,</span>&nbsp;<span class="op" id="4099628">&amp;</span><span class="ident" id="4099629">OpError</span><span class="op" id="4099636">{</span><span class="ident" id="4099637">Op</span><span class="op" id="4099639">:</span>&nbsp;<span class="string" id="4099641">&#34;dial&#34;</span><span class="op" id="4099647">,</span>&nbsp;<span class="ident" id="4099649">Net</span><span class="op" id="4099652">:</span>&nbsp;<span class="ident" id="4099654">netProto</span><span class="op" id="4099662">,</span>&nbsp;<span class="ident" id="4099664">Addr</span><span class="op" id="4099668">:</span>&nbsp;<span class="ident" id="4099670">nil</span><span class="op" id="4099673">,</span>&nbsp;<span class="ident" id="4099675">Err</span><span class="op" id="4099678">:</span>&nbsp;<span class="ident" id="4099680">errMissingAddress</span><span class="op" id="4099697">}</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4099700">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4099703">fd</span><span class="op" id="4099705">,</span>&nbsp;<span class="ident" id="4099707">err</span>&nbsp;<span class="op" id="4099711">:=</span>&nbsp;<span class="ident" id="4099714">internetSocket</span><span class="op" id="4099728">(</span><span class="ident" id="4099729">net</span><span class="op" id="4099732">,</span>&nbsp;<span class="ident" id="4099734">laddr</span><span class="op" id="4099739">,</span>&nbsp;<span class="ident" id="4099741">raddr</span><span class="op" id="4099746">,</span>&nbsp;<span class="ident" id="4099748">deadline</span><span class="op" id="4099756">,</span>&nbsp;<span class="ident" id="4099758">syscall</span><span class="op" id="4099765">.</span><span class="ident" id="4099766">SOCK_RAW</span><span class="op" id="4099774">,</span>&nbsp;<span class="ident" id="4099776">proto</span><span class="op" id="4099781">,</span>&nbsp;<span class="string" id="4099783">&#34;dial&#34;</span><span class="op" id="4099789">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4099792">if</span>&nbsp;<span class="ident" id="4099795">err</span>&nbsp;<span class="op" id="4099799">!=</span>&nbsp;<span class="ident" id="4099802">nil</span>&nbsp;<span class="op" id="4099806">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4099810">return</span>&nbsp;<span class="ident" id="4099817">nil</span><span class="op" id="4099820">,</span>&nbsp;<span class="op" id="4099822">&amp;</span><span class="ident" id="4099823">OpError</span><span class="op" id="4099830">{</span><span class="ident" id="4099831">Op</span><span class="op" id="4099833">:</span>&nbsp;<span class="string" id="4099835">&#34;dial&#34;</span><span class="op" id="4099841">,</span>&nbsp;<span class="ident" id="4099843">Net</span><span class="op" id="4099846">:</span>&nbsp;<span class="ident" id="4099848">netProto</span><span class="op" id="4099856">,</span>&nbsp;<span class="ident" id="4099858">Addr</span><span class="op" id="4099862">:</span>&nbsp;<span class="ident" id="4099864">raddr</span><span class="op" id="4099869">,</span>&nbsp;<span class="ident" id="4099871">Err</span><span class="op" id="4099874">:</span>&nbsp;<span class="ident" id="4099876">err</span><span class="op" id="4099879">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4099882">}</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4099885">return</span>&nbsp;<span class="ident" id="4099892">newIPConn</span><span class="op" id="4099901">(</span><span class="ident" id="4099902">fd</span><span class="op" id="4099904">)</span><span class="op" id="4099905">,</span>&nbsp;<span class="ident" id="4099907">nil</span><br>
<span class="lineno"></span><span class="op" id="4099911">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="4099914">//&nbsp;ListenIP&nbsp;listens&nbsp;for&nbsp;incoming&nbsp;IP&nbsp;packets&nbsp;addressed&nbsp;to&nbsp;the&nbsp;local</span><br>
<span class="lineno"></span><span class="comment" id="4099981">//&nbsp;address&nbsp;laddr.&nbsp;&nbsp;The&nbsp;returned&nbsp;connection&#39;s&nbsp;ReadFrom&nbsp;and&nbsp;WriteTo</span><br>
<span class="lineno">210</span><span class="comment" id="4100047">//&nbsp;methods&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;receive&nbsp;and&nbsp;send&nbsp;IP&nbsp;packets&nbsp;with&nbsp;per-packet</span><br>
<span class="lineno"></span><span class="comment" id="4100117">//&nbsp;addressing.</span><br>
<span class="lineno"></span><span class="keyword" id="4100132">func</span>&nbsp;<span class="ident" id="4100137">ListenIP</span><span class="op" id="4100145">(</span><span class="ident" id="4100146">netProto</span>&nbsp;<span class="builtintype" id="4100155">string</span><span class="op" id="4100161">,</span>&nbsp;<span class="ident" id="4100163">laddr</span>&nbsp;<span class="op" id="4100169">*</span><span class="ident" id="4100170">IPAddr</span><span class="op" id="4100176">)</span>&nbsp;<span class="op" id="4100178">(</span><span class="op" id="4100179">*</span><span class="ident" id="4100180">IPConn</span><span class="op" id="4100186">,</span>&nbsp;<span class="builtintype" id="4100188">error</span><span class="op" id="4100193">)</span>&nbsp;<span class="op" id="4100195">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4100198">net</span><span class="op" id="4100201">,</span>&nbsp;<span class="ident" id="4100203">proto</span><span class="op" id="4100208">,</span>&nbsp;<span class="ident" id="4100210">err</span>&nbsp;<span class="op" id="4100214">:=</span>&nbsp;<span class="ident" id="4100217">parseNetwork</span><span class="op" id="4100229">(</span><span class="ident" id="4100230">netProto</span><span class="op" id="4100238">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4100241">if</span>&nbsp;<span class="ident" id="4100244">err</span>&nbsp;<span class="op" id="4100248">!=</span>&nbsp;<span class="ident" id="4100251">nil</span>&nbsp;<span class="op" id="4100255">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4100259">return</span>&nbsp;<span class="ident" id="4100266">nil</span><span class="op" id="4100269">,</span>&nbsp;<span class="op" id="4100271">&amp;</span><span class="ident" id="4100272">OpError</span><span class="op" id="4100279">{</span><span class="ident" id="4100280">Op</span><span class="op" id="4100282">:</span>&nbsp;<span class="string" id="4100284">&#34;dial&#34;</span><span class="op" id="4100290">,</span>&nbsp;<span class="ident" id="4100292">Net</span><span class="op" id="4100295">:</span>&nbsp;<span class="ident" id="4100297">netProto</span><span class="op" id="4100305">,</span>&nbsp;<span class="ident" id="4100307">Addr</span><span class="op" id="4100311">:</span>&nbsp;<span class="ident" id="4100313">laddr</span><span class="op" id="4100318">,</span>&nbsp;<span class="ident" id="4100320">Err</span><span class="op" id="4100323">:</span>&nbsp;<span class="ident" id="4100325">err</span><span class="op" id="4100328">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4100331">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4100334">switch</span>&nbsp;<span class="ident" id="4100341">net</span>&nbsp;<span class="op" id="4100345">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4100348">case</span>&nbsp;<span class="string" id="4100353">&#34;ip&#34;</span><span class="op" id="4100357">,</span>&nbsp;<span class="string" id="4100359">&#34;ip4&#34;</span><span class="op" id="4100364">,</span>&nbsp;<span class="string" id="4100366">&#34;ip6&#34;</span><span class="op" id="4100371">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4100374">default</span><span class="op" id="4100381">:</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4100385">return</span>&nbsp;<span class="ident" id="4100392">nil</span><span class="op" id="4100395">,</span>&nbsp;<span class="op" id="4100397">&amp;</span><span class="ident" id="4100398">OpError</span><span class="op" id="4100405">{</span><span class="ident" id="4100406">Op</span><span class="op" id="4100408">:</span>&nbsp;<span class="string" id="4100410">&#34;listen&#34;</span><span class="op" id="4100418">,</span>&nbsp;<span class="ident" id="4100420">Net</span><span class="op" id="4100423">:</span>&nbsp;<span class="ident" id="4100425">netProto</span><span class="op" id="4100433">,</span>&nbsp;<span class="ident" id="4100435">Addr</span><span class="op" id="4100439">:</span>&nbsp;<span class="ident" id="4100441">laddr</span><span class="op" id="4100446">,</span>&nbsp;<span class="ident" id="4100448">Err</span><span class="op" id="4100451">:</span>&nbsp;<span class="ident" id="4100453">UnknownNetworkError</span><span class="op" id="4100472">(</span><span class="ident" id="4100473">netProto</span><span class="op" id="4100481">)</span><span class="op" id="4100482">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4100485">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="4100488">fd</span><span class="op" id="4100490">,</span>&nbsp;<span class="ident" id="4100492">err</span>&nbsp;<span class="op" id="4100496">:=</span>&nbsp;<span class="ident" id="4100499">internetSocket</span><span class="op" id="4100513">(</span><span class="ident" id="4100514">net</span><span class="op" id="4100517">,</span>&nbsp;<span class="ident" id="4100519">laddr</span><span class="op" id="4100524">,</span>&nbsp;<span class="ident" id="4100526">nil</span><span class="op" id="4100529">,</span>&nbsp;<span class="ident" id="4100531">noDeadline</span><span class="op" id="4100541">,</span>&nbsp;<span class="ident" id="4100543">syscall</span><span class="op" id="4100550">.</span><span class="ident" id="4100551">SOCK_RAW</span><span class="op" id="4100559">,</span>&nbsp;<span class="ident" id="4100561">proto</span><span class="op" id="4100566">,</span>&nbsp;<span class="string" id="4100568">&#34;listen&#34;</span><span class="op" id="4100576">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4100579">if</span>&nbsp;<span class="ident" id="4100582">err</span>&nbsp;<span class="op" id="4100586">!=</span>&nbsp;<span class="ident" id="4100589">nil</span>&nbsp;<span class="op" id="4100593">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4100597">return</span>&nbsp;<span class="ident" id="4100604">nil</span><span class="op" id="4100607">,</span>&nbsp;<span class="op" id="4100609">&amp;</span><span class="ident" id="4100610">OpError</span><span class="op" id="4100617">{</span><span class="ident" id="4100618">Op</span><span class="op" id="4100620">:</span>&nbsp;<span class="string" id="4100622">&#34;listen&#34;</span><span class="op" id="4100630">,</span>&nbsp;<span class="ident" id="4100632">Net</span><span class="op" id="4100635">:</span>&nbsp;<span class="ident" id="4100637">netProto</span><span class="op" id="4100645">,</span>&nbsp;<span class="ident" id="4100647">Addr</span><span class="op" id="4100651">:</span>&nbsp;<span class="ident" id="4100653">laddr</span><span class="op" id="4100658">,</span>&nbsp;<span class="ident" id="4100660">Err</span><span class="op" id="4100663">:</span>&nbsp;<span class="ident" id="4100665">err</span><span class="op" id="4100668">}</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="4100671">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="4100674">return</span>&nbsp;<span class="ident" id="4100681">newIPConn</span><span class="op" id="4100690">(</span><span class="ident" id="4100691">fd</span><span class="op" id="4100693">)</span><span class="op" id="4100694">,</span>&nbsp;<span class="ident" id="4100696">nil</span><br>
<span class="lineno"></span><span class="op" id="4100700">}</span>
</div>
</body>
</html>
