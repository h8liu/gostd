<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment">//&nbsp;+build&nbsp;!plan9</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">package</span>&nbsp;<span class="ident">net</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">import</span>&nbsp;<span class="op">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;syscall&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string">&#34;testing&#34;</span><br>
<span class="lineno"></span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword">var</span>&nbsp;<span class="ident">listenerTests</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">net</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">laddr</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ipv6</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">bool</span>&nbsp;<span class="comment">//&nbsp;test&nbsp;with&nbsp;underlying&nbsp;AF_INET6&nbsp;socket</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">wildcard</span>&nbsp;<span class="builtintype">bool</span>&nbsp;<span class="comment">//&nbsp;test&nbsp;with&nbsp;wildcard&nbsp;address</span><br>
<span class="lineno">20</span><span class="op">}</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">net</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;&#34;</span><span class="op">,</span>&nbsp;<span class="ident">wildcard</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">net</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;0.0.0.0&#34;</span><span class="op">,</span>&nbsp;<span class="ident">wildcard</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">net</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::ffff:0.0.0.0]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">wildcard</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">net</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">ipv6</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">,</span>&nbsp;<span class="ident">wildcard</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno">25</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">net</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;127.0.0.1&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">net</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::ffff:127.0.0.1]&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">net</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::1]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">ipv6</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">net</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp4&#34;</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;&#34;</span><span class="op">,</span>&nbsp;<span class="ident">wildcard</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">net</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp4&#34;</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;0.0.0.0&#34;</span><span class="op">,</span>&nbsp;<span class="ident">wildcard</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">net</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp4&#34;</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::ffff:0.0.0.0]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">wildcard</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">net</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp4&#34;</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;127.0.0.1&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">net</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp4&#34;</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::ffff:127.0.0.1]&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">net</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp6&#34;</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;&#34;</span><span class="op">,</span>&nbsp;<span class="ident">ipv6</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">,</span>&nbsp;<span class="ident">wildcard</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">net</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp6&#34;</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">ipv6</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">,</span>&nbsp;<span class="ident">wildcard</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">net</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp6&#34;</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::1]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">ipv6</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;TestTCPListener&nbsp;tests&nbsp;both&nbsp;single&nbsp;and&nbsp;double&nbsp;listen&nbsp;to&nbsp;a&nbsp;test</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;listener&nbsp;with&nbsp;same&nbsp;address&nbsp;family,&nbsp;same&nbsp;listening&nbsp;address&nbsp;and</span><br>
<span class="lineno">45</span><span class="comment">//&nbsp;same&nbsp;port.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">TestTCPListener</span><span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">testing</span><span class="op">.</span><span class="ident">T</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">runtime</span><span class="op">.</span><span class="ident">GOOS</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#34;plan9&#34;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Skipf</span><span class="op">(</span><span class="string">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op">,</span>&nbsp;<span class="ident">runtime</span><span class="op">.</span><span class="ident">GOOS</span><span class="op">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">tt</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">listenerTests</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">wildcard</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="op">(</span><span class="ident">testing</span><span class="op">.</span><span class="ident">Short</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">||</span>&nbsp;<span class="op">!</span><span class="op">*</span><span class="ident">testExternal</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">continue</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">ipv6</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="op">!</span><span class="ident">supportsIPv6</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">l1</span><span class="op">,</span>&nbsp;<span class="ident">port</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">usableListenPort</span><span class="op">(</span><span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">laddr</span><span class="op">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">checkFirstListener</span><span class="op">(</span><span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">laddr</span><span class="op">+</span><span class="string">&#34;:&#34;</span><span class="op">+</span><span class="ident">port</span><span class="op">,</span>&nbsp;<span class="ident">l1</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">l2</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">Listen</span><span class="op">(</span><span class="ident">tt</span><span class="op">.</span><span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">laddr</span><span class="op">+</span><span class="string">&#34;:&#34;</span><span class="op">+</span><span class="ident">port</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">checkSecondListener</span><span class="op">(</span><span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">laddr</span><span class="op">+</span><span class="string">&#34;:&#34;</span><span class="op">+</span><span class="ident">port</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">,</span>&nbsp;<span class="ident">l2</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">l1</span><span class="op">.</span><span class="ident">Close</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">65</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;TestUDPListener&nbsp;tests&nbsp;both&nbsp;single&nbsp;and&nbsp;double&nbsp;listen&nbsp;to&nbsp;a&nbsp;test</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;listener&nbsp;with&nbsp;same&nbsp;address&nbsp;family,&nbsp;same&nbsp;listening&nbsp;address&nbsp;and</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;same&nbsp;port.</span><br>
<span class="lineno">70</span><span class="keyword">func</span>&nbsp;<span class="ident">TestUDPListener</span><span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">testing</span><span class="op">.</span><span class="ident">T</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">runtime</span><span class="op">.</span><span class="ident">GOOS</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#34;plan9&#34;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Skipf</span><span class="op">(</span><span class="string">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op">,</span>&nbsp;<span class="ident">runtime</span><span class="op">.</span><span class="ident">GOOS</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">75</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">toudpnet</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="ident">net</span>&nbsp;<span class="builtintype">string</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">net</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="string">&#34;udp&#34;</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#34;tcp4&#34;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="string">&#34;udp4&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#34;tcp6&#34;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="string">&#34;udp6&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="string">&#34;&lt;nil&gt;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">tt</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">listenerTests</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">wildcard</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="op">(</span><span class="ident">testing</span><span class="op">.</span><span class="ident">Short</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">||</span>&nbsp;<span class="op">!</span><span class="op">*</span><span class="ident">testExternal</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">ipv6</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="op">!</span><span class="ident">supportsIPv6</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">95</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tt</span><span class="op">.</span><span class="ident">net</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">toudpnet</span><span class="op">(</span><span class="ident">tt</span><span class="op">.</span><span class="ident">net</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">l1</span><span class="op">,</span>&nbsp;<span class="ident">port</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">usableListenPacketPort</span><span class="op">(</span><span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">laddr</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">checkFirstListener</span><span class="op">(</span><span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">laddr</span><span class="op">+</span><span class="string">&#34;:&#34;</span><span class="op">+</span><span class="ident">port</span><span class="op">,</span>&nbsp;<span class="ident">l1</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">l2</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">ListenPacket</span><span class="op">(</span><span class="ident">tt</span><span class="op">.</span><span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">laddr</span><span class="op">+</span><span class="string">&#34;:&#34;</span><span class="op">+</span><span class="ident">port</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">checkSecondListener</span><span class="op">(</span><span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">laddr</span><span class="op">+</span><span class="string">&#34;:&#34;</span><span class="op">+</span><span class="ident">port</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">,</span>&nbsp;<span class="ident">l2</span><span class="op">)</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">l1</span><span class="op">.</span><span class="ident">Close</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">dualStackListenerTests</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">net1</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">string</span>&nbsp;<span class="comment">//&nbsp;first&nbsp;listener</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">laddr1</span>&nbsp;&nbsp;&nbsp;<span class="builtintype">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">net2</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">string</span>&nbsp;<span class="comment">//&nbsp;second&nbsp;listener</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">laddr2</span>&nbsp;&nbsp;&nbsp;<span class="builtintype">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">wildcard</span>&nbsp;<span class="builtintype">bool</span>&nbsp;&nbsp;<span class="comment">//&nbsp;test&nbsp;with&nbsp;wildcard&nbsp;address</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">xerr</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype">error</span>&nbsp;<span class="comment">//&nbsp;expected&nbsp;error&nbsp;value,&nbsp;nil&nbsp;or&nbsp;other</span><br>
<span class="lineno"></span><span class="op">}</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Test&nbsp;cases&nbsp;and&nbsp;expected&nbsp;results&nbsp;for&nbsp;the&nbsp;attemping&nbsp;2nd&nbsp;listen&nbsp;on&nbsp;the&nbsp;same&nbsp;port</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;1st&nbsp;listen&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2nd&nbsp;listen&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;darwin&nbsp;&nbsp;freebsd&nbsp;&nbsp;linux&nbsp;&nbsp;openbsd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;------------------------------------------------------------------------------------</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&#34;tcp&#34;&nbsp;&nbsp;&#34;&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#34;tcp&#34;&nbsp;&nbsp;&#34;&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&#34;tcp&#34;&nbsp;&nbsp;&#34;&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#34;tcp&#34;&nbsp;&nbsp;&#34;0.0.0.0&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&#34;tcp&#34;&nbsp;&nbsp;&#34;0.0.0.0&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#34;tcp&#34;&nbsp;&nbsp;&#34;&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;------------------------------------------------------------------------------------</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&#34;tcp&#34;&nbsp;&nbsp;&#34;&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#34;tcp&#34;&nbsp;&nbsp;&#34;[::]&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ok</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&#34;tcp&#34;&nbsp;&nbsp;&#34;[::]&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#34;tcp&#34;&nbsp;&nbsp;&#34;&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ok</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&#34;tcp&#34;&nbsp;&nbsp;&#34;0.0.0.0&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#34;tcp&#34;&nbsp;&nbsp;&#34;[::]&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ok</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&#34;tcp&#34;&nbsp;&nbsp;&#34;[::]&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#34;tcp&#34;&nbsp;&nbsp;&#34;0.0.0.0&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ok</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&#34;tcp&#34;&nbsp;&nbsp;&#34;[::ffff:0.0.0.0]&#34;&nbsp;&#34;tcp&#34;&nbsp;&nbsp;&#34;[::]&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ok</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&#34;tcp&#34;&nbsp;&nbsp;&#34;[::]&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#34;tcp&#34;&nbsp;&nbsp;&#34;[::ffff:0.0.0.0]&#34;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ok</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;------------------------------------------------------------------------------------</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&#34;tcp4&#34;&nbsp;&#34;&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#34;tcp6&#34;&nbsp;&#34;&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ok&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ok&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ok&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ok</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&#34;tcp6&#34;&nbsp;&#34;&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#34;tcp4&#34;&nbsp;&#34;&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ok&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ok&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ok&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ok</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&#34;tcp4&#34;&nbsp;&#34;0.0.0.0&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#34;tcp6&#34;&nbsp;&#34;[::]&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ok&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ok&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ok&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ok</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&#34;tcp6&#34;&nbsp;&#34;[::]&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#34;tcp4&#34;&nbsp;&#34;0.0.0.0&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ok&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ok&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ok&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ok</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;------------------------------------------------------------------------------------</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&#34;tcp&#34;&nbsp;&nbsp;&#34;127.0.0.1&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#34;tcp&#34;&nbsp;&nbsp;&#34;[::1]&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ok&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ok&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ok&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ok</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&#34;tcp&#34;&nbsp;&nbsp;&#34;[::1]&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#34;tcp&#34;&nbsp;&nbsp;&#34;127.0.0.1&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ok&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ok&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ok&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ok</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&#34;tcp4&#34;&nbsp;&#34;127.0.0.1&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#34;tcp6&#34;&nbsp;&#34;[::1]&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ok&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ok&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ok&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ok</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&#34;tcp6&#34;&nbsp;&#34;[::1]&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#34;tcp4&#34;&nbsp;&#34;127.0.0.1&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ok&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ok&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ok&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ok</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;Platform&nbsp;default&nbsp;configurations:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;darwin,&nbsp;kernel&nbsp;version&nbsp;11.3.0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&nbsp;&nbsp;&nbspnet.inet6.ip6.v6only=0&nbsp;(overridable&nbsp;by&nbsp;sysctl&nbsp;or&nbsp;IPV6_V6ONLY&nbsp;option)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;freebsd,&nbsp;kernel&nbsp;version&nbsp;8.2</span><br>
<span class="lineno">140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&nbsp;&nbsp;&nbspnet.inet6.ip6.v6only=1&nbsp;(overridable&nbsp;by&nbsp;sysctl&nbsp;or&nbsp;IPV6_V6ONLY&nbsp;option)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;linux,&nbsp;kernel&nbsp;version&nbsp;3.0.0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&nbsp;&nbsp;&nbspnet.ipv6.bindv6only=0&nbsp;(overridable&nbsp;by&nbsp;sysctl&nbsp;or&nbsp;IPV6_V6ONLY&nbsp;option)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;openbsd,&nbsp;kernel&nbsp;version&nbsp;5.0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;&nbsp;&nbsp;&nbspnet.inet6.ip6.v6only=1&nbsp;(overriding&nbsp;is&nbsp;prohibited)</span><br>
<span class="lineno">145</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">net1</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">laddr1</span><span class="op">:</span>&nbsp;<span class="string">&#34;&#34;</span><span class="op">,</span>&nbsp;<span class="ident">net2</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">laddr2</span><span class="op">:</span>&nbsp;<span class="string">&#34;&#34;</span><span class="op">,</span>&nbsp;<span class="ident">wildcard</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">,</span>&nbsp;<span class="ident">xerr</span><span class="op">:</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">EADDRINUSE</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">net1</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">laddr1</span><span class="op">:</span>&nbsp;<span class="string">&#34;&#34;</span><span class="op">,</span>&nbsp;<span class="ident">net2</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">laddr2</span><span class="op">:</span>&nbsp;<span class="string">&#34;0.0.0.0&#34;</span><span class="op">,</span>&nbsp;<span class="ident">wildcard</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">,</span>&nbsp;<span class="ident">xerr</span><span class="op">:</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">EADDRINUSE</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">net1</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">laddr1</span><span class="op">:</span>&nbsp;<span class="string">&#34;0.0.0.0&#34;</span><span class="op">,</span>&nbsp;<span class="ident">net2</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">laddr2</span><span class="op">:</span>&nbsp;<span class="string">&#34;&#34;</span><span class="op">,</span>&nbsp;<span class="ident">wildcard</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">,</span>&nbsp;<span class="ident">xerr</span><span class="op">:</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">EADDRINUSE</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">net1</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">laddr1</span><span class="op">:</span>&nbsp;<span class="string">&#34;&#34;</span><span class="op">,</span>&nbsp;<span class="ident">net2</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">laddr2</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">wildcard</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">,</span>&nbsp;<span class="ident">xerr</span><span class="op">:</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">EADDRINUSE</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">net1</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">laddr1</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">net2</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">laddr2</span><span class="op">:</span>&nbsp;<span class="string">&#34;&#34;</span><span class="op">,</span>&nbsp;<span class="ident">wildcard</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">,</span>&nbsp;<span class="ident">xerr</span><span class="op">:</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">EADDRINUSE</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">net1</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">laddr1</span><span class="op">:</span>&nbsp;<span class="string">&#34;0.0.0.0&#34;</span><span class="op">,</span>&nbsp;<span class="ident">net2</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">laddr2</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">wildcard</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">,</span>&nbsp;<span class="ident">xerr</span><span class="op">:</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">EADDRINUSE</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">net1</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">laddr1</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">net2</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">laddr2</span><span class="op">:</span>&nbsp;<span class="string">&#34;0.0.0.0&#34;</span><span class="op">,</span>&nbsp;<span class="ident">wildcard</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">,</span>&nbsp;<span class="ident">xerr</span><span class="op">:</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">EADDRINUSE</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">net1</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">laddr1</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::ffff:0.0.0.0]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">net2</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">laddr2</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">wildcard</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">,</span>&nbsp;<span class="ident">xerr</span><span class="op">:</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">EADDRINUSE</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">net1</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">laddr1</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">net2</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">laddr2</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::ffff:0.0.0.0]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">wildcard</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">,</span>&nbsp;<span class="ident">xerr</span><span class="op">:</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">EADDRINUSE</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">net1</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp4&#34;</span><span class="op">,</span>&nbsp;<span class="ident">laddr1</span><span class="op">:</span>&nbsp;<span class="string">&#34;&#34;</span><span class="op">,</span>&nbsp;<span class="ident">net2</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp6&#34;</span><span class="op">,</span>&nbsp;<span class="ident">laddr2</span><span class="op">:</span>&nbsp;<span class="string">&#34;&#34;</span><span class="op">,</span>&nbsp;<span class="ident">wildcard</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">net1</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp6&#34;</span><span class="op">,</span>&nbsp;<span class="ident">laddr1</span><span class="op">:</span>&nbsp;<span class="string">&#34;&#34;</span><span class="op">,</span>&nbsp;<span class="ident">net2</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp4&#34;</span><span class="op">,</span>&nbsp;<span class="ident">laddr2</span><span class="op">:</span>&nbsp;<span class="string">&#34;&#34;</span><span class="op">,</span>&nbsp;<span class="ident">wildcard</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">net1</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp4&#34;</span><span class="op">,</span>&nbsp;<span class="ident">laddr1</span><span class="op">:</span>&nbsp;<span class="string">&#34;0.0.0.0&#34;</span><span class="op">,</span>&nbsp;<span class="ident">net2</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp6&#34;</span><span class="op">,</span>&nbsp;<span class="ident">laddr2</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">wildcard</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">net1</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp6&#34;</span><span class="op">,</span>&nbsp;<span class="ident">laddr1</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">net2</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp4&#34;</span><span class="op">,</span>&nbsp;<span class="ident">laddr2</span><span class="op">:</span>&nbsp;<span class="string">&#34;0.0.0.0&#34;</span><span class="op">,</span>&nbsp;<span class="ident">wildcard</span><span class="op">:</span>&nbsp;<span class="ident">true</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">net1</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">laddr1</span><span class="op">:</span>&nbsp;<span class="string">&#34;127.0.0.1&#34;</span><span class="op">,</span>&nbsp;<span class="ident">net2</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">laddr2</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::1]&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">net1</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">laddr1</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::1]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">net2</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">laddr2</span><span class="op">:</span>&nbsp;<span class="string">&#34;127.0.0.1&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">net1</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp4&#34;</span><span class="op">,</span>&nbsp;<span class="ident">laddr1</span><span class="op">:</span>&nbsp;<span class="string">&#34;127.0.0.1&#34;</span><span class="op">,</span>&nbsp;<span class="ident">net2</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp6&#34;</span><span class="op">,</span>&nbsp;<span class="ident">laddr2</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::1]&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="ident">net1</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp6&#34;</span><span class="op">,</span>&nbsp;<span class="ident">laddr1</span><span class="op">:</span>&nbsp;<span class="string">&#34;[::1]&#34;</span><span class="op">,</span>&nbsp;<span class="ident">net2</span><span class="op">:</span>&nbsp;<span class="string">&#34;tcp4&#34;</span><span class="op">,</span>&nbsp;<span class="ident">laddr2</span><span class="op">:</span>&nbsp;<span class="string">&#34;127.0.0.1&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;TestDualStackTCPListener&nbsp;tests&nbsp;both&nbsp;single&nbsp;and&nbsp;double&nbsp;listen</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;to&nbsp;a&nbsp;test&nbsp;listener&nbsp;with&nbsp;various&nbsp;address&nbsp;families,&nbsp;different</span><br>
<span class="lineno">170</span><span class="comment">//&nbsp;listening&nbsp;address&nbsp;and&nbsp;same&nbsp;port.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">TestDualStackTCPListener</span><span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">testing</span><span class="op">.</span><span class="ident">T</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">testing</span><span class="op">.</span><span class="ident">Short</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Skip</span><span class="op">(</span><span class="string">&#34;skipping&nbsp;in&nbsp;-short&nbsp;mode,&nbsp;see&nbsp;issue&nbsp;5001&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">runtime</span><span class="op">.</span><span class="ident">GOOS</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#34;plan9&#34;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Skipf</span><span class="op">(</span><span class="string">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op">,</span>&nbsp;<span class="ident">runtime</span><span class="op">.</span><span class="ident">GOOS</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">supportsIPv6</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Skip</span><span class="op">(</span><span class="string">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">tt</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">dualStackListenerTests</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">wildcard</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="op">!</span><span class="op">*</span><span class="ident">testExternal</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">runtime</span><span class="op">.</span><span class="ident">GOOS</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#34;openbsd&#34;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">wildcard</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">differentWildcardAddr</span><span class="op">(</span><span class="ident">tt</span><span class="op">.</span><span class="ident">laddr1</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">laddr2</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tt</span><span class="op">.</span><span class="ident">xerr</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">l1</span><span class="op">,</span>&nbsp;<span class="ident">port</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">usableListenPort</span><span class="op">(</span><span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">net1</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">laddr1</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">laddr</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">laddr1</span>&nbsp;<span class="op">+</span>&nbsp;<span class="string">&#34;:&#34;</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">port</span><br>
<span class="lineno">195</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">checkFirstListener</span><span class="op">(</span><span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">net1</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span><span class="op">,</span>&nbsp;<span class="ident">l1</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">laddr</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">laddr2</span>&nbsp;<span class="op">+</span>&nbsp;<span class="string">&#34;:&#34;</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">port</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">l2</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">Listen</span><span class="op">(</span><span class="ident">tt</span><span class="op">.</span><span class="ident">net2</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">checkDualStackSecondListener</span><span class="op">(</span><span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">net2</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">xerr</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">,</span>&nbsp;<span class="ident">l2</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">l1</span><span class="op">.</span><span class="ident">Close</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment">//&nbsp;TestDualStackUDPListener&nbsp;tests&nbsp;both&nbsp;single&nbsp;and&nbsp;double&nbsp;listen</span><br>
<span class="lineno"></span><span class="comment">//&nbsp;to&nbsp;a&nbsp;test&nbsp;listener&nbsp;with&nbsp;various&nbsp;address&nbsp;families,&nbsp;differnet</span><br>
<span class="lineno">205</span><span class="comment">//&nbsp;listening&nbsp;address&nbsp;and&nbsp;same&nbsp;port.</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">TestDualStackUDPListener</span><span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">testing</span><span class="op">.</span><span class="ident">T</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">testing</span><span class="op">.</span><span class="ident">Short</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Skip</span><span class="op">(</span><span class="string">&#34;skipping&nbsp;in&nbsp;-short&nbsp;mode,&nbsp;see&nbsp;issue&nbsp;5001&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">runtime</span><span class="op">.</span><span class="ident">GOOS</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#34;plan9&#34;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Skipf</span><span class="op">(</span><span class="string">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op">,</span>&nbsp;<span class="ident">runtime</span><span class="op">.</span><span class="ident">GOOS</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">supportsIPv6</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Skip</span><span class="op">(</span><span class="string">&#34;ipv6&nbsp;is&nbsp;not&nbsp;supported&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">toudpnet</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="ident">net</span>&nbsp;<span class="builtintype">string</span><span class="op">)</span>&nbsp;<span class="builtintype">string</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">net</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="string">&#34;udp&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#34;tcp4&#34;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="string">&#34;udp4&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#34;tcp6&#34;</span><span class="op">:</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="string">&#34;udp6&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="string">&#34;&lt;nil&gt;&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">tt</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">dualStackListenerTests</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">wildcard</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="op">(</span><span class="ident">testing</span><span class="op">.</span><span class="ident">Short</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">||</span>&nbsp;<span class="op">!</span><span class="op">*</span><span class="ident">testExternal</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tt</span><span class="op">.</span><span class="ident">net1</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">toudpnet</span><span class="op">(</span><span class="ident">tt</span><span class="op">.</span><span class="ident">net1</span><span class="op">)</span><br>
<span class="lineno">235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tt</span><span class="op">.</span><span class="ident">net2</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">toudpnet</span><span class="op">(</span><span class="ident">tt</span><span class="op">.</span><span class="ident">net2</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">runtime</span><span class="op">.</span><span class="ident">GOOS</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#34;openbsd&#34;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">wildcard</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">differentWildcardAddr</span><span class="op">(</span><span class="ident">tt</span><span class="op">.</span><span class="ident">laddr1</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">laddr2</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">tt</span><span class="op">.</span><span class="ident">xerr</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">nil</span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">l1</span><span class="op">,</span>&nbsp;<span class="ident">port</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">usableListenPacketPort</span><span class="op">(</span><span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">net1</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">laddr1</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">laddr</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">laddr1</span>&nbsp;<span class="op">+</span>&nbsp;<span class="string">&#34;:&#34;</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">port</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">checkFirstListener</span><span class="op">(</span><span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">net1</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span><span class="op">,</span>&nbsp;<span class="ident">l1</span><span class="op">)</span><br>
<span class="lineno">245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">laddr</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">laddr2</span>&nbsp;<span class="op">+</span>&nbsp;<span class="string">&#34;:&#34;</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">port</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">l2</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">ListenPacket</span><span class="op">(</span><span class="ident">tt</span><span class="op">.</span><span class="ident">net2</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">checkDualStackSecondListener</span><span class="op">(</span><span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">net2</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">xerr</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">,</span>&nbsp;<span class="ident">l2</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">l1</span><span class="op">.</span><span class="ident">Close</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">250</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">usableListenPort</span><span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">testing</span><span class="op">.</span><span class="ident">T</span><span class="op">,</span>&nbsp;<span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span>&nbsp;<span class="builtintype">string</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">l</span>&nbsp;<span class="ident">Listener</span><span class="op">,</span>&nbsp;<span class="ident">port</span>&nbsp;<span class="builtintype">string</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">nladdr</span>&nbsp;<span class="builtintype">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="builtintype">error</span><br>
<span class="lineno">255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">net</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">default</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="string">&#34;usableListenPort&nbsp;net=&#34;</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">net</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;tcp4&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;tcp6&#34;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">l</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">Listen</span><span class="op">(</span><span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span><span class="op">+</span><span class="string">&#34;:0&#34;</span><span class="op">)</span><br>
<span class="lineno">260</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;Probe&nbsp;Listen(%q,&nbsp;%q)&nbsp;failed:&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nladdr</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">l</span><span class="op">.</span><span class="op">(</span><span class="op">*</span><span class="ident">TCPListener</span><span class="op">)</span><span class="op">.</span><span class="ident">Addr</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="ident">String</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">port</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">SplitHostPort</span><span class="op">(</span><span class="ident">nladdr</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;SplitHostPort&nbsp;failed:&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">l</span><span class="op">,</span>&nbsp;<span class="ident">port</span><br>
<span class="lineno">270</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">usableListenPacketPort</span><span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">testing</span><span class="op">.</span><span class="ident">T</span><span class="op">,</span>&nbsp;<span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span>&nbsp;<span class="builtintype">string</span><span class="op">)</span>&nbsp;<span class="op">(</span><span class="ident">l</span>&nbsp;<span class="ident">PacketConn</span><span class="op">,</span>&nbsp;<span class="ident">port</span>&nbsp;<span class="builtintype">string</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">nladdr</span>&nbsp;<span class="builtintype">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">var</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="builtintype">error</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">net</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">default</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc">panic</span><span class="op">(</span><span class="string">&#34;usableListenPacketPort&nbsp;net=&#34;</span>&nbsp;<span class="op">+</span>&nbsp;<span class="ident">net</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#34;udp&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;udp4&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;udp6&#34;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">l</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">ListenPacket</span><span class="op">(</span><span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span><span class="op">+</span><span class="string">&#34;:0&#34;</span><span class="op">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;Probe&nbsp;ListenPacket(%q,&nbsp;%q)&nbsp;failed:&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">nladdr</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">l</span><span class="op">.</span><span class="op">(</span><span class="op">*</span><span class="ident">UDPConn</span><span class="op">)</span><span class="op">.</span><span class="ident">LocalAddr</span><span class="op">(</span><span class="op">)</span><span class="op">.</span><span class="ident">String</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">port</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">=</span>&nbsp;<span class="ident">SplitHostPort</span><span class="op">(</span><span class="ident">nladdr</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;SplitHostPort&nbsp;failed:&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">l</span><span class="op">,</span>&nbsp;<span class="ident">port</span><br>
<span class="lineno">290</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">differentWildcardAddr</span><span class="op">(</span><span class="ident">i</span><span class="op">,</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="builtintype">string</span><span class="op">)</span>&nbsp;<span class="builtintype">bool</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">(</span><span class="ident">i</span>&nbsp;<span class="op">==</span>&nbsp;<span class="string">&#34;&#34;</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">==</span>&nbsp;<span class="string">&#34;0.0.0.0&#34;</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">==</span>&nbsp;<span class="string">&#34;::ffff:0.0.0.0&#34;</span><span class="op">)</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="op">(</span><span class="ident">j</span>&nbsp;<span class="op">==</span>&nbsp;<span class="string">&#34;&#34;</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="op">==</span>&nbsp;<span class="string">&#34;0.0.0.0&#34;</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="op">==</span>&nbsp;<span class="string">&#34;::ffff:0.0.0.0&#34;</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">false</span><br>
<span class="lineno">295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">i</span>&nbsp;<span class="op">==</span>&nbsp;<span class="string">&#34;[::]&#34;</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">j</span>&nbsp;<span class="op">==</span>&nbsp;<span class="string">&#34;[::]&#34;</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span>&nbsp;<span class="ident">true</span><br>
<span class="lineno">300</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">checkFirstListener</span><span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">testing</span><span class="op">.</span><span class="ident">T</span><span class="op">,</span>&nbsp;<span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span>&nbsp;<span class="builtintype">string</span><span class="op">,</span>&nbsp;<span class="ident">l</span>&nbsp;<span class="keyword">interface</span><span class="op">{</span><span class="op">}</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">net</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">:</span><br>
<span class="lineno">305</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">fd</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">l</span><span class="op">.</span><span class="op">(</span><span class="op">*</span><span class="ident">TCPListener</span><span class="op">)</span><span class="op">.</span><span class="ident">fd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">checkDualStackAddrFamily</span><span class="op">(</span><span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span><span class="op">,</span>&nbsp;<span class="ident">fd</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#34;tcp4&#34;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">fd</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">l</span><span class="op">.</span><span class="op">(</span><span class="op">*</span><span class="ident">TCPListener</span><span class="op">)</span><span class="op">.</span><span class="ident">fd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">fd</span><span class="op">.</span><span class="ident">family</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">AF_INET</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;First&nbsp;Listen(%q,&nbsp;%q)&nbsp;returns&nbsp;address&nbsp;family&nbsp;%v,&nbsp;expected&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span><span class="op">,</span>&nbsp;<span class="ident">fd</span><span class="op">.</span><span class="ident">family</span><span class="op">,</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">AF_INET</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#34;tcp6&#34;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">fd</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">l</span><span class="op">.</span><span class="op">(</span><span class="op">*</span><span class="ident">TCPListener</span><span class="op">)</span><span class="op">.</span><span class="ident">fd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">fd</span><span class="op">.</span><span class="ident">family</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">AF_INET6</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;First&nbsp;Listen(%q,&nbsp;%q)&nbsp;returns&nbsp;address&nbsp;family&nbsp;%v,&nbsp;expected&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span><span class="op">,</span>&nbsp;<span class="ident">fd</span><span class="op">.</span><span class="ident">family</span><span class="op">,</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">AF_INET6</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#34;udp&#34;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">fd</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">l</span><span class="op">.</span><span class="op">(</span><span class="op">*</span><span class="ident">UDPConn</span><span class="op">)</span><span class="op">.</span><span class="ident">fd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">checkDualStackAddrFamily</span><span class="op">(</span><span class="ident">t</span><span class="op">,</span>&nbsp;<span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span><span class="op">,</span>&nbsp;<span class="ident">fd</span><span class="op">)</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#34;udp4&#34;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">fd</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">l</span><span class="op">.</span><span class="op">(</span><span class="op">*</span><span class="ident">UDPConn</span><span class="op">)</span><span class="op">.</span><span class="ident">fd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">fd</span><span class="op">.</span><span class="ident">family</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">AF_INET</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;First&nbsp;ListenPacket(%q,&nbsp;%q)&nbsp;returns&nbsp;address&nbsp;family&nbsp;%v,&nbsp;expected&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span><span class="op">,</span>&nbsp;<span class="ident">fd</span><span class="op">.</span><span class="ident">family</span><span class="op">,</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">AF_INET</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#34;udp6&#34;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">fd</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">l</span><span class="op">.</span><span class="op">(</span><span class="op">*</span><span class="ident">UDPConn</span><span class="op">)</span><span class="op">.</span><span class="ident">fd</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">fd</span><span class="op">.</span><span class="ident">family</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">AF_INET6</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;First&nbsp;ListenPacket(%q,&nbsp;%q)&nbsp;returns&nbsp;address&nbsp;family&nbsp;%v,&nbsp;expected&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span><span class="op">,</span>&nbsp;<span class="ident">fd</span><span class="op">.</span><span class="ident">family</span><span class="op">,</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">AF_INET6</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">default</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;Unexpected&nbsp;network:&nbsp;%q&#34;</span><span class="op">,</span>&nbsp;<span class="ident">net</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span><span class="keyword">func</span>&nbsp;<span class="ident">checkSecondListener</span><span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">testing</span><span class="op">.</span><span class="ident">T</span><span class="op">,</span>&nbsp;<span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span>&nbsp;<span class="builtintype">string</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="builtintype">error</span><span class="op">,</span>&nbsp;<span class="ident">l</span>&nbsp;<span class="keyword">interface</span><span class="op">{</span><span class="op">}</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">net</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;tcp4&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;tcp6&#34;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">l</span><span class="op">.</span><span class="op">(</span><span class="op">*</span><span class="ident">TCPListener</span><span class="op">)</span><span class="op">.</span><span class="ident">Close</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;Second&nbsp;Listen(%q,&nbsp;%q)&nbsp;should&nbsp;fail&#34;</span><span class="op">,</span>&nbsp;<span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#34;udp&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;udp4&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;udp6&#34;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">l</span><span class="op">.</span><span class="op">(</span><span class="op">*</span><span class="ident">UDPConn</span><span class="op">)</span><span class="op">.</span><span class="ident">Close</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;Second&nbsp;ListenPacket(%q,&nbsp;%q)&nbsp;should&nbsp;fail&#34;</span><span class="op">,</span>&nbsp;<span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">default</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;Unexpected&nbsp;network:&nbsp;%q&#34;</span><span class="op">,</span>&nbsp;<span class="ident">net</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">350</span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">checkDualStackSecondListener</span><span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">testing</span><span class="op">.</span><span class="ident">T</span><span class="op">,</span>&nbsp;<span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span>&nbsp;<span class="builtintype">string</span><span class="op">,</span>&nbsp;<span class="ident">xerr</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="builtintype">error</span><span class="op">,</span>&nbsp;<span class="ident">l</span>&nbsp;<span class="keyword">interface</span><span class="op">{</span><span class="op">}</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">net</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;tcp4&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;tcp6&#34;</span><span class="op">:</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">xerr</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">xerr</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;Second&nbsp;Listen(%q,&nbsp;%q)&nbsp;returns&nbsp;%v,&nbsp;expected&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">,</span>&nbsp;<span class="ident">xerr</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">l</span><span class="op">.</span><span class="op">(</span><span class="op">*</span><span class="ident">TCPListener</span><span class="op">)</span><span class="op">.</span><span class="ident">Close</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#34;udp&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;udp4&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;udp6&#34;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">xerr</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">xerr</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;Second&nbsp;ListenPacket(%q,&nbsp;%q)&nbsp;returns&nbsp;%v,&nbsp;expected&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span><span class="op">,</span>&nbsp;<span class="ident">err</span><span class="op">,</span>&nbsp;<span class="ident">xerr</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">l</span><span class="op">.</span><span class="op">(</span><span class="op">*</span><span class="ident">UDPConn</span><span class="op">)</span><span class="op">.</span><span class="ident">Close</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">default</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;Unexpected&nbsp;network:&nbsp;%q&#34;</span><span class="op">,</span>&nbsp;<span class="ident">net</span><span class="op">)</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">checkDualStackAddrFamily</span><span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">testing</span><span class="op">.</span><span class="ident">T</span><span class="op">,</span>&nbsp;<span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span>&nbsp;<span class="builtintype">string</span><span class="op">,</span>&nbsp;<span class="ident">fd</span>&nbsp;<span class="op">*</span><span class="ident">netFD</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">a</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">fd</span><span class="op">.</span><span class="ident">laddr</span><span class="op">.</span><span class="op">(</span><span class="keyword">type</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="op">*</span><span class="ident">TCPAddr</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;If&nbsp;a&nbsp;node&nbsp;under&nbsp;test&nbsp;supports&nbsp;both&nbsp;IPv6&nbsp;capability</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;and&nbsp;IPv6&nbsp;IPv4-mapping&nbsp;capability,&nbsp;we&nbsp;can&nbsp;assume</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;that&nbsp;the&nbsp;node&nbsp;listens&nbsp;on&nbsp;a&nbsp;wildcard&nbsp;address&nbsp;with&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;AF_INET6&nbsp;socket.</span><br>
<span class="lineno">380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">supportsIPv4map</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">fd</span><span class="op">.</span><span class="ident">laddr</span><span class="op">.</span><span class="op">(</span><span class="op">*</span><span class="ident">TCPAddr</span><span class="op">)</span><span class="op">.</span><span class="ident">isWildcard</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">fd</span><span class="op">.</span><span class="ident">family</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">AF_INET6</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;Listen(%q,&nbsp;%q)&nbsp;returns&nbsp;address&nbsp;family&nbsp;%v,&nbsp;expected&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span><span class="op">,</span>&nbsp;<span class="ident">fd</span><span class="op">.</span><span class="ident">family</span><span class="op">,</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">AF_INET6</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">fd</span><span class="op">.</span><span class="ident">family</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">a</span><span class="op">.</span><span class="ident">family</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;Listen(%q,&nbsp;%q)&nbsp;returns&nbsp;address&nbsp;family&nbsp;%v,&nbsp;expected&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span><span class="op">,</span>&nbsp;<span class="ident">fd</span><span class="op">.</span><span class="ident">family</span><span class="op">,</span>&nbsp;<span class="ident">a</span><span class="op">.</span><span class="ident">family</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="op">*</span><span class="ident">UDPAddr</span><span class="op">:</span><br>
<span class="lineno">390</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;If&nbsp;a&nbsp;node&nbsp;under&nbsp;test&nbsp;supports&nbsp;both&nbsp;IPv6&nbsp;capability</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;and&nbsp;IPv6&nbsp;IPv4-mapping&nbsp;capability,&nbsp;we&nbsp;can&nbsp;assume</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;that&nbsp;the&nbsp;node&nbsp;listens&nbsp;on&nbsp;a&nbsp;wildcard&nbsp;address&nbsp;with&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;AF_INET6&nbsp;socket.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">supportsIPv4map</span>&nbsp;<span class="op">&amp;&amp;</span>&nbsp;<span class="ident">fd</span><span class="op">.</span><span class="ident">laddr</span><span class="op">.</span><span class="op">(</span><span class="op">*</span><span class="ident">UDPAddr</span><span class="op">)</span><span class="op">.</span><span class="ident">isWildcard</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">fd</span><span class="op">.</span><span class="ident">family</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">AF_INET6</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;ListenPacket(%q,&nbsp;%q)&nbsp;returns&nbsp;address&nbsp;family&nbsp;%v,&nbsp;expected&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span><span class="op">,</span>&nbsp;<span class="ident">fd</span><span class="op">.</span><span class="ident">family</span><span class="op">,</span>&nbsp;<span class="ident">syscall</span><span class="op">.</span><span class="ident">AF_INET6</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">fd</span><span class="op">.</span><span class="ident">family</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">a</span><span class="op">.</span><span class="ident">family</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;ListenPacket(%q,&nbsp;%q)&nbsp;returns&nbsp;address&nbsp;family&nbsp;%v,&nbsp;expected&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">laddr</span><span class="op">,</span>&nbsp;<span class="ident">fd</span><span class="op">.</span><span class="ident">family</span><span class="op">,</span>&nbsp;<span class="ident">a</span><span class="op">.</span><span class="ident">family</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">default</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;Unexpected&nbsp;protocol&nbsp;address&nbsp;type:&nbsp;%T&#34;</span><span class="op">,</span>&nbsp;<span class="ident">a</span><span class="op">)</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">var</span>&nbsp;<span class="ident">prohibitionaryDialArgTests</span>&nbsp;<span class="op">=</span>&nbsp;<span class="op">[</span><span class="op">]</span><span class="keyword">struct</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">net</span>&nbsp;&nbsp;<span class="builtintype">string</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">addr</span>&nbsp;<span class="builtintype">string</span><br>
<span class="lineno"></span><span class="op">}</span><span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="string">&#34;tcp6&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;127.0.0.1&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">{</span><span class="string">&#34;tcp6&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;[::ffff:127.0.0.1]&#34;</span><span class="op">}</span><span class="op">,</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno">415</span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">TestProhibitionaryDialArgs</span><span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">testing</span><span class="op">.</span><span class="ident">T</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">runtime</span><span class="op">.</span><span class="ident">GOOS</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#34;plan9&#34;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Skipf</span><span class="op">(</span><span class="string">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op">,</span>&nbsp;<span class="ident">runtime</span><span class="op">.</span><span class="ident">GOOS</span><span class="op">)</span><br>
<span class="lineno">420</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment">//&nbsp;This&nbsp;test&nbsp;requires&nbsp;both&nbsp;IPv6&nbsp;and&nbsp;IPv6&nbsp;IPv4-mapping&nbsp;functionality.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="op">!</span><span class="ident">supportsIPv4map</span>&nbsp;<span class="op">||</span>&nbsp;<span class="ident">testing</span><span class="op">.</span><span class="ident">Short</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">||</span>&nbsp;<span class="op">!</span><span class="op">*</span><span class="ident">testExternal</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">425</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">l</span><span class="op">,</span>&nbsp;<span class="ident">port</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">usableListenPort</span><span class="op">(</span><span class="ident">t</span><span class="op">,</span>&nbsp;<span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;[::]&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">defer</span>&nbsp;<span class="ident">l</span><span class="op">.</span><span class="ident">Close</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">for</span>&nbsp;<span class="ident">_</span><span class="op">,</span>&nbsp;<span class="ident">tt</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="keyword">range</span>&nbsp;<span class="ident">prohibitionaryDialArgTests</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">430</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">c</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">Dial</span><span class="op">(</span><span class="ident">tt</span><span class="op">.</span><span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">addr</span><span class="op">+</span><span class="string">&#34;:&#34;</span><span class="op">+</span><span class="ident">port</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">c</span><span class="op">.</span><span class="ident">Close</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;Dial(%q,&nbsp;%q)&nbsp;should&nbsp;fail&#34;</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">net</span><span class="op">,</span>&nbsp;<span class="ident">tt</span><span class="op">.</span><span class="ident">addr</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">435</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword">func</span>&nbsp;<span class="ident">TestWildWildcardListener</span><span class="op">(</span><span class="ident">t</span>&nbsp;<span class="op">*</span><span class="ident">testing</span><span class="op">.</span><span class="ident">T</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">switch</span>&nbsp;<span class="ident">runtime</span><span class="op">.</span><span class="ident">GOOS</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">440</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">case</span>&nbsp;<span class="string">&#34;plan9&#34;</span><span class="op">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Skipf</span><span class="op">(</span><span class="string">&#34;skipping&nbsp;test&nbsp;on&nbsp;%q&#34;</span><span class="op">,</span>&nbsp;<span class="ident">runtime</span><span class="op">.</span><span class="ident">GOOS</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">testing</span><span class="op">.</span><span class="ident">Short</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">||</span>&nbsp;<span class="op">!</span><span class="op">*</span><span class="ident">testExternal</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Skip</span><span class="op">(</span><span class="string">&#34;skipping&nbsp;test&nbsp;to&nbsp;avoid&nbsp;external&nbsp;network&#34;</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">defer</span>&nbsp;<span class="keyword">func</span><span class="op">(</span><span class="op">)</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">p</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="builtinfunc">recover</span><span class="op">(</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">p</span>&nbsp;<span class="op">!=</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">t</span><span class="op">.</span><span class="ident">Fatalf</span><span class="op">(</span><span class="string">&#34;Listen,&nbsp;ListenPacket&nbsp;or&nbsp;protocol-specific&nbsp;Listen&nbsp;panicked:&nbsp;%v&#34;</span><span class="op">,</span>&nbsp;<span class="ident">p</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">ln</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">Listen</span><span class="op">(</span><span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;&#34;</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno">455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ln</span><span class="op">.</span><span class="ident">Close</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">ln</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">ListenPacket</span><span class="op">(</span><span class="string">&#34;udp&#34;</span><span class="op">,</span>&nbsp;<span class="string">&#34;&#34;</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ln</span><span class="op">.</span><span class="ident">Close</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">ln</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">ListenTCP</span><span class="op">(</span><span class="string">&#34;tcp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ln</span><span class="op">.</span><span class="ident">Close</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">ln</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">ListenUDP</span><span class="op">(</span><span class="string">&#34;udp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ln</span><span class="op">.</span><span class="ident">Close</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword">if</span>&nbsp;<span class="ident">ln</span><span class="op">,</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">:=</span>&nbsp;<span class="ident">ListenIP</span><span class="op">(</span><span class="string">&#34;ip:icmp&#34;</span><span class="op">,</span>&nbsp;<span class="ident">nil</span><span class="op">)</span><span class="op">;</span>&nbsp;<span class="ident">err</span>&nbsp;<span class="op">==</span>&nbsp;<span class="ident">nil</span>&nbsp;<span class="op">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident">ln</span><span class="op">.</span><span class="ident">Close</span><span class="op">(</span><span class="op">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op">}</span><br>
<span class="lineno"></span><span class="op">}</span>
</div>
</body>
</html>
