<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/style.css">
</head>

<body>

<div class="code">
<span class="lineno">1</span><span class="comment" id="8528628">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="8528683">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="8528737">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="8528788">//&nbsp;Reverse&nbsp;proxy&nbsp;tests.</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8528813">package</span>&nbsp;<span class="ident" id="8528821">httputil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8528831">import</span>&nbsp;<span class="op" id="8528838">(</span><br>
<span class="lineno">10</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8528841">&#34;io/ioutil&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8528854">&#34;net/http&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8528866">&#34;net/http/httptest&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8528887">&#34;net/url&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8528898">&#34;strings&#34;</span><br>
<span class="lineno">15</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8528909">&#34;testing&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="8528920">&#34;time&#34;</span><br>
<span class="lineno"></span><span class="op" id="8528927">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8528930">const</span>&nbsp;<span class="ident" id="8528936">fakeHopHeader</span>&nbsp;<span class="op" id="8528950">=</span>&nbsp;<span class="string" id="8528952">&#34;X-Fake-Hop-Header-For-Test&#34;</span><br>
<span class="lineno">20</span><br>
<span class="lineno"></span><span class="keyword" id="8528982">func</span>&nbsp;<span class="ident" id="8528987">init</span><span class="op" id="8528991">(</span><span class="op" id="8528992">)</span>&nbsp;<span class="op" id="8528994">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8528997"><a href="/net/http/httputil/reverseproxy.go.html#6271015">hopHeaders</a></span>&nbsp;<span class="op" id="8529008">=</span>&nbsp;<span class="builtinfunc" id="8529010">append</span><span class="op" id="8529016">(</span><span class="ident" id="8529017"><a href="/net/http/httputil/reverseproxy.go.html#6271015">hopHeaders</a></span><span class="op" id="8529027">,</span>&nbsp;<span class="ident" id="8529029"><a href="/net/http/httputil/reverseproxy_test.go.html#8528936">fakeHopHeader</a></span><span class="op" id="8529042">)</span><br>
<span class="lineno"></span><span class="op" id="8529044">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="8529047">func</span>&nbsp;<span class="ident" id="8529052">TestReverseProxy</span><span class="op" id="8529068">(</span><span class="ident" id="8529069">t</span>&nbsp;<span class="op" id="8529071">*</span><span class="ident" id="8529072"><a href="/net/http/httputil/reverseproxy_test.go.html#8528909">testing</a></span><span class="op" id="8529079">.</span><span class="ident" id="8529080">T</span><span class="op" id="8529081">)</span>&nbsp;<span class="op" id="8529083">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8529086">const</span>&nbsp;<span class="ident" id="8529092">backendResponse</span>&nbsp;<span class="op" id="8529108">=</span>&nbsp;<span class="string" id="8529110">&#34;I&nbsp;am&nbsp;the&nbsp;backend&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8529130">const</span>&nbsp;<span class="ident" id="8529136">backendStatus</span>&nbsp;<span class="op" id="8529150">=</span>&nbsp;<span class="num" id="8529152">404</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8529157">backend</span>&nbsp;<span class="op" id="8529165">:=</span>&nbsp;<span class="ident" id="8529168"><a href="/net/http/httputil/reverseproxy_test.go.html#8528866">httptest</a></span><span class="op" id="8529176">.</span><span class="ident" id="8529177">NewServer</span><span class="op" id="8529186">(</span><span class="ident" id="8529187"><a href="/net/http/httputil/reverseproxy_test.go.html#8528854">http</a></span><span class="op" id="8529191">.</span><span class="ident" id="8529192">HandlerFunc</span><span class="op" id="8529203">(</span><span class="keyword" id="8529204">func</span><span class="op" id="8529208">(</span><span class="ident" id="8529209">w</span>&nbsp;<span class="ident" id="8529211"><a href="/net/http/httputil/reverseproxy_test.go.html#8528854">http</a></span><span class="op" id="8529215">.</span><span class="ident" id="8529216">ResponseWriter</span><span class="op" id="8529230">,</span>&nbsp;<span class="ident" id="8529232">r</span>&nbsp;<span class="op" id="8529234">*</span><span class="ident" id="8529235"><a href="/net/http/httputil/reverseproxy_test.go.html#8528854">http</a></span><span class="op" id="8529239">.</span><span class="ident" id="8529240">Request</span><span class="op" id="8529247">)</span>&nbsp;<span class="op" id="8529249">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8529253">if</span>&nbsp;<span class="builtinfunc" id="8529256">len</span><span class="op" id="8529259">(</span><span class="ident" id="8529260"><a href="/net/http/httputil/reverseproxy_test.go.html#8529232">r</a></span><span class="op" id="8529261">.</span><span class="ident" id="8529262">TransferEncoding</span><span class="op" id="8529278">)</span>&nbsp;<span class="op" id="8529280">&gt;</span>&nbsp;<span class="num" id="8529282">0</span>&nbsp;<span class="op" id="8529284">{</span><br>
<span class="lineno">30</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8529289"><a href="/net/http/httputil/reverseproxy_test.go.html#8529069">t</a></span><span class="op" id="8529290">.</span><span class="ident" id="8529291">Errorf</span><span class="op" id="8529297">(</span><span class="string" id="8529298">&#34;backend&nbsp;got&nbsp;unexpected&nbsp;TransferEncoding:&nbsp;%v&#34;</span><span class="op" id="8529343">,</span>&nbsp;<span class="ident" id="8529345"><a href="/net/http/httputil/reverseproxy_test.go.html#8529232">r</a></span><span class="op" id="8529346">.</span><span class="ident" id="8529347">TransferEncoding</span><span class="op" id="8529363">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8529367">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8529371">if</span>&nbsp;<span class="ident" id="8529374"><a href="/net/http/httputil/reverseproxy_test.go.html#8529232">r</a></span><span class="op" id="8529375">.</span><span class="ident" id="8529376">Header</span><span class="op" id="8529382">.</span><span class="ident" id="8529383">Get</span><span class="op" id="8529386">(</span><span class="string" id="8529387">&#34;X-Forwarded-For&#34;</span><span class="op" id="8529404">)</span>&nbsp;<span class="op" id="8529406">==</span>&nbsp;<span class="string" id="8529409">&#34;&#34;</span>&nbsp;<span class="op" id="8529412">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8529417"><a href="/net/http/httputil/reverseproxy_test.go.html#8529069">t</a></span><span class="op" id="8529418">.</span><span class="ident" id="8529419">Errorf</span><span class="op" id="8529425">(</span><span class="string" id="8529426">&#34;didn&#39;t&nbsp;get&nbsp;X-Forwarded-For&nbsp;header&#34;</span><span class="op" id="8529461">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8529465">}</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8529469">if</span>&nbsp;<span class="ident" id="8529472">c</span>&nbsp;<span class="op" id="8529474">:=</span>&nbsp;<span class="ident" id="8529477"><a href="/net/http/httputil/reverseproxy_test.go.html#8529232">r</a></span><span class="op" id="8529478">.</span><span class="ident" id="8529479">Header</span><span class="op" id="8529485">.</span><span class="ident" id="8529486">Get</span><span class="op" id="8529489">(</span><span class="string" id="8529490">&#34;Connection&#34;</span><span class="op" id="8529502">)</span><span class="op" id="8529503">;</span>&nbsp;<span class="ident" id="8529505"><a href="/net/http/httputil/reverseproxy_test.go.html#8529472">c</a></span>&nbsp;<span class="op" id="8529507">!=</span>&nbsp;<span class="string" id="8529510">&#34;&#34;</span>&nbsp;<span class="op" id="8529513">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8529518"><a href="/net/http/httputil/reverseproxy_test.go.html#8529069">t</a></span><span class="op" id="8529519">.</span><span class="ident" id="8529520">Errorf</span><span class="op" id="8529526">(</span><span class="string" id="8529527">&#34;handler&nbsp;got&nbsp;Connection&nbsp;header&nbsp;value&nbsp;%q&#34;</span><span class="op" id="8529567">,</span>&nbsp;<span class="ident" id="8529569"><a href="/net/http/httputil/reverseproxy_test.go.html#8529472">c</a></span><span class="op" id="8529570">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8529574">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8529578">if</span>&nbsp;<span class="ident" id="8529581">c</span>&nbsp;<span class="op" id="8529583">:=</span>&nbsp;<span class="ident" id="8529586"><a href="/net/http/httputil/reverseproxy_test.go.html#8529232">r</a></span><span class="op" id="8529587">.</span><span class="ident" id="8529588">Header</span><span class="op" id="8529594">.</span><span class="ident" id="8529595">Get</span><span class="op" id="8529598">(</span><span class="string" id="8529599">&#34;Upgrade&#34;</span><span class="op" id="8529608">)</span><span class="op" id="8529609">;</span>&nbsp;<span class="ident" id="8529611"><a href="/net/http/httputil/reverseproxy_test.go.html#8529581">c</a></span>&nbsp;<span class="op" id="8529613">!=</span>&nbsp;<span class="string" id="8529616">&#34;&#34;</span>&nbsp;<span class="op" id="8529619">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8529624"><a href="/net/http/httputil/reverseproxy_test.go.html#8529069">t</a></span><span class="op" id="8529625">.</span><span class="ident" id="8529626">Errorf</span><span class="op" id="8529632">(</span><span class="string" id="8529633">&#34;handler&nbsp;got&nbsp;Upgrade&nbsp;header&nbsp;value&nbsp;%q&#34;</span><span class="op" id="8529670">,</span>&nbsp;<span class="ident" id="8529672"><a href="/net/http/httputil/reverseproxy_test.go.html#8529581">c</a></span><span class="op" id="8529673">)</span><br>
<span class="lineno">40</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8529677">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8529681">if</span>&nbsp;<span class="ident" id="8529684">g</span><span class="op" id="8529685">,</span>&nbsp;<span class="ident" id="8529687">e</span>&nbsp;<span class="op" id="8529689">:=</span>&nbsp;<span class="ident" id="8529692"><a href="/net/http/httputil/reverseproxy_test.go.html#8529232">r</a></span><span class="op" id="8529693">.</span><span class="ident" id="8529694">Host</span><span class="op" id="8529698">,</span>&nbsp;<span class="string" id="8529700">&#34;some-name&#34;</span><span class="op" id="8529711">;</span>&nbsp;<span class="ident" id="8529713"><a href="/net/http/httputil/reverseproxy_test.go.html#8529684">g</a></span>&nbsp;<span class="op" id="8529715">!=</span>&nbsp;<span class="ident" id="8529718"><a href="/net/http/httputil/reverseproxy_test.go.html#8529687">e</a></span>&nbsp;<span class="op" id="8529720">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8529725"><a href="/net/http/httputil/reverseproxy_test.go.html#8529069">t</a></span><span class="op" id="8529726">.</span><span class="ident" id="8529727">Errorf</span><span class="op" id="8529733">(</span><span class="string" id="8529734">&#34;backend&nbsp;got&nbsp;Host&nbsp;header&nbsp;%q,&nbsp;want&nbsp;%q&#34;</span><span class="op" id="8529771">,</span>&nbsp;<span class="ident" id="8529773"><a href="/net/http/httputil/reverseproxy_test.go.html#8529684">g</a></span><span class="op" id="8529774">,</span>&nbsp;<span class="ident" id="8529776"><a href="/net/http/httputil/reverseproxy_test.go.html#8529687">e</a></span><span class="op" id="8529777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8529781">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8529785"><a href="/net/http/httputil/reverseproxy_test.go.html#8529209">w</a></span><span class="op" id="8529786">.</span><span class="ident" id="8529787">Header</span><span class="op" id="8529793">(</span><span class="op" id="8529794">)</span><span class="op" id="8529795">.</span><span class="ident" id="8529796">Set</span><span class="op" id="8529799">(</span><span class="string" id="8529800">&#34;X-Foo&#34;</span><span class="op" id="8529807">,</span>&nbsp;<span class="string" id="8529809">&#34;bar&#34;</span><span class="op" id="8529814">)</span><br>
<span class="lineno">45</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8529818"><a href="/net/http/httputil/reverseproxy_test.go.html#8529209">w</a></span><span class="op" id="8529819">.</span><span class="ident" id="8529820">Header</span><span class="op" id="8529826">(</span><span class="op" id="8529827">)</span><span class="op" id="8529828">.</span><span class="ident" id="8529829">Set</span><span class="op" id="8529832">(</span><span class="string" id="8529833">&#34;Upgrade&#34;</span><span class="op" id="8529842">,</span>&nbsp;<span class="string" id="8529844">&#34;foo&#34;</span><span class="op" id="8529849">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8529853"><a href="/net/http/httputil/reverseproxy_test.go.html#8529209">w</a></span><span class="op" id="8529854">.</span><span class="ident" id="8529855">Header</span><span class="op" id="8529861">(</span><span class="op" id="8529862">)</span><span class="op" id="8529863">.</span><span class="ident" id="8529864">Set</span><span class="op" id="8529867">(</span><span class="ident" id="8529868"><a href="/net/http/httputil/reverseproxy_test.go.html#8528936">fakeHopHeader</a></span><span class="op" id="8529881">,</span>&nbsp;<span class="string" id="8529883">&#34;foo&#34;</span><span class="op" id="8529888">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8529892"><a href="/net/http/httputil/reverseproxy_test.go.html#8529209">w</a></span><span class="op" id="8529893">.</span><span class="ident" id="8529894">Header</span><span class="op" id="8529900">(</span><span class="op" id="8529901">)</span><span class="op" id="8529902">.</span><span class="ident" id="8529903">Add</span><span class="op" id="8529906">(</span><span class="string" id="8529907">&#34;X-Multi-Value&#34;</span><span class="op" id="8529922">,</span>&nbsp;<span class="string" id="8529924">&#34;foo&#34;</span><span class="op" id="8529929">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8529933"><a href="/net/http/httputil/reverseproxy_test.go.html#8529209">w</a></span><span class="op" id="8529934">.</span><span class="ident" id="8529935">Header</span><span class="op" id="8529941">(</span><span class="op" id="8529942">)</span><span class="op" id="8529943">.</span><span class="ident" id="8529944">Add</span><span class="op" id="8529947">(</span><span class="string" id="8529948">&#34;X-Multi-Value&#34;</span><span class="op" id="8529963">,</span>&nbsp;<span class="string" id="8529965">&#34;bar&#34;</span><span class="op" id="8529970">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8529974"><a href="/net/http/httputil/reverseproxy_test.go.html#8528854">http</a></span><span class="op" id="8529978">.</span><span class="ident" id="8529979">SetCookie</span><span class="op" id="8529988">(</span><span class="ident" id="8529989"><a href="/net/http/httputil/reverseproxy_test.go.html#8529209">w</a></span><span class="op" id="8529990">,</span>&nbsp;<span class="op" id="8529992">&amp;</span><span class="ident" id="8529993"><a href="/net/http/httputil/reverseproxy_test.go.html#8528854">http</a></span><span class="op" id="8529997">.</span><span class="ident" id="8529998">Cookie</span><span class="op" id="8530004">{</span><span class="ident" id="8530005">Name</span><span class="op" id="8530009">:</span>&nbsp;<span class="string" id="8530011">&#34;flavor&#34;</span><span class="op" id="8530019">,</span>&nbsp;<span class="ident" id="8530021">Value</span><span class="op" id="8530026">:</span>&nbsp;<span class="string" id="8530028">&#34;chocolateChip&#34;</span><span class="op" id="8530043">}</span><span class="op" id="8530044">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8530048"><a href="/net/http/httputil/reverseproxy_test.go.html#8529209">w</a></span><span class="op" id="8530049">.</span><span class="ident" id="8530050">WriteHeader</span><span class="op" id="8530061">(</span><span class="ident" id="8530062"><a href="/net/http/httputil/reverseproxy_test.go.html#8529136">backendStatus</a></span><span class="op" id="8530075">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8530079"><a href="/net/http/httputil/reverseproxy_test.go.html#8529209">w</a></span><span class="op" id="8530080">.</span><span class="ident" id="8530081">Write</span><span class="op" id="8530086">(</span><span class="op" id="8530087">[</span><span class="op" id="8530088">]</span><span class="builtintype" id="8530089">byte</span><span class="op" id="8530093">(</span><span class="ident" id="8530094"><a href="/net/http/httputil/reverseproxy_test.go.html#8529092">backendResponse</a></span><span class="op" id="8530109">)</span><span class="op" id="8530110">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8530113">}</span><span class="op" id="8530114">)</span><span class="op" id="8530115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8530118">defer</span>&nbsp;<span class="ident" id="8530124"><a href="/net/http/httputil/reverseproxy_test.go.html#8529157">backend</a></span><span class="op" id="8530131">.</span><span class="ident" id="8530132">Close</span><span class="op" id="8530137">(</span><span class="op" id="8530138">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8530141">backendURL</span><span class="op" id="8530151">,</span>&nbsp;<span class="ident" id="8530153">err</span>&nbsp;<span class="op" id="8530157">:=</span>&nbsp;<span class="ident" id="8530160"><a href="/net/http/httputil/reverseproxy_test.go.html#8528887">url</a></span><span class="op" id="8530163">.</span><span class="ident" id="8530164">Parse</span><span class="op" id="8530169">(</span><span class="ident" id="8530170"><a href="/net/http/httputil/reverseproxy_test.go.html#8529157">backend</a></span><span class="op" id="8530177">.</span><span class="ident" id="8530178">URL</span><span class="op" id="8530181">)</span><br>
<span class="lineno">55</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8530184">if</span>&nbsp;<span class="ident" id="8530187"><a href="/net/http/httputil/reverseproxy_test.go.html#8530153">err</a></span>&nbsp;<span class="op" id="8530191">!=</span>&nbsp;<span class="ident" id="8530194">nil</span>&nbsp;<span class="op" id="8530198">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8530202"><a href="/net/http/httputil/reverseproxy_test.go.html#8529069">t</a></span><span class="op" id="8530203">.</span><span class="ident" id="8530204">Fatal</span><span class="op" id="8530209">(</span><span class="ident" id="8530210"><a href="/net/http/httputil/reverseproxy_test.go.html#8530153">err</a></span><span class="op" id="8530213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8530216">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8530219">proxyHandler</span>&nbsp;<span class="op" id="8530232">:=</span>&nbsp;<span class="ident" id="8530235"><a href="/net/http/httputil/reverseproxy.go.html#6270287">NewSingleHostReverseProxy</a></span><span class="op" id="8530260">(</span><span class="ident" id="8530261"><a href="/net/http/httputil/reverseproxy_test.go.html#8530141">backendURL</a></span><span class="op" id="8530271">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8530274">frontend</span>&nbsp;<span class="op" id="8530283">:=</span>&nbsp;<span class="ident" id="8530286"><a href="/net/http/httputil/reverseproxy_test.go.html#8528866">httptest</a></span><span class="op" id="8530294">.</span><span class="ident" id="8530295">NewServer</span><span class="op" id="8530304">(</span><span class="ident" id="8530305"><a href="/net/http/httputil/reverseproxy_test.go.html#8530219">proxyHandler</a></span><span class="op" id="8530317">)</span><br>
<span class="lineno">60</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8530320">defer</span>&nbsp;<span class="ident" id="8530326"><a href="/net/http/httputil/reverseproxy_test.go.html#8530274">frontend</a></span><span class="op" id="8530334">.</span><span class="ident" id="8530335">Close</span><span class="op" id="8530340">(</span><span class="op" id="8530341">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8530345">getReq</span><span class="op" id="8530351">,</span>&nbsp;<span class="ident" id="8530353">_</span>&nbsp;<span class="op" id="8530355">:=</span>&nbsp;<span class="ident" id="8530358"><a href="/net/http/httputil/reverseproxy_test.go.html#8528854">http</a></span><span class="op" id="8530362">.</span><span class="ident" id="8530363">NewRequest</span><span class="op" id="8530373">(</span><span class="string" id="8530374">&#34;GET&#34;</span><span class="op" id="8530379">,</span>&nbsp;<span class="ident" id="8530381"><a href="/net/http/httputil/reverseproxy_test.go.html#8530274">frontend</a></span><span class="op" id="8530389">.</span><span class="ident" id="8530390">URL</span><span class="op" id="8530393">,</span>&nbsp;<span class="ident" id="8530395">nil</span><span class="op" id="8530398">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8530401"><a href="/net/http/httputil/reverseproxy_test.go.html#8530345">getReq</a></span><span class="op" id="8530407">.</span><span class="ident" id="8530408">Host</span>&nbsp;<span class="op" id="8530413">=</span>&nbsp;<span class="string" id="8530415">&#34;some-name&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8530428"><a href="/net/http/httputil/reverseproxy_test.go.html#8530345">getReq</a></span><span class="op" id="8530434">.</span><span class="ident" id="8530435">Header</span><span class="op" id="8530441">.</span><span class="ident" id="8530442">Set</span><span class="op" id="8530445">(</span><span class="string" id="8530446">&#34;Connection&#34;</span><span class="op" id="8530458">,</span>&nbsp;<span class="string" id="8530460">&#34;close&#34;</span><span class="op" id="8530467">)</span><br>
<span class="lineno">65</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8530470"><a href="/net/http/httputil/reverseproxy_test.go.html#8530345">getReq</a></span><span class="op" id="8530476">.</span><span class="ident" id="8530477">Header</span><span class="op" id="8530483">.</span><span class="ident" id="8530484">Set</span><span class="op" id="8530487">(</span><span class="string" id="8530488">&#34;Upgrade&#34;</span><span class="op" id="8530497">,</span>&nbsp;<span class="string" id="8530499">&#34;foo&#34;</span><span class="op" id="8530504">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8530507"><a href="/net/http/httputil/reverseproxy_test.go.html#8530345">getReq</a></span><span class="op" id="8530513">.</span><span class="ident" id="8530514">Close</span>&nbsp;<span class="op" id="8530520">=</span>&nbsp;<span class="ident" id="8530522">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8530528">res</span><span class="op" id="8530531">,</span>&nbsp;<span class="ident" id="8530533"><a href="/net/http/httputil/reverseproxy_test.go.html#8530153">err</a></span>&nbsp;<span class="op" id="8530537">:=</span>&nbsp;<span class="ident" id="8530540"><a href="/net/http/httputil/reverseproxy_test.go.html#8528854">http</a></span><span class="op" id="8530544">.</span><span class="ident" id="8530545">DefaultClient</span><span class="op" id="8530558">.</span><span class="ident" id="8530559">Do</span><span class="op" id="8530561">(</span><span class="ident" id="8530562"><a href="/net/http/httputil/reverseproxy_test.go.html#8530345">getReq</a></span><span class="op" id="8530568">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8530571">if</span>&nbsp;<span class="ident" id="8530574"><a href="/net/http/httputil/reverseproxy_test.go.html#8530153">err</a></span>&nbsp;<span class="op" id="8530578">!=</span>&nbsp;<span class="ident" id="8530581">nil</span>&nbsp;<span class="op" id="8530585">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8530589"><a href="/net/http/httputil/reverseproxy_test.go.html#8529069">t</a></span><span class="op" id="8530590">.</span><span class="ident" id="8530591">Fatalf</span><span class="op" id="8530597">(</span><span class="string" id="8530598">&#34;Get:&nbsp;%v&#34;</span><span class="op" id="8530607">,</span>&nbsp;<span class="ident" id="8530609"><a href="/net/http/httputil/reverseproxy_test.go.html#8530153">err</a></span><span class="op" id="8530612">)</span><br>
<span class="lineno">70</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8530615">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8530618">if</span>&nbsp;<span class="ident" id="8530621">g</span><span class="op" id="8530622">,</span>&nbsp;<span class="ident" id="8530624">e</span>&nbsp;<span class="op" id="8530626">:=</span>&nbsp;<span class="ident" id="8530629"><a href="/net/http/httputil/reverseproxy_test.go.html#8530528">res</a></span><span class="op" id="8530632">.</span><span class="ident" id="8530633">StatusCode</span><span class="op" id="8530643">,</span>&nbsp;<span class="ident" id="8530645"><a href="/net/http/httputil/reverseproxy_test.go.html#8529136">backendStatus</a></span><span class="op" id="8530658">;</span>&nbsp;<span class="ident" id="8530660"><a href="/net/http/httputil/reverseproxy_test.go.html#8530621">g</a></span>&nbsp;<span class="op" id="8530662">!=</span>&nbsp;<span class="ident" id="8530665"><a href="/net/http/httputil/reverseproxy_test.go.html#8530624">e</a></span>&nbsp;<span class="op" id="8530667">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8530671"><a href="/net/http/httputil/reverseproxy_test.go.html#8529069">t</a></span><span class="op" id="8530672">.</span><span class="ident" id="8530673">Errorf</span><span class="op" id="8530679">(</span><span class="string" id="8530680">&#34;got&nbsp;res.StatusCode&nbsp;%d;&nbsp;expected&nbsp;%d&#34;</span><span class="op" id="8530716">,</span>&nbsp;<span class="ident" id="8530718"><a href="/net/http/httputil/reverseproxy_test.go.html#8530621">g</a></span><span class="op" id="8530719">,</span>&nbsp;<span class="ident" id="8530721"><a href="/net/http/httputil/reverseproxy_test.go.html#8530624">e</a></span><span class="op" id="8530722">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8530725">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8530728">if</span>&nbsp;<span class="ident" id="8530731">g</span><span class="op" id="8530732">,</span>&nbsp;<span class="ident" id="8530734">e</span>&nbsp;<span class="op" id="8530736">:=</span>&nbsp;<span class="ident" id="8530739"><a href="/net/http/httputil/reverseproxy_test.go.html#8530528">res</a></span><span class="op" id="8530742">.</span><span class="ident" id="8530743">Header</span><span class="op" id="8530749">.</span><span class="ident" id="8530750">Get</span><span class="op" id="8530753">(</span><span class="string" id="8530754">&#34;X-Foo&#34;</span><span class="op" id="8530761">)</span><span class="op" id="8530762">,</span>&nbsp;<span class="string" id="8530764">&#34;bar&#34;</span><span class="op" id="8530769">;</span>&nbsp;<span class="ident" id="8530771"><a href="/net/http/httputil/reverseproxy_test.go.html#8530731">g</a></span>&nbsp;<span class="op" id="8530773">!=</span>&nbsp;<span class="ident" id="8530776"><a href="/net/http/httputil/reverseproxy_test.go.html#8530734">e</a></span>&nbsp;<span class="op" id="8530778">{</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8530782"><a href="/net/http/httputil/reverseproxy_test.go.html#8529069">t</a></span><span class="op" id="8530783">.</span><span class="ident" id="8530784">Errorf</span><span class="op" id="8530790">(</span><span class="string" id="8530791">&#34;got&nbsp;X-Foo&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="8530818">,</span>&nbsp;<span class="ident" id="8530820"><a href="/net/http/httputil/reverseproxy_test.go.html#8530731">g</a></span><span class="op" id="8530821">,</span>&nbsp;<span class="ident" id="8530823"><a href="/net/http/httputil/reverseproxy_test.go.html#8530734">e</a></span><span class="op" id="8530824">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8530827">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8530830">if</span>&nbsp;<span class="ident" id="8530833">c</span>&nbsp;<span class="op" id="8530835">:=</span>&nbsp;<span class="ident" id="8530838"><a href="/net/http/httputil/reverseproxy_test.go.html#8530528">res</a></span><span class="op" id="8530841">.</span><span class="ident" id="8530842">Header</span><span class="op" id="8530848">.</span><span class="ident" id="8530849">Get</span><span class="op" id="8530852">(</span><span class="ident" id="8530853"><a href="/net/http/httputil/reverseproxy_test.go.html#8528936">fakeHopHeader</a></span><span class="op" id="8530866">)</span><span class="op" id="8530867">;</span>&nbsp;<span class="ident" id="8530869"><a href="/net/http/httputil/reverseproxy_test.go.html#8530833">c</a></span>&nbsp;<span class="op" id="8530871">!=</span>&nbsp;<span class="string" id="8530874">&#34;&#34;</span>&nbsp;<span class="op" id="8530877">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8530881"><a href="/net/http/httputil/reverseproxy_test.go.html#8529069">t</a></span><span class="op" id="8530882">.</span><span class="ident" id="8530883">Errorf</span><span class="op" id="8530889">(</span><span class="string" id="8530890">&#34;got&nbsp;%s&nbsp;header&nbsp;value&nbsp;%q&#34;</span><span class="op" id="8530914">,</span>&nbsp;<span class="ident" id="8530916"><a href="/net/http/httputil/reverseproxy_test.go.html#8528936">fakeHopHeader</a></span><span class="op" id="8530929">,</span>&nbsp;<span class="ident" id="8530931"><a href="/net/http/httputil/reverseproxy_test.go.html#8530833">c</a></span><span class="op" id="8530932">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8530935">}</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8530938">if</span>&nbsp;<span class="ident" id="8530941">g</span><span class="op" id="8530942">,</span>&nbsp;<span class="ident" id="8530944">e</span>&nbsp;<span class="op" id="8530946">:=</span>&nbsp;<span class="builtinfunc" id="8530949">len</span><span class="op" id="8530952">(</span><span class="ident" id="8530953"><a href="/net/http/httputil/reverseproxy_test.go.html#8530528">res</a></span><span class="op" id="8530956">.</span><span class="ident" id="8530957">Header</span><span class="op" id="8530963">[</span><span class="string" id="8530964">&#34;X-Multi-Value&#34;</span><span class="op" id="8530979">]</span><span class="op" id="8530980">)</span><span class="op" id="8530981">,</span>&nbsp;<span class="num" id="8530983">2</span><span class="op" id="8530984">;</span>&nbsp;<span class="ident" id="8530986"><a href="/net/http/httputil/reverseproxy_test.go.html#8530941">g</a></span>&nbsp;<span class="op" id="8530988">!=</span>&nbsp;<span class="ident" id="8530991"><a href="/net/http/httputil/reverseproxy_test.go.html#8530944">e</a></span>&nbsp;<span class="op" id="8530993">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8530997"><a href="/net/http/httputil/reverseproxy_test.go.html#8529069">t</a></span><span class="op" id="8530998">.</span><span class="ident" id="8530999">Errorf</span><span class="op" id="8531005">(</span><span class="string" id="8531006">&#34;got&nbsp;%d&nbsp;X-Multi-Value&nbsp;header&nbsp;values;&nbsp;expected&nbsp;%d&#34;</span><span class="op" id="8531055">,</span>&nbsp;<span class="ident" id="8531057"><a href="/net/http/httputil/reverseproxy_test.go.html#8530941">g</a></span><span class="op" id="8531058">,</span>&nbsp;<span class="ident" id="8531060"><a href="/net/http/httputil/reverseproxy_test.go.html#8530944">e</a></span><span class="op" id="8531061">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8531064">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8531067">if</span>&nbsp;<span class="ident" id="8531070">g</span><span class="op" id="8531071">,</span>&nbsp;<span class="ident" id="8531073">e</span>&nbsp;<span class="op" id="8531075">:=</span>&nbsp;<span class="builtinfunc" id="8531078">len</span><span class="op" id="8531081">(</span><span class="ident" id="8531082"><a href="/net/http/httputil/reverseproxy_test.go.html#8530528">res</a></span><span class="op" id="8531085">.</span><span class="ident" id="8531086">Header</span><span class="op" id="8531092">[</span><span class="string" id="8531093">&#34;Set-Cookie&#34;</span><span class="op" id="8531105">]</span><span class="op" id="8531106">)</span><span class="op" id="8531107">,</span>&nbsp;<span class="num" id="8531109">1</span><span class="op" id="8531110">;</span>&nbsp;<span class="ident" id="8531112"><a href="/net/http/httputil/reverseproxy_test.go.html#8531070">g</a></span>&nbsp;<span class="op" id="8531114">!=</span>&nbsp;<span class="ident" id="8531117"><a href="/net/http/httputil/reverseproxy_test.go.html#8531073">e</a></span>&nbsp;<span class="op" id="8531119">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8531123"><a href="/net/http/httputil/reverseproxy_test.go.html#8529069">t</a></span><span class="op" id="8531124">.</span><span class="ident" id="8531125">Fatalf</span><span class="op" id="8531131">(</span><span class="string" id="8531132">&#34;got&nbsp;%d&nbsp;SetCookies,&nbsp;want&nbsp;%d&#34;</span><span class="op" id="8531160">,</span>&nbsp;<span class="ident" id="8531162"><a href="/net/http/httputil/reverseproxy_test.go.html#8531070">g</a></span><span class="op" id="8531163">,</span>&nbsp;<span class="ident" id="8531165"><a href="/net/http/httputil/reverseproxy_test.go.html#8531073">e</a></span><span class="op" id="8531166">)</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8531169">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8531172">if</span>&nbsp;<span class="ident" id="8531175">cookie</span>&nbsp;<span class="op" id="8531182">:=</span>&nbsp;<span class="ident" id="8531185"><a href="/net/http/httputil/reverseproxy_test.go.html#8530528">res</a></span><span class="op" id="8531188">.</span><span class="ident" id="8531189">Cookies</span><span class="op" id="8531196">(</span><span class="op" id="8531197">)</span><span class="op" id="8531198">[</span><span class="num" id="8531199">0</span><span class="op" id="8531200">]</span><span class="op" id="8531201">;</span>&nbsp;<span class="ident" id="8531203"><a href="/net/http/httputil/reverseproxy_test.go.html#8531175">cookie</a></span><span class="op" id="8531209">.</span><span class="ident" id="8531210">Name</span>&nbsp;<span class="op" id="8531215">!=</span>&nbsp;<span class="string" id="8531218">&#34;flavor&#34;</span>&nbsp;<span class="op" id="8531227">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8531231"><a href="/net/http/httputil/reverseproxy_test.go.html#8529069">t</a></span><span class="op" id="8531232">.</span><span class="ident" id="8531233">Errorf</span><span class="op" id="8531239">(</span><span class="string" id="8531240">&#34;unexpected&nbsp;cookie&nbsp;%q&#34;</span><span class="op" id="8531262">,</span>&nbsp;<span class="ident" id="8531264"><a href="/net/http/httputil/reverseproxy_test.go.html#8531175">cookie</a></span><span class="op" id="8531270">.</span><span class="ident" id="8531271">Name</span><span class="op" id="8531275">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8531278">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8531281">bodyBytes</span><span class="op" id="8531290">,</span>&nbsp;<span class="ident" id="8531292">_</span>&nbsp;<span class="op" id="8531294">:=</span>&nbsp;<span class="ident" id="8531297"><a href="/net/http/httputil/reverseproxy_test.go.html#8528841">ioutil</a></span><span class="op" id="8531303">.</span><span class="ident" id="8531304">ReadAll</span><span class="op" id="8531311">(</span><span class="ident" id="8531312"><a href="/net/http/httputil/reverseproxy_test.go.html#8530528">res</a></span><span class="op" id="8531315">.</span><span class="ident" id="8531316">Body</span><span class="op" id="8531320">)</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8531323">if</span>&nbsp;<span class="ident" id="8531326">g</span><span class="op" id="8531327">,</span>&nbsp;<span class="ident" id="8531329">e</span>&nbsp;<span class="op" id="8531331">:=</span>&nbsp;<span class="builtintype" id="8531334">string</span><span class="op" id="8531340">(</span><span class="ident" id="8531341"><a href="/net/http/httputil/reverseproxy_test.go.html#8531281">bodyBytes</a></span><span class="op" id="8531350">)</span><span class="op" id="8531351">,</span>&nbsp;<span class="ident" id="8531353"><a href="/net/http/httputil/reverseproxy_test.go.html#8529092">backendResponse</a></span><span class="op" id="8531368">;</span>&nbsp;<span class="ident" id="8531370"><a href="/net/http/httputil/reverseproxy_test.go.html#8531326">g</a></span>&nbsp;<span class="op" id="8531372">!=</span>&nbsp;<span class="ident" id="8531375"><a href="/net/http/httputil/reverseproxy_test.go.html#8531329">e</a></span>&nbsp;<span class="op" id="8531377">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8531381"><a href="/net/http/httputil/reverseproxy_test.go.html#8529069">t</a></span><span class="op" id="8531382">.</span><span class="ident" id="8531383">Errorf</span><span class="op" id="8531389">(</span><span class="string" id="8531390">&#34;got&nbsp;body&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="8531416">,</span>&nbsp;<span class="ident" id="8531418"><a href="/net/http/httputil/reverseproxy_test.go.html#8531326">g</a></span><span class="op" id="8531419">,</span>&nbsp;<span class="ident" id="8531421"><a href="/net/http/httputil/reverseproxy_test.go.html#8531329">e</a></span><span class="op" id="8531422">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8531425">}</span><br>
<span class="lineno"></span><span class="op" id="8531427">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">95</span><span class="keyword" id="8531430">func</span>&nbsp;<span class="ident" id="8531435">TestXForwardedFor</span><span class="op" id="8531452">(</span><span class="ident" id="8531453">t</span>&nbsp;<span class="op" id="8531455">*</span><span class="ident" id="8531456"><a href="/net/http/httputil/reverseproxy_test.go.html#8528909">testing</a></span><span class="op" id="8531463">.</span><span class="ident" id="8531464">T</span><span class="op" id="8531465">)</span>&nbsp;<span class="op" id="8531467">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8531470">const</span>&nbsp;<span class="ident" id="8531476">prevForwardedFor</span>&nbsp;<span class="op" id="8531493">=</span>&nbsp;<span class="string" id="8531495">&#34;client&nbsp;ip&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8531508">const</span>&nbsp;<span class="ident" id="8531514">backendResponse</span>&nbsp;<span class="op" id="8531530">=</span>&nbsp;<span class="string" id="8531532">&#34;I&nbsp;am&nbsp;the&nbsp;backend&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8531552">const</span>&nbsp;<span class="ident" id="8531558">backendStatus</span>&nbsp;<span class="op" id="8531572">=</span>&nbsp;<span class="num" id="8531574">404</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8531579">backend</span>&nbsp;<span class="op" id="8531587">:=</span>&nbsp;<span class="ident" id="8531590"><a href="/net/http/httputil/reverseproxy_test.go.html#8528866">httptest</a></span><span class="op" id="8531598">.</span><span class="ident" id="8531599">NewServer</span><span class="op" id="8531608">(</span><span class="ident" id="8531609"><a href="/net/http/httputil/reverseproxy_test.go.html#8528854">http</a></span><span class="op" id="8531613">.</span><span class="ident" id="8531614">HandlerFunc</span><span class="op" id="8531625">(</span><span class="keyword" id="8531626">func</span><span class="op" id="8531630">(</span><span class="ident" id="8531631">w</span>&nbsp;<span class="ident" id="8531633"><a href="/net/http/httputil/reverseproxy_test.go.html#8528854">http</a></span><span class="op" id="8531637">.</span><span class="ident" id="8531638">ResponseWriter</span><span class="op" id="8531652">,</span>&nbsp;<span class="ident" id="8531654">r</span>&nbsp;<span class="op" id="8531656">*</span><span class="ident" id="8531657"><a href="/net/http/httputil/reverseproxy_test.go.html#8528854">http</a></span><span class="op" id="8531661">.</span><span class="ident" id="8531662">Request</span><span class="op" id="8531669">)</span>&nbsp;<span class="op" id="8531671">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8531675">if</span>&nbsp;<span class="ident" id="8531678"><a href="/net/http/httputil/reverseproxy_test.go.html#8531654">r</a></span><span class="op" id="8531679">.</span><span class="ident" id="8531680">Header</span><span class="op" id="8531686">.</span><span class="ident" id="8531687">Get</span><span class="op" id="8531690">(</span><span class="string" id="8531691">&#34;X-Forwarded-For&#34;</span><span class="op" id="8531708">)</span>&nbsp;<span class="op" id="8531710">==</span>&nbsp;<span class="string" id="8531713">&#34;&#34;</span>&nbsp;<span class="op" id="8531716">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8531721"><a href="/net/http/httputil/reverseproxy_test.go.html#8531453">t</a></span><span class="op" id="8531722">.</span><span class="ident" id="8531723">Errorf</span><span class="op" id="8531729">(</span><span class="string" id="8531730">&#34;didn&#39;t&nbsp;get&nbsp;X-Forwarded-For&nbsp;header&#34;</span><span class="op" id="8531765">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8531769">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8531773">if</span>&nbsp;<span class="op" id="8531776">!</span><span class="ident" id="8531777"><a href="/net/http/httputil/reverseproxy_test.go.html#8528898">strings</a></span><span class="op" id="8531784">.</span><span class="ident" id="8531785">Contains</span><span class="op" id="8531793">(</span><span class="ident" id="8531794"><a href="/net/http/httputil/reverseproxy_test.go.html#8531654">r</a></span><span class="op" id="8531795">.</span><span class="ident" id="8531796">Header</span><span class="op" id="8531802">.</span><span class="ident" id="8531803">Get</span><span class="op" id="8531806">(</span><span class="string" id="8531807">&#34;X-Forwarded-For&#34;</span><span class="op" id="8531824">)</span><span class="op" id="8531825">,</span>&nbsp;<span class="ident" id="8531827"><a href="/net/http/httputil/reverseproxy_test.go.html#8531476">prevForwardedFor</a></span><span class="op" id="8531843">)</span>&nbsp;<span class="op" id="8531845">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8531850"><a href="/net/http/httputil/reverseproxy_test.go.html#8531453">t</a></span><span class="op" id="8531851">.</span><span class="ident" id="8531852">Errorf</span><span class="op" id="8531858">(</span><span class="string" id="8531859">&#34;X-Forwarded-For&nbsp;didn&#39;t&nbsp;contain&nbsp;prior&nbsp;data&#34;</span><span class="op" id="8531902">)</span><br>
<span class="lineno">105</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8531906">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8531910"><a href="/net/http/httputil/reverseproxy_test.go.html#8531631">w</a></span><span class="op" id="8531911">.</span><span class="ident" id="8531912">WriteHeader</span><span class="op" id="8531923">(</span><span class="ident" id="8531924"><a href="/net/http/httputil/reverseproxy_test.go.html#8531558">backendStatus</a></span><span class="op" id="8531937">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8531941"><a href="/net/http/httputil/reverseproxy_test.go.html#8531631">w</a></span><span class="op" id="8531942">.</span><span class="ident" id="8531943">Write</span><span class="op" id="8531948">(</span><span class="op" id="8531949">[</span><span class="op" id="8531950">]</span><span class="builtintype" id="8531951">byte</span><span class="op" id="8531955">(</span><span class="ident" id="8531956"><a href="/net/http/httputil/reverseproxy_test.go.html#8531514">backendResponse</a></span><span class="op" id="8531971">)</span><span class="op" id="8531972">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8531975">}</span><span class="op" id="8531976">)</span><span class="op" id="8531977">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8531980">defer</span>&nbsp;<span class="ident" id="8531986"><a href="/net/http/httputil/reverseproxy_test.go.html#8531579">backend</a></span><span class="op" id="8531993">.</span><span class="ident" id="8531994">Close</span><span class="op" id="8531999">(</span><span class="op" id="8532000">)</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8532003">backendURL</span><span class="op" id="8532013">,</span>&nbsp;<span class="ident" id="8532015">err</span>&nbsp;<span class="op" id="8532019">:=</span>&nbsp;<span class="ident" id="8532022"><a href="/net/http/httputil/reverseproxy_test.go.html#8528887">url</a></span><span class="op" id="8532025">.</span><span class="ident" id="8532026">Parse</span><span class="op" id="8532031">(</span><span class="ident" id="8532032"><a href="/net/http/httputil/reverseproxy_test.go.html#8531579">backend</a></span><span class="op" id="8532039">.</span><span class="ident" id="8532040">URL</span><span class="op" id="8532043">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8532046">if</span>&nbsp;<span class="ident" id="8532049"><a href="/net/http/httputil/reverseproxy_test.go.html#8532015">err</a></span>&nbsp;<span class="op" id="8532053">!=</span>&nbsp;<span class="ident" id="8532056">nil</span>&nbsp;<span class="op" id="8532060">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8532064"><a href="/net/http/httputil/reverseproxy_test.go.html#8531453">t</a></span><span class="op" id="8532065">.</span><span class="ident" id="8532066">Fatal</span><span class="op" id="8532071">(</span><span class="ident" id="8532072"><a href="/net/http/httputil/reverseproxy_test.go.html#8532015">err</a></span><span class="op" id="8532075">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8532078">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8532081">proxyHandler</span>&nbsp;<span class="op" id="8532094">:=</span>&nbsp;<span class="ident" id="8532097"><a href="/net/http/httputil/reverseproxy.go.html#6270287">NewSingleHostReverseProxy</a></span><span class="op" id="8532122">(</span><span class="ident" id="8532123"><a href="/net/http/httputil/reverseproxy_test.go.html#8532003">backendURL</a></span><span class="op" id="8532133">)</span><br>
<span class="lineno">115</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8532136">frontend</span>&nbsp;<span class="op" id="8532145">:=</span>&nbsp;<span class="ident" id="8532148"><a href="/net/http/httputil/reverseproxy_test.go.html#8528866">httptest</a></span><span class="op" id="8532156">.</span><span class="ident" id="8532157">NewServer</span><span class="op" id="8532166">(</span><span class="ident" id="8532167"><a href="/net/http/httputil/reverseproxy_test.go.html#8532081">proxyHandler</a></span><span class="op" id="8532179">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8532182">defer</span>&nbsp;<span class="ident" id="8532188"><a href="/net/http/httputil/reverseproxy_test.go.html#8532136">frontend</a></span><span class="op" id="8532196">.</span><span class="ident" id="8532197">Close</span><span class="op" id="8532202">(</span><span class="op" id="8532203">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8532207">getReq</span><span class="op" id="8532213">,</span>&nbsp;<span class="ident" id="8532215">_</span>&nbsp;<span class="op" id="8532217">:=</span>&nbsp;<span class="ident" id="8532220"><a href="/net/http/httputil/reverseproxy_test.go.html#8528854">http</a></span><span class="op" id="8532224">.</span><span class="ident" id="8532225">NewRequest</span><span class="op" id="8532235">(</span><span class="string" id="8532236">&#34;GET&#34;</span><span class="op" id="8532241">,</span>&nbsp;<span class="ident" id="8532243"><a href="/net/http/httputil/reverseproxy_test.go.html#8532136">frontend</a></span><span class="op" id="8532251">.</span><span class="ident" id="8532252">URL</span><span class="op" id="8532255">,</span>&nbsp;<span class="ident" id="8532257">nil</span><span class="op" id="8532260">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8532263"><a href="/net/http/httputil/reverseproxy_test.go.html#8532207">getReq</a></span><span class="op" id="8532269">.</span><span class="ident" id="8532270">Host</span>&nbsp;<span class="op" id="8532275">=</span>&nbsp;<span class="string" id="8532277">&#34;some-name&#34;</span><br>
<span class="lineno">120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8532290"><a href="/net/http/httputil/reverseproxy_test.go.html#8532207">getReq</a></span><span class="op" id="8532296">.</span><span class="ident" id="8532297">Header</span><span class="op" id="8532303">.</span><span class="ident" id="8532304">Set</span><span class="op" id="8532307">(</span><span class="string" id="8532308">&#34;Connection&#34;</span><span class="op" id="8532320">,</span>&nbsp;<span class="string" id="8532322">&#34;close&#34;</span><span class="op" id="8532329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8532332"><a href="/net/http/httputil/reverseproxy_test.go.html#8532207">getReq</a></span><span class="op" id="8532338">.</span><span class="ident" id="8532339">Header</span><span class="op" id="8532345">.</span><span class="ident" id="8532346">Set</span><span class="op" id="8532349">(</span><span class="string" id="8532350">&#34;X-Forwarded-For&#34;</span><span class="op" id="8532367">,</span>&nbsp;<span class="ident" id="8532369"><a href="/net/http/httputil/reverseproxy_test.go.html#8531476">prevForwardedFor</a></span><span class="op" id="8532385">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8532388"><a href="/net/http/httputil/reverseproxy_test.go.html#8532207">getReq</a></span><span class="op" id="8532394">.</span><span class="ident" id="8532395">Close</span>&nbsp;<span class="op" id="8532401">=</span>&nbsp;<span class="ident" id="8532403">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8532409">res</span><span class="op" id="8532412">,</span>&nbsp;<span class="ident" id="8532414"><a href="/net/http/httputil/reverseproxy_test.go.html#8532015">err</a></span>&nbsp;<span class="op" id="8532418">:=</span>&nbsp;<span class="ident" id="8532421"><a href="/net/http/httputil/reverseproxy_test.go.html#8528854">http</a></span><span class="op" id="8532425">.</span><span class="ident" id="8532426">DefaultClient</span><span class="op" id="8532439">.</span><span class="ident" id="8532440">Do</span><span class="op" id="8532442">(</span><span class="ident" id="8532443"><a href="/net/http/httputil/reverseproxy_test.go.html#8532207">getReq</a></span><span class="op" id="8532449">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8532452">if</span>&nbsp;<span class="ident" id="8532455"><a href="/net/http/httputil/reverseproxy_test.go.html#8532015">err</a></span>&nbsp;<span class="op" id="8532459">!=</span>&nbsp;<span class="ident" id="8532462">nil</span>&nbsp;<span class="op" id="8532466">{</span><br>
<span class="lineno">125</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8532470"><a href="/net/http/httputil/reverseproxy_test.go.html#8531453">t</a></span><span class="op" id="8532471">.</span><span class="ident" id="8532472">Fatalf</span><span class="op" id="8532478">(</span><span class="string" id="8532479">&#34;Get:&nbsp;%v&#34;</span><span class="op" id="8532488">,</span>&nbsp;<span class="ident" id="8532490"><a href="/net/http/httputil/reverseproxy_test.go.html#8532015">err</a></span><span class="op" id="8532493">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8532496">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8532499">if</span>&nbsp;<span class="ident" id="8532502">g</span><span class="op" id="8532503">,</span>&nbsp;<span class="ident" id="8532505">e</span>&nbsp;<span class="op" id="8532507">:=</span>&nbsp;<span class="ident" id="8532510"><a href="/net/http/httputil/reverseproxy_test.go.html#8532409">res</a></span><span class="op" id="8532513">.</span><span class="ident" id="8532514">StatusCode</span><span class="op" id="8532524">,</span>&nbsp;<span class="ident" id="8532526"><a href="/net/http/httputil/reverseproxy_test.go.html#8531558">backendStatus</a></span><span class="op" id="8532539">;</span>&nbsp;<span class="ident" id="8532541"><a href="/net/http/httputil/reverseproxy_test.go.html#8532502">g</a></span>&nbsp;<span class="op" id="8532543">!=</span>&nbsp;<span class="ident" id="8532546"><a href="/net/http/httputil/reverseproxy_test.go.html#8532505">e</a></span>&nbsp;<span class="op" id="8532548">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8532552"><a href="/net/http/httputil/reverseproxy_test.go.html#8531453">t</a></span><span class="op" id="8532553">.</span><span class="ident" id="8532554">Errorf</span><span class="op" id="8532560">(</span><span class="string" id="8532561">&#34;got&nbsp;res.StatusCode&nbsp;%d;&nbsp;expected&nbsp;%d&#34;</span><span class="op" id="8532597">,</span>&nbsp;<span class="ident" id="8532599"><a href="/net/http/httputil/reverseproxy_test.go.html#8532502">g</a></span><span class="op" id="8532600">,</span>&nbsp;<span class="ident" id="8532602"><a href="/net/http/httputil/reverseproxy_test.go.html#8532505">e</a></span><span class="op" id="8532603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8532606">}</span><br>
<span class="lineno">130</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8532609">bodyBytes</span><span class="op" id="8532618">,</span>&nbsp;<span class="ident" id="8532620">_</span>&nbsp;<span class="op" id="8532622">:=</span>&nbsp;<span class="ident" id="8532625"><a href="/net/http/httputil/reverseproxy_test.go.html#8528841">ioutil</a></span><span class="op" id="8532631">.</span><span class="ident" id="8532632">ReadAll</span><span class="op" id="8532639">(</span><span class="ident" id="8532640"><a href="/net/http/httputil/reverseproxy_test.go.html#8532409">res</a></span><span class="op" id="8532643">.</span><span class="ident" id="8532644">Body</span><span class="op" id="8532648">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8532651">if</span>&nbsp;<span class="ident" id="8532654">g</span><span class="op" id="8532655">,</span>&nbsp;<span class="ident" id="8532657">e</span>&nbsp;<span class="op" id="8532659">:=</span>&nbsp;<span class="builtintype" id="8532662">string</span><span class="op" id="8532668">(</span><span class="ident" id="8532669"><a href="/net/http/httputil/reverseproxy_test.go.html#8532609">bodyBytes</a></span><span class="op" id="8532678">)</span><span class="op" id="8532679">,</span>&nbsp;<span class="ident" id="8532681"><a href="/net/http/httputil/reverseproxy_test.go.html#8531514">backendResponse</a></span><span class="op" id="8532696">;</span>&nbsp;<span class="ident" id="8532698"><a href="/net/http/httputil/reverseproxy_test.go.html#8532654">g</a></span>&nbsp;<span class="op" id="8532700">!=</span>&nbsp;<span class="ident" id="8532703"><a href="/net/http/httputil/reverseproxy_test.go.html#8532657">e</a></span>&nbsp;<span class="op" id="8532705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8532709"><a href="/net/http/httputil/reverseproxy_test.go.html#8531453">t</a></span><span class="op" id="8532710">.</span><span class="ident" id="8532711">Errorf</span><span class="op" id="8532717">(</span><span class="string" id="8532718">&#34;got&nbsp;body&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="8532744">,</span>&nbsp;<span class="ident" id="8532746"><a href="/net/http/httputil/reverseproxy_test.go.html#8532654">g</a></span><span class="op" id="8532747">,</span>&nbsp;<span class="ident" id="8532749"><a href="/net/http/httputil/reverseproxy_test.go.html#8532657">e</a></span><span class="op" id="8532750">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8532753">}</span><br>
<span class="lineno"></span><span class="op" id="8532755">}</span><br>
<span class="lineno">135</span><br>
<span class="lineno"></span><span class="keyword" id="8532758">var</span>&nbsp;<span class="ident" id="8532762">proxyQueryTests</span>&nbsp;<span class="op" id="8532778">=</span>&nbsp;<span class="op" id="8532780">[</span><span class="op" id="8532781">]</span><span class="keyword" id="8532782">struct</span>&nbsp;<span class="op" id="8532789">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8532792">baseSuffix</span>&nbsp;<span class="builtintype" id="8532803">string</span>&nbsp;<span class="comment" id="8532810">//&nbsp;suffix&nbsp;to&nbsp;add&nbsp;to&nbsp;backend&nbsp;URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8532843">reqSuffix</span>&nbsp;&nbsp;<span class="builtintype" id="8532854">string</span>&nbsp;<span class="comment" id="8532861">//&nbsp;suffix&nbsp;to&nbsp;add&nbsp;to&nbsp;frontend&#39;s&nbsp;request&nbsp;URL</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8532905">want</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="8532916">string</span>&nbsp;<span class="comment" id="8532923">//&nbsp;what&nbsp;backend&nbsp;should&nbsp;see&nbsp;for&nbsp;final&nbsp;request&nbsp;URL&nbsp;(without&nbsp;?)</span><br>
<span class="lineno">140</span><span class="op" id="8532984">}</span><span class="op" id="8532985">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8532988">{</span><span class="string" id="8532989">&#34;&#34;</span><span class="op" id="8532991">,</span>&nbsp;<span class="string" id="8532993">&#34;&#34;</span><span class="op" id="8532995">,</span>&nbsp;<span class="string" id="8532997">&#34;&#34;</span><span class="op" id="8532999">}</span><span class="op" id="8533000">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8533003">{</span><span class="string" id="8533004">&#34;?sta=tic&#34;</span><span class="op" id="8533014">,</span>&nbsp;<span class="string" id="8533016">&#34;?us=er&#34;</span><span class="op" id="8533024">,</span>&nbsp;<span class="string" id="8533026">&#34;sta=tic&amp;us=er&#34;</span><span class="op" id="8533041">}</span><span class="op" id="8533042">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8533045">{</span><span class="string" id="8533046">&#34;&#34;</span><span class="op" id="8533048">,</span>&nbsp;<span class="string" id="8533050">&#34;?us=er&#34;</span><span class="op" id="8533058">,</span>&nbsp;<span class="string" id="8533060">&#34;us=er&#34;</span><span class="op" id="8533067">}</span><span class="op" id="8533068">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8533071">{</span><span class="string" id="8533072">&#34;?sta=tic&#34;</span><span class="op" id="8533082">,</span>&nbsp;<span class="string" id="8533084">&#34;&#34;</span><span class="op" id="8533086">,</span>&nbsp;<span class="string" id="8533088">&#34;sta=tic&#34;</span><span class="op" id="8533097">}</span><span class="op" id="8533098">,</span><br>
<span class="lineno">145</span><span class="op" id="8533100">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8533103">func</span>&nbsp;<span class="ident" id="8533108">TestReverseProxyQuery</span><span class="op" id="8533129">(</span><span class="ident" id="8533130">t</span>&nbsp;<span class="op" id="8533132">*</span><span class="ident" id="8533133"><a href="/net/http/httputil/reverseproxy_test.go.html#8528909">testing</a></span><span class="op" id="8533140">.</span><span class="ident" id="8533141">T</span><span class="op" id="8533142">)</span>&nbsp;<span class="op" id="8533144">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8533147">backend</span>&nbsp;<span class="op" id="8533155">:=</span>&nbsp;<span class="ident" id="8533158"><a href="/net/http/httputil/reverseproxy_test.go.html#8528866">httptest</a></span><span class="op" id="8533166">.</span><span class="ident" id="8533167">NewServer</span><span class="op" id="8533176">(</span><span class="ident" id="8533177"><a href="/net/http/httputil/reverseproxy_test.go.html#8528854">http</a></span><span class="op" id="8533181">.</span><span class="ident" id="8533182">HandlerFunc</span><span class="op" id="8533193">(</span><span class="keyword" id="8533194">func</span><span class="op" id="8533198">(</span><span class="ident" id="8533199">w</span>&nbsp;<span class="ident" id="8533201"><a href="/net/http/httputil/reverseproxy_test.go.html#8528854">http</a></span><span class="op" id="8533205">.</span><span class="ident" id="8533206">ResponseWriter</span><span class="op" id="8533220">,</span>&nbsp;<span class="ident" id="8533222">r</span>&nbsp;<span class="op" id="8533224">*</span><span class="ident" id="8533225"><a href="/net/http/httputil/reverseproxy_test.go.html#8528854">http</a></span><span class="op" id="8533229">.</span><span class="ident" id="8533230">Request</span><span class="op" id="8533237">)</span>&nbsp;<span class="op" id="8533239">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8533243"><a href="/net/http/httputil/reverseproxy_test.go.html#8533199">w</a></span><span class="op" id="8533244">.</span><span class="ident" id="8533245">Header</span><span class="op" id="8533251">(</span><span class="op" id="8533252">)</span><span class="op" id="8533253">.</span><span class="ident" id="8533254">Set</span><span class="op" id="8533257">(</span><span class="string" id="8533258">&#34;X-Got-Query&#34;</span><span class="op" id="8533271">,</span>&nbsp;<span class="ident" id="8533273"><a href="/net/http/httputil/reverseproxy_test.go.html#8533222">r</a></span><span class="op" id="8533274">.</span><span class="ident" id="8533275">URL</span><span class="op" id="8533278">.</span><span class="ident" id="8533279">RawQuery</span><span class="op" id="8533287">)</span><br>
<span class="lineno">150</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8533291"><a href="/net/http/httputil/reverseproxy_test.go.html#8533199">w</a></span><span class="op" id="8533292">.</span><span class="ident" id="8533293">Write</span><span class="op" id="8533298">(</span><span class="op" id="8533299">[</span><span class="op" id="8533300">]</span><span class="builtintype" id="8533301">byte</span><span class="op" id="8533305">(</span><span class="string" id="8533306">&#34;hi&#34;</span><span class="op" id="8533310">)</span><span class="op" id="8533311">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8533314">}</span><span class="op" id="8533315">)</span><span class="op" id="8533316">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8533319">defer</span>&nbsp;<span class="ident" id="8533325"><a href="/net/http/httputil/reverseproxy_test.go.html#8533147">backend</a></span><span class="op" id="8533332">.</span><span class="ident" id="8533333">Close</span><span class="op" id="8533338">(</span><span class="op" id="8533339">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8533343">for</span>&nbsp;<span class="ident" id="8533347">i</span><span class="op" id="8533348">,</span>&nbsp;<span class="ident" id="8533350">tt</span>&nbsp;<span class="op" id="8533353">:=</span>&nbsp;<span class="keyword" id="8533356">range</span>&nbsp;<span class="ident" id="8533362"><a href="/net/http/httputil/reverseproxy_test.go.html#8532762">proxyQueryTests</a></span>&nbsp;<span class="op" id="8533378">{</span><br>
<span class="lineno">155</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8533382">backendURL</span><span class="op" id="8533392">,</span>&nbsp;<span class="ident" id="8533394">err</span>&nbsp;<span class="op" id="8533398">:=</span>&nbsp;<span class="ident" id="8533401"><a href="/net/http/httputil/reverseproxy_test.go.html#8528887">url</a></span><span class="op" id="8533404">.</span><span class="ident" id="8533405">Parse</span><span class="op" id="8533410">(</span><span class="ident" id="8533411"><a href="/net/http/httputil/reverseproxy_test.go.html#8533147">backend</a></span><span class="op" id="8533418">.</span><span class="ident" id="8533419">URL</span>&nbsp;<span class="op" id="8533423">+</span>&nbsp;<span class="ident" id="8533425"><a href="/net/http/httputil/reverseproxy_test.go.html#8533350">tt</a></span><span class="op" id="8533427">.</span><span class="ident" id="8533428">baseSuffix</span><span class="op" id="8533438">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8533442">if</span>&nbsp;<span class="ident" id="8533445"><a href="/net/http/httputil/reverseproxy_test.go.html#8533394">err</a></span>&nbsp;<span class="op" id="8533449">!=</span>&nbsp;<span class="ident" id="8533452">nil</span>&nbsp;<span class="op" id="8533456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8533461"><a href="/net/http/httputil/reverseproxy_test.go.html#8533130">t</a></span><span class="op" id="8533462">.</span><span class="ident" id="8533463">Fatal</span><span class="op" id="8533468">(</span><span class="ident" id="8533469"><a href="/net/http/httputil/reverseproxy_test.go.html#8533394">err</a></span><span class="op" id="8533472">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8533476">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8533480">frontend</span>&nbsp;<span class="op" id="8533489">:=</span>&nbsp;<span class="ident" id="8533492"><a href="/net/http/httputil/reverseproxy_test.go.html#8528866">httptest</a></span><span class="op" id="8533500">.</span><span class="ident" id="8533501">NewServer</span><span class="op" id="8533510">(</span><span class="ident" id="8533511"><a href="/net/http/httputil/reverseproxy.go.html#6270287">NewSingleHostReverseProxy</a></span><span class="op" id="8533536">(</span><span class="ident" id="8533537"><a href="/net/http/httputil/reverseproxy_test.go.html#8533382">backendURL</a></span><span class="op" id="8533547">)</span><span class="op" id="8533548">)</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8533552">req</span><span class="op" id="8533555">,</span>&nbsp;<span class="ident" id="8533557">_</span>&nbsp;<span class="op" id="8533559">:=</span>&nbsp;<span class="ident" id="8533562"><a href="/net/http/httputil/reverseproxy_test.go.html#8528854">http</a></span><span class="op" id="8533566">.</span><span class="ident" id="8533567">NewRequest</span><span class="op" id="8533577">(</span><span class="string" id="8533578">&#34;GET&#34;</span><span class="op" id="8533583">,</span>&nbsp;<span class="ident" id="8533585"><a href="/net/http/httputil/reverseproxy_test.go.html#8533480">frontend</a></span><span class="op" id="8533593">.</span><span class="ident" id="8533594">URL</span><span class="op" id="8533597">+</span><span class="ident" id="8533598"><a href="/net/http/httputil/reverseproxy_test.go.html#8533350">tt</a></span><span class="op" id="8533600">.</span><span class="ident" id="8533601">reqSuffix</span><span class="op" id="8533610">,</span>&nbsp;<span class="ident" id="8533612">nil</span><span class="op" id="8533615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8533619"><a href="/net/http/httputil/reverseproxy_test.go.html#8533552">req</a></span><span class="op" id="8533622">.</span><span class="ident" id="8533623">Close</span>&nbsp;<span class="op" id="8533629">=</span>&nbsp;<span class="ident" id="8533631">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8533638">res</span><span class="op" id="8533641">,</span>&nbsp;<span class="ident" id="8533643"><a href="/net/http/httputil/reverseproxy_test.go.html#8533394">err</a></span>&nbsp;<span class="op" id="8533647">:=</span>&nbsp;<span class="ident" id="8533650"><a href="/net/http/httputil/reverseproxy_test.go.html#8528854">http</a></span><span class="op" id="8533654">.</span><span class="ident" id="8533655">DefaultClient</span><span class="op" id="8533668">.</span><span class="ident" id="8533669">Do</span><span class="op" id="8533671">(</span><span class="ident" id="8533672"><a href="/net/http/httputil/reverseproxy_test.go.html#8533552">req</a></span><span class="op" id="8533675">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8533679">if</span>&nbsp;<span class="ident" id="8533682"><a href="/net/http/httputil/reverseproxy_test.go.html#8533394">err</a></span>&nbsp;<span class="op" id="8533686">!=</span>&nbsp;<span class="ident" id="8533689">nil</span>&nbsp;<span class="op" id="8533693">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8533698"><a href="/net/http/httputil/reverseproxy_test.go.html#8533130">t</a></span><span class="op" id="8533699">.</span><span class="ident" id="8533700">Fatalf</span><span class="op" id="8533706">(</span><span class="string" id="8533707">&#34;%d.&nbsp;Get:&nbsp;%v&#34;</span><span class="op" id="8533720">,</span>&nbsp;<span class="ident" id="8533722"><a href="/net/http/httputil/reverseproxy_test.go.html#8533347">i</a></span><span class="op" id="8533723">,</span>&nbsp;<span class="ident" id="8533725"><a href="/net/http/httputil/reverseproxy_test.go.html#8533394">err</a></span><span class="op" id="8533728">)</span><br>
<span class="lineno">165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8533732">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8533736">if</span>&nbsp;<span class="ident" id="8533739">g</span><span class="op" id="8533740">,</span>&nbsp;<span class="ident" id="8533742">e</span>&nbsp;<span class="op" id="8533744">:=</span>&nbsp;<span class="ident" id="8533747"><a href="/net/http/httputil/reverseproxy_test.go.html#8533638">res</a></span><span class="op" id="8533750">.</span><span class="ident" id="8533751">Header</span><span class="op" id="8533757">.</span><span class="ident" id="8533758">Get</span><span class="op" id="8533761">(</span><span class="string" id="8533762">&#34;X-Got-Query&#34;</span><span class="op" id="8533775">)</span><span class="op" id="8533776">,</span>&nbsp;<span class="ident" id="8533778"><a href="/net/http/httputil/reverseproxy_test.go.html#8533350">tt</a></span><span class="op" id="8533780">.</span><span class="ident" id="8533781">want</span><span class="op" id="8533785">;</span>&nbsp;<span class="ident" id="8533787"><a href="/net/http/httputil/reverseproxy_test.go.html#8533739">g</a></span>&nbsp;<span class="op" id="8533789">!=</span>&nbsp;<span class="ident" id="8533792"><a href="/net/http/httputil/reverseproxy_test.go.html#8533742">e</a></span>&nbsp;<span class="op" id="8533794">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8533799"><a href="/net/http/httputil/reverseproxy_test.go.html#8533130">t</a></span><span class="op" id="8533800">.</span><span class="ident" id="8533801">Errorf</span><span class="op" id="8533807">(</span><span class="string" id="8533808">&#34;%d.&nbsp;got&nbsp;query&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="8533839">,</span>&nbsp;<span class="ident" id="8533841"><a href="/net/http/httputil/reverseproxy_test.go.html#8533347">i</a></span><span class="op" id="8533842">,</span>&nbsp;<span class="ident" id="8533844"><a href="/net/http/httputil/reverseproxy_test.go.html#8533739">g</a></span><span class="op" id="8533845">,</span>&nbsp;<span class="ident" id="8533847"><a href="/net/http/httputil/reverseproxy_test.go.html#8533742">e</a></span><span class="op" id="8533848">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8533852">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8533856"><a href="/net/http/httputil/reverseproxy_test.go.html#8533638">res</a></span><span class="op" id="8533859">.</span><span class="ident" id="8533860">Body</span><span class="op" id="8533864">.</span><span class="ident" id="8533865">Close</span><span class="op" id="8533870">(</span><span class="op" id="8533871">)</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8533875"><a href="/net/http/httputil/reverseproxy_test.go.html#8533480">frontend</a></span><span class="op" id="8533883">.</span><span class="ident" id="8533884">Close</span><span class="op" id="8533889">(</span><span class="op" id="8533890">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8533893">}</span><br>
<span class="lineno"></span><span class="op" id="8533895">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="8533898">func</span>&nbsp;<span class="ident" id="8533903">TestReverseProxyFlushInterval</span><span class="op" id="8533932">(</span><span class="ident" id="8533933">t</span>&nbsp;<span class="op" id="8533935">*</span><span class="ident" id="8533936"><a href="/net/http/httputil/reverseproxy_test.go.html#8528909">testing</a></span><span class="op" id="8533943">.</span><span class="ident" id="8533944">T</span><span class="op" id="8533945">)</span>&nbsp;<span class="op" id="8533947">{</span><br>
<span class="lineno">175</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8533950">const</span>&nbsp;<span class="ident" id="8533956">expected</span>&nbsp;<span class="op" id="8533965">=</span>&nbsp;<span class="string" id="8533967">&#34;hi&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8533973">backend</span>&nbsp;<span class="op" id="8533981">:=</span>&nbsp;<span class="ident" id="8533984"><a href="/net/http/httputil/reverseproxy_test.go.html#8528866">httptest</a></span><span class="op" id="8533992">.</span><span class="ident" id="8533993">NewServer</span><span class="op" id="8534002">(</span><span class="ident" id="8534003"><a href="/net/http/httputil/reverseproxy_test.go.html#8528854">http</a></span><span class="op" id="8534007">.</span><span class="ident" id="8534008">HandlerFunc</span><span class="op" id="8534019">(</span><span class="keyword" id="8534020">func</span><span class="op" id="8534024">(</span><span class="ident" id="8534025">w</span>&nbsp;<span class="ident" id="8534027"><a href="/net/http/httputil/reverseproxy_test.go.html#8528854">http</a></span><span class="op" id="8534031">.</span><span class="ident" id="8534032">ResponseWriter</span><span class="op" id="8534046">,</span>&nbsp;<span class="ident" id="8534048">r</span>&nbsp;<span class="op" id="8534050">*</span><span class="ident" id="8534051"><a href="/net/http/httputil/reverseproxy_test.go.html#8528854">http</a></span><span class="op" id="8534055">.</span><span class="ident" id="8534056">Request</span><span class="op" id="8534063">)</span>&nbsp;<span class="op" id="8534065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8534069"><a href="/net/http/httputil/reverseproxy_test.go.html#8534025">w</a></span><span class="op" id="8534070">.</span><span class="ident" id="8534071">Write</span><span class="op" id="8534076">(</span><span class="op" id="8534077">[</span><span class="op" id="8534078">]</span><span class="builtintype" id="8534079">byte</span><span class="op" id="8534083">(</span><span class="ident" id="8534084"><a href="/net/http/httputil/reverseproxy_test.go.html#8533956">expected</a></span><span class="op" id="8534092">)</span><span class="op" id="8534093">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8534096">}</span><span class="op" id="8534097">)</span><span class="op" id="8534098">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8534101">defer</span>&nbsp;<span class="ident" id="8534107"><a href="/net/http/httputil/reverseproxy_test.go.html#8533973">backend</a></span><span class="op" id="8534114">.</span><span class="ident" id="8534115">Close</span><span class="op" id="8534120">(</span><span class="op" id="8534121">)</span><br>
<span class="lineno">180</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8534125">backendURL</span><span class="op" id="8534135">,</span>&nbsp;<span class="ident" id="8534137">err</span>&nbsp;<span class="op" id="8534141">:=</span>&nbsp;<span class="ident" id="8534144"><a href="/net/http/httputil/reverseproxy_test.go.html#8528887">url</a></span><span class="op" id="8534147">.</span><span class="ident" id="8534148">Parse</span><span class="op" id="8534153">(</span><span class="ident" id="8534154"><a href="/net/http/httputil/reverseproxy_test.go.html#8533973">backend</a></span><span class="op" id="8534161">.</span><span class="ident" id="8534162">URL</span><span class="op" id="8534165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8534168">if</span>&nbsp;<span class="ident" id="8534171"><a href="/net/http/httputil/reverseproxy_test.go.html#8534137">err</a></span>&nbsp;<span class="op" id="8534175">!=</span>&nbsp;<span class="ident" id="8534178">nil</span>&nbsp;<span class="op" id="8534182">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8534186"><a href="/net/http/httputil/reverseproxy_test.go.html#8533933">t</a></span><span class="op" id="8534187">.</span><span class="ident" id="8534188">Fatal</span><span class="op" id="8534193">(</span><span class="ident" id="8534194"><a href="/net/http/httputil/reverseproxy_test.go.html#8534137">err</a></span><span class="op" id="8534197">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8534200">}</span><br>
<span class="lineno">185</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8534204">proxyHandler</span>&nbsp;<span class="op" id="8534217">:=</span>&nbsp;<span class="ident" id="8534220"><a href="/net/http/httputil/reverseproxy.go.html#6270287">NewSingleHostReverseProxy</a></span><span class="op" id="8534245">(</span><span class="ident" id="8534246"><a href="/net/http/httputil/reverseproxy_test.go.html#8534125">backendURL</a></span><span class="op" id="8534256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8534259"><a href="/net/http/httputil/reverseproxy_test.go.html#8534204">proxyHandler</a></span><span class="op" id="8534271">.</span><span class="ident" id="8534272">FlushInterval</span>&nbsp;<span class="op" id="8534286">=</span>&nbsp;<span class="ident" id="8534288"><a href="/net/http/httputil/reverseproxy_test.go.html#8528920">time</a></span><span class="op" id="8534292">.</span><span class="ident" id="8534293">Microsecond</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8534307">done</span>&nbsp;<span class="op" id="8534312">:=</span>&nbsp;<span class="builtinfunc" id="8534315">make</span><span class="op" id="8534319">(</span><span class="keyword" id="8534320">chan</span>&nbsp;<span class="builtintype" id="8534325">bool</span><span class="op" id="8534329">)</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8534332"><a href="/net/http/httputil/reverseproxy.go.html#6268855">onExitFlushLoop</a></span>&nbsp;<span class="op" id="8534348">=</span>&nbsp;<span class="keyword" id="8534350">func</span><span class="op" id="8534354">(</span><span class="op" id="8534355">)</span>&nbsp;<span class="op" id="8534357">{</span>&nbsp;<span class="ident" id="8534359"><a href="/net/http/httputil/reverseproxy_test.go.html#8534307">done</a></span>&nbsp;<span class="op" id="8534364">&lt;-</span>&nbsp;<span class="ident" id="8534367">true</span>&nbsp;<span class="op" id="8534372">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8534375">defer</span>&nbsp;<span class="keyword" id="8534381">func</span><span class="op" id="8534385">(</span><span class="op" id="8534386">)</span>&nbsp;<span class="op" id="8534388">{</span>&nbsp;<span class="ident" id="8534390"><a href="/net/http/httputil/reverseproxy.go.html#6268855">onExitFlushLoop</a></span>&nbsp;<span class="op" id="8534406">=</span>&nbsp;<span class="ident" id="8534408">nil</span>&nbsp;<span class="op" id="8534412">}</span><span class="op" id="8534413">(</span><span class="op" id="8534414">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8534418">frontend</span>&nbsp;<span class="op" id="8534427">:=</span>&nbsp;<span class="ident" id="8534430"><a href="/net/http/httputil/reverseproxy_test.go.html#8528866">httptest</a></span><span class="op" id="8534438">.</span><span class="ident" id="8534439">NewServer</span><span class="op" id="8534448">(</span><span class="ident" id="8534449"><a href="/net/http/httputil/reverseproxy_test.go.html#8534204">proxyHandler</a></span><span class="op" id="8534461">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8534464">defer</span>&nbsp;<span class="ident" id="8534470"><a href="/net/http/httputil/reverseproxy_test.go.html#8534418">frontend</a></span><span class="op" id="8534478">.</span><span class="ident" id="8534479">Close</span><span class="op" id="8534484">(</span><span class="op" id="8534485">)</span><br>
<span class="lineno">195</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8534489">req</span><span class="op" id="8534492">,</span>&nbsp;<span class="ident" id="8534494">_</span>&nbsp;<span class="op" id="8534496">:=</span>&nbsp;<span class="ident" id="8534499"><a href="/net/http/httputil/reverseproxy_test.go.html#8528854">http</a></span><span class="op" id="8534503">.</span><span class="ident" id="8534504">NewRequest</span><span class="op" id="8534514">(</span><span class="string" id="8534515">&#34;GET&#34;</span><span class="op" id="8534520">,</span>&nbsp;<span class="ident" id="8534522"><a href="/net/http/httputil/reverseproxy_test.go.html#8534418">frontend</a></span><span class="op" id="8534530">.</span><span class="ident" id="8534531">URL</span><span class="op" id="8534534">,</span>&nbsp;<span class="ident" id="8534536">nil</span><span class="op" id="8534539">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8534542"><a href="/net/http/httputil/reverseproxy_test.go.html#8534489">req</a></span><span class="op" id="8534545">.</span><span class="ident" id="8534546">Close</span>&nbsp;<span class="op" id="8534552">=</span>&nbsp;<span class="ident" id="8534554">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8534560">res</span><span class="op" id="8534563">,</span>&nbsp;<span class="ident" id="8534565"><a href="/net/http/httputil/reverseproxy_test.go.html#8534137">err</a></span>&nbsp;<span class="op" id="8534569">:=</span>&nbsp;<span class="ident" id="8534572"><a href="/net/http/httputil/reverseproxy_test.go.html#8528854">http</a></span><span class="op" id="8534576">.</span><span class="ident" id="8534577">DefaultClient</span><span class="op" id="8534590">.</span><span class="ident" id="8534591">Do</span><span class="op" id="8534593">(</span><span class="ident" id="8534594"><a href="/net/http/httputil/reverseproxy_test.go.html#8534489">req</a></span><span class="op" id="8534597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8534600">if</span>&nbsp;<span class="ident" id="8534603"><a href="/net/http/httputil/reverseproxy_test.go.html#8534137">err</a></span>&nbsp;<span class="op" id="8534607">!=</span>&nbsp;<span class="ident" id="8534610">nil</span>&nbsp;<span class="op" id="8534614">{</span><br>
<span class="lineno">200</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8534618"><a href="/net/http/httputil/reverseproxy_test.go.html#8533933">t</a></span><span class="op" id="8534619">.</span><span class="ident" id="8534620">Fatalf</span><span class="op" id="8534626">(</span><span class="string" id="8534627">&#34;Get:&nbsp;%v&#34;</span><span class="op" id="8534636">,</span>&nbsp;<span class="ident" id="8534638"><a href="/net/http/httputil/reverseproxy_test.go.html#8534137">err</a></span><span class="op" id="8534641">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8534644">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8534647">defer</span>&nbsp;<span class="ident" id="8534653"><a href="/net/http/httputil/reverseproxy_test.go.html#8534560">res</a></span><span class="op" id="8534656">.</span><span class="ident" id="8534657">Body</span><span class="op" id="8534661">.</span><span class="ident" id="8534662">Close</span><span class="op" id="8534667">(</span><span class="op" id="8534668">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8534671">if</span>&nbsp;<span class="ident" id="8534674">bodyBytes</span><span class="op" id="8534683">,</span>&nbsp;<span class="ident" id="8534685">_</span>&nbsp;<span class="op" id="8534687">:=</span>&nbsp;<span class="ident" id="8534690"><a href="/net/http/httputil/reverseproxy_test.go.html#8528841">ioutil</a></span><span class="op" id="8534696">.</span><span class="ident" id="8534697">ReadAll</span><span class="op" id="8534704">(</span><span class="ident" id="8534705"><a href="/net/http/httputil/reverseproxy_test.go.html#8534560">res</a></span><span class="op" id="8534708">.</span><span class="ident" id="8534709">Body</span><span class="op" id="8534713">)</span><span class="op" id="8534714">;</span>&nbsp;<span class="builtintype" id="8534716">string</span><span class="op" id="8534722">(</span><span class="ident" id="8534723"><a href="/net/http/httputil/reverseproxy_test.go.html#8534674">bodyBytes</a></span><span class="op" id="8534732">)</span>&nbsp;<span class="op" id="8534734">!=</span>&nbsp;<span class="ident" id="8534737"><a href="/net/http/httputil/reverseproxy_test.go.html#8533956">expected</a></span>&nbsp;<span class="op" id="8534746">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8534750"><a href="/net/http/httputil/reverseproxy_test.go.html#8533933">t</a></span><span class="op" id="8534751">.</span><span class="ident" id="8534752">Errorf</span><span class="op" id="8534758">(</span><span class="string" id="8534759">&#34;got&nbsp;body&nbsp;%q;&nbsp;expected&nbsp;%q&#34;</span><span class="op" id="8534785">,</span>&nbsp;<span class="ident" id="8534787"><a href="/net/http/httputil/reverseproxy_test.go.html#8534674">bodyBytes</a></span><span class="op" id="8534796">,</span>&nbsp;<span class="ident" id="8534798"><a href="/net/http/httputil/reverseproxy_test.go.html#8533956">expected</a></span><span class="op" id="8534806">)</span><br>
<span class="lineno">205</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8534809">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8534813">select</span>&nbsp;<span class="op" id="8534820">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8534823">case</span>&nbsp;<span class="op" id="8534828">&lt;-</span><span class="ident" id="8534830"><a href="/net/http/httputil/reverseproxy_test.go.html#8534307">done</a></span><span class="op" id="8534834">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="8534838">//&nbsp;OK</span><br>
<span class="lineno">210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="8534845">case</span>&nbsp;<span class="op" id="8534850">&lt;-</span><span class="ident" id="8534852"><a href="/net/http/httputil/reverseproxy_test.go.html#8528920">time</a></span><span class="op" id="8534856">.</span><span class="ident" id="8534857">After</span><span class="op" id="8534862">(</span><span class="num" id="8534863">5</span>&nbsp;<span class="op" id="8534865">*</span>&nbsp;<span class="ident" id="8534867"><a href="/net/http/httputil/reverseproxy_test.go.html#8528920">time</a></span><span class="op" id="8534871">.</span><span class="ident" id="8534872">Second</span><span class="op" id="8534878">)</span><span class="op" id="8534879">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="8534883"><a href="/net/http/httputil/reverseproxy_test.go.html#8533933">t</a></span><span class="op" id="8534884">.</span><span class="ident" id="8534885">Error</span><span class="op" id="8534890">(</span><span class="string" id="8534891">&#34;maxLatencyWriter&nbsp;flushLoop()&nbsp;never&nbsp;exited&#34;</span><span class="op" id="8534934">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="8534937">}</span><br>
<span class="lineno"></span><span class="op" id="8534939">}</span>
</div>
</body>
</html>
