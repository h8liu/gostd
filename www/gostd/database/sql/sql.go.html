<!doctype html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Go standard library</title>
	<link rel="stylesheet" type="text/css" href="/gostd.css">
</head>

<body>

<div class="pkgnavi">
<h1><a href="/gostd/index.html">Go Standard Library</a></h1>
<h2>database/sql</h2>
<ul>
<li><a href="/gostd/database/sql/convert.go.html">convert.go</a></li>
<li><a href="/gostd/database/sql/convert_test.go.html">convert_test.go</a></li>
<li><a href="/gostd/database/sql/example_test.go.html">example_test.go</a></li>
<li><a href="/gostd/database/sql/fakedb_test.go.html">fakedb_test.go</a></li>
<li><a href="/gostd/database/sql/sql.go.html">sql.go</a></li>
<li><a href="/gostd/database/sql/sql_test.go.html">sql_test.go</a></li>
</ul>
</div>
<div class="code">
<span class="lineno">1</span><span class="comment" id="3213721">//&nbsp;Copyright&nbsp;2011&nbsp;The&nbsp;Go&nbsp;Authors.&nbsp;All&nbsp;rights&nbsp;reserved.</span><br>
<span class="lineno"></span><span class="comment" id="3213776">//&nbsp;Use&nbsp;of&nbsp;this&nbsp;source&nbsp;code&nbsp;is&nbsp;governed&nbsp;by&nbsp;a&nbsp;BSD-style</span><br>
<span class="lineno"></span><span class="comment" id="3213830">//&nbsp;license&nbsp;that&nbsp;can&nbsp;be&nbsp;found&nbsp;in&nbsp;the&nbsp;LICENSE&nbsp;file.</span><br>
<span class="lineno"></span><br>
<span class="lineno">5</span><span class="comment" id="3213881">//&nbsp;Package&nbsp;sql&nbsp;provides&nbsp;a&nbsp;generic&nbsp;interface&nbsp;around&nbsp;SQL&nbsp;(or&nbsp;SQL-like)</span><br>
<span class="lineno"></span><span class="comment" id="3213950">//&nbsp;databases.</span><br>
<span class="lineno"></span><span class="comment" id="3213964">//</span><br>
<span class="lineno"></span><span class="comment" id="3213967">//&nbsp;The&nbsp;sql&nbsp;package&nbsp;must&nbsp;be&nbsp;used&nbsp;in&nbsp;conjunction&nbsp;with&nbsp;a&nbsp;database&nbsp;driver.</span><br>
<span class="lineno"></span><span class="comment" id="3214038">//&nbsp;See&nbsp;http://golang.org/s/sqldrivers&nbsp;for&nbsp;a&nbsp;list&nbsp;of&nbsp;drivers.</span><br>
<span class="lineno">10</span><span class="comment" id="3214099">//</span><br>
<span class="lineno"></span><span class="comment" id="3214102">//&nbsp;For&nbsp;more&nbsp;usage&nbsp;examples,&nbsp;see&nbsp;the&nbsp;wiki&nbsp;page&nbsp;at</span><br>
<span class="lineno"></span><span class="comment" id="3214151">//&nbsp;http://golang.org/s/sqlwiki.</span><br>
<span class="lineno"></span><span class="keyword" id="3214183">package</span>&nbsp;<span class="ident" id="3214191">sql</span><br>
<span class="lineno"></span><br>
<span class="lineno">15</span><span class="keyword" id="3214196">import</span>&nbsp;<span class="op" id="3214203">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3214206">&#34;database/sql/driver&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3214229">&#34;errors&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3214239">&#34;fmt&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3214246">&#34;io&#34;</span><br>
<span class="lineno">20</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3214252">&#34;runtime&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3214263">&#34;sort&#34;</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="string" id="3214271">&#34;sync&#34;</span><br>
<span class="lineno"></span><span class="op" id="3214278">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">25</span><span class="keyword" id="3214281">var</span>&nbsp;<span class="ident" id="3214285">drivers</span>&nbsp;<span class="op" id="3214293">=</span>&nbsp;<span class="builtinfunc" id="3214295">make</span><span class="op" id="3214299">(</span><span class="keyword" id="3214300">map</span><span class="op" id="3214303">[</span><span class="builtintype" id="3214304">string</span><span class="op" id="3214310">]</span><span class="ident" id="3214311">driver</span><span class="op" id="3214317">.</span><span class="ident" id="3214318">Driver</span><span class="op" id="3214324">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3214327">//&nbsp;Register&nbsp;makes&nbsp;a&nbsp;database&nbsp;driver&nbsp;available&nbsp;by&nbsp;the&nbsp;provided&nbsp;name.</span><br>
<span class="lineno"></span><span class="comment" id="3214395">//&nbsp;If&nbsp;Register&nbsp;is&nbsp;called&nbsp;twice&nbsp;with&nbsp;the&nbsp;same&nbsp;name&nbsp;or&nbsp;if&nbsp;driver&nbsp;is&nbsp;nil,</span><br>
<span class="lineno"></span><span class="comment" id="3214466">//&nbsp;it&nbsp;panics.</span><br>
<span class="lineno">30</span><span class="keyword" id="3214480">func</span>&nbsp;<span class="ident" id="3214485">Register</span><span class="op" id="3214493">(</span><span class="ident" id="3214494">name</span>&nbsp;<span class="builtintype" id="3214499">string</span><span class="op" id="3214505">,</span>&nbsp;<span class="ident" id="3214507">driver</span>&nbsp;<span class="ident" id="3214514">driver</span><span class="op" id="3214520">.</span><span class="ident" id="3214521">Driver</span><span class="op" id="3214527">)</span>&nbsp;<span class="op" id="3214529">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3214532">if</span>&nbsp;<span class="ident" id="3214535">driver</span>&nbsp;<span class="op" id="3214542">==</span>&nbsp;<span class="ident" id="3214545">nil</span>&nbsp;<span class="op" id="3214549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3214553">panic</span><span class="op" id="3214558">(</span><span class="string" id="3214559">&#34;sql:&nbsp;Register&nbsp;driver&nbsp;is&nbsp;nil&#34;</span><span class="op" id="3214588">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3214591">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3214594">if</span>&nbsp;<span class="ident" id="3214597">_</span><span class="op" id="3214598">,</span>&nbsp;<span class="ident" id="3214600">dup</span>&nbsp;<span class="op" id="3214604">:=</span>&nbsp;<span class="ident" id="3214607">drivers</span><span class="op" id="3214614">[</span><span class="ident" id="3214615">name</span><span class="op" id="3214619">]</span><span class="op" id="3214620">;</span>&nbsp;<span class="ident" id="3214622">dup</span>&nbsp;<span class="op" id="3214626">{</span><br>
<span class="lineno">35</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3214630">panic</span><span class="op" id="3214635">(</span><span class="string" id="3214636">&#34;sql:&nbsp;Register&nbsp;called&nbsp;twice&nbsp;for&nbsp;driver&nbsp;&#34;</span>&nbsp;<span class="op" id="3214677">+</span>&nbsp;<span class="ident" id="3214679">name</span><span class="op" id="3214683">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3214686">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3214689">drivers</span><span class="op" id="3214696">[</span><span class="ident" id="3214697">name</span><span class="op" id="3214701">]</span>&nbsp;<span class="op" id="3214703">=</span>&nbsp;<span class="ident" id="3214705">driver</span><br>
<span class="lineno"></span><span class="op" id="3214712">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">40</span><span class="keyword" id="3214715">func</span>&nbsp;<span class="ident" id="3214720">unregisterAllDrivers</span><span class="op" id="3214740">(</span><span class="op" id="3214741">)</span>&nbsp;<span class="op" id="3214743">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3214746">//&nbsp;For&nbsp;tests.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3214761">drivers</span>&nbsp;<span class="op" id="3214769">=</span>&nbsp;<span class="builtinfunc" id="3214771">make</span><span class="op" id="3214775">(</span><span class="keyword" id="3214776">map</span><span class="op" id="3214779">[</span><span class="builtintype" id="3214780">string</span><span class="op" id="3214786">]</span><span class="ident" id="3214787">driver</span><span class="op" id="3214793">.</span><span class="ident" id="3214794">Driver</span><span class="op" id="3214800">)</span><br>
<span class="lineno"></span><span class="op" id="3214802">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">45</span><span class="comment" id="3214805">//&nbsp;Drivers&nbsp;returns&nbsp;a&nbsp;sorted&nbsp;list&nbsp;of&nbsp;the&nbsp;names&nbsp;of&nbsp;the&nbsp;registered&nbsp;drivers.</span><br>
<span class="lineno"></span><span class="keyword" id="3214878">func</span>&nbsp;<span class="ident" id="3214883">Drivers</span><span class="op" id="3214890">(</span><span class="op" id="3214891">)</span>&nbsp;<span class="op" id="3214893">[</span><span class="op" id="3214894">]</span><span class="builtintype" id="3214895">string</span>&nbsp;<span class="op" id="3214902">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3214905">var</span>&nbsp;<span class="ident" id="3214909">list</span>&nbsp;<span class="op" id="3214914">[</span><span class="op" id="3214915">]</span><span class="builtintype" id="3214916">string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3214924">for</span>&nbsp;<span class="ident" id="3214928">name</span>&nbsp;<span class="op" id="3214933">:=</span>&nbsp;<span class="keyword" id="3214936">range</span>&nbsp;<span class="ident" id="3214942">drivers</span>&nbsp;<span class="op" id="3214950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3214954">list</span>&nbsp;<span class="op" id="3214959">=</span>&nbsp;<span class="builtinfunc" id="3214961">append</span><span class="op" id="3214967">(</span><span class="ident" id="3214968">list</span><span class="op" id="3214972">,</span>&nbsp;<span class="ident" id="3214974">name</span><span class="op" id="3214978">)</span><br>
<span class="lineno">50</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3214981">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3214984">sort</span><span class="op" id="3214988">.</span><span class="ident" id="3214989">Strings</span><span class="op" id="3214996">(</span><span class="ident" id="3214997">list</span><span class="op" id="3215001">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3215004">return</span>&nbsp;<span class="ident" id="3215011">list</span><br>
<span class="lineno"></span><span class="op" id="3215016">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">55</span><span class="comment" id="3215019">//&nbsp;RawBytes&nbsp;is&nbsp;a&nbsp;byte&nbsp;slice&nbsp;that&nbsp;holds&nbsp;a&nbsp;reference&nbsp;to&nbsp;memory&nbsp;owned&nbsp;by</span><br>
<span class="lineno"></span><span class="comment" id="3215089">//&nbsp;the&nbsp;database&nbsp;itself.&nbsp;After&nbsp;a&nbsp;Scan&nbsp;into&nbsp;a&nbsp;RawBytes,&nbsp;the&nbsp;slice&nbsp;is&nbsp;only</span><br>
<span class="lineno"></span><span class="comment" id="3215161">//&nbsp;valid&nbsp;until&nbsp;the&nbsp;next&nbsp;call&nbsp;to&nbsp;Next,&nbsp;Scan,&nbsp;or&nbsp;Close.</span><br>
<span class="lineno"></span><span class="keyword" id="3215215">type</span>&nbsp;<span class="ident" id="3215220">RawBytes</span>&nbsp;<span class="op" id="3215229">[</span><span class="op" id="3215230">]</span><span class="builtintype" id="3215231">byte</span><br>
<span class="lineno"></span><br>
<span class="lineno">60</span><span class="comment" id="3215237">//&nbsp;NullString&nbsp;represents&nbsp;a&nbsp;string&nbsp;that&nbsp;may&nbsp;be&nbsp;null.</span><br>
<span class="lineno"></span><span class="comment" id="3215289">//&nbsp;NullString&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface&nbsp;so</span><br>
<span class="lineno"></span><span class="comment" id="3215339">//&nbsp;it&nbsp;can&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;scan&nbsp;destination:</span><br>
<span class="lineno"></span><span class="comment" id="3215380">//</span><br>
<span class="lineno"></span><span class="comment" id="3215383">//&nbsp;&nbsp;var&nbsp;s&nbsp;NullString</span><br>
<span class="lineno">65</span><span class="comment" id="3215404">//&nbsp;&nbsp;err&nbsp;:=&nbsp;db.QueryRow(&#34;SELECT&nbsp;name&nbsp;FROM&nbsp;foo&nbsp;WHERE&nbsp;id=?&#34;,&nbsp;id).Scan(&amp;s)</span><br>
<span class="lineno"></span><span class="comment" id="3215475">//&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="comment" id="3215483">//&nbsp;&nbsp;if&nbsp;s.Valid&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="3215500">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;use&nbsp;s.String</span><br>
<span class="lineno"></span><span class="comment" id="3215523">//&nbsp;&nbsp;}&nbsp;else&nbsp;{</span><br>
<span class="lineno">70</span><span class="comment" id="3215536">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;NULL&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="3215557">//&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="3215563">//</span><br>
<span class="lineno"></span><span class="keyword" id="3215566">type</span>&nbsp;<span class="ident" id="3215571">NullString</span>&nbsp;<span class="keyword" id="3215582">struct</span>&nbsp;<span class="op" id="3215589">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3215592">String</span>&nbsp;<span class="builtintype" id="3215599">string</span><br>
<span class="lineno">75</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3215607">Valid</span>&nbsp;&nbsp;<span class="builtintype" id="3215614">bool</span>&nbsp;<span class="comment" id="3215619">//&nbsp;Valid&nbsp;is&nbsp;true&nbsp;if&nbsp;String&nbsp;is&nbsp;not&nbsp;NULL</span><br>
<span class="lineno"></span><span class="op" id="3215658">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3215661">//&nbsp;Scan&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="3215703">func</span>&nbsp;<span class="op" id="3215708">(</span><span class="ident" id="3215709">ns</span>&nbsp;<span class="op" id="3215712">*</span><span class="ident" id="3215713">NullString</span><span class="op" id="3215723">)</span>&nbsp;<span class="ident" id="3215725">Scan</span><span class="op" id="3215729">(</span><span class="ident" id="3215730">value</span>&nbsp;<span class="keyword" id="3215736">interface</span><span class="op" id="3215745">{</span><span class="op" id="3215746">}</span><span class="op" id="3215747">)</span>&nbsp;<span class="builtintype" id="3215749">error</span>&nbsp;<span class="op" id="3215755">{</span><br>
<span class="lineno">80</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3215758">if</span>&nbsp;<span class="ident" id="3215761">value</span>&nbsp;<span class="op" id="3215767">==</span>&nbsp;<span class="ident" id="3215770">nil</span>&nbsp;<span class="op" id="3215774">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3215778">ns</span><span class="op" id="3215780">.</span><span class="ident" id="3215781">String</span><span class="op" id="3215787">,</span>&nbsp;<span class="ident" id="3215789">ns</span><span class="op" id="3215791">.</span><span class="ident" id="3215792">Valid</span>&nbsp;<span class="op" id="3215798">=</span>&nbsp;<span class="string" id="3215800">&#34;&#34;</span><span class="op" id="3215802">,</span>&nbsp;<span class="builtintype" id="3215804">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3215812">return</span>&nbsp;<span class="ident" id="3215819">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3215824">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3215827">ns</span><span class="op" id="3215829">.</span><span class="ident" id="3215830">Valid</span>&nbsp;<span class="op" id="3215836">=</span>&nbsp;<span class="builtintype" id="3215838">true</span><br>
<span class="lineno">85</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3215844">return</span>&nbsp;<span class="ident" id="3215851">convertAssign</span><span class="op" id="3215864">(</span><span class="op" id="3215865">&amp;</span><span class="ident" id="3215866">ns</span><span class="op" id="3215868">.</span><span class="ident" id="3215869">String</span><span class="op" id="3215875">,</span>&nbsp;<span class="ident" id="3215877">value</span><span class="op" id="3215882">)</span><br>
<span class="lineno"></span><span class="op" id="3215884">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3215887">//&nbsp;Value&nbsp;implements&nbsp;the&nbsp;driver&nbsp;Valuer&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="3215936">func</span>&nbsp;<span class="op" id="3215941">(</span><span class="ident" id="3215942">ns</span>&nbsp;<span class="ident" id="3215945">NullString</span><span class="op" id="3215955">)</span>&nbsp;<span class="ident" id="3215957">Value</span><span class="op" id="3215962">(</span><span class="op" id="3215963">)</span>&nbsp;<span class="op" id="3215965">(</span><span class="ident" id="3215966">driver</span><span class="op" id="3215972">.</span><span class="ident" id="3215973">Value</span><span class="op" id="3215978">,</span>&nbsp;<span class="builtintype" id="3215980">error</span><span class="op" id="3215985">)</span>&nbsp;<span class="op" id="3215987">{</span><br>
<span class="lineno">90</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3215990">if</span>&nbsp;<span class="op" id="3215993">!</span><span class="ident" id="3215994">ns</span><span class="op" id="3215996">.</span><span class="ident" id="3215997">Valid</span>&nbsp;<span class="op" id="3216003">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3216007">return</span>&nbsp;<span class="ident" id="3216014">nil</span><span class="op" id="3216017">,</span>&nbsp;<span class="ident" id="3216019">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3216024">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3216027">return</span>&nbsp;<span class="ident" id="3216034">ns</span><span class="op" id="3216036">.</span><span class="ident" id="3216037">String</span><span class="op" id="3216043">,</span>&nbsp;<span class="ident" id="3216045">nil</span><br>
<span class="lineno"></span><span class="op" id="3216049">}</span><br>
<span class="lineno">95</span><br>
<span class="lineno"></span><span class="comment" id="3216052">//&nbsp;NullInt64&nbsp;represents&nbsp;an&nbsp;int64&nbsp;that&nbsp;may&nbsp;be&nbsp;null.</span><br>
<span class="lineno"></span><span class="comment" id="3216103">//&nbsp;NullInt64&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface&nbsp;so</span><br>
<span class="lineno"></span><span class="comment" id="3216152">//&nbsp;it&nbsp;can&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;scan&nbsp;destination,&nbsp;similar&nbsp;to&nbsp;NullString.</span><br>
<span class="lineno"></span><span class="keyword" id="3216216">type</span>&nbsp;<span class="ident" id="3216221">NullInt64</span>&nbsp;<span class="keyword" id="3216231">struct</span>&nbsp;<span class="op" id="3216238">{</span><br>
<span class="lineno">100</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3216241">Int64</span>&nbsp;<span class="ident" id="3216247">int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3216254">Valid</span>&nbsp;<span class="builtintype" id="3216260">bool</span>&nbsp;<span class="comment" id="3216265">//&nbsp;Valid&nbsp;is&nbsp;true&nbsp;if&nbsp;Int64&nbsp;is&nbsp;not&nbsp;NULL</span><br>
<span class="lineno"></span><span class="op" id="3216303">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3216306">//&nbsp;Scan&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface.</span><br>
<span class="lineno">105</span><span class="keyword" id="3216348">func</span>&nbsp;<span class="op" id="3216353">(</span><span class="ident" id="3216354">n</span>&nbsp;<span class="op" id="3216356">*</span><span class="ident" id="3216357">NullInt64</span><span class="op" id="3216366">)</span>&nbsp;<span class="ident" id="3216368">Scan</span><span class="op" id="3216372">(</span><span class="ident" id="3216373">value</span>&nbsp;<span class="keyword" id="3216379">interface</span><span class="op" id="3216388">{</span><span class="op" id="3216389">}</span><span class="op" id="3216390">)</span>&nbsp;<span class="builtintype" id="3216392">error</span>&nbsp;<span class="op" id="3216398">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3216401">if</span>&nbsp;<span class="ident" id="3216404">value</span>&nbsp;<span class="op" id="3216410">==</span>&nbsp;<span class="ident" id="3216413">nil</span>&nbsp;<span class="op" id="3216417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3216421">n</span><span class="op" id="3216422">.</span><span class="ident" id="3216423">Int64</span><span class="op" id="3216428">,</span>&nbsp;<span class="ident" id="3216430">n</span><span class="op" id="3216431">.</span><span class="ident" id="3216432">Valid</span>&nbsp;<span class="op" id="3216438">=</span>&nbsp;<span class="num" id="3216440">0</span><span class="op" id="3216441">,</span>&nbsp;<span class="builtintype" id="3216443">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3216451">return</span>&nbsp;<span class="ident" id="3216458">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3216463">}</span><br>
<span class="lineno">110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3216466">n</span><span class="op" id="3216467">.</span><span class="ident" id="3216468">Valid</span>&nbsp;<span class="op" id="3216474">=</span>&nbsp;<span class="builtintype" id="3216476">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3216482">return</span>&nbsp;<span class="ident" id="3216489">convertAssign</span><span class="op" id="3216502">(</span><span class="op" id="3216503">&amp;</span><span class="ident" id="3216504">n</span><span class="op" id="3216505">.</span><span class="ident" id="3216506">Int64</span><span class="op" id="3216511">,</span>&nbsp;<span class="ident" id="3216513">value</span><span class="op" id="3216518">)</span><br>
<span class="lineno"></span><span class="op" id="3216520">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3216523">//&nbsp;Value&nbsp;implements&nbsp;the&nbsp;driver&nbsp;Valuer&nbsp;interface.</span><br>
<span class="lineno">115</span><span class="keyword" id="3216572">func</span>&nbsp;<span class="op" id="3216577">(</span><span class="ident" id="3216578">n</span>&nbsp;<span class="ident" id="3216580">NullInt64</span><span class="op" id="3216589">)</span>&nbsp;<span class="ident" id="3216591">Value</span><span class="op" id="3216596">(</span><span class="op" id="3216597">)</span>&nbsp;<span class="op" id="3216599">(</span><span class="ident" id="3216600">driver</span><span class="op" id="3216606">.</span><span class="ident" id="3216607">Value</span><span class="op" id="3216612">,</span>&nbsp;<span class="builtintype" id="3216614">error</span><span class="op" id="3216619">)</span>&nbsp;<span class="op" id="3216621">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3216624">if</span>&nbsp;<span class="op" id="3216627">!</span><span class="ident" id="3216628">n</span><span class="op" id="3216629">.</span><span class="ident" id="3216630">Valid</span>&nbsp;<span class="op" id="3216636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3216640">return</span>&nbsp;<span class="ident" id="3216647">nil</span><span class="op" id="3216650">,</span>&nbsp;<span class="ident" id="3216652">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3216657">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3216660">return</span>&nbsp;<span class="ident" id="3216667">n</span><span class="op" id="3216668">.</span><span class="ident" id="3216669">Int64</span><span class="op" id="3216674">,</span>&nbsp;<span class="ident" id="3216676">nil</span><br>
<span class="lineno">120</span><span class="op" id="3216680">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3216683">//&nbsp;NullFloat64&nbsp;represents&nbsp;a&nbsp;float64&nbsp;that&nbsp;may&nbsp;be&nbsp;null.</span><br>
<span class="lineno"></span><span class="comment" id="3216737">//&nbsp;NullFloat64&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface&nbsp;so</span><br>
<span class="lineno"></span><span class="comment" id="3216788">//&nbsp;it&nbsp;can&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;scan&nbsp;destination,&nbsp;similar&nbsp;to&nbsp;NullString.</span><br>
<span class="lineno">125</span><span class="keyword" id="3216852">type</span>&nbsp;<span class="ident" id="3216857">NullFloat64</span>&nbsp;<span class="keyword" id="3216869">struct</span>&nbsp;<span class="op" id="3216876">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3216879">Float64</span>&nbsp;<span class="builtintype" id="3216887">float64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3216896">Valid</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3216904">bool</span>&nbsp;<span class="comment" id="3216909">//&nbsp;Valid&nbsp;is&nbsp;true&nbsp;if&nbsp;Float64&nbsp;is&nbsp;not&nbsp;NULL</span><br>
<span class="lineno"></span><span class="op" id="3216949">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">130</span><span class="comment" id="3216952">//&nbsp;Scan&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="3216994">func</span>&nbsp;<span class="op" id="3216999">(</span><span class="ident" id="3217000">n</span>&nbsp;<span class="op" id="3217002">*</span><span class="ident" id="3217003">NullFloat64</span><span class="op" id="3217014">)</span>&nbsp;<span class="ident" id="3217016">Scan</span><span class="op" id="3217020">(</span><span class="ident" id="3217021">value</span>&nbsp;<span class="keyword" id="3217027">interface</span><span class="op" id="3217036">{</span><span class="op" id="3217037">}</span><span class="op" id="3217038">)</span>&nbsp;<span class="builtintype" id="3217040">error</span>&nbsp;<span class="op" id="3217046">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3217049">if</span>&nbsp;<span class="ident" id="3217052">value</span>&nbsp;<span class="op" id="3217058">==</span>&nbsp;<span class="ident" id="3217061">nil</span>&nbsp;<span class="op" id="3217065">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3217069">n</span><span class="op" id="3217070">.</span><span class="ident" id="3217071">Float64</span><span class="op" id="3217078">,</span>&nbsp;<span class="ident" id="3217080">n</span><span class="op" id="3217081">.</span><span class="ident" id="3217082">Valid</span>&nbsp;<span class="op" id="3217088">=</span>&nbsp;<span class="num" id="3217090">0</span><span class="op" id="3217091">,</span>&nbsp;<span class="builtintype" id="3217093">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3217101">return</span>&nbsp;<span class="ident" id="3217108">nil</span><br>
<span class="lineno">135</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3217113">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3217116">n</span><span class="op" id="3217117">.</span><span class="ident" id="3217118">Valid</span>&nbsp;<span class="op" id="3217124">=</span>&nbsp;<span class="builtintype" id="3217126">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3217132">return</span>&nbsp;<span class="ident" id="3217139">convertAssign</span><span class="op" id="3217152">(</span><span class="op" id="3217153">&amp;</span><span class="ident" id="3217154">n</span><span class="op" id="3217155">.</span><span class="ident" id="3217156">Float64</span><span class="op" id="3217163">,</span>&nbsp;<span class="ident" id="3217165">value</span><span class="op" id="3217170">)</span><br>
<span class="lineno"></span><span class="op" id="3217172">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">140</span><span class="comment" id="3217175">//&nbsp;Value&nbsp;implements&nbsp;the&nbsp;driver&nbsp;Valuer&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="3217224">func</span>&nbsp;<span class="op" id="3217229">(</span><span class="ident" id="3217230">n</span>&nbsp;<span class="ident" id="3217232">NullFloat64</span><span class="op" id="3217243">)</span>&nbsp;<span class="ident" id="3217245">Value</span><span class="op" id="3217250">(</span><span class="op" id="3217251">)</span>&nbsp;<span class="op" id="3217253">(</span><span class="ident" id="3217254">driver</span><span class="op" id="3217260">.</span><span class="ident" id="3217261">Value</span><span class="op" id="3217266">,</span>&nbsp;<span class="builtintype" id="3217268">error</span><span class="op" id="3217273">)</span>&nbsp;<span class="op" id="3217275">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3217278">if</span>&nbsp;<span class="op" id="3217281">!</span><span class="ident" id="3217282">n</span><span class="op" id="3217283">.</span><span class="ident" id="3217284">Valid</span>&nbsp;<span class="op" id="3217290">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3217294">return</span>&nbsp;<span class="ident" id="3217301">nil</span><span class="op" id="3217304">,</span>&nbsp;<span class="ident" id="3217306">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3217311">}</span><br>
<span class="lineno">145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3217314">return</span>&nbsp;<span class="ident" id="3217321">n</span><span class="op" id="3217322">.</span><span class="ident" id="3217323">Float64</span><span class="op" id="3217330">,</span>&nbsp;<span class="ident" id="3217332">nil</span><br>
<span class="lineno"></span><span class="op" id="3217336">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3217339">//&nbsp;NullBool&nbsp;represents&nbsp;a&nbsp;bool&nbsp;that&nbsp;may&nbsp;be&nbsp;null.</span><br>
<span class="lineno"></span><span class="comment" id="3217387">//&nbsp;NullBool&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface&nbsp;so</span><br>
<span class="lineno">150</span><span class="comment" id="3217435">//&nbsp;it&nbsp;can&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;scan&nbsp;destination,&nbsp;similar&nbsp;to&nbsp;NullString.</span><br>
<span class="lineno"></span><span class="keyword" id="3217499">type</span>&nbsp;<span class="ident" id="3217504">NullBool</span>&nbsp;<span class="keyword" id="3217513">struct</span>&nbsp;<span class="op" id="3217520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3217523">Bool</span>&nbsp;&nbsp;<span class="builtintype" id="3217529">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3217535">Valid</span>&nbsp;<span class="builtintype" id="3217541">bool</span>&nbsp;<span class="comment" id="3217546">//&nbsp;Valid&nbsp;is&nbsp;true&nbsp;if&nbsp;Bool&nbsp;is&nbsp;not&nbsp;NULL</span><br>
<span class="lineno"></span><span class="op" id="3217583">}</span><br>
<span class="lineno">155</span><br>
<span class="lineno"></span><span class="comment" id="3217586">//&nbsp;Scan&nbsp;implements&nbsp;the&nbsp;Scanner&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="3217628">func</span>&nbsp;<span class="op" id="3217633">(</span><span class="ident" id="3217634">n</span>&nbsp;<span class="op" id="3217636">*</span><span class="ident" id="3217637">NullBool</span><span class="op" id="3217645">)</span>&nbsp;<span class="ident" id="3217647">Scan</span><span class="op" id="3217651">(</span><span class="ident" id="3217652">value</span>&nbsp;<span class="keyword" id="3217658">interface</span><span class="op" id="3217667">{</span><span class="op" id="3217668">}</span><span class="op" id="3217669">)</span>&nbsp;<span class="builtintype" id="3217671">error</span>&nbsp;<span class="op" id="3217677">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3217680">if</span>&nbsp;<span class="ident" id="3217683">value</span>&nbsp;<span class="op" id="3217689">==</span>&nbsp;<span class="ident" id="3217692">nil</span>&nbsp;<span class="op" id="3217696">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3217700">n</span><span class="op" id="3217701">.</span><span class="ident" id="3217702">Bool</span><span class="op" id="3217706">,</span>&nbsp;<span class="ident" id="3217708">n</span><span class="op" id="3217709">.</span><span class="ident" id="3217710">Valid</span>&nbsp;<span class="op" id="3217716">=</span>&nbsp;<span class="builtintype" id="3217718">false</span><span class="op" id="3217723">,</span>&nbsp;<span class="builtintype" id="3217725">false</span><br>
<span class="lineno">160</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3217733">return</span>&nbsp;<span class="ident" id="3217740">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3217745">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3217748">n</span><span class="op" id="3217749">.</span><span class="ident" id="3217750">Valid</span>&nbsp;<span class="op" id="3217756">=</span>&nbsp;<span class="builtintype" id="3217758">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3217764">return</span>&nbsp;<span class="ident" id="3217771">convertAssign</span><span class="op" id="3217784">(</span><span class="op" id="3217785">&amp;</span><span class="ident" id="3217786">n</span><span class="op" id="3217787">.</span><span class="ident" id="3217788">Bool</span><span class="op" id="3217792">,</span>&nbsp;<span class="ident" id="3217794">value</span><span class="op" id="3217799">)</span><br>
<span class="lineno"></span><span class="op" id="3217801">}</span><br>
<span class="lineno">165</span><br>
<span class="lineno"></span><span class="comment" id="3217804">//&nbsp;Value&nbsp;implements&nbsp;the&nbsp;driver&nbsp;Valuer&nbsp;interface.</span><br>
<span class="lineno"></span><span class="keyword" id="3217853">func</span>&nbsp;<span class="op" id="3217858">(</span><span class="ident" id="3217859">n</span>&nbsp;<span class="ident" id="3217861">NullBool</span><span class="op" id="3217869">)</span>&nbsp;<span class="ident" id="3217871">Value</span><span class="op" id="3217876">(</span><span class="op" id="3217877">)</span>&nbsp;<span class="op" id="3217879">(</span><span class="ident" id="3217880">driver</span><span class="op" id="3217886">.</span><span class="ident" id="3217887">Value</span><span class="op" id="3217892">,</span>&nbsp;<span class="builtintype" id="3217894">error</span><span class="op" id="3217899">)</span>&nbsp;<span class="op" id="3217901">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3217904">if</span>&nbsp;<span class="op" id="3217907">!</span><span class="ident" id="3217908">n</span><span class="op" id="3217909">.</span><span class="ident" id="3217910">Valid</span>&nbsp;<span class="op" id="3217916">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3217920">return</span>&nbsp;<span class="ident" id="3217927">nil</span><span class="op" id="3217930">,</span>&nbsp;<span class="ident" id="3217932">nil</span><br>
<span class="lineno">170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3217937">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3217940">return</span>&nbsp;<span class="ident" id="3217947">n</span><span class="op" id="3217948">.</span><span class="ident" id="3217949">Bool</span><span class="op" id="3217953">,</span>&nbsp;<span class="ident" id="3217955">nil</span><br>
<span class="lineno"></span><span class="op" id="3217959">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3217962">//&nbsp;Scanner&nbsp;is&nbsp;an&nbsp;interface&nbsp;used&nbsp;by&nbsp;Scan.</span><br>
<span class="lineno">175</span><span class="keyword" id="3218003">type</span>&nbsp;<span class="ident" id="3218008">Scanner</span>&nbsp;<span class="keyword" id="3218016">interface</span>&nbsp;<span class="op" id="3218026">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3218029">//&nbsp;Scan&nbsp;assigns&nbsp;a&nbsp;value&nbsp;from&nbsp;a&nbsp;database&nbsp;driver.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3218078">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3218082">//&nbsp;The&nbsp;src&nbsp;value&nbsp;will&nbsp;be&nbsp;of&nbsp;one&nbsp;of&nbsp;the&nbsp;following&nbsp;restricted</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3218143">//&nbsp;set&nbsp;of&nbsp;types:</span><br>
<span class="lineno">180</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3218161">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3218165">//&nbsp;&nbsp;&nbsp;&nbsp;int64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3218178">//&nbsp;&nbsp;&nbsp;&nbsp;float64</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3218193">//&nbsp;&nbsp;&nbsp;&nbsp;bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3218205">//&nbsp;&nbsp;&nbsp;&nbsp;[]byte</span><br>
<span class="lineno">185</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3218219">//&nbsp;&nbsp;&nbsp;&nbsp;string</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3218233">//&nbsp;&nbsp;&nbsp;&nbsp;time.Time</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3218250">//&nbsp;&nbsp;&nbsp;&nbsp;nil&nbsp;-&nbsp;for&nbsp;NULL&nbsp;values</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3218279">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3218283">//&nbsp;An&nbsp;error&nbsp;should&nbsp;be&nbsp;returned&nbsp;if&nbsp;the&nbsp;value&nbsp;can&nbsp;not&nbsp;be&nbsp;stored</span><br>
<span class="lineno">190</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3218346">//&nbsp;without&nbsp;loss&nbsp;of&nbsp;information.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3218379">Scan</span><span class="op" id="3218383">(</span><span class="ident" id="3218384">src</span>&nbsp;<span class="keyword" id="3218388">interface</span><span class="op" id="3218397">{</span><span class="op" id="3218398">}</span><span class="op" id="3218399">)</span>&nbsp;<span class="builtintype" id="3218401">error</span><br>
<span class="lineno"></span><span class="op" id="3218407">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3218410">//&nbsp;ErrNoRows&nbsp;is&nbsp;returned&nbsp;by&nbsp;Scan&nbsp;when&nbsp;QueryRow&nbsp;doesn&#39;t&nbsp;return&nbsp;a</span><br>
<span class="lineno">195</span><span class="comment" id="3218474">//&nbsp;row.&nbsp;In&nbsp;such&nbsp;a&nbsp;case,&nbsp;QueryRow&nbsp;returns&nbsp;a&nbsp;placeholder&nbsp;*Row&nbsp;value&nbsp;that</span><br>
<span class="lineno"></span><span class="comment" id="3218545">//&nbsp;defers&nbsp;this&nbsp;error&nbsp;until&nbsp;a&nbsp;Scan.</span><br>
<span class="lineno"></span><span class="keyword" id="3218580">var</span>&nbsp;<span class="ident" id="3218584">ErrNoRows</span>&nbsp;<span class="op" id="3218594">=</span>&nbsp;<span class="ident" id="3218596">errors</span><span class="op" id="3218602">.</span><span class="ident" id="3218603">New</span><span class="op" id="3218606">(</span><span class="string" id="3218607">&#34;sql:&nbsp;no&nbsp;rows&nbsp;in&nbsp;result&nbsp;set&#34;</span><span class="op" id="3218635">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3218638">//&nbsp;DB&nbsp;is&nbsp;a&nbsp;database&nbsp;handle&nbsp;representing&nbsp;a&nbsp;pool&nbsp;of&nbsp;zero&nbsp;or&nbsp;more</span><br>
<span class="lineno">200</span><span class="comment" id="3218701">//&nbsp;underlying&nbsp;connections.&nbsp;It&#39;s&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple</span><br>
<span class="lineno"></span><span class="comment" id="3218769">//&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="comment" id="3218784">//</span><br>
<span class="lineno"></span><span class="comment" id="3218787">//&nbsp;The&nbsp;sql&nbsp;package&nbsp;creates&nbsp;and&nbsp;frees&nbsp;connections&nbsp;automatically;&nbsp;it</span><br>
<span class="lineno"></span><span class="comment" id="3218854">//&nbsp;also&nbsp;maintains&nbsp;a&nbsp;free&nbsp;pool&nbsp;of&nbsp;idle&nbsp;connections.&nbsp;If&nbsp;the&nbsp;database&nbsp;has</span><br>
<span class="lineno">205</span><span class="comment" id="3218925">//&nbsp;a&nbsp;concept&nbsp;of&nbsp;per-connection&nbsp;state,&nbsp;such&nbsp;state&nbsp;can&nbsp;only&nbsp;be&nbsp;reliably</span><br>
<span class="lineno"></span><span class="comment" id="3218995">//&nbsp;observed&nbsp;within&nbsp;a&nbsp;transaction.&nbsp;Once&nbsp;DB.Begin&nbsp;is&nbsp;called,&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3219058">//&nbsp;returned&nbsp;Tx&nbsp;is&nbsp;bound&nbsp;to&nbsp;a&nbsp;single&nbsp;connection.&nbsp;Once&nbsp;Commit&nbsp;or</span><br>
<span class="lineno"></span><span class="comment" id="3219121">//&nbsp;Rollback&nbsp;is&nbsp;called&nbsp;on&nbsp;the&nbsp;transaction,&nbsp;that&nbsp;transaction&#39;s</span><br>
<span class="lineno"></span><span class="comment" id="3219182">//&nbsp;connection&nbsp;is&nbsp;returned&nbsp;to&nbsp;DB&#39;s&nbsp;idle&nbsp;connection&nbsp;pool.&nbsp;The&nbsp;pool&nbsp;size</span><br>
<span class="lineno">210</span><span class="comment" id="3219252">//&nbsp;can&nbsp;be&nbsp;controlled&nbsp;with&nbsp;SetMaxIdleConns.</span><br>
<span class="lineno"></span><span class="keyword" id="3219295">type</span>&nbsp;<span class="ident" id="3219300">DB</span>&nbsp;<span class="keyword" id="3219303">struct</span>&nbsp;<span class="op" id="3219310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3219313">driver</span>&nbsp;<span class="ident" id="3219320">driver</span><span class="op" id="3219326">.</span><span class="ident" id="3219327">Driver</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3219335">dsn</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3219342">string</span><br>
<span class="lineno"></span><br>
<span class="lineno">215</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3219351">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3219364">sync</span><span class="op" id="3219368">.</span><span class="ident" id="3219369">Mutex</span>&nbsp;<span class="comment" id="3219375">//&nbsp;protects&nbsp;following&nbsp;fields</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3219405">freeConn</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3219418">[</span><span class="op" id="3219419">]</span><span class="op" id="3219420">*</span><span class="ident" id="3219421">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3219433">connRequests</span>&nbsp;<span class="op" id="3219446">[</span><span class="op" id="3219447">]</span><span class="keyword" id="3219448">chan</span>&nbsp;<span class="ident" id="3219453">connRequest</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3219466">numOpen</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3219479">int</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3219484">pendingOpens</span>&nbsp;<span class="builtintype" id="3219497">int</span><br>
<span class="lineno">220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3219502">//&nbsp;Used&nbsp;to&nbsp;signal&nbsp;the&nbsp;need&nbsp;for&nbsp;new&nbsp;connections</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3219550">//&nbsp;a&nbsp;goroutine&nbsp;running&nbsp;connectionOpener()&nbsp;reads&nbsp;on&nbsp;this&nbsp;chan&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3219616">//&nbsp;maybeOpenNewConnections&nbsp;sends&nbsp;on&nbsp;the&nbsp;chan&nbsp;(one&nbsp;send&nbsp;per&nbsp;needed&nbsp;connection)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3219695">//&nbsp;It&nbsp;is&nbsp;closed&nbsp;during&nbsp;db.Close().&nbsp;The&nbsp;close&nbsp;tells&nbsp;the&nbsp;connectionOpener</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3219768">//&nbsp;goroutine&nbsp;to&nbsp;exit.</span><br>
<span class="lineno">225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3219791">openerCh</span>&nbsp;<span class="keyword" id="3219800">chan</span>&nbsp;<span class="keyword" id="3219805">struct</span><span class="op" id="3219811">{</span><span class="op" id="3219812">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3219815">closed</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3219824">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3219830">dep</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3219839">map</span><span class="op" id="3219842">[</span><span class="ident" id="3219843">finalCloser</span><span class="op" id="3219854">]</span><span class="ident" id="3219855">depSet</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3219863">lastPut</span>&nbsp;&nbsp;<span class="keyword" id="3219872">map</span><span class="op" id="3219875">[</span><span class="op" id="3219876">*</span><span class="ident" id="3219877">driverConn</span><span class="op" id="3219887">]</span><span class="builtintype" id="3219888">string</span>&nbsp;<span class="comment" id="3219895">//&nbsp;stacktrace&nbsp;of&nbsp;last&nbsp;conn&#39;s&nbsp;put;&nbsp;debug&nbsp;only</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3219941">maxIdle</span>&nbsp;&nbsp;<span class="builtintype" id="3219950">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3219973">//&nbsp;zero&nbsp;means&nbsp;defaultMaxIdleConns;&nbsp;negative&nbsp;means&nbsp;0</span><br>
<span class="lineno">230</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3220026">maxOpen</span>&nbsp;&nbsp;<span class="builtintype" id="3220035">int</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3220058">//&nbsp;&lt;=&nbsp;0&nbsp;means&nbsp;unlimited</span><br>
<span class="lineno"></span><span class="op" id="3220082">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3220085">//&nbsp;driverConn&nbsp;wraps&nbsp;a&nbsp;driver.Conn&nbsp;with&nbsp;a&nbsp;mutex,&nbsp;to</span><br>
<span class="lineno"></span><span class="comment" id="3220136">//&nbsp;be&nbsp;held&nbsp;during&nbsp;all&nbsp;calls&nbsp;into&nbsp;the&nbsp;Conn.&nbsp;(including&nbsp;any&nbsp;calls&nbsp;onto</span><br>
<span class="lineno">235</span><span class="comment" id="3220205">//&nbsp;interfaces&nbsp;returned&nbsp;via&nbsp;that&nbsp;Conn,&nbsp;such&nbsp;as&nbsp;calls&nbsp;on&nbsp;Tx,&nbsp;Stmt,</span><br>
<span class="lineno"></span><span class="comment" id="3220270">//&nbsp;Result,&nbsp;Rows)</span><br>
<span class="lineno"></span><span class="keyword" id="3220287">type</span>&nbsp;<span class="ident" id="3220292">driverConn</span>&nbsp;<span class="keyword" id="3220303">struct</span>&nbsp;<span class="op" id="3220310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3220313">db</span>&nbsp;<span class="op" id="3220316">*</span><span class="ident" id="3220317">DB</span><br>
<span class="lineno"></span><br>
<span class="lineno">240</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3220322">sync</span><span class="op" id="3220326">.</span><span class="ident" id="3220327">Mutex</span>&nbsp;&nbsp;<span class="comment" id="3220334">//&nbsp;guards&nbsp;following</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3220355">ci</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3220367">driver</span><span class="op" id="3220373">.</span><span class="ident" id="3220374">Conn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3220380">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3220392">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3220398">finalClosed</span>&nbsp;<span class="builtintype" id="3220410">bool</span>&nbsp;<span class="comment" id="3220415">//&nbsp;ci.Close&nbsp;has&nbsp;been&nbsp;called</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3220444">openStmt</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword" id="3220456">map</span><span class="op" id="3220459">[</span><span class="ident" id="3220460">driver</span><span class="op" id="3220466">.</span><span class="ident" id="3220467">Stmt</span><span class="op" id="3220471">]</span><span class="builtintype" id="3220472">bool</span><br>
<span class="lineno">245</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3220479">//&nbsp;guarded&nbsp;by&nbsp;db.mu</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3220500">inUse</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3220511">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3220517">onPut</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3220528">[</span><span class="op" id="3220529">]</span><span class="keyword" id="3220530">func</span><span class="op" id="3220534">(</span><span class="op" id="3220535">)</span>&nbsp;<span class="comment" id="3220537">//&nbsp;code&nbsp;(with&nbsp;db.mu&nbsp;held)&nbsp;run&nbsp;when&nbsp;conn&nbsp;is&nbsp;next&nbsp;returned</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3220595">dbmuClosed</span>&nbsp;<span class="builtintype" id="3220606">bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3220615">//&nbsp;same&nbsp;as&nbsp;closed,&nbsp;but&nbsp;guarded&nbsp;by&nbsp;db.mu,&nbsp;for&nbsp;connIfFree</span><br>
<span class="lineno">250</span><span class="op" id="3220671">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3220674">func</span>&nbsp;<span class="op" id="3220679">(</span><span class="ident" id="3220680">dc</span>&nbsp;<span class="op" id="3220683">*</span><span class="ident" id="3220684">driverConn</span><span class="op" id="3220694">)</span>&nbsp;<span class="ident" id="3220696">releaseConn</span><span class="op" id="3220707">(</span><span class="ident" id="3220708">err</span>&nbsp;<span class="builtintype" id="3220712">error</span><span class="op" id="3220717">)</span>&nbsp;<span class="op" id="3220719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3220722">dc</span><span class="op" id="3220724">.</span><span class="ident" id="3220725">db</span><span class="op" id="3220727">.</span><span class="ident" id="3220728">putConn</span><span class="op" id="3220735">(</span><span class="ident" id="3220736">dc</span><span class="op" id="3220738">,</span>&nbsp;<span class="ident" id="3220740">err</span><span class="op" id="3220743">)</span><br>
<span class="lineno"></span><span class="op" id="3220745">}</span><br>
<span class="lineno">255</span><br>
<span class="lineno"></span><span class="keyword" id="3220748">func</span>&nbsp;<span class="op" id="3220753">(</span><span class="ident" id="3220754">dc</span>&nbsp;<span class="op" id="3220757">*</span><span class="ident" id="3220758">driverConn</span><span class="op" id="3220768">)</span>&nbsp;<span class="ident" id="3220770">removeOpenStmt</span><span class="op" id="3220784">(</span><span class="ident" id="3220785">si</span>&nbsp;<span class="ident" id="3220788">driver</span><span class="op" id="3220794">.</span><span class="ident" id="3220795">Stmt</span><span class="op" id="3220799">)</span>&nbsp;<span class="op" id="3220801">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3220804">dc</span><span class="op" id="3220806">.</span><span class="ident" id="3220807">Lock</span><span class="op" id="3220811">(</span><span class="op" id="3220812">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3220815">defer</span>&nbsp;<span class="ident" id="3220821">dc</span><span class="op" id="3220823">.</span><span class="ident" id="3220824">Unlock</span><span class="op" id="3220830">(</span><span class="op" id="3220831">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3220834">delete</span><span class="op" id="3220840">(</span><span class="ident" id="3220841">dc</span><span class="op" id="3220843">.</span><span class="ident" id="3220844">openStmt</span><span class="op" id="3220852">,</span>&nbsp;<span class="ident" id="3220854">si</span><span class="op" id="3220856">)</span><br>
<span class="lineno">260</span><span class="op" id="3220858">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3220861">func</span>&nbsp;<span class="op" id="3220866">(</span><span class="ident" id="3220867">dc</span>&nbsp;<span class="op" id="3220870">*</span><span class="ident" id="3220871">driverConn</span><span class="op" id="3220881">)</span>&nbsp;<span class="ident" id="3220883">prepareLocked</span><span class="op" id="3220896">(</span><span class="ident" id="3220897">query</span>&nbsp;<span class="builtintype" id="3220903">string</span><span class="op" id="3220909">)</span>&nbsp;<span class="op" id="3220911">(</span><span class="ident" id="3220912">driver</span><span class="op" id="3220918">.</span><span class="ident" id="3220919">Stmt</span><span class="op" id="3220923">,</span>&nbsp;<span class="builtintype" id="3220925">error</span><span class="op" id="3220930">)</span>&nbsp;<span class="op" id="3220932">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3220935">si</span><span class="op" id="3220937">,</span>&nbsp;<span class="ident" id="3220939">err</span>&nbsp;<span class="op" id="3220943">:=</span>&nbsp;<span class="ident" id="3220946">dc</span><span class="op" id="3220948">.</span><span class="ident" id="3220949">ci</span><span class="op" id="3220951">.</span><span class="ident" id="3220952">Prepare</span><span class="op" id="3220959">(</span><span class="ident" id="3220960">query</span><span class="op" id="3220965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3220968">if</span>&nbsp;<span class="ident" id="3220971">err</span>&nbsp;<span class="op" id="3220975">==</span>&nbsp;<span class="ident" id="3220978">nil</span>&nbsp;<span class="op" id="3220982">{</span><br>
<span class="lineno">265</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3220986">//&nbsp;Track&nbsp;each&nbsp;driverConn&#39;s&nbsp;open&nbsp;statements,&nbsp;so&nbsp;we&nbsp;can&nbsp;close&nbsp;them</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3221053">//&nbsp;before&nbsp;closing&nbsp;the&nbsp;conn.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3221083">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3221088">//&nbsp;TODO(bradfitz):&nbsp;let&nbsp;drivers&nbsp;opt&nbsp;out&nbsp;of&nbsp;caring&nbsp;about</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3221145">//&nbsp;stmt&nbsp;closes&nbsp;if&nbsp;the&nbsp;conn&nbsp;is&nbsp;about&nbsp;to&nbsp;close&nbsp;anyway?&nbsp;For&nbsp;now</span><br>
<span class="lineno">270</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3221208">//&nbsp;do&nbsp;the&nbsp;safe&nbsp;thing,&nbsp;in&nbsp;case&nbsp;stmts&nbsp;need&nbsp;to&nbsp;be&nbsp;closed.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3221265">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3221270">//&nbsp;TODO(bradfitz):&nbsp;after&nbsp;Go&nbsp;1.2,&nbsp;closing&nbsp;driver.Stmts</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3221326">//&nbsp;should&nbsp;be&nbsp;moved&nbsp;to&nbsp;driverStmt,&nbsp;using&nbsp;unique</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3221375">//&nbsp;*driverStmts&nbsp;everywhere&nbsp;(including&nbsp;from</span><br>
<span class="lineno">275</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3221420">//&nbsp;*Stmt.connStmt,&nbsp;instead&nbsp;of&nbsp;returning&nbsp;a</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3221464">//&nbsp;driver.Stmt),&nbsp;using&nbsp;driverStmt&nbsp;as&nbsp;a&nbsp;pointer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3221513">//&nbsp;everywhere,&nbsp;and&nbsp;making&nbsp;it&nbsp;a&nbsp;finalCloser.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3221559">if</span>&nbsp;<span class="ident" id="3221562">dc</span><span class="op" id="3221564">.</span><span class="ident" id="3221565">openStmt</span>&nbsp;<span class="op" id="3221574">==</span>&nbsp;<span class="ident" id="3221577">nil</span>&nbsp;<span class="op" id="3221581">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3221586">dc</span><span class="op" id="3221588">.</span><span class="ident" id="3221589">openStmt</span>&nbsp;<span class="op" id="3221598">=</span>&nbsp;<span class="builtinfunc" id="3221600">make</span><span class="op" id="3221604">(</span><span class="keyword" id="3221605">map</span><span class="op" id="3221608">[</span><span class="ident" id="3221609">driver</span><span class="op" id="3221615">.</span><span class="ident" id="3221616">Stmt</span><span class="op" id="3221620">]</span><span class="builtintype" id="3221621">bool</span><span class="op" id="3221625">)</span><br>
<span class="lineno">280</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3221629">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3221633">dc</span><span class="op" id="3221635">.</span><span class="ident" id="3221636">openStmt</span><span class="op" id="3221644">[</span><span class="ident" id="3221645">si</span><span class="op" id="3221647">]</span>&nbsp;<span class="op" id="3221649">=</span>&nbsp;<span class="builtintype" id="3221651">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3221657">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3221660">return</span>&nbsp;<span class="ident" id="3221667">si</span><span class="op" id="3221669">,</span>&nbsp;<span class="ident" id="3221671">err</span><br>
<span class="lineno"></span><span class="op" id="3221675">}</span><br>
<span class="lineno">285</span><br>
<span class="lineno"></span><span class="comment" id="3221678">//&nbsp;the&nbsp;dc.db&#39;s&nbsp;Mutex&nbsp;is&nbsp;held.</span><br>
<span class="lineno"></span><span class="keyword" id="3221708">func</span>&nbsp;<span class="op" id="3221713">(</span><span class="ident" id="3221714">dc</span>&nbsp;<span class="op" id="3221717">*</span><span class="ident" id="3221718">driverConn</span><span class="op" id="3221728">)</span>&nbsp;<span class="ident" id="3221730">closeDBLocked</span><span class="op" id="3221743">(</span><span class="op" id="3221744">)</span>&nbsp;<span class="keyword" id="3221746">func</span><span class="op" id="3221750">(</span><span class="op" id="3221751">)</span>&nbsp;<span class="builtintype" id="3221753">error</span>&nbsp;<span class="op" id="3221759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3221762">dc</span><span class="op" id="3221764">.</span><span class="ident" id="3221765">Lock</span><span class="op" id="3221769">(</span><span class="op" id="3221770">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3221773">defer</span>&nbsp;<span class="ident" id="3221779">dc</span><span class="op" id="3221781">.</span><span class="ident" id="3221782">Unlock</span><span class="op" id="3221788">(</span><span class="op" id="3221789">)</span><br>
<span class="lineno">290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3221792">if</span>&nbsp;<span class="ident" id="3221795">dc</span><span class="op" id="3221797">.</span><span class="ident" id="3221798">closed</span>&nbsp;<span class="op" id="3221805">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3221809">return</span>&nbsp;<span class="keyword" id="3221816">func</span><span class="op" id="3221820">(</span><span class="op" id="3221821">)</span>&nbsp;<span class="builtintype" id="3221823">error</span>&nbsp;<span class="op" id="3221829">{</span>&nbsp;<span class="keyword" id="3221831">return</span>&nbsp;<span class="ident" id="3221838">errors</span><span class="op" id="3221844">.</span><span class="ident" id="3221845">New</span><span class="op" id="3221848">(</span><span class="string" id="3221849">&#34;sql:&nbsp;duplicate&nbsp;driverConn&nbsp;close&#34;</span><span class="op" id="3221882">)</span>&nbsp;<span class="op" id="3221884">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3221887">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3221890">dc</span><span class="op" id="3221892">.</span><span class="ident" id="3221893">closed</span>&nbsp;<span class="op" id="3221900">=</span>&nbsp;<span class="builtintype" id="3221902">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3221908">return</span>&nbsp;<span class="ident" id="3221915">dc</span><span class="op" id="3221917">.</span><span class="ident" id="3221918">db</span><span class="op" id="3221920">.</span><span class="ident" id="3221921">removeDepLocked</span><span class="op" id="3221936">(</span><span class="ident" id="3221937">dc</span><span class="op" id="3221939">,</span>&nbsp;<span class="ident" id="3221941">dc</span><span class="op" id="3221943">)</span><br>
<span class="lineno">295</span><span class="op" id="3221945">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3221948">func</span>&nbsp;<span class="op" id="3221953">(</span><span class="ident" id="3221954">dc</span>&nbsp;<span class="op" id="3221957">*</span><span class="ident" id="3221958">driverConn</span><span class="op" id="3221968">)</span>&nbsp;<span class="ident" id="3221970">Close</span><span class="op" id="3221975">(</span><span class="op" id="3221976">)</span>&nbsp;<span class="builtintype" id="3221978">error</span>&nbsp;<span class="op" id="3221984">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3221987">dc</span><span class="op" id="3221989">.</span><span class="ident" id="3221990">Lock</span><span class="op" id="3221994">(</span><span class="op" id="3221995">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3221998">if</span>&nbsp;<span class="ident" id="3222001">dc</span><span class="op" id="3222003">.</span><span class="ident" id="3222004">closed</span>&nbsp;<span class="op" id="3222011">{</span><br>
<span class="lineno">300</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3222015">dc</span><span class="op" id="3222017">.</span><span class="ident" id="3222018">Unlock</span><span class="op" id="3222024">(</span><span class="op" id="3222025">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3222029">return</span>&nbsp;<span class="ident" id="3222036">errors</span><span class="op" id="3222042">.</span><span class="ident" id="3222043">New</span><span class="op" id="3222046">(</span><span class="string" id="3222047">&#34;sql:&nbsp;duplicate&nbsp;driverConn&nbsp;close&#34;</span><span class="op" id="3222080">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3222083">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3222086">dc</span><span class="op" id="3222088">.</span><span class="ident" id="3222089">closed</span>&nbsp;<span class="op" id="3222096">=</span>&nbsp;<span class="builtintype" id="3222098">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3222104">dc</span><span class="op" id="3222106">.</span><span class="ident" id="3222107">Unlock</span><span class="op" id="3222113">(</span><span class="op" id="3222114">)</span>&nbsp;<span class="comment" id="3222116">//&nbsp;not&nbsp;defer;&nbsp;removeDep&nbsp;finalClose&nbsp;calls&nbsp;may&nbsp;need&nbsp;to&nbsp;lock</span><br>
<span class="lineno">305</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3222176">//&nbsp;And&nbsp;now&nbsp;updates&nbsp;that&nbsp;require&nbsp;holding&nbsp;dc.mu.Lock.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3222229">dc</span><span class="op" id="3222231">.</span><span class="ident" id="3222232">db</span><span class="op" id="3222234">.</span><span class="ident" id="3222235">mu</span><span class="op" id="3222237">.</span><span class="ident" id="3222238">Lock</span><span class="op" id="3222242">(</span><span class="op" id="3222243">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3222246">dc</span><span class="op" id="3222248">.</span><span class="ident" id="3222249">dbmuClosed</span>&nbsp;<span class="op" id="3222260">=</span>&nbsp;<span class="builtintype" id="3222262">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3222268">fn</span>&nbsp;<span class="op" id="3222271">:=</span>&nbsp;<span class="ident" id="3222274">dc</span><span class="op" id="3222276">.</span><span class="ident" id="3222277">db</span><span class="op" id="3222279">.</span><span class="ident" id="3222280">removeDepLocked</span><span class="op" id="3222295">(</span><span class="ident" id="3222296">dc</span><span class="op" id="3222298">,</span>&nbsp;<span class="ident" id="3222300">dc</span><span class="op" id="3222302">)</span><br>
<span class="lineno">310</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3222305">dc</span><span class="op" id="3222307">.</span><span class="ident" id="3222308">db</span><span class="op" id="3222310">.</span><span class="ident" id="3222311">mu</span><span class="op" id="3222313">.</span><span class="ident" id="3222314">Unlock</span><span class="op" id="3222320">(</span><span class="op" id="3222321">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3222324">return</span>&nbsp;<span class="ident" id="3222331">fn</span><span class="op" id="3222333">(</span><span class="op" id="3222334">)</span><br>
<span class="lineno"></span><span class="op" id="3222336">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3222339">func</span>&nbsp;<span class="op" id="3222344">(</span><span class="ident" id="3222345">dc</span>&nbsp;<span class="op" id="3222348">*</span><span class="ident" id="3222349">driverConn</span><span class="op" id="3222359">)</span>&nbsp;<span class="ident" id="3222361">finalClose</span><span class="op" id="3222371">(</span><span class="op" id="3222372">)</span>&nbsp;<span class="builtintype" id="3222374">error</span>&nbsp;<span class="op" id="3222380">{</span><br>
<span class="lineno">315</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3222383">dc</span><span class="op" id="3222385">.</span><span class="ident" id="3222386">Lock</span><span class="op" id="3222390">(</span><span class="op" id="3222391">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3222395">for</span>&nbsp;<span class="ident" id="3222399">si</span>&nbsp;<span class="op" id="3222402">:=</span>&nbsp;<span class="keyword" id="3222405">range</span>&nbsp;<span class="ident" id="3222411">dc</span><span class="op" id="3222413">.</span><span class="ident" id="3222414">openStmt</span>&nbsp;<span class="op" id="3222423">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3222427">si</span><span class="op" id="3222429">.</span><span class="ident" id="3222430">Close</span><span class="op" id="3222435">(</span><span class="op" id="3222436">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3222439">}</span><br>
<span class="lineno">320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3222442">dc</span><span class="op" id="3222444">.</span><span class="ident" id="3222445">openStmt</span>&nbsp;<span class="op" id="3222454">=</span>&nbsp;<span class="ident" id="3222456">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3222462">err</span>&nbsp;<span class="op" id="3222466">:=</span>&nbsp;<span class="ident" id="3222469">dc</span><span class="op" id="3222471">.</span><span class="ident" id="3222472">ci</span><span class="op" id="3222474">.</span><span class="ident" id="3222475">Close</span><span class="op" id="3222480">(</span><span class="op" id="3222481">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3222484">dc</span><span class="op" id="3222486">.</span><span class="ident" id="3222487">ci</span>&nbsp;<span class="op" id="3222490">=</span>&nbsp;<span class="ident" id="3222492">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3222497">dc</span><span class="op" id="3222499">.</span><span class="ident" id="3222500">finalClosed</span>&nbsp;<span class="op" id="3222512">=</span>&nbsp;<span class="builtintype" id="3222514">true</span><br>
<span class="lineno">325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3222520">dc</span><span class="op" id="3222522">.</span><span class="ident" id="3222523">Unlock</span><span class="op" id="3222529">(</span><span class="op" id="3222530">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3222534">dc</span><span class="op" id="3222536">.</span><span class="ident" id="3222537">db</span><span class="op" id="3222539">.</span><span class="ident" id="3222540">mu</span><span class="op" id="3222542">.</span><span class="ident" id="3222543">Lock</span><span class="op" id="3222547">(</span><span class="op" id="3222548">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3222551">dc</span><span class="op" id="3222553">.</span><span class="ident" id="3222554">db</span><span class="op" id="3222556">.</span><span class="ident" id="3222557">numOpen</span><span class="op" id="3222564">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3222568">dc</span><span class="op" id="3222570">.</span><span class="ident" id="3222571">db</span><span class="op" id="3222573">.</span><span class="ident" id="3222574">maybeOpenNewConnections</span><span class="op" id="3222597">(</span><span class="op" id="3222598">)</span><br>
<span class="lineno">330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3222601">dc</span><span class="op" id="3222603">.</span><span class="ident" id="3222604">db</span><span class="op" id="3222606">.</span><span class="ident" id="3222607">mu</span><span class="op" id="3222609">.</span><span class="ident" id="3222610">Unlock</span><span class="op" id="3222616">(</span><span class="op" id="3222617">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3222621">return</span>&nbsp;<span class="ident" id="3222628">err</span><br>
<span class="lineno"></span><span class="op" id="3222632">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">335</span><span class="comment" id="3222635">//&nbsp;driverStmt&nbsp;associates&nbsp;a&nbsp;driver.Stmt&nbsp;with&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3222683">//&nbsp;*driverConn&nbsp;from&nbsp;which&nbsp;it&nbsp;came,&nbsp;so&nbsp;the&nbsp;driverConn&#39;s&nbsp;lock&nbsp;can&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="3222750">//&nbsp;held&nbsp;during&nbsp;calls.</span><br>
<span class="lineno"></span><span class="keyword" id="3222772">type</span>&nbsp;<span class="ident" id="3222777">driverStmt</span>&nbsp;<span class="keyword" id="3222788">struct</span>&nbsp;<span class="op" id="3222795">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3222798">sync</span><span class="op" id="3222802">.</span><span class="ident" id="3222803">Locker</span>&nbsp;<span class="comment" id="3222810">//&nbsp;the&nbsp;*driverConn</span><br>
<span class="lineno">340</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3222830">si</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3222842">driver</span><span class="op" id="3222848">.</span><span class="ident" id="3222849">Stmt</span><br>
<span class="lineno"></span><span class="op" id="3222854">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3222857">func</span>&nbsp;<span class="op" id="3222862">(</span><span class="ident" id="3222863">ds</span>&nbsp;<span class="op" id="3222866">*</span><span class="ident" id="3222867">driverStmt</span><span class="op" id="3222877">)</span>&nbsp;<span class="ident" id="3222879">Close</span><span class="op" id="3222884">(</span><span class="op" id="3222885">)</span>&nbsp;<span class="builtintype" id="3222887">error</span>&nbsp;<span class="op" id="3222893">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3222896">ds</span><span class="op" id="3222898">.</span><span class="ident" id="3222899">Lock</span><span class="op" id="3222903">(</span><span class="op" id="3222904">)</span><br>
<span class="lineno">345</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3222907">defer</span>&nbsp;<span class="ident" id="3222913">ds</span><span class="op" id="3222915">.</span><span class="ident" id="3222916">Unlock</span><span class="op" id="3222922">(</span><span class="op" id="3222923">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3222926">return</span>&nbsp;<span class="ident" id="3222933">ds</span><span class="op" id="3222935">.</span><span class="ident" id="3222936">si</span><span class="op" id="3222938">.</span><span class="ident" id="3222939">Close</span><span class="op" id="3222944">(</span><span class="op" id="3222945">)</span><br>
<span class="lineno"></span><span class="op" id="3222947">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3222950">//&nbsp;depSet&nbsp;is&nbsp;a&nbsp;finalCloser&#39;s&nbsp;outstanding&nbsp;dependencies</span><br>
<span class="lineno">350</span><span class="keyword" id="3223004">type</span>&nbsp;<span class="ident" id="3223009">depSet</span>&nbsp;<span class="keyword" id="3223016">map</span><span class="op" id="3223019">[</span><span class="keyword" id="3223020">interface</span><span class="op" id="3223029">{</span><span class="op" id="3223030">}</span><span class="op" id="3223031">]</span><span class="builtintype" id="3223032">bool</span>&nbsp;<span class="comment" id="3223037">//&nbsp;set&nbsp;of&nbsp;true&nbsp;bools</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3223059">//&nbsp;The&nbsp;finalCloser&nbsp;interface&nbsp;is&nbsp;used&nbsp;by&nbsp;(*DB).addDep&nbsp;and&nbsp;related</span><br>
<span class="lineno"></span><span class="comment" id="3223124">//&nbsp;dependency&nbsp;reference&nbsp;counting.</span><br>
<span class="lineno"></span><span class="keyword" id="3223158">type</span>&nbsp;<span class="ident" id="3223163">finalCloser</span>&nbsp;<span class="keyword" id="3223175">interface</span>&nbsp;<span class="op" id="3223185">{</span><br>
<span class="lineno">355</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3223188">//&nbsp;finalClose&nbsp;is&nbsp;called&nbsp;when&nbsp;the&nbsp;reference&nbsp;count&nbsp;of&nbsp;an&nbsp;object</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3223251">//&nbsp;goes&nbsp;to&nbsp;zero.&nbsp;(*DB).mu&nbsp;is&nbsp;not&nbsp;held&nbsp;while&nbsp;calling&nbsp;it.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3223308">finalClose</span><span class="op" id="3223318">(</span><span class="op" id="3223319">)</span>&nbsp;<span class="builtintype" id="3223321">error</span><br>
<span class="lineno"></span><span class="op" id="3223327">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">360</span><span class="comment" id="3223330">//&nbsp;addDep&nbsp;notes&nbsp;that&nbsp;x&nbsp;now&nbsp;depends&nbsp;on&nbsp;dep,&nbsp;and&nbsp;x&#39;s&nbsp;finalClose&nbsp;won&#39;t&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="3223401">//&nbsp;called&nbsp;until&nbsp;all&nbsp;of&nbsp;x&#39;s&nbsp;dependencies&nbsp;are&nbsp;removed&nbsp;with&nbsp;removeDep.</span><br>
<span class="lineno"></span><span class="keyword" id="3223469">func</span>&nbsp;<span class="op" id="3223474">(</span><span class="ident" id="3223475">db</span>&nbsp;<span class="op" id="3223478">*</span><span class="ident" id="3223479">DB</span><span class="op" id="3223481">)</span>&nbsp;<span class="ident" id="3223483">addDep</span><span class="op" id="3223489">(</span><span class="ident" id="3223490">x</span>&nbsp;<span class="ident" id="3223492">finalCloser</span><span class="op" id="3223503">,</span>&nbsp;<span class="ident" id="3223505">dep</span>&nbsp;<span class="keyword" id="3223509">interface</span><span class="op" id="3223518">{</span><span class="op" id="3223519">}</span><span class="op" id="3223520">)</span>&nbsp;<span class="op" id="3223522">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3223525">//println(fmt.Sprintf(&#34;addDep(%T&nbsp;%p,&nbsp;%T&nbsp;%p)&#34;,&nbsp;x,&nbsp;x,&nbsp;dep,&nbsp;dep))</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3223589">db</span><span class="op" id="3223591">.</span><span class="ident" id="3223592">mu</span><span class="op" id="3223594">.</span><span class="ident" id="3223595">Lock</span><span class="op" id="3223599">(</span><span class="op" id="3223600">)</span><br>
<span class="lineno">365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3223603">defer</span>&nbsp;<span class="ident" id="3223609">db</span><span class="op" id="3223611">.</span><span class="ident" id="3223612">mu</span><span class="op" id="3223614">.</span><span class="ident" id="3223615">Unlock</span><span class="op" id="3223621">(</span><span class="op" id="3223622">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3223625">db</span><span class="op" id="3223627">.</span><span class="ident" id="3223628">addDepLocked</span><span class="op" id="3223640">(</span><span class="ident" id="3223641">x</span><span class="op" id="3223642">,</span>&nbsp;<span class="ident" id="3223644">dep</span><span class="op" id="3223647">)</span><br>
<span class="lineno"></span><span class="op" id="3223649">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3223652">func</span>&nbsp;<span class="op" id="3223657">(</span><span class="ident" id="3223658">db</span>&nbsp;<span class="op" id="3223661">*</span><span class="ident" id="3223662">DB</span><span class="op" id="3223664">)</span>&nbsp;<span class="ident" id="3223666">addDepLocked</span><span class="op" id="3223678">(</span><span class="ident" id="3223679">x</span>&nbsp;<span class="ident" id="3223681">finalCloser</span><span class="op" id="3223692">,</span>&nbsp;<span class="ident" id="3223694">dep</span>&nbsp;<span class="keyword" id="3223698">interface</span><span class="op" id="3223707">{</span><span class="op" id="3223708">}</span><span class="op" id="3223709">)</span>&nbsp;<span class="op" id="3223711">{</span><br>
<span class="lineno">370</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3223714">if</span>&nbsp;<span class="ident" id="3223717">db</span><span class="op" id="3223719">.</span><span class="ident" id="3223720">dep</span>&nbsp;<span class="op" id="3223724">==</span>&nbsp;<span class="ident" id="3223727">nil</span>&nbsp;<span class="op" id="3223731">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3223735">db</span><span class="op" id="3223737">.</span><span class="ident" id="3223738">dep</span>&nbsp;<span class="op" id="3223742">=</span>&nbsp;<span class="builtinfunc" id="3223744">make</span><span class="op" id="3223748">(</span><span class="keyword" id="3223749">map</span><span class="op" id="3223752">[</span><span class="ident" id="3223753">finalCloser</span><span class="op" id="3223764">]</span><span class="ident" id="3223765">depSet</span><span class="op" id="3223771">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3223774">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3223777">xdep</span>&nbsp;<span class="op" id="3223782">:=</span>&nbsp;<span class="ident" id="3223785">db</span><span class="op" id="3223787">.</span><span class="ident" id="3223788">dep</span><span class="op" id="3223791">[</span><span class="ident" id="3223792">x</span><span class="op" id="3223793">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3223796">if</span>&nbsp;<span class="ident" id="3223799">xdep</span>&nbsp;<span class="op" id="3223804">==</span>&nbsp;<span class="ident" id="3223807">nil</span>&nbsp;<span class="op" id="3223811">{</span><br>
<span class="lineno">375</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3223815">xdep</span>&nbsp;<span class="op" id="3223820">=</span>&nbsp;<span class="builtinfunc" id="3223822">make</span><span class="op" id="3223826">(</span><span class="ident" id="3223827">depSet</span><span class="op" id="3223833">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3223837">db</span><span class="op" id="3223839">.</span><span class="ident" id="3223840">dep</span><span class="op" id="3223843">[</span><span class="ident" id="3223844">x</span><span class="op" id="3223845">]</span>&nbsp;<span class="op" id="3223847">=</span>&nbsp;<span class="ident" id="3223849">xdep</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3223855">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3223858">xdep</span><span class="op" id="3223862">[</span><span class="ident" id="3223863">dep</span><span class="op" id="3223866">]</span>&nbsp;<span class="op" id="3223868">=</span>&nbsp;<span class="builtintype" id="3223870">true</span><br>
<span class="lineno"></span><span class="op" id="3223875">}</span><br>
<span class="lineno">380</span><br>
<span class="lineno"></span><span class="comment" id="3223878">//&nbsp;removeDep&nbsp;notes&nbsp;that&nbsp;x&nbsp;no&nbsp;longer&nbsp;depends&nbsp;on&nbsp;dep.</span><br>
<span class="lineno"></span><span class="comment" id="3223930">//&nbsp;If&nbsp;x&nbsp;still&nbsp;has&nbsp;dependencies,&nbsp;nil&nbsp;is&nbsp;returned.</span><br>
<span class="lineno"></span><span class="comment" id="3223979">//&nbsp;If&nbsp;x&nbsp;no&nbsp;longer&nbsp;has&nbsp;any&nbsp;dependencies,&nbsp;its&nbsp;finalClose&nbsp;method&nbsp;will&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="3224049">//&nbsp;called&nbsp;and&nbsp;its&nbsp;error&nbsp;value&nbsp;will&nbsp;be&nbsp;returned.</span><br>
<span class="lineno">385</span><span class="keyword" id="3224097">func</span>&nbsp;<span class="op" id="3224102">(</span><span class="ident" id="3224103">db</span>&nbsp;<span class="op" id="3224106">*</span><span class="ident" id="3224107">DB</span><span class="op" id="3224109">)</span>&nbsp;<span class="ident" id="3224111">removeDep</span><span class="op" id="3224120">(</span><span class="ident" id="3224121">x</span>&nbsp;<span class="ident" id="3224123">finalCloser</span><span class="op" id="3224134">,</span>&nbsp;<span class="ident" id="3224136">dep</span>&nbsp;<span class="keyword" id="3224140">interface</span><span class="op" id="3224149">{</span><span class="op" id="3224150">}</span><span class="op" id="3224151">)</span>&nbsp;<span class="builtintype" id="3224153">error</span>&nbsp;<span class="op" id="3224159">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3224162">db</span><span class="op" id="3224164">.</span><span class="ident" id="3224165">mu</span><span class="op" id="3224167">.</span><span class="ident" id="3224168">Lock</span><span class="op" id="3224172">(</span><span class="op" id="3224173">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3224176">fn</span>&nbsp;<span class="op" id="3224179">:=</span>&nbsp;<span class="ident" id="3224182">db</span><span class="op" id="3224184">.</span><span class="ident" id="3224185">removeDepLocked</span><span class="op" id="3224200">(</span><span class="ident" id="3224201">x</span><span class="op" id="3224202">,</span>&nbsp;<span class="ident" id="3224204">dep</span><span class="op" id="3224207">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3224210">db</span><span class="op" id="3224212">.</span><span class="ident" id="3224213">mu</span><span class="op" id="3224215">.</span><span class="ident" id="3224216">Unlock</span><span class="op" id="3224222">(</span><span class="op" id="3224223">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3224226">return</span>&nbsp;<span class="ident" id="3224233">fn</span><span class="op" id="3224235">(</span><span class="op" id="3224236">)</span><br>
<span class="lineno">390</span><span class="op" id="3224238">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3224241">func</span>&nbsp;<span class="op" id="3224246">(</span><span class="ident" id="3224247">db</span>&nbsp;<span class="op" id="3224250">*</span><span class="ident" id="3224251">DB</span><span class="op" id="3224253">)</span>&nbsp;<span class="ident" id="3224255">removeDepLocked</span><span class="op" id="3224270">(</span><span class="ident" id="3224271">x</span>&nbsp;<span class="ident" id="3224273">finalCloser</span><span class="op" id="3224284">,</span>&nbsp;<span class="ident" id="3224286">dep</span>&nbsp;<span class="keyword" id="3224290">interface</span><span class="op" id="3224299">{</span><span class="op" id="3224300">}</span><span class="op" id="3224301">)</span>&nbsp;<span class="keyword" id="3224303">func</span><span class="op" id="3224307">(</span><span class="op" id="3224308">)</span>&nbsp;<span class="builtintype" id="3224310">error</span>&nbsp;<span class="op" id="3224316">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3224319">//println(fmt.Sprintf(&#34;removeDep(%T&nbsp;%p,&nbsp;%T&nbsp;%p)&#34;,&nbsp;x,&nbsp;x,&nbsp;dep,&nbsp;dep))</span><br>
<span class="lineno"></span><br>
<span class="lineno">395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3224387">xdep</span><span class="op" id="3224391">,</span>&nbsp;<span class="ident" id="3224393">ok</span>&nbsp;<span class="op" id="3224396">:=</span>&nbsp;<span class="ident" id="3224399">db</span><span class="op" id="3224401">.</span><span class="ident" id="3224402">dep</span><span class="op" id="3224405">[</span><span class="ident" id="3224406">x</span><span class="op" id="3224407">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3224410">if</span>&nbsp;<span class="op" id="3224413">!</span><span class="ident" id="3224414">ok</span>&nbsp;<span class="op" id="3224417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3224421">panic</span><span class="op" id="3224426">(</span><span class="ident" id="3224427">fmt</span><span class="op" id="3224430">.</span><span class="ident" id="3224431">Sprintf</span><span class="op" id="3224438">(</span><span class="string" id="3224439">&#34;unpaired&nbsp;removeDep:&nbsp;no&nbsp;deps&nbsp;for&nbsp;%T&#34;</span><span class="op" id="3224475">,</span>&nbsp;<span class="ident" id="3224477">x</span><span class="op" id="3224478">)</span><span class="op" id="3224479">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3224482">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">400</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3224486">l0</span>&nbsp;<span class="op" id="3224489">:=</span>&nbsp;<span class="builtinfunc" id="3224492">len</span><span class="op" id="3224495">(</span><span class="ident" id="3224496">xdep</span><span class="op" id="3224500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3224503">delete</span><span class="op" id="3224509">(</span><span class="ident" id="3224510">xdep</span><span class="op" id="3224514">,</span>&nbsp;<span class="ident" id="3224516">dep</span><span class="op" id="3224519">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3224523">switch</span>&nbsp;<span class="builtinfunc" id="3224530">len</span><span class="op" id="3224533">(</span><span class="ident" id="3224534">xdep</span><span class="op" id="3224538">)</span>&nbsp;<span class="op" id="3224540">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3224543">case</span>&nbsp;<span class="ident" id="3224548">l0</span><span class="op" id="3224550">:</span><br>
<span class="lineno">405</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3224554">//&nbsp;Nothing&nbsp;removed.&nbsp;Shouldn&#39;t&nbsp;happen.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3224594">panic</span><span class="op" id="3224599">(</span><span class="ident" id="3224600">fmt</span><span class="op" id="3224603">.</span><span class="ident" id="3224604">Sprintf</span><span class="op" id="3224611">(</span><span class="string" id="3224612">&#34;unpaired&nbsp;removeDep:&nbsp;no&nbsp;%T&nbsp;dep&nbsp;on&nbsp;%T&#34;</span><span class="op" id="3224649">,</span>&nbsp;<span class="ident" id="3224651">dep</span><span class="op" id="3224654">,</span>&nbsp;<span class="ident" id="3224656">x</span><span class="op" id="3224657">)</span><span class="op" id="3224658">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3224661">case</span>&nbsp;<span class="num" id="3224666">0</span><span class="op" id="3224667">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3224671">//&nbsp;No&nbsp;more&nbsp;dependencies.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3224698">delete</span><span class="op" id="3224704">(</span><span class="ident" id="3224705">db</span><span class="op" id="3224707">.</span><span class="ident" id="3224708">dep</span><span class="op" id="3224711">,</span>&nbsp;<span class="ident" id="3224713">x</span><span class="op" id="3224714">)</span><br>
<span class="lineno">410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3224718">return</span>&nbsp;<span class="ident" id="3224725">x</span><span class="op" id="3224726">.</span><span class="ident" id="3224727">finalClose</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3224739">default</span><span class="op" id="3224746">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3224750">//&nbsp;Dependencies&nbsp;remain.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3224776">return</span>&nbsp;<span class="keyword" id="3224783">func</span><span class="op" id="3224787">(</span><span class="op" id="3224788">)</span>&nbsp;<span class="builtintype" id="3224790">error</span>&nbsp;<span class="op" id="3224796">{</span>&nbsp;<span class="keyword" id="3224798">return</span>&nbsp;<span class="ident" id="3224805">nil</span>&nbsp;<span class="op" id="3224809">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3224812">}</span><br>
<span class="lineno">415</span><span class="op" id="3224814">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3224817">//&nbsp;This&nbsp;is&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;connectionOpener&nbsp;request&nbsp;chan&nbsp;(dn.openerCh).</span><br>
<span class="lineno"></span><span class="comment" id="3224889">//&nbsp;This&nbsp;value&nbsp;should&nbsp;be&nbsp;larger&nbsp;than&nbsp;the&nbsp;maximum&nbsp;typical&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="3224951">//&nbsp;used&nbsp;for&nbsp;db.maxOpen.&nbsp;If&nbsp;maxOpen&nbsp;is&nbsp;significantly&nbsp;larger&nbsp;than</span><br>
<span class="lineno">420</span><span class="comment" id="3225015">//&nbsp;connectionRequestQueueSize&nbsp;then&nbsp;it&nbsp;is&nbsp;possible&nbsp;for&nbsp;ALL&nbsp;calls&nbsp;into&nbsp;the&nbsp;*DB</span><br>
<span class="lineno"></span><span class="comment" id="3225092">//&nbsp;to&nbsp;block&nbsp;until&nbsp;the&nbsp;connectionOpener&nbsp;can&nbsp;satisfy&nbsp;the&nbsp;backlog&nbsp;of&nbsp;requests.</span><br>
<span class="lineno"></span><span class="keyword" id="3225168">var</span>&nbsp;<span class="ident" id="3225172">connectionRequestQueueSize</span>&nbsp;<span class="op" id="3225199">=</span>&nbsp;<span class="num" id="3225201">1000000</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3225210">//&nbsp;Open&nbsp;opens&nbsp;a&nbsp;database&nbsp;specified&nbsp;by&nbsp;its&nbsp;database&nbsp;driver&nbsp;name&nbsp;and&nbsp;a</span><br>
<span class="lineno">425</span><span class="comment" id="3225279">//&nbsp;driver-specific&nbsp;data&nbsp;source&nbsp;name,&nbsp;usually&nbsp;consisting&nbsp;of&nbsp;at&nbsp;least&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3225349">//&nbsp;database&nbsp;name&nbsp;and&nbsp;connection&nbsp;information.</span><br>
<span class="lineno"></span><span class="comment" id="3225394">//</span><br>
<span class="lineno"></span><span class="comment" id="3225397">//&nbsp;Most&nbsp;users&nbsp;will&nbsp;open&nbsp;a&nbsp;database&nbsp;via&nbsp;a&nbsp;driver-specific&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="3225465">//&nbsp;helper&nbsp;function&nbsp;that&nbsp;returns&nbsp;a&nbsp;*DB.&nbsp;No&nbsp;database&nbsp;drivers&nbsp;are&nbsp;included</span><br>
<span class="lineno">430</span><span class="comment" id="3225537">//&nbsp;in&nbsp;the&nbsp;Go&nbsp;standard&nbsp;library.&nbsp;See&nbsp;http://golang.org/s/sqldrivers&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="3225607">//&nbsp;a&nbsp;list&nbsp;of&nbsp;third-party&nbsp;drivers.</span><br>
<span class="lineno"></span><span class="comment" id="3225641">//</span><br>
<span class="lineno"></span><span class="comment" id="3225644">//&nbsp;Open&nbsp;may&nbsp;just&nbsp;validate&nbsp;its&nbsp;arguments&nbsp;without&nbsp;creating&nbsp;a&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="3225714">//&nbsp;to&nbsp;the&nbsp;database.&nbsp;To&nbsp;verify&nbsp;that&nbsp;the&nbsp;data&nbsp;source&nbsp;name&nbsp;is&nbsp;valid,&nbsp;call</span><br>
<span class="lineno">435</span><span class="comment" id="3225785">//&nbsp;Ping.</span><br>
<span class="lineno"></span><span class="comment" id="3225794">//</span><br>
<span class="lineno"></span><span class="comment" id="3225797">//&nbsp;The&nbsp;returned&nbsp;DB&nbsp;is&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines</span><br>
<span class="lineno"></span><span class="comment" id="3225866">//&nbsp;and&nbsp;maintains&nbsp;its&nbsp;own&nbsp;pool&nbsp;of&nbsp;idle&nbsp;connections.&nbsp;Thus,&nbsp;the&nbsp;Open</span><br>
<span class="lineno"></span><span class="comment" id="3225932">//&nbsp;function&nbsp;should&nbsp;be&nbsp;called&nbsp;just&nbsp;once.&nbsp;It&nbsp;is&nbsp;rarely&nbsp;necessary&nbsp;to</span><br>
<span class="lineno">440</span><span class="comment" id="3225998">//&nbsp;close&nbsp;a&nbsp;DB.</span><br>
<span class="lineno"></span><span class="keyword" id="3226013">func</span>&nbsp;<span class="ident" id="3226018">Open</span><span class="op" id="3226022">(</span><span class="ident" id="3226023">driverName</span><span class="op" id="3226033">,</span>&nbsp;<span class="ident" id="3226035">dataSourceName</span>&nbsp;<span class="builtintype" id="3226050">string</span><span class="op" id="3226056">)</span>&nbsp;<span class="op" id="3226058">(</span><span class="op" id="3226059">*</span><span class="ident" id="3226060">DB</span><span class="op" id="3226062">,</span>&nbsp;<span class="builtintype" id="3226064">error</span><span class="op" id="3226069">)</span>&nbsp;<span class="op" id="3226071">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3226074">driveri</span><span class="op" id="3226081">,</span>&nbsp;<span class="ident" id="3226083">ok</span>&nbsp;<span class="op" id="3226086">:=</span>&nbsp;<span class="ident" id="3226089">drivers</span><span class="op" id="3226096">[</span><span class="ident" id="3226097">driverName</span><span class="op" id="3226107">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3226110">if</span>&nbsp;<span class="op" id="3226113">!</span><span class="ident" id="3226114">ok</span>&nbsp;<span class="op" id="3226117">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3226121">return</span>&nbsp;<span class="ident" id="3226128">nil</span><span class="op" id="3226131">,</span>&nbsp;<span class="ident" id="3226133">fmt</span><span class="op" id="3226136">.</span><span class="ident" id="3226137">Errorf</span><span class="op" id="3226143">(</span><span class="string" id="3226144">&#34;sql:&nbsp;unknown&nbsp;driver&nbsp;%q&nbsp;(forgotten&nbsp;import?)&#34;</span><span class="op" id="3226188">,</span>&nbsp;<span class="ident" id="3226190">driverName</span><span class="op" id="3226200">)</span><br>
<span class="lineno">445</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3226203">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3226206">db</span>&nbsp;<span class="op" id="3226209">:=</span>&nbsp;<span class="op" id="3226212">&amp;</span><span class="ident" id="3226213">DB</span><span class="op" id="3226215">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3226219">driver</span><span class="op" id="3226225">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3226229">driveri</span><span class="op" id="3226236">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3226240">dsn</span><span class="op" id="3226243">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3226250">dataSourceName</span><span class="op" id="3226264">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3226268">openerCh</span><span class="op" id="3226276">:</span>&nbsp;<span class="builtinfunc" id="3226278">make</span><span class="op" id="3226282">(</span><span class="keyword" id="3226283">chan</span>&nbsp;<span class="keyword" id="3226288">struct</span><span class="op" id="3226294">{</span><span class="op" id="3226295">}</span><span class="op" id="3226296">,</span>&nbsp;<span class="ident" id="3226298">connectionRequestQueueSize</span><span class="op" id="3226324">)</span><span class="op" id="3226325">,</span><br>
<span class="lineno">450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3226329">lastPut</span><span class="op" id="3226336">:</span>&nbsp;&nbsp;<span class="builtinfunc" id="3226339">make</span><span class="op" id="3226343">(</span><span class="keyword" id="3226344">map</span><span class="op" id="3226347">[</span><span class="op" id="3226348">*</span><span class="ident" id="3226349">driverConn</span><span class="op" id="3226359">]</span><span class="builtintype" id="3226360">string</span><span class="op" id="3226366">)</span><span class="op" id="3226367">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3226370">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3226373">go</span>&nbsp;<span class="ident" id="3226376">db</span><span class="op" id="3226378">.</span><span class="ident" id="3226379">connectionOpener</span><span class="op" id="3226395">(</span><span class="op" id="3226396">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3226399">return</span>&nbsp;<span class="ident" id="3226406">db</span><span class="op" id="3226408">,</span>&nbsp;<span class="ident" id="3226410">nil</span><br>
<span class="lineno"></span><span class="op" id="3226414">}</span><br>
<span class="lineno">455</span><br>
<span class="lineno"></span><span class="comment" id="3226417">//&nbsp;Ping&nbsp;verifies&nbsp;a&nbsp;connection&nbsp;to&nbsp;the&nbsp;database&nbsp;is&nbsp;still&nbsp;alive,</span><br>
<span class="lineno"></span><span class="comment" id="3226479">//&nbsp;establishing&nbsp;a&nbsp;connection&nbsp;if&nbsp;necessary.</span><br>
<span class="lineno"></span><span class="keyword" id="3226522">func</span>&nbsp;<span class="op" id="3226527">(</span><span class="ident" id="3226528">db</span>&nbsp;<span class="op" id="3226531">*</span><span class="ident" id="3226532">DB</span><span class="op" id="3226534">)</span>&nbsp;<span class="ident" id="3226536">Ping</span><span class="op" id="3226540">(</span><span class="op" id="3226541">)</span>&nbsp;<span class="builtintype" id="3226543">error</span>&nbsp;<span class="op" id="3226549">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3226552">//&nbsp;TODO(bradfitz):&nbsp;give&nbsp;drivers&nbsp;an&nbsp;optional&nbsp;hook&nbsp;to&nbsp;implement</span><br>
<span class="lineno">460</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3226615">//&nbsp;this&nbsp;in&nbsp;a&nbsp;more&nbsp;efficient&nbsp;or&nbsp;more&nbsp;reliable&nbsp;way,&nbsp;if&nbsp;they</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3226674">//&nbsp;have&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3226688">dc</span><span class="op" id="3226690">,</span>&nbsp;<span class="ident" id="3226692">err</span>&nbsp;<span class="op" id="3226696">:=</span>&nbsp;<span class="ident" id="3226699">db</span><span class="op" id="3226701">.</span><span class="ident" id="3226702">conn</span><span class="op" id="3226706">(</span><span class="op" id="3226707">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3226710">if</span>&nbsp;<span class="ident" id="3226713">err</span>&nbsp;<span class="op" id="3226717">!=</span>&nbsp;<span class="ident" id="3226720">nil</span>&nbsp;<span class="op" id="3226724">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3226728">return</span>&nbsp;<span class="ident" id="3226735">err</span><br>
<span class="lineno">465</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3226740">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3226743">db</span><span class="op" id="3226745">.</span><span class="ident" id="3226746">putConn</span><span class="op" id="3226753">(</span><span class="ident" id="3226754">dc</span><span class="op" id="3226756">,</span>&nbsp;<span class="ident" id="3226758">nil</span><span class="op" id="3226761">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3226764">return</span>&nbsp;<span class="ident" id="3226771">nil</span><br>
<span class="lineno"></span><span class="op" id="3226775">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">470</span><span class="comment" id="3226778">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;database,&nbsp;releasing&nbsp;any&nbsp;open&nbsp;resources.</span><br>
<span class="lineno"></span><span class="comment" id="3226838">//</span><br>
<span class="lineno"></span><span class="comment" id="3226841">//&nbsp;It&nbsp;is&nbsp;rare&nbsp;to&nbsp;Close&nbsp;a&nbsp;DB,&nbsp;as&nbsp;the&nbsp;DB&nbsp;handle&nbsp;is&nbsp;meant&nbsp;to&nbsp;be</span><br>
<span class="lineno"></span><span class="comment" id="3226902">//&nbsp;long-lived&nbsp;and&nbsp;shared&nbsp;between&nbsp;many&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="keyword" id="3226952">func</span>&nbsp;<span class="op" id="3226957">(</span><span class="ident" id="3226958">db</span>&nbsp;<span class="op" id="3226961">*</span><span class="ident" id="3226962">DB</span><span class="op" id="3226964">)</span>&nbsp;<span class="ident" id="3226966">Close</span><span class="op" id="3226971">(</span><span class="op" id="3226972">)</span>&nbsp;<span class="builtintype" id="3226974">error</span>&nbsp;<span class="op" id="3226980">{</span><br>
<span class="lineno">475</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3226983">db</span><span class="op" id="3226985">.</span><span class="ident" id="3226986">mu</span><span class="op" id="3226988">.</span><span class="ident" id="3226989">Lock</span><span class="op" id="3226993">(</span><span class="op" id="3226994">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3226997">if</span>&nbsp;<span class="ident" id="3227000">db</span><span class="op" id="3227002">.</span><span class="ident" id="3227003">closed</span>&nbsp;<span class="op" id="3227010">{</span>&nbsp;<span class="comment" id="3227012">//&nbsp;Make&nbsp;DB.Close&nbsp;idempotent</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3227042">db</span><span class="op" id="3227044">.</span><span class="ident" id="3227045">mu</span><span class="op" id="3227047">.</span><span class="ident" id="3227048">Unlock</span><span class="op" id="3227054">(</span><span class="op" id="3227055">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3227059">return</span>&nbsp;<span class="ident" id="3227066">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3227071">}</span><br>
<span class="lineno">480</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3227074">close</span><span class="op" id="3227079">(</span><span class="ident" id="3227080">db</span><span class="op" id="3227082">.</span><span class="ident" id="3227083">openerCh</span><span class="op" id="3227091">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3227094">var</span>&nbsp;<span class="ident" id="3227098">err</span>&nbsp;<span class="builtintype" id="3227102">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3227109">fns</span>&nbsp;<span class="op" id="3227113">:=</span>&nbsp;<span class="builtinfunc" id="3227116">make</span><span class="op" id="3227120">(</span><span class="op" id="3227121">[</span><span class="op" id="3227122">]</span><span class="keyword" id="3227123">func</span><span class="op" id="3227127">(</span><span class="op" id="3227128">)</span>&nbsp;<span class="builtintype" id="3227130">error</span><span class="op" id="3227135">,</span>&nbsp;<span class="num" id="3227137">0</span><span class="op" id="3227138">,</span>&nbsp;<span class="builtinfunc" id="3227140">len</span><span class="op" id="3227143">(</span><span class="ident" id="3227144">db</span><span class="op" id="3227146">.</span><span class="ident" id="3227147">freeConn</span><span class="op" id="3227155">)</span><span class="op" id="3227156">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3227159">for</span>&nbsp;<span class="ident" id="3227163">_</span><span class="op" id="3227164">,</span>&nbsp;<span class="ident" id="3227166">dc</span>&nbsp;<span class="op" id="3227169">:=</span>&nbsp;<span class="keyword" id="3227172">range</span>&nbsp;<span class="ident" id="3227178">db</span><span class="op" id="3227180">.</span><span class="ident" id="3227181">freeConn</span>&nbsp;<span class="op" id="3227190">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3227194">fns</span>&nbsp;<span class="op" id="3227198">=</span>&nbsp;<span class="builtinfunc" id="3227200">append</span><span class="op" id="3227206">(</span><span class="ident" id="3227207">fns</span><span class="op" id="3227210">,</span>&nbsp;<span class="ident" id="3227212">dc</span><span class="op" id="3227214">.</span><span class="ident" id="3227215">closeDBLocked</span><span class="op" id="3227228">(</span><span class="op" id="3227229">)</span><span class="op" id="3227230">)</span><br>
<span class="lineno">485</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3227233">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3227236">db</span><span class="op" id="3227238">.</span><span class="ident" id="3227239">freeConn</span>&nbsp;<span class="op" id="3227248">=</span>&nbsp;<span class="ident" id="3227250">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3227255">db</span><span class="op" id="3227257">.</span><span class="ident" id="3227258">closed</span>&nbsp;<span class="op" id="3227265">=</span>&nbsp;<span class="builtintype" id="3227267">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3227273">for</span>&nbsp;<span class="ident" id="3227277">_</span><span class="op" id="3227278">,</span>&nbsp;<span class="ident" id="3227280">req</span>&nbsp;<span class="op" id="3227284">:=</span>&nbsp;<span class="keyword" id="3227287">range</span>&nbsp;<span class="ident" id="3227293">db</span><span class="op" id="3227295">.</span><span class="ident" id="3227296">connRequests</span>&nbsp;<span class="op" id="3227309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3227313">close</span><span class="op" id="3227318">(</span><span class="ident" id="3227319">req</span><span class="op" id="3227322">)</span><br>
<span class="lineno">490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3227325">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3227328">db</span><span class="op" id="3227330">.</span><span class="ident" id="3227331">mu</span><span class="op" id="3227333">.</span><span class="ident" id="3227334">Unlock</span><span class="op" id="3227340">(</span><span class="op" id="3227341">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3227344">for</span>&nbsp;<span class="ident" id="3227348">_</span><span class="op" id="3227349">,</span>&nbsp;<span class="ident" id="3227351">fn</span>&nbsp;<span class="op" id="3227354">:=</span>&nbsp;<span class="keyword" id="3227357">range</span>&nbsp;<span class="ident" id="3227363">fns</span>&nbsp;<span class="op" id="3227367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3227371">err1</span>&nbsp;<span class="op" id="3227376">:=</span>&nbsp;<span class="ident" id="3227379">fn</span><span class="op" id="3227381">(</span><span class="op" id="3227382">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3227386">if</span>&nbsp;<span class="ident" id="3227389">err1</span>&nbsp;<span class="op" id="3227394">!=</span>&nbsp;<span class="ident" id="3227397">nil</span>&nbsp;<span class="op" id="3227401">{</span><br>
<span class="lineno">495</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3227406">err</span>&nbsp;<span class="op" id="3227410">=</span>&nbsp;<span class="ident" id="3227412">err1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3227419">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3227422">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3227425">return</span>&nbsp;<span class="ident" id="3227432">err</span><br>
<span class="lineno"></span><span class="op" id="3227436">}</span><br>
<span class="lineno">500</span><br>
<span class="lineno"></span><span class="keyword" id="3227439">const</span>&nbsp;<span class="ident" id="3227445">defaultMaxIdleConns</span>&nbsp;<span class="op" id="3227465">=</span>&nbsp;<span class="num" id="3227467">2</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3227470">func</span>&nbsp;<span class="op" id="3227475">(</span><span class="ident" id="3227476">db</span>&nbsp;<span class="op" id="3227479">*</span><span class="ident" id="3227480">DB</span><span class="op" id="3227482">)</span>&nbsp;<span class="ident" id="3227484">maxIdleConnsLocked</span><span class="op" id="3227502">(</span><span class="op" id="3227503">)</span>&nbsp;<span class="builtintype" id="3227505">int</span>&nbsp;<span class="op" id="3227509">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3227512">n</span>&nbsp;<span class="op" id="3227514">:=</span>&nbsp;<span class="ident" id="3227517">db</span><span class="op" id="3227519">.</span><span class="ident" id="3227520">maxIdle</span><br>
<span class="lineno">505</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3227529">switch</span>&nbsp;<span class="op" id="3227536">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3227539">case</span>&nbsp;<span class="ident" id="3227544">n</span>&nbsp;<span class="op" id="3227546">==</span>&nbsp;<span class="num" id="3227549">0</span><span class="op" id="3227550">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3227554">//&nbsp;TODO(bradfitz):&nbsp;ask&nbsp;driver,&nbsp;if&nbsp;supported,&nbsp;for&nbsp;its&nbsp;default&nbsp;preference</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3227628">return</span>&nbsp;<span class="ident" id="3227635">defaultMaxIdleConns</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3227656">case</span>&nbsp;<span class="ident" id="3227661">n</span>&nbsp;<span class="op" id="3227663">&lt;</span>&nbsp;<span class="num" id="3227665">0</span><span class="op" id="3227666">:</span><br>
<span class="lineno">510</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3227670">return</span>&nbsp;<span class="num" id="3227677">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3227680">default</span><span class="op" id="3227687">:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3227691">return</span>&nbsp;<span class="ident" id="3227698">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3227701">}</span><br>
<span class="lineno"></span><span class="op" id="3227703">}</span><br>
<span class="lineno">515</span><br>
<span class="lineno"></span><span class="comment" id="3227706">//&nbsp;SetMaxIdleConns&nbsp;sets&nbsp;the&nbsp;maximum&nbsp;number&nbsp;of&nbsp;connections&nbsp;in&nbsp;the&nbsp;idle</span><br>
<span class="lineno"></span><span class="comment" id="3227776">//&nbsp;connection&nbsp;pool.</span><br>
<span class="lineno"></span><span class="comment" id="3227796">//</span><br>
<span class="lineno"></span><span class="comment" id="3227799">//&nbsp;If&nbsp;MaxOpenConns&nbsp;is&nbsp;greater&nbsp;than&nbsp;0&nbsp;but&nbsp;less&nbsp;than&nbsp;the&nbsp;new&nbsp;MaxIdleConns</span><br>
<span class="lineno">520</span><span class="comment" id="3227871">//&nbsp;then&nbsp;the&nbsp;new&nbsp;MaxIdleConns&nbsp;will&nbsp;be&nbsp;reduced&nbsp;to&nbsp;match&nbsp;the&nbsp;MaxOpenConns&nbsp;limit</span><br>
<span class="lineno"></span><span class="comment" id="3227948">//</span><br>
<span class="lineno"></span><span class="comment" id="3227951">//&nbsp;If&nbsp;n&nbsp;&lt;=&nbsp;0,&nbsp;no&nbsp;idle&nbsp;connections&nbsp;are&nbsp;retained.</span><br>
<span class="lineno"></span><span class="keyword" id="3227999">func</span>&nbsp;<span class="op" id="3228004">(</span><span class="ident" id="3228005">db</span>&nbsp;<span class="op" id="3228008">*</span><span class="ident" id="3228009">DB</span><span class="op" id="3228011">)</span>&nbsp;<span class="ident" id="3228013">SetMaxIdleConns</span><span class="op" id="3228028">(</span><span class="ident" id="3228029">n</span>&nbsp;<span class="builtintype" id="3228031">int</span><span class="op" id="3228034">)</span>&nbsp;<span class="op" id="3228036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3228039">db</span><span class="op" id="3228041">.</span><span class="ident" id="3228042">mu</span><span class="op" id="3228044">.</span><span class="ident" id="3228045">Lock</span><span class="op" id="3228049">(</span><span class="op" id="3228050">)</span><br>
<span class="lineno">525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3228053">if</span>&nbsp;<span class="ident" id="3228056">n</span>&nbsp;<span class="op" id="3228058">&gt;</span>&nbsp;<span class="num" id="3228060">0</span>&nbsp;<span class="op" id="3228062">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3228066">db</span><span class="op" id="3228068">.</span><span class="ident" id="3228069">maxIdle</span>&nbsp;<span class="op" id="3228077">=</span>&nbsp;<span class="ident" id="3228079">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3228082">}</span>&nbsp;<span class="keyword" id="3228084">else</span>&nbsp;<span class="op" id="3228089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3228093">//&nbsp;No&nbsp;idle&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3228119">db</span><span class="op" id="3228121">.</span><span class="ident" id="3228122">maxIdle</span>&nbsp;<span class="op" id="3228130">=</span>&nbsp;<span class="op" id="3228132">-</span><span class="num" id="3228133">1</span><br>
<span class="lineno">530</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3228136">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3228139">//&nbsp;Make&nbsp;sure&nbsp;maxIdle&nbsp;doesn&#39;t&nbsp;exceed&nbsp;maxOpen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3228184">if</span>&nbsp;<span class="ident" id="3228187">db</span><span class="op" id="3228189">.</span><span class="ident" id="3228190">maxOpen</span>&nbsp;<span class="op" id="3228198">&gt;</span>&nbsp;<span class="num" id="3228200">0</span>&nbsp;<span class="op" id="3228202">&amp;&amp;</span>&nbsp;<span class="ident" id="3228205">db</span><span class="op" id="3228207">.</span><span class="ident" id="3228208">maxIdleConnsLocked</span><span class="op" id="3228226">(</span><span class="op" id="3228227">)</span>&nbsp;<span class="op" id="3228229">&gt;</span>&nbsp;<span class="ident" id="3228231">db</span><span class="op" id="3228233">.</span><span class="ident" id="3228234">maxOpen</span>&nbsp;<span class="op" id="3228242">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3228246">db</span><span class="op" id="3228248">.</span><span class="ident" id="3228249">maxIdle</span>&nbsp;<span class="op" id="3228257">=</span>&nbsp;<span class="ident" id="3228259">db</span><span class="op" id="3228261">.</span><span class="ident" id="3228262">maxOpen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3228271">}</span><br>
<span class="lineno">535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3228274">var</span>&nbsp;<span class="ident" id="3228278">closing</span>&nbsp;<span class="op" id="3228286">[</span><span class="op" id="3228287">]</span><span class="op" id="3228288">*</span><span class="ident" id="3228289">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3228301">idleCount</span>&nbsp;<span class="op" id="3228311">:=</span>&nbsp;<span class="builtinfunc" id="3228314">len</span><span class="op" id="3228317">(</span><span class="ident" id="3228318">db</span><span class="op" id="3228320">.</span><span class="ident" id="3228321">freeConn</span><span class="op" id="3228329">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3228332">maxIdle</span>&nbsp;<span class="op" id="3228340">:=</span>&nbsp;<span class="ident" id="3228343">db</span><span class="op" id="3228345">.</span><span class="ident" id="3228346">maxIdleConnsLocked</span><span class="op" id="3228364">(</span><span class="op" id="3228365">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3228368">if</span>&nbsp;<span class="ident" id="3228371">idleCount</span>&nbsp;<span class="op" id="3228381">&gt;</span>&nbsp;<span class="ident" id="3228383">maxIdle</span>&nbsp;<span class="op" id="3228391">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3228395">closing</span>&nbsp;<span class="op" id="3228403">=</span>&nbsp;<span class="ident" id="3228405">db</span><span class="op" id="3228407">.</span><span class="ident" id="3228408">freeConn</span><span class="op" id="3228416">[</span><span class="ident" id="3228417">maxIdle</span><span class="op" id="3228424">:</span><span class="op" id="3228425">]</span><br>
<span class="lineno">540</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3228429">db</span><span class="op" id="3228431">.</span><span class="ident" id="3228432">freeConn</span>&nbsp;<span class="op" id="3228441">=</span>&nbsp;<span class="ident" id="3228443">db</span><span class="op" id="3228445">.</span><span class="ident" id="3228446">freeConn</span><span class="op" id="3228454">[</span><span class="op" id="3228455">:</span><span class="ident" id="3228456">maxIdle</span><span class="op" id="3228463">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3228466">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3228469">db</span><span class="op" id="3228471">.</span><span class="ident" id="3228472">mu</span><span class="op" id="3228474">.</span><span class="ident" id="3228475">Unlock</span><span class="op" id="3228481">(</span><span class="op" id="3228482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3228485">for</span>&nbsp;<span class="ident" id="3228489">_</span><span class="op" id="3228490">,</span>&nbsp;<span class="ident" id="3228492">c</span>&nbsp;<span class="op" id="3228494">:=</span>&nbsp;<span class="keyword" id="3228497">range</span>&nbsp;<span class="ident" id="3228503">closing</span>&nbsp;<span class="op" id="3228511">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3228515">c</span><span class="op" id="3228516">.</span><span class="ident" id="3228517">Close</span><span class="op" id="3228522">(</span><span class="op" id="3228523">)</span><br>
<span class="lineno">545</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3228526">}</span><br>
<span class="lineno"></span><span class="op" id="3228528">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3228531">//&nbsp;SetMaxOpenConns&nbsp;sets&nbsp;the&nbsp;maximum&nbsp;number&nbsp;of&nbsp;open&nbsp;connections&nbsp;to&nbsp;the&nbsp;database.</span><br>
<span class="lineno"></span><span class="comment" id="3228611">//</span><br>
<span class="lineno">550</span><span class="comment" id="3228614">//&nbsp;If&nbsp;MaxIdleConns&nbsp;is&nbsp;greater&nbsp;than&nbsp;0&nbsp;and&nbsp;the&nbsp;new&nbsp;MaxOpenConns&nbsp;is&nbsp;less&nbsp;than</span><br>
<span class="lineno"></span><span class="comment" id="3228689">//&nbsp;MaxIdleConns,&nbsp;then&nbsp;MaxIdleConns&nbsp;will&nbsp;be&nbsp;reduced&nbsp;to&nbsp;match&nbsp;the&nbsp;new</span><br>
<span class="lineno"></span><span class="comment" id="3228757">//&nbsp;MaxOpenConns&nbsp;limit</span><br>
<span class="lineno"></span><span class="comment" id="3228779">//</span><br>
<span class="lineno"></span><span class="comment" id="3228782">//&nbsp;If&nbsp;n&nbsp;&lt;=&nbsp;0,&nbsp;then&nbsp;there&nbsp;is&nbsp;no&nbsp;limit&nbsp;on&nbsp;the&nbsp;number&nbsp;of&nbsp;open&nbsp;connections.</span><br>
<span class="lineno">555</span><span class="comment" id="3228854">//&nbsp;The&nbsp;default&nbsp;is&nbsp;0&nbsp;(unlimited).</span><br>
<span class="lineno"></span><span class="keyword" id="3228887">func</span>&nbsp;<span class="op" id="3228892">(</span><span class="ident" id="3228893">db</span>&nbsp;<span class="op" id="3228896">*</span><span class="ident" id="3228897">DB</span><span class="op" id="3228899">)</span>&nbsp;<span class="ident" id="3228901">SetMaxOpenConns</span><span class="op" id="3228916">(</span><span class="ident" id="3228917">n</span>&nbsp;<span class="builtintype" id="3228919">int</span><span class="op" id="3228922">)</span>&nbsp;<span class="op" id="3228924">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3228927">db</span><span class="op" id="3228929">.</span><span class="ident" id="3228930">mu</span><span class="op" id="3228932">.</span><span class="ident" id="3228933">Lock</span><span class="op" id="3228937">(</span><span class="op" id="3228938">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3228941">db</span><span class="op" id="3228943">.</span><span class="ident" id="3228944">maxOpen</span>&nbsp;<span class="op" id="3228952">=</span>&nbsp;<span class="ident" id="3228954">n</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3228957">if</span>&nbsp;<span class="ident" id="3228960">n</span>&nbsp;<span class="op" id="3228962">&lt;</span>&nbsp;<span class="num" id="3228964">0</span>&nbsp;<span class="op" id="3228966">{</span><br>
<span class="lineno">560</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3228970">db</span><span class="op" id="3228972">.</span><span class="ident" id="3228973">maxOpen</span>&nbsp;<span class="op" id="3228981">=</span>&nbsp;<span class="num" id="3228983">0</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3228986">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3228989">syncMaxIdle</span>&nbsp;<span class="op" id="3229001">:=</span>&nbsp;<span class="ident" id="3229004">db</span><span class="op" id="3229006">.</span><span class="ident" id="3229007">maxOpen</span>&nbsp;<span class="op" id="3229015">&gt;</span>&nbsp;<span class="num" id="3229017">0</span>&nbsp;<span class="op" id="3229019">&amp;&amp;</span>&nbsp;<span class="ident" id="3229022">db</span><span class="op" id="3229024">.</span><span class="ident" id="3229025">maxIdleConnsLocked</span><span class="op" id="3229043">(</span><span class="op" id="3229044">)</span>&nbsp;<span class="op" id="3229046">&gt;</span>&nbsp;<span class="ident" id="3229048">db</span><span class="op" id="3229050">.</span><span class="ident" id="3229051">maxOpen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3229060">db</span><span class="op" id="3229062">.</span><span class="ident" id="3229063">mu</span><span class="op" id="3229065">.</span><span class="ident" id="3229066">Unlock</span><span class="op" id="3229072">(</span><span class="op" id="3229073">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3229076">if</span>&nbsp;<span class="ident" id="3229079">syncMaxIdle</span>&nbsp;<span class="op" id="3229091">{</span><br>
<span class="lineno">565</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3229095">db</span><span class="op" id="3229097">.</span><span class="ident" id="3229098">SetMaxIdleConns</span><span class="op" id="3229113">(</span><span class="ident" id="3229114">n</span><span class="op" id="3229115">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3229118">}</span><br>
<span class="lineno"></span><span class="op" id="3229120">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3229123">//&nbsp;Assumes&nbsp;db.mu&nbsp;is&nbsp;locked.</span><br>
<span class="lineno">570</span><span class="comment" id="3229151">//&nbsp;If&nbsp;there&nbsp;are&nbsp;connRequests&nbsp;and&nbsp;the&nbsp;connection&nbsp;limit&nbsp;hasn&#39;t&nbsp;been&nbsp;reached,</span><br>
<span class="lineno"></span><span class="comment" id="3229226">//&nbsp;then&nbsp;tell&nbsp;the&nbsp;connectionOpener&nbsp;to&nbsp;open&nbsp;new&nbsp;connections.</span><br>
<span class="lineno"></span><span class="keyword" id="3229285">func</span>&nbsp;<span class="op" id="3229290">(</span><span class="ident" id="3229291">db</span>&nbsp;<span class="op" id="3229294">*</span><span class="ident" id="3229295">DB</span><span class="op" id="3229297">)</span>&nbsp;<span class="ident" id="3229299">maybeOpenNewConnections</span><span class="op" id="3229322">(</span><span class="op" id="3229323">)</span>&nbsp;<span class="op" id="3229325">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3229328">numRequests</span>&nbsp;<span class="op" id="3229340">:=</span>&nbsp;<span class="builtinfunc" id="3229343">len</span><span class="op" id="3229346">(</span><span class="ident" id="3229347">db</span><span class="op" id="3229349">.</span><span class="ident" id="3229350">connRequests</span><span class="op" id="3229362">)</span>&nbsp;<span class="op" id="3229364">-</span>&nbsp;<span class="ident" id="3229366">db</span><span class="op" id="3229368">.</span><span class="ident" id="3229369">pendingOpens</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3229383">if</span>&nbsp;<span class="ident" id="3229386">db</span><span class="op" id="3229388">.</span><span class="ident" id="3229389">maxOpen</span>&nbsp;<span class="op" id="3229397">&gt;</span>&nbsp;<span class="num" id="3229399">0</span>&nbsp;<span class="op" id="3229401">{</span><br>
<span class="lineno">575</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3229405">numCanOpen</span>&nbsp;<span class="op" id="3229416">:=</span>&nbsp;<span class="ident" id="3229419">db</span><span class="op" id="3229421">.</span><span class="ident" id="3229422">maxOpen</span>&nbsp;<span class="op" id="3229430">-</span>&nbsp;<span class="op" id="3229432">(</span><span class="ident" id="3229433">db</span><span class="op" id="3229435">.</span><span class="ident" id="3229436">numOpen</span>&nbsp;<span class="op" id="3229444">+</span>&nbsp;<span class="ident" id="3229446">db</span><span class="op" id="3229448">.</span><span class="ident" id="3229449">pendingOpens</span><span class="op" id="3229461">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3229465">if</span>&nbsp;<span class="ident" id="3229468">numRequests</span>&nbsp;<span class="op" id="3229480">&gt;</span>&nbsp;<span class="ident" id="3229482">numCanOpen</span>&nbsp;<span class="op" id="3229493">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3229498">numRequests</span>&nbsp;<span class="op" id="3229510">=</span>&nbsp;<span class="ident" id="3229512">numCanOpen</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3229525">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3229528">}</span><br>
<span class="lineno">580</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3229531">for</span>&nbsp;<span class="ident" id="3229535">numRequests</span>&nbsp;<span class="op" id="3229547">&gt;</span>&nbsp;<span class="num" id="3229549">0</span>&nbsp;<span class="op" id="3229551">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3229555">db</span><span class="op" id="3229557">.</span><span class="ident" id="3229558">pendingOpens</span><span class="op" id="3229570">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3229575">numRequests</span><span class="op" id="3229586">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3229591">db</span><span class="op" id="3229593">.</span><span class="ident" id="3229594">openerCh</span>&nbsp;<span class="op" id="3229603">&lt;-</span>&nbsp;<span class="keyword" id="3229606">struct</span><span class="op" id="3229612">{</span><span class="op" id="3229613">}</span><span class="op" id="3229614">{</span><span class="op" id="3229615">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3229618">}</span><br>
<span class="lineno">585</span><span class="op" id="3229620">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3229623">//&nbsp;Runs&nbsp;in&nbsp;a&nbsp;separate&nbsp;goroutine,&nbsp;opens&nbsp;new&nbsp;connections&nbsp;when&nbsp;requested.</span><br>
<span class="lineno"></span><span class="keyword" id="3229694">func</span>&nbsp;<span class="op" id="3229699">(</span><span class="ident" id="3229700">db</span>&nbsp;<span class="op" id="3229703">*</span><span class="ident" id="3229704">DB</span><span class="op" id="3229706">)</span>&nbsp;<span class="ident" id="3229708">connectionOpener</span><span class="op" id="3229724">(</span><span class="op" id="3229725">)</span>&nbsp;<span class="op" id="3229727">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3229730">for</span>&nbsp;<span class="keyword" id="3229734">range</span>&nbsp;<span class="ident" id="3229740">db</span><span class="op" id="3229742">.</span><span class="ident" id="3229743">openerCh</span>&nbsp;<span class="op" id="3229752">{</span><br>
<span class="lineno">590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3229756">db</span><span class="op" id="3229758">.</span><span class="ident" id="3229759">openNewConnection</span><span class="op" id="3229776">(</span><span class="op" id="3229777">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3229780">}</span><br>
<span class="lineno"></span><span class="op" id="3229782">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3229785">//&nbsp;Open&nbsp;one&nbsp;new&nbsp;connection</span><br>
<span class="lineno">595</span><span class="keyword" id="3229812">func</span>&nbsp;<span class="op" id="3229817">(</span><span class="ident" id="3229818">db</span>&nbsp;<span class="op" id="3229821">*</span><span class="ident" id="3229822">DB</span><span class="op" id="3229824">)</span>&nbsp;<span class="ident" id="3229826">openNewConnection</span><span class="op" id="3229843">(</span><span class="op" id="3229844">)</span>&nbsp;<span class="op" id="3229846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3229849">ci</span><span class="op" id="3229851">,</span>&nbsp;<span class="ident" id="3229853">err</span>&nbsp;<span class="op" id="3229857">:=</span>&nbsp;<span class="ident" id="3229860">db</span><span class="op" id="3229862">.</span><span class="ident" id="3229863">driver</span><span class="op" id="3229869">.</span><span class="ident" id="3229870">Open</span><span class="op" id="3229874">(</span><span class="ident" id="3229875">db</span><span class="op" id="3229877">.</span><span class="ident" id="3229878">dsn</span><span class="op" id="3229881">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3229884">db</span><span class="op" id="3229886">.</span><span class="ident" id="3229887">mu</span><span class="op" id="3229889">.</span><span class="ident" id="3229890">Lock</span><span class="op" id="3229894">(</span><span class="op" id="3229895">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3229898">defer</span>&nbsp;<span class="ident" id="3229904">db</span><span class="op" id="3229906">.</span><span class="ident" id="3229907">mu</span><span class="op" id="3229909">.</span><span class="ident" id="3229910">Unlock</span><span class="op" id="3229916">(</span><span class="op" id="3229917">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3229920">if</span>&nbsp;<span class="ident" id="3229923">db</span><span class="op" id="3229925">.</span><span class="ident" id="3229926">closed</span>&nbsp;<span class="op" id="3229933">{</span><br>
<span class="lineno">600</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3229937">if</span>&nbsp;<span class="ident" id="3229940">err</span>&nbsp;<span class="op" id="3229944">==</span>&nbsp;<span class="ident" id="3229947">nil</span>&nbsp;<span class="op" id="3229951">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3229956">ci</span><span class="op" id="3229958">.</span><span class="ident" id="3229959">Close</span><span class="op" id="3229964">(</span><span class="op" id="3229965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3229969">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3229973">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3229981">}</span><br>
<span class="lineno">605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3229984">db</span><span class="op" id="3229986">.</span><span class="ident" id="3229987">pendingOpens</span><span class="op" id="3229999">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3230003">if</span>&nbsp;<span class="ident" id="3230006">err</span>&nbsp;<span class="op" id="3230010">!=</span>&nbsp;<span class="ident" id="3230013">nil</span>&nbsp;<span class="op" id="3230017">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3230021">db</span><span class="op" id="3230023">.</span><span class="ident" id="3230024">putConnDBLocked</span><span class="op" id="3230039">(</span><span class="ident" id="3230040">nil</span><span class="op" id="3230043">,</span>&nbsp;<span class="ident" id="3230045">err</span><span class="op" id="3230048">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3230052">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3230060">}</span><br>
<span class="lineno">610</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3230063">dc</span>&nbsp;<span class="op" id="3230066">:=</span>&nbsp;<span class="op" id="3230069">&amp;</span><span class="ident" id="3230070">driverConn</span><span class="op" id="3230080">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3230084">db</span><span class="op" id="3230086">:</span>&nbsp;<span class="ident" id="3230088">db</span><span class="op" id="3230090">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3230094">ci</span><span class="op" id="3230096">:</span>&nbsp;<span class="ident" id="3230098">ci</span><span class="op" id="3230100">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3230103">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3230106">if</span>&nbsp;<span class="ident" id="3230109">db</span><span class="op" id="3230111">.</span><span class="ident" id="3230112">putConnDBLocked</span><span class="op" id="3230127">(</span><span class="ident" id="3230128">dc</span><span class="op" id="3230130">,</span>&nbsp;<span class="ident" id="3230132">err</span><span class="op" id="3230135">)</span>&nbsp;<span class="op" id="3230137">{</span><br>
<span class="lineno">615</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3230141">db</span><span class="op" id="3230143">.</span><span class="ident" id="3230144">addDepLocked</span><span class="op" id="3230156">(</span><span class="ident" id="3230157">dc</span><span class="op" id="3230159">,</span>&nbsp;<span class="ident" id="3230161">dc</span><span class="op" id="3230163">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3230167">db</span><span class="op" id="3230169">.</span><span class="ident" id="3230170">numOpen</span><span class="op" id="3230177">++</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3230181">}</span>&nbsp;<span class="keyword" id="3230183">else</span>&nbsp;<span class="op" id="3230188">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3230192">ci</span><span class="op" id="3230194">.</span><span class="ident" id="3230195">Close</span><span class="op" id="3230200">(</span><span class="op" id="3230201">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3230204">}</span><br>
<span class="lineno">620</span><span class="op" id="3230206">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3230209">//&nbsp;connRequest&nbsp;represents&nbsp;one&nbsp;request&nbsp;for&nbsp;a&nbsp;new&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="3230268">//&nbsp;When&nbsp;there&nbsp;are&nbsp;no&nbsp;idle&nbsp;connections&nbsp;available,&nbsp;DB.conn&nbsp;will&nbsp;create</span><br>
<span class="lineno"></span><span class="comment" id="3230337">//&nbsp;a&nbsp;new&nbsp;connRequest&nbsp;and&nbsp;put&nbsp;it&nbsp;on&nbsp;the&nbsp;db.connRequests&nbsp;list.</span><br>
<span class="lineno">625</span><span class="keyword" id="3230398">type</span>&nbsp;<span class="ident" id="3230403">connRequest</span>&nbsp;<span class="keyword" id="3230415">struct</span>&nbsp;<span class="op" id="3230422">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3230425">conn</span>&nbsp;<span class="op" id="3230430">*</span><span class="ident" id="3230431">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3230443">err</span>&nbsp;&nbsp;<span class="builtintype" id="3230448">error</span><br>
<span class="lineno"></span><span class="op" id="3230454">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">630</span><span class="keyword" id="3230457">var</span>&nbsp;<span class="ident" id="3230461">errDBClosed</span>&nbsp;<span class="op" id="3230473">=</span>&nbsp;<span class="ident" id="3230475">errors</span><span class="op" id="3230481">.</span><span class="ident" id="3230482">New</span><span class="op" id="3230485">(</span><span class="string" id="3230486">&#34;sql:&nbsp;database&nbsp;is&nbsp;closed&#34;</span><span class="op" id="3230511">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3230514">//&nbsp;conn&nbsp;returns&nbsp;a&nbsp;newly-opened&nbsp;or&nbsp;cached&nbsp;*driverConn</span><br>
<span class="lineno"></span><span class="keyword" id="3230567">func</span>&nbsp;<span class="op" id="3230572">(</span><span class="ident" id="3230573">db</span>&nbsp;<span class="op" id="3230576">*</span><span class="ident" id="3230577">DB</span><span class="op" id="3230579">)</span>&nbsp;<span class="ident" id="3230581">conn</span><span class="op" id="3230585">(</span><span class="op" id="3230586">)</span>&nbsp;<span class="op" id="3230588">(</span><span class="op" id="3230589">*</span><span class="ident" id="3230590">driverConn</span><span class="op" id="3230600">,</span>&nbsp;<span class="builtintype" id="3230602">error</span><span class="op" id="3230607">)</span>&nbsp;<span class="op" id="3230609">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3230612">db</span><span class="op" id="3230614">.</span><span class="ident" id="3230615">mu</span><span class="op" id="3230617">.</span><span class="ident" id="3230618">Lock</span><span class="op" id="3230622">(</span><span class="op" id="3230623">)</span><br>
<span class="lineno">635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3230626">if</span>&nbsp;<span class="ident" id="3230629">db</span><span class="op" id="3230631">.</span><span class="ident" id="3230632">closed</span>&nbsp;<span class="op" id="3230639">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3230643">db</span><span class="op" id="3230645">.</span><span class="ident" id="3230646">mu</span><span class="op" id="3230648">.</span><span class="ident" id="3230649">Unlock</span><span class="op" id="3230655">(</span><span class="op" id="3230656">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3230660">return</span>&nbsp;<span class="ident" id="3230667">nil</span><span class="op" id="3230670">,</span>&nbsp;<span class="ident" id="3230672">errDBClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3230685">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3230689">//&nbsp;If&nbsp;db.maxOpen&nbsp;&gt;&nbsp;0&nbsp;and&nbsp;the&nbsp;number&nbsp;of&nbsp;open&nbsp;connections&nbsp;is&nbsp;over&nbsp;the&nbsp;limit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3230764">//&nbsp;and&nbsp;there&nbsp;are&nbsp;no&nbsp;free&nbsp;connection,&nbsp;make&nbsp;a&nbsp;request&nbsp;and&nbsp;wait.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3230827">if</span>&nbsp;<span class="ident" id="3230830">db</span><span class="op" id="3230832">.</span><span class="ident" id="3230833">maxOpen</span>&nbsp;<span class="op" id="3230841">&gt;</span>&nbsp;<span class="num" id="3230843">0</span>&nbsp;<span class="op" id="3230845">&amp;&amp;</span>&nbsp;<span class="ident" id="3230848">db</span><span class="op" id="3230850">.</span><span class="ident" id="3230851">numOpen</span>&nbsp;<span class="op" id="3230859">&gt;=</span>&nbsp;<span class="ident" id="3230862">db</span><span class="op" id="3230864">.</span><span class="ident" id="3230865">maxOpen</span>&nbsp;<span class="op" id="3230873">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3230876">len</span><span class="op" id="3230879">(</span><span class="ident" id="3230880">db</span><span class="op" id="3230882">.</span><span class="ident" id="3230883">freeConn</span><span class="op" id="3230891">)</span>&nbsp;<span class="op" id="3230893">==</span>&nbsp;<span class="num" id="3230896">0</span>&nbsp;<span class="op" id="3230898">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3230902">//&nbsp;Make&nbsp;the&nbsp;connRequest&nbsp;channel.&nbsp;It&#39;s&nbsp;buffered&nbsp;so&nbsp;that&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3230963">//&nbsp;connectionOpener&nbsp;doesn&#39;t&nbsp;block&nbsp;while&nbsp;waiting&nbsp;for&nbsp;the&nbsp;req&nbsp;to&nbsp;be&nbsp;read.</span><br>
<span class="lineno">645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3231037">req</span>&nbsp;<span class="op" id="3231041">:=</span>&nbsp;<span class="builtinfunc" id="3231044">make</span><span class="op" id="3231048">(</span><span class="keyword" id="3231049">chan</span>&nbsp;<span class="ident" id="3231054">connRequest</span><span class="op" id="3231065">,</span>&nbsp;<span class="num" id="3231067">1</span><span class="op" id="3231068">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3231072">db</span><span class="op" id="3231074">.</span><span class="ident" id="3231075">connRequests</span>&nbsp;<span class="op" id="3231088">=</span>&nbsp;<span class="builtinfunc" id="3231090">append</span><span class="op" id="3231096">(</span><span class="ident" id="3231097">db</span><span class="op" id="3231099">.</span><span class="ident" id="3231100">connRequests</span><span class="op" id="3231112">,</span>&nbsp;<span class="ident" id="3231114">req</span><span class="op" id="3231117">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3231121">db</span><span class="op" id="3231123">.</span><span class="ident" id="3231124">maybeOpenNewConnections</span><span class="op" id="3231147">(</span><span class="op" id="3231148">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3231152">db</span><span class="op" id="3231154">.</span><span class="ident" id="3231155">mu</span><span class="op" id="3231157">.</span><span class="ident" id="3231158">Unlock</span><span class="op" id="3231164">(</span><span class="op" id="3231165">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3231169">ret</span>&nbsp;<span class="op" id="3231173">:=</span>&nbsp;<span class="op" id="3231176">&lt;-</span><span class="ident" id="3231178">req</span><br>
<span class="lineno">650</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3231184">return</span>&nbsp;<span class="ident" id="3231191">ret</span><span class="op" id="3231194">.</span><span class="ident" id="3231195">conn</span><span class="op" id="3231199">,</span>&nbsp;<span class="ident" id="3231201">ret</span><span class="op" id="3231204">.</span><span class="ident" id="3231205">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3231210">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3231214">if</span>&nbsp;<span class="ident" id="3231217">c</span>&nbsp;<span class="op" id="3231219">:=</span>&nbsp;<span class="builtinfunc" id="3231222">len</span><span class="op" id="3231225">(</span><span class="ident" id="3231226">db</span><span class="op" id="3231228">.</span><span class="ident" id="3231229">freeConn</span><span class="op" id="3231237">)</span><span class="op" id="3231238">;</span>&nbsp;<span class="ident" id="3231240">c</span>&nbsp;<span class="op" id="3231242">&gt;</span>&nbsp;<span class="num" id="3231244">0</span>&nbsp;<span class="op" id="3231246">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3231250">conn</span>&nbsp;<span class="op" id="3231255">:=</span>&nbsp;<span class="ident" id="3231258">db</span><span class="op" id="3231260">.</span><span class="ident" id="3231261">freeConn</span><span class="op" id="3231269">[</span><span class="num" id="3231270">0</span><span class="op" id="3231271">]</span><br>
<span class="lineno">655</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3231275">copy</span><span class="op" id="3231279">(</span><span class="ident" id="3231280">db</span><span class="op" id="3231282">.</span><span class="ident" id="3231283">freeConn</span><span class="op" id="3231291">,</span>&nbsp;<span class="ident" id="3231293">db</span><span class="op" id="3231295">.</span><span class="ident" id="3231296">freeConn</span><span class="op" id="3231304">[</span><span class="num" id="3231305">1</span><span class="op" id="3231306">:</span><span class="op" id="3231307">]</span><span class="op" id="3231308">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3231312">db</span><span class="op" id="3231314">.</span><span class="ident" id="3231315">freeConn</span>&nbsp;<span class="op" id="3231324">=</span>&nbsp;<span class="ident" id="3231326">db</span><span class="op" id="3231328">.</span><span class="ident" id="3231329">freeConn</span><span class="op" id="3231337">[</span><span class="op" id="3231338">:</span><span class="ident" id="3231339">c</span><span class="op" id="3231340">-</span><span class="num" id="3231341">1</span><span class="op" id="3231342">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3231346">conn</span><span class="op" id="3231350">.</span><span class="ident" id="3231351">inUse</span>&nbsp;<span class="op" id="3231357">=</span>&nbsp;<span class="builtintype" id="3231359">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3231366">db</span><span class="op" id="3231368">.</span><span class="ident" id="3231369">mu</span><span class="op" id="3231371">.</span><span class="ident" id="3231372">Unlock</span><span class="op" id="3231378">(</span><span class="op" id="3231379">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3231383">return</span>&nbsp;<span class="ident" id="3231390">conn</span><span class="op" id="3231394">,</span>&nbsp;<span class="ident" id="3231396">nil</span><br>
<span class="lineno">660</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3231401">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3231405">db</span><span class="op" id="3231407">.</span><span class="ident" id="3231408">numOpen</span><span class="op" id="3231415">++</span>&nbsp;<span class="comment" id="3231418">//&nbsp;optimistically</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3231437">db</span><span class="op" id="3231439">.</span><span class="ident" id="3231440">mu</span><span class="op" id="3231442">.</span><span class="ident" id="3231443">Unlock</span><span class="op" id="3231449">(</span><span class="op" id="3231450">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3231453">ci</span><span class="op" id="3231455">,</span>&nbsp;<span class="ident" id="3231457">err</span>&nbsp;<span class="op" id="3231461">:=</span>&nbsp;<span class="ident" id="3231464">db</span><span class="op" id="3231466">.</span><span class="ident" id="3231467">driver</span><span class="op" id="3231473">.</span><span class="ident" id="3231474">Open</span><span class="op" id="3231478">(</span><span class="ident" id="3231479">db</span><span class="op" id="3231481">.</span><span class="ident" id="3231482">dsn</span><span class="op" id="3231485">)</span><br>
<span class="lineno">665</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3231488">if</span>&nbsp;<span class="ident" id="3231491">err</span>&nbsp;<span class="op" id="3231495">!=</span>&nbsp;<span class="ident" id="3231498">nil</span>&nbsp;<span class="op" id="3231502">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3231506">db</span><span class="op" id="3231508">.</span><span class="ident" id="3231509">mu</span><span class="op" id="3231511">.</span><span class="ident" id="3231512">Lock</span><span class="op" id="3231516">(</span><span class="op" id="3231517">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3231521">db</span><span class="op" id="3231523">.</span><span class="ident" id="3231524">numOpen</span><span class="op" id="3231531">--</span>&nbsp;<span class="comment" id="3231534">//&nbsp;correct&nbsp;for&nbsp;earlier&nbsp;optimism</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3231568">db</span><span class="op" id="3231570">.</span><span class="ident" id="3231571">mu</span><span class="op" id="3231573">.</span><span class="ident" id="3231574">Unlock</span><span class="op" id="3231580">(</span><span class="op" id="3231581">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3231585">return</span>&nbsp;<span class="ident" id="3231592">nil</span><span class="op" id="3231595">,</span>&nbsp;<span class="ident" id="3231597">err</span><br>
<span class="lineno">670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3231602">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3231605">db</span><span class="op" id="3231607">.</span><span class="ident" id="3231608">mu</span><span class="op" id="3231610">.</span><span class="ident" id="3231611">Lock</span><span class="op" id="3231615">(</span><span class="op" id="3231616">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3231619">dc</span>&nbsp;<span class="op" id="3231622">:=</span>&nbsp;<span class="op" id="3231625">&amp;</span><span class="ident" id="3231626">driverConn</span><span class="op" id="3231636">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3231640">db</span><span class="op" id="3231642">:</span>&nbsp;<span class="ident" id="3231644">db</span><span class="op" id="3231646">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3231650">ci</span><span class="op" id="3231652">:</span>&nbsp;<span class="ident" id="3231654">ci</span><span class="op" id="3231656">,</span><br>
<span class="lineno">675</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3231659">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3231662">db</span><span class="op" id="3231664">.</span><span class="ident" id="3231665">addDepLocked</span><span class="op" id="3231677">(</span><span class="ident" id="3231678">dc</span><span class="op" id="3231680">,</span>&nbsp;<span class="ident" id="3231682">dc</span><span class="op" id="3231684">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3231687">dc</span><span class="op" id="3231689">.</span><span class="ident" id="3231690">inUse</span>&nbsp;<span class="op" id="3231696">=</span>&nbsp;<span class="builtintype" id="3231698">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3231704">db</span><span class="op" id="3231706">.</span><span class="ident" id="3231707">mu</span><span class="op" id="3231709">.</span><span class="ident" id="3231710">Unlock</span><span class="op" id="3231716">(</span><span class="op" id="3231717">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3231720">return</span>&nbsp;<span class="ident" id="3231727">dc</span><span class="op" id="3231729">,</span>&nbsp;<span class="ident" id="3231731">nil</span><br>
<span class="lineno">680</span><span class="op" id="3231735">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3231738">var</span>&nbsp;<span class="op" id="3231742">(</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3231745">errConnClosed</span>&nbsp;<span class="op" id="3231759">=</span>&nbsp;<span class="ident" id="3231761">errors</span><span class="op" id="3231767">.</span><span class="ident" id="3231768">New</span><span class="op" id="3231771">(</span><span class="string" id="3231772">&#34;database/sql:&nbsp;internal&nbsp;sentinel&nbsp;error:&nbsp;conn&nbsp;is&nbsp;closed&#34;</span><span class="op" id="3231827">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3231830">errConnBusy</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3231844">=</span>&nbsp;<span class="ident" id="3231846">errors</span><span class="op" id="3231852">.</span><span class="ident" id="3231853">New</span><span class="op" id="3231856">(</span><span class="string" id="3231857">&#34;database/sql:&nbsp;internal&nbsp;sentinel&nbsp;error:&nbsp;conn&nbsp;is&nbsp;busy&#34;</span><span class="op" id="3231910">)</span><br>
<span class="lineno">685</span><span class="op" id="3231912">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3231915">//&nbsp;connIfFree&nbsp;returns&nbsp;(wanted,&nbsp;nil)&nbsp;if&nbsp;wanted&nbsp;is&nbsp;still&nbsp;a&nbsp;valid&nbsp;conn&nbsp;and</span><br>
<span class="lineno"></span><span class="comment" id="3231987">//&nbsp;isn&#39;t&nbsp;in&nbsp;use.</span><br>
<span class="lineno"></span><span class="comment" id="3232004">//</span><br>
<span class="lineno">690</span><span class="comment" id="3232007">//&nbsp;The&nbsp;error&nbsp;is&nbsp;errConnClosed&nbsp;if&nbsp;the&nbsp;connection&nbsp;if&nbsp;the&nbsp;requested&nbsp;connection</span><br>
<span class="lineno"></span><span class="comment" id="3232083">//&nbsp;is&nbsp;invalid&nbsp;because&nbsp;it&#39;s&nbsp;been&nbsp;closed.</span><br>
<span class="lineno"></span><span class="comment" id="3232123">//</span><br>
<span class="lineno"></span><span class="comment" id="3232126">//&nbsp;The&nbsp;error&nbsp;is&nbsp;errConnBusy&nbsp;if&nbsp;the&nbsp;connection&nbsp;is&nbsp;in&nbsp;use.</span><br>
<span class="lineno"></span><span class="keyword" id="3232183">func</span>&nbsp;<span class="op" id="3232188">(</span><span class="ident" id="3232189">db</span>&nbsp;<span class="op" id="3232192">*</span><span class="ident" id="3232193">DB</span><span class="op" id="3232195">)</span>&nbsp;<span class="ident" id="3232197">connIfFree</span><span class="op" id="3232207">(</span><span class="ident" id="3232208">wanted</span>&nbsp;<span class="op" id="3232215">*</span><span class="ident" id="3232216">driverConn</span><span class="op" id="3232226">)</span>&nbsp;<span class="op" id="3232228">(</span><span class="op" id="3232229">*</span><span class="ident" id="3232230">driverConn</span><span class="op" id="3232240">,</span>&nbsp;<span class="builtintype" id="3232242">error</span><span class="op" id="3232247">)</span>&nbsp;<span class="op" id="3232249">{</span><br>
<span class="lineno">695</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3232252">db</span><span class="op" id="3232254">.</span><span class="ident" id="3232255">mu</span><span class="op" id="3232257">.</span><span class="ident" id="3232258">Lock</span><span class="op" id="3232262">(</span><span class="op" id="3232263">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3232266">defer</span>&nbsp;<span class="ident" id="3232272">db</span><span class="op" id="3232274">.</span><span class="ident" id="3232275">mu</span><span class="op" id="3232277">.</span><span class="ident" id="3232278">Unlock</span><span class="op" id="3232284">(</span><span class="op" id="3232285">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3232288">if</span>&nbsp;<span class="ident" id="3232291">wanted</span><span class="op" id="3232297">.</span><span class="ident" id="3232298">dbmuClosed</span>&nbsp;<span class="op" id="3232309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3232313">return</span>&nbsp;<span class="ident" id="3232320">nil</span><span class="op" id="3232323">,</span>&nbsp;<span class="ident" id="3232325">errConnClosed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3232340">}</span><br>
<span class="lineno">700</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3232343">if</span>&nbsp;<span class="ident" id="3232346">wanted</span><span class="op" id="3232352">.</span><span class="ident" id="3232353">inUse</span>&nbsp;<span class="op" id="3232359">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3232363">return</span>&nbsp;<span class="ident" id="3232370">nil</span><span class="op" id="3232373">,</span>&nbsp;<span class="ident" id="3232375">errConnBusy</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3232388">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3232391">idx</span>&nbsp;<span class="op" id="3232395">:=</span>&nbsp;<span class="op" id="3232398">-</span><span class="num" id="3232399">1</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3232402">for</span>&nbsp;<span class="ident" id="3232406">ii</span><span class="op" id="3232408">,</span>&nbsp;<span class="ident" id="3232410">v</span>&nbsp;<span class="op" id="3232412">:=</span>&nbsp;<span class="keyword" id="3232415">range</span>&nbsp;<span class="ident" id="3232421">db</span><span class="op" id="3232423">.</span><span class="ident" id="3232424">freeConn</span>&nbsp;<span class="op" id="3232433">{</span><br>
<span class="lineno">705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3232437">if</span>&nbsp;<span class="ident" id="3232440">v</span>&nbsp;<span class="op" id="3232442">==</span>&nbsp;<span class="ident" id="3232445">wanted</span>&nbsp;<span class="op" id="3232452">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3232457">idx</span>&nbsp;<span class="op" id="3232461">=</span>&nbsp;<span class="ident" id="3232463">ii</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3232469">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3232477">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3232480">}</span><br>
<span class="lineno">710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3232483">if</span>&nbsp;<span class="ident" id="3232486">idx</span>&nbsp;<span class="op" id="3232490">&gt;=</span>&nbsp;<span class="num" id="3232493">0</span>&nbsp;<span class="op" id="3232495">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3232499">db</span><span class="op" id="3232501">.</span><span class="ident" id="3232502">freeConn</span>&nbsp;<span class="op" id="3232511">=</span>&nbsp;<span class="builtinfunc" id="3232513">append</span><span class="op" id="3232519">(</span><span class="ident" id="3232520">db</span><span class="op" id="3232522">.</span><span class="ident" id="3232523">freeConn</span><span class="op" id="3232531">[</span><span class="op" id="3232532">:</span><span class="ident" id="3232533">idx</span><span class="op" id="3232536">]</span><span class="op" id="3232537">,</span>&nbsp;<span class="ident" id="3232539">db</span><span class="op" id="3232541">.</span><span class="ident" id="3232542">freeConn</span><span class="op" id="3232550">[</span><span class="ident" id="3232551">idx</span><span class="op" id="3232554">+</span><span class="num" id="3232555">1</span><span class="op" id="3232556">:</span><span class="op" id="3232557">]</span><span class="op" id="3232558">...</span><span class="op" id="3232561">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3232565">wanted</span><span class="op" id="3232571">.</span><span class="ident" id="3232572">inUse</span>&nbsp;<span class="op" id="3232578">=</span>&nbsp;<span class="builtintype" id="3232580">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3232587">return</span>&nbsp;<span class="ident" id="3232594">wanted</span><span class="op" id="3232600">,</span>&nbsp;<span class="ident" id="3232602">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3232607">}</span><br>
<span class="lineno">715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3232610">//&nbsp;TODO(bradfitz):&nbsp;shouldn&#39;t&nbsp;get&nbsp;here.&nbsp;After&nbsp;Go&nbsp;1.1,&nbsp;change&nbsp;this&nbsp;to:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3232680">//&nbsp;panic(&#34;connIfFree&nbsp;call&nbsp;requested&nbsp;a&nbsp;non-closed,&nbsp;non-busy,&nbsp;non-free&nbsp;conn&#34;)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3232757">//&nbsp;Which&nbsp;passes&nbsp;all&nbsp;the&nbsp;tests,&nbsp;but&nbsp;I&#39;m&nbsp;too&nbsp;paranoid&nbsp;to&nbsp;include&nbsp;this</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3232826">//&nbsp;late&nbsp;in&nbsp;Go&nbsp;1.1.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3232846">//&nbsp;Instead,&nbsp;treat&nbsp;it&nbsp;like&nbsp;a&nbsp;busy&nbsp;connection:</span><br>
<span class="lineno">720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3232892">return</span>&nbsp;<span class="ident" id="3232899">nil</span><span class="op" id="3232902">,</span>&nbsp;<span class="ident" id="3232904">errConnBusy</span><br>
<span class="lineno"></span><span class="op" id="3232916">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3232919">//&nbsp;putConnHook&nbsp;is&nbsp;a&nbsp;hook&nbsp;for&nbsp;testing.</span><br>
<span class="lineno"></span><span class="keyword" id="3232957">var</span>&nbsp;<span class="ident" id="3232961">putConnHook</span>&nbsp;<span class="keyword" id="3232973">func</span><span class="op" id="3232977">(</span><span class="op" id="3232978">*</span><span class="ident" id="3232979">DB</span><span class="op" id="3232981">,</span>&nbsp;<span class="op" id="3232983">*</span><span class="ident" id="3232984">driverConn</span><span class="op" id="3232994">)</span><br>
<span class="lineno">725</span><br>
<span class="lineno"></span><span class="comment" id="3232997">//&nbsp;noteUnusedDriverStatement&nbsp;notes&nbsp;that&nbsp;si&nbsp;is&nbsp;no&nbsp;longer&nbsp;used&nbsp;and&nbsp;should</span><br>
<span class="lineno"></span><span class="comment" id="3233069">//&nbsp;be&nbsp;closed&nbsp;whenever&nbsp;possible&nbsp;(when&nbsp;c&nbsp;is&nbsp;next&nbsp;not&nbsp;in&nbsp;use),&nbsp;unless&nbsp;c&nbsp;is</span><br>
<span class="lineno"></span><span class="comment" id="3233141">//&nbsp;already&nbsp;closed.</span><br>
<span class="lineno"></span><span class="keyword" id="3233160">func</span>&nbsp;<span class="op" id="3233165">(</span><span class="ident" id="3233166">db</span>&nbsp;<span class="op" id="3233169">*</span><span class="ident" id="3233170">DB</span><span class="op" id="3233172">)</span>&nbsp;<span class="ident" id="3233174">noteUnusedDriverStatement</span><span class="op" id="3233199">(</span><span class="ident" id="3233200">c</span>&nbsp;<span class="op" id="3233202">*</span><span class="ident" id="3233203">driverConn</span><span class="op" id="3233213">,</span>&nbsp;<span class="ident" id="3233215">si</span>&nbsp;<span class="ident" id="3233218">driver</span><span class="op" id="3233224">.</span><span class="ident" id="3233225">Stmt</span><span class="op" id="3233229">)</span>&nbsp;<span class="op" id="3233231">{</span><br>
<span class="lineno">730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3233234">db</span><span class="op" id="3233236">.</span><span class="ident" id="3233237">mu</span><span class="op" id="3233239">.</span><span class="ident" id="3233240">Lock</span><span class="op" id="3233244">(</span><span class="op" id="3233245">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3233248">defer</span>&nbsp;<span class="ident" id="3233254">db</span><span class="op" id="3233256">.</span><span class="ident" id="3233257">mu</span><span class="op" id="3233259">.</span><span class="ident" id="3233260">Unlock</span><span class="op" id="3233266">(</span><span class="op" id="3233267">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3233270">if</span>&nbsp;<span class="ident" id="3233273">c</span><span class="op" id="3233274">.</span><span class="ident" id="3233275">inUse</span>&nbsp;<span class="op" id="3233281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3233285">c</span><span class="op" id="3233286">.</span><span class="ident" id="3233287">onPut</span>&nbsp;<span class="op" id="3233293">=</span>&nbsp;<span class="builtinfunc" id="3233295">append</span><span class="op" id="3233301">(</span><span class="ident" id="3233302">c</span><span class="op" id="3233303">.</span><span class="ident" id="3233304">onPut</span><span class="op" id="3233309">,</span>&nbsp;<span class="keyword" id="3233311">func</span><span class="op" id="3233315">(</span><span class="op" id="3233316">)</span>&nbsp;<span class="op" id="3233318">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3233323">si</span><span class="op" id="3233325">.</span><span class="ident" id="3233326">Close</span><span class="op" id="3233331">(</span><span class="op" id="3233332">)</span><br>
<span class="lineno">735</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3233336">}</span><span class="op" id="3233337">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3233340">}</span>&nbsp;<span class="keyword" id="3233342">else</span>&nbsp;<span class="op" id="3233347">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3233351">c</span><span class="op" id="3233352">.</span><span class="ident" id="3233353">Lock</span><span class="op" id="3233357">(</span><span class="op" id="3233358">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3233362">defer</span>&nbsp;<span class="ident" id="3233368">c</span><span class="op" id="3233369">.</span><span class="ident" id="3233370">Unlock</span><span class="op" id="3233376">(</span><span class="op" id="3233377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3233381">if</span>&nbsp;<span class="op" id="3233384">!</span><span class="ident" id="3233385">c</span><span class="op" id="3233386">.</span><span class="ident" id="3233387">finalClosed</span>&nbsp;<span class="op" id="3233399">{</span><br>
<span class="lineno">740</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3233404">si</span><span class="op" id="3233406">.</span><span class="ident" id="3233407">Close</span><span class="op" id="3233412">(</span><span class="op" id="3233413">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3233417">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3233420">}</span><br>
<span class="lineno"></span><span class="op" id="3233422">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">745</span><span class="comment" id="3233425">//&nbsp;debugGetPut&nbsp;determines&nbsp;whether&nbsp;getConn&nbsp;&amp;&nbsp;putConn&nbsp;calls&#39;&nbsp;stack&nbsp;traces</span><br>
<span class="lineno"></span><span class="comment" id="3233497">//&nbsp;are&nbsp;returned&nbsp;for&nbsp;more&nbsp;verbose&nbsp;crashes.</span><br>
<span class="lineno"></span><span class="keyword" id="3233539">const</span>&nbsp;<span class="ident" id="3233545">debugGetPut</span>&nbsp;<span class="op" id="3233557">=</span>&nbsp;<span class="builtintype" id="3233559">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3233566">//&nbsp;putConn&nbsp;adds&nbsp;a&nbsp;connection&nbsp;to&nbsp;the&nbsp;db&#39;s&nbsp;free&nbsp;pool.</span><br>
<span class="lineno">750</span><span class="comment" id="3233618">//&nbsp;err&nbsp;is&nbsp;optionally&nbsp;the&nbsp;last&nbsp;error&nbsp;that&nbsp;occurred&nbsp;on&nbsp;this&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3233688">func</span>&nbsp;<span class="op" id="3233693">(</span><span class="ident" id="3233694">db</span>&nbsp;<span class="op" id="3233697">*</span><span class="ident" id="3233698">DB</span><span class="op" id="3233700">)</span>&nbsp;<span class="ident" id="3233702">putConn</span><span class="op" id="3233709">(</span><span class="ident" id="3233710">dc</span>&nbsp;<span class="op" id="3233713">*</span><span class="ident" id="3233714">driverConn</span><span class="op" id="3233724">,</span>&nbsp;<span class="ident" id="3233726">err</span>&nbsp;<span class="builtintype" id="3233730">error</span><span class="op" id="3233735">)</span>&nbsp;<span class="op" id="3233737">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3233740">db</span><span class="op" id="3233742">.</span><span class="ident" id="3233743">mu</span><span class="op" id="3233745">.</span><span class="ident" id="3233746">Lock</span><span class="op" id="3233750">(</span><span class="op" id="3233751">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3233754">if</span>&nbsp;<span class="op" id="3233757">!</span><span class="ident" id="3233758">dc</span><span class="op" id="3233760">.</span><span class="ident" id="3233761">inUse</span>&nbsp;<span class="op" id="3233767">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3233771">if</span>&nbsp;<span class="ident" id="3233774">debugGetPut</span>&nbsp;<span class="op" id="3233786">{</span><br>
<span class="lineno">755</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3233791">fmt</span><span class="op" id="3233794">.</span><span class="ident" id="3233795">Printf</span><span class="op" id="3233801">(</span><span class="string" id="3233802">&#34;putConn(%v)&nbsp;DUPLICATE&nbsp;was:&nbsp;%s\n\nPREVIOUS&nbsp;was:&nbsp;%s&#34;</span><span class="op" id="3233853">,</span>&nbsp;<span class="ident" id="3233855">dc</span><span class="op" id="3233857">,</span>&nbsp;<span class="ident" id="3233859">stack</span><span class="op" id="3233864">(</span><span class="op" id="3233865">)</span><span class="op" id="3233866">,</span>&nbsp;<span class="ident" id="3233868">db</span><span class="op" id="3233870">.</span><span class="ident" id="3233871">lastPut</span><span class="op" id="3233878">[</span><span class="ident" id="3233879">dc</span><span class="op" id="3233881">]</span><span class="op" id="3233882">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3233886">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3233890">panic</span><span class="op" id="3233895">(</span><span class="string" id="3233896">&#34;sql:&nbsp;connection&nbsp;returned&nbsp;that&nbsp;was&nbsp;never&nbsp;out&#34;</span><span class="op" id="3233941">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3233944">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3233947">if</span>&nbsp;<span class="ident" id="3233950">debugGetPut</span>&nbsp;<span class="op" id="3233962">{</span><br>
<span class="lineno">760</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3233966">db</span><span class="op" id="3233968">.</span><span class="ident" id="3233969">lastPut</span><span class="op" id="3233976">[</span><span class="ident" id="3233977">dc</span><span class="op" id="3233979">]</span>&nbsp;<span class="op" id="3233981">=</span>&nbsp;<span class="ident" id="3233983">stack</span><span class="op" id="3233988">(</span><span class="op" id="3233989">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3233992">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3233995">dc</span><span class="op" id="3233997">.</span><span class="ident" id="3233998">inUse</span>&nbsp;<span class="op" id="3234004">=</span>&nbsp;<span class="builtintype" id="3234006">false</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3234014">for</span>&nbsp;<span class="ident" id="3234018">_</span><span class="op" id="3234019">,</span>&nbsp;<span class="ident" id="3234021">fn</span>&nbsp;<span class="op" id="3234024">:=</span>&nbsp;<span class="keyword" id="3234027">range</span>&nbsp;<span class="ident" id="3234033">dc</span><span class="op" id="3234035">.</span><span class="ident" id="3234036">onPut</span>&nbsp;<span class="op" id="3234042">{</span><br>
<span class="lineno">765</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3234046">fn</span><span class="op" id="3234048">(</span><span class="op" id="3234049">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3234052">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3234055">dc</span><span class="op" id="3234057">.</span><span class="ident" id="3234058">onPut</span>&nbsp;<span class="op" id="3234064">=</span>&nbsp;<span class="ident" id="3234066">nil</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3234072">if</span>&nbsp;<span class="ident" id="3234075">err</span>&nbsp;<span class="op" id="3234079">==</span>&nbsp;<span class="ident" id="3234082">driver</span><span class="op" id="3234088">.</span><span class="ident" id="3234089">ErrBadConn</span>&nbsp;<span class="op" id="3234100">{</span><br>
<span class="lineno">770</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3234104">//&nbsp;Don&#39;t&nbsp;reuse&nbsp;bad&nbsp;connections.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3234138">//&nbsp;Since&nbsp;the&nbsp;conn&nbsp;is&nbsp;considered&nbsp;bad&nbsp;and&nbsp;is&nbsp;being&nbsp;discarded,&nbsp;treat&nbsp;it</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3234209">//&nbsp;as&nbsp;closed.&nbsp;Don&#39;t&nbsp;decrement&nbsp;the&nbsp;open&nbsp;count&nbsp;here,&nbsp;finalClose&nbsp;will</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3234278">//&nbsp;take&nbsp;care&nbsp;of&nbsp;that.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3234302">db</span><span class="op" id="3234304">.</span><span class="ident" id="3234305">maybeOpenNewConnections</span><span class="op" id="3234328">(</span><span class="op" id="3234329">)</span><br>
<span class="lineno">775</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3234333">db</span><span class="op" id="3234335">.</span><span class="ident" id="3234336">mu</span><span class="op" id="3234338">.</span><span class="ident" id="3234339">Unlock</span><span class="op" id="3234345">(</span><span class="op" id="3234346">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3234350">dc</span><span class="op" id="3234352">.</span><span class="ident" id="3234353">Close</span><span class="op" id="3234358">(</span><span class="op" id="3234359">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3234363">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3234371">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3234374">if</span>&nbsp;<span class="ident" id="3234377">putConnHook</span>&nbsp;<span class="op" id="3234389">!=</span>&nbsp;<span class="ident" id="3234392">nil</span>&nbsp;<span class="op" id="3234396">{</span><br>
<span class="lineno">780</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3234400">putConnHook</span><span class="op" id="3234411">(</span><span class="ident" id="3234412">db</span><span class="op" id="3234414">,</span>&nbsp;<span class="ident" id="3234416">dc</span><span class="op" id="3234418">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3234421">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3234424">added</span>&nbsp;<span class="op" id="3234430">:=</span>&nbsp;<span class="ident" id="3234433">db</span><span class="op" id="3234435">.</span><span class="ident" id="3234436">putConnDBLocked</span><span class="op" id="3234451">(</span><span class="ident" id="3234452">dc</span><span class="op" id="3234454">,</span>&nbsp;<span class="ident" id="3234456">nil</span><span class="op" id="3234459">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3234462">db</span><span class="op" id="3234464">.</span><span class="ident" id="3234465">mu</span><span class="op" id="3234467">.</span><span class="ident" id="3234468">Unlock</span><span class="op" id="3234474">(</span><span class="op" id="3234475">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">785</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3234479">if</span>&nbsp;<span class="op" id="3234482">!</span><span class="ident" id="3234483">added</span>&nbsp;<span class="op" id="3234489">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3234493">dc</span><span class="op" id="3234495">.</span><span class="ident" id="3234496">Close</span><span class="op" id="3234501">(</span><span class="op" id="3234502">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3234505">}</span><br>
<span class="lineno"></span><span class="op" id="3234507">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">790</span><span class="comment" id="3234510">//&nbsp;Satisfy&nbsp;a&nbsp;connRequest&nbsp;or&nbsp;put&nbsp;the&nbsp;driverConn&nbsp;in&nbsp;the&nbsp;idle&nbsp;pool&nbsp;and&nbsp;return&nbsp;true</span><br>
<span class="lineno"></span><span class="comment" id="3234590">//&nbsp;or&nbsp;return&nbsp;false.</span><br>
<span class="lineno"></span><span class="comment" id="3234610">//&nbsp;putConnDBLocked&nbsp;will&nbsp;satisfy&nbsp;a&nbsp;connRequest&nbsp;if&nbsp;there&nbsp;is&nbsp;one,&nbsp;or&nbsp;it&nbsp;will</span><br>
<span class="lineno"></span><span class="comment" id="3234684">//&nbsp;return&nbsp;the&nbsp;*driverConn&nbsp;to&nbsp;the&nbsp;freeConn&nbsp;list&nbsp;if&nbsp;err&nbsp;==&nbsp;nil&nbsp;and&nbsp;the&nbsp;idle</span><br>
<span class="lineno"></span><span class="comment" id="3234758">//&nbsp;connection&nbsp;limit&nbsp;will&nbsp;not&nbsp;be&nbsp;exceeded.</span><br>
<span class="lineno">795</span><span class="comment" id="3234800">//&nbsp;If&nbsp;err&nbsp;!=&nbsp;nil,&nbsp;the&nbsp;value&nbsp;of&nbsp;dc&nbsp;is&nbsp;ignored.</span><br>
<span class="lineno"></span><span class="comment" id="3234846">//&nbsp;If&nbsp;err&nbsp;==&nbsp;nil,&nbsp;then&nbsp;dc&nbsp;must&nbsp;not&nbsp;equal&nbsp;nil.</span><br>
<span class="lineno"></span><span class="comment" id="3234892">//&nbsp;If&nbsp;a&nbsp;connRequest&nbsp;was&nbsp;fulfilled&nbsp;or&nbsp;the&nbsp;*driverConn&nbsp;was&nbsp;placed&nbsp;in&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3234963">//&nbsp;freeConn&nbsp;list,&nbsp;then&nbsp;true&nbsp;is&nbsp;returned,&nbsp;otherwise&nbsp;false&nbsp;is&nbsp;returned.</span><br>
<span class="lineno"></span><span class="keyword" id="3235033">func</span>&nbsp;<span class="op" id="3235038">(</span><span class="ident" id="3235039">db</span>&nbsp;<span class="op" id="3235042">*</span><span class="ident" id="3235043">DB</span><span class="op" id="3235045">)</span>&nbsp;<span class="ident" id="3235047">putConnDBLocked</span><span class="op" id="3235062">(</span><span class="ident" id="3235063">dc</span>&nbsp;<span class="op" id="3235066">*</span><span class="ident" id="3235067">driverConn</span><span class="op" id="3235077">,</span>&nbsp;<span class="ident" id="3235079">err</span>&nbsp;<span class="builtintype" id="3235083">error</span><span class="op" id="3235088">)</span>&nbsp;<span class="builtintype" id="3235090">bool</span>&nbsp;<span class="op" id="3235095">{</span><br>
<span class="lineno">800</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3235098">if</span>&nbsp;<span class="ident" id="3235101">c</span>&nbsp;<span class="op" id="3235103">:=</span>&nbsp;<span class="builtinfunc" id="3235106">len</span><span class="op" id="3235109">(</span><span class="ident" id="3235110">db</span><span class="op" id="3235112">.</span><span class="ident" id="3235113">connRequests</span><span class="op" id="3235125">)</span><span class="op" id="3235126">;</span>&nbsp;<span class="ident" id="3235128">c</span>&nbsp;<span class="op" id="3235130">&gt;</span>&nbsp;<span class="num" id="3235132">0</span>&nbsp;<span class="op" id="3235134">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3235138">req</span>&nbsp;<span class="op" id="3235142">:=</span>&nbsp;<span class="ident" id="3235145">db</span><span class="op" id="3235147">.</span><span class="ident" id="3235148">connRequests</span><span class="op" id="3235160">[</span><span class="num" id="3235161">0</span><span class="op" id="3235162">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3235166">//&nbsp;This&nbsp;copy&nbsp;is&nbsp;O(n)&nbsp;but&nbsp;in&nbsp;practice&nbsp;faster&nbsp;than&nbsp;a&nbsp;linked&nbsp;list.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3235232">//&nbsp;TODO:&nbsp;consider&nbsp;compacting&nbsp;it&nbsp;down&nbsp;less&nbsp;often&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3235286">//&nbsp;moving&nbsp;the&nbsp;base&nbsp;instead?</span><br>
<span class="lineno">805</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3235316">copy</span><span class="op" id="3235320">(</span><span class="ident" id="3235321">db</span><span class="op" id="3235323">.</span><span class="ident" id="3235324">connRequests</span><span class="op" id="3235336">,</span>&nbsp;<span class="ident" id="3235338">db</span><span class="op" id="3235340">.</span><span class="ident" id="3235341">connRequests</span><span class="op" id="3235353">[</span><span class="num" id="3235354">1</span><span class="op" id="3235355">:</span><span class="op" id="3235356">]</span><span class="op" id="3235357">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3235361">db</span><span class="op" id="3235363">.</span><span class="ident" id="3235364">connRequests</span>&nbsp;<span class="op" id="3235377">=</span>&nbsp;<span class="ident" id="3235379">db</span><span class="op" id="3235381">.</span><span class="ident" id="3235382">connRequests</span><span class="op" id="3235394">[</span><span class="op" id="3235395">:</span><span class="ident" id="3235396">c</span><span class="op" id="3235397">-</span><span class="num" id="3235398">1</span><span class="op" id="3235399">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3235403">if</span>&nbsp;<span class="ident" id="3235406">err</span>&nbsp;<span class="op" id="3235410">==</span>&nbsp;<span class="ident" id="3235413">nil</span>&nbsp;<span class="op" id="3235417">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3235422">dc</span><span class="op" id="3235424">.</span><span class="ident" id="3235425">inUse</span>&nbsp;<span class="op" id="3235431">=</span>&nbsp;<span class="builtintype" id="3235433">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3235440">}</span><br>
<span class="lineno">810</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3235444">req</span>&nbsp;<span class="op" id="3235448">&lt;-</span>&nbsp;<span class="ident" id="3235451">connRequest</span><span class="op" id="3235462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3235467">conn</span><span class="op" id="3235471">:</span>&nbsp;<span class="ident" id="3235473">dc</span><span class="op" id="3235475">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3235480">err</span><span class="op" id="3235483">:</span>&nbsp;&nbsp;<span class="ident" id="3235486">err</span><span class="op" id="3235489">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3235493">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3235497">return</span>&nbsp;<span class="builtintype" id="3235504">true</span><br>
<span class="lineno">815</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3235510">}</span>&nbsp;<span class="keyword" id="3235512">else</span>&nbsp;<span class="keyword" id="3235517">if</span>&nbsp;<span class="ident" id="3235520">err</span>&nbsp;<span class="op" id="3235524">==</span>&nbsp;<span class="ident" id="3235527">nil</span>&nbsp;<span class="op" id="3235531">&amp;&amp;</span>&nbsp;<span class="op" id="3235534">!</span><span class="ident" id="3235535">db</span><span class="op" id="3235537">.</span><span class="ident" id="3235538">closed</span>&nbsp;<span class="op" id="3235545">&amp;&amp;</span>&nbsp;<span class="ident" id="3235548">db</span><span class="op" id="3235550">.</span><span class="ident" id="3235551">maxIdleConnsLocked</span><span class="op" id="3235569">(</span><span class="op" id="3235570">)</span>&nbsp;<span class="op" id="3235572">&gt;</span>&nbsp;<span class="builtinfunc" id="3235574">len</span><span class="op" id="3235577">(</span><span class="ident" id="3235578">db</span><span class="op" id="3235580">.</span><span class="ident" id="3235581">freeConn</span><span class="op" id="3235589">)</span>&nbsp;<span class="op" id="3235591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3235595">db</span><span class="op" id="3235597">.</span><span class="ident" id="3235598">freeConn</span>&nbsp;<span class="op" id="3235607">=</span>&nbsp;<span class="builtinfunc" id="3235609">append</span><span class="op" id="3235615">(</span><span class="ident" id="3235616">db</span><span class="op" id="3235618">.</span><span class="ident" id="3235619">freeConn</span><span class="op" id="3235627">,</span>&nbsp;<span class="ident" id="3235629">dc</span><span class="op" id="3235631">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3235635">return</span>&nbsp;<span class="builtintype" id="3235642">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3235648">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3235651">return</span>&nbsp;<span class="builtintype" id="3235658">false</span><br>
<span class="lineno">820</span><span class="op" id="3235664">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3235667">//&nbsp;maxBadConnRetries&nbsp;is&nbsp;the&nbsp;number&nbsp;of&nbsp;maximum&nbsp;retries&nbsp;if&nbsp;the&nbsp;driver&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="3235743">//&nbsp;driver.ErrBadConn&nbsp;to&nbsp;signal&nbsp;a&nbsp;broken&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3235795">const</span>&nbsp;<span class="ident" id="3235801">maxBadConnRetries</span>&nbsp;<span class="op" id="3235819">=</span>&nbsp;<span class="num" id="3235821">10</span><br>
<span class="lineno">825</span><br>
<span class="lineno"></span><span class="comment" id="3235825">//&nbsp;Prepare&nbsp;creates&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;for&nbsp;later&nbsp;queries&nbsp;or&nbsp;executions.</span><br>
<span class="lineno"></span><span class="comment" id="3235898">//&nbsp;Multiple&nbsp;queries&nbsp;or&nbsp;executions&nbsp;may&nbsp;be&nbsp;run&nbsp;concurrently&nbsp;from&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3235965">//&nbsp;returned&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="3235988">func</span>&nbsp;<span class="op" id="3235993">(</span><span class="ident" id="3235994">db</span>&nbsp;<span class="op" id="3235997">*</span><span class="ident" id="3235998">DB</span><span class="op" id="3236000">)</span>&nbsp;<span class="ident" id="3236002">Prepare</span><span class="op" id="3236009">(</span><span class="ident" id="3236010">query</span>&nbsp;<span class="builtintype" id="3236016">string</span><span class="op" id="3236022">)</span>&nbsp;<span class="op" id="3236024">(</span><span class="op" id="3236025">*</span><span class="ident" id="3236026">Stmt</span><span class="op" id="3236030">,</span>&nbsp;<span class="builtintype" id="3236032">error</span><span class="op" id="3236037">)</span>&nbsp;<span class="op" id="3236039">{</span><br>
<span class="lineno">830</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3236042">var</span>&nbsp;<span class="ident" id="3236046">stmt</span>&nbsp;<span class="op" id="3236051">*</span><span class="ident" id="3236052">Stmt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3236058">var</span>&nbsp;<span class="ident" id="3236062">err</span>&nbsp;<span class="builtintype" id="3236066">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3236073">for</span>&nbsp;<span class="ident" id="3236077">i</span>&nbsp;<span class="op" id="3236079">:=</span>&nbsp;<span class="num" id="3236082">0</span><span class="op" id="3236083">;</span>&nbsp;<span class="ident" id="3236085">i</span>&nbsp;<span class="op" id="3236087">&lt;</span>&nbsp;<span class="ident" id="3236089">maxBadConnRetries</span><span class="op" id="3236106">;</span>&nbsp;<span class="ident" id="3236108">i</span><span class="op" id="3236109">++</span>&nbsp;<span class="op" id="3236112">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3236116">stmt</span><span class="op" id="3236120">,</span>&nbsp;<span class="ident" id="3236122">err</span>&nbsp;<span class="op" id="3236126">=</span>&nbsp;<span class="ident" id="3236128">db</span><span class="op" id="3236130">.</span><span class="ident" id="3236131">prepare</span><span class="op" id="3236138">(</span><span class="ident" id="3236139">query</span><span class="op" id="3236144">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3236148">if</span>&nbsp;<span class="ident" id="3236151">err</span>&nbsp;<span class="op" id="3236155">!=</span>&nbsp;<span class="ident" id="3236158">driver</span><span class="op" id="3236164">.</span><span class="ident" id="3236165">ErrBadConn</span>&nbsp;<span class="op" id="3236176">{</span><br>
<span class="lineno">835</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3236181">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3236189">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3236192">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3236195">return</span>&nbsp;<span class="ident" id="3236202">stmt</span><span class="op" id="3236206">,</span>&nbsp;<span class="ident" id="3236208">err</span><br>
<span class="lineno"></span><span class="op" id="3236212">}</span><br>
<span class="lineno">840</span><br>
<span class="lineno"></span><span class="keyword" id="3236215">func</span>&nbsp;<span class="op" id="3236220">(</span><span class="ident" id="3236221">db</span>&nbsp;<span class="op" id="3236224">*</span><span class="ident" id="3236225">DB</span><span class="op" id="3236227">)</span>&nbsp;<span class="ident" id="3236229">prepare</span><span class="op" id="3236236">(</span><span class="ident" id="3236237">query</span>&nbsp;<span class="builtintype" id="3236243">string</span><span class="op" id="3236249">)</span>&nbsp;<span class="op" id="3236251">(</span><span class="op" id="3236252">*</span><span class="ident" id="3236253">Stmt</span><span class="op" id="3236257">,</span>&nbsp;<span class="builtintype" id="3236259">error</span><span class="op" id="3236264">)</span>&nbsp;<span class="op" id="3236266">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3236269">//&nbsp;TODO:&nbsp;check&nbsp;if&nbsp;db.driver&nbsp;supports&nbsp;an&nbsp;optional</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3236319">//&nbsp;driver.Preparer&nbsp;interface&nbsp;and&nbsp;call&nbsp;that&nbsp;instead,&nbsp;if&nbsp;so,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3236379">//&nbsp;otherwise&nbsp;we&nbsp;make&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;that&#39;s&nbsp;bound</span><br>
<span class="lineno">845</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3236435">//&nbsp;to&nbsp;a&nbsp;connection,&nbsp;and&nbsp;to&nbsp;execute&nbsp;this&nbsp;prepared&nbsp;statement</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3236495">//&nbsp;we&nbsp;either&nbsp;need&nbsp;to&nbsp;use&nbsp;this&nbsp;connection&nbsp;(if&nbsp;it&#39;s&nbsp;free),&nbsp;else</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3236558">//&nbsp;get&nbsp;a&nbsp;new&nbsp;connection&nbsp;+&nbsp;re-prepare&nbsp;+&nbsp;execute&nbsp;on&nbsp;that&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3236619">dc</span><span class="op" id="3236621">,</span>&nbsp;<span class="ident" id="3236623">err</span>&nbsp;<span class="op" id="3236627">:=</span>&nbsp;<span class="ident" id="3236630">db</span><span class="op" id="3236632">.</span><span class="ident" id="3236633">conn</span><span class="op" id="3236637">(</span><span class="op" id="3236638">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3236641">if</span>&nbsp;<span class="ident" id="3236644">err</span>&nbsp;<span class="op" id="3236648">!=</span>&nbsp;<span class="ident" id="3236651">nil</span>&nbsp;<span class="op" id="3236655">{</span><br>
<span class="lineno">850</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3236659">return</span>&nbsp;<span class="ident" id="3236666">nil</span><span class="op" id="3236669">,</span>&nbsp;<span class="ident" id="3236671">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3236676">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3236679">dc</span><span class="op" id="3236681">.</span><span class="ident" id="3236682">Lock</span><span class="op" id="3236686">(</span><span class="op" id="3236687">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3236690">si</span><span class="op" id="3236692">,</span>&nbsp;<span class="ident" id="3236694">err</span>&nbsp;<span class="op" id="3236698">:=</span>&nbsp;<span class="ident" id="3236701">dc</span><span class="op" id="3236703">.</span><span class="ident" id="3236704">prepareLocked</span><span class="op" id="3236717">(</span><span class="ident" id="3236718">query</span><span class="op" id="3236723">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3236726">dc</span><span class="op" id="3236728">.</span><span class="ident" id="3236729">Unlock</span><span class="op" id="3236735">(</span><span class="op" id="3236736">)</span><br>
<span class="lineno">855</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3236739">if</span>&nbsp;<span class="ident" id="3236742">err</span>&nbsp;<span class="op" id="3236746">!=</span>&nbsp;<span class="ident" id="3236749">nil</span>&nbsp;<span class="op" id="3236753">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3236757">db</span><span class="op" id="3236759">.</span><span class="ident" id="3236760">putConn</span><span class="op" id="3236767">(</span><span class="ident" id="3236768">dc</span><span class="op" id="3236770">,</span>&nbsp;<span class="ident" id="3236772">err</span><span class="op" id="3236775">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3236779">return</span>&nbsp;<span class="ident" id="3236786">nil</span><span class="op" id="3236789">,</span>&nbsp;<span class="ident" id="3236791">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3236796">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3236799">stmt</span>&nbsp;<span class="op" id="3236804">:=</span>&nbsp;<span class="op" id="3236807">&amp;</span><span class="ident" id="3236808">Stmt</span><span class="op" id="3236812">{</span><br>
<span class="lineno">860</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3236816">db</span><span class="op" id="3236818">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3236823">db</span><span class="op" id="3236825">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3236829">query</span><span class="op" id="3236834">:</span>&nbsp;<span class="ident" id="3236836">query</span><span class="op" id="3236841">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3236845">css</span><span class="op" id="3236848">:</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3236852">[</span><span class="op" id="3236853">]</span><span class="ident" id="3236854">connStmt</span><span class="op" id="3236862">{</span><span class="op" id="3236863">{</span><span class="ident" id="3236864">dc</span><span class="op" id="3236866">,</span>&nbsp;<span class="ident" id="3236868">si</span><span class="op" id="3236870">}</span><span class="op" id="3236871">}</span><span class="op" id="3236872">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3236875">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3236878">db</span><span class="op" id="3236880">.</span><span class="ident" id="3236881">addDep</span><span class="op" id="3236887">(</span><span class="ident" id="3236888">stmt</span><span class="op" id="3236892">,</span>&nbsp;<span class="ident" id="3236894">stmt</span><span class="op" id="3236898">)</span><br>
<span class="lineno">865</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3236901">db</span><span class="op" id="3236903">.</span><span class="ident" id="3236904">putConn</span><span class="op" id="3236911">(</span><span class="ident" id="3236912">dc</span><span class="op" id="3236914">,</span>&nbsp;<span class="ident" id="3236916">nil</span><span class="op" id="3236919">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3236922">return</span>&nbsp;<span class="ident" id="3236929">stmt</span><span class="op" id="3236933">,</span>&nbsp;<span class="ident" id="3236935">nil</span><br>
<span class="lineno"></span><span class="op" id="3236939">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3236942">//&nbsp;Exec&nbsp;executes&nbsp;a&nbsp;query&nbsp;without&nbsp;returning&nbsp;any&nbsp;rows.</span><br>
<span class="lineno">870</span><span class="comment" id="3236995">//&nbsp;The&nbsp;args&nbsp;are&nbsp;for&nbsp;any&nbsp;placeholder&nbsp;parameters&nbsp;in&nbsp;the&nbsp;query.</span><br>
<span class="lineno"></span><span class="keyword" id="3237056">func</span>&nbsp;<span class="op" id="3237061">(</span><span class="ident" id="3237062">db</span>&nbsp;<span class="op" id="3237065">*</span><span class="ident" id="3237066">DB</span><span class="op" id="3237068">)</span>&nbsp;<span class="ident" id="3237070">Exec</span><span class="op" id="3237074">(</span><span class="ident" id="3237075">query</span>&nbsp;<span class="builtintype" id="3237081">string</span><span class="op" id="3237087">,</span>&nbsp;<span class="ident" id="3237089">args</span>&nbsp;<span class="op" id="3237094">...</span><span class="keyword" id="3237097">interface</span><span class="op" id="3237106">{</span><span class="op" id="3237107">}</span><span class="op" id="3237108">)</span>&nbsp;<span class="op" id="3237110">(</span><span class="ident" id="3237111">Result</span><span class="op" id="3237117">,</span>&nbsp;<span class="builtintype" id="3237119">error</span><span class="op" id="3237124">)</span>&nbsp;<span class="op" id="3237126">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3237129">var</span>&nbsp;<span class="ident" id="3237133">res</span>&nbsp;<span class="ident" id="3237137">Result</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3237145">var</span>&nbsp;<span class="ident" id="3237149">err</span>&nbsp;<span class="builtintype" id="3237153">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3237160">for</span>&nbsp;<span class="ident" id="3237164">i</span>&nbsp;<span class="op" id="3237166">:=</span>&nbsp;<span class="num" id="3237169">0</span><span class="op" id="3237170">;</span>&nbsp;<span class="ident" id="3237172">i</span>&nbsp;<span class="op" id="3237174">&lt;</span>&nbsp;<span class="ident" id="3237176">maxBadConnRetries</span><span class="op" id="3237193">;</span>&nbsp;<span class="ident" id="3237195">i</span><span class="op" id="3237196">++</span>&nbsp;<span class="op" id="3237199">{</span><br>
<span class="lineno">875</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3237203">res</span><span class="op" id="3237206">,</span>&nbsp;<span class="ident" id="3237208">err</span>&nbsp;<span class="op" id="3237212">=</span>&nbsp;<span class="ident" id="3237214">db</span><span class="op" id="3237216">.</span><span class="ident" id="3237217">exec</span><span class="op" id="3237221">(</span><span class="ident" id="3237222">query</span><span class="op" id="3237227">,</span>&nbsp;<span class="ident" id="3237229">args</span><span class="op" id="3237233">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3237237">if</span>&nbsp;<span class="ident" id="3237240">err</span>&nbsp;<span class="op" id="3237244">!=</span>&nbsp;<span class="ident" id="3237247">driver</span><span class="op" id="3237253">.</span><span class="ident" id="3237254">ErrBadConn</span>&nbsp;<span class="op" id="3237265">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3237270">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3237278">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3237281">}</span><br>
<span class="lineno">880</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3237284">return</span>&nbsp;<span class="ident" id="3237291">res</span><span class="op" id="3237294">,</span>&nbsp;<span class="ident" id="3237296">err</span><br>
<span class="lineno"></span><span class="op" id="3237300">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3237303">func</span>&nbsp;<span class="op" id="3237308">(</span><span class="ident" id="3237309">db</span>&nbsp;<span class="op" id="3237312">*</span><span class="ident" id="3237313">DB</span><span class="op" id="3237315">)</span>&nbsp;<span class="ident" id="3237317">exec</span><span class="op" id="3237321">(</span><span class="ident" id="3237322">query</span>&nbsp;<span class="builtintype" id="3237328">string</span><span class="op" id="3237334">,</span>&nbsp;<span class="ident" id="3237336">args</span>&nbsp;<span class="op" id="3237341">[</span><span class="op" id="3237342">]</span><span class="keyword" id="3237343">interface</span><span class="op" id="3237352">{</span><span class="op" id="3237353">}</span><span class="op" id="3237354">)</span>&nbsp;<span class="op" id="3237356">(</span><span class="ident" id="3237357">res</span>&nbsp;<span class="ident" id="3237361">Result</span><span class="op" id="3237367">,</span>&nbsp;<span class="ident" id="3237369">err</span>&nbsp;<span class="builtintype" id="3237373">error</span><span class="op" id="3237378">)</span>&nbsp;<span class="op" id="3237380">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3237383">dc</span><span class="op" id="3237385">,</span>&nbsp;<span class="ident" id="3237387">err</span>&nbsp;<span class="op" id="3237391">:=</span>&nbsp;<span class="ident" id="3237394">db</span><span class="op" id="3237396">.</span><span class="ident" id="3237397">conn</span><span class="op" id="3237401">(</span><span class="op" id="3237402">)</span><br>
<span class="lineno">885</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3237405">if</span>&nbsp;<span class="ident" id="3237408">err</span>&nbsp;<span class="op" id="3237412">!=</span>&nbsp;<span class="ident" id="3237415">nil</span>&nbsp;<span class="op" id="3237419">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3237423">return</span>&nbsp;<span class="ident" id="3237430">nil</span><span class="op" id="3237433">,</span>&nbsp;<span class="ident" id="3237435">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3237440">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3237443">defer</span>&nbsp;<span class="keyword" id="3237449">func</span><span class="op" id="3237453">(</span><span class="op" id="3237454">)</span>&nbsp;<span class="op" id="3237456">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3237460">db</span><span class="op" id="3237462">.</span><span class="ident" id="3237463">putConn</span><span class="op" id="3237470">(</span><span class="ident" id="3237471">dc</span><span class="op" id="3237473">,</span>&nbsp;<span class="ident" id="3237475">err</span><span class="op" id="3237478">)</span><br>
<span class="lineno">890</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3237481">}</span><span class="op" id="3237482">(</span><span class="op" id="3237483">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3237487">if</span>&nbsp;<span class="ident" id="3237490">execer</span><span class="op" id="3237496">,</span>&nbsp;<span class="ident" id="3237498">ok</span>&nbsp;<span class="op" id="3237501">:=</span>&nbsp;<span class="ident" id="3237504">dc</span><span class="op" id="3237506">.</span><span class="ident" id="3237507">ci</span><span class="op" id="3237509">.</span><span class="op" id="3237510">(</span><span class="ident" id="3237511">driver</span><span class="op" id="3237517">.</span><span class="ident" id="3237518">Execer</span><span class="op" id="3237524">)</span><span class="op" id="3237525">;</span>&nbsp;<span class="ident" id="3237527">ok</span>&nbsp;<span class="op" id="3237530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3237534">dargs</span><span class="op" id="3237539">,</span>&nbsp;<span class="ident" id="3237541">err</span>&nbsp;<span class="op" id="3237545">:=</span>&nbsp;<span class="ident" id="3237548">driverArgs</span><span class="op" id="3237558">(</span><span class="ident" id="3237559">nil</span><span class="op" id="3237562">,</span>&nbsp;<span class="ident" id="3237564">args</span><span class="op" id="3237568">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3237572">if</span>&nbsp;<span class="ident" id="3237575">err</span>&nbsp;<span class="op" id="3237579">!=</span>&nbsp;<span class="ident" id="3237582">nil</span>&nbsp;<span class="op" id="3237586">{</span><br>
<span class="lineno">895</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3237591">return</span>&nbsp;<span class="ident" id="3237598">nil</span><span class="op" id="3237601">,</span>&nbsp;<span class="ident" id="3237603">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3237609">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3237613">dc</span><span class="op" id="3237615">.</span><span class="ident" id="3237616">Lock</span><span class="op" id="3237620">(</span><span class="op" id="3237621">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3237625">resi</span><span class="op" id="3237629">,</span>&nbsp;<span class="ident" id="3237631">err</span>&nbsp;<span class="op" id="3237635">:=</span>&nbsp;<span class="ident" id="3237638">execer</span><span class="op" id="3237644">.</span><span class="ident" id="3237645">Exec</span><span class="op" id="3237649">(</span><span class="ident" id="3237650">query</span><span class="op" id="3237655">,</span>&nbsp;<span class="ident" id="3237657">dargs</span><span class="op" id="3237662">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3237666">dc</span><span class="op" id="3237668">.</span><span class="ident" id="3237669">Unlock</span><span class="op" id="3237675">(</span><span class="op" id="3237676">)</span><br>
<span class="lineno">900</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3237680">if</span>&nbsp;<span class="ident" id="3237683">err</span>&nbsp;<span class="op" id="3237687">!=</span>&nbsp;<span class="ident" id="3237690">driver</span><span class="op" id="3237696">.</span><span class="ident" id="3237697">ErrSkip</span>&nbsp;<span class="op" id="3237705">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3237710">if</span>&nbsp;<span class="ident" id="3237713">err</span>&nbsp;<span class="op" id="3237717">!=</span>&nbsp;<span class="ident" id="3237720">nil</span>&nbsp;<span class="op" id="3237724">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3237730">return</span>&nbsp;<span class="ident" id="3237737">nil</span><span class="op" id="3237740">,</span>&nbsp;<span class="ident" id="3237742">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3237749">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3237754">return</span>&nbsp;<span class="ident" id="3237761">driverResult</span><span class="op" id="3237773">{</span><span class="ident" id="3237774">dc</span><span class="op" id="3237776">,</span>&nbsp;<span class="ident" id="3237778">resi</span><span class="op" id="3237782">}</span><span class="op" id="3237783">,</span>&nbsp;<span class="ident" id="3237785">nil</span><br>
<span class="lineno">905</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3237791">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3237794">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3237798">dc</span><span class="op" id="3237800">.</span><span class="ident" id="3237801">Lock</span><span class="op" id="3237805">(</span><span class="op" id="3237806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3237809">si</span><span class="op" id="3237811">,</span>&nbsp;<span class="ident" id="3237813">err</span>&nbsp;<span class="op" id="3237817">:=</span>&nbsp;<span class="ident" id="3237820">dc</span><span class="op" id="3237822">.</span><span class="ident" id="3237823">ci</span><span class="op" id="3237825">.</span><span class="ident" id="3237826">Prepare</span><span class="op" id="3237833">(</span><span class="ident" id="3237834">query</span><span class="op" id="3237839">)</span><br>
<span class="lineno">910</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3237842">dc</span><span class="op" id="3237844">.</span><span class="ident" id="3237845">Unlock</span><span class="op" id="3237851">(</span><span class="op" id="3237852">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3237855">if</span>&nbsp;<span class="ident" id="3237858">err</span>&nbsp;<span class="op" id="3237862">!=</span>&nbsp;<span class="ident" id="3237865">nil</span>&nbsp;<span class="op" id="3237869">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3237873">return</span>&nbsp;<span class="ident" id="3237880">nil</span><span class="op" id="3237883">,</span>&nbsp;<span class="ident" id="3237885">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3237890">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3237893">defer</span>&nbsp;<span class="ident" id="3237899">withLock</span><span class="op" id="3237907">(</span><span class="ident" id="3237908">dc</span><span class="op" id="3237910">,</span>&nbsp;<span class="keyword" id="3237912">func</span><span class="op" id="3237916">(</span><span class="op" id="3237917">)</span>&nbsp;<span class="op" id="3237919">{</span>&nbsp;<span class="ident" id="3237921">si</span><span class="op" id="3237923">.</span><span class="ident" id="3237924">Close</span><span class="op" id="3237929">(</span><span class="op" id="3237930">)</span>&nbsp;<span class="op" id="3237932">}</span><span class="op" id="3237933">)</span><br>
<span class="lineno">915</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3237936">return</span>&nbsp;<span class="ident" id="3237943">resultFromStatement</span><span class="op" id="3237962">(</span><span class="ident" id="3237963">driverStmt</span><span class="op" id="3237973">{</span><span class="ident" id="3237974">dc</span><span class="op" id="3237976">,</span>&nbsp;<span class="ident" id="3237978">si</span><span class="op" id="3237980">}</span><span class="op" id="3237981">,</span>&nbsp;<span class="ident" id="3237983">args</span><span class="op" id="3237987">...</span><span class="op" id="3237990">)</span><br>
<span class="lineno"></span><span class="op" id="3237992">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3237995">//&nbsp;Query&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;returns&nbsp;rows,&nbsp;typically&nbsp;a&nbsp;SELECT.</span><br>
<span class="lineno"></span><span class="comment" id="3238060">//&nbsp;The&nbsp;args&nbsp;are&nbsp;for&nbsp;any&nbsp;placeholder&nbsp;parameters&nbsp;in&nbsp;the&nbsp;query.</span><br>
<span class="lineno">920</span><span class="keyword" id="3238121">func</span>&nbsp;<span class="op" id="3238126">(</span><span class="ident" id="3238127">db</span>&nbsp;<span class="op" id="3238130">*</span><span class="ident" id="3238131">DB</span><span class="op" id="3238133">)</span>&nbsp;<span class="ident" id="3238135">Query</span><span class="op" id="3238140">(</span><span class="ident" id="3238141">query</span>&nbsp;<span class="builtintype" id="3238147">string</span><span class="op" id="3238153">,</span>&nbsp;<span class="ident" id="3238155">args</span>&nbsp;<span class="op" id="3238160">...</span><span class="keyword" id="3238163">interface</span><span class="op" id="3238172">{</span><span class="op" id="3238173">}</span><span class="op" id="3238174">)</span>&nbsp;<span class="op" id="3238176">(</span><span class="op" id="3238177">*</span><span class="ident" id="3238178">Rows</span><span class="op" id="3238182">,</span>&nbsp;<span class="builtintype" id="3238184">error</span><span class="op" id="3238189">)</span>&nbsp;<span class="op" id="3238191">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3238194">var</span>&nbsp;<span class="ident" id="3238198">rows</span>&nbsp;<span class="op" id="3238203">*</span><span class="ident" id="3238204">Rows</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3238210">var</span>&nbsp;<span class="ident" id="3238214">err</span>&nbsp;<span class="builtintype" id="3238218">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3238225">for</span>&nbsp;<span class="ident" id="3238229">i</span>&nbsp;<span class="op" id="3238231">:=</span>&nbsp;<span class="num" id="3238234">0</span><span class="op" id="3238235">;</span>&nbsp;<span class="ident" id="3238237">i</span>&nbsp;<span class="op" id="3238239">&lt;</span>&nbsp;<span class="ident" id="3238241">maxBadConnRetries</span><span class="op" id="3238258">;</span>&nbsp;<span class="ident" id="3238260">i</span><span class="op" id="3238261">++</span>&nbsp;<span class="op" id="3238264">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3238268">rows</span><span class="op" id="3238272">,</span>&nbsp;<span class="ident" id="3238274">err</span>&nbsp;<span class="op" id="3238278">=</span>&nbsp;<span class="ident" id="3238280">db</span><span class="op" id="3238282">.</span><span class="ident" id="3238283">query</span><span class="op" id="3238288">(</span><span class="ident" id="3238289">query</span><span class="op" id="3238294">,</span>&nbsp;<span class="ident" id="3238296">args</span><span class="op" id="3238300">)</span><br>
<span class="lineno">925</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3238304">if</span>&nbsp;<span class="ident" id="3238307">err</span>&nbsp;<span class="op" id="3238311">!=</span>&nbsp;<span class="ident" id="3238314">driver</span><span class="op" id="3238320">.</span><span class="ident" id="3238321">ErrBadConn</span>&nbsp;<span class="op" id="3238332">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3238337">break</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3238345">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3238348">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3238351">return</span>&nbsp;<span class="ident" id="3238358">rows</span><span class="op" id="3238362">,</span>&nbsp;<span class="ident" id="3238364">err</span><br>
<span class="lineno">930</span><span class="op" id="3238368">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3238371">func</span>&nbsp;<span class="op" id="3238376">(</span><span class="ident" id="3238377">db</span>&nbsp;<span class="op" id="3238380">*</span><span class="ident" id="3238381">DB</span><span class="op" id="3238383">)</span>&nbsp;<span class="ident" id="3238385">query</span><span class="op" id="3238390">(</span><span class="ident" id="3238391">query</span>&nbsp;<span class="builtintype" id="3238397">string</span><span class="op" id="3238403">,</span>&nbsp;<span class="ident" id="3238405">args</span>&nbsp;<span class="op" id="3238410">[</span><span class="op" id="3238411">]</span><span class="keyword" id="3238412">interface</span><span class="op" id="3238421">{</span><span class="op" id="3238422">}</span><span class="op" id="3238423">)</span>&nbsp;<span class="op" id="3238425">(</span><span class="op" id="3238426">*</span><span class="ident" id="3238427">Rows</span><span class="op" id="3238431">,</span>&nbsp;<span class="builtintype" id="3238433">error</span><span class="op" id="3238438">)</span>&nbsp;<span class="op" id="3238440">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3238443">ci</span><span class="op" id="3238445">,</span>&nbsp;<span class="ident" id="3238447">err</span>&nbsp;<span class="op" id="3238451">:=</span>&nbsp;<span class="ident" id="3238454">db</span><span class="op" id="3238456">.</span><span class="ident" id="3238457">conn</span><span class="op" id="3238461">(</span><span class="op" id="3238462">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3238465">if</span>&nbsp;<span class="ident" id="3238468">err</span>&nbsp;<span class="op" id="3238472">!=</span>&nbsp;<span class="ident" id="3238475">nil</span>&nbsp;<span class="op" id="3238479">{</span><br>
<span class="lineno">935</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3238483">return</span>&nbsp;<span class="ident" id="3238490">nil</span><span class="op" id="3238493">,</span>&nbsp;<span class="ident" id="3238495">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3238500">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3238504">return</span>&nbsp;<span class="ident" id="3238511">db</span><span class="op" id="3238513">.</span><span class="ident" id="3238514">queryConn</span><span class="op" id="3238523">(</span><span class="ident" id="3238524">ci</span><span class="op" id="3238526">,</span>&nbsp;<span class="ident" id="3238528">ci</span><span class="op" id="3238530">.</span><span class="ident" id="3238531">releaseConn</span><span class="op" id="3238542">,</span>&nbsp;<span class="ident" id="3238544">query</span><span class="op" id="3238549">,</span>&nbsp;<span class="ident" id="3238551">args</span><span class="op" id="3238555">)</span><br>
<span class="lineno"></span><span class="op" id="3238557">}</span><br>
<span class="lineno">940</span><br>
<span class="lineno"></span><span class="comment" id="3238560">//&nbsp;queryConn&nbsp;executes&nbsp;a&nbsp;query&nbsp;on&nbsp;the&nbsp;given&nbsp;connection.</span><br>
<span class="lineno"></span><span class="comment" id="3238615">//&nbsp;The&nbsp;connection&nbsp;gets&nbsp;released&nbsp;by&nbsp;the&nbsp;releaseConn&nbsp;function.</span><br>
<span class="lineno"></span><span class="keyword" id="3238676">func</span>&nbsp;<span class="op" id="3238681">(</span><span class="ident" id="3238682">db</span>&nbsp;<span class="op" id="3238685">*</span><span class="ident" id="3238686">DB</span><span class="op" id="3238688">)</span>&nbsp;<span class="ident" id="3238690">queryConn</span><span class="op" id="3238699">(</span><span class="ident" id="3238700">dc</span>&nbsp;<span class="op" id="3238703">*</span><span class="ident" id="3238704">driverConn</span><span class="op" id="3238714">,</span>&nbsp;<span class="ident" id="3238716">releaseConn</span>&nbsp;<span class="keyword" id="3238728">func</span><span class="op" id="3238732">(</span><span class="builtintype" id="3238733">error</span><span class="op" id="3238738">)</span><span class="op" id="3238739">,</span>&nbsp;<span class="ident" id="3238741">query</span>&nbsp;<span class="builtintype" id="3238747">string</span><span class="op" id="3238753">,</span>&nbsp;<span class="ident" id="3238755">args</span>&nbsp;<span class="op" id="3238760">[</span><span class="op" id="3238761">]</span><span class="keyword" id="3238762">interface</span><span class="op" id="3238771">{</span><span class="op" id="3238772">}</span><span class="op" id="3238773">)</span>&nbsp;<span class="op" id="3238775">(</span><span class="op" id="3238776">*</span><span class="ident" id="3238777">Rows</span><span class="op" id="3238781">,</span>&nbsp;<span class="builtintype" id="3238783">error</span><span class="op" id="3238788">)</span>&nbsp;<span class="op" id="3238790">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3238793">if</span>&nbsp;<span class="ident" id="3238796">queryer</span><span class="op" id="3238803">,</span>&nbsp;<span class="ident" id="3238805">ok</span>&nbsp;<span class="op" id="3238808">:=</span>&nbsp;<span class="ident" id="3238811">dc</span><span class="op" id="3238813">.</span><span class="ident" id="3238814">ci</span><span class="op" id="3238816">.</span><span class="op" id="3238817">(</span><span class="ident" id="3238818">driver</span><span class="op" id="3238824">.</span><span class="ident" id="3238825">Queryer</span><span class="op" id="3238832">)</span><span class="op" id="3238833">;</span>&nbsp;<span class="ident" id="3238835">ok</span>&nbsp;<span class="op" id="3238838">{</span><br>
<span class="lineno">945</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3238842">dargs</span><span class="op" id="3238847">,</span>&nbsp;<span class="ident" id="3238849">err</span>&nbsp;<span class="op" id="3238853">:=</span>&nbsp;<span class="ident" id="3238856">driverArgs</span><span class="op" id="3238866">(</span><span class="ident" id="3238867">nil</span><span class="op" id="3238870">,</span>&nbsp;<span class="ident" id="3238872">args</span><span class="op" id="3238876">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3238880">if</span>&nbsp;<span class="ident" id="3238883">err</span>&nbsp;<span class="op" id="3238887">!=</span>&nbsp;<span class="ident" id="3238890">nil</span>&nbsp;<span class="op" id="3238894">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3238899">releaseConn</span><span class="op" id="3238910">(</span><span class="ident" id="3238911">err</span><span class="op" id="3238914">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3238919">return</span>&nbsp;<span class="ident" id="3238926">nil</span><span class="op" id="3238929">,</span>&nbsp;<span class="ident" id="3238931">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3238937">}</span><br>
<span class="lineno">950</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3238941">dc</span><span class="op" id="3238943">.</span><span class="ident" id="3238944">Lock</span><span class="op" id="3238948">(</span><span class="op" id="3238949">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3238953">rowsi</span><span class="op" id="3238958">,</span>&nbsp;<span class="ident" id="3238960">err</span>&nbsp;<span class="op" id="3238964">:=</span>&nbsp;<span class="ident" id="3238967">queryer</span><span class="op" id="3238974">.</span><span class="ident" id="3238975">Query</span><span class="op" id="3238980">(</span><span class="ident" id="3238981">query</span><span class="op" id="3238986">,</span>&nbsp;<span class="ident" id="3238988">dargs</span><span class="op" id="3238993">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3238997">dc</span><span class="op" id="3238999">.</span><span class="ident" id="3239000">Unlock</span><span class="op" id="3239006">(</span><span class="op" id="3239007">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3239011">if</span>&nbsp;<span class="ident" id="3239014">err</span>&nbsp;<span class="op" id="3239018">!=</span>&nbsp;<span class="ident" id="3239021">driver</span><span class="op" id="3239027">.</span><span class="ident" id="3239028">ErrSkip</span>&nbsp;<span class="op" id="3239036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3239041">if</span>&nbsp;<span class="ident" id="3239044">err</span>&nbsp;<span class="op" id="3239048">!=</span>&nbsp;<span class="ident" id="3239051">nil</span>&nbsp;<span class="op" id="3239055">{</span><br>
<span class="lineno">955</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3239061">releaseConn</span><span class="op" id="3239072">(</span><span class="ident" id="3239073">err</span><span class="op" id="3239076">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3239082">return</span>&nbsp;<span class="ident" id="3239089">nil</span><span class="op" id="3239092">,</span>&nbsp;<span class="ident" id="3239094">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3239101">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3239106">//&nbsp;Note:&nbsp;ownership&nbsp;of&nbsp;dc&nbsp;passes&nbsp;to&nbsp;the&nbsp;*Rows,&nbsp;to&nbsp;be&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3239167">//&nbsp;with&nbsp;releaseConn.</span><br>
<span class="lineno">960</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3239191">rows</span>&nbsp;<span class="op" id="3239196">:=</span>&nbsp;<span class="op" id="3239199">&amp;</span><span class="ident" id="3239200">Rows</span><span class="op" id="3239204">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3239210">dc</span><span class="op" id="3239212">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3239223">dc</span><span class="op" id="3239225">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3239231">releaseConn</span><span class="op" id="3239242">:</span>&nbsp;<span class="ident" id="3239244">releaseConn</span><span class="op" id="3239255">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3239261">rowsi</span><span class="op" id="3239266">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3239274">rowsi</span><span class="op" id="3239279">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3239284">}</span><br>
<span class="lineno">965</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3239289">return</span>&nbsp;<span class="ident" id="3239296">rows</span><span class="op" id="3239300">,</span>&nbsp;<span class="ident" id="3239302">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3239308">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3239311">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3239315">dc</span><span class="op" id="3239317">.</span><span class="ident" id="3239318">Lock</span><span class="op" id="3239322">(</span><span class="op" id="3239323">)</span><br>
<span class="lineno">970</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3239326">si</span><span class="op" id="3239328">,</span>&nbsp;<span class="ident" id="3239330">err</span>&nbsp;<span class="op" id="3239334">:=</span>&nbsp;<span class="ident" id="3239337">dc</span><span class="op" id="3239339">.</span><span class="ident" id="3239340">ci</span><span class="op" id="3239342">.</span><span class="ident" id="3239343">Prepare</span><span class="op" id="3239350">(</span><span class="ident" id="3239351">query</span><span class="op" id="3239356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3239359">dc</span><span class="op" id="3239361">.</span><span class="ident" id="3239362">Unlock</span><span class="op" id="3239368">(</span><span class="op" id="3239369">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3239372">if</span>&nbsp;<span class="ident" id="3239375">err</span>&nbsp;<span class="op" id="3239379">!=</span>&nbsp;<span class="ident" id="3239382">nil</span>&nbsp;<span class="op" id="3239386">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3239390">releaseConn</span><span class="op" id="3239401">(</span><span class="ident" id="3239402">err</span><span class="op" id="3239405">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3239409">return</span>&nbsp;<span class="ident" id="3239416">nil</span><span class="op" id="3239419">,</span>&nbsp;<span class="ident" id="3239421">err</span><br>
<span class="lineno">975</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3239426">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3239430">ds</span>&nbsp;<span class="op" id="3239433">:=</span>&nbsp;<span class="ident" id="3239436">driverStmt</span><span class="op" id="3239446">{</span><span class="ident" id="3239447">dc</span><span class="op" id="3239449">,</span>&nbsp;<span class="ident" id="3239451">si</span><span class="op" id="3239453">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3239456">rowsi</span><span class="op" id="3239461">,</span>&nbsp;<span class="ident" id="3239463">err</span>&nbsp;<span class="op" id="3239467">:=</span>&nbsp;<span class="ident" id="3239470">rowsiFromStatement</span><span class="op" id="3239488">(</span><span class="ident" id="3239489">ds</span><span class="op" id="3239491">,</span>&nbsp;<span class="ident" id="3239493">args</span><span class="op" id="3239497">...</span><span class="op" id="3239500">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3239503">if</span>&nbsp;<span class="ident" id="3239506">err</span>&nbsp;<span class="op" id="3239510">!=</span>&nbsp;<span class="ident" id="3239513">nil</span>&nbsp;<span class="op" id="3239517">{</span><br>
<span class="lineno">980</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3239521">dc</span><span class="op" id="3239523">.</span><span class="ident" id="3239524">Lock</span><span class="op" id="3239528">(</span><span class="op" id="3239529">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3239533">si</span><span class="op" id="3239535">.</span><span class="ident" id="3239536">Close</span><span class="op" id="3239541">(</span><span class="op" id="3239542">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3239546">dc</span><span class="op" id="3239548">.</span><span class="ident" id="3239549">Unlock</span><span class="op" id="3239555">(</span><span class="op" id="3239556">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3239560">releaseConn</span><span class="op" id="3239571">(</span><span class="ident" id="3239572">err</span><span class="op" id="3239575">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3239579">return</span>&nbsp;<span class="ident" id="3239586">nil</span><span class="op" id="3239589">,</span>&nbsp;<span class="ident" id="3239591">err</span><br>
<span class="lineno">985</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3239596">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3239600">//&nbsp;Note:&nbsp;ownership&nbsp;of&nbsp;ci&nbsp;passes&nbsp;to&nbsp;the&nbsp;*Rows,&nbsp;to&nbsp;be&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3239659">//&nbsp;with&nbsp;releaseConn.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3239681">rows</span>&nbsp;<span class="op" id="3239686">:=</span>&nbsp;<span class="op" id="3239689">&amp;</span><span class="ident" id="3239690">Rows</span><span class="op" id="3239694">{</span><br>
<span class="lineno">990</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3239698">dc</span><span class="op" id="3239700">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3239711">dc</span><span class="op" id="3239713">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3239717">releaseConn</span><span class="op" id="3239728">:</span>&nbsp;<span class="ident" id="3239730">releaseConn</span><span class="op" id="3239741">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3239745">rowsi</span><span class="op" id="3239750">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3239758">rowsi</span><span class="op" id="3239763">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3239767">closeStmt</span><span class="op" id="3239776">:</span>&nbsp;&nbsp;&nbsp;<span class="ident" id="3239780">si</span><span class="op" id="3239782">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3239785">}</span><br>
<span class="lineno">995</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3239788">return</span>&nbsp;<span class="ident" id="3239795">rows</span><span class="op" id="3239799">,</span>&nbsp;<span class="ident" id="3239801">nil</span><br>
<span class="lineno"></span><span class="op" id="3239805">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3239808">//&nbsp;QueryRow&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;is&nbsp;expected&nbsp;to&nbsp;return&nbsp;at&nbsp;most&nbsp;one&nbsp;row.</span><br>
<span class="lineno"></span><span class="comment" id="3239881">//&nbsp;QueryRow&nbsp;always&nbsp;return&nbsp;a&nbsp;non-nil&nbsp;value.&nbsp;Errors&nbsp;are&nbsp;deferred&nbsp;until</span><br>
<span class="lineno">1000</span><span class="comment" id="3239950">//&nbsp;Row&#39;s&nbsp;Scan&nbsp;method&nbsp;is&nbsp;called.</span><br>
<span class="lineno"></span><span class="keyword" id="3239982">func</span>&nbsp;<span class="op" id="3239987">(</span><span class="ident" id="3239988">db</span>&nbsp;<span class="op" id="3239991">*</span><span class="ident" id="3239992">DB</span><span class="op" id="3239994">)</span>&nbsp;<span class="ident" id="3239996">QueryRow</span><span class="op" id="3240004">(</span><span class="ident" id="3240005">query</span>&nbsp;<span class="builtintype" id="3240011">string</span><span class="op" id="3240017">,</span>&nbsp;<span class="ident" id="3240019">args</span>&nbsp;<span class="op" id="3240024">...</span><span class="keyword" id="3240027">interface</span><span class="op" id="3240036">{</span><span class="op" id="3240037">}</span><span class="op" id="3240038">)</span>&nbsp;<span class="op" id="3240040">*</span><span class="ident" id="3240041">Row</span>&nbsp;<span class="op" id="3240045">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3240048">rows</span><span class="op" id="3240052">,</span>&nbsp;<span class="ident" id="3240054">err</span>&nbsp;<span class="op" id="3240058">:=</span>&nbsp;<span class="ident" id="3240061">db</span><span class="op" id="3240063">.</span><span class="ident" id="3240064">Query</span><span class="op" id="3240069">(</span><span class="ident" id="3240070">query</span><span class="op" id="3240075">,</span>&nbsp;<span class="ident" id="3240077">args</span><span class="op" id="3240081">...</span><span class="op" id="3240084">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3240087">return</span>&nbsp;<span class="op" id="3240094">&amp;</span><span class="ident" id="3240095">Row</span><span class="op" id="3240098">{</span><span class="ident" id="3240099">rows</span><span class="op" id="3240103">:</span>&nbsp;<span class="ident" id="3240105">rows</span><span class="op" id="3240109">,</span>&nbsp;<span class="ident" id="3240111">err</span><span class="op" id="3240114">:</span>&nbsp;<span class="ident" id="3240116">err</span><span class="op" id="3240119">}</span><br>
<span class="lineno"></span><span class="op" id="3240121">}</span><br>
<span class="lineno">1005</span><br>
<span class="lineno"></span><span class="comment" id="3240124">//&nbsp;Begin&nbsp;starts&nbsp;a&nbsp;transaction.&nbsp;The&nbsp;isolation&nbsp;level&nbsp;is&nbsp;dependent&nbsp;on</span><br>
<span class="lineno"></span><span class="comment" id="3240191">//&nbsp;the&nbsp;driver.</span><br>
<span class="lineno"></span><span class="keyword" id="3240206">func</span>&nbsp;<span class="op" id="3240211">(</span><span class="ident" id="3240212">db</span>&nbsp;<span class="op" id="3240215">*</span><span class="ident" id="3240216">DB</span><span class="op" id="3240218">)</span>&nbsp;<span class="ident" id="3240220">Begin</span><span class="op" id="3240225">(</span><span class="op" id="3240226">)</span>&nbsp;<span class="op" id="3240228">(</span><span class="op" id="3240229">*</span><span class="ident" id="3240230">Tx</span><span class="op" id="3240232">,</span>&nbsp;<span class="builtintype" id="3240234">error</span><span class="op" id="3240239">)</span>&nbsp;<span class="op" id="3240241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3240244">var</span>&nbsp;<span class="ident" id="3240248">tx</span>&nbsp;<span class="op" id="3240251">*</span><span class="ident" id="3240252">Tx</span><br>
<span class="lineno">1010</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3240256">var</span>&nbsp;<span class="ident" id="3240260">err</span>&nbsp;<span class="builtintype" id="3240264">error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3240271">for</span>&nbsp;<span class="ident" id="3240275">i</span>&nbsp;<span class="op" id="3240277">:=</span>&nbsp;<span class="num" id="3240280">0</span><span class="op" id="3240281">;</span>&nbsp;<span class="ident" id="3240283">i</span>&nbsp;<span class="op" id="3240285">&lt;</span>&nbsp;<span class="ident" id="3240287">maxBadConnRetries</span><span class="op" id="3240304">;</span>&nbsp;<span class="ident" id="3240306">i</span><span class="op" id="3240307">++</span>&nbsp;<span class="op" id="3240310">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3240314">tx</span><span class="op" id="3240316">,</span>&nbsp;<span class="ident" id="3240318">err</span>&nbsp;<span class="op" id="3240322">=</span>&nbsp;<span class="ident" id="3240324">db</span><span class="op" id="3240326">.</span><span class="ident" id="3240327">begin</span><span class="op" id="3240332">(</span><span class="op" id="3240333">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3240337">if</span>&nbsp;<span class="ident" id="3240340">err</span>&nbsp;<span class="op" id="3240344">!=</span>&nbsp;<span class="ident" id="3240347">driver</span><span class="op" id="3240353">.</span><span class="ident" id="3240354">ErrBadConn</span>&nbsp;<span class="op" id="3240365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3240370">break</span><br>
<span class="lineno">1015</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3240378">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3240381">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3240384">return</span>&nbsp;<span class="ident" id="3240391">tx</span><span class="op" id="3240393">,</span>&nbsp;<span class="ident" id="3240395">err</span><br>
<span class="lineno"></span><span class="op" id="3240399">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1020</span><span class="keyword" id="3240402">func</span>&nbsp;<span class="op" id="3240407">(</span><span class="ident" id="3240408">db</span>&nbsp;<span class="op" id="3240411">*</span><span class="ident" id="3240412">DB</span><span class="op" id="3240414">)</span>&nbsp;<span class="ident" id="3240416">begin</span><span class="op" id="3240421">(</span><span class="op" id="3240422">)</span>&nbsp;<span class="op" id="3240424">(</span><span class="ident" id="3240425">tx</span>&nbsp;<span class="op" id="3240428">*</span><span class="ident" id="3240429">Tx</span><span class="op" id="3240431">,</span>&nbsp;<span class="ident" id="3240433">err</span>&nbsp;<span class="builtintype" id="3240437">error</span><span class="op" id="3240442">)</span>&nbsp;<span class="op" id="3240444">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3240447">dc</span><span class="op" id="3240449">,</span>&nbsp;<span class="ident" id="3240451">err</span>&nbsp;<span class="op" id="3240455">:=</span>&nbsp;<span class="ident" id="3240458">db</span><span class="op" id="3240460">.</span><span class="ident" id="3240461">conn</span><span class="op" id="3240465">(</span><span class="op" id="3240466">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3240469">if</span>&nbsp;<span class="ident" id="3240472">err</span>&nbsp;<span class="op" id="3240476">!=</span>&nbsp;<span class="ident" id="3240479">nil</span>&nbsp;<span class="op" id="3240483">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3240487">return</span>&nbsp;<span class="ident" id="3240494">nil</span><span class="op" id="3240497">,</span>&nbsp;<span class="ident" id="3240499">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3240504">}</span><br>
<span class="lineno">1025</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3240507">dc</span><span class="op" id="3240509">.</span><span class="ident" id="3240510">Lock</span><span class="op" id="3240514">(</span><span class="op" id="3240515">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3240518">txi</span><span class="op" id="3240521">,</span>&nbsp;<span class="ident" id="3240523">err</span>&nbsp;<span class="op" id="3240527">:=</span>&nbsp;<span class="ident" id="3240530">dc</span><span class="op" id="3240532">.</span><span class="ident" id="3240533">ci</span><span class="op" id="3240535">.</span><span class="ident" id="3240536">Begin</span><span class="op" id="3240541">(</span><span class="op" id="3240542">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3240545">dc</span><span class="op" id="3240547">.</span><span class="ident" id="3240548">Unlock</span><span class="op" id="3240554">(</span><span class="op" id="3240555">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3240558">if</span>&nbsp;<span class="ident" id="3240561">err</span>&nbsp;<span class="op" id="3240565">!=</span>&nbsp;<span class="ident" id="3240568">nil</span>&nbsp;<span class="op" id="3240572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3240576">db</span><span class="op" id="3240578">.</span><span class="ident" id="3240579">putConn</span><span class="op" id="3240586">(</span><span class="ident" id="3240587">dc</span><span class="op" id="3240589">,</span>&nbsp;<span class="ident" id="3240591">err</span><span class="op" id="3240594">)</span><br>
<span class="lineno">1030</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3240598">return</span>&nbsp;<span class="ident" id="3240605">nil</span><span class="op" id="3240608">,</span>&nbsp;<span class="ident" id="3240610">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3240615">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3240618">return</span>&nbsp;<span class="op" id="3240625">&amp;</span><span class="ident" id="3240626">Tx</span><span class="op" id="3240628">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3240632">db</span><span class="op" id="3240634">:</span>&nbsp;&nbsp;<span class="ident" id="3240637">db</span><span class="op" id="3240639">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3240643">dc</span><span class="op" id="3240645">:</span>&nbsp;&nbsp;<span class="ident" id="3240648">dc</span><span class="op" id="3240650">,</span><br>
<span class="lineno">1035</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3240654">txi</span><span class="op" id="3240657">:</span>&nbsp;<span class="ident" id="3240659">txi</span><span class="op" id="3240662">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3240665">}</span><span class="op" id="3240666">,</span>&nbsp;<span class="ident" id="3240668">nil</span><br>
<span class="lineno"></span><span class="op" id="3240672">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3240675">//&nbsp;Driver&nbsp;returns&nbsp;the&nbsp;database&#39;s&nbsp;underlying&nbsp;driver.</span><br>
<span class="lineno">1040</span><span class="keyword" id="3240727">func</span>&nbsp;<span class="op" id="3240732">(</span><span class="ident" id="3240733">db</span>&nbsp;<span class="op" id="3240736">*</span><span class="ident" id="3240737">DB</span><span class="op" id="3240739">)</span>&nbsp;<span class="ident" id="3240741">Driver</span><span class="op" id="3240747">(</span><span class="op" id="3240748">)</span>&nbsp;<span class="ident" id="3240750">driver</span><span class="op" id="3240756">.</span><span class="ident" id="3240757">Driver</span>&nbsp;<span class="op" id="3240764">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3240767">return</span>&nbsp;<span class="ident" id="3240774">db</span><span class="op" id="3240776">.</span><span class="ident" id="3240777">driver</span><br>
<span class="lineno"></span><span class="op" id="3240784">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3240787">//&nbsp;Tx&nbsp;is&nbsp;an&nbsp;in-progress&nbsp;database&nbsp;transaction.</span><br>
<span class="lineno">1045</span><span class="comment" id="3240833">//</span><br>
<span class="lineno"></span><span class="comment" id="3240836">//&nbsp;A&nbsp;transaction&nbsp;must&nbsp;end&nbsp;with&nbsp;a&nbsp;call&nbsp;to&nbsp;Commit&nbsp;or&nbsp;Rollback.</span><br>
<span class="lineno"></span><span class="comment" id="3240897">//</span><br>
<span class="lineno"></span><span class="comment" id="3240900">//&nbsp;After&nbsp;a&nbsp;call&nbsp;to&nbsp;Commit&nbsp;or&nbsp;Rollback,&nbsp;all&nbsp;operations&nbsp;on&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3240961">//&nbsp;transaction&nbsp;fail&nbsp;with&nbsp;ErrTxDone.</span><br>
<span class="lineno">1050</span><span class="keyword" id="3240997">type</span>&nbsp;<span class="ident" id="3241002">Tx</span>&nbsp;<span class="keyword" id="3241005">struct</span>&nbsp;<span class="op" id="3241012">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3241015">db</span>&nbsp;<span class="op" id="3241018">*</span><span class="ident" id="3241019">DB</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3241024">//&nbsp;dc&nbsp;is&nbsp;owned&nbsp;exclusively&nbsp;until&nbsp;Commit&nbsp;or&nbsp;Rollback,&nbsp;at&nbsp;which&nbsp;point</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3241093">//&nbsp;it&#39;s&nbsp;returned&nbsp;with&nbsp;putConn.</span><br>
<span class="lineno">1055</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3241125">dc</span>&nbsp;&nbsp;<span class="op" id="3241129">*</span><span class="ident" id="3241130">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3241142">txi</span>&nbsp;<span class="ident" id="3241146">driver</span><span class="op" id="3241152">.</span><span class="ident" id="3241153">Tx</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3241158">//&nbsp;done&nbsp;transitions&nbsp;from&nbsp;false&nbsp;to&nbsp;true&nbsp;exactly&nbsp;once,&nbsp;on&nbsp;Commit</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3241222">//&nbsp;or&nbsp;Rollback.&nbsp;once&nbsp;done,&nbsp;all&nbsp;operations&nbsp;fail&nbsp;with</span><br>
<span class="lineno">1060</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3241275">//&nbsp;ErrTxDone.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3241290">done</span>&nbsp;<span class="builtintype" id="3241295">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3241302">//&nbsp;All&nbsp;Stmts&nbsp;prepared&nbsp;for&nbsp;this&nbsp;transaction.&nbsp;&nbsp;These&nbsp;will&nbsp;be&nbsp;closed&nbsp;after&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3241379">//&nbsp;transaction&nbsp;has&nbsp;been&nbsp;committed&nbsp;or&nbsp;rolled&nbsp;back.</span><br>
<span class="lineno">1065</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3241430">stmts</span>&nbsp;<span class="keyword" id="3241436">struct</span>&nbsp;<span class="op" id="3241443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3241447">sync</span><span class="op" id="3241451">.</span><span class="ident" id="3241452">Mutex</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3241460">v</span>&nbsp;<span class="op" id="3241462">[</span><span class="op" id="3241463">]</span><span class="op" id="3241464">*</span><span class="ident" id="3241465">Stmt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3241471">}</span><br>
<span class="lineno"></span><span class="op" id="3241473">}</span><br>
<span class="lineno">1070</span><br>
<span class="lineno"></span><span class="keyword" id="3241476">var</span>&nbsp;<span class="ident" id="3241480">ErrTxDone</span>&nbsp;<span class="op" id="3241490">=</span>&nbsp;<span class="ident" id="3241492">errors</span><span class="op" id="3241498">.</span><span class="ident" id="3241499">New</span><span class="op" id="3241502">(</span><span class="string" id="3241503">&#34;sql:&nbsp;Transaction&nbsp;has&nbsp;already&nbsp;been&nbsp;committed&nbsp;or&nbsp;rolled&nbsp;back&#34;</span><span class="op" id="3241563">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3241566">func</span>&nbsp;<span class="op" id="3241571">(</span><span class="ident" id="3241572">tx</span>&nbsp;<span class="op" id="3241575">*</span><span class="ident" id="3241576">Tx</span><span class="op" id="3241578">)</span>&nbsp;<span class="builtinfunc" id="3241580">close</span><span class="op" id="3241585">(</span><span class="op" id="3241586">)</span>&nbsp;<span class="op" id="3241588">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3241591">if</span>&nbsp;<span class="ident" id="3241594">tx</span><span class="op" id="3241596">.</span><span class="ident" id="3241597">done</span>&nbsp;<span class="op" id="3241602">{</span><br>
<span class="lineno">1075</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="builtinfunc" id="3241606">panic</span><span class="op" id="3241611">(</span><span class="string" id="3241612">&#34;double&nbsp;close&#34;</span><span class="op" id="3241626">)</span>&nbsp;<span class="comment" id="3241628">//&nbsp;internal&nbsp;error</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3241647">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3241650">tx</span><span class="op" id="3241652">.</span><span class="ident" id="3241653">done</span>&nbsp;<span class="op" id="3241658">=</span>&nbsp;<span class="builtintype" id="3241660">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3241666">tx</span><span class="op" id="3241668">.</span><span class="ident" id="3241669">db</span><span class="op" id="3241671">.</span><span class="ident" id="3241672">putConn</span><span class="op" id="3241679">(</span><span class="ident" id="3241680">tx</span><span class="op" id="3241682">.</span><span class="ident" id="3241683">dc</span><span class="op" id="3241685">,</span>&nbsp;<span class="ident" id="3241687">nil</span><span class="op" id="3241690">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3241693">tx</span><span class="op" id="3241695">.</span><span class="ident" id="3241696">dc</span>&nbsp;<span class="op" id="3241699">=</span>&nbsp;<span class="ident" id="3241701">nil</span><br>
<span class="lineno">1080</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3241706">tx</span><span class="op" id="3241708">.</span><span class="ident" id="3241709">txi</span>&nbsp;<span class="op" id="3241713">=</span>&nbsp;<span class="ident" id="3241715">nil</span><br>
<span class="lineno"></span><span class="op" id="3241719">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3241722">func</span>&nbsp;<span class="op" id="3241727">(</span><span class="ident" id="3241728">tx</span>&nbsp;<span class="op" id="3241731">*</span><span class="ident" id="3241732">Tx</span><span class="op" id="3241734">)</span>&nbsp;<span class="ident" id="3241736">grabConn</span><span class="op" id="3241744">(</span><span class="op" id="3241745">)</span>&nbsp;<span class="op" id="3241747">(</span><span class="op" id="3241748">*</span><span class="ident" id="3241749">driverConn</span><span class="op" id="3241759">,</span>&nbsp;<span class="builtintype" id="3241761">error</span><span class="op" id="3241766">)</span>&nbsp;<span class="op" id="3241768">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3241771">if</span>&nbsp;<span class="ident" id="3241774">tx</span><span class="op" id="3241776">.</span><span class="ident" id="3241777">done</span>&nbsp;<span class="op" id="3241782">{</span><br>
<span class="lineno">1085</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3241786">return</span>&nbsp;<span class="ident" id="3241793">nil</span><span class="op" id="3241796">,</span>&nbsp;<span class="ident" id="3241798">ErrTxDone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3241809">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3241812">return</span>&nbsp;<span class="ident" id="3241819">tx</span><span class="op" id="3241821">.</span><span class="ident" id="3241822">dc</span><span class="op" id="3241824">,</span>&nbsp;<span class="ident" id="3241826">nil</span><br>
<span class="lineno"></span><span class="op" id="3241830">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1090</span><span class="comment" id="3241833">//&nbsp;Closes&nbsp;all&nbsp;Stmts&nbsp;prepared&nbsp;for&nbsp;this&nbsp;transaction.</span><br>
<span class="lineno"></span><span class="keyword" id="3241884">func</span>&nbsp;<span class="op" id="3241889">(</span><span class="ident" id="3241890">tx</span>&nbsp;<span class="op" id="3241893">*</span><span class="ident" id="3241894">Tx</span><span class="op" id="3241896">)</span>&nbsp;<span class="ident" id="3241898">closePrepared</span><span class="op" id="3241911">(</span><span class="op" id="3241912">)</span>&nbsp;<span class="op" id="3241914">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3241917">tx</span><span class="op" id="3241919">.</span><span class="ident" id="3241920">stmts</span><span class="op" id="3241925">.</span><span class="ident" id="3241926">Lock</span><span class="op" id="3241930">(</span><span class="op" id="3241931">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3241934">for</span>&nbsp;<span class="ident" id="3241938">_</span><span class="op" id="3241939">,</span>&nbsp;<span class="ident" id="3241941">stmt</span>&nbsp;<span class="op" id="3241946">:=</span>&nbsp;<span class="keyword" id="3241949">range</span>&nbsp;<span class="ident" id="3241955">tx</span><span class="op" id="3241957">.</span><span class="ident" id="3241958">stmts</span><span class="op" id="3241963">.</span><span class="ident" id="3241964">v</span>&nbsp;<span class="op" id="3241966">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3241970">stmt</span><span class="op" id="3241974">.</span><span class="ident" id="3241975">Close</span><span class="op" id="3241980">(</span><span class="op" id="3241981">)</span><br>
<span class="lineno">1095</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3241984">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3241987">tx</span><span class="op" id="3241989">.</span><span class="ident" id="3241990">stmts</span><span class="op" id="3241995">.</span><span class="ident" id="3241996">Unlock</span><span class="op" id="3242002">(</span><span class="op" id="3242003">)</span><br>
<span class="lineno"></span><span class="op" id="3242005">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3242008">//&nbsp;Commit&nbsp;commits&nbsp;the&nbsp;transaction.</span><br>
<span class="lineno">1100</span><span class="keyword" id="3242043">func</span>&nbsp;<span class="op" id="3242048">(</span><span class="ident" id="3242049">tx</span>&nbsp;<span class="op" id="3242052">*</span><span class="ident" id="3242053">Tx</span><span class="op" id="3242055">)</span>&nbsp;<span class="ident" id="3242057">Commit</span><span class="op" id="3242063">(</span><span class="op" id="3242064">)</span>&nbsp;<span class="builtintype" id="3242066">error</span>&nbsp;<span class="op" id="3242072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3242075">if</span>&nbsp;<span class="ident" id="3242078">tx</span><span class="op" id="3242080">.</span><span class="ident" id="3242081">done</span>&nbsp;<span class="op" id="3242086">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3242090">return</span>&nbsp;<span class="ident" id="3242097">ErrTxDone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3242108">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3242111">defer</span>&nbsp;<span class="ident" id="3242117">tx</span><span class="op" id="3242119">.</span><span class="builtinfunc" id="3242120">close</span><span class="op" id="3242125">(</span><span class="op" id="3242126">)</span><br>
<span class="lineno">1105</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3242129">tx</span><span class="op" id="3242131">.</span><span class="ident" id="3242132">dc</span><span class="op" id="3242134">.</span><span class="ident" id="3242135">Lock</span><span class="op" id="3242139">(</span><span class="op" id="3242140">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3242143">err</span>&nbsp;<span class="op" id="3242147">:=</span>&nbsp;<span class="ident" id="3242150">tx</span><span class="op" id="3242152">.</span><span class="ident" id="3242153">txi</span><span class="op" id="3242156">.</span><span class="ident" id="3242157">Commit</span><span class="op" id="3242163">(</span><span class="op" id="3242164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3242167">tx</span><span class="op" id="3242169">.</span><span class="ident" id="3242170">dc</span><span class="op" id="3242172">.</span><span class="ident" id="3242173">Unlock</span><span class="op" id="3242179">(</span><span class="op" id="3242180">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3242183">if</span>&nbsp;<span class="ident" id="3242186">err</span>&nbsp;<span class="op" id="3242190">!=</span>&nbsp;<span class="ident" id="3242193">driver</span><span class="op" id="3242199">.</span><span class="ident" id="3242200">ErrBadConn</span>&nbsp;<span class="op" id="3242211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3242215">tx</span><span class="op" id="3242217">.</span><span class="ident" id="3242218">closePrepared</span><span class="op" id="3242231">(</span><span class="op" id="3242232">)</span><br>
<span class="lineno">1110</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3242235">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3242238">return</span>&nbsp;<span class="ident" id="3242245">err</span><br>
<span class="lineno"></span><span class="op" id="3242249">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3242252">//&nbsp;Rollback&nbsp;aborts&nbsp;the&nbsp;transaction.</span><br>
<span class="lineno">1115</span><span class="keyword" id="3242288">func</span>&nbsp;<span class="op" id="3242293">(</span><span class="ident" id="3242294">tx</span>&nbsp;<span class="op" id="3242297">*</span><span class="ident" id="3242298">Tx</span><span class="op" id="3242300">)</span>&nbsp;<span class="ident" id="3242302">Rollback</span><span class="op" id="3242310">(</span><span class="op" id="3242311">)</span>&nbsp;<span class="builtintype" id="3242313">error</span>&nbsp;<span class="op" id="3242319">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3242322">if</span>&nbsp;<span class="ident" id="3242325">tx</span><span class="op" id="3242327">.</span><span class="ident" id="3242328">done</span>&nbsp;<span class="op" id="3242333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3242337">return</span>&nbsp;<span class="ident" id="3242344">ErrTxDone</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3242355">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3242358">defer</span>&nbsp;<span class="ident" id="3242364">tx</span><span class="op" id="3242366">.</span><span class="builtinfunc" id="3242367">close</span><span class="op" id="3242372">(</span><span class="op" id="3242373">)</span><br>
<span class="lineno">1120</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3242376">tx</span><span class="op" id="3242378">.</span><span class="ident" id="3242379">dc</span><span class="op" id="3242381">.</span><span class="ident" id="3242382">Lock</span><span class="op" id="3242386">(</span><span class="op" id="3242387">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3242390">err</span>&nbsp;<span class="op" id="3242394">:=</span>&nbsp;<span class="ident" id="3242397">tx</span><span class="op" id="3242399">.</span><span class="ident" id="3242400">txi</span><span class="op" id="3242403">.</span><span class="ident" id="3242404">Rollback</span><span class="op" id="3242412">(</span><span class="op" id="3242413">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3242416">tx</span><span class="op" id="3242418">.</span><span class="ident" id="3242419">dc</span><span class="op" id="3242421">.</span><span class="ident" id="3242422">Unlock</span><span class="op" id="3242428">(</span><span class="op" id="3242429">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3242432">if</span>&nbsp;<span class="ident" id="3242435">err</span>&nbsp;<span class="op" id="3242439">!=</span>&nbsp;<span class="ident" id="3242442">driver</span><span class="op" id="3242448">.</span><span class="ident" id="3242449">ErrBadConn</span>&nbsp;<span class="op" id="3242460">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3242464">tx</span><span class="op" id="3242466">.</span><span class="ident" id="3242467">closePrepared</span><span class="op" id="3242480">(</span><span class="op" id="3242481">)</span><br>
<span class="lineno">1125</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3242484">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3242487">return</span>&nbsp;<span class="ident" id="3242494">err</span><br>
<span class="lineno"></span><span class="op" id="3242498">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3242501">//&nbsp;Prepare&nbsp;creates&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;for&nbsp;use&nbsp;within&nbsp;a&nbsp;transaction.</span><br>
<span class="lineno">1130</span><span class="comment" id="3242571">//</span><br>
<span class="lineno"></span><span class="comment" id="3242574">//&nbsp;The&nbsp;returned&nbsp;statement&nbsp;operates&nbsp;within&nbsp;the&nbsp;transaction&nbsp;and&nbsp;can&nbsp;no&nbsp;longer</span><br>
<span class="lineno"></span><span class="comment" id="3242650">//&nbsp;be&nbsp;used&nbsp;once&nbsp;the&nbsp;transaction&nbsp;has&nbsp;been&nbsp;committed&nbsp;or&nbsp;rolled&nbsp;back.</span><br>
<span class="lineno"></span><span class="comment" id="3242717">//</span><br>
<span class="lineno"></span><span class="comment" id="3242720">//&nbsp;To&nbsp;use&nbsp;an&nbsp;existing&nbsp;prepared&nbsp;statement&nbsp;on&nbsp;this&nbsp;transaction,&nbsp;see&nbsp;Tx.Stmt.</span><br>
<span class="lineno">1135</span><span class="keyword" id="3242795">func</span>&nbsp;<span class="op" id="3242800">(</span><span class="ident" id="3242801">tx</span>&nbsp;<span class="op" id="3242804">*</span><span class="ident" id="3242805">Tx</span><span class="op" id="3242807">)</span>&nbsp;<span class="ident" id="3242809">Prepare</span><span class="op" id="3242816">(</span><span class="ident" id="3242817">query</span>&nbsp;<span class="builtintype" id="3242823">string</span><span class="op" id="3242829">)</span>&nbsp;<span class="op" id="3242831">(</span><span class="op" id="3242832">*</span><span class="ident" id="3242833">Stmt</span><span class="op" id="3242837">,</span>&nbsp;<span class="builtintype" id="3242839">error</span><span class="op" id="3242844">)</span>&nbsp;<span class="op" id="3242846">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3242849">//&nbsp;TODO(bradfitz):&nbsp;We&nbsp;could&nbsp;be&nbsp;more&nbsp;efficient&nbsp;here&nbsp;and&nbsp;either</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3242912">//&nbsp;provide&nbsp;a&nbsp;method&nbsp;to&nbsp;take&nbsp;an&nbsp;existing&nbsp;Stmt&nbsp;(created&nbsp;on</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3242970">//&nbsp;perhaps&nbsp;a&nbsp;different&nbsp;Conn),&nbsp;and&nbsp;re-create&nbsp;it&nbsp;on&nbsp;this&nbsp;Conn&nbsp;if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3243034">//&nbsp;necessary.&nbsp;Or,&nbsp;better:&nbsp;keep&nbsp;a&nbsp;map&nbsp;in&nbsp;DB&nbsp;of&nbsp;query&nbsp;string&nbsp;to</span><br>
<span class="lineno">1140</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3243097">//&nbsp;Stmts,&nbsp;and&nbsp;have&nbsp;Stmt.Execute&nbsp;do&nbsp;the&nbsp;right&nbsp;thing&nbsp;and</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3243153">//&nbsp;re-prepare&nbsp;if&nbsp;the&nbsp;Conn&nbsp;in&nbsp;use&nbsp;doesn&#39;t&nbsp;have&nbsp;that&nbsp;prepared</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3243214">//&nbsp;statement.&nbsp;&nbsp;But&nbsp;we&#39;ll&nbsp;want&nbsp;to&nbsp;avoid&nbsp;caching&nbsp;the&nbsp;statement</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3243276">//&nbsp;in&nbsp;the&nbsp;case&nbsp;where&nbsp;we&nbsp;only&nbsp;call&nbsp;conn.Prepare&nbsp;implicitly</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3243335">//&nbsp;(such&nbsp;as&nbsp;in&nbsp;db.Exec&nbsp;or&nbsp;tx.Exec),&nbsp;but&nbsp;the&nbsp;caller&nbsp;package</span><br>
<span class="lineno">1145</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3243395">//&nbsp;can&#39;t&nbsp;be&nbsp;holding&nbsp;a&nbsp;reference&nbsp;to&nbsp;the&nbsp;returned&nbsp;statement.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3243455">//&nbsp;Perhaps&nbsp;just&nbsp;looking&nbsp;at&nbsp;the&nbsp;reference&nbsp;count&nbsp;(by&nbsp;noting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3243514">//&nbsp;Stmt.Close)&nbsp;would&nbsp;be&nbsp;enough.&nbsp;We&nbsp;might&nbsp;also&nbsp;want&nbsp;a&nbsp;finalizer</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3243578">//&nbsp;on&nbsp;Stmt&nbsp;to&nbsp;drop&nbsp;the&nbsp;reference&nbsp;count.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3243619">dc</span><span class="op" id="3243621">,</span>&nbsp;<span class="ident" id="3243623">err</span>&nbsp;<span class="op" id="3243627">:=</span>&nbsp;<span class="ident" id="3243630">tx</span><span class="op" id="3243632">.</span><span class="ident" id="3243633">grabConn</span><span class="op" id="3243641">(</span><span class="op" id="3243642">)</span><br>
<span class="lineno">1150</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3243645">if</span>&nbsp;<span class="ident" id="3243648">err</span>&nbsp;<span class="op" id="3243652">!=</span>&nbsp;<span class="ident" id="3243655">nil</span>&nbsp;<span class="op" id="3243659">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3243663">return</span>&nbsp;<span class="ident" id="3243670">nil</span><span class="op" id="3243673">,</span>&nbsp;<span class="ident" id="3243675">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3243680">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3243684">dc</span><span class="op" id="3243686">.</span><span class="ident" id="3243687">Lock</span><span class="op" id="3243691">(</span><span class="op" id="3243692">)</span><br>
<span class="lineno">1155</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3243695">si</span><span class="op" id="3243697">,</span>&nbsp;<span class="ident" id="3243699">err</span>&nbsp;<span class="op" id="3243703">:=</span>&nbsp;<span class="ident" id="3243706">dc</span><span class="op" id="3243708">.</span><span class="ident" id="3243709">ci</span><span class="op" id="3243711">.</span><span class="ident" id="3243712">Prepare</span><span class="op" id="3243719">(</span><span class="ident" id="3243720">query</span><span class="op" id="3243725">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3243728">dc</span><span class="op" id="3243730">.</span><span class="ident" id="3243731">Unlock</span><span class="op" id="3243737">(</span><span class="op" id="3243738">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3243741">if</span>&nbsp;<span class="ident" id="3243744">err</span>&nbsp;<span class="op" id="3243748">!=</span>&nbsp;<span class="ident" id="3243751">nil</span>&nbsp;<span class="op" id="3243755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3243759">return</span>&nbsp;<span class="ident" id="3243766">nil</span><span class="op" id="3243769">,</span>&nbsp;<span class="ident" id="3243771">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3243776">}</span><br>
<span class="lineno">1160</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3243780">stmt</span>&nbsp;<span class="op" id="3243785">:=</span>&nbsp;<span class="op" id="3243788">&amp;</span><span class="ident" id="3243789">Stmt</span><span class="op" id="3243793">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3243797">db</span><span class="op" id="3243799">:</span>&nbsp;<span class="ident" id="3243801">tx</span><span class="op" id="3243803">.</span><span class="ident" id="3243804">db</span><span class="op" id="3243806">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3243810">tx</span><span class="op" id="3243812">:</span>&nbsp;<span class="ident" id="3243814">tx</span><span class="op" id="3243816">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3243820">txsi</span><span class="op" id="3243824">:</span>&nbsp;<span class="op" id="3243826">&amp;</span><span class="ident" id="3243827">driverStmt</span><span class="op" id="3243837">{</span><br>
<span class="lineno">1165</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3243842">Locker</span><span class="op" id="3243848">:</span>&nbsp;<span class="ident" id="3243850">dc</span><span class="op" id="3243852">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3243857">si</span><span class="op" id="3243859">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3243865">si</span><span class="op" id="3243867">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3243871">}</span><span class="op" id="3243872">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3243876">query</span><span class="op" id="3243881">:</span>&nbsp;<span class="ident" id="3243883">query</span><span class="op" id="3243888">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3243891">}</span><br>
<span class="lineno">1170</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3243894">tx</span><span class="op" id="3243896">.</span><span class="ident" id="3243897">stmts</span><span class="op" id="3243902">.</span><span class="ident" id="3243903">Lock</span><span class="op" id="3243907">(</span><span class="op" id="3243908">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3243911">tx</span><span class="op" id="3243913">.</span><span class="ident" id="3243914">stmts</span><span class="op" id="3243919">.</span><span class="ident" id="3243920">v</span>&nbsp;<span class="op" id="3243922">=</span>&nbsp;<span class="builtinfunc" id="3243924">append</span><span class="op" id="3243930">(</span><span class="ident" id="3243931">tx</span><span class="op" id="3243933">.</span><span class="ident" id="3243934">stmts</span><span class="op" id="3243939">.</span><span class="ident" id="3243940">v</span><span class="op" id="3243941">,</span>&nbsp;<span class="ident" id="3243943">stmt</span><span class="op" id="3243947">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3243950">tx</span><span class="op" id="3243952">.</span><span class="ident" id="3243953">stmts</span><span class="op" id="3243958">.</span><span class="ident" id="3243959">Unlock</span><span class="op" id="3243965">(</span><span class="op" id="3243966">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3243969">return</span>&nbsp;<span class="ident" id="3243976">stmt</span><span class="op" id="3243980">,</span>&nbsp;<span class="ident" id="3243982">nil</span><br>
<span class="lineno"></span><span class="op" id="3243986">}</span><br>
<span class="lineno">1175</span><br>
<span class="lineno"></span><span class="comment" id="3243989">//&nbsp;Stmt&nbsp;returns&nbsp;a&nbsp;transaction-specific&nbsp;prepared&nbsp;statement&nbsp;from</span><br>
<span class="lineno"></span><span class="comment" id="3244052">//&nbsp;an&nbsp;existing&nbsp;statement.</span><br>
<span class="lineno"></span><span class="comment" id="3244078">//</span><br>
<span class="lineno"></span><span class="comment" id="3244081">//&nbsp;Example:</span><br>
<span class="lineno">1180</span><span class="comment" id="3244093">//&nbsp;&nbsp;updateMoney,&nbsp;err&nbsp;:=&nbsp;db.Prepare(&#34;UPDATE&nbsp;balance&nbsp;SET&nbsp;money=money+?&nbsp;WHERE&nbsp;id=?&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="3244175">//&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="comment" id="3244183">//&nbsp;&nbsp;tx,&nbsp;err&nbsp;:=&nbsp;db.Begin()</span><br>
<span class="lineno"></span><span class="comment" id="3244209">//&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="comment" id="3244217">//&nbsp;&nbsp;res,&nbsp;err&nbsp;:=&nbsp;tx.Stmt(updateMoney).Exec(123.45,&nbsp;98293203)</span><br>
<span class="lineno">1185</span><span class="keyword" id="3244277">func</span>&nbsp;<span class="op" id="3244282">(</span><span class="ident" id="3244283">tx</span>&nbsp;<span class="op" id="3244286">*</span><span class="ident" id="3244287">Tx</span><span class="op" id="3244289">)</span>&nbsp;<span class="ident" id="3244291">Stmt</span><span class="op" id="3244295">(</span><span class="ident" id="3244296">stmt</span>&nbsp;<span class="op" id="3244301">*</span><span class="ident" id="3244302">Stmt</span><span class="op" id="3244306">)</span>&nbsp;<span class="op" id="3244308">*</span><span class="ident" id="3244309">Stmt</span>&nbsp;<span class="op" id="3244314">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3244317">//&nbsp;TODO(bradfitz):&nbsp;optimize&nbsp;this.&nbsp;Currently&nbsp;this&nbsp;re-prepares</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3244379">//&nbsp;each&nbsp;time.&nbsp;&nbsp;This&nbsp;is&nbsp;fine&nbsp;for&nbsp;now&nbsp;to&nbsp;illustrate&nbsp;the&nbsp;API&nbsp;but</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3244442">//&nbsp;we&nbsp;should&nbsp;really&nbsp;cache&nbsp;already-prepared&nbsp;statements</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3244497">//&nbsp;per-Conn.&nbsp;See&nbsp;also&nbsp;the&nbsp;big&nbsp;comment&nbsp;in&nbsp;Tx.Prepare.</span><br>
<span class="lineno">1190</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3244552">if</span>&nbsp;<span class="ident" id="3244555">tx</span><span class="op" id="3244557">.</span><span class="ident" id="3244558">db</span>&nbsp;<span class="op" id="3244561">!=</span>&nbsp;<span class="ident" id="3244564">stmt</span><span class="op" id="3244568">.</span><span class="ident" id="3244569">db</span>&nbsp;<span class="op" id="3244572">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3244576">return</span>&nbsp;<span class="op" id="3244583">&amp;</span><span class="ident" id="3244584">Stmt</span><span class="op" id="3244588">{</span><span class="ident" id="3244589">stickyErr</span><span class="op" id="3244598">:</span>&nbsp;<span class="ident" id="3244600">errors</span><span class="op" id="3244606">.</span><span class="ident" id="3244607">New</span><span class="op" id="3244610">(</span><span class="string" id="3244611">&#34;sql:&nbsp;Tx.Stmt:&nbsp;statement&nbsp;from&nbsp;different&nbsp;database&nbsp;used&#34;</span><span class="op" id="3244665">)</span><span class="op" id="3244666">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3244669">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3244672">dc</span><span class="op" id="3244674">,</span>&nbsp;<span class="ident" id="3244676">err</span>&nbsp;<span class="op" id="3244680">:=</span>&nbsp;<span class="ident" id="3244683">tx</span><span class="op" id="3244685">.</span><span class="ident" id="3244686">grabConn</span><span class="op" id="3244694">(</span><span class="op" id="3244695">)</span><br>
<span class="lineno">1195</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3244698">if</span>&nbsp;<span class="ident" id="3244701">err</span>&nbsp;<span class="op" id="3244705">!=</span>&nbsp;<span class="ident" id="3244708">nil</span>&nbsp;<span class="op" id="3244712">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3244716">return</span>&nbsp;<span class="op" id="3244723">&amp;</span><span class="ident" id="3244724">Stmt</span><span class="op" id="3244728">{</span><span class="ident" id="3244729">stickyErr</span><span class="op" id="3244738">:</span>&nbsp;<span class="ident" id="3244740">err</span><span class="op" id="3244743">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3244746">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3244749">dc</span><span class="op" id="3244751">.</span><span class="ident" id="3244752">Lock</span><span class="op" id="3244756">(</span><span class="op" id="3244757">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3244760">si</span><span class="op" id="3244762">,</span>&nbsp;<span class="ident" id="3244764">err</span>&nbsp;<span class="op" id="3244768">:=</span>&nbsp;<span class="ident" id="3244771">dc</span><span class="op" id="3244773">.</span><span class="ident" id="3244774">ci</span><span class="op" id="3244776">.</span><span class="ident" id="3244777">Prepare</span><span class="op" id="3244784">(</span><span class="ident" id="3244785">stmt</span><span class="op" id="3244789">.</span><span class="ident" id="3244790">query</span><span class="op" id="3244795">)</span><br>
<span class="lineno">1200</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3244798">dc</span><span class="op" id="3244800">.</span><span class="ident" id="3244801">Unlock</span><span class="op" id="3244807">(</span><span class="op" id="3244808">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3244811">txs</span>&nbsp;<span class="op" id="3244815">:=</span>&nbsp;<span class="op" id="3244818">&amp;</span><span class="ident" id="3244819">Stmt</span><span class="op" id="3244823">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3244827">db</span><span class="op" id="3244829">:</span>&nbsp;<span class="ident" id="3244831">tx</span><span class="op" id="3244833">.</span><span class="ident" id="3244834">db</span><span class="op" id="3244836">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3244840">tx</span><span class="op" id="3244842">:</span>&nbsp;<span class="ident" id="3244844">tx</span><span class="op" id="3244846">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3244850">txsi</span><span class="op" id="3244854">:</span>&nbsp;<span class="op" id="3244856">&amp;</span><span class="ident" id="3244857">driverStmt</span><span class="op" id="3244867">{</span><br>
<span class="lineno">1205</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3244872">Locker</span><span class="op" id="3244878">:</span>&nbsp;<span class="ident" id="3244880">dc</span><span class="op" id="3244882">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3244887">si</span><span class="op" id="3244889">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3244895">si</span><span class="op" id="3244897">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3244901">}</span><span class="op" id="3244902">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3244906">query</span><span class="op" id="3244911">:</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3244917">stmt</span><span class="op" id="3244921">.</span><span class="ident" id="3244922">query</span><span class="op" id="3244927">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3244931">stickyErr</span><span class="op" id="3244940">:</span>&nbsp;<span class="ident" id="3244942">err</span><span class="op" id="3244945">,</span><br>
<span class="lineno">1210</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3244948">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3244951">tx</span><span class="op" id="3244953">.</span><span class="ident" id="3244954">stmts</span><span class="op" id="3244959">.</span><span class="ident" id="3244960">Lock</span><span class="op" id="3244964">(</span><span class="op" id="3244965">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3244968">tx</span><span class="op" id="3244970">.</span><span class="ident" id="3244971">stmts</span><span class="op" id="3244976">.</span><span class="ident" id="3244977">v</span>&nbsp;<span class="op" id="3244979">=</span>&nbsp;<span class="builtinfunc" id="3244981">append</span><span class="op" id="3244987">(</span><span class="ident" id="3244988">tx</span><span class="op" id="3244990">.</span><span class="ident" id="3244991">stmts</span><span class="op" id="3244996">.</span><span class="ident" id="3244997">v</span><span class="op" id="3244998">,</span>&nbsp;<span class="ident" id="3245000">txs</span><span class="op" id="3245003">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3245006">tx</span><span class="op" id="3245008">.</span><span class="ident" id="3245009">stmts</span><span class="op" id="3245014">.</span><span class="ident" id="3245015">Unlock</span><span class="op" id="3245021">(</span><span class="op" id="3245022">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3245025">return</span>&nbsp;<span class="ident" id="3245032">txs</span><br>
<span class="lineno">1215</span><span class="op" id="3245036">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3245039">//&nbsp;Exec&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;doesn&#39;t&nbsp;return&nbsp;rows.</span><br>
<span class="lineno"></span><span class="comment" id="3245090">//&nbsp;For&nbsp;example:&nbsp;an&nbsp;INSERT&nbsp;and&nbsp;UPDATE.</span><br>
<span class="lineno"></span><span class="keyword" id="3245128">func</span>&nbsp;<span class="op" id="3245133">(</span><span class="ident" id="3245134">tx</span>&nbsp;<span class="op" id="3245137">*</span><span class="ident" id="3245138">Tx</span><span class="op" id="3245140">)</span>&nbsp;<span class="ident" id="3245142">Exec</span><span class="op" id="3245146">(</span><span class="ident" id="3245147">query</span>&nbsp;<span class="builtintype" id="3245153">string</span><span class="op" id="3245159">,</span>&nbsp;<span class="ident" id="3245161">args</span>&nbsp;<span class="op" id="3245166">...</span><span class="keyword" id="3245169">interface</span><span class="op" id="3245178">{</span><span class="op" id="3245179">}</span><span class="op" id="3245180">)</span>&nbsp;<span class="op" id="3245182">(</span><span class="ident" id="3245183">Result</span><span class="op" id="3245189">,</span>&nbsp;<span class="builtintype" id="3245191">error</span><span class="op" id="3245196">)</span>&nbsp;<span class="op" id="3245198">{</span><br>
<span class="lineno">1220</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3245201">dc</span><span class="op" id="3245203">,</span>&nbsp;<span class="ident" id="3245205">err</span>&nbsp;<span class="op" id="3245209">:=</span>&nbsp;<span class="ident" id="3245212">tx</span><span class="op" id="3245214">.</span><span class="ident" id="3245215">grabConn</span><span class="op" id="3245223">(</span><span class="op" id="3245224">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3245227">if</span>&nbsp;<span class="ident" id="3245230">err</span>&nbsp;<span class="op" id="3245234">!=</span>&nbsp;<span class="ident" id="3245237">nil</span>&nbsp;<span class="op" id="3245241">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3245245">return</span>&nbsp;<span class="ident" id="3245252">nil</span><span class="op" id="3245255">,</span>&nbsp;<span class="ident" id="3245257">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3245262">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1225</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3245266">if</span>&nbsp;<span class="ident" id="3245269">execer</span><span class="op" id="3245275">,</span>&nbsp;<span class="ident" id="3245277">ok</span>&nbsp;<span class="op" id="3245280">:=</span>&nbsp;<span class="ident" id="3245283">dc</span><span class="op" id="3245285">.</span><span class="ident" id="3245286">ci</span><span class="op" id="3245288">.</span><span class="op" id="3245289">(</span><span class="ident" id="3245290">driver</span><span class="op" id="3245296">.</span><span class="ident" id="3245297">Execer</span><span class="op" id="3245303">)</span><span class="op" id="3245304">;</span>&nbsp;<span class="ident" id="3245306">ok</span>&nbsp;<span class="op" id="3245309">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3245313">dargs</span><span class="op" id="3245318">,</span>&nbsp;<span class="ident" id="3245320">err</span>&nbsp;<span class="op" id="3245324">:=</span>&nbsp;<span class="ident" id="3245327">driverArgs</span><span class="op" id="3245337">(</span><span class="ident" id="3245338">nil</span><span class="op" id="3245341">,</span>&nbsp;<span class="ident" id="3245343">args</span><span class="op" id="3245347">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3245351">if</span>&nbsp;<span class="ident" id="3245354">err</span>&nbsp;<span class="op" id="3245358">!=</span>&nbsp;<span class="ident" id="3245361">nil</span>&nbsp;<span class="op" id="3245365">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3245370">return</span>&nbsp;<span class="ident" id="3245377">nil</span><span class="op" id="3245380">,</span>&nbsp;<span class="ident" id="3245382">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3245388">}</span><br>
<span class="lineno">1230</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3245392">dc</span><span class="op" id="3245394">.</span><span class="ident" id="3245395">Lock</span><span class="op" id="3245399">(</span><span class="op" id="3245400">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3245404">resi</span><span class="op" id="3245408">,</span>&nbsp;<span class="ident" id="3245410">err</span>&nbsp;<span class="op" id="3245414">:=</span>&nbsp;<span class="ident" id="3245417">execer</span><span class="op" id="3245423">.</span><span class="ident" id="3245424">Exec</span><span class="op" id="3245428">(</span><span class="ident" id="3245429">query</span><span class="op" id="3245434">,</span>&nbsp;<span class="ident" id="3245436">dargs</span><span class="op" id="3245441">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3245445">dc</span><span class="op" id="3245447">.</span><span class="ident" id="3245448">Unlock</span><span class="op" id="3245454">(</span><span class="op" id="3245455">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3245459">if</span>&nbsp;<span class="ident" id="3245462">err</span>&nbsp;<span class="op" id="3245466">==</span>&nbsp;<span class="ident" id="3245469">nil</span>&nbsp;<span class="op" id="3245473">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3245478">return</span>&nbsp;<span class="ident" id="3245485">driverResult</span><span class="op" id="3245497">{</span><span class="ident" id="3245498">dc</span><span class="op" id="3245500">,</span>&nbsp;<span class="ident" id="3245502">resi</span><span class="op" id="3245506">}</span><span class="op" id="3245507">,</span>&nbsp;<span class="ident" id="3245509">nil</span><br>
<span class="lineno">1235</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3245515">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3245519">if</span>&nbsp;<span class="ident" id="3245522">err</span>&nbsp;<span class="op" id="3245526">!=</span>&nbsp;<span class="ident" id="3245529">driver</span><span class="op" id="3245535">.</span><span class="ident" id="3245536">ErrSkip</span>&nbsp;<span class="op" id="3245544">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3245549">return</span>&nbsp;<span class="ident" id="3245556">nil</span><span class="op" id="3245559">,</span>&nbsp;<span class="ident" id="3245561">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3245567">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3245570">}</span><br>
<span class="lineno">1240</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3245574">dc</span><span class="op" id="3245576">.</span><span class="ident" id="3245577">Lock</span><span class="op" id="3245581">(</span><span class="op" id="3245582">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3245585">si</span><span class="op" id="3245587">,</span>&nbsp;<span class="ident" id="3245589">err</span>&nbsp;<span class="op" id="3245593">:=</span>&nbsp;<span class="ident" id="3245596">dc</span><span class="op" id="3245598">.</span><span class="ident" id="3245599">ci</span><span class="op" id="3245601">.</span><span class="ident" id="3245602">Prepare</span><span class="op" id="3245609">(</span><span class="ident" id="3245610">query</span><span class="op" id="3245615">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3245618">dc</span><span class="op" id="3245620">.</span><span class="ident" id="3245621">Unlock</span><span class="op" id="3245627">(</span><span class="op" id="3245628">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3245631">if</span>&nbsp;<span class="ident" id="3245634">err</span>&nbsp;<span class="op" id="3245638">!=</span>&nbsp;<span class="ident" id="3245641">nil</span>&nbsp;<span class="op" id="3245645">{</span><br>
<span class="lineno">1245</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3245649">return</span>&nbsp;<span class="ident" id="3245656">nil</span><span class="op" id="3245659">,</span>&nbsp;<span class="ident" id="3245661">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3245666">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3245669">defer</span>&nbsp;<span class="ident" id="3245675">withLock</span><span class="op" id="3245683">(</span><span class="ident" id="3245684">dc</span><span class="op" id="3245686">,</span>&nbsp;<span class="keyword" id="3245688">func</span><span class="op" id="3245692">(</span><span class="op" id="3245693">)</span>&nbsp;<span class="op" id="3245695">{</span>&nbsp;<span class="ident" id="3245697">si</span><span class="op" id="3245699">.</span><span class="ident" id="3245700">Close</span><span class="op" id="3245705">(</span><span class="op" id="3245706">)</span>&nbsp;<span class="op" id="3245708">}</span><span class="op" id="3245709">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3245713">return</span>&nbsp;<span class="ident" id="3245720">resultFromStatement</span><span class="op" id="3245739">(</span><span class="ident" id="3245740">driverStmt</span><span class="op" id="3245750">{</span><span class="ident" id="3245751">dc</span><span class="op" id="3245753">,</span>&nbsp;<span class="ident" id="3245755">si</span><span class="op" id="3245757">}</span><span class="op" id="3245758">,</span>&nbsp;<span class="ident" id="3245760">args</span><span class="op" id="3245764">...</span><span class="op" id="3245767">)</span><br>
<span class="lineno">1250</span><span class="op" id="3245769">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3245772">//&nbsp;Query&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;returns&nbsp;rows,&nbsp;typically&nbsp;a&nbsp;SELECT.</span><br>
<span class="lineno"></span><span class="keyword" id="3245837">func</span>&nbsp;<span class="op" id="3245842">(</span><span class="ident" id="3245843">tx</span>&nbsp;<span class="op" id="3245846">*</span><span class="ident" id="3245847">Tx</span><span class="op" id="3245849">)</span>&nbsp;<span class="ident" id="3245851">Query</span><span class="op" id="3245856">(</span><span class="ident" id="3245857">query</span>&nbsp;<span class="builtintype" id="3245863">string</span><span class="op" id="3245869">,</span>&nbsp;<span class="ident" id="3245871">args</span>&nbsp;<span class="op" id="3245876">...</span><span class="keyword" id="3245879">interface</span><span class="op" id="3245888">{</span><span class="op" id="3245889">}</span><span class="op" id="3245890">)</span>&nbsp;<span class="op" id="3245892">(</span><span class="op" id="3245893">*</span><span class="ident" id="3245894">Rows</span><span class="op" id="3245898">,</span>&nbsp;<span class="builtintype" id="3245900">error</span><span class="op" id="3245905">)</span>&nbsp;<span class="op" id="3245907">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3245910">dc</span><span class="op" id="3245912">,</span>&nbsp;<span class="ident" id="3245914">err</span>&nbsp;<span class="op" id="3245918">:=</span>&nbsp;<span class="ident" id="3245921">tx</span><span class="op" id="3245923">.</span><span class="ident" id="3245924">grabConn</span><span class="op" id="3245932">(</span><span class="op" id="3245933">)</span><br>
<span class="lineno">1255</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3245936">if</span>&nbsp;<span class="ident" id="3245939">err</span>&nbsp;<span class="op" id="3245943">!=</span>&nbsp;<span class="ident" id="3245946">nil</span>&nbsp;<span class="op" id="3245950">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3245954">return</span>&nbsp;<span class="ident" id="3245961">nil</span><span class="op" id="3245964">,</span>&nbsp;<span class="ident" id="3245966">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3245971">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3245974">releaseConn</span>&nbsp;<span class="op" id="3245986">:=</span>&nbsp;<span class="keyword" id="3245989">func</span><span class="op" id="3245993">(</span><span class="builtintype" id="3245994">error</span><span class="op" id="3245999">)</span>&nbsp;<span class="op" id="3246001">{</span><span class="op" id="3246002">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3246005">return</span>&nbsp;<span class="ident" id="3246012">tx</span><span class="op" id="3246014">.</span><span class="ident" id="3246015">db</span><span class="op" id="3246017">.</span><span class="ident" id="3246018">queryConn</span><span class="op" id="3246027">(</span><span class="ident" id="3246028">dc</span><span class="op" id="3246030">,</span>&nbsp;<span class="ident" id="3246032">releaseConn</span><span class="op" id="3246043">,</span>&nbsp;<span class="ident" id="3246045">query</span><span class="op" id="3246050">,</span>&nbsp;<span class="ident" id="3246052">args</span><span class="op" id="3246056">)</span><br>
<span class="lineno">1260</span><span class="op" id="3246058">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3246061">//&nbsp;QueryRow&nbsp;executes&nbsp;a&nbsp;query&nbsp;that&nbsp;is&nbsp;expected&nbsp;to&nbsp;return&nbsp;at&nbsp;most&nbsp;one&nbsp;row.</span><br>
<span class="lineno"></span><span class="comment" id="3246134">//&nbsp;QueryRow&nbsp;always&nbsp;return&nbsp;a&nbsp;non-nil&nbsp;value.&nbsp;Errors&nbsp;are&nbsp;deferred&nbsp;until</span><br>
<span class="lineno"></span><span class="comment" id="3246203">//&nbsp;Row&#39;s&nbsp;Scan&nbsp;method&nbsp;is&nbsp;called.</span><br>
<span class="lineno">1265</span><span class="keyword" id="3246235">func</span>&nbsp;<span class="op" id="3246240">(</span><span class="ident" id="3246241">tx</span>&nbsp;<span class="op" id="3246244">*</span><span class="ident" id="3246245">Tx</span><span class="op" id="3246247">)</span>&nbsp;<span class="ident" id="3246249">QueryRow</span><span class="op" id="3246257">(</span><span class="ident" id="3246258">query</span>&nbsp;<span class="builtintype" id="3246264">string</span><span class="op" id="3246270">,</span>&nbsp;<span class="ident" id="3246272">args</span>&nbsp;<span class="op" id="3246277">...</span><span class="keyword" id="3246280">interface</span><span class="op" id="3246289">{</span><span class="op" id="3246290">}</span><span class="op" id="3246291">)</span>&nbsp;<span class="op" id="3246293">*</span><span class="ident" id="3246294">Row</span>&nbsp;<span class="op" id="3246298">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3246301">rows</span><span class="op" id="3246305">,</span>&nbsp;<span class="ident" id="3246307">err</span>&nbsp;<span class="op" id="3246311">:=</span>&nbsp;<span class="ident" id="3246314">tx</span><span class="op" id="3246316">.</span><span class="ident" id="3246317">Query</span><span class="op" id="3246322">(</span><span class="ident" id="3246323">query</span><span class="op" id="3246328">,</span>&nbsp;<span class="ident" id="3246330">args</span><span class="op" id="3246334">...</span><span class="op" id="3246337">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3246340">return</span>&nbsp;<span class="op" id="3246347">&amp;</span><span class="ident" id="3246348">Row</span><span class="op" id="3246351">{</span><span class="ident" id="3246352">rows</span><span class="op" id="3246356">:</span>&nbsp;<span class="ident" id="3246358">rows</span><span class="op" id="3246362">,</span>&nbsp;<span class="ident" id="3246364">err</span><span class="op" id="3246367">:</span>&nbsp;<span class="ident" id="3246369">err</span><span class="op" id="3246372">}</span><br>
<span class="lineno"></span><span class="op" id="3246374">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1270</span><span class="comment" id="3246377">//&nbsp;connStmt&nbsp;is&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;on&nbsp;a&nbsp;particular&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3246441">type</span>&nbsp;<span class="ident" id="3246446">connStmt</span>&nbsp;<span class="keyword" id="3246455">struct</span>&nbsp;<span class="op" id="3246462">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3246465">dc</span>&nbsp;<span class="op" id="3246468">*</span><span class="ident" id="3246469">driverConn</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3246481">si</span>&nbsp;<span class="ident" id="3246484">driver</span><span class="op" id="3246490">.</span><span class="ident" id="3246491">Stmt</span><br>
<span class="lineno"></span><span class="op" id="3246496">}</span><br>
<span class="lineno">1275</span><br>
<span class="lineno"></span><span class="comment" id="3246499">//&nbsp;Stmt&nbsp;is&nbsp;a&nbsp;prepared&nbsp;statement.&nbsp;Stmt&nbsp;is&nbsp;safe&nbsp;for&nbsp;concurrent&nbsp;use&nbsp;by&nbsp;multiple&nbsp;goroutines.</span><br>
<span class="lineno"></span><span class="keyword" id="3246588">type</span>&nbsp;<span class="ident" id="3246593">Stmt</span>&nbsp;<span class="keyword" id="3246598">struct</span>&nbsp;<span class="op" id="3246605">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3246608">//&nbsp;Immutable:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3246623">db</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3246633">*</span><span class="ident" id="3246634">DB</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3246640">//&nbsp;where&nbsp;we&nbsp;came&nbsp;from</span><br>
<span class="lineno">1280</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3246663">query</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3246673">string</span>&nbsp;<span class="comment" id="3246680">//&nbsp;that&nbsp;created&nbsp;the&nbsp;Stmt</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3246706">stickyErr</span>&nbsp;<span class="builtintype" id="3246716">error</span>&nbsp;&nbsp;<span class="comment" id="3246723">//&nbsp;if&nbsp;non-nil,&nbsp;this&nbsp;error&nbsp;is&nbsp;returned&nbsp;for&nbsp;all&nbsp;operations</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3246782">closemu</span>&nbsp;<span class="ident" id="3246790">sync</span><span class="op" id="3246794">.</span><span class="ident" id="3246795">RWMutex</span>&nbsp;<span class="comment" id="3246803">//&nbsp;held&nbsp;exclusively&nbsp;during&nbsp;close,&nbsp;for&nbsp;read&nbsp;otherwise.</span><br>
<span class="lineno"></span><br>
<span class="lineno">1285</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3246859">//&nbsp;If&nbsp;in&nbsp;a&nbsp;transaction,&nbsp;else&nbsp;both&nbsp;nil:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3246899">tx</span>&nbsp;&nbsp;&nbsp;<span class="op" id="3246904">*</span><span class="ident" id="3246905">Tx</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3246909">txsi</span>&nbsp;<span class="op" id="3246914">*</span><span class="ident" id="3246915">driverStmt</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3246928">mu</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3246935">sync</span><span class="op" id="3246939">.</span><span class="ident" id="3246940">Mutex</span>&nbsp;<span class="comment" id="3246946">//&nbsp;protects&nbsp;the&nbsp;rest&nbsp;of&nbsp;the&nbsp;fields</span><br>
<span class="lineno">1290</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3246982">closed</span>&nbsp;<span class="builtintype" id="3246989">bool</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3246996">//&nbsp;css&nbsp;is&nbsp;a&nbsp;list&nbsp;of&nbsp;underlying&nbsp;driver&nbsp;statement&nbsp;interfaces</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3247056">//&nbsp;that&nbsp;are&nbsp;valid&nbsp;on&nbsp;particular&nbsp;connections.&nbsp;&nbsp;This&nbsp;is&nbsp;only</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3247116">//&nbsp;used&nbsp;if&nbsp;tx&nbsp;==&nbsp;nil&nbsp;and&nbsp;one&nbsp;is&nbsp;found&nbsp;that&nbsp;has&nbsp;idle</span><br>
<span class="lineno">1295</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3247169">//&nbsp;connections.&nbsp;&nbsp;If&nbsp;tx&nbsp;!=&nbsp;nil,&nbsp;txsi&nbsp;is&nbsp;always&nbsp;used.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3247222">css</span>&nbsp;<span class="op" id="3247226">[</span><span class="op" id="3247227">]</span><span class="ident" id="3247228">connStmt</span><br>
<span class="lineno"></span><span class="op" id="3247237">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3247240">//&nbsp;Exec&nbsp;executes&nbsp;a&nbsp;prepared&nbsp;statement&nbsp;with&nbsp;the&nbsp;given&nbsp;arguments&nbsp;and</span><br>
<span class="lineno">1300</span><span class="comment" id="3247307">//&nbsp;returns&nbsp;a&nbsp;Result&nbsp;summarizing&nbsp;the&nbsp;effect&nbsp;of&nbsp;the&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="3247368">func</span>&nbsp;<span class="op" id="3247373">(</span><span class="ident" id="3247374">s</span>&nbsp;<span class="op" id="3247376">*</span><span class="ident" id="3247377">Stmt</span><span class="op" id="3247381">)</span>&nbsp;<span class="ident" id="3247383">Exec</span><span class="op" id="3247387">(</span><span class="ident" id="3247388">args</span>&nbsp;<span class="op" id="3247393">...</span><span class="keyword" id="3247396">interface</span><span class="op" id="3247405">{</span><span class="op" id="3247406">}</span><span class="op" id="3247407">)</span>&nbsp;<span class="op" id="3247409">(</span><span class="ident" id="3247410">Result</span><span class="op" id="3247416">,</span>&nbsp;<span class="builtintype" id="3247418">error</span><span class="op" id="3247423">)</span>&nbsp;<span class="op" id="3247425">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3247428">s</span><span class="op" id="3247429">.</span><span class="ident" id="3247430">closemu</span><span class="op" id="3247437">.</span><span class="ident" id="3247438">RLock</span><span class="op" id="3247443">(</span><span class="op" id="3247444">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3247447">defer</span>&nbsp;<span class="ident" id="3247453">s</span><span class="op" id="3247454">.</span><span class="ident" id="3247455">closemu</span><span class="op" id="3247462">.</span><span class="ident" id="3247463">RUnlock</span><span class="op" id="3247470">(</span><span class="op" id="3247471">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1305</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3247475">var</span>&nbsp;<span class="ident" id="3247479">res</span>&nbsp;<span class="ident" id="3247483">Result</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3247491">for</span>&nbsp;<span class="ident" id="3247495">i</span>&nbsp;<span class="op" id="3247497">:=</span>&nbsp;<span class="num" id="3247500">0</span><span class="op" id="3247501">;</span>&nbsp;<span class="ident" id="3247503">i</span>&nbsp;<span class="op" id="3247505">&lt;</span>&nbsp;<span class="ident" id="3247507">maxBadConnRetries</span><span class="op" id="3247524">;</span>&nbsp;<span class="ident" id="3247526">i</span><span class="op" id="3247527">++</span>&nbsp;<span class="op" id="3247530">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3247534">dc</span><span class="op" id="3247536">,</span>&nbsp;<span class="ident" id="3247538">releaseConn</span><span class="op" id="3247549">,</span>&nbsp;<span class="ident" id="3247551">si</span><span class="op" id="3247553">,</span>&nbsp;<span class="ident" id="3247555">err</span>&nbsp;<span class="op" id="3247559">:=</span>&nbsp;<span class="ident" id="3247562">s</span><span class="op" id="3247563">.</span><span class="ident" id="3247564">connStmt</span><span class="op" id="3247572">(</span><span class="op" id="3247573">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3247577">if</span>&nbsp;<span class="ident" id="3247580">err</span>&nbsp;<span class="op" id="3247584">!=</span>&nbsp;<span class="ident" id="3247587">nil</span>&nbsp;<span class="op" id="3247591">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3247596">if</span>&nbsp;<span class="ident" id="3247599">err</span>&nbsp;<span class="op" id="3247603">==</span>&nbsp;<span class="ident" id="3247606">driver</span><span class="op" id="3247612">.</span><span class="ident" id="3247613">ErrBadConn</span>&nbsp;<span class="op" id="3247624">{</span><br>
<span class="lineno">1310</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3247630">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3247642">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3247647">return</span>&nbsp;<span class="ident" id="3247654">nil</span><span class="op" id="3247657">,</span>&nbsp;<span class="ident" id="3247659">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3247665">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1315</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3247670">res</span><span class="op" id="3247673">,</span>&nbsp;<span class="ident" id="3247675">err</span>&nbsp;<span class="op" id="3247679">=</span>&nbsp;<span class="ident" id="3247681">resultFromStatement</span><span class="op" id="3247700">(</span><span class="ident" id="3247701">driverStmt</span><span class="op" id="3247711">{</span><span class="ident" id="3247712">dc</span><span class="op" id="3247714">,</span>&nbsp;<span class="ident" id="3247716">si</span><span class="op" id="3247718">}</span><span class="op" id="3247719">,</span>&nbsp;<span class="ident" id="3247721">args</span><span class="op" id="3247725">...</span><span class="op" id="3247728">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3247732">releaseConn</span><span class="op" id="3247743">(</span><span class="ident" id="3247744">err</span><span class="op" id="3247747">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3247751">if</span>&nbsp;<span class="ident" id="3247754">err</span>&nbsp;<span class="op" id="3247758">!=</span>&nbsp;<span class="ident" id="3247761">driver</span><span class="op" id="3247767">.</span><span class="ident" id="3247768">ErrBadConn</span>&nbsp;<span class="op" id="3247779">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3247784">return</span>&nbsp;<span class="ident" id="3247791">res</span><span class="op" id="3247794">,</span>&nbsp;<span class="ident" id="3247796">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3247802">}</span><br>
<span class="lineno">1320</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3247805">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3247808">return</span>&nbsp;<span class="ident" id="3247815">nil</span><span class="op" id="3247818">,</span>&nbsp;<span class="ident" id="3247820">driver</span><span class="op" id="3247826">.</span><span class="ident" id="3247827">ErrBadConn</span><br>
<span class="lineno"></span><span class="op" id="3247838">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3247841">func</span>&nbsp;<span class="ident" id="3247846">resultFromStatement</span><span class="op" id="3247865">(</span><span class="ident" id="3247866">ds</span>&nbsp;<span class="ident" id="3247869">driverStmt</span><span class="op" id="3247879">,</span>&nbsp;<span class="ident" id="3247881">args</span>&nbsp;<span class="op" id="3247886">...</span><span class="keyword" id="3247889">interface</span><span class="op" id="3247898">{</span><span class="op" id="3247899">}</span><span class="op" id="3247900">)</span>&nbsp;<span class="op" id="3247902">(</span><span class="ident" id="3247903">Result</span><span class="op" id="3247909">,</span>&nbsp;<span class="builtintype" id="3247911">error</span><span class="op" id="3247916">)</span>&nbsp;<span class="op" id="3247918">{</span><br>
<span class="lineno">1325</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3247921">ds</span><span class="op" id="3247923">.</span><span class="ident" id="3247924">Lock</span><span class="op" id="3247928">(</span><span class="op" id="3247929">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3247932">want</span>&nbsp;<span class="op" id="3247937">:=</span>&nbsp;<span class="ident" id="3247940">ds</span><span class="op" id="3247942">.</span><span class="ident" id="3247943">si</span><span class="op" id="3247945">.</span><span class="ident" id="3247946">NumInput</span><span class="op" id="3247954">(</span><span class="op" id="3247955">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3247958">ds</span><span class="op" id="3247960">.</span><span class="ident" id="3247961">Unlock</span><span class="op" id="3247967">(</span><span class="op" id="3247968">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3247972">//&nbsp;-1&nbsp;means&nbsp;the&nbsp;driver&nbsp;doesn&#39;t&nbsp;know&nbsp;how&nbsp;to&nbsp;count&nbsp;the&nbsp;number&nbsp;of</span><br>
<span class="lineno">1330</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3248036">//&nbsp;placeholders,&nbsp;so&nbsp;we&nbsp;won&#39;t&nbsp;sanity&nbsp;check&nbsp;input&nbsp;here&nbsp;and&nbsp;instead&nbsp;let&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3248110">//&nbsp;driver&nbsp;deal&nbsp;with&nbsp;errors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3248139">if</span>&nbsp;<span class="ident" id="3248142">want</span>&nbsp;<span class="op" id="3248147">!=</span>&nbsp;<span class="op" id="3248150">-</span><span class="num" id="3248151">1</span>&nbsp;<span class="op" id="3248153">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3248156">len</span><span class="op" id="3248159">(</span><span class="ident" id="3248160">args</span><span class="op" id="3248164">)</span>&nbsp;<span class="op" id="3248166">!=</span>&nbsp;<span class="ident" id="3248169">want</span>&nbsp;<span class="op" id="3248174">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3248178">return</span>&nbsp;<span class="ident" id="3248185">nil</span><span class="op" id="3248188">,</span>&nbsp;<span class="ident" id="3248190">fmt</span><span class="op" id="3248193">.</span><span class="ident" id="3248194">Errorf</span><span class="op" id="3248200">(</span><span class="string" id="3248201">&#34;sql:&nbsp;expected&nbsp;%d&nbsp;arguments,&nbsp;got&nbsp;%d&#34;</span><span class="op" id="3248237">,</span>&nbsp;<span class="ident" id="3248239">want</span><span class="op" id="3248243">,</span>&nbsp;<span class="builtinfunc" id="3248245">len</span><span class="op" id="3248248">(</span><span class="ident" id="3248249">args</span><span class="op" id="3248253">)</span><span class="op" id="3248254">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3248257">}</span><br>
<span class="lineno">1335</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3248261">dargs</span><span class="op" id="3248266">,</span>&nbsp;<span class="ident" id="3248268">err</span>&nbsp;<span class="op" id="3248272">:=</span>&nbsp;<span class="ident" id="3248275">driverArgs</span><span class="op" id="3248285">(</span><span class="op" id="3248286">&amp;</span><span class="ident" id="3248287">ds</span><span class="op" id="3248289">,</span>&nbsp;<span class="ident" id="3248291">args</span><span class="op" id="3248295">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3248298">if</span>&nbsp;<span class="ident" id="3248301">err</span>&nbsp;<span class="op" id="3248305">!=</span>&nbsp;<span class="ident" id="3248308">nil</span>&nbsp;<span class="op" id="3248312">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3248316">return</span>&nbsp;<span class="ident" id="3248323">nil</span><span class="op" id="3248326">,</span>&nbsp;<span class="ident" id="3248328">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3248333">}</span><br>
<span class="lineno">1340</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3248337">ds</span><span class="op" id="3248339">.</span><span class="ident" id="3248340">Lock</span><span class="op" id="3248344">(</span><span class="op" id="3248345">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3248348">resi</span><span class="op" id="3248352">,</span>&nbsp;<span class="ident" id="3248354">err</span>&nbsp;<span class="op" id="3248358">:=</span>&nbsp;<span class="ident" id="3248361">ds</span><span class="op" id="3248363">.</span><span class="ident" id="3248364">si</span><span class="op" id="3248366">.</span><span class="ident" id="3248367">Exec</span><span class="op" id="3248371">(</span><span class="ident" id="3248372">dargs</span><span class="op" id="3248377">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3248380">ds</span><span class="op" id="3248382">.</span><span class="ident" id="3248383">Unlock</span><span class="op" id="3248389">(</span><span class="op" id="3248390">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3248393">if</span>&nbsp;<span class="ident" id="3248396">err</span>&nbsp;<span class="op" id="3248400">!=</span>&nbsp;<span class="ident" id="3248403">nil</span>&nbsp;<span class="op" id="3248407">{</span><br>
<span class="lineno">1345</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3248411">return</span>&nbsp;<span class="ident" id="3248418">nil</span><span class="op" id="3248421">,</span>&nbsp;<span class="ident" id="3248423">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3248428">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3248431">return</span>&nbsp;<span class="ident" id="3248438">driverResult</span><span class="op" id="3248450">{</span><span class="ident" id="3248451">ds</span><span class="op" id="3248453">.</span><span class="ident" id="3248454">Locker</span><span class="op" id="3248460">,</span>&nbsp;<span class="ident" id="3248462">resi</span><span class="op" id="3248466">}</span><span class="op" id="3248467">,</span>&nbsp;<span class="ident" id="3248469">nil</span><br>
<span class="lineno"></span><span class="op" id="3248473">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1350</span><span class="comment" id="3248476">//&nbsp;connStmt&nbsp;returns&nbsp;a&nbsp;free&nbsp;driver&nbsp;connection&nbsp;on&nbsp;which&nbsp;to&nbsp;execute&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3248545">//&nbsp;statement,&nbsp;a&nbsp;function&nbsp;to&nbsp;call&nbsp;to&nbsp;release&nbsp;the&nbsp;connection,&nbsp;and&nbsp;a</span><br>
<span class="lineno"></span><span class="comment" id="3248611">//&nbsp;statement&nbsp;bound&nbsp;to&nbsp;that&nbsp;connection.</span><br>
<span class="lineno"></span><span class="keyword" id="3248650">func</span>&nbsp;<span class="op" id="3248655">(</span><span class="ident" id="3248656">s</span>&nbsp;<span class="op" id="3248658">*</span><span class="ident" id="3248659">Stmt</span><span class="op" id="3248663">)</span>&nbsp;<span class="ident" id="3248665">connStmt</span><span class="op" id="3248673">(</span><span class="op" id="3248674">)</span>&nbsp;<span class="op" id="3248676">(</span><span class="ident" id="3248677">ci</span>&nbsp;<span class="op" id="3248680">*</span><span class="ident" id="3248681">driverConn</span><span class="op" id="3248691">,</span>&nbsp;<span class="ident" id="3248693">releaseConn</span>&nbsp;<span class="keyword" id="3248705">func</span><span class="op" id="3248709">(</span><span class="builtintype" id="3248710">error</span><span class="op" id="3248715">)</span><span class="op" id="3248716">,</span>&nbsp;<span class="ident" id="3248718">si</span>&nbsp;<span class="ident" id="3248721">driver</span><span class="op" id="3248727">.</span><span class="ident" id="3248728">Stmt</span><span class="op" id="3248732">,</span>&nbsp;<span class="ident" id="3248734">err</span>&nbsp;<span class="builtintype" id="3248738">error</span><span class="op" id="3248743">)</span>&nbsp;<span class="op" id="3248745">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3248748">if</span>&nbsp;<span class="ident" id="3248751">err</span>&nbsp;<span class="op" id="3248755">=</span>&nbsp;<span class="ident" id="3248757">s</span><span class="op" id="3248758">.</span><span class="ident" id="3248759">stickyErr</span><span class="op" id="3248768">;</span>&nbsp;<span class="ident" id="3248770">err</span>&nbsp;<span class="op" id="3248774">!=</span>&nbsp;<span class="ident" id="3248777">nil</span>&nbsp;<span class="op" id="3248781">{</span><br>
<span class="lineno">1355</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3248785">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3248793">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3248796">s</span><span class="op" id="3248797">.</span><span class="ident" id="3248798">mu</span><span class="op" id="3248800">.</span><span class="ident" id="3248801">Lock</span><span class="op" id="3248805">(</span><span class="op" id="3248806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3248809">if</span>&nbsp;<span class="ident" id="3248812">s</span><span class="op" id="3248813">.</span><span class="ident" id="3248814">closed</span>&nbsp;<span class="op" id="3248821">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3248825">s</span><span class="op" id="3248826">.</span><span class="ident" id="3248827">mu</span><span class="op" id="3248829">.</span><span class="ident" id="3248830">Unlock</span><span class="op" id="3248836">(</span><span class="op" id="3248837">)</span><br>
<span class="lineno">1360</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3248841">err</span>&nbsp;<span class="op" id="3248845">=</span>&nbsp;<span class="ident" id="3248847">errors</span><span class="op" id="3248853">.</span><span class="ident" id="3248854">New</span><span class="op" id="3248857">(</span><span class="string" id="3248858">&#34;sql:&nbsp;statement&nbsp;is&nbsp;closed&#34;</span><span class="op" id="3248884">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3248888">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3248896">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3248900">//&nbsp;In&nbsp;a&nbsp;transaction,&nbsp;we&nbsp;always&nbsp;use&nbsp;the&nbsp;connection&nbsp;that&nbsp;the</span><br>
<span class="lineno">1365</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3248960">//&nbsp;transaction&nbsp;was&nbsp;created&nbsp;on.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3248992">if</span>&nbsp;<span class="ident" id="3248995">s</span><span class="op" id="3248996">.</span><span class="ident" id="3248997">tx</span>&nbsp;<span class="op" id="3249000">!=</span>&nbsp;<span class="ident" id="3249003">nil</span>&nbsp;<span class="op" id="3249007">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3249011">s</span><span class="op" id="3249012">.</span><span class="ident" id="3249013">mu</span><span class="op" id="3249015">.</span><span class="ident" id="3249016">Unlock</span><span class="op" id="3249022">(</span><span class="op" id="3249023">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3249027">ci</span><span class="op" id="3249029">,</span>&nbsp;<span class="ident" id="3249031">err</span>&nbsp;<span class="op" id="3249035">=</span>&nbsp;<span class="ident" id="3249037">s</span><span class="op" id="3249038">.</span><span class="ident" id="3249039">tx</span><span class="op" id="3249041">.</span><span class="ident" id="3249042">grabConn</span><span class="op" id="3249050">(</span><span class="op" id="3249051">)</span>&nbsp;<span class="comment" id="3249053">//&nbsp;blocks,&nbsp;waiting&nbsp;for&nbsp;the&nbsp;connection.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3249094">if</span>&nbsp;<span class="ident" id="3249097">err</span>&nbsp;<span class="op" id="3249101">!=</span>&nbsp;<span class="ident" id="3249104">nil</span>&nbsp;<span class="op" id="3249108">{</span><br>
<span class="lineno">1370</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3249113">return</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3249122">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3249126">releaseConn</span>&nbsp;<span class="op" id="3249138">=</span>&nbsp;<span class="keyword" id="3249140">func</span><span class="op" id="3249144">(</span><span class="builtintype" id="3249145">error</span><span class="op" id="3249150">)</span>&nbsp;<span class="op" id="3249152">{</span><span class="op" id="3249153">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3249157">return</span>&nbsp;<span class="ident" id="3249164">ci</span><span class="op" id="3249166">,</span>&nbsp;<span class="ident" id="3249168">releaseConn</span><span class="op" id="3249179">,</span>&nbsp;<span class="ident" id="3249181">s</span><span class="op" id="3249182">.</span><span class="ident" id="3249183">txsi</span><span class="op" id="3249187">.</span><span class="ident" id="3249188">si</span><span class="op" id="3249190">,</span>&nbsp;<span class="ident" id="3249192">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3249197">}</span><br>
<span class="lineno">1375</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3249201">for</span>&nbsp;<span class="ident" id="3249205">i</span>&nbsp;<span class="op" id="3249207">:=</span>&nbsp;<span class="num" id="3249210">0</span><span class="op" id="3249211">;</span>&nbsp;<span class="ident" id="3249213">i</span>&nbsp;<span class="op" id="3249215">&lt;</span>&nbsp;<span class="builtinfunc" id="3249217">len</span><span class="op" id="3249220">(</span><span class="ident" id="3249221">s</span><span class="op" id="3249222">.</span><span class="ident" id="3249223">css</span><span class="op" id="3249226">)</span><span class="op" id="3249227">;</span>&nbsp;<span class="ident" id="3249229">i</span><span class="op" id="3249230">++</span>&nbsp;<span class="op" id="3249233">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3249237">v</span>&nbsp;<span class="op" id="3249239">:=</span>&nbsp;<span class="ident" id="3249242">s</span><span class="op" id="3249243">.</span><span class="ident" id="3249244">css</span><span class="op" id="3249247">[</span><span class="ident" id="3249248">i</span><span class="op" id="3249249">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3249253">_</span><span class="op" id="3249254">,</span>&nbsp;<span class="ident" id="3249256">err</span>&nbsp;<span class="op" id="3249260">:=</span>&nbsp;<span class="ident" id="3249263">s</span><span class="op" id="3249264">.</span><span class="ident" id="3249265">db</span><span class="op" id="3249267">.</span><span class="ident" id="3249268">connIfFree</span><span class="op" id="3249278">(</span><span class="ident" id="3249279">v</span><span class="op" id="3249280">.</span><span class="ident" id="3249281">dc</span><span class="op" id="3249283">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3249287">if</span>&nbsp;<span class="ident" id="3249290">err</span>&nbsp;<span class="op" id="3249294">==</span>&nbsp;<span class="ident" id="3249297">nil</span>&nbsp;<span class="op" id="3249301">{</span><br>
<span class="lineno">1380</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3249306">s</span><span class="op" id="3249307">.</span><span class="ident" id="3249308">mu</span><span class="op" id="3249310">.</span><span class="ident" id="3249311">Unlock</span><span class="op" id="3249317">(</span><span class="op" id="3249318">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3249323">return</span>&nbsp;<span class="ident" id="3249330">v</span><span class="op" id="3249331">.</span><span class="ident" id="3249332">dc</span><span class="op" id="3249334">,</span>&nbsp;<span class="ident" id="3249336">v</span><span class="op" id="3249337">.</span><span class="ident" id="3249338">dc</span><span class="op" id="3249340">.</span><span class="ident" id="3249341">releaseConn</span><span class="op" id="3249352">,</span>&nbsp;<span class="ident" id="3249354">v</span><span class="op" id="3249355">.</span><span class="ident" id="3249356">si</span><span class="op" id="3249358">,</span>&nbsp;<span class="ident" id="3249360">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3249366">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3249370">if</span>&nbsp;<span class="ident" id="3249373">err</span>&nbsp;<span class="op" id="3249377">==</span>&nbsp;<span class="ident" id="3249380">errConnClosed</span>&nbsp;<span class="op" id="3249394">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3249399">//&nbsp;Lazily&nbsp;remove&nbsp;dead&nbsp;conn&nbsp;from&nbsp;our&nbsp;freelist.</span><br>
<span class="lineno">1385</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3249448">s</span><span class="op" id="3249449">.</span><span class="ident" id="3249450">css</span><span class="op" id="3249453">[</span><span class="ident" id="3249454">i</span><span class="op" id="3249455">]</span>&nbsp;<span class="op" id="3249457">=</span>&nbsp;<span class="ident" id="3249459">s</span><span class="op" id="3249460">.</span><span class="ident" id="3249461">css</span><span class="op" id="3249464">[</span><span class="builtinfunc" id="3249465">len</span><span class="op" id="3249468">(</span><span class="ident" id="3249469">s</span><span class="op" id="3249470">.</span><span class="ident" id="3249471">css</span><span class="op" id="3249474">)</span><span class="op" id="3249475">-</span><span class="num" id="3249476">1</span><span class="op" id="3249477">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3249482">s</span><span class="op" id="3249483">.</span><span class="ident" id="3249484">css</span>&nbsp;<span class="op" id="3249488">=</span>&nbsp;<span class="ident" id="3249490">s</span><span class="op" id="3249491">.</span><span class="ident" id="3249492">css</span><span class="op" id="3249495">[</span><span class="op" id="3249496">:</span><span class="builtinfunc" id="3249497">len</span><span class="op" id="3249500">(</span><span class="ident" id="3249501">s</span><span class="op" id="3249502">.</span><span class="ident" id="3249503">css</span><span class="op" id="3249506">)</span><span class="op" id="3249507">-</span><span class="num" id="3249508">1</span><span class="op" id="3249509">]</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3249514">i</span><span class="op" id="3249515">--</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3249520">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1390</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3249524">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3249527">s</span><span class="op" id="3249528">.</span><span class="ident" id="3249529">mu</span><span class="op" id="3249531">.</span><span class="ident" id="3249532">Unlock</span><span class="op" id="3249538">(</span><span class="op" id="3249539">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3249543">//&nbsp;If&nbsp;all&nbsp;connections&nbsp;are&nbsp;busy,&nbsp;either&nbsp;wait&nbsp;for&nbsp;one&nbsp;to&nbsp;become&nbsp;available&nbsp;(if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3249620">//&nbsp;we&#39;ve&nbsp;already&nbsp;hit&nbsp;the&nbsp;maximum&nbsp;number&nbsp;of&nbsp;open&nbsp;connections)&nbsp;or&nbsp;create&nbsp;a</span><br>
<span class="lineno">1395</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3249694">//&nbsp;new&nbsp;one.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3249707">//</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3249711">//&nbsp;TODO(bradfitz):&nbsp;or&nbsp;always&nbsp;wait&nbsp;for&nbsp;one?&nbsp;make&nbsp;configurable&nbsp;later?</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3249780">dc</span><span class="op" id="3249782">,</span>&nbsp;<span class="ident" id="3249784">err</span>&nbsp;<span class="op" id="3249788">:=</span>&nbsp;<span class="ident" id="3249791">s</span><span class="op" id="3249792">.</span><span class="ident" id="3249793">db</span><span class="op" id="3249795">.</span><span class="ident" id="3249796">conn</span><span class="op" id="3249800">(</span><span class="op" id="3249801">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3249804">if</span>&nbsp;<span class="ident" id="3249807">err</span>&nbsp;<span class="op" id="3249811">!=</span>&nbsp;<span class="ident" id="3249814">nil</span>&nbsp;<span class="op" id="3249818">{</span><br>
<span class="lineno">1400</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3249822">return</span>&nbsp;<span class="ident" id="3249829">nil</span><span class="op" id="3249832">,</span>&nbsp;<span class="ident" id="3249834">nil</span><span class="op" id="3249837">,</span>&nbsp;<span class="ident" id="3249839">nil</span><span class="op" id="3249842">,</span>&nbsp;<span class="ident" id="3249844">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3249849">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3249853">//&nbsp;Do&nbsp;another&nbsp;pass&nbsp;over&nbsp;the&nbsp;list&nbsp;to&nbsp;see&nbsp;whether&nbsp;this&nbsp;statement&nbsp;has</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3249921">//&nbsp;already&nbsp;been&nbsp;prepared&nbsp;on&nbsp;the&nbsp;connection&nbsp;assigned&nbsp;to&nbsp;us.</span><br>
<span class="lineno">1405</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3249981">s</span><span class="op" id="3249982">.</span><span class="ident" id="3249983">mu</span><span class="op" id="3249985">.</span><span class="ident" id="3249986">Lock</span><span class="op" id="3249990">(</span><span class="op" id="3249991">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3249994">for</span>&nbsp;<span class="ident" id="3249998">_</span><span class="op" id="3249999">,</span>&nbsp;<span class="ident" id="3250001">v</span>&nbsp;<span class="op" id="3250003">:=</span>&nbsp;<span class="keyword" id="3250006">range</span>&nbsp;<span class="ident" id="3250012">s</span><span class="op" id="3250013">.</span><span class="ident" id="3250014">css</span>&nbsp;<span class="op" id="3250018">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3250022">if</span>&nbsp;<span class="ident" id="3250025">v</span><span class="op" id="3250026">.</span><span class="ident" id="3250027">dc</span>&nbsp;<span class="op" id="3250030">==</span>&nbsp;<span class="ident" id="3250033">dc</span>&nbsp;<span class="op" id="3250036">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3250041">s</span><span class="op" id="3250042">.</span><span class="ident" id="3250043">mu</span><span class="op" id="3250045">.</span><span class="ident" id="3250046">Unlock</span><span class="op" id="3250052">(</span><span class="op" id="3250053">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3250058">return</span>&nbsp;<span class="ident" id="3250065">dc</span><span class="op" id="3250067">,</span>&nbsp;<span class="ident" id="3250069">dc</span><span class="op" id="3250071">.</span><span class="ident" id="3250072">releaseConn</span><span class="op" id="3250083">,</span>&nbsp;<span class="ident" id="3250085">v</span><span class="op" id="3250086">.</span><span class="ident" id="3250087">si</span><span class="op" id="3250089">,</span>&nbsp;<span class="ident" id="3250091">nil</span><br>
<span class="lineno">1410</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3250097">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3250100">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3250103">s</span><span class="op" id="3250104">.</span><span class="ident" id="3250105">mu</span><span class="op" id="3250107">.</span><span class="ident" id="3250108">Unlock</span><span class="op" id="3250114">(</span><span class="op" id="3250115">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3250119">//&nbsp;No&nbsp;luck;&nbsp;we&nbsp;need&nbsp;to&nbsp;prepare&nbsp;the&nbsp;statement&nbsp;on&nbsp;this&nbsp;connection</span><br>
<span class="lineno">1415</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3250184">dc</span><span class="op" id="3250186">.</span><span class="ident" id="3250187">Lock</span><span class="op" id="3250191">(</span><span class="op" id="3250192">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3250195">si</span><span class="op" id="3250197">,</span>&nbsp;<span class="ident" id="3250199">err</span>&nbsp;<span class="op" id="3250203">=</span>&nbsp;<span class="ident" id="3250205">dc</span><span class="op" id="3250207">.</span><span class="ident" id="3250208">prepareLocked</span><span class="op" id="3250221">(</span><span class="ident" id="3250222">s</span><span class="op" id="3250223">.</span><span class="ident" id="3250224">query</span><span class="op" id="3250229">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3250232">dc</span><span class="op" id="3250234">.</span><span class="ident" id="3250235">Unlock</span><span class="op" id="3250241">(</span><span class="op" id="3250242">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3250245">if</span>&nbsp;<span class="ident" id="3250248">err</span>&nbsp;<span class="op" id="3250252">!=</span>&nbsp;<span class="ident" id="3250255">nil</span>&nbsp;<span class="op" id="3250259">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3250263">s</span><span class="op" id="3250264">.</span><span class="ident" id="3250265">db</span><span class="op" id="3250267">.</span><span class="ident" id="3250268">putConn</span><span class="op" id="3250275">(</span><span class="ident" id="3250276">dc</span><span class="op" id="3250278">,</span>&nbsp;<span class="ident" id="3250280">err</span><span class="op" id="3250283">)</span><br>
<span class="lineno">1420</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3250287">return</span>&nbsp;<span class="ident" id="3250294">nil</span><span class="op" id="3250297">,</span>&nbsp;<span class="ident" id="3250299">nil</span><span class="op" id="3250302">,</span>&nbsp;<span class="ident" id="3250304">nil</span><span class="op" id="3250307">,</span>&nbsp;<span class="ident" id="3250309">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3250314">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3250317">s</span><span class="op" id="3250318">.</span><span class="ident" id="3250319">mu</span><span class="op" id="3250321">.</span><span class="ident" id="3250322">Lock</span><span class="op" id="3250326">(</span><span class="op" id="3250327">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3250330">cs</span>&nbsp;<span class="op" id="3250333">:=</span>&nbsp;<span class="ident" id="3250336">connStmt</span><span class="op" id="3250344">{</span><span class="ident" id="3250345">dc</span><span class="op" id="3250347">,</span>&nbsp;<span class="ident" id="3250349">si</span><span class="op" id="3250351">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3250354">s</span><span class="op" id="3250355">.</span><span class="ident" id="3250356">css</span>&nbsp;<span class="op" id="3250360">=</span>&nbsp;<span class="builtinfunc" id="3250362">append</span><span class="op" id="3250368">(</span><span class="ident" id="3250369">s</span><span class="op" id="3250370">.</span><span class="ident" id="3250371">css</span><span class="op" id="3250374">,</span>&nbsp;<span class="ident" id="3250376">cs</span><span class="op" id="3250378">)</span><br>
<span class="lineno">1425</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3250381">s</span><span class="op" id="3250382">.</span><span class="ident" id="3250383">mu</span><span class="op" id="3250385">.</span><span class="ident" id="3250386">Unlock</span><span class="op" id="3250392">(</span><span class="op" id="3250393">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3250397">return</span>&nbsp;<span class="ident" id="3250404">dc</span><span class="op" id="3250406">,</span>&nbsp;<span class="ident" id="3250408">dc</span><span class="op" id="3250410">.</span><span class="ident" id="3250411">releaseConn</span><span class="op" id="3250422">,</span>&nbsp;<span class="ident" id="3250424">si</span><span class="op" id="3250426">,</span>&nbsp;<span class="ident" id="3250428">nil</span><br>
<span class="lineno"></span><span class="op" id="3250432">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1430</span><span class="comment" id="3250435">//&nbsp;Query&nbsp;executes&nbsp;a&nbsp;prepared&nbsp;query&nbsp;statement&nbsp;with&nbsp;the&nbsp;given&nbsp;arguments</span><br>
<span class="lineno"></span><span class="comment" id="3250505">//&nbsp;and&nbsp;returns&nbsp;the&nbsp;query&nbsp;results&nbsp;as&nbsp;a&nbsp;*Rows.</span><br>
<span class="lineno"></span><span class="keyword" id="3250550">func</span>&nbsp;<span class="op" id="3250555">(</span><span class="ident" id="3250556">s</span>&nbsp;<span class="op" id="3250558">*</span><span class="ident" id="3250559">Stmt</span><span class="op" id="3250563">)</span>&nbsp;<span class="ident" id="3250565">Query</span><span class="op" id="3250570">(</span><span class="ident" id="3250571">args</span>&nbsp;<span class="op" id="3250576">...</span><span class="keyword" id="3250579">interface</span><span class="op" id="3250588">{</span><span class="op" id="3250589">}</span><span class="op" id="3250590">)</span>&nbsp;<span class="op" id="3250592">(</span><span class="op" id="3250593">*</span><span class="ident" id="3250594">Rows</span><span class="op" id="3250598">,</span>&nbsp;<span class="builtintype" id="3250600">error</span><span class="op" id="3250605">)</span>&nbsp;<span class="op" id="3250607">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3250610">s</span><span class="op" id="3250611">.</span><span class="ident" id="3250612">closemu</span><span class="op" id="3250619">.</span><span class="ident" id="3250620">RLock</span><span class="op" id="3250625">(</span><span class="op" id="3250626">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3250629">defer</span>&nbsp;<span class="ident" id="3250635">s</span><span class="op" id="3250636">.</span><span class="ident" id="3250637">closemu</span><span class="op" id="3250644">.</span><span class="ident" id="3250645">RUnlock</span><span class="op" id="3250652">(</span><span class="op" id="3250653">)</span><br>
<span class="lineno">1435</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3250657">var</span>&nbsp;<span class="ident" id="3250661">rowsi</span>&nbsp;<span class="ident" id="3250667">driver</span><span class="op" id="3250673">.</span><span class="ident" id="3250674">Rows</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3250680">for</span>&nbsp;<span class="ident" id="3250684">i</span>&nbsp;<span class="op" id="3250686">:=</span>&nbsp;<span class="num" id="3250689">0</span><span class="op" id="3250690">;</span>&nbsp;<span class="ident" id="3250692">i</span>&nbsp;<span class="op" id="3250694">&lt;</span>&nbsp;<span class="ident" id="3250696">maxBadConnRetries</span><span class="op" id="3250713">;</span>&nbsp;<span class="ident" id="3250715">i</span><span class="op" id="3250716">++</span>&nbsp;<span class="op" id="3250719">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3250723">dc</span><span class="op" id="3250725">,</span>&nbsp;<span class="ident" id="3250727">releaseConn</span><span class="op" id="3250738">,</span>&nbsp;<span class="ident" id="3250740">si</span><span class="op" id="3250742">,</span>&nbsp;<span class="ident" id="3250744">err</span>&nbsp;<span class="op" id="3250748">:=</span>&nbsp;<span class="ident" id="3250751">s</span><span class="op" id="3250752">.</span><span class="ident" id="3250753">connStmt</span><span class="op" id="3250761">(</span><span class="op" id="3250762">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3250766">if</span>&nbsp;<span class="ident" id="3250769">err</span>&nbsp;<span class="op" id="3250773">!=</span>&nbsp;<span class="ident" id="3250776">nil</span>&nbsp;<span class="op" id="3250780">{</span><br>
<span class="lineno">1440</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3250785">if</span>&nbsp;<span class="ident" id="3250788">err</span>&nbsp;<span class="op" id="3250792">==</span>&nbsp;<span class="ident" id="3250795">driver</span><span class="op" id="3250801">.</span><span class="ident" id="3250802">ErrBadConn</span>&nbsp;<span class="op" id="3250813">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3250819">continue</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3250831">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3250836">return</span>&nbsp;<span class="ident" id="3250843">nil</span><span class="op" id="3250846">,</span>&nbsp;<span class="ident" id="3250848">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3250854">}</span><br>
<span class="lineno">1445</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3250859">rowsi</span><span class="op" id="3250864">,</span>&nbsp;<span class="ident" id="3250866">err</span>&nbsp;<span class="op" id="3250870">=</span>&nbsp;<span class="ident" id="3250872">rowsiFromStatement</span><span class="op" id="3250890">(</span><span class="ident" id="3250891">driverStmt</span><span class="op" id="3250901">{</span><span class="ident" id="3250902">dc</span><span class="op" id="3250904">,</span>&nbsp;<span class="ident" id="3250906">si</span><span class="op" id="3250908">}</span><span class="op" id="3250909">,</span>&nbsp;<span class="ident" id="3250911">args</span><span class="op" id="3250915">...</span><span class="op" id="3250918">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3250922">if</span>&nbsp;<span class="ident" id="3250925">err</span>&nbsp;<span class="op" id="3250929">==</span>&nbsp;<span class="ident" id="3250932">nil</span>&nbsp;<span class="op" id="3250936">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3250941">//&nbsp;Note:&nbsp;ownership&nbsp;of&nbsp;ci&nbsp;passes&nbsp;to&nbsp;the&nbsp;*Rows,&nbsp;to&nbsp;be&nbsp;freed</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3251002">//&nbsp;with&nbsp;releaseConn.</span><br>
<span class="lineno">1450</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3251026">rows</span>&nbsp;<span class="op" id="3251031">:=</span>&nbsp;<span class="op" id="3251034">&amp;</span><span class="ident" id="3251035">Rows</span><span class="op" id="3251039">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3251045">dc</span><span class="op" id="3251047">:</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3251052">dc</span><span class="op" id="3251054">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3251060">rowsi</span><span class="op" id="3251065">:</span>&nbsp;<span class="ident" id="3251067">rowsi</span><span class="op" id="3251072">,</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3251078">//&nbsp;releaseConn&nbsp;set&nbsp;below</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3251106">}</span><br>
<span class="lineno">1455</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3251111">s</span><span class="op" id="3251112">.</span><span class="ident" id="3251113">db</span><span class="op" id="3251115">.</span><span class="ident" id="3251116">addDep</span><span class="op" id="3251122">(</span><span class="ident" id="3251123">s</span><span class="op" id="3251124">,</span>&nbsp;<span class="ident" id="3251126">rows</span><span class="op" id="3251130">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3251135">rows</span><span class="op" id="3251139">.</span><span class="ident" id="3251140">releaseConn</span>&nbsp;<span class="op" id="3251152">=</span>&nbsp;<span class="keyword" id="3251154">func</span><span class="op" id="3251158">(</span><span class="ident" id="3251159">err</span>&nbsp;<span class="builtintype" id="3251163">error</span><span class="op" id="3251168">)</span>&nbsp;<span class="op" id="3251170">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3251176">releaseConn</span><span class="op" id="3251187">(</span><span class="ident" id="3251188">err</span><span class="op" id="3251191">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3251197">s</span><span class="op" id="3251198">.</span><span class="ident" id="3251199">db</span><span class="op" id="3251201">.</span><span class="ident" id="3251202">removeDep</span><span class="op" id="3251211">(</span><span class="ident" id="3251212">s</span><span class="op" id="3251213">,</span>&nbsp;<span class="ident" id="3251215">rows</span><span class="op" id="3251219">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3251224">}</span><br>
<span class="lineno">1460</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3251229">return</span>&nbsp;<span class="ident" id="3251236">rows</span><span class="op" id="3251240">,</span>&nbsp;<span class="ident" id="3251242">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3251248">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3251253">releaseConn</span><span class="op" id="3251264">(</span><span class="ident" id="3251265">err</span><span class="op" id="3251268">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3251272">if</span>&nbsp;<span class="ident" id="3251275">err</span>&nbsp;<span class="op" id="3251279">!=</span>&nbsp;<span class="ident" id="3251282">driver</span><span class="op" id="3251288">.</span><span class="ident" id="3251289">ErrBadConn</span>&nbsp;<span class="op" id="3251300">{</span><br>
<span class="lineno">1465</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3251305">return</span>&nbsp;<span class="ident" id="3251312">nil</span><span class="op" id="3251315">,</span>&nbsp;<span class="ident" id="3251317">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3251323">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3251326">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3251329">return</span>&nbsp;<span class="ident" id="3251336">nil</span><span class="op" id="3251339">,</span>&nbsp;<span class="ident" id="3251341">driver</span><span class="op" id="3251347">.</span><span class="ident" id="3251348">ErrBadConn</span><br>
<span class="lineno"></span><span class="op" id="3251359">}</span><br>
<span class="lineno">1470</span><br>
<span class="lineno"></span><span class="keyword" id="3251362">func</span>&nbsp;<span class="ident" id="3251367">rowsiFromStatement</span><span class="op" id="3251385">(</span><span class="ident" id="3251386">ds</span>&nbsp;<span class="ident" id="3251389">driverStmt</span><span class="op" id="3251399">,</span>&nbsp;<span class="ident" id="3251401">args</span>&nbsp;<span class="op" id="3251406">...</span><span class="keyword" id="3251409">interface</span><span class="op" id="3251418">{</span><span class="op" id="3251419">}</span><span class="op" id="3251420">)</span>&nbsp;<span class="op" id="3251422">(</span><span class="ident" id="3251423">driver</span><span class="op" id="3251429">.</span><span class="ident" id="3251430">Rows</span><span class="op" id="3251434">,</span>&nbsp;<span class="builtintype" id="3251436">error</span><span class="op" id="3251441">)</span>&nbsp;<span class="op" id="3251443">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3251446">ds</span><span class="op" id="3251448">.</span><span class="ident" id="3251449">Lock</span><span class="op" id="3251453">(</span><span class="op" id="3251454">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3251457">want</span>&nbsp;<span class="op" id="3251462">:=</span>&nbsp;<span class="ident" id="3251465">ds</span><span class="op" id="3251467">.</span><span class="ident" id="3251468">si</span><span class="op" id="3251470">.</span><span class="ident" id="3251471">NumInput</span><span class="op" id="3251479">(</span><span class="op" id="3251480">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3251483">ds</span><span class="op" id="3251485">.</span><span class="ident" id="3251486">Unlock</span><span class="op" id="3251492">(</span><span class="op" id="3251493">)</span><br>
<span class="lineno">1475</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3251497">//&nbsp;-1&nbsp;means&nbsp;the&nbsp;driver&nbsp;doesn&#39;t&nbsp;know&nbsp;how&nbsp;to&nbsp;count&nbsp;the&nbsp;number&nbsp;of</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3251561">//&nbsp;placeholders,&nbsp;so&nbsp;we&nbsp;won&#39;t&nbsp;sanity&nbsp;check&nbsp;input&nbsp;here&nbsp;and&nbsp;instead&nbsp;let&nbsp;the</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3251635">//&nbsp;driver&nbsp;deal&nbsp;with&nbsp;errors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3251664">if</span>&nbsp;<span class="ident" id="3251667">want</span>&nbsp;<span class="op" id="3251672">!=</span>&nbsp;<span class="op" id="3251675">-</span><span class="num" id="3251676">1</span>&nbsp;<span class="op" id="3251678">&amp;&amp;</span>&nbsp;<span class="builtinfunc" id="3251681">len</span><span class="op" id="3251684">(</span><span class="ident" id="3251685">args</span><span class="op" id="3251689">)</span>&nbsp;<span class="op" id="3251691">!=</span>&nbsp;<span class="ident" id="3251694">want</span>&nbsp;<span class="op" id="3251699">{</span><br>
<span class="lineno">1480</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3251703">return</span>&nbsp;<span class="ident" id="3251710">nil</span><span class="op" id="3251713">,</span>&nbsp;<span class="ident" id="3251715">fmt</span><span class="op" id="3251718">.</span><span class="ident" id="3251719">Errorf</span><span class="op" id="3251725">(</span><span class="string" id="3251726">&#34;sql:&nbsp;statement&nbsp;expects&nbsp;%d&nbsp;inputs;&nbsp;got&nbsp;%d&#34;</span><span class="op" id="3251768">,</span>&nbsp;<span class="ident" id="3251770">want</span><span class="op" id="3251774">,</span>&nbsp;<span class="builtinfunc" id="3251776">len</span><span class="op" id="3251779">(</span><span class="ident" id="3251780">args</span><span class="op" id="3251784">)</span><span class="op" id="3251785">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3251788">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3251792">dargs</span><span class="op" id="3251797">,</span>&nbsp;<span class="ident" id="3251799">err</span>&nbsp;<span class="op" id="3251803">:=</span>&nbsp;<span class="ident" id="3251806">driverArgs</span><span class="op" id="3251816">(</span><span class="op" id="3251817">&amp;</span><span class="ident" id="3251818">ds</span><span class="op" id="3251820">,</span>&nbsp;<span class="ident" id="3251822">args</span><span class="op" id="3251826">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3251829">if</span>&nbsp;<span class="ident" id="3251832">err</span>&nbsp;<span class="op" id="3251836">!=</span>&nbsp;<span class="ident" id="3251839">nil</span>&nbsp;<span class="op" id="3251843">{</span><br>
<span class="lineno">1485</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3251847">return</span>&nbsp;<span class="ident" id="3251854">nil</span><span class="op" id="3251857">,</span>&nbsp;<span class="ident" id="3251859">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3251864">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3251868">ds</span><span class="op" id="3251870">.</span><span class="ident" id="3251871">Lock</span><span class="op" id="3251875">(</span><span class="op" id="3251876">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3251879">rowsi</span><span class="op" id="3251884">,</span>&nbsp;<span class="ident" id="3251886">err</span>&nbsp;<span class="op" id="3251890">:=</span>&nbsp;<span class="ident" id="3251893">ds</span><span class="op" id="3251895">.</span><span class="ident" id="3251896">si</span><span class="op" id="3251898">.</span><span class="ident" id="3251899">Query</span><span class="op" id="3251904">(</span><span class="ident" id="3251905">dargs</span><span class="op" id="3251910">)</span><br>
<span class="lineno">1490</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3251913">ds</span><span class="op" id="3251915">.</span><span class="ident" id="3251916">Unlock</span><span class="op" id="3251922">(</span><span class="op" id="3251923">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3251926">if</span>&nbsp;<span class="ident" id="3251929">err</span>&nbsp;<span class="op" id="3251933">!=</span>&nbsp;<span class="ident" id="3251936">nil</span>&nbsp;<span class="op" id="3251940">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3251944">return</span>&nbsp;<span class="ident" id="3251951">nil</span><span class="op" id="3251954">,</span>&nbsp;<span class="ident" id="3251956">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3251961">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3251964">return</span>&nbsp;<span class="ident" id="3251971">rowsi</span><span class="op" id="3251976">,</span>&nbsp;<span class="ident" id="3251978">nil</span><br>
<span class="lineno">1495</span><span class="op" id="3251982">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3251985">//&nbsp;QueryRow&nbsp;executes&nbsp;a&nbsp;prepared&nbsp;query&nbsp;statement&nbsp;with&nbsp;the&nbsp;given&nbsp;arguments.</span><br>
<span class="lineno"></span><span class="comment" id="3252059">//&nbsp;If&nbsp;an&nbsp;error&nbsp;occurs&nbsp;during&nbsp;the&nbsp;execution&nbsp;of&nbsp;the&nbsp;statement,&nbsp;that&nbsp;error&nbsp;will</span><br>
<span class="lineno"></span><span class="comment" id="3252136">//&nbsp;be&nbsp;returned&nbsp;by&nbsp;a&nbsp;call&nbsp;to&nbsp;Scan&nbsp;on&nbsp;the&nbsp;returned&nbsp;*Row,&nbsp;which&nbsp;is&nbsp;always&nbsp;non-nil.</span><br>
<span class="lineno">1500</span><span class="comment" id="3252216">//&nbsp;If&nbsp;the&nbsp;query&nbsp;selects&nbsp;no&nbsp;rows,&nbsp;the&nbsp;*Row&#39;s&nbsp;Scan&nbsp;will&nbsp;return&nbsp;ErrNoRows.</span><br>
<span class="lineno"></span><span class="comment" id="3252288">//&nbsp;Otherwise,&nbsp;the&nbsp;*Row&#39;s&nbsp;Scan&nbsp;scans&nbsp;the&nbsp;first&nbsp;selected&nbsp;row&nbsp;and&nbsp;discards</span><br>
<span class="lineno"></span><span class="comment" id="3252360">//&nbsp;the&nbsp;rest.</span><br>
<span class="lineno"></span><span class="comment" id="3252373">//</span><br>
<span class="lineno"></span><span class="comment" id="3252376">//&nbsp;Example&nbsp;usage:</span><br>
<span class="lineno">1505</span><span class="comment" id="3252394">//</span><br>
<span class="lineno"></span><span class="comment" id="3252397">//&nbsp;&nbsp;var&nbsp;name&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="3252417">//&nbsp;&nbsp;err&nbsp;:=&nbsp;nameByUseridStmt.QueryRow(id).Scan(&amp;name)</span><br>
<span class="lineno"></span><span class="keyword" id="3252470">func</span>&nbsp;<span class="op" id="3252475">(</span><span class="ident" id="3252476">s</span>&nbsp;<span class="op" id="3252478">*</span><span class="ident" id="3252479">Stmt</span><span class="op" id="3252483">)</span>&nbsp;<span class="ident" id="3252485">QueryRow</span><span class="op" id="3252493">(</span><span class="ident" id="3252494">args</span>&nbsp;<span class="op" id="3252499">...</span><span class="keyword" id="3252502">interface</span><span class="op" id="3252511">{</span><span class="op" id="3252512">}</span><span class="op" id="3252513">)</span>&nbsp;<span class="op" id="3252515">*</span><span class="ident" id="3252516">Row</span>&nbsp;<span class="op" id="3252520">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3252523">rows</span><span class="op" id="3252527">,</span>&nbsp;<span class="ident" id="3252529">err</span>&nbsp;<span class="op" id="3252533">:=</span>&nbsp;<span class="ident" id="3252536">s</span><span class="op" id="3252537">.</span><span class="ident" id="3252538">Query</span><span class="op" id="3252543">(</span><span class="ident" id="3252544">args</span><span class="op" id="3252548">...</span><span class="op" id="3252551">)</span><br>
<span class="lineno">1510</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3252554">if</span>&nbsp;<span class="ident" id="3252557">err</span>&nbsp;<span class="op" id="3252561">!=</span>&nbsp;<span class="ident" id="3252564">nil</span>&nbsp;<span class="op" id="3252568">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3252572">return</span>&nbsp;<span class="op" id="3252579">&amp;</span><span class="ident" id="3252580">Row</span><span class="op" id="3252583">{</span><span class="ident" id="3252584">err</span><span class="op" id="3252587">:</span>&nbsp;<span class="ident" id="3252589">err</span><span class="op" id="3252592">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3252595">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3252598">return</span>&nbsp;<span class="op" id="3252605">&amp;</span><span class="ident" id="3252606">Row</span><span class="op" id="3252609">{</span><span class="ident" id="3252610">rows</span><span class="op" id="3252614">:</span>&nbsp;<span class="ident" id="3252616">rows</span><span class="op" id="3252620">}</span><br>
<span class="lineno"></span><span class="op" id="3252622">}</span><br>
<span class="lineno">1515</span><br>
<span class="lineno"></span><span class="comment" id="3252625">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;statement.</span><br>
<span class="lineno"></span><span class="keyword" id="3252656">func</span>&nbsp;<span class="op" id="3252661">(</span><span class="ident" id="3252662">s</span>&nbsp;<span class="op" id="3252664">*</span><span class="ident" id="3252665">Stmt</span><span class="op" id="3252669">)</span>&nbsp;<span class="ident" id="3252671">Close</span><span class="op" id="3252676">(</span><span class="op" id="3252677">)</span>&nbsp;<span class="builtintype" id="3252679">error</span>&nbsp;<span class="op" id="3252685">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3252688">s</span><span class="op" id="3252689">.</span><span class="ident" id="3252690">closemu</span><span class="op" id="3252697">.</span><span class="ident" id="3252698">Lock</span><span class="op" id="3252702">(</span><span class="op" id="3252703">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3252706">defer</span>&nbsp;<span class="ident" id="3252712">s</span><span class="op" id="3252713">.</span><span class="ident" id="3252714">closemu</span><span class="op" id="3252721">.</span><span class="ident" id="3252722">Unlock</span><span class="op" id="3252728">(</span><span class="op" id="3252729">)</span><br>
<span class="lineno">1520</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3252733">if</span>&nbsp;<span class="ident" id="3252736">s</span><span class="op" id="3252737">.</span><span class="ident" id="3252738">stickyErr</span>&nbsp;<span class="op" id="3252748">!=</span>&nbsp;<span class="ident" id="3252751">nil</span>&nbsp;<span class="op" id="3252755">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3252759">return</span>&nbsp;<span class="ident" id="3252766">s</span><span class="op" id="3252767">.</span><span class="ident" id="3252768">stickyErr</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3252779">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3252782">s</span><span class="op" id="3252783">.</span><span class="ident" id="3252784">mu</span><span class="op" id="3252786">.</span><span class="ident" id="3252787">Lock</span><span class="op" id="3252791">(</span><span class="op" id="3252792">)</span><br>
<span class="lineno">1525</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3252795">if</span>&nbsp;<span class="ident" id="3252798">s</span><span class="op" id="3252799">.</span><span class="ident" id="3252800">closed</span>&nbsp;<span class="op" id="3252807">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3252811">s</span><span class="op" id="3252812">.</span><span class="ident" id="3252813">mu</span><span class="op" id="3252815">.</span><span class="ident" id="3252816">Unlock</span><span class="op" id="3252822">(</span><span class="op" id="3252823">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3252827">return</span>&nbsp;<span class="ident" id="3252834">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3252839">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3252842">s</span><span class="op" id="3252843">.</span><span class="ident" id="3252844">closed</span>&nbsp;<span class="op" id="3252851">=</span>&nbsp;<span class="builtintype" id="3252853">true</span><br>
<span class="lineno">1530</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3252860">if</span>&nbsp;<span class="ident" id="3252863">s</span><span class="op" id="3252864">.</span><span class="ident" id="3252865">tx</span>&nbsp;<span class="op" id="3252868">!=</span>&nbsp;<span class="ident" id="3252871">nil</span>&nbsp;<span class="op" id="3252875">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3252879">s</span><span class="op" id="3252880">.</span><span class="ident" id="3252881">txsi</span><span class="op" id="3252885">.</span><span class="ident" id="3252886">Close</span><span class="op" id="3252891">(</span><span class="op" id="3252892">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3252896">s</span><span class="op" id="3252897">.</span><span class="ident" id="3252898">mu</span><span class="op" id="3252900">.</span><span class="ident" id="3252901">Unlock</span><span class="op" id="3252907">(</span><span class="op" id="3252908">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3252912">return</span>&nbsp;<span class="ident" id="3252919">nil</span><br>
<span class="lineno">1535</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3252924">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3252927">s</span><span class="op" id="3252928">.</span><span class="ident" id="3252929">mu</span><span class="op" id="3252931">.</span><span class="ident" id="3252932">Unlock</span><span class="op" id="3252938">(</span><span class="op" id="3252939">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3252943">return</span>&nbsp;<span class="ident" id="3252950">s</span><span class="op" id="3252951">.</span><span class="ident" id="3252952">db</span><span class="op" id="3252954">.</span><span class="ident" id="3252955">removeDep</span><span class="op" id="3252964">(</span><span class="ident" id="3252965">s</span><span class="op" id="3252966">,</span>&nbsp;<span class="ident" id="3252968">s</span><span class="op" id="3252969">)</span><br>
<span class="lineno"></span><span class="op" id="3252971">}</span><br>
<span class="lineno">1540</span><br>
<span class="lineno"></span><span class="keyword" id="3252974">func</span>&nbsp;<span class="op" id="3252979">(</span><span class="ident" id="3252980">s</span>&nbsp;<span class="op" id="3252982">*</span><span class="ident" id="3252983">Stmt</span><span class="op" id="3252987">)</span>&nbsp;<span class="ident" id="3252989">finalClose</span><span class="op" id="3252999">(</span><span class="op" id="3253000">)</span>&nbsp;<span class="builtintype" id="3253002">error</span>&nbsp;<span class="op" id="3253008">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3253011">s</span><span class="op" id="3253012">.</span><span class="ident" id="3253013">mu</span><span class="op" id="3253015">.</span><span class="ident" id="3253016">Lock</span><span class="op" id="3253020">(</span><span class="op" id="3253021">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3253024">defer</span>&nbsp;<span class="ident" id="3253030">s</span><span class="op" id="3253031">.</span><span class="ident" id="3253032">mu</span><span class="op" id="3253034">.</span><span class="ident" id="3253035">Unlock</span><span class="op" id="3253041">(</span><span class="op" id="3253042">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3253045">if</span>&nbsp;<span class="ident" id="3253048">s</span><span class="op" id="3253049">.</span><span class="ident" id="3253050">css</span>&nbsp;<span class="op" id="3253054">!=</span>&nbsp;<span class="ident" id="3253057">nil</span>&nbsp;<span class="op" id="3253061">{</span><br>
<span class="lineno">1545</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3253065">for</span>&nbsp;<span class="ident" id="3253069">_</span><span class="op" id="3253070">,</span>&nbsp;<span class="ident" id="3253072">v</span>&nbsp;<span class="op" id="3253074">:=</span>&nbsp;<span class="keyword" id="3253077">range</span>&nbsp;<span class="ident" id="3253083">s</span><span class="op" id="3253084">.</span><span class="ident" id="3253085">css</span>&nbsp;<span class="op" id="3253089">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3253094">s</span><span class="op" id="3253095">.</span><span class="ident" id="3253096">db</span><span class="op" id="3253098">.</span><span class="ident" id="3253099">noteUnusedDriverStatement</span><span class="op" id="3253124">(</span><span class="ident" id="3253125">v</span><span class="op" id="3253126">.</span><span class="ident" id="3253127">dc</span><span class="op" id="3253129">,</span>&nbsp;<span class="ident" id="3253131">v</span><span class="op" id="3253132">.</span><span class="ident" id="3253133">si</span><span class="op" id="3253135">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3253140">v</span><span class="op" id="3253141">.</span><span class="ident" id="3253142">dc</span><span class="op" id="3253144">.</span><span class="ident" id="3253145">removeOpenStmt</span><span class="op" id="3253159">(</span><span class="ident" id="3253160">v</span><span class="op" id="3253161">.</span><span class="ident" id="3253162">si</span><span class="op" id="3253164">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3253168">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3253172">s</span><span class="op" id="3253173">.</span><span class="ident" id="3253174">css</span>&nbsp;<span class="op" id="3253178">=</span>&nbsp;<span class="ident" id="3253180">nil</span><br>
<span class="lineno">1550</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3253185">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3253188">return</span>&nbsp;<span class="ident" id="3253195">nil</span><br>
<span class="lineno"></span><span class="op" id="3253199">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3253202">//&nbsp;Rows&nbsp;is&nbsp;the&nbsp;result&nbsp;of&nbsp;a&nbsp;query.&nbsp;Its&nbsp;cursor&nbsp;starts&nbsp;before&nbsp;the&nbsp;first&nbsp;row</span><br>
<span class="lineno">1555</span><span class="comment" id="3253275">//&nbsp;of&nbsp;the&nbsp;result&nbsp;set.&nbsp;Use&nbsp;Next&nbsp;to&nbsp;advance&nbsp;through&nbsp;the&nbsp;rows:</span><br>
<span class="lineno"></span><span class="comment" id="3253335">//</span><br>
<span class="lineno"></span><span class="comment" id="3253338">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rows,&nbsp;err&nbsp;:=&nbsp;db.Query(&#34;SELECT&nbsp;...&#34;)</span><br>
<span class="lineno"></span><span class="comment" id="3253381">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="comment" id="3253392">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;defer&nbsp;rows.Close()</span><br>
<span class="lineno">1560</span><span class="comment" id="3253418">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;rows.Next()&nbsp;{</span><br>
<span class="lineno"></span><span class="comment" id="3253443">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;id&nbsp;int</span><br>
<span class="lineno"></span><span class="comment" id="3253465">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;name&nbsp;string</span><br>
<span class="lineno"></span><span class="comment" id="3253492">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err&nbsp;=&nbsp;rows.Scan(&amp;id,&nbsp;&amp;name)</span><br>
<span class="lineno"></span><span class="comment" id="3253531">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><br>
<span class="lineno">1565</span><span class="comment" id="3253546">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span><br>
<span class="lineno"></span><span class="comment" id="3253555">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err&nbsp;=&nbsp;rows.Err()&nbsp;//&nbsp;get&nbsp;any&nbsp;error&nbsp;encountered&nbsp;during&nbsp;iteration</span><br>
<span class="lineno"></span><span class="comment" id="3253625">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...</span><br>
<span class="lineno"></span><span class="keyword" id="3253636">type</span>&nbsp;<span class="ident" id="3253641">Rows</span>&nbsp;<span class="keyword" id="3253646">struct</span>&nbsp;<span class="op" id="3253653">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3253656">dc</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="op" id="3253668">*</span><span class="ident" id="3253669">driverConn</span>&nbsp;<span class="comment" id="3253680">//&nbsp;owned;&nbsp;must&nbsp;call&nbsp;releaseConn&nbsp;when&nbsp;closed&nbsp;to&nbsp;release</span><br>
<span class="lineno">1570</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3253736">releaseConn</span>&nbsp;<span class="keyword" id="3253748">func</span><span class="op" id="3253752">(</span><span class="builtintype" id="3253753">error</span><span class="op" id="3253758">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3253761">rowsi</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3253773">driver</span><span class="op" id="3253779">.</span><span class="ident" id="3253780">Rows</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3253787">closed</span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3253797">bool</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3253803">lastcols</span>&nbsp;&nbsp;<span class="op" id="3253813">[</span><span class="op" id="3253814">]</span><span class="ident" id="3253815">driver</span><span class="op" id="3253821">.</span><span class="ident" id="3253822">Value</span><br>
<span class="lineno">1575</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3253829">lasterr</span>&nbsp;&nbsp;&nbsp;<span class="builtintype" id="3253839">error</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment" id="3253851">//&nbsp;non-nil&nbsp;only&nbsp;if&nbsp;closed&nbsp;is&nbsp;true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3253886">closeStmt</span>&nbsp;<span class="ident" id="3253896">driver</span><span class="op" id="3253902">.</span><span class="ident" id="3253903">Stmt</span>&nbsp;<span class="comment" id="3253908">//&nbsp;if&nbsp;non-nil,&nbsp;statement&nbsp;to&nbsp;Close&nbsp;on&nbsp;close</span><br>
<span class="lineno"></span><span class="op" id="3253951">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3253954">//&nbsp;Next&nbsp;prepares&nbsp;the&nbsp;next&nbsp;result&nbsp;row&nbsp;for&nbsp;reading&nbsp;with&nbsp;the&nbsp;Scan&nbsp;method.&nbsp;&nbsp;It</span><br>
<span class="lineno">1580</span><span class="comment" id="3254029">//&nbsp;returns&nbsp;true&nbsp;on&nbsp;success,&nbsp;or&nbsp;false&nbsp;if&nbsp;there&nbsp;is&nbsp;no&nbsp;next&nbsp;result&nbsp;row&nbsp;or&nbsp;an&nbsp;error</span><br>
<span class="lineno"></span><span class="comment" id="3254109">//&nbsp;happened&nbsp;while&nbsp;preparing&nbsp;it.&nbsp;&nbsp;Err&nbsp;should&nbsp;be&nbsp;consulted&nbsp;to&nbsp;distinguish&nbsp;between</span><br>
<span class="lineno"></span><span class="comment" id="3254189">//&nbsp;the&nbsp;two&nbsp;cases.</span><br>
<span class="lineno"></span><span class="comment" id="3254207">//</span><br>
<span class="lineno"></span><span class="comment" id="3254210">//&nbsp;Every&nbsp;call&nbsp;to&nbsp;Scan,&nbsp;even&nbsp;the&nbsp;first&nbsp;one,&nbsp;must&nbsp;be&nbsp;preceded&nbsp;by&nbsp;a&nbsp;call&nbsp;to&nbsp;Next.</span><br>
<span class="lineno">1585</span><span class="keyword" id="3254289">func</span>&nbsp;<span class="op" id="3254294">(</span><span class="ident" id="3254295">rs</span>&nbsp;<span class="op" id="3254298">*</span><span class="ident" id="3254299">Rows</span><span class="op" id="3254303">)</span>&nbsp;<span class="ident" id="3254305">Next</span><span class="op" id="3254309">(</span><span class="op" id="3254310">)</span>&nbsp;<span class="builtintype" id="3254312">bool</span>&nbsp;<span class="op" id="3254317">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3254320">if</span>&nbsp;<span class="ident" id="3254323">rs</span><span class="op" id="3254325">.</span><span class="ident" id="3254326">closed</span>&nbsp;<span class="op" id="3254333">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3254337">return</span>&nbsp;<span class="builtintype" id="3254344">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3254351">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3254354">if</span>&nbsp;<span class="ident" id="3254357">rs</span><span class="op" id="3254359">.</span><span class="ident" id="3254360">lastcols</span>&nbsp;<span class="op" id="3254369">==</span>&nbsp;<span class="ident" id="3254372">nil</span>&nbsp;<span class="op" id="3254376">{</span><br>
<span class="lineno">1590</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3254380">rs</span><span class="op" id="3254382">.</span><span class="ident" id="3254383">lastcols</span>&nbsp;<span class="op" id="3254392">=</span>&nbsp;<span class="builtinfunc" id="3254394">make</span><span class="op" id="3254398">(</span><span class="op" id="3254399">[</span><span class="op" id="3254400">]</span><span class="ident" id="3254401">driver</span><span class="op" id="3254407">.</span><span class="ident" id="3254408">Value</span><span class="op" id="3254413">,</span>&nbsp;<span class="builtinfunc" id="3254415">len</span><span class="op" id="3254418">(</span><span class="ident" id="3254419">rs</span><span class="op" id="3254421">.</span><span class="ident" id="3254422">rowsi</span><span class="op" id="3254427">.</span><span class="ident" id="3254428">Columns</span><span class="op" id="3254435">(</span><span class="op" id="3254436">)</span><span class="op" id="3254437">)</span><span class="op" id="3254438">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3254441">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3254444">rs</span><span class="op" id="3254446">.</span><span class="ident" id="3254447">lasterr</span>&nbsp;<span class="op" id="3254455">=</span>&nbsp;<span class="ident" id="3254457">rs</span><span class="op" id="3254459">.</span><span class="ident" id="3254460">rowsi</span><span class="op" id="3254465">.</span><span class="ident" id="3254466">Next</span><span class="op" id="3254470">(</span><span class="ident" id="3254471">rs</span><span class="op" id="3254473">.</span><span class="ident" id="3254474">lastcols</span><span class="op" id="3254482">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3254485">if</span>&nbsp;<span class="ident" id="3254488">rs</span><span class="op" id="3254490">.</span><span class="ident" id="3254491">lasterr</span>&nbsp;<span class="op" id="3254499">!=</span>&nbsp;<span class="ident" id="3254502">nil</span>&nbsp;<span class="op" id="3254506">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3254510">rs</span><span class="op" id="3254512">.</span><span class="ident" id="3254513">Close</span><span class="op" id="3254518">(</span><span class="op" id="3254519">)</span><br>
<span class="lineno">1595</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3254523">return</span>&nbsp;<span class="builtintype" id="3254530">false</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3254537">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3254540">return</span>&nbsp;<span class="builtintype" id="3254547">true</span><br>
<span class="lineno"></span><span class="op" id="3254552">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1600</span><span class="comment" id="3254555">//&nbsp;Err&nbsp;returns&nbsp;the&nbsp;error,&nbsp;if&nbsp;any,&nbsp;that&nbsp;was&nbsp;encountered&nbsp;during&nbsp;iteration.</span><br>
<span class="lineno"></span><span class="comment" id="3254628">//&nbsp;Err&nbsp;may&nbsp;be&nbsp;called&nbsp;after&nbsp;an&nbsp;explicit&nbsp;or&nbsp;implicit&nbsp;Close.</span><br>
<span class="lineno"></span><span class="keyword" id="3254686">func</span>&nbsp;<span class="op" id="3254691">(</span><span class="ident" id="3254692">rs</span>&nbsp;<span class="op" id="3254695">*</span><span class="ident" id="3254696">Rows</span><span class="op" id="3254700">)</span>&nbsp;<span class="ident" id="3254702">Err</span><span class="op" id="3254705">(</span><span class="op" id="3254706">)</span>&nbsp;<span class="builtintype" id="3254708">error</span>&nbsp;<span class="op" id="3254714">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3254717">if</span>&nbsp;<span class="ident" id="3254720">rs</span><span class="op" id="3254722">.</span><span class="ident" id="3254723">lasterr</span>&nbsp;<span class="op" id="3254731">==</span>&nbsp;<span class="ident" id="3254734">io</span><span class="op" id="3254736">.</span><span class="ident" id="3254737">EOF</span>&nbsp;<span class="op" id="3254741">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3254745">return</span>&nbsp;<span class="ident" id="3254752">nil</span><br>
<span class="lineno">1605</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3254757">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3254760">return</span>&nbsp;<span class="ident" id="3254767">rs</span><span class="op" id="3254769">.</span><span class="ident" id="3254770">lasterr</span><br>
<span class="lineno"></span><span class="op" id="3254778">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3254781">//&nbsp;Columns&nbsp;returns&nbsp;the&nbsp;column&nbsp;names.</span><br>
<span class="lineno">1610</span><span class="comment" id="3254818">//&nbsp;Columns&nbsp;returns&nbsp;an&nbsp;error&nbsp;if&nbsp;the&nbsp;rows&nbsp;are&nbsp;closed,&nbsp;or&nbsp;if&nbsp;the&nbsp;rows</span><br>
<span class="lineno"></span><span class="comment" id="3254885">//&nbsp;are&nbsp;from&nbsp;QueryRow&nbsp;and&nbsp;there&nbsp;was&nbsp;a&nbsp;deferred&nbsp;error.</span><br>
<span class="lineno"></span><span class="keyword" id="3254938">func</span>&nbsp;<span class="op" id="3254943">(</span><span class="ident" id="3254944">rs</span>&nbsp;<span class="op" id="3254947">*</span><span class="ident" id="3254948">Rows</span><span class="op" id="3254952">)</span>&nbsp;<span class="ident" id="3254954">Columns</span><span class="op" id="3254961">(</span><span class="op" id="3254962">)</span>&nbsp;<span class="op" id="3254964">(</span><span class="op" id="3254965">[</span><span class="op" id="3254966">]</span><span class="builtintype" id="3254967">string</span><span class="op" id="3254973">,</span>&nbsp;<span class="builtintype" id="3254975">error</span><span class="op" id="3254980">)</span>&nbsp;<span class="op" id="3254982">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3254985">if</span>&nbsp;<span class="ident" id="3254988">rs</span><span class="op" id="3254990">.</span><span class="ident" id="3254991">closed</span>&nbsp;<span class="op" id="3254998">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3255002">return</span>&nbsp;<span class="ident" id="3255009">nil</span><span class="op" id="3255012">,</span>&nbsp;<span class="ident" id="3255014">errors</span><span class="op" id="3255020">.</span><span class="ident" id="3255021">New</span><span class="op" id="3255024">(</span><span class="string" id="3255025">&#34;sql:&nbsp;Rows&nbsp;are&nbsp;closed&#34;</span><span class="op" id="3255047">)</span><br>
<span class="lineno">1615</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3255050">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3255053">if</span>&nbsp;<span class="ident" id="3255056">rs</span><span class="op" id="3255058">.</span><span class="ident" id="3255059">rowsi</span>&nbsp;<span class="op" id="3255065">==</span>&nbsp;<span class="ident" id="3255068">nil</span>&nbsp;<span class="op" id="3255072">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3255076">return</span>&nbsp;<span class="ident" id="3255083">nil</span><span class="op" id="3255086">,</span>&nbsp;<span class="ident" id="3255088">errors</span><span class="op" id="3255094">.</span><span class="ident" id="3255095">New</span><span class="op" id="3255098">(</span><span class="string" id="3255099">&#34;sql:&nbsp;no&nbsp;Rows&nbsp;available&#34;</span><span class="op" id="3255123">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3255126">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3255129">return</span>&nbsp;<span class="ident" id="3255136">rs</span><span class="op" id="3255138">.</span><span class="ident" id="3255139">rowsi</span><span class="op" id="3255144">.</span><span class="ident" id="3255145">Columns</span><span class="op" id="3255152">(</span><span class="op" id="3255153">)</span><span class="op" id="3255154">,</span>&nbsp;<span class="ident" id="3255156">nil</span><br>
<span class="lineno">1620</span><span class="op" id="3255160">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3255163">//&nbsp;Scan&nbsp;copies&nbsp;the&nbsp;columns&nbsp;in&nbsp;the&nbsp;current&nbsp;row&nbsp;into&nbsp;the&nbsp;values&nbsp;pointed</span><br>
<span class="lineno"></span><span class="comment" id="3255233">//&nbsp;at&nbsp;by&nbsp;dest.</span><br>
<span class="lineno"></span><span class="comment" id="3255248">//</span><br>
<span class="lineno">1625</span><span class="comment" id="3255251">//&nbsp;If&nbsp;an&nbsp;argument&nbsp;has&nbsp;type&nbsp;*[]byte,&nbsp;Scan&nbsp;saves&nbsp;in&nbsp;that&nbsp;argument&nbsp;a&nbsp;copy</span><br>
<span class="lineno"></span><span class="comment" id="3255322">//&nbsp;of&nbsp;the&nbsp;corresponding&nbsp;data.&nbsp;The&nbsp;copy&nbsp;is&nbsp;owned&nbsp;by&nbsp;the&nbsp;caller&nbsp;and&nbsp;can</span><br>
<span class="lineno"></span><span class="comment" id="3255392">//&nbsp;be&nbsp;modified&nbsp;and&nbsp;held&nbsp;indefinitely.&nbsp;The&nbsp;copy&nbsp;can&nbsp;be&nbsp;avoided&nbsp;by&nbsp;using</span><br>
<span class="lineno"></span><span class="comment" id="3255463">//&nbsp;an&nbsp;argument&nbsp;of&nbsp;type&nbsp;*RawBytes&nbsp;instead;&nbsp;see&nbsp;the&nbsp;documentation&nbsp;for</span><br>
<span class="lineno"></span><span class="comment" id="3255531">//&nbsp;RawBytes&nbsp;for&nbsp;restrictions&nbsp;on&nbsp;its&nbsp;use.</span><br>
<span class="lineno">1630</span><span class="comment" id="3255572">//</span><br>
<span class="lineno"></span><span class="comment" id="3255575">//&nbsp;If&nbsp;an&nbsp;argument&nbsp;has&nbsp;type&nbsp;*interface{},&nbsp;Scan&nbsp;copies&nbsp;the&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="3255638">//&nbsp;provided&nbsp;by&nbsp;the&nbsp;underlying&nbsp;driver&nbsp;without&nbsp;conversion.&nbsp;If&nbsp;the&nbsp;value</span><br>
<span class="lineno"></span><span class="comment" id="3255708">//&nbsp;is&nbsp;of&nbsp;type&nbsp;[]byte,&nbsp;a&nbsp;copy&nbsp;is&nbsp;made&nbsp;and&nbsp;the&nbsp;caller&nbsp;owns&nbsp;the&nbsp;result.</span><br>
<span class="lineno"></span><span class="keyword" id="3255777">func</span>&nbsp;<span class="op" id="3255782">(</span><span class="ident" id="3255783">rs</span>&nbsp;<span class="op" id="3255786">*</span><span class="ident" id="3255787">Rows</span><span class="op" id="3255791">)</span>&nbsp;<span class="ident" id="3255793">Scan</span><span class="op" id="3255797">(</span><span class="ident" id="3255798">dest</span>&nbsp;<span class="op" id="3255803">...</span><span class="keyword" id="3255806">interface</span><span class="op" id="3255815">{</span><span class="op" id="3255816">}</span><span class="op" id="3255817">)</span>&nbsp;<span class="builtintype" id="3255819">error</span>&nbsp;<span class="op" id="3255825">{</span><br>
<span class="lineno">1635</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3255828">if</span>&nbsp;<span class="ident" id="3255831">rs</span><span class="op" id="3255833">.</span><span class="ident" id="3255834">closed</span>&nbsp;<span class="op" id="3255841">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3255845">return</span>&nbsp;<span class="ident" id="3255852">errors</span><span class="op" id="3255858">.</span><span class="ident" id="3255859">New</span><span class="op" id="3255862">(</span><span class="string" id="3255863">&#34;sql:&nbsp;Rows&nbsp;are&nbsp;closed&#34;</span><span class="op" id="3255885">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3255888">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3255891">if</span>&nbsp;<span class="ident" id="3255894">rs</span><span class="op" id="3255896">.</span><span class="ident" id="3255897">lastcols</span>&nbsp;<span class="op" id="3255906">==</span>&nbsp;<span class="ident" id="3255909">nil</span>&nbsp;<span class="op" id="3255913">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3255917">return</span>&nbsp;<span class="ident" id="3255924">errors</span><span class="op" id="3255930">.</span><span class="ident" id="3255931">New</span><span class="op" id="3255934">(</span><span class="string" id="3255935">&#34;sql:&nbsp;Scan&nbsp;called&nbsp;without&nbsp;calling&nbsp;Next&#34;</span><span class="op" id="3255974">)</span><br>
<span class="lineno">1640</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3255977">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3255980">if</span>&nbsp;<span class="builtinfunc" id="3255983">len</span><span class="op" id="3255986">(</span><span class="ident" id="3255987">dest</span><span class="op" id="3255991">)</span>&nbsp;<span class="op" id="3255993">!=</span>&nbsp;<span class="builtinfunc" id="3255996">len</span><span class="op" id="3255999">(</span><span class="ident" id="3256000">rs</span><span class="op" id="3256002">.</span><span class="ident" id="3256003">lastcols</span><span class="op" id="3256011">)</span>&nbsp;<span class="op" id="3256013">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3256017">return</span>&nbsp;<span class="ident" id="3256024">fmt</span><span class="op" id="3256027">.</span><span class="ident" id="3256028">Errorf</span><span class="op" id="3256034">(</span><span class="string" id="3256035">&#34;sql:&nbsp;expected&nbsp;%d&nbsp;destination&nbsp;arguments&nbsp;in&nbsp;Scan,&nbsp;not&nbsp;%d&#34;</span><span class="op" id="3256091">,</span>&nbsp;<span class="builtinfunc" id="3256093">len</span><span class="op" id="3256096">(</span><span class="ident" id="3256097">rs</span><span class="op" id="3256099">.</span><span class="ident" id="3256100">lastcols</span><span class="op" id="3256108">)</span><span class="op" id="3256109">,</span>&nbsp;<span class="builtinfunc" id="3256111">len</span><span class="op" id="3256114">(</span><span class="ident" id="3256115">dest</span><span class="op" id="3256119">)</span><span class="op" id="3256120">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3256123">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3256126">for</span>&nbsp;<span class="ident" id="3256130">i</span><span class="op" id="3256131">,</span>&nbsp;<span class="ident" id="3256133">sv</span>&nbsp;<span class="op" id="3256136">:=</span>&nbsp;<span class="keyword" id="3256139">range</span>&nbsp;<span class="ident" id="3256145">rs</span><span class="op" id="3256147">.</span><span class="ident" id="3256148">lastcols</span>&nbsp;<span class="op" id="3256157">{</span><br>
<span class="lineno">1645</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3256161">err</span>&nbsp;<span class="op" id="3256165">:=</span>&nbsp;<span class="ident" id="3256168">convertAssign</span><span class="op" id="3256181">(</span><span class="ident" id="3256182">dest</span><span class="op" id="3256186">[</span><span class="ident" id="3256187">i</span><span class="op" id="3256188">]</span><span class="op" id="3256189">,</span>&nbsp;<span class="ident" id="3256191">sv</span><span class="op" id="3256193">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3256197">if</span>&nbsp;<span class="ident" id="3256200">err</span>&nbsp;<span class="op" id="3256204">!=</span>&nbsp;<span class="ident" id="3256207">nil</span>&nbsp;<span class="op" id="3256211">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3256216">return</span>&nbsp;<span class="ident" id="3256223">fmt</span><span class="op" id="3256226">.</span><span class="ident" id="3256227">Errorf</span><span class="op" id="3256233">(</span><span class="string" id="3256234">&#34;sql:&nbsp;Scan&nbsp;error&nbsp;on&nbsp;column&nbsp;index&nbsp;%d:&nbsp;%v&#34;</span><span class="op" id="3256274">,</span>&nbsp;<span class="ident" id="3256276">i</span><span class="op" id="3256277">,</span>&nbsp;<span class="ident" id="3256279">err</span><span class="op" id="3256282">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3256286">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3256289">}</span><br>
<span class="lineno">1650</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3256292">return</span>&nbsp;<span class="ident" id="3256299">nil</span><br>
<span class="lineno"></span><span class="op" id="3256303">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3256306">var</span>&nbsp;<span class="ident" id="3256310">rowsCloseHook</span>&nbsp;<span class="keyword" id="3256324">func</span><span class="op" id="3256328">(</span><span class="op" id="3256329">*</span><span class="ident" id="3256330">Rows</span><span class="op" id="3256334">,</span>&nbsp;<span class="op" id="3256336">*</span><span class="builtintype" id="3256337">error</span><span class="op" id="3256342">)</span><br>
<span class="lineno"></span><br>
<span class="lineno">1655</span><span class="comment" id="3256345">//&nbsp;Close&nbsp;closes&nbsp;the&nbsp;Rows,&nbsp;preventing&nbsp;further&nbsp;enumeration.&nbsp;If&nbsp;Next&nbsp;returns</span><br>
<span class="lineno"></span><span class="comment" id="3256419">//&nbsp;false,&nbsp;the&nbsp;Rows&nbsp;are&nbsp;closed&nbsp;automatically&nbsp;and&nbsp;it&nbsp;will&nbsp;suffice&nbsp;to&nbsp;check&nbsp;the</span><br>
<span class="lineno"></span><span class="comment" id="3256496">//&nbsp;result&nbsp;of&nbsp;Err.&nbsp;Close&nbsp;is&nbsp;idempotent&nbsp;and&nbsp;does&nbsp;not&nbsp;affect&nbsp;the&nbsp;result&nbsp;of&nbsp;Err.</span><br>
<span class="lineno"></span><span class="keyword" id="3256573">func</span>&nbsp;<span class="op" id="3256578">(</span><span class="ident" id="3256579">rs</span>&nbsp;<span class="op" id="3256582">*</span><span class="ident" id="3256583">Rows</span><span class="op" id="3256587">)</span>&nbsp;<span class="ident" id="3256589">Close</span><span class="op" id="3256594">(</span><span class="op" id="3256595">)</span>&nbsp;<span class="builtintype" id="3256597">error</span>&nbsp;<span class="op" id="3256603">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3256606">if</span>&nbsp;<span class="ident" id="3256609">rs</span><span class="op" id="3256611">.</span><span class="ident" id="3256612">closed</span>&nbsp;<span class="op" id="3256619">{</span><br>
<span class="lineno">1660</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3256623">return</span>&nbsp;<span class="ident" id="3256630">nil</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3256635">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3256638">rs</span><span class="op" id="3256640">.</span><span class="ident" id="3256641">closed</span>&nbsp;<span class="op" id="3256648">=</span>&nbsp;<span class="builtintype" id="3256650">true</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3256656">err</span>&nbsp;<span class="op" id="3256660">:=</span>&nbsp;<span class="ident" id="3256663">rs</span><span class="op" id="3256665">.</span><span class="ident" id="3256666">rowsi</span><span class="op" id="3256671">.</span><span class="ident" id="3256672">Close</span><span class="op" id="3256677">(</span><span class="op" id="3256678">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3256681">if</span>&nbsp;<span class="ident" id="3256684">fn</span>&nbsp;<span class="op" id="3256687">:=</span>&nbsp;<span class="ident" id="3256690">rowsCloseHook</span><span class="op" id="3256703">;</span>&nbsp;<span class="ident" id="3256705">fn</span>&nbsp;<span class="op" id="3256708">!=</span>&nbsp;<span class="ident" id="3256711">nil</span>&nbsp;<span class="op" id="3256715">{</span><br>
<span class="lineno">1665</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3256719">fn</span><span class="op" id="3256721">(</span><span class="ident" id="3256722">rs</span><span class="op" id="3256724">,</span>&nbsp;<span class="op" id="3256726">&amp;</span><span class="ident" id="3256727">err</span><span class="op" id="3256730">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3256733">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3256736">if</span>&nbsp;<span class="ident" id="3256739">rs</span><span class="op" id="3256741">.</span><span class="ident" id="3256742">closeStmt</span>&nbsp;<span class="op" id="3256752">!=</span>&nbsp;<span class="ident" id="3256755">nil</span>&nbsp;<span class="op" id="3256759">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3256763">rs</span><span class="op" id="3256765">.</span><span class="ident" id="3256766">closeStmt</span><span class="op" id="3256775">.</span><span class="ident" id="3256776">Close</span><span class="op" id="3256781">(</span><span class="op" id="3256782">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3256785">}</span><br>
<span class="lineno">1670</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3256788">rs</span><span class="op" id="3256790">.</span><span class="ident" id="3256791">releaseConn</span><span class="op" id="3256802">(</span><span class="ident" id="3256803">err</span><span class="op" id="3256806">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3256809">return</span>&nbsp;<span class="ident" id="3256816">err</span><br>
<span class="lineno"></span><span class="op" id="3256820">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3256823">//&nbsp;Row&nbsp;is&nbsp;the&nbsp;result&nbsp;of&nbsp;calling&nbsp;QueryRow&nbsp;to&nbsp;select&nbsp;a&nbsp;single&nbsp;row.</span><br>
<span class="lineno">1675</span><span class="keyword" id="3256888">type</span>&nbsp;<span class="ident" id="3256893">Row</span>&nbsp;<span class="keyword" id="3256897">struct</span>&nbsp;<span class="op" id="3256904">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3256907">//&nbsp;One&nbsp;of&nbsp;these&nbsp;two&nbsp;will&nbsp;be&nbsp;non-nil:</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3256945">err</span>&nbsp;&nbsp;<span class="builtintype" id="3256950">error</span>&nbsp;<span class="comment" id="3256956">//&nbsp;deferred&nbsp;error&nbsp;for&nbsp;easy&nbsp;chaining</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3256993">rows</span>&nbsp;<span class="op" id="3256998">*</span><span class="ident" id="3256999">Rows</span><br>
<span class="lineno"></span><span class="op" id="3257004">}</span><br>
<span class="lineno">1680</span><br>
<span class="lineno"></span><span class="comment" id="3257007">//&nbsp;Scan&nbsp;copies&nbsp;the&nbsp;columns&nbsp;from&nbsp;the&nbsp;matched&nbsp;row&nbsp;into&nbsp;the&nbsp;values</span><br>
<span class="lineno"></span><span class="comment" id="3257071">//&nbsp;pointed&nbsp;at&nbsp;by&nbsp;dest.&nbsp;&nbsp;If&nbsp;more&nbsp;than&nbsp;one&nbsp;row&nbsp;matches&nbsp;the&nbsp;query,</span><br>
<span class="lineno"></span><span class="comment" id="3257135">//&nbsp;Scan&nbsp;uses&nbsp;the&nbsp;first&nbsp;row&nbsp;and&nbsp;discards&nbsp;the&nbsp;rest.&nbsp;&nbsp;If&nbsp;no&nbsp;row&nbsp;matches</span><br>
<span class="lineno"></span><span class="comment" id="3257204">//&nbsp;the&nbsp;query,&nbsp;Scan&nbsp;returns&nbsp;ErrNoRows.</span><br>
<span class="lineno">1685</span><span class="keyword" id="3257242">func</span>&nbsp;<span class="op" id="3257247">(</span><span class="ident" id="3257248">r</span>&nbsp;<span class="op" id="3257250">*</span><span class="ident" id="3257251">Row</span><span class="op" id="3257254">)</span>&nbsp;<span class="ident" id="3257256">Scan</span><span class="op" id="3257260">(</span><span class="ident" id="3257261">dest</span>&nbsp;<span class="op" id="3257266">...</span><span class="keyword" id="3257269">interface</span><span class="op" id="3257278">{</span><span class="op" id="3257279">}</span><span class="op" id="3257280">)</span>&nbsp;<span class="builtintype" id="3257282">error</span>&nbsp;<span class="op" id="3257288">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3257291">if</span>&nbsp;<span class="ident" id="3257294">r</span><span class="op" id="3257295">.</span><span class="ident" id="3257296">err</span>&nbsp;<span class="op" id="3257300">!=</span>&nbsp;<span class="ident" id="3257303">nil</span>&nbsp;<span class="op" id="3257307">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3257311">return</span>&nbsp;<span class="ident" id="3257318">r</span><span class="op" id="3257319">.</span><span class="ident" id="3257320">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3257325">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1690</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3257329">//&nbsp;TODO(bradfitz):&nbsp;for&nbsp;now&nbsp;we&nbsp;need&nbsp;to&nbsp;defensively&nbsp;clone&nbsp;all</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3257390">//&nbsp;[]byte&nbsp;that&nbsp;the&nbsp;driver&nbsp;returned&nbsp;(not&nbsp;permitting</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3257442">//&nbsp;*RawBytes&nbsp;in&nbsp;Rows.Scan),&nbsp;since&nbsp;we&#39;re&nbsp;about&nbsp;to&nbsp;close</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3257498">//&nbsp;the&nbsp;Rows&nbsp;in&nbsp;our&nbsp;defer,&nbsp;when&nbsp;we&nbsp;return&nbsp;from&nbsp;this&nbsp;function.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3257560">//&nbsp;the&nbsp;contract&nbsp;with&nbsp;the&nbsp;driver.Next(...)&nbsp;interface&nbsp;is&nbsp;that&nbsp;it</span><br>
<span class="lineno">1695</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3257624">//&nbsp;can&nbsp;return&nbsp;slices&nbsp;into&nbsp;read-only&nbsp;temporary&nbsp;memory&nbsp;that&#39;s</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3257685">//&nbsp;only&nbsp;valid&nbsp;until&nbsp;the&nbsp;next&nbsp;Scan/Close.&nbsp;&nbsp;But&nbsp;the&nbsp;TODO&nbsp;is&nbsp;that</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3257749">//&nbsp;for&nbsp;a&nbsp;lot&nbsp;of&nbsp;drivers,&nbsp;this&nbsp;copy&nbsp;will&nbsp;be&nbsp;unnecessary.&nbsp;&nbsp;We</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3257810">//&nbsp;should&nbsp;provide&nbsp;an&nbsp;optional&nbsp;interface&nbsp;for&nbsp;drivers&nbsp;to</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3257866">//&nbsp;implement&nbsp;to&nbsp;say,&nbsp;&#34;don&#39;t&nbsp;worry,&nbsp;the&nbsp;[]bytes&nbsp;that&nbsp;I&nbsp;return</span><br>
<span class="lineno">1700</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3257928">//&nbsp;from&nbsp;Next&nbsp;will&nbsp;not&nbsp;be&nbsp;modified&nbsp;again.&#34;&nbsp;(for&nbsp;instance,&nbsp;if</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3257989">//&nbsp;they&nbsp;were&nbsp;obtained&nbsp;from&nbsp;the&nbsp;network&nbsp;anyway)&nbsp;But&nbsp;for&nbsp;now&nbsp;we</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3258052">//&nbsp;don&#39;t&nbsp;care.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3258068">defer</span>&nbsp;<span class="ident" id="3258074">r</span><span class="op" id="3258075">.</span><span class="ident" id="3258076">rows</span><span class="op" id="3258080">.</span><span class="ident" id="3258081">Close</span><span class="op" id="3258086">(</span><span class="op" id="3258087">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3258090">for</span>&nbsp;<span class="ident" id="3258094">_</span><span class="op" id="3258095">,</span>&nbsp;<span class="ident" id="3258097">dp</span>&nbsp;<span class="op" id="3258100">:=</span>&nbsp;<span class="keyword" id="3258103">range</span>&nbsp;<span class="ident" id="3258109">dest</span>&nbsp;<span class="op" id="3258114">{</span><br>
<span class="lineno">1705</span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3258118">if</span>&nbsp;<span class="ident" id="3258121">_</span><span class="op" id="3258122">,</span>&nbsp;<span class="ident" id="3258124">ok</span>&nbsp;<span class="op" id="3258127">:=</span>&nbsp;<span class="ident" id="3258130">dp</span><span class="op" id="3258132">.</span><span class="op" id="3258133">(</span><span class="op" id="3258134">*</span><span class="ident" id="3258135">RawBytes</span><span class="op" id="3258143">)</span><span class="op" id="3258144">;</span>&nbsp;<span class="ident" id="3258146">ok</span>&nbsp;<span class="op" id="3258149">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3258154">return</span>&nbsp;<span class="ident" id="3258161">errors</span><span class="op" id="3258167">.</span><span class="ident" id="3258168">New</span><span class="op" id="3258171">(</span><span class="string" id="3258172">&#34;sql:&nbsp;RawBytes&nbsp;isn&#39;t&nbsp;allowed&nbsp;on&nbsp;Row.Scan&#34;</span><span class="op" id="3258213">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3258217">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3258220">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1710</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3258224">if</span>&nbsp;<span class="op" id="3258227">!</span><span class="ident" id="3258228">r</span><span class="op" id="3258229">.</span><span class="ident" id="3258230">rows</span><span class="op" id="3258234">.</span><span class="ident" id="3258235">Next</span><span class="op" id="3258239">(</span><span class="op" id="3258240">)</span>&nbsp;<span class="op" id="3258242">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3258246">if</span>&nbsp;<span class="ident" id="3258249">err</span>&nbsp;<span class="op" id="3258253">:=</span>&nbsp;<span class="ident" id="3258256">r</span><span class="op" id="3258257">.</span><span class="ident" id="3258258">rows</span><span class="op" id="3258262">.</span><span class="ident" id="3258263">Err</span><span class="op" id="3258266">(</span><span class="op" id="3258267">)</span><span class="op" id="3258268">;</span>&nbsp;<span class="ident" id="3258270">err</span>&nbsp;<span class="op" id="3258274">!=</span>&nbsp;<span class="ident" id="3258277">nil</span>&nbsp;<span class="op" id="3258281">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3258286">return</span>&nbsp;<span class="ident" id="3258293">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3258299">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3258303">return</span>&nbsp;<span class="ident" id="3258310">ErrNoRows</span><br>
<span class="lineno">1715</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3258321">}</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3258324">err</span>&nbsp;<span class="op" id="3258328">:=</span>&nbsp;<span class="ident" id="3258331">r</span><span class="op" id="3258332">.</span><span class="ident" id="3258333">rows</span><span class="op" id="3258337">.</span><span class="ident" id="3258338">Scan</span><span class="op" id="3258342">(</span><span class="ident" id="3258343">dest</span><span class="op" id="3258347">...</span><span class="op" id="3258350">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3258353">if</span>&nbsp;<span class="ident" id="3258356">err</span>&nbsp;<span class="op" id="3258360">!=</span>&nbsp;<span class="ident" id="3258363">nil</span>&nbsp;<span class="op" id="3258367">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3258371">return</span>&nbsp;<span class="ident" id="3258378">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3258383">}</span><br>
<span class="lineno">1720</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3258386">//&nbsp;Make&nbsp;sure&nbsp;the&nbsp;query&nbsp;can&nbsp;be&nbsp;processed&nbsp;to&nbsp;completion&nbsp;with&nbsp;no&nbsp;errors.</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3258457">if</span>&nbsp;<span class="ident" id="3258460">err</span>&nbsp;<span class="op" id="3258464">:=</span>&nbsp;<span class="ident" id="3258467">r</span><span class="op" id="3258468">.</span><span class="ident" id="3258469">rows</span><span class="op" id="3258473">.</span><span class="ident" id="3258474">Close</span><span class="op" id="3258479">(</span><span class="op" id="3258480">)</span><span class="op" id="3258481">;</span>&nbsp;<span class="ident" id="3258483">err</span>&nbsp;<span class="op" id="3258487">!=</span>&nbsp;<span class="ident" id="3258490">nil</span>&nbsp;<span class="op" id="3258494">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3258498">return</span>&nbsp;<span class="ident" id="3258505">err</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="op" id="3258510">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1725</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3258514">return</span>&nbsp;<span class="ident" id="3258521">nil</span><br>
<span class="lineno"></span><span class="op" id="3258525">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="comment" id="3258528">//&nbsp;A&nbsp;Result&nbsp;summarizes&nbsp;an&nbsp;executed&nbsp;SQL&nbsp;command.</span><br>
<span class="lineno"></span><span class="keyword" id="3258576">type</span>&nbsp;<span class="ident" id="3258581">Result</span>&nbsp;<span class="keyword" id="3258588">interface</span>&nbsp;<span class="op" id="3258598">{</span><br>
<span class="lineno">1730</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3258601">//&nbsp;LastInsertId&nbsp;returns&nbsp;the&nbsp;integer&nbsp;generated&nbsp;by&nbsp;the&nbsp;database</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3258664">//&nbsp;in&nbsp;response&nbsp;to&nbsp;a&nbsp;command.&nbsp;Typically&nbsp;this&nbsp;will&nbsp;be&nbsp;from&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3258725">//&nbsp;&#34;auto&nbsp;increment&#34;&nbsp;column&nbsp;when&nbsp;inserting&nbsp;a&nbsp;new&nbsp;row.&nbsp;Not&nbsp;all</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3258787">//&nbsp;databases&nbsp;support&nbsp;this&nbsp;feature,&nbsp;and&nbsp;the&nbsp;syntax&nbsp;of&nbsp;such</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3258846">//&nbsp;statements&nbsp;varies.</span><br>
<span class="lineno">1735</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3258869">LastInsertId</span><span class="op" id="3258881">(</span><span class="op" id="3258882">)</span>&nbsp;<span class="op" id="3258884">(</span><span class="ident" id="3258885">int64</span><span class="op" id="3258890">,</span>&nbsp;<span class="builtintype" id="3258892">error</span><span class="op" id="3258897">)</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3258901">//&nbsp;RowsAffected&nbsp;returns&nbsp;the&nbsp;number&nbsp;of&nbsp;rows&nbsp;affected&nbsp;by&nbsp;an</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3258960">//&nbsp;update,&nbsp;insert,&nbsp;or&nbsp;delete.&nbsp;Not&nbsp;every&nbsp;database&nbsp;or&nbsp;database</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="comment" id="3259022">//&nbsp;driver&nbsp;may&nbsp;support&nbsp;this.</span><br>
<span class="lineno">1740</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3259051">RowsAffected</span><span class="op" id="3259063">(</span><span class="op" id="3259064">)</span>&nbsp;<span class="op" id="3259066">(</span><span class="ident" id="3259067">int64</span><span class="op" id="3259072">,</span>&nbsp;<span class="builtintype" id="3259074">error</span><span class="op" id="3259079">)</span><br>
<span class="lineno"></span><span class="op" id="3259081">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3259084">type</span>&nbsp;<span class="ident" id="3259089">driverResult</span>&nbsp;<span class="keyword" id="3259102">struct</span>&nbsp;<span class="op" id="3259109">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3259112">sync</span><span class="op" id="3259116">.</span><span class="ident" id="3259117">Locker</span>&nbsp;<span class="comment" id="3259124">//&nbsp;the&nbsp;*driverConn</span><br>
<span class="lineno">1745</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3259144">resi</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="ident" id="3259156">driver</span><span class="op" id="3259162">.</span><span class="ident" id="3259163">Result</span><br>
<span class="lineno"></span><span class="op" id="3259170">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3259173">func</span>&nbsp;<span class="op" id="3259178">(</span><span class="ident" id="3259179">dr</span>&nbsp;<span class="ident" id="3259182">driverResult</span><span class="op" id="3259194">)</span>&nbsp;<span class="ident" id="3259196">LastInsertId</span><span class="op" id="3259208">(</span><span class="op" id="3259209">)</span>&nbsp;<span class="op" id="3259211">(</span><span class="ident" id="3259212">int64</span><span class="op" id="3259217">,</span>&nbsp;<span class="builtintype" id="3259219">error</span><span class="op" id="3259224">)</span>&nbsp;<span class="op" id="3259226">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3259229">dr</span><span class="op" id="3259231">.</span><span class="ident" id="3259232">Lock</span><span class="op" id="3259236">(</span><span class="op" id="3259237">)</span><br>
<span class="lineno">1750</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3259240">defer</span>&nbsp;<span class="ident" id="3259246">dr</span><span class="op" id="3259248">.</span><span class="ident" id="3259249">Unlock</span><span class="op" id="3259255">(</span><span class="op" id="3259256">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3259259">return</span>&nbsp;<span class="ident" id="3259266">dr</span><span class="op" id="3259268">.</span><span class="ident" id="3259269">resi</span><span class="op" id="3259273">.</span><span class="ident" id="3259274">LastInsertId</span><span class="op" id="3259286">(</span><span class="op" id="3259287">)</span><br>
<span class="lineno"></span><span class="op" id="3259289">}</span><br>
<span class="lineno"></span><br>
<span class="lineno"></span><span class="keyword" id="3259292">func</span>&nbsp;<span class="op" id="3259297">(</span><span class="ident" id="3259298">dr</span>&nbsp;<span class="ident" id="3259301">driverResult</span><span class="op" id="3259313">)</span>&nbsp;<span class="ident" id="3259315">RowsAffected</span><span class="op" id="3259327">(</span><span class="op" id="3259328">)</span>&nbsp;<span class="op" id="3259330">(</span><span class="ident" id="3259331">int64</span><span class="op" id="3259336">,</span>&nbsp;<span class="builtintype" id="3259338">error</span><span class="op" id="3259343">)</span>&nbsp;<span class="op" id="3259345">{</span><br>
<span class="lineno">1755</span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3259348">dr</span><span class="op" id="3259350">.</span><span class="ident" id="3259351">Lock</span><span class="op" id="3259355">(</span><span class="op" id="3259356">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3259359">defer</span>&nbsp;<span class="ident" id="3259365">dr</span><span class="op" id="3259367">.</span><span class="ident" id="3259368">Unlock</span><span class="op" id="3259374">(</span><span class="op" id="3259375">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3259378">return</span>&nbsp;<span class="ident" id="3259385">dr</span><span class="op" id="3259387">.</span><span class="ident" id="3259388">resi</span><span class="op" id="3259392">.</span><span class="ident" id="3259393">RowsAffected</span><span class="op" id="3259405">(</span><span class="op" id="3259406">)</span><br>
<span class="lineno"></span><span class="op" id="3259408">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1760</span><span class="keyword" id="3259411">func</span>&nbsp;<span class="ident" id="3259416">stack</span><span class="op" id="3259421">(</span><span class="op" id="3259422">)</span>&nbsp;<span class="builtintype" id="3259424">string</span>&nbsp;<span class="op" id="3259431">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3259434">var</span>&nbsp;<span class="ident" id="3259438">buf</span>&nbsp;<span class="op" id="3259442">[</span><span class="num" id="3259443">2</span>&nbsp;<span class="op" id="3259445">&lt;&lt;</span>&nbsp;<span class="num" id="3259448">10</span><span class="op" id="3259450">]</span><span class="builtintype" id="3259451">byte</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="keyword" id="3259457">return</span>&nbsp;<span class="builtintype" id="3259464">string</span><span class="op" id="3259470">(</span><span class="ident" id="3259471">buf</span><span class="op" id="3259474">[</span><span class="op" id="3259475">:</span><span class="ident" id="3259476">runtime</span><span class="op" id="3259483">.</span><span class="ident" id="3259484">Stack</span><span class="op" id="3259489">(</span><span class="ident" id="3259490">buf</span><span class="op" id="3259493">[</span><span class="op" id="3259494">:</span><span class="op" id="3259495">]</span><span class="op" id="3259496">,</span>&nbsp;<span class="builtintype" id="3259498">false</span><span class="op" id="3259503">)</span><span class="op" id="3259504">]</span><span class="op" id="3259505">)</span><br>
<span class="lineno"></span><span class="op" id="3259507">}</span><br>
<span class="lineno"></span><br>
<span class="lineno">1765</span><span class="comment" id="3259510">//&nbsp;withLock&nbsp;runs&nbsp;while&nbsp;holding&nbsp;lk.</span><br>
<span class="lineno"></span><span class="keyword" id="3259545">func</span>&nbsp;<span class="ident" id="3259550">withLock</span><span class="op" id="3259558">(</span><span class="ident" id="3259559">lk</span>&nbsp;<span class="ident" id="3259562">sync</span><span class="op" id="3259566">.</span><span class="ident" id="3259567">Locker</span><span class="op" id="3259573">,</span>&nbsp;<span class="ident" id="3259575">fn</span>&nbsp;<span class="keyword" id="3259578">func</span><span class="op" id="3259582">(</span><span class="op" id="3259583">)</span><span class="op" id="3259584">)</span>&nbsp;<span class="op" id="3259586">{</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3259589">lk</span><span class="op" id="3259591">.</span><span class="ident" id="3259592">Lock</span><span class="op" id="3259596">(</span><span class="op" id="3259597">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3259600">fn</span><span class="op" id="3259602">(</span><span class="op" id="3259603">)</span><br>
<span class="lineno"></span>&nbsp;&nbsp;&nbsp;&nbsp<span class="ident" id="3259606">lk</span><span class="op" id="3259608">.</span><span class="ident" id="3259609">Unlock</span><span class="op" id="3259615">(</span><span class="op" id="3259616">)</span><br>
<span class="lineno">1770</span><span class="op" id="3259618">}</span>
</div>
</body>
</html>
